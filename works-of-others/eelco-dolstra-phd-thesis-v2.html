<html>
<head><meta http-equiv=Content-Type content="text/html; charset=UTF-8">
<style type="text/css">
<!--
span.cls_002{font-family:Arial,serif;font-size:24.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_002{font-family:Arial,serif;font-size:24.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_003{font-family:Arial,serif;font-size:14.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_003{font-family:Arial,serif;font-size:14.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_004{font-family:Arial,serif;font-size:10.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_004{font-family:Arial,serif;font-size:10.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_005{font-family:Arial,serif;font-size:17.3px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_005{font-family:Arial,serif;font-size:17.3px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_006{font-family:Arial,serif;font-size:18.6px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_006{font-family:Arial,serif;font-size:18.6px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_007{font-family:Arial,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_007{font-family:Arial,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_008{font-family:Arial,serif;font-size:10.8px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_008{font-family:Arial,serif;font-size:10.8px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_009{font-family:Arial,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_009{font-family:Arial,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_010{font-family:Arial,serif;font-size:22.4px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_010{font-family:Arial,serif;font-size:22.4px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_011{font-family:Arial,serif;font-size:13.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_011{font-family:Arial,serif;font-size:13.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_012{font-family:Arial,serif;font-size:7.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_012{font-family:Arial,serif;font-size:7.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_013{font-family:Arial,serif;font-size:6.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_013{font-family:Arial,serif;font-size:6.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_014{font-family:Arial,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_014{font-family:Arial,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_015{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_015{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_056{font-family:Arial,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: underline}
div.cls_056{font-family:Arial,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_016{font-family:Arial,serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_016{font-family:Arial,serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_059{font-family:Arial,serif;font-size:10.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: underline}
div.cls_059{font-family:Arial,serif;font-size:10.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_017{font-family:Times,serif;font-size:7.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_017{font-family:Times,serif;font-size:7.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_018{font-family:Times,serif;font-size:6.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_018{font-family:Times,serif;font-size:6.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_019{font-family:Times,serif;font-size:5.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_019{font-family:Times,serif;font-size:5.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_020{font-family:Times,serif;font-size:4.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_020{font-family:Times,serif;font-size:4.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_021{font-family:Times,serif;font-size:7.1px;color:rgb(255,255,255);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_021{font-family:Times,serif;font-size:7.1px;color:rgb(255,255,255);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_023{font-family:Times,serif;font-size:6.5px;color:rgb(255,255,255);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_023{font-family:Times,serif;font-size:6.5px;color:rgb(255,255,255);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_024{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_024{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_022{font-family:Times,serif;font-size:9.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_022{font-family:Times,serif;font-size:9.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_025{font-family:Times,serif;font-size:1.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_025{font-family:Times,serif;font-size:1.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_026{font-family:Times,serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_026{font-family:Times,serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_060{font-family:Times,serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: underline}
div.cls_060{font-family:Times,serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_027{font-family:Arial,serif;font-size:6.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_027{font-family:Arial,serif;font-size:6.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_029{font-family:Arial,serif;font-size:6.7px;color:rgb(191,191,191);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_029{font-family:Arial,serif;font-size:6.7px;color:rgb(191,191,191);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_028{font-family:Arial,serif;font-size:6.7px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_028{font-family:Arial,serif;font-size:6.7px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_030{font-family:Times,serif;font-size:5.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_030{font-family:Times,serif;font-size:5.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_031{font-family:Times,serif;font-size:5.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_031{font-family:Times,serif;font-size:5.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_061{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: underline}
div.cls_061{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_032{font-family:Arial,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_032{font-family:Arial,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_033{font-family:Times,serif;font-size:6.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_033{font-family:Times,serif;font-size:6.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_034{font-family:Times,serif;font-size:6.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_034{font-family:Times,serif;font-size:6.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_035{font-family:Arial,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_035{font-family:Arial,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_036{font-family:Arial,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_036{font-family:Arial,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_037{font-family:Arial,serif;font-size:10.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_037{font-family:Arial,serif;font-size:10.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_038{font-family:Arial,serif;font-size:14.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_038{font-family:Arial,serif;font-size:14.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_039{font-family:Arial,serif;font-size:6.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_039{font-family:Arial,serif;font-size:6.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_040{font-family:Times,serif;font-size:5.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_040{font-family:Times,serif;font-size:5.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_041{font-family:Times,serif;font-size:6.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_041{font-family:Times,serif;font-size:6.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_042{font-family:Arial,serif;font-size:10.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_042{font-family:Arial,serif;font-size:10.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_043{font-family:Arial,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_043{font-family:Arial,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_044{font-family:Arial,serif;font-size:4.3px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_044{font-family:Arial,serif;font-size:4.3px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_045{font-family:Arial,serif;font-size:3.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_045{font-family:Arial,serif;font-size:3.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_057{font-family:Arial,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: line-through}
div.cls_057{font-family:Arial,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_046{font-family:Times,serif;font-size:5.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_046{font-family:Times,serif;font-size:5.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_047{font-family:Times,serif;font-size:6.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_047{font-family:Times,serif;font-size:6.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_048{font-family:Times,serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_048{font-family:Times,serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_051{font-family:Courier New,serif;font-size:4.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_051{font-family:Courier New,serif;font-size:4.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_049{font-family:Times,serif;font-size:13.3px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_049{font-family:Times,serif;font-size:13.3px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_050{font-family:Times,serif;font-size:10.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_050{font-family:Times,serif;font-size:10.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_052{font-family:Times,serif;font-size:5.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_052{font-family:Times,serif;font-size:5.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_053{font-family:Times,serif;font-size:5.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_053{font-family:Times,serif;font-size:5.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_054{font-family:Times,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_054{font-family:Times,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_055{font-family:Times,serif;font-size:6.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_055{font-family:Times,serif;font-size:6.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
-->
</style>
<script type="text/javascript" src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/wz_jsgraphics.js"></script>
</head>
<body>
<div style="position:absolute;left:50%;margin-left:-240px;top:0px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background001.jpg" width=481 height=680></div>
<div style="position:absolute;left:105.05px;top:135.93px" class="cls_002"><span class="cls_002">The Purely Functional Software</span></div>
<div style="position:absolute;left:228.96px;top:165.82px" class="cls_002"><span class="cls_002">Deployment Model</span></div>
<div style="position:absolute;left:147.15px;top:216.50px" class="cls_003"><span class="cls_003">Het puur functionele softwaredeploymentmodel</span></div>
<div style="position:absolute;left:183.66px;top:234.43px" class="cls_003"><span class="cls_003">(met een samenvatting in het Nederlands)</span></div>
<div style="position:absolute;left:63.87px;top:392.46px" class="cls_004"><span class="cls_004">Proefschrift ter verkrijging van de graad van doctor aan de Universiteit Utrecht op gezag</span></div>
<div style="position:absolute;left:63.87px;top:404.42px" class="cls_004"><span class="cls_004">van de Rector Magnificus, Prof. dr. W. H. Gispen, ingevolge het besluit van het College</span></div>
<div style="position:absolute;left:63.87px;top:416.37px" class="cls_004"><span class="cls_004">voor Promoties in het openbaar te verdedigen op woensdag 18 januari 2006 des middags</span></div>
<div style="position:absolute;left:63.87px;top:428.33px" class="cls_004"><span class="cls_004">te 12.45 uur</span></div>
<div style="position:absolute;left:63.87px;top:444.76px" class="cls_004"><span class="cls_004">door</span></div>
<div style="position:absolute;left:327.99px;top:473.88px" class="cls_005"><span class="cls_005">Eelco Dolstra</span></div>
<div style="position:absolute;left:241.18px;top:505.04px" class="cls_004"><span class="cls_004">geboren op 18 augustus 1978, te Wageningen</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:690px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background002.jpg" width=481 height=680></div>
<div style="position:absolute;left:65.69px;top:43.45px" class="cls_004"><span class="cls_004">Promotor:</span></div>
<div style="position:absolute;left:129.13px;top:43.45px" class="cls_004"><span class="cls_004">Prof. dr. S. Doaitse Swierstra, Universiteit Utrecht</span></div>
<div style="position:absolute;left:65.69px;top:55.40px" class="cls_004"><span class="cls_004">Copromotor:</span></div>
<div style="position:absolute;left:129.13px;top:55.40px" class="cls_004"><span class="cls_004">Dr. Eelco Visser, Universiteit Utrecht</span></div>
<div style="position:absolute;left:59.72px;top:499.12px" class="cls_004"><span class="cls_004">The work in this thesis has been carried out under the auspices of the research school IPA</span></div>
<div style="position:absolute;left:59.72px;top:511.07px" class="cls_004"><span class="cls_004">(Institute for Programming research and Algorithmics).  Dit proefschrift werd mogelijk</span></div>
<div style="position:absolute;left:59.72px;top:523.03px" class="cls_004"><span class="cls_004">gemaakt met financiële steun van CIBIT|SERC ICT Adviseurs.</span></div>
<div style="position:absolute;left:59.72px;top:540.96px" class="cls_004"><span class="cls_004">Cover illustration: Arthur Rackham (1867-1939), The Rhinegold & The Valkyrie (1910),</span></div>
<div style="position:absolute;left:59.72px;top:552.91px" class="cls_004"><span class="cls_004">illustrations for Richard Wagner’s Der Ring des Nibelungen: the gods enter Walhalla as</span></div>
<div style="position:absolute;left:59.72px;top:564.87px" class="cls_004"><span class="cls_004">the Rhinemaidens lament the loss of their gold.</span></div>
<div style="position:absolute;left:59.72px;top:582.80px" class="cls_004"><span class="cls_004">ISBN 90-393-4130-3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:1380px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background003.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:88.81px" class="cls_006"><span class="cls_006">Acknowledgements</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">This thesis could not have come about without the help of many individuals. Foremost I</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">wish to thank my supervisor and copromotor Eelco Visser. He was also my master’s thesis</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">supervisor, and I was quite happy that we were able to continue to work together on the</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">Variability/TraCE project. He shared my eventual interest in configuration management-</span></div>
<div style="position:absolute;left:63.87px;top:176.55px" class="cls_004"><span class="cls_004">related issues, and package management in particular.  His insights have improved this</span></div>
<div style="position:absolute;left:63.87px;top:188.50px" class="cls_004"><span class="cls_004">research and this thesis at every point.</span></div>
<div style="position:absolute;left:73.84px;top:200.46px" class="cls_004"><span class="cls_004">The Software Engineering Research Center (SERC), now known as CIBIT|SERC ICT</span></div>
<div style="position:absolute;left:63.87px;top:212.41px" class="cls_004"><span class="cls_004">Adviseurs, funded my PhD position. Gert Florijn initiated the variability project and the</span></div>
<div style="position:absolute;left:63.87px;top:224.37px" class="cls_004"><span class="cls_004">discussions with him were a valuable source of insights. The results of the present thesis</span></div>
<div style="position:absolute;left:63.87px;top:236.32px" class="cls_004"><span class="cls_004">are probably not what any of us had expected at the start; but then again, the nice thing</span></div>
<div style="position:absolute;left:63.87px;top:248.28px" class="cls_004"><span class="cls_004">about a term like “variability” is that it can take you in so many directions.</span></div>
<div style="position:absolute;left:73.84px;top:260.23px" class="cls_004"><span class="cls_004">My promotor Doaitse Swierstra gave lots of good advice—but I ended up not imple-</span></div>
<div style="position:absolute;left:63.87px;top:272.19px" class="cls_004"><span class="cls_004">menting his advice to keep this thesis short. I am grateful to the members of the reading</span></div>
<div style="position:absolute;left:63.87px;top:284.14px" class="cls_004"><span class="cls_004">committee—Jörgen van den Berg, Sjaak Brinkkemper, Paul Klint, Alexander Wolf and</span></div>
<div style="position:absolute;left:63.87px;top:296.10px" class="cls_004"><span class="cls_004">Andreas Zeller—for taking the time and effort to go through this book. Karl Trygve Kalle-</span></div>
<div style="position:absolute;left:63.87px;top:308.05px" class="cls_004"><span class="cls_004">berg, Armijn Hemel, Arthur van Dam and Martin Bravenboer gave helpful comments.</span></div>
<div style="position:absolute;left:73.84px;top:320.01px" class="cls_004"><span class="cls_004">Several people have made important contributions to Nix. Notorious workaholic Martin</span></div>
<div style="position:absolute;left:63.87px;top:331.96px" class="cls_004"><span class="cls_004">Bravenboer in particular was an early adopter who contributed to almost every aspect of</span></div>
<div style="position:absolute;left:63.87px;top:343.92px" class="cls_004"><span class="cls_004">the system.  Armijn Hemel (“I am the itch programmers like to scratch”) contributed to</span></div>
<div style="position:absolute;left:63.87px;top:355.87px" class="cls_004"><span class="cls_004">Nixpkgs and initiated the NixOS, which will surely conquer the world.  René de Groot</span></div>
<div style="position:absolute;left:63.87px;top:367.83px" class="cls_004"><span class="cls_004">coined the marketing slogan for NixOS—“Nix moet, alles kan!” Roy van den Broek has</span></div>
<div style="position:absolute;left:63.87px;top:379.78px" class="cls_004"><span class="cls_004">replaced my hacky build farm supervisor with something much nicer (and Web 2.0 compli-</span></div>
<div style="position:absolute;left:63.87px;top:391.74px" class="cls_004"><span class="cls_004">ant!). Eelco Visser, Rob Vermaas and Merijn de Jonge also contributed to Nixpkgs and the</span></div>
<div style="position:absolute;left:63.87px;top:403.69px" class="cls_004"><span class="cls_004">build farm. In addition, it is hard to overestimate the importance of the work done by the</span></div>
<div style="position:absolute;left:63.87px;top:415.65px" class="cls_004"><span class="cls_004">free and open source software community in providing a large body of non-trivial modular</span></div>
<div style="position:absolute;left:63.87px;top:427.60px" class="cls_004"><span class="cls_004">components suitable for validation. Thanks!</span></div>
<div style="position:absolute;left:73.84px;top:439.56px" class="cls_004"><span class="cls_004">The Software Technology group is a very pleasant work environment, and I thank</span></div>
<div style="position:absolute;left:63.87px;top:451.52px" class="cls_004"><span class="cls_004">all my current and former colleagues for that.  I especially thank my roommates Dave</span></div>
<div style="position:absolute;left:63.87px;top:463.47px" class="cls_004"><span class="cls_004">Clarke (“The cause of the software crisis is software”), Frank Atanassow (who demanded</span></div>
<div style="position:absolute;left:63.87px;top:475.43px" class="cls_004"><span class="cls_004">“pointable research”), Merijn de Jonge, Martin Bravenboer, Rob Vermaas and Stefan Hold-</span></div>
<div style="position:absolute;left:63.87px;top:487.38px" class="cls_004"><span class="cls_004">ermans. Andres Löh, Bastiaan Heeren, Arthur Baars, Karina Olmos and Alexey Rodriguez</span></div>
<div style="position:absolute;left:63.87px;top:499.34px" class="cls_004"><span class="cls_004">were more than just good colleagues. Daan Leijen insisted on doing things the right way.</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> #klaplopers</span><span class="cls_004"> provided a nice work environment in virtual space—though whether IRC</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">is a medium that increases productivity remains an unanswered empirical question.</span></div>
<div style="position:absolute;left:73.84px;top:535.20px" class="cls_004"><span class="cls_004">Arthur van Dam and Piet van Oostrum provided valuable assistance in wrestling with</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">TEX. Atze Dijkstra, Bastiaan Heeren and Andres Löh had helpful advice (and code!) for</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">the preparation of this thesis.</span></div>
<div style="position:absolute;left:73.84px;top:571.07px" class="cls_004"><span class="cls_004">And finally I would like to thank my family—Mom, Dad, Jitske and Menno—for their</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">support and love through all these years.</span></div>
<div style="position:absolute;left:413.86px;top:624.87px" class="cls_004"><span class="cls_004">iii</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:2070px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background004.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">iv</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:2760px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background005.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:88.94px" class="cls_006"><span class="cls_006">Contents</span></div>
<div style="position:absolute;left:63.87px;top:154.19px" class="cls_008"><span class="cls_008">I.</span></div>
<div style="position:absolute;left:88.78px;top:154.19px" class="cls_008"><span class="cls_008">Introduction</span></div>
<div style="position:absolute;left:416.19px;top:154.19px" class="cls_008"><span class="cls_008">1</span></div>
<div style="position:absolute;left:63.87px;top:178.16px" class="cls_009"><span class="cls_009">1.</span></div>
<div style="position:absolute;left:88.78px;top:178.16px" class="cls_009"><span class="cls_009">Introduction</span></div>
<div style="position:absolute;left:417.19px;top:178.16px" class="cls_009"><span class="cls_009">3</span></div>
<div style="position:absolute;left:63.87px;top:189.27px" class="cls_004"><span class="cls_004">1.1.</span></div>
<div style="position:absolute;left:88.78px;top:189.27px" class="cls_004"><span class="cls_004">Software deployment</span></div>
<div style="position:absolute;left:417.19px;top:189.27px" class="cls_004"><span class="cls_004">3</span></div>
<div style="position:absolute;left:63.87px;top:201.38px" class="cls_004"><span class="cls_004">1.2.</span></div>
<div style="position:absolute;left:88.78px;top:201.38px" class="cls_004"><span class="cls_004">The state of the art</span></div>
<div style="position:absolute;left:417.19px;top:201.38px" class="cls_004"><span class="cls_004">6</span></div>
<div style="position:absolute;left:63.87px;top:213.49px" class="cls_004"><span class="cls_004">1.3.</span></div>
<div style="position:absolute;left:88.78px;top:213.49px" class="cls_004"><span class="cls_004">Motivation</span></div>
<div style="position:absolute;left:412.21px;top:213.49px" class="cls_004"><span class="cls_004">13</span></div>
<div style="position:absolute;left:63.87px;top:225.60px" class="cls_004"><span class="cls_004">1.4.</span></div>
<div style="position:absolute;left:88.78px;top:225.60px" class="cls_004"><span class="cls_004">The Nix deployment system</span></div>
<div style="position:absolute;left:412.21px;top:225.60px" class="cls_004"><span class="cls_004">14</span></div>
<div style="position:absolute;left:63.87px;top:237.71px" class="cls_004"><span class="cls_004">1.5.</span></div>
<div style="position:absolute;left:88.78px;top:237.71px" class="cls_004"><span class="cls_004">Contributions</span></div>
<div style="position:absolute;left:412.21px;top:237.71px" class="cls_004"><span class="cls_004">14</span></div>
<div style="position:absolute;left:63.87px;top:249.82px" class="cls_004"><span class="cls_004">1.6.</span></div>
<div style="position:absolute;left:88.78px;top:249.82px" class="cls_004"><span class="cls_004">Outline of this thesis</span></div>
<div style="position:absolute;left:412.21px;top:249.82px" class="cls_004"><span class="cls_004">16</span></div>
<div style="position:absolute;left:63.87px;top:261.92px" class="cls_004"><span class="cls_004">1.7.</span></div>
<div style="position:absolute;left:88.78px;top:261.92px" class="cls_004"><span class="cls_004">Notational conventions</span></div>
<div style="position:absolute;left:412.21px;top:261.92px" class="cls_004"><span class="cls_004">17</span></div>
<div style="position:absolute;left:63.87px;top:285.09px" class="cls_009"><span class="cls_009">2.</span></div>
<div style="position:absolute;left:88.78px;top:285.09px" class="cls_009"><span class="cls_009">An Overview of Nix</span></div>
<div style="position:absolute;left:412.21px;top:285.09px" class="cls_009"><span class="cls_009">19</span></div>
<div style="position:absolute;left:63.87px;top:296.21px" class="cls_004"><span class="cls_004">2.1.</span></div>
<div style="position:absolute;left:88.78px;top:296.21px" class="cls_004"><span class="cls_004">The Nix store</span></div>
<div style="position:absolute;left:412.21px;top:296.21px" class="cls_004"><span class="cls_004">19</span></div>
<div style="position:absolute;left:63.87px;top:308.32px" class="cls_004"><span class="cls_004">2.2.</span></div>
<div style="position:absolute;left:88.78px;top:308.32px" class="cls_004"><span class="cls_004">Nix expressions</span></div>
<div style="position:absolute;left:412.21px;top:308.32px" class="cls_004"><span class="cls_004">25</span></div>
<div style="position:absolute;left:63.87px;top:320.42px" class="cls_004"><span class="cls_004">2.3.</span></div>
<div style="position:absolute;left:88.78px;top:320.42px" class="cls_004"><span class="cls_004">Package management</span></div>
<div style="position:absolute;left:412.21px;top:320.42px" class="cls_004"><span class="cls_004">34</span></div>
<div style="position:absolute;left:63.87px;top:332.53px" class="cls_004"><span class="cls_004">2.4.</span></div>
<div style="position:absolute;left:88.78px;top:332.53px" class="cls_004"><span class="cls_004">Store derivations</span></div>
<div style="position:absolute;left:412.21px;top:332.53px" class="cls_004"><span class="cls_004">39</span></div>
<div style="position:absolute;left:63.87px;top:344.64px" class="cls_004"><span class="cls_004">2.5.</span></div>
<div style="position:absolute;left:88.78px;top:344.64px" class="cls_004"><span class="cls_004">Deployment models</span></div>
<div style="position:absolute;left:412.21px;top:344.64px" class="cls_004"><span class="cls_004">42</span></div>
<div style="position:absolute;left:63.87px;top:356.75px" class="cls_004"><span class="cls_004">2.6.</span></div>
<div style="position:absolute;left:88.78px;top:356.75px" class="cls_004"><span class="cls_004">Transparent source/binary deployment</span></div>
<div style="position:absolute;left:412.21px;top:356.75px" class="cls_004"><span class="cls_004">44</span></div>
<div style="position:absolute;left:63.87px;top:392.57px" class="cls_008"><span class="cls_008">II.</span></div>
<div style="position:absolute;left:88.78px;top:392.57px" class="cls_008"><span class="cls_008">Foundations</span></div>
<div style="position:absolute;left:410.20px;top:392.57px" class="cls_008"><span class="cls_008">47</span></div>
<div style="position:absolute;left:63.87px;top:416.54px" class="cls_009"><span class="cls_009">3.</span></div>
<div style="position:absolute;left:88.78px;top:416.54px" class="cls_009"><span class="cls_009">Deployment as Memory Management</span></div>
<div style="position:absolute;left:412.21px;top:416.54px" class="cls_009"><span class="cls_009">49</span></div>
<div style="position:absolute;left:63.87px;top:427.65px" class="cls_004"><span class="cls_004">3.1.</span></div>
<div style="position:absolute;left:88.78px;top:427.65px" class="cls_004"><span class="cls_004">What is a component?</span></div>
<div style="position:absolute;left:412.21px;top:427.65px" class="cls_004"><span class="cls_004">49</span></div>
<div style="position:absolute;left:63.87px;top:439.76px" class="cls_004"><span class="cls_004">3.2.</span></div>
<div style="position:absolute;left:88.78px;top:439.76px" class="cls_004"><span class="cls_004">The file system as memory</span></div>
<div style="position:absolute;left:412.21px;top:439.76px" class="cls_004"><span class="cls_004">52</span></div>
<div style="position:absolute;left:63.87px;top:451.87px" class="cls_004"><span class="cls_004">3.3.</span></div>
<div style="position:absolute;left:88.78px;top:451.87px" class="cls_004"><span class="cls_004">Closures</span></div>
<div style="position:absolute;left:412.21px;top:451.87px" class="cls_004"><span class="cls_004">55</span></div>
<div style="position:absolute;left:63.87px;top:463.98px" class="cls_004"><span class="cls_004">3.4.</span></div>
<div style="position:absolute;left:88.78px;top:463.98px" class="cls_004"><span class="cls_004">A pointer discipline</span></div>
<div style="position:absolute;left:412.21px;top:463.98px" class="cls_004"><span class="cls_004">56</span></div>
<div style="position:absolute;left:63.87px;top:476.09px" class="cls_004"><span class="cls_004">3.5.</span></div>
<div style="position:absolute;left:88.78px;top:476.09px" class="cls_004"><span class="cls_004">Persistence</span></div>
<div style="position:absolute;left:412.21px;top:476.09px" class="cls_004"><span class="cls_004">59</span></div>
<div style="position:absolute;left:63.87px;top:499.26px" class="cls_009"><span class="cls_009">4.</span></div>
<div style="position:absolute;left:88.78px;top:499.26px" class="cls_009"><span class="cls_009">The Nix Expression Language</span></div>
<div style="position:absolute;left:412.21px;top:499.26px" class="cls_009"><span class="cls_009">61</span></div>
<div style="position:absolute;left:63.87px;top:510.37px" class="cls_004"><span class="cls_004">4.1.</span></div>
<div style="position:absolute;left:88.78px;top:510.37px" class="cls_004"><span class="cls_004">Motivation</span></div>
<div style="position:absolute;left:412.21px;top:510.37px" class="cls_004"><span class="cls_004">61</span></div>
<div style="position:absolute;left:63.87px;top:522.48px" class="cls_004"><span class="cls_004">4.2.</span></div>
<div style="position:absolute;left:88.78px;top:522.48px" class="cls_004"><span class="cls_004">Syntax</span></div>
<div style="position:absolute;left:412.21px;top:522.48px" class="cls_004"><span class="cls_004">64</span></div>
<div style="position:absolute;left:63.87px;top:534.59px" class="cls_004"><span class="cls_004">4.2.1. Lexical syntax</span></div>
<div style="position:absolute;left:412.21px;top:534.59px" class="cls_004"><span class="cls_004">66</span></div>
<div style="position:absolute;left:63.87px;top:546.70px" class="cls_004"><span class="cls_004">4.2.2. Context-free syntax</span></div>
<div style="position:absolute;left:412.21px;top:546.70px" class="cls_004"><span class="cls_004">67</span></div>
<div style="position:absolute;left:63.87px;top:558.80px" class="cls_004"><span class="cls_004">4.3.  Semantics</span></div>
<div style="position:absolute;left:412.21px;top:558.80px" class="cls_004"><span class="cls_004">71</span></div>
<div style="position:absolute;left:63.87px;top:570.91px" class="cls_004"><span class="cls_004">4.3.1. Basic values</span></div>
<div style="position:absolute;left:412.21px;top:570.91px" class="cls_004"><span class="cls_004">71</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">4.3.2. Compound values</span></div>
<div style="position:absolute;left:412.21px;top:583.02px" class="cls_004"><span class="cls_004">73</span></div>
<div style="position:absolute;left:417.19px;top:624.87px" class="cls_004"><span class="cls_004">v</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:3450px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background006.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">Contents</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">4.3.3. Substitutions</span></div>
<div style="position:absolute;left:408.05px;top:45.04px" class="cls_004"><span class="cls_004">75</span></div>
<div style="position:absolute;left:59.72px;top:57.98px" class="cls_004"><span class="cls_004">4.3.4. Evaluation rules</span></div>
<div style="position:absolute;left:408.05px;top:57.98px" class="cls_004"><span class="cls_004">76</span></div>
<div style="position:absolute;left:59.72px;top:70.92px" class="cls_004"><span class="cls_004">4.4.</span></div>
<div style="position:absolute;left:84.62px;top:70.92px" class="cls_004"><span class="cls_004">Implementation</span></div>
<div style="position:absolute;left:408.05px;top:70.92px" class="cls_004"><span class="cls_004">81</span></div>
<div style="position:absolute;left:59.72px;top:95.47px" class="cls_009"><span class="cls_009">5.</span></div>
<div style="position:absolute;left:84.62px;top:95.47px" class="cls_009"><span class="cls_009">The Extensional Model</span></div>
<div style="position:absolute;left:408.05px;top:95.47px" class="cls_009"><span class="cls_009">87</span></div>
<div style="position:absolute;left:59.72px;top:107.41px" class="cls_004"><span class="cls_004">5.1.</span></div>
<div style="position:absolute;left:84.62px;top:107.41px" class="cls_004"><span class="cls_004">Cryptographic hashes</span></div>
<div style="position:absolute;left:408.05px;top:107.41px" class="cls_004"><span class="cls_004">87</span></div>
<div style="position:absolute;left:59.72px;top:120.35px" class="cls_004"><span class="cls_004">5.2.</span></div>
<div style="position:absolute;left:84.62px;top:120.35px" class="cls_004"><span class="cls_004">The Nix store</span></div>
<div style="position:absolute;left:408.05px;top:120.35px" class="cls_004"><span class="cls_004">90</span></div>
<div style="position:absolute;left:59.72px;top:133.29px" class="cls_004"><span class="cls_004">5.2.1. File system objects</span></div>
<div style="position:absolute;left:408.05px;top:133.29px" class="cls_004"><span class="cls_004">90</span></div>
<div style="position:absolute;left:59.72px;top:146.23px" class="cls_004"><span class="cls_004">5.2.2. Store paths</span></div>
<div style="position:absolute;left:408.05px;top:146.23px" class="cls_004"><span class="cls_004">92</span></div>
<div style="position:absolute;left:59.72px;top:159.17px" class="cls_004"><span class="cls_004">5.2.3. Path validity and the closure invariant</span></div>
<div style="position:absolute;left:408.05px;top:159.17px" class="cls_004"><span class="cls_004">95</span></div>
<div style="position:absolute;left:59.72px;top:172.11px" class="cls_004"><span class="cls_004">5.3.</span></div>
<div style="position:absolute;left:84.62px;top:172.11px" class="cls_004"><span class="cls_004">Atoms</span></div>
<div style="position:absolute;left:408.05px;top:172.11px" class="cls_004"><span class="cls_004">97</span></div>
<div style="position:absolute;left:59.72px;top:185.05px" class="cls_004"><span class="cls_004">5.4.</span></div>
<div style="position:absolute;left:84.62px;top:185.05px" class="cls_004"><span class="cls_004">Translating Nix expressions to store derivations</span></div>
<div style="position:absolute;left:403.07px;top:185.05px" class="cls_004"><span class="cls_004">100</span></div>
<div style="position:absolute;left:59.72px;top:197.99px" class="cls_004"><span class="cls_004">5.4.1. Fixed-output derivations</span></div>
<div style="position:absolute;left:403.07px;top:197.99px" class="cls_004"><span class="cls_004">106</span></div>
<div style="position:absolute;left:59.72px;top:210.93px" class="cls_004"><span class="cls_004">5.5.</span></div>
<div style="position:absolute;left:84.62px;top:210.93px" class="cls_004"><span class="cls_004">Building store derivations</span></div>
<div style="position:absolute;left:403.07px;top:210.93px" class="cls_004"><span class="cls_004">108</span></div>
<div style="position:absolute;left:59.72px;top:223.86px" class="cls_004"><span class="cls_004">5.5.1. The simple build algorithm</span></div>
<div style="position:absolute;left:403.07px;top:223.86px" class="cls_004"><span class="cls_004">109</span></div>
<div style="position:absolute;left:59.72px;top:236.80px" class="cls_004"><span class="cls_004">5.5.2. Distributed builds</span></div>
<div style="position:absolute;left:403.07px;top:236.80px" class="cls_004"><span class="cls_004">115</span></div>
<div style="position:absolute;left:59.72px;top:249.74px" class="cls_004"><span class="cls_004">5.5.3. Substitutes</span></div>
<div style="position:absolute;left:403.07px;top:249.74px" class="cls_004"><span class="cls_004">118</span></div>
<div style="position:absolute;left:59.72px;top:262.68px" class="cls_004"><span class="cls_004">5.5.4. The parallel build algorithm</span></div>
<div style="position:absolute;left:403.07px;top:262.68px" class="cls_004"><span class="cls_004">121</span></div>
<div style="position:absolute;left:59.72px;top:275.62px" class="cls_004"><span class="cls_004">5.6.</span></div>
<div style="position:absolute;left:84.62px;top:275.62px" class="cls_004"><span class="cls_004">Garbage collection</span></div>
<div style="position:absolute;left:403.07px;top:275.62px" class="cls_004"><span class="cls_004">124</span></div>
<div style="position:absolute;left:59.72px;top:288.56px" class="cls_004"><span class="cls_004">5.6.1. Garbage collection roots</span></div>
<div style="position:absolute;left:403.07px;top:288.56px" class="cls_004"><span class="cls_004">125</span></div>
<div style="position:absolute;left:59.72px;top:301.50px" class="cls_004"><span class="cls_004">5.6.2. Live paths</span></div>
<div style="position:absolute;left:403.07px;top:301.50px" class="cls_004"><span class="cls_004">127</span></div>
<div style="position:absolute;left:59.72px;top:314.44px" class="cls_004"><span class="cls_004">5.6.3. Stop-the-world garbage collection</span></div>
<div style="position:absolute;left:403.07px;top:314.44px" class="cls_004"><span class="cls_004">128</span></div>
<div style="position:absolute;left:59.72px;top:327.38px" class="cls_004"><span class="cls_004">5.6.4. Concurrent garbage collection  . .</span></div>
<div style="position:absolute;left:403.07px;top:327.38px" class="cls_004"><span class="cls_004">131</span></div>
<div style="position:absolute;left:59.72px;top:340.32px" class="cls_004"><span class="cls_004">5.7.</span></div>
<div style="position:absolute;left:84.62px;top:340.32px" class="cls_004"><span class="cls_004">Extensionality</span></div>
<div style="position:absolute;left:403.07px;top:340.32px" class="cls_004"><span class="cls_004">134</span></div>
<div style="position:absolute;left:59.72px;top:364.87px" class="cls_009"><span class="cls_009">6.</span></div>
<div style="position:absolute;left:84.62px;top:364.87px" class="cls_009"><span class="cls_009">The Intensional Model</span></div>
<div style="position:absolute;left:403.06px;top:364.87px" class="cls_009"><span class="cls_009">135</span></div>
<div style="position:absolute;left:59.72px;top:376.81px" class="cls_004"><span class="cls_004">6.1.</span></div>
<div style="position:absolute;left:84.62px;top:376.81px" class="cls_004"><span class="cls_004">Sharing</span></div>
<div style="position:absolute;left:403.07px;top:376.81px" class="cls_004"><span class="cls_004">135</span></div>
<div style="position:absolute;left:59.72px;top:389.75px" class="cls_004"><span class="cls_004">6.2.</span></div>
<div style="position:absolute;left:84.62px;top:389.75px" class="cls_004"><span class="cls_004">Local sharing</span></div>
<div style="position:absolute;left:403.07px;top:389.75px" class="cls_004"><span class="cls_004">139</span></div>
<div style="position:absolute;left:59.72px;top:402.69px" class="cls_004"><span class="cls_004">6.3.</span></div>
<div style="position:absolute;left:84.62px;top:402.69px" class="cls_004"><span class="cls_004">A content-addressable store</span></div>
<div style="position:absolute;left:403.07px;top:402.69px" class="cls_004"><span class="cls_004">140</span></div>
<div style="position:absolute;left:59.72px;top:415.63px" class="cls_004"><span class="cls_004">6.3.1. The hash invariant</span></div>
<div style="position:absolute;left:403.07px;top:415.63px" class="cls_004"><span class="cls_004">141</span></div>
<div style="position:absolute;left:59.72px;top:428.57px" class="cls_004"><span class="cls_004">6.3.2. Hash rewriting</span></div>
<div style="position:absolute;left:403.07px;top:428.57px" class="cls_004"><span class="cls_004">143</span></div>
<div style="position:absolute;left:59.72px;top:441.51px" class="cls_004"><span class="cls_004">6.4.</span></div>
<div style="position:absolute;left:84.62px;top:441.51px" class="cls_004"><span class="cls_004">Semantics</span></div>
<div style="position:absolute;left:403.07px;top:441.51px" class="cls_004"><span class="cls_004">145</span></div>
<div style="position:absolute;left:59.72px;top:454.45px" class="cls_004"><span class="cls_004">6.4.1. Equivalence class collisions</span></div>
<div style="position:absolute;left:403.07px;top:454.45px" class="cls_004"><span class="cls_004">147</span></div>
<div style="position:absolute;left:59.72px;top:467.38px" class="cls_004"><span class="cls_004">6.4.2. Adding store objects</span></div>
<div style="position:absolute;left:403.07px;top:467.38px" class="cls_004"><span class="cls_004">153</span></div>
<div style="position:absolute;left:59.72px;top:480.32px" class="cls_004"><span class="cls_004">6.4.3. Building store derivations</span></div>
<div style="position:absolute;left:403.07px;top:480.32px" class="cls_004"><span class="cls_004">155</span></div>
<div style="position:absolute;left:59.72px;top:493.26px" class="cls_004"><span class="cls_004">6.4.4. Substitutes</span></div>
<div style="position:absolute;left:403.07px;top:493.26px" class="cls_004"><span class="cls_004">157</span></div>
<div style="position:absolute;left:59.72px;top:506.20px" class="cls_004"><span class="cls_004">6.5.</span></div>
<div style="position:absolute;left:84.62px;top:506.20px" class="cls_004"><span class="cls_004">Trust relations</span></div>
<div style="position:absolute;left:403.07px;top:506.20px" class="cls_004"><span class="cls_004">159</span></div>
<div style="position:absolute;left:59.72px;top:519.14px" class="cls_004"><span class="cls_004">6.6.</span></div>
<div style="position:absolute;left:84.62px;top:519.14px" class="cls_004"><span class="cls_004">Related work</span></div>
<div style="position:absolute;left:403.07px;top:519.14px" class="cls_004"><span class="cls_004">159</span></div>
<div style="position:absolute;left:59.72px;top:532.08px" class="cls_004"><span class="cls_004">6.7.</span></div>
<div style="position:absolute;left:84.62px;top:532.08px" class="cls_004"><span class="cls_004">Multiple outputs</span></div>
<div style="position:absolute;left:403.07px;top:532.08px" class="cls_004"><span class="cls_004">160</span></div>
<div style="position:absolute;left:59.72px;top:545.02px" class="cls_004"><span class="cls_004">6.8.</span></div>
<div style="position:absolute;left:84.62px;top:545.02px" class="cls_004"><span class="cls_004">Assumptions about components  .</span></div>
<div style="position:absolute;left:403.07px;top:545.02px" class="cls_004"><span class="cls_004">162</span></div>
<div style="position:absolute;left:59.72px;top:582.23px" class="cls_008"><span class="cls_008">III.</span></div>
<div style="position:absolute;left:84.62px;top:582.23px" class="cls_008"><span class="cls_008">Applications</span></div>
<div style="position:absolute;left:400.06px;top:582.23px" class="cls_008"><span class="cls_008">165</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">vi</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:4140px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background007.jpg" width=481 height=680></div>
<div style="position:absolute;left:386.75px;top:17.14px" class="cls_004"><span class="cls_004">Contents</span></div>
<div style="position:absolute;left:63.87px;top:46.04px" class="cls_009"><span class="cls_009">7.</span></div>
<div style="position:absolute;left:88.78px;top:46.04px" class="cls_009"><span class="cls_009">Software Deployment</span></div>
<div style="position:absolute;left:407.22px;top:46.04px" class="cls_009"><span class="cls_009">167</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">7.1.</span></div>
<div style="position:absolute;left:88.78px;top:56.99px" class="cls_004"><span class="cls_004">The Nix Packages collection</span></div>
<div style="position:absolute;left:407.23px;top:56.99px" class="cls_004"><span class="cls_004">167</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">7.1.1. Principles</span></div>
<div style="position:absolute;left:407.23px;top:68.95px" class="cls_004"><span class="cls_004">170</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">7.1.2. The standard environment</span></div>
<div style="position:absolute;left:407.23px;top:80.90px" class="cls_004"><span class="cls_004">174</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">7.1.3. Ensuring purity</span></div>
<div style="position:absolute;left:407.23px;top:92.86px" class="cls_004"><span class="cls_004">179</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">7.1.4. Supporting third-party binary components</span></div>
<div style="position:absolute;left:407.23px;top:104.82px" class="cls_004"><span class="cls_004">180</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">7.1.5. Experience</span></div>
<div style="position:absolute;left:407.23px;top:116.77px" class="cls_004"><span class="cls_004">181</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">7.2.</span></div>
<div style="position:absolute;left:88.78px;top:128.73px" class="cls_004"><span class="cls_004">User environments</span></div>
<div style="position:absolute;left:407.23px;top:128.73px" class="cls_004"><span class="cls_004">184</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">7.3.</span></div>
<div style="position:absolute;left:88.78px;top:140.68px" class="cls_004"><span class="cls_004">Binary deployment</span></div>
<div style="position:absolute;left:407.23px;top:140.68px" class="cls_004"><span class="cls_004">185</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">7.4.</span></div>
<div style="position:absolute;left:88.78px;top:152.64px" class="cls_004"><span class="cls_004">Deployment policies</span></div>
<div style="position:absolute;left:407.23px;top:152.64px" class="cls_004"><span class="cls_004">187</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">7.5.</span></div>
<div style="position:absolute;left:88.78px;top:164.59px" class="cls_004"><span class="cls_004">Patch deployment</span></div>
<div style="position:absolute;left:407.23px;top:164.59px" class="cls_004"><span class="cls_004">190</span></div>
<div style="position:absolute;left:63.87px;top:176.55px" class="cls_004"><span class="cls_004">7.5.1. Binary patch creation</span></div>
<div style="position:absolute;left:407.23px;top:176.55px" class="cls_004"><span class="cls_004">193</span></div>
<div style="position:absolute;left:63.87px;top:188.50px" class="cls_004"><span class="cls_004">7.5.2. Patch chaining</span></div>
<div style="position:absolute;left:407.23px;top:188.50px" class="cls_004"><span class="cls_004">194</span></div>
<div style="position:absolute;left:63.87px;top:200.46px" class="cls_004"><span class="cls_004">7.5.3. Base selection</span></div>
<div style="position:absolute;left:407.23px;top:200.46px" class="cls_004"><span class="cls_004">196</span></div>
<div style="position:absolute;left:63.87px;top:212.41px" class="cls_004"><span class="cls_004">7.5.4. Experience</span></div>
<div style="position:absolute;left:407.23px;top:212.41px" class="cls_004"><span class="cls_004">198</span></div>
<div style="position:absolute;left:63.87px;top:224.37px" class="cls_004"><span class="cls_004">7.6.</span></div>
<div style="position:absolute;left:88.78px;top:224.37px" class="cls_004"><span class="cls_004">Related work</span></div>
<div style="position:absolute;left:407.23px;top:224.37px" class="cls_004"><span class="cls_004">200</span></div>
<div style="position:absolute;left:63.87px;top:247.28px" class="cls_009"><span class="cls_009">8.</span></div>
<div style="position:absolute;left:88.78px;top:247.28px" class="cls_009"><span class="cls_009">Continuous Integration and Release Management</span></div>
<div style="position:absolute;left:407.22px;top:247.28px" class="cls_009"><span class="cls_009">209</span></div>
<div style="position:absolute;left:63.87px;top:258.24px" class="cls_004"><span class="cls_004">8.1.</span></div>
<div style="position:absolute;left:88.78px;top:258.24px" class="cls_004"><span class="cls_004">Motivation</span></div>
<div style="position:absolute;left:407.23px;top:258.24px" class="cls_004"><span class="cls_004">209</span></div>
<div style="position:absolute;left:63.87px;top:270.20px" class="cls_004"><span class="cls_004">8.2.</span></div>
<div style="position:absolute;left:88.78px;top:270.20px" class="cls_004"><span class="cls_004">The Nix build farm</span></div>
<div style="position:absolute;left:407.23px;top:270.20px" class="cls_004"><span class="cls_004">212</span></div>
<div style="position:absolute;left:63.87px;top:282.15px" class="cls_004"><span class="cls_004">8.3.</span></div>
<div style="position:absolute;left:88.78px;top:282.15px" class="cls_004"><span class="cls_004">Distributed builds</span></div>
<div style="position:absolute;left:407.23px;top:282.15px" class="cls_004"><span class="cls_004">217</span></div>
<div style="position:absolute;left:63.87px;top:294.11px" class="cls_004"><span class="cls_004">8.4.</span></div>
<div style="position:absolute;left:88.78px;top:294.11px" class="cls_004"><span class="cls_004">Discussion and related work</span></div>
<div style="position:absolute;left:407.23px;top:294.11px" class="cls_004"><span class="cls_004">218</span></div>
<div style="position:absolute;left:63.87px;top:317.02px" class="cls_009"><span class="cls_009">9.</span></div>
<div style="position:absolute;left:88.78px;top:317.02px" class="cls_009"><span class="cls_009">Service Deployment</span></div>
<div style="position:absolute;left:407.22px;top:317.02px" class="cls_009"><span class="cls_009">221</span></div>
<div style="position:absolute;left:63.87px;top:327.98px" class="cls_004"><span class="cls_004">9.1.</span></div>
<div style="position:absolute;left:88.78px;top:327.98px" class="cls_004"><span class="cls_004">Overview</span></div>
<div style="position:absolute;left:407.23px;top:327.98px" class="cls_004"><span class="cls_004">222</span></div>
<div style="position:absolute;left:63.87px;top:339.93px" class="cls_004"><span class="cls_004">9.1.1. Service components</span></div>
<div style="position:absolute;left:407.23px;top:339.93px" class="cls_004"><span class="cls_004">222</span></div>
<div style="position:absolute;left:63.87px;top:351.89px" class="cls_004"><span class="cls_004">9.1.2. Service configuration and deployment</span></div>
<div style="position:absolute;left:407.23px;top:351.89px" class="cls_004"><span class="cls_004">223</span></div>
<div style="position:absolute;left:63.87px;top:363.84px" class="cls_004"><span class="cls_004">9.1.3. Capturing component compositions with Nix expressions .</span></div>
<div style="position:absolute;left:407.23px;top:363.84px" class="cls_004"><span class="cls_004">224</span></div>
<div style="position:absolute;left:63.87px;top:375.80px" class="cls_004"><span class="cls_004">9.1.4. Maintaining the service</span></div>
<div style="position:absolute;left:407.23px;top:375.80px" class="cls_004"><span class="cls_004">225</span></div>
<div style="position:absolute;left:63.87px;top:387.75px" class="cls_004"><span class="cls_004">9.2.</span></div>
<div style="position:absolute;left:88.78px;top:387.75px" class="cls_004"><span class="cls_004">Composition of services</span></div>
<div style="position:absolute;left:407.23px;top:387.75px" class="cls_004"><span class="cls_004">225</span></div>
<div style="position:absolute;left:63.87px;top:399.71px" class="cls_004"><span class="cls_004">9.3.</span></div>
<div style="position:absolute;left:88.78px;top:399.71px" class="cls_004"><span class="cls_004">Variability and crosscutting configuration choices</span></div>
<div style="position:absolute;left:407.23px;top:399.71px" class="cls_004"><span class="cls_004">226</span></div>
<div style="position:absolute;left:63.87px;top:411.66px" class="cls_004"><span class="cls_004">9.4.</span></div>
<div style="position:absolute;left:88.78px;top:411.66px" class="cls_004"><span class="cls_004">Distributed deployment</span></div>
<div style="position:absolute;left:407.23px;top:411.66px" class="cls_004"><span class="cls_004">228</span></div>
<div style="position:absolute;left:63.87px;top:423.62px" class="cls_004"><span class="cls_004">9.5.</span></div>
<div style="position:absolute;left:88.78px;top:423.62px" class="cls_004"><span class="cls_004">Experience</span></div>
<div style="position:absolute;left:407.23px;top:423.62px" class="cls_004"><span class="cls_004">230</span></div>
<div style="position:absolute;left:63.87px;top:435.57px" class="cls_004"><span class="cls_004">9.6.</span></div>
<div style="position:absolute;left:88.78px;top:435.57px" class="cls_004"><span class="cls_004">Related work</span></div>
<div style="position:absolute;left:407.23px;top:435.57px" class="cls_004"><span class="cls_004">230</span></div>
<div style="position:absolute;left:63.87px;top:458.49px" class="cls_009"><span class="cls_009">10.</span></div>
<div style="position:absolute;left:88.78px;top:458.49px" class="cls_009"><span class="cls_009">Build Management</span></div>
<div style="position:absolute;left:407.22px;top:458.49px" class="cls_009"><span class="cls_009">233</span></div>
<div style="position:absolute;left:63.87px;top:469.45px" class="cls_004"><span class="cls_004">10.1.</span></div>
<div style="position:absolute;left:88.78px;top:469.45px" class="cls_004"><span class="cls_004">Low-level build management using Nix</span></div>
<div style="position:absolute;left:407.23px;top:469.45px" class="cls_004"><span class="cls_004">233</span></div>
<div style="position:absolute;left:63.87px;top:481.40px" class="cls_004"><span class="cls_004">10.2.</span></div>
<div style="position:absolute;left:88.78px;top:481.40px" class="cls_004"><span class="cls_004">Discussion</span></div>
<div style="position:absolute;left:407.23px;top:481.40px" class="cls_004"><span class="cls_004">238</span></div>
<div style="position:absolute;left:63.87px;top:493.36px" class="cls_004"><span class="cls_004">10.3.</span></div>
<div style="position:absolute;left:88.78px;top:493.36px" class="cls_004"><span class="cls_004">Related work</span></div>
<div style="position:absolute;left:407.23px;top:493.36px" class="cls_004"><span class="cls_004">240</span></div>
<div style="position:absolute;left:63.87px;top:528.92px" class="cls_008"><span class="cls_008">IV.   Conclusion</span></div>
<div style="position:absolute;left:404.22px;top:528.92px" class="cls_008"><span class="cls_008">243</span></div>
<div style="position:absolute;left:63.87px;top:552.64px" class="cls_009"><span class="cls_009">11.</span></div>
<div style="position:absolute;left:88.78px;top:552.64px" class="cls_009"><span class="cls_009">Conclusion</span></div>
<div style="position:absolute;left:407.22px;top:552.64px" class="cls_009"><span class="cls_009">245</span></div>
<div style="position:absolute;left:63.87px;top:563.59px" class="cls_004"><span class="cls_004">11.1. Future work</span></div>
<div style="position:absolute;left:407.23px;top:563.59px" class="cls_004"><span class="cls_004">247</span></div>
<div style="position:absolute;left:411.65px;top:624.87px" class="cls_004"><span class="cls_004">vii</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:4830px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background008.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">Contents</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">viii</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:5520px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background009.jpg" width=481 height=680></div>
<div style="position:absolute;left:217.28px;top:211.75px" class="cls_006"><span class="cls_006">Part I.</span></div>
<div style="position:absolute;left:178.19px;top:257.85px" class="cls_010"><span class="cls_010">Introduction</span></div>
<div style="position:absolute;left:417.19px;top:624.87px" class="cls_004"><span class="cls_004">1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:6210px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background010.jpg" width=481 height=680></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:6210px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background011.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:89.52px" class="cls_006"><span class="cls_006">1. Introduction</span></div>
<div style="position:absolute;left:63.87px;top:132.43px" class="cls_004"><span class="cls_004">This thesis is about getting computer programs from one machine to another—and having</span></div>
<div style="position:absolute;left:63.87px;top:144.39px" class="cls_004"><span class="cls_004">them still work when they get there. This is the problem of software deployment. Though</span></div>
<div style="position:absolute;left:63.87px;top:156.35px" class="cls_004"><span class="cls_004">it is a part of the field of Software Configuration Management (SCM), it has not been a</span></div>
<div style="position:absolute;left:63.87px;top:168.30px" class="cls_004"><span class="cls_004">subject of academic study until quite recently [169]. The development of principles and</span></div>
<div style="position:absolute;left:63.87px;top:180.26px" class="cls_004"><span class="cls_004">tools to support the deployment process has largely been relegated to industry, system</span></div>
<div style="position:absolute;left:63.87px;top:192.21px" class="cls_004"><span class="cls_004">administrators, and Unix hackers.  This has resulted in a large number of often ad hoc</span></div>
<div style="position:absolute;left:63.87px;top:204.17px" class="cls_004"><span class="cls_004">tools that typically automate manual practices but do not address fundamental issues in a</span></div>
<div style="position:absolute;left:63.87px;top:216.12px" class="cls_004"><span class="cls_004">systematic and disciplined way.</span></div>
<div style="position:absolute;left:73.84px;top:228.79px" class="cls_004"><span class="cls_004">This is evidenced by the huge number of mailing list and forum postings about de-</span></div>
<div style="position:absolute;left:63.87px;top:240.75px" class="cls_004"><span class="cls_004">ployment failures, ranging from applications not working due to missing dependencies, to</span></div>
<div style="position:absolute;left:63.87px;top:252.70px" class="cls_004"><span class="cls_004">subtle malfunctions caused by incompatible components. Deployment problems also seem</span></div>
<div style="position:absolute;left:63.87px;top:264.66px" class="cls_004"><span class="cls_004">curiously resistant to automation: the same concrete problems appear time and again. De-</span></div>
<div style="position:absolute;left:63.87px;top:276.61px" class="cls_004"><span class="cls_004">ployment is especially difficult in heavily component-based systems—such as Unix-based</span></div>
<div style="position:absolute;left:63.87px;top:288.57px" class="cls_004"><span class="cls_004">open source software—because the effort of dealing with the dependencies can increase</span></div>
<div style="position:absolute;left:63.87px;top:300.52px" class="cls_004"><span class="cls_004">super-linearly with each additional dependency.</span></div>
<div style="position:absolute;left:73.84px;top:313.19px" class="cls_004"><span class="cls_004">This thesis describes a system for software deployment called Nix that addresses many</span></div>
<div style="position:absolute;left:63.87px;top:325.15px" class="cls_004"><span class="cls_004">of the problems that plague existing deployment systems. In this introductory chapter I</span></div>
<div style="position:absolute;left:63.87px;top:337.10px" class="cls_004"><span class="cls_004">describe the problem of software deployment, give an overview of existing systems and</span></div>
<div style="position:absolute;left:63.87px;top:349.06px" class="cls_004"><span class="cls_004">the limitations that motivated this research, summarise its main contributions, and outline</span></div>
<div style="position:absolute;left:63.87px;top:361.01px" class="cls_004"><span class="cls_004">the structure of this thesis.</span></div>
<div style="position:absolute;left:63.87px;top:395.61px" class="cls_011"><span class="cls_011">1.1. Software deployment</span></div>
<div style="position:absolute;left:63.87px;top:422.19px" class="cls_004"><span class="cls_004">Software deployment is the problem of managing the distribution of software to end-user</span></div>
<div style="position:absolute;left:63.87px;top:434.14px" class="cls_004"><span class="cls_004">machines. That is, a developer has created some piece of software, and this ultimately has</span></div>
<div style="position:absolute;left:63.87px;top:446.10px" class="cls_004"><span class="cls_004">to end up on the machines of end-users.  After the initial installation of the software, it</span></div>
<div style="position:absolute;left:63.87px;top:458.05px" class="cls_004"><span class="cls_004">might need to be upgraded or uninstalled.</span></div>
<div style="position:absolute;left:73.84px;top:470.72px" class="cls_004"><span class="cls_004">Presumably, the developer has tested the software and found it to work sufficiently well,</span></div>
<div style="position:absolute;left:63.87px;top:482.68px" class="cls_004"><span class="cls_004">so the challenge is to make sure that the software works just as well, i.e., the same, on the</span></div>
<div style="position:absolute;left:63.87px;top:494.63px" class="cls_004"><span class="cls_004">end-user machines. I will informally refer to this as correct deployment: given identical</span></div>
<div style="position:absolute;left:63.87px;top:506.59px" class="cls_004"><span class="cls_004">inputs, the software should behave the same on an end-user machine as on the developer</span></div>
<div style="position:absolute;left:63.87px;top:517.52px" class="cls_004"><span class="cls_004">machine</span><span class="cls_012"><sup>1</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:531.21px" class="cls_004"><span class="cls_004">This should be a simple problem. For instance, if the software consists of a set of files,</span></div>
<div style="position:absolute;left:63.87px;top:543.17px" class="cls_004"><span class="cls_004">then deployment should be a simple matter of copying those to the target machines.  In</span></div>
<div style="position:absolute;left:68.36px;top:565.18px" class="cls_013"><span class="cls_013"><sup>1</sup></span><span class="cls_014">I’m making several gross simplifications, of course. First, in general there is no single “developer”. Second,</span></div>
<div style="position:absolute;left:75.83px;top:575.55px" class="cls_014"><span class="cls_014">there are usually several intermediaries between the developer and the end-user, such as a system administra-</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">tor. However, for a discussion of the main issues this will suffice.</span></div>
<div style="position:absolute;left:417.19px;top:624.87px" class="cls_004"><span class="cls_004">3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:6900px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background012.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">1. Introduction</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">practice, deployment turns out to be much harder. This has a number of causes. These fall</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">into two broad categories: environment issues and manageability issues.</span></div>
<div style="position:absolute;left:59.72px;top:89.40px" class="cls_009"><span class="cls_009">Environment issues</span><span class="cls_004">   The first category is essentially about correctness.  The software</span></div>
<div style="position:absolute;left:59.72px;top:101.36px" class="cls_004"><span class="cls_004">might make all sorts of demands about the environment in which it executes: that certain</span></div>
<div style="position:absolute;left:59.72px;top:113.31px" class="cls_004"><span class="cls_004">other software components are present in the system, that certain configuration files exist,</span></div>
<div style="position:absolute;left:59.72px;top:125.27px" class="cls_004"><span class="cls_004">that certain modifications were made to the Windows registry, and so on. If any of those</span></div>
<div style="position:absolute;left:59.72px;top:137.22px" class="cls_004"><span class="cls_004">environmental characteristics does not hold, then there is a possibility that the software</span></div>
<div style="position:absolute;left:59.72px;top:149.18px" class="cls_004"><span class="cls_004">does not work the same as it did on the developer machine. Some concrete issues are the</span></div>
<div style="position:absolute;left:59.72px;top:161.13px" class="cls_004"><span class="cls_004">following:</span></div>
<div style="position:absolute;left:74.66px;top:187.33px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:187.33px" class="cls_004"><span class="cls_004">A software component is almost never self-contained; rather, it depends on other</span></div>
<div style="position:absolute;left:84.62px;top:199.28px" class="cls_004"><span class="cls_004">components to do some work on its behalf. These are its dependencies. For correct</span></div>
<div style="position:absolute;left:84.62px;top:211.24px" class="cls_004"><span class="cls_004">deployment, it is necessary that all dependencies are identified. This identification</span></div>
<div style="position:absolute;left:84.62px;top:223.19px" class="cls_004"><span class="cls_004">is quite hard, however, as it is often difficult to test whether the dependency specifi-</span></div>
<div style="position:absolute;left:84.62px;top:235.15px" class="cls_004"><span class="cls_004">cation is complete. After all, if we forget to specify a dependency, we don’t discover</span></div>
<div style="position:absolute;left:84.62px;top:247.11px" class="cls_004"><span class="cls_004">that fact if the machine on which we are testing already happens to have the depen-</span></div>
<div style="position:absolute;left:84.62px;top:259.06px" class="cls_004"><span class="cls_004">dency installed.</span></div>
<div style="position:absolute;left:74.66px;top:283.26px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:283.26px" class="cls_004"><span class="cls_004">Dependencies are not just a runtime issue. To build a component in the first place we</span></div>
<div style="position:absolute;left:84.62px;top:295.22px" class="cls_004"><span class="cls_004">need certain dependencies (such as compilers), and these need not be the same as the</span></div>
<div style="position:absolute;left:84.62px;top:307.17px" class="cls_004"><span class="cls_004">runtime dependencies, although there may be some overlap. In general, deployment</span></div>
<div style="position:absolute;left:84.62px;top:319.13px" class="cls_004"><span class="cls_004">of the build-time dependencies is not an end-user issue, but it might be in source-</span></div>
<div style="position:absolute;left:84.62px;top:331.08px" class="cls_004"><span class="cls_004">based deployment scenarios; that is, when a component is deployed in source form.</span></div>
<div style="position:absolute;left:84.62px;top:343.04px" class="cls_004"><span class="cls_004">This is common in the open source world.</span></div>
<div style="position:absolute;left:74.66px;top:367.24px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:367.24px" class="cls_004"><span class="cls_004">Dependencies also need to be compatible with what is expected by the referring</span></div>
<div style="position:absolute;left:84.62px;top:379.20px" class="cls_004"><span class="cls_004">component. In general, not all versions of a component will work. This is the case</span></div>
<div style="position:absolute;left:84.62px;top:391.15px" class="cls_004"><span class="cls_004">even in the presence of type-checked interfaces, since interfaces never give a full</span></div>
<div style="position:absolute;left:84.62px;top:403.11px" class="cls_004"><span class="cls_004">specification of the observable behaviour of a component. Also, components often</span></div>
<div style="position:absolute;left:84.62px;top:415.06px" class="cls_004"><span class="cls_004">exhibit build-time variability, meaning that they can be built with or without certain</span></div>
<div style="position:absolute;left:84.62px;top:427.02px" class="cls_004"><span class="cls_004">optional features, or with other parameters selected at build time. Even worse, the</span></div>
<div style="position:absolute;left:84.62px;top:438.97px" class="cls_004"><span class="cls_004">component might be dependent on a specific compiler, or on specific compilation</span></div>
<div style="position:absolute;left:84.62px;top:450.93px" class="cls_004"><span class="cls_004">options being used for its dependencies (e.g., for Application Binary Interface (ABI)</span></div>
<div style="position:absolute;left:84.62px;top:462.88px" class="cls_004"><span class="cls_004">compatibility).</span></div>
<div style="position:absolute;left:74.66px;top:487.09px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:487.09px" class="cls_004"><span class="cls_004">Even if all required dependencies are present, our component still has to find them,</span></div>
<div style="position:absolute;left:84.62px;top:499.04px" class="cls_004"><span class="cls_004">in order to actually establish a concrete composition of components. This is often</span></div>
<div style="position:absolute;left:84.62px;top:511.00px" class="cls_004"><span class="cls_004">a rather labour-intensive part of the deployment process. Examples include setting</span></div>
<div style="position:absolute;left:84.62px;top:522.95px" class="cls_004"><span class="cls_004">up the dynamic linker search path on Unix systems [160], or the</span><span class="cls_007"> CLASSPATH</span><span class="cls_004"> in the</span></div>
<div style="position:absolute;left:84.62px;top:534.91px" class="cls_004"><span class="cls_004">Java environment.</span></div>
<div style="position:absolute;left:74.66px;top:559.11px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:559.11px" class="cls_004"><span class="cls_004">Components can depend on non-software artifacts, such as configuration files, user</span></div>
<div style="position:absolute;left:84.62px;top:571.07px" class="cls_004"><span class="cls_004">accounts, and so on. For instance, a component might keep state in a database that</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">has to be initialised prior to its first use.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">4</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:7590px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background013.jpg" width=481 height=680></div>
<div style="position:absolute;left:316.95px;top:17.14px" class="cls_004"><span class="cls_004">1.1. Software deployment</span></div>
<div style="position:absolute;left:78.82px;top:45.04px" class="cls_004"><span class="cls_004">• Components can require certain hardware characteristics, such as a specific proces-</span></div>
<div style="position:absolute;left:88.78px;top:56.99px" class="cls_004"><span class="cls_004">sor type or a video card. These are somewhat outside the scope of software deploy-</span></div>
<div style="position:absolute;left:88.78px;top:68.95px" class="cls_004"><span class="cls_004">ment, since we can at most check for such properties, not realise them if they are</span></div>
<div style="position:absolute;left:88.78px;top:80.90px" class="cls_004"><span class="cls_004">missing.</span></div>
<div style="position:absolute;left:78.82px;top:100.58px" class="cls_004"><span class="cls_004">• Finally, deployment can be a distributed problem.  A component can depend on</span></div>
<div style="position:absolute;left:88.78px;top:112.54px" class="cls_004"><span class="cls_004">other components running on remote machines or as separate processes on the same</span></div>
<div style="position:absolute;left:88.78px;top:124.49px" class="cls_004"><span class="cls_004">machine. For instance, a typical multi-tier web service consists of an HTTP server,</span></div>
<div style="position:absolute;left:88.78px;top:136.45px" class="cls_004"><span class="cls_004">a server implementing the business logic, and a database server, possibly all running</span></div>
<div style="position:absolute;left:88.78px;top:148.40px" class="cls_004"><span class="cls_004">on different machines.</span></div>
<div style="position:absolute;left:73.84px;top:169.69px" class="cls_004"><span class="cls_004">So we have two problems in deployment: we must identify what our component’s re-</span></div>
<div style="position:absolute;left:63.87px;top:181.65px" class="cls_004"><span class="cls_004">quirements on the environment are, and we must somehow realise those requirements in</span></div>
<div style="position:absolute;left:63.87px;top:193.60px" class="cls_004"><span class="cls_004">the target environment. Realisation might consist of installing dependencies, creating or</span></div>
<div style="position:absolute;left:63.87px;top:205.56px" class="cls_004"><span class="cls_004">modifying configuration files, starting remote processes, and so on.</span></div>
<div style="position:absolute;left:63.87px;top:231.97px" class="cls_009"><span class="cls_009">Manageability issues</span><span class="cls_004">   The second category is about our ability to properly manage the</span></div>
<div style="position:absolute;left:63.87px;top:243.93px" class="cls_004"><span class="cls_004">deployment process. There are all kinds of operations that we need to be able to perform,</span></div>
<div style="position:absolute;left:63.87px;top:255.88px" class="cls_004"><span class="cls_004">such as packaging, transferring, installing, upgrading, uninstalling, and answering various</span></div>
<div style="position:absolute;left:63.87px;top:267.84px" class="cls_004"><span class="cls_004">queries; i.e., we have to be able to support the evolution of a software system. All these</span></div>
<div style="position:absolute;left:63.87px;top:279.79px" class="cls_004"><span class="cls_004">operations require various bits of information, can be time-consuming, and if not done</span></div>
<div style="position:absolute;left:63.87px;top:291.75px" class="cls_004"><span class="cls_004">properly can lead to incorrect deployment. For example:</span></div>
<div style="position:absolute;left:78.82px;top:313.04px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:313.04px" class="cls_004"><span class="cls_004">When we uninstall a component, we have to know what steps to take to safely undo</span></div>
<div style="position:absolute;left:88.78px;top:324.99px" class="cls_004"><span class="cls_004">the installation, e.g., by deleting files and modifying configuration files. At the same</span></div>
<div style="position:absolute;left:88.78px;top:336.95px" class="cls_004"><span class="cls_004">time we must also take care never to remove any component still in use by some</span></div>
<div style="position:absolute;left:88.78px;top:348.90px" class="cls_004"><span class="cls_004">other part of the system.</span></div>
<div style="position:absolute;left:78.82px;top:368.58px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:368.58px" class="cls_004"><span class="cls_004">Likewise, when we perform a component upgrade, we should be careful not to over-</span></div>
<div style="position:absolute;left:88.78px;top:380.53px" class="cls_004"><span class="cls_004">write any part of any component that might induce a failure in another part of the</span></div>
<div style="position:absolute;left:88.78px;top:392.49px" class="cls_004"><span class="cls_004">system. This is the well-known DLL hell, where upgrading or installing one applica-</span></div>
<div style="position:absolute;left:88.78px;top:404.45px" class="cls_004"><span class="cls_004">tion can cause a failure in another application due to shared dynamic libraries. It has</span></div>
<div style="position:absolute;left:88.78px;top:416.40px" class="cls_004"><span class="cls_004">been observed that software systems often suffer from the seemingly inexplicable</span></div>
<div style="position:absolute;left:88.78px;top:428.36px" class="cls_004"><span class="cls_004">phenomenon of “bit rot,” i.e., that applications that worked initially stop working</span></div>
<div style="position:absolute;left:88.78px;top:440.31px" class="cls_004"><span class="cls_004">over time due to changes in the environment [26].</span></div>
<div style="position:absolute;left:78.82px;top:459.99px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:459.99px" class="cls_004"><span class="cls_004">Administrators often want to perform queries such as “to what component does this</span></div>
<div style="position:absolute;left:88.78px;top:471.94px" class="cls_004"><span class="cls_004">file belong?”, “how much disk space will it take to install this component?”, “from</span></div>
<div style="position:absolute;left:88.78px;top:483.90px" class="cls_004"><span class="cls_004">what sources was this component built?”, and so on.</span></div>
<div style="position:absolute;left:78.82px;top:503.57px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:503.57px" class="cls_004"><span class="cls_004">Maintenance of a system means keeping the software up to date. There are many</span></div>
<div style="position:absolute;left:88.78px;top:515.53px" class="cls_004"><span class="cls_004">different policy choices that can be made. For instance, in a network, system ad-</span></div>
<div style="position:absolute;left:88.78px;top:527.48px" class="cls_004"><span class="cls_004">ministrators may want to push updates (such as security fixes) to all client machines</span></div>
<div style="position:absolute;left:88.78px;top:539.44px" class="cls_004"><span class="cls_004">periodically.  On the other hand, if users are allowed to administer their own ma-</span></div>
<div style="position:absolute;left:88.78px;top:551.39px" class="cls_004"><span class="cls_004">chines, it should be possible for them to select components individually.</span></div>
<div style="position:absolute;left:78.82px;top:571.07px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:571.07px" class="cls_004"><span class="cls_004">When we upgrade components, it is important to be able to undo, or roll back the</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_004"><span class="cls_004">effects of the upgrade, if the upgrade turns out to break important functionality. This</span></div>
<div style="position:absolute;left:417.19px;top:624.87px" class="cls_004"><span class="cls_004">5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:8280px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background014.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">1. Introduction</span></div>
<div style="position:absolute;left:84.62px;top:45.04px" class="cls_004"><span class="cls_004">requires both that we remember what the old configuration was, and that we have</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">some way to reproduce the old configuration.</span></div>
<div style="position:absolute;left:74.66px;top:77.11px" class="cls_004"><span class="cls_004">• In heterogeneous networks (i.e., consisting of many different types of machines),</span></div>
<div style="position:absolute;left:84.62px;top:89.06px" class="cls_004"><span class="cls_004">or in small environments (e.g., a home computer), it is not easy to stay up to date</span></div>
<div style="position:absolute;left:84.62px;top:101.02px" class="cls_004"><span class="cls_004">with software updates. In particular in the case of security fixes this is an important</span></div>
<div style="position:absolute;left:84.62px;top:112.97px" class="cls_004"><span class="cls_004">problem. So we need to know what software is in use, whether updates are available,</span></div>
<div style="position:absolute;left:84.62px;top:124.93px" class="cls_004"><span class="cls_004">and whether such updates should be performed.</span></div>
<div style="position:absolute;left:74.66px;top:145.04px" class="cls_004"><span class="cls_004">• Components can often be deployed in both source and binary form. Binary pack-</span></div>
<div style="position:absolute;left:84.62px;top:157.00px" class="cls_004"><span class="cls_004">ages have to be built for each supported platform, and sometimes in several variants</span></div>
<div style="position:absolute;left:84.62px;top:168.95px" class="cls_004"><span class="cls_004">as well.  For instance, the Linux kernel has thousands of build-time configuration</span></div>
<div style="position:absolute;left:84.62px;top:180.91px" class="cls_004"><span class="cls_004">options. This greatly increases the deployment effort, particularly if packaging and</span></div>
<div style="position:absolute;left:84.62px;top:192.86px" class="cls_004"><span class="cls_004">transfer of packages is a manual or semi-automatic process.</span></div>
<div style="position:absolute;left:74.66px;top:212.98px" class="cls_004"><span class="cls_004">• Since components often have a huge amount of variability, we sometimes want to</span></div>
<div style="position:absolute;left:84.62px;top:224.93px" class="cls_004"><span class="cls_004">expose that variability to certain users. For instance, Linux distributors or system</span></div>
<div style="position:absolute;left:84.62px;top:236.89px" class="cls_004"><span class="cls_004">administrators typically want to make specific feature selections.  A deployment</span></div>
<div style="position:absolute;left:84.62px;top:248.84px" class="cls_004"><span class="cls_004">system should support this.</span></div>
<div style="position:absolute;left:59.72px;top:279.78px" class="cls_011"><span class="cls_011">1.2. The state of the art</span></div>
<div style="position:absolute;left:59.72px;top:305.08px" class="cls_004"><span class="cls_004">Having seen some of the main issues in the field of software deployment, we now look at</span></div>
<div style="position:absolute;left:59.72px;top:317.04px" class="cls_004"><span class="cls_004">some representative deployment tools. This section does not aim to provide a full survey</span></div>
<div style="position:absolute;left:59.72px;top:328.99px" class="cls_004"><span class="cls_004">of the field; rather, the goal is to show the main approaches to deployment. Section 7.6 has</span></div>
<div style="position:absolute;left:59.72px;top:340.95px" class="cls_004"><span class="cls_004">a more complete discussion of related work.</span></div>
<div style="position:absolute;left:69.68px;top:352.95px" class="cls_004"><span class="cls_004">Package management is a perennial problem in the Unix community [2]. In fact, entire</span></div>
<div style="position:absolute;left:59.72px;top:364.91px" class="cls_004"><span class="cls_004">operating system distributions rise and fall on the basis of their deployment qualities. It can</span></div>
<div style="position:absolute;left:59.72px;top:376.86px" class="cls_004"><span class="cls_004">be argued that Gentoo Linux’s [77] quick adoption in the Linux community was entirely</span></div>
<div style="position:absolute;left:59.72px;top:388.82px" class="cls_004"><span class="cls_004">due to the perceived strengths of its package management system over those used by other</span></div>
<div style="position:absolute;left:59.72px;top:400.77px" class="cls_004"><span class="cls_004">distributions. This interest in deployment can be traced to Unix’s early adoption in large,</span></div>
<div style="position:absolute;left:59.72px;top:412.73px" class="cls_004"><span class="cls_004">advanced and often academic installations (in contrast to the single PC, single user focus</span></div>
<div style="position:absolute;left:59.72px;top:424.68px" class="cls_004"><span class="cls_004">in the PC industry in a bygone era).</span></div>
<div style="position:absolute;left:69.68px;top:436.69px" class="cls_004"><span class="cls_004">Also, for better or for worse, Unix systems have traditionally insisted on storing com-</span></div>
<div style="position:absolute;left:59.72px;top:448.64px" class="cls_004"><span class="cls_004">ponents in global namespaces in the file system such as the</span><span class="cls_007"> /usr/bin</span><span class="cls_004"> directory. This makes</span></div>
<div style="position:absolute;left:59.72px;top:460.60px" class="cls_004"><span class="cls_004">management tools indispensable. But more importantly, modern Unix components have</span></div>
<div style="position:absolute;left:59.72px;top:472.55px" class="cls_004"><span class="cls_004">fine-grained reuse, often having dozens of dependencies on other components.  Since it</span></div>
<div style="position:absolute;left:59.72px;top:484.51px" class="cls_004"><span class="cls_004">is not desirable to use monolithic distribution (as is generally done in Windows and Mac</span></div>
<div style="position:absolute;left:59.72px;top:496.46px" class="cls_004"><span class="cls_004">OS X, as discussed below), a package management tool is absolutely required to support</span></div>
<div style="position:absolute;left:59.72px;top:508.42px" class="cls_004"><span class="cls_004">the resulting deployment complexity.  Therefore Unix (and specifically, Linux) package</span></div>
<div style="position:absolute;left:59.72px;top:520.37px" class="cls_004"><span class="cls_004">management is what we will look at first.</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_009"><span class="cls_009">RPM</span><span class="cls_004">   The most widely used Linux package management system is the Red Hat Package</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">Manager (RPM) [62], and as it is a good, mature tool it is instructive to look at it in some</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">detail. RPM is a low-level deployment tool: it installs and manages components, keeping</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">meta-information about them to prevent unsafe upgrades or uninstalls.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:8970px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background015.jpg" width=481 height=680></div>
<div style="position:absolute;left:327.55px;top:17.14px" class="cls_004"><span class="cls_004">1.2. The state of the art</span></div>
<div style="position:absolute;left:67.26px;top:49.20px" class="cls_015"><span class="cls_015">Summary:  Hello  World  program</span></div>
<div style="position:absolute;left:245.32px;top:49.20px" class="cls_015"><span class="cls_015">Summary:  Hello  World  GUI</span></div>
<div style="position:absolute;left:67.26px;top:60.16px" class="cls_015"><span class="cls_015">Name:  hello</span></div>
<div style="position:absolute;left:245.32px;top:60.16px" class="cls_015"><span class="cls_015">Name:  xhello</span></div>
<div style="position:absolute;left:67.26px;top:71.12px" class="cls_015"><span class="cls_015">Version:  1.0</span></div>
<div style="position:absolute;left:245.32px;top:71.12px" class="cls_015"><span class="cls_015">Version:  1.4</span></div>
<div style="position:absolute;left:67.26px;top:82.08px" class="cls_015"><span class="cls_015">Source0:  %{name}-%{version}.tar.gz</span></div>
<div style="position:absolute;left:245.32px;top:82.08px" class="cls_015"><span class="cls_015">Source0:  %name-%version.tar.gz</span></div>
<div style="position:absolute;left:245.32px;top:93.03px" class="cls_015"><span class="cls_015">Requires:  hello  >=  1.0</span></div>
<div style="position:absolute;left:354.96px;top:89.77px" class="cls_056"><span class="cls_056">1</span></div>
<div style="position:absolute;left:67.26px;top:103.99px" class="cls_015"><span class="cls_015">%description</span></div>
<div style="position:absolute;left:245.32px;top:103.99px" class="cls_015"><span class="cls_015">Requires:  XFree86</span></div>
<div style="position:absolute;left:67.26px;top:114.95px" class="cls_015"><span class="cls_015">This  program  prints  out  "Hello</span></div>
<div style="position:absolute;left:67.26px;top:125.91px" class="cls_015"><span class="cls_015">World".</span></div>
<div style="position:absolute;left:245.32px;top:125.91px" class="cls_015"><span class="cls_015">%description</span></div>
<div style="position:absolute;left:245.32px;top:136.87px" class="cls_015"><span class="cls_015">This  program  provides  a  graphical</span></div>
<div style="position:absolute;left:67.26px;top:147.83px" class="cls_015"><span class="cls_015">%build</span></div>
<div style="position:absolute;left:245.32px;top:147.83px" class="cls_015"><span class="cls_015">user  interface  around  Hello.</span></div>
<div style="position:absolute;left:67.26px;top:158.79px" class="cls_015"><span class="cls_015">./configure  --prefix=%{_prefix}</span></div>
<div style="position:absolute;left:67.26px;top:169.75px" class="cls_015"><span class="cls_015">make</span></div>
<div style="position:absolute;left:245.32px;top:169.75px" class="cls_015"><span class="cls_015">%build</span></div>
<div style="position:absolute;left:245.32px;top:180.71px" class="cls_015"><span class="cls_015">./configure  --prefix=%_prefix</span></div>
<div style="position:absolute;left:67.26px;top:191.66px" class="cls_015"><span class="cls_015">%install</span></div>
<div style="position:absolute;left:245.32px;top:191.66px" class="cls_015"><span class="cls_015">make</span></div>
<div style="position:absolute;left:67.26px;top:202.62px" class="cls_015"><span class="cls_015">make  install</span></div>
<div style="position:absolute;left:245.32px;top:213.58px" class="cls_015"><span class="cls_015">%install</span></div>
<div style="position:absolute;left:67.26px;top:224.54px" class="cls_015"><span class="cls_015">%files</span></div>
<div style="position:absolute;left:245.32px;top:224.54px" class="cls_015"><span class="cls_015">make  install</span></div>
<div style="position:absolute;left:67.26px;top:235.50px" class="cls_015"><span class="cls_015">/usr/bin/hello</span></div>
<div style="position:absolute;left:67.26px;top:246.46px" class="cls_015"><span class="cls_015">/usr/share/man/man1/hello.1.gz</span></div>
<div style="position:absolute;left:245.32px;top:246.46px" class="cls_015"><span class="cls_015">%files</span></div>
<div style="position:absolute;left:67.26px;top:257.42px" class="cls_015"><span class="cls_015">/etc/hello.conf</span></div>
<div style="position:absolute;left:245.32px;top:257.42px" class="cls_015"><span class="cls_015">/usr/bin/xhello</span></div>
<div style="position:absolute;left:92.24px;top:284.04px" class="cls_004"><span class="cls_004">Figure 1.1.: Spec file for</span><span class="cls_007"> hello</span></div>
<div style="position:absolute;left:268.06px;top:284.04px" class="cls_004"><span class="cls_004">Figure 1.2.: Spec file for</span><span class="cls_007"> xhello</span></div>
<div style="position:absolute;left:73.84px;top:319.98px" class="cls_004"><span class="cls_004">A software component is deployed by packaging it into an RPM package (or simply</span></div>
<div style="position:absolute;left:63.87px;top:331.93px" class="cls_004"><span class="cls_004">RPM), which is an archive file that consists of the files that constitute the component, and</span></div>
<div style="position:absolute;left:63.87px;top:343.89px" class="cls_004"><span class="cls_004">some meta-information about the package. This includes a specification of the dependen-</span></div>
<div style="position:absolute;left:63.87px;top:355.84px" class="cls_004"><span class="cls_004">cies of the package, scripts to be run at various points in the install and uninstall process,</span></div>
<div style="position:absolute;left:63.87px;top:367.80px" class="cls_004"><span class="cls_004">and administrative information such as the originator of the package. RPMs are built from</span></div>
<div style="position:absolute;left:63.87px;top:379.75px" class="cls_004"><span class="cls_004">spec files. Figure 1.1 shows a trivial spec file for an imaginary component called Hello that</span></div>
<div style="position:absolute;left:63.87px;top:391.71px" class="cls_004"><span class="cls_004">provides a command</span><span class="cls_007"> /usr/bin/hello</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:402.89px" class="cls_004"><span class="cls_004">An RPM package is typically produced from source as follows</span><span class="cls_012"><sup>2</sup></span><span class="cls_004">:</span></div>
<div style="position:absolute;left:88.78px;top:428.86px" class="cls_015"><span class="cls_015">$ rpmbuild  -ba  hello.tar.gz</span></div>
<div style="position:absolute;left:63.87px;top:444.28px" class="cls_004"><span class="cls_004">where</span><span class="cls_007"> hello.tar.gz</span><span class="cls_004"> contains the sources of the component and its spec file. The resulting</span></div>
<div style="position:absolute;left:63.87px;top:456.24px" class="cls_004"><span class="cls_004">RPM (say,</span><span class="cls_007"> hello-1.0.i686.rpm</span><span class="cls_004">) must then be transferred to the client machines in some way</span></div>
<div style="position:absolute;left:63.87px;top:468.19px" class="cls_004"><span class="cls_004">that the RPM tool itself does not specify. Once it is on a client machine, it can be installed:</span></div>
<div style="position:absolute;left:88.78px;top:493.13px" class="cls_015"><span class="cls_015">$ rpm  -i  hello-1.0.i686.rpm</span></div>
<div style="position:absolute;left:63.87px;top:508.56px" class="cls_004"><span class="cls_004">Similarly, we can upgrade the package when a new RPM with the same name comes along</span></div>
<div style="position:absolute;left:63.87px;top:520.51px" class="cls_004"><span class="cls_004">(</span><span class="cls_007">rpm -u hello-2.0.i686.rpm</span><span class="cls_004">), and uninstall it (</span><span class="cls_007">rpm -e hello</span><span class="cls_004">). To perform upgrades and unin-</span></div>
<div style="position:absolute;left:63.87px;top:532.47px" class="cls_004"><span class="cls_004">stalls cleanly, it is necessary to track which files belong to what packages. This information</span></div>
<div style="position:absolute;left:63.87px;top:544.42px" class="cls_004"><span class="cls_004">can be queried by users:</span></div>
<div style="position:absolute;left:88.78px;top:569.37px" class="cls_015"><span class="cls_015">$ rpm  -ql  hello</span></div>
<div style="position:absolute;left:68.36px;top:584.11px" class="cls_013"><span class="cls_013"><sup>2</sup></span><span class="cls_014">In this thesis, the prefix</span><span class="cls_016"> $</span><span class="cls_014"> in code samples indicates a Unix shell command.</span></div>
<div style="position:absolute;left:417.19px;top:624.86px" class="cls_004"><span class="cls_004">7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:9660px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background016.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">1. Introduction</span></div>
<div style="position:absolute;left:84.62px;top:50.30px" class="cls_015"><span class="cls_015">/usr/bin/hello</span></div>
<div style="position:absolute;left:84.62px;top:61.25px" class="cls_015"><span class="cls_015">/etc/hello.conf</span></div>
<div style="position:absolute;left:84.62px;top:83.17px" class="cls_015"><span class="cls_015">$ rpm  -qf  /usr/bin/hello</span></div>
<div style="position:absolute;left:84.62px;top:94.13px" class="cls_015"><span class="cls_015">hello-1.0</span></div>
<div style="position:absolute;left:59.72px;top:108.14px" class="cls_004"><span class="cls_004">RPM also maintains a cryptographic hash [145] of the contents of each file as it existed at</span></div>
<div style="position:absolute;left:59.72px;top:120.09px" class="cls_004"><span class="cls_004">installation time. Thus, users can verify that files have not been tampered with.</span></div>
<div style="position:absolute;left:69.68px;top:132.05px" class="cls_004"><span class="cls_004">RPM maintains the integrity of installed packages with respect to the dependency re-</span></div>
<div style="position:absolute;left:59.72px;top:144.00px" class="cls_004"><span class="cls_004">quirements. Figure 1.2 shows another RPM package,</span><span class="cls_007"> xhello</span><span class="cls_004">, that provides a GUI front-end</span></div>
<div style="position:absolute;left:59.72px;top:155.96px" class="cls_004"><span class="cls_004">for</span><span class="cls_007"> hello</span><span class="cls_004"> and thus depends on the</span><span class="cls_007"> hello</span><span class="cls_004"> package (expressed at point</span><span class="cls_014"> </span><span class="cls_056">1</span><span class="cls_059"> </span><span class="cls_004">). When we have the</span></div>
<div style="position:absolute;left:59.72px;top:167.91px" class="cls_007"><span class="cls_007">xhello</span><span class="cls_004"> package installed, we cannot uninstall</span><span class="cls_007"> hello</span><span class="cls_004"> unless</span><span class="cls_007"> xhello</span><span class="cls_004"> is uninstalled also:</span></div>
<div style="position:absolute;left:84.62px;top:191.43px" class="cls_015"><span class="cls_015">$ rpm  -e  hello</span></div>
<div style="position:absolute;left:84.62px;top:202.39px" class="cls_015"><span class="cls_015">hello  is  needed  by  (installed)  xhello-1.4</span></div>
<div style="position:absolute;left:69.68px;top:216.40px" class="cls_004"><span class="cls_004">Similarly, RPM does not allow two packages that contain files with equal path names</span></div>
<div style="position:absolute;left:59.72px;top:228.35px" class="cls_004"><span class="cls_004">to exist simultaneously in the system. For instance, when we have our</span><span class="cls_007"> hello-1.0</span><span class="cls_004"> package</span></div>
<div style="position:absolute;left:59.72px;top:240.31px" class="cls_004"><span class="cls_004">installed, it is not possible to install another package that also installs a file with path name</span></div>
<div style="position:absolute;left:59.72px;top:252.26px" class="cls_007"><span class="cls_007">/usr/bin/hello</span><span class="cls_004">.  In general, this means that we cannot have multiple versions of the same</span></div>
<div style="position:absolute;left:59.72px;top:264.22px" class="cls_004"><span class="cls_004">component installed simultaneously.  It also means that it is hard for multiple users to</span></div>
<div style="position:absolute;left:59.72px;top:276.17px" class="cls_004"><span class="cls_004">independently select, install and manage software.</span></div>
<div style="position:absolute;left:69.68px;top:288.13px" class="cls_004"><span class="cls_004">A fundamental problem of RPM and essentially all general package management sys-</span></div>
<div style="position:absolute;left:59.72px;top:300.08px" class="cls_004"><span class="cls_004">tems is that they cannot reliably determine the correctness of dependency specifications.</span></div>
<div style="position:absolute;left:59.72px;top:312.04px" class="cls_004"><span class="cls_004">In our example,</span><span class="cls_007"> xhello</span><span class="cls_004"> depends on</span><span class="cls_007"> hello</span><span class="cls_004">, and so its spec file will contain a dependency</span></div>
<div style="position:absolute;left:59.72px;top:323.99px" class="cls_004"><span class="cls_004">specification to that effect, e.g.,</span></div>
<div style="position:absolute;left:84.62px;top:347.51px" class="cls_015"><span class="cls_015">Requires:  hello</span></div>
<div style="position:absolute;left:59.72px;top:361.52px" class="cls_004"><span class="cls_004">But what happens when we forget to specify this? When the developer builds and tests the</span></div>
<div style="position:absolute;left:59.72px;top:373.47px" class="cls_004"><span class="cls_004">RPM package, the component will probably work because in all likelihood the developer</span></div>
<div style="position:absolute;left:59.72px;top:385.43px" class="cls_004"><span class="cls_004">has</span><span class="cls_007"> hello</span><span class="cls_004"> installed. If we then deploy</span><span class="cls_007"> xhello</span><span class="cls_004"> to clients, the component will work if</span><span class="cls_007"> hello</span></div>
<div style="position:absolute;left:59.72px;top:397.38px" class="cls_004"><span class="cls_004">happens to have been installed previously. If it was not,</span><span class="cls_007"> xhello</span><span class="cls_004"> may fail mysteriously (Fig-</span></div>
<div style="position:absolute;left:59.72px;top:409.34px" class="cls_004"><span class="cls_004">ure 1.3; black ovals denote broken components). Thus, it is intrinsically hard to validate</span></div>
<div style="position:absolute;left:59.72px;top:421.30px" class="cls_004"><span class="cls_004">dependency specifications. (It is also hard to prevent unnecessary dependencies, but that</span></div>
<div style="position:absolute;left:59.72px;top:433.25px" class="cls_004"><span class="cls_004">does not harm correctness, just efficiency.)  An analysis of the actual number of depen-</span></div>
<div style="position:absolute;left:59.72px;top:445.21px" class="cls_004"><span class="cls_004">dency errors in a large RPM-based Linux distribution is described in [87]. The number of</span></div>
<div style="position:absolute;left:59.72px;top:457.16px" class="cls_004"><span class="cls_004">dependency errors turned out to be quite low, but this is likely to be at least in part due to</span></div>
<div style="position:absolute;left:59.72px;top:469.12px" class="cls_004"><span class="cls_004">the substantial effort invested in specifying complete dependencies. Missing dependencies</span></div>
<div style="position:absolute;left:59.72px;top:481.07px" class="cls_004"><span class="cls_004">lead to incomplete deployment; correct deployment on the other hand requires complete</span></div>
<div style="position:absolute;left:59.72px;top:493.03px" class="cls_004"><span class="cls_004">deployment.</span></div>
<div style="position:absolute;left:69.68px;top:504.98px" class="cls_004"><span class="cls_004">Related to the inability to validate dependency specifications is the fact that dependen-</span></div>
<div style="position:absolute;left:59.72px;top:516.94px" class="cls_004"><span class="cls_004">cies tend to be inexact. Above,</span><span class="cls_007"> xhello</span><span class="cls_004"> required that a component named</span><span class="cls_007"> hello</span><span class="cls_004"> is present—</span></div>
<div style="position:absolute;left:59.72px;top:528.89px" class="cls_004"><span class="cls_004">but it makes no requirements on the actual properties or interfaces of that component. That</span></div>
<div style="position:absolute;left:59.72px;top:540.85px" class="cls_004"><span class="cls_004">is, the dependency specification is nominal</span></div>
<div style="position:absolute;left:240.46px;top:540.85px" class="cls_004"><span class="cls_004">(determined by name only), not by contract</span></div>
<div style="position:absolute;left:59.72px;top:552.80px" class="cls_004"><span class="cls_004">(requiring that the dependency has certain properties).  So any component named</span><span class="cls_007"> hello</span></div>
<div style="position:absolute;left:59.72px;top:564.76px" class="cls_004"><span class="cls_004">satisfies the dependency. Actually, we can require specific versions of the dependency:</span></div>
<div style="position:absolute;left:84.62px;top:588.28px" class="cls_015"><span class="cls_015">Requires:  hello  >=  1.0</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:10350px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background017.jpg" width=481 height=680></div>
<div style="position:absolute;left:327.55px;top:17.14px" class="cls_004"><span class="cls_004">1.2. The state of the art</span></div>
<div style="position:absolute;left:109.32px;top:49.59px" class="cls_017"><span class="cls_017">Producer Site</span></div>
<div style="position:absolute;left:110.88px;top:60.22px" class="cls_017"><span class="cls_017">Application</span></div>
<div style="position:absolute;left:121.57px;top:73.12px" class="cls_017"><span class="cls_017">App</span></div>
<div style="position:absolute;left:292.88px;top:79.78px" class="cls_018"><span class="cls_018">Applications</span></div>
<div style="position:absolute;left:273.24px;top:91.53px" class="cls_018"><span class="cls_018">App1</span></div>
<div style="position:absolute;left:302.26px;top:91.53px" class="cls_018"><span class="cls_018">App2</span></div>
<div style="position:absolute;left:331.28px;top:91.53px" class="cls_018"><span class="cls_018">App3</span></div>
<div style="position:absolute;left:114.81px;top:97.42px" class="cls_017"><span class="cls_017">Libraries</span></div>
<div style="position:absolute;left:95.47px;top:107.46px" class="cls_019"><span class="cls_019">LibA</span></div>
<div style="position:absolute;left:148.76px;top:107.55px" class="cls_019"><span class="cls_019">LibB</span></div>
<div style="position:absolute;left:91.81px;top:113.45px" class="cls_020"><span class="cls_020">version 0.5</span></div>
<div style="position:absolute;left:144.96px;top:113.57px" class="cls_020"><span class="cls_020">version 1.3</span></div>
<div style="position:absolute;left:297.72px;top:113.64px" class="cls_018"><span class="cls_018">Libraries</span></div>
<div style="position:absolute;left:288.10px;top:125.38px" class="cls_018"><span class="cls_018">LibA</span></div>
<div style="position:absolute;left:317.28px;top:125.38px" class="cls_018"><span class="cls_018">LibB</span></div>
<div style="position:absolute;left:214.96px;top:147.47px" class="cls_018"><span class="cls_018">Upgrade of App2</span></div>
<div style="position:absolute;left:357.77px;top:147.47px" class="cls_018"><span class="cls_018">Removal of App3</span></div>
<div style="position:absolute;left:107.57px;top:164.74px" class="cls_017"><span class="cls_017">Consumer Site</span></div>
<div style="position:absolute;left:110.88px;top:175.37px" class="cls_017"><span class="cls_017">Application</span></div>
<div style="position:absolute;left:234.84px;top:176.52px" class="cls_018"><span class="cls_018">Applications</span></div>
<div style="position:absolute;left:350.92px;top:176.52px" class="cls_018"><span class="cls_018">Applications</span></div>
<div style="position:absolute;left:121.57px;top:188.28px" class="cls_021"><span class="cls_021">App</span></div>
<div style="position:absolute;left:215.20px;top:188.26px" class="cls_023"><span class="cls_023">App1</span></div>
<div style="position:absolute;left:243.65px;top:188.26px" class="cls_018"><span class="cls_018">App2'</span></div>
<div style="position:absolute;left:273.24px;top:188.26px" class="cls_018"><span class="cls_018">App3</span></div>
<div style="position:absolute;left:331.28px;top:188.26px" class="cls_023"><span class="cls_023">App1</span></div>
<div style="position:absolute;left:360.30px;top:188.26px" class="cls_018"><span class="cls_018">App2</span></div>
<div style="position:absolute;left:239.68px;top:210.37px" class="cls_018"><span class="cls_018">Libraries</span></div>
<div style="position:absolute;left:355.76px;top:210.37px" class="cls_018"><span class="cls_018">Libraries</span></div>
<div style="position:absolute;left:114.81px;top:212.58px" class="cls_017"><span class="cls_017">Libraries</span></div>
<div style="position:absolute;left:95.47px;top:223.50px" class="cls_019"><span class="cls_019">LibA</span></div>
<div style="position:absolute;left:230.06px;top:222.11px" class="cls_018"><span class="cls_018">LibA</span></div>
<div style="position:absolute;left:258.67px;top:222.11px" class="cls_018"><span class="cls_018">LibB'</span></div>
<div style="position:absolute;left:349.63px;top:220.02px" class="cls_024"><span class="cls_024">?!</span></div>
<div style="position:absolute;left:375.32px;top:222.11px" class="cls_018"><span class="cls_018">LibB</span></div>
<div style="position:absolute;left:91.81px;top:229.50px" class="cls_020"><span class="cls_020">version 0.3</span></div>
<div style="position:absolute;left:151.48px;top:224.71px" class="cls_022"><span class="cls_022">?!</span></div>
<div style="position:absolute;left:261.13px;top:256.34px" class="cls_004"><span class="cls_004">Figure 1.4.: Interference</span></div>
<div style="position:absolute;left:63.87px;top:272.21px" class="cls_004"><span class="cls_004">Figure 1.3.: Incomplete deploy-</span></div>
<div style="position:absolute;left:112.58px;top:284.17px" class="cls_004"><span class="cls_004">ment</span></div>
<div style="position:absolute;left:63.87px;top:314.73px" class="cls_004"><span class="cls_004">which excludes version 1.0. However, such version specifications involve a high degree of</span></div>
<div style="position:absolute;left:63.87px;top:326.68px" class="cls_004"><span class="cls_004">wishful thinking, since we can never in general rely on the fact that any version in an open</span></div>
<div style="position:absolute;left:63.87px;top:338.64px" class="cls_004"><span class="cls_004">range works. For instance, there is no way to know whether future release 1.3.1 of</span><span class="cls_007"> hello</span></div>
<div style="position:absolute;left:63.87px;top:350.59px" class="cls_004"><span class="cls_004">will be backwards compatible. Even “exact” dependencies such as</span></div>
<div style="position:absolute;left:88.78px;top:375.64px" class="cls_015"><span class="cls_015">Require:  hello  =  1.0</span></div>
<div style="position:absolute;left:63.87px;top:391.17px" class="cls_004"><span class="cls_004">are unsafe, because this is still a nominal dependency: we can conceive of any number</span></div>
<div style="position:absolute;left:63.87px;top:403.12px" class="cls_004"><span class="cls_004">of component instances with name</span><span class="cls_007"> hello</span><span class="cls_004"> and version number 1.0 that behave completely</span></div>
<div style="position:absolute;left:63.87px;top:415.08px" class="cls_004"><span class="cls_004">differently. In fact, this is a real problem: Linux distributions from different vendors can</span></div>
<div style="position:absolute;left:63.87px;top:427.03px" class="cls_004"><span class="cls_004">easily have components with equal names (e.g.,</span><span class="cls_007"> glibc-2.3.5</span><span class="cls_004">) that actually have vendor-</span></div>
<div style="position:absolute;left:63.87px;top:438.99px" class="cls_004"><span class="cls_004">specific patches applied, have been built with specific options, compilers, or ABI options,</span></div>
<div style="position:absolute;left:63.87px;top:450.94px" class="cls_004"><span class="cls_004">and so on.</span></div>
<div style="position:absolute;left:73.84px;top:463.18px" class="cls_004"><span class="cls_004">Incomplete dependencies and inexact notions of component compatibility give rise to</span></div>
<div style="position:absolute;left:63.87px;top:475.14px" class="cls_004"><span class="cls_004">interference between components, which is the phenomenon that an operation on one com-</span></div>
<div style="position:absolute;left:63.87px;top:487.09px" class="cls_004"><span class="cls_004">ponent can “break” an essentially unrelated component. Figure 1.4 shows two examples of</span></div>
<div style="position:absolute;left:63.87px;top:499.05px" class="cls_004"><span class="cls_004">interference. In the left scenario, the upgrading of application</span><span class="cls_007"> App2</span><span class="cls_004"> breaks</span><span class="cls_007"> App1</span><span class="cls_004"> because</span></div>
<div style="position:absolute;left:63.87px;top:511.00px" class="cls_004"><span class="cls_004">the new version</span><span class="cls_007"> App2’</span><span class="cls_004"> requires a newer version of</span><span class="cls_007"> LibB’</span><span class="cls_004">, which happens not to be suffi-</span></div>
<div style="position:absolute;left:63.87px;top:522.96px" class="cls_004"><span class="cls_004">ciently backwards compatible. In the right scenario, the uninstallation of</span><span class="cls_007"> App3</span><span class="cls_004"> also breaks</span></div>
<div style="position:absolute;left:63.87px;top:534.91px" class="cls_007"><span class="cls_007">App1</span><span class="cls_004">, because the package manager has removed</span><span class="cls_007"> LibA</span><span class="cls_004"> under the mistaken belief that</span><span class="cls_007"> App3</span></div>
<div style="position:absolute;left:63.87px;top:546.87px" class="cls_004"><span class="cls_004">was the sole user of</span><span class="cls_007"> LibA</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:559.11px" class="cls_004"><span class="cls_004">A more subtle problem in RPM (and most other deployment tools) is that it has the prop-</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">erty of destructive upgrading, which means that components are upgraded by overwriting</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">the files of the old version with those of the new one. This is the case because the new ver-</span></div>
<div style="position:absolute;left:417.19px;top:624.87px" class="cls_004"><span class="cls_004">9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:11040px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background018.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">1.</span></div>
<div style="position:absolute;left:72.17px;top:17.14px" class="cls_004"><span class="cls_004">Introduction</span></div>
<div style="position:absolute;left:257.03px;top:53.57px" class="cls_025"><span class="cls_025">glibc-2.3.3</span></div>
<div style="position:absolute;left:149.69px;top:72.11px" class="cls_025"><span class="cls_025">xextensions-1.0.1</span></div>
<div style="position:absolute;left:178.15px;top:72.11px" class="cls_025"><span class="cls_025">libXau-0.1.1</span></div>
<div style="position:absolute;left:217.71px;top:72.11px" class="cls_025"><span class="cls_025">libXtrans-0.1</span></div>
<div style="position:absolute;left:229.81px;top:72.11px" class="cls_025"><span class="cls_025">xproto-6.6.1</span></div>
<div style="position:absolute;left:190.87px;top:90.72px" class="cls_025"><span class="cls_025">renderext-0.8</span></div>
<div style="position:absolute;left:211.50px;top:90.72px" class="cls_025"><span class="cls_025">libX11-6.2.1</span></div>
<div style="position:absolute;left:267.50px;top:90.72px" class="cls_025"><span class="cls_025">freetype-2.1.5</span></div>
<div style="position:absolute;left:281.31px;top:90.72px" class="cls_025"><span class="cls_025">expat-1.95.8</span></div>
<div style="position:absolute;left:303.18px;top:90.72px" class="cls_025"><span class="cls_025">libICE-6.3.3</span></div>
<div style="position:absolute;left:146.97px;top:109.26px" class="cls_025"><span class="cls_025">libXext-6.4.3</span></div>
<div style="position:absolute;left:174.35px;top:109.26px" class="cls_025"><span class="cls_025">libXrender-0.8.4</span></div>
<div style="position:absolute;left:267.19px;top:109.26px" class="cls_025"><span class="cls_025">fontconfig-2.2.3</span></div>
<div style="position:absolute;left:303.25px;top:109.26px" class="cls_025"><span class="cls_025">libSM-6.0.3</span></div>
<div style="position:absolute;left:330.09px;top:109.26px" class="cls_025"><span class="cls_025">coreutils-5.2.1</span></div>
<div style="position:absolute;left:141.77px;top:127.87px" class="cls_025"><span class="cls_025">libXv-2.2.2</span></div>
<div style="position:absolute;left:215.92px;top:127.87px" class="cls_025"><span class="cls_025">libXft-2.1.6</span></div>
<div style="position:absolute;left:247.18px;top:127.87px" class="cls_025"><span class="cls_025">libXt-0.1.4-cvs</span></div>
<div style="position:absolute;left:345.29px;top:127.87px" class="cls_025"><span class="cls_025">perl-5.8.5</span></div>
<div style="position:absolute;left:82.52px;top:146.41px" class="cls_025"><span class="cls_025">libjpeg-6b</span></div>
<div style="position:absolute;left:103.38px;top:146.41px" class="cls_025"><span class="cls_025">gcc-3.4.2</span></div>
<div style="position:absolute;left:126.03px;top:146.41px" class="cls_025"><span class="cls_025">zlib-1.2.1</span></div>
<div style="position:absolute;left:180.71px;top:146.41px" class="cls_025"><span class="cls_025">glib-2.2.3</span></div>
<div style="position:absolute;left:244.93px;top:146.41px" class="cls_025"><span class="cls_025">xlib-1.0</span></div>
<div style="position:absolute;left:356.93px;top:146.41px" class="cls_025"><span class="cls_025">glib-2.4.7</span></div>
<div style="position:absolute;left:86.78px;top:164.95px" class="cls_025"><span class="cls_025">libtiff-3.6.1</span></div>
<div style="position:absolute;left:103.07px;top:164.95px" class="cls_025"><span class="cls_025">libpng-1.2.7</span></div>
<div style="position:absolute;left:113.93px;top:164.95px" class="cls_025"><span class="cls_025">python-2.3.4</span></div>
<div style="position:absolute;left:166.21px;top:164.95px" class="cls_025"><span class="cls_025">atk-1.2.4</span></div>
<div style="position:absolute;left:215.46px;top:164.95px" class="cls_025"><span class="cls_025">pango-1.2.5</span></div>
<div style="position:absolute;left:275.95px;top:164.95px" class="cls_025"><span class="cls_025">pango-1.4.1</span></div>
<div style="position:absolute;left:314.66px;top:164.95px" class="cls_025"><span class="cls_025">popt-1.7</span></div>
<div style="position:absolute;left:328.31px;top:164.95px" class="cls_025"><span class="cls_025">atk-1.6.1</span></div>
<div style="position:absolute;left:368.72px;top:164.95px" class="cls_025"><span class="cls_025">audiofile-0.2.3</span></div>
<div style="position:absolute;left:381.98px;top:164.95px" class="cls_025"><span class="cls_025">libIDL-0.8.2</span></div>
<div style="position:absolute;left:91.75px;top:183.56px" class="cls_025"><span class="cls_025">zvbi-0.2.8</span></div>
<div style="position:absolute;left:176.44px;top:183.56px" class="cls_025"><span class="cls_025">gtk+-2.2.4</span></div>
<div style="position:absolute;left:219.49px;top:183.56px" class="cls_025"><span class="cls_025">gtk+-2.4.13</span></div>
<div style="position:absolute;left:282.47px;top:183.56px" class="cls_025"><span class="cls_025">libxml2-2.6.13</span></div>
<div style="position:absolute;left:377.25px;top:183.56px" class="cls_025"><span class="cls_025">esound-0.2.32</span></div>
<div style="position:absolute;left:390.43px;top:183.56px" class="cls_025"><span class="cls_025">ORBit2-2.8.3</span></div>
<div style="position:absolute;left:103.54px;top:202.10px" class="cls_025"><span class="cls_025">wxGTK-2.4.2</span></div>
<div style="position:absolute;left:246.33px;top:202.10px" class="cls_025"><span class="cls_025">libglade-2.0.1</span></div>
<div style="position:absolute;left:297.59px;top:202.10px" class="cls_025"><span class="cls_025">GConf-2.4.0.1</span></div>
<div style="position:absolute;left:313.73px;top:202.10px" class="cls_025"><span class="cls_025">libart_lgpl-2.3.16</span></div>
<div style="position:absolute;left:345.99px;top:202.10px" class="cls_025"><span class="cls_025">libbonobo-2.4.2</span></div>
<div style="position:absolute;left:102.68px;top:220.71px" class="cls_025"><span class="cls_025">wxPython-2.4.2.4</span></div>
<div style="position:absolute;left:263.39px;top:220.71px" class="cls_025"><span class="cls_025">libgnomecanvas-2.4.0</span></div>
<div style="position:absolute;left:334.20px;top:220.71px" class="cls_025"><span class="cls_025">gnome-vfs-2.4.2</span></div>
<div style="position:absolute;left:106.72px;top:239.25px" class="cls_025"><span class="cls_025">bittorrent-3.4.2</span></div>
<div style="position:absolute;left:332.49px;top:239.25px" class="cls_025"><span class="cls_025">libgnome-2.0.6</span></div>
<div style="position:absolute;left:291.78px;top:257.86px" class="cls_025"><span class="cls_025">libbonoboui-2.4.1</span></div>
<div style="position:absolute;left:412.07px;top:257.86px" class="cls_025"><span class="cls_025">rte-0.5.2</span></div>
<div style="position:absolute;left:267.11px;top:276.40px" class="cls_025"><span class="cls_025">libgnomeui-2.4.0.1</span></div>
<div style="position:absolute;left:277.50px;top:295.02px" class="cls_025"><span class="cls_025">zapping-0.7</span></div>
<div style="position:absolute;left:71.93px;top:316.90px" class="cls_004"><span class="cls_004">Figure 1.5.: The dependency hell: the runtime dependency graph of Mozilla Firefox</span></div>
<div style="position:absolute;left:59.72px;top:349.77px" class="cls_004"><span class="cls_004">sion typically lives in the same paths in the file system, e.g.,</span><span class="cls_007"> hello-2.0</span><span class="cls_004"> will still install into</span></div>
<div style="position:absolute;left:59.72px;top:361.73px" class="cls_007"><span class="cls_007">/usr/bin/hello</span><span class="cls_004"> and</span><span class="cls_007"> /etc/hello.conf</span><span class="cls_004">. Apart from the resulting inability to have multiple ver-</span></div>
<div style="position:absolute;left:59.72px;top:373.68px" class="cls_004"><span class="cls_004">sions installed at the same time, this gives rise to a temporary inconsistency in the system:</span></div>
<div style="position:absolute;left:59.72px;top:385.64px" class="cls_004"><span class="cls_004">there is a time window in which we have some of the files of the old version, and some of</span></div>
<div style="position:absolute;left:59.72px;top:397.59px" class="cls_004"><span class="cls_004">the new version. Thus, upgrading is not atomic. If a user were to start the Hello program</span></div>
<div style="position:absolute;left:59.72px;top:409.55px" class="cls_004"><span class="cls_004">during this time window, the program might not work at all or misbehave in certain ways.</span></div>
<div style="position:absolute;left:69.68px;top:421.91px" class="cls_004"><span class="cls_004">The main criticism leveled at RPM by some of its users is the difficulty in obtaining RPM</span></div>
<div style="position:absolute;left:59.72px;top:433.87px" class="cls_004"><span class="cls_004">packages. If we want to install a complex, multi-component system such as X.org, KDE,</span></div>
<div style="position:absolute;left:59.72px;top:445.83px" class="cls_004"><span class="cls_004">or GNOME, we have to manually download a possibly large number of RPM packages</span></div>
<div style="position:absolute;left:59.72px;top:457.78px" class="cls_004"><span class="cls_004">until all missing dependencies are resolved. That is, RPM verifies that an installation of a</span></div>
<div style="position:absolute;left:59.72px;top:469.74px" class="cls_004"><span class="cls_004">package proceeds safely according to its spec file, but has no way to resolve problems by</span></div>
<div style="position:absolute;left:59.72px;top:481.69px" class="cls_004"><span class="cls_004">itself if they do occur. This gives rise to the dependency hell, where users find themselves</span></div>
<div style="position:absolute;left:59.72px;top:493.65px" class="cls_004"><span class="cls_004">chasing down RPMs that may not be easy to obtain.  Figure 1.5 shows the dependency</span></div>
<div style="position:absolute;left:59.72px;top:504.57px" class="cls_004"><span class="cls_004">graph of Mozilla Firefox, a popular web browser</span><span class="cls_012"><sup>3</sup></span><span class="cls_004">. Each node is a component that must be</span></div>
<div style="position:absolute;left:59.72px;top:517.56px" class="cls_004"><span class="cls_004">present. This gives an intuition as to the magnitude of the problem.</span></div>
<div style="position:absolute;left:69.68px;top:529.92px" class="cls_004"><span class="cls_004">However, it is not actually a problem that RPM does not obtain packages automatically:</span></div>
<div style="position:absolute;left:59.72px;top:541.88px" class="cls_004"><span class="cls_004">it is in fact a good separation of mechanism and policy.  Higher-level deployment tools</span></div>
<div style="position:absolute;left:59.72px;top:553.84px" class="cls_004"><span class="cls_004">can be built on top of RPM that do provide automatic fetching of packages. Installation</span></div>
<div style="position:absolute;left:64.20px;top:574.65px" class="cls_013"><span class="cls_013"><sup>3</sup></span><span class="cls_014">This picture was produced from the Firefox component in the Nix Packages collection using the</span><span class="cls_016"> nix-env --query</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_016"><span class="cls_016">--graph</span><span class="cls_014"> command and Graphviz [54].</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">10</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:11730px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background019.jpg" width=481 height=680></div>
<div style="position:absolute;left:327.55px;top:17.14px" class="cls_004"><span class="cls_004">1.2. The state of the art</span></div>
<div style="position:absolute;left:184.77px;top:51.14px" class="cls_026"><span class="cls_026">Client machine</span></div>
<div style="position:absolute;left:213.77px;top:76.58px" class="cls_026"><span class="cls_026">calls</span></div>
<div style="position:absolute;left:253.96px;top:74.55px" class="cls_026"><span class="cls_026">rpm</span></div>
<div style="position:absolute;left:336.89px;top:75.06px" class="cls_026"><span class="cls_026">Server 1</span></div>
<div style="position:absolute;left:296.70px;top:79.13px" class="cls_026"><span class="cls_026">refers to</span></div>
<div style="position:absolute;left:155.27px;top:89.30px" class="cls_060"><span class="cls_060">invokes</span></div>
<div style="position:absolute;left:132.88px;top:93.37px" class="cls_026"><span class="cls_026">user</span></div>
<div style="position:absolute;left:186.30px;top:93.37px" class="cls_026"><span class="cls_026">yum</span></div>
<div style="position:absolute;left:212.25px;top:96.42px" class="cls_026"><span class="cls_026">reads</span></div>
<div style="position:absolute;left:296.70px;top:98.46px" class="cls_026"><span class="cls_026">refers to</span></div>
<div style="position:absolute;left:240.23px;top:102.53px" class="cls_026"><span class="cls_026">/etc/yum.conf</span></div>
<div style="position:absolute;left:336.89px;top:102.53px" class="cls_026"><span class="cls_026">Server 2</span></div>
<div style="position:absolute;left:296.70px;top:109.14px" class="cls_026"><span class="cls_026">refers to</span></div>
<div style="position:absolute;left:336.89px;top:130.00px" class="cls_026"><span class="cls_026">Server 3</span></div>
<div style="position:absolute;left:154.27px;top:159.76px" class="cls_004"><span class="cls_004">Figure 1.6.: Software deployment using</span><span class="cls_007"> yum</span></div>
<div style="position:absolute;left:63.87px;top:192.20px" class="cls_004"><span class="cls_004">tools such as SuSE Linux’s YaST have a global view of all available packages in a Linux</span></div>
<div style="position:absolute;left:63.87px;top:204.15px" class="cls_004"><span class="cls_004">distribution, and will automatically download them from a network site or prompt for the</span></div>
<div style="position:absolute;left:63.87px;top:216.11px" class="cls_004"><span class="cls_004">appropriate installation CD or DVD. The tool</span><span class="cls_007"> yum</span><span class="cls_004"> (short for Yellow Dog Updater, Modi-</span></div>
<div style="position:absolute;left:63.87px;top:228.06px" class="cls_004"><span class="cls_004">fied) [174], used among others by the Fedora Core Linux distribution, is a wrapper around</span></div>
<div style="position:absolute;left:63.87px;top:240.02px" class="cls_004"><span class="cls_004">RPM to add support for network repositories from which the tool can automatically ac-</span></div>
<div style="position:absolute;left:63.87px;top:251.97px" class="cls_004"><span class="cls_004">quire packages. Figure 1.6 illustrates a typical</span><span class="cls_007"> yum</span><span class="cls_004"> deployment scenario. Client machines</span></div>
<div style="position:absolute;left:63.87px;top:263.93px" class="cls_004"><span class="cls_004">have a file</span><span class="cls_007"> /etc/yum.conf</span><span class="cls_004"> that contains a list of RPM repositories.  We can then install a</span></div>
<div style="position:absolute;left:63.87px;top:275.88px" class="cls_004"><span class="cls_004">package with all its dependencies by saying, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:300.66px" class="cls_015"><span class="cls_015">$ yum  install  firefox</span></div>
<div style="position:absolute;left:63.87px;top:315.92px" class="cls_004"><span class="cls_004">Yum will consult the repositories defined in</span><span class="cls_007"> /etc/yum.conf</span><span class="cls_004"> to find the appropriate RPM</span></div>
<div style="position:absolute;left:63.87px;top:327.87px" class="cls_004"><span class="cls_004">packages, download them, and install them by calling the RPM tool.</span></div>
<div style="position:absolute;left:63.87px;top:355.48px" class="cls_009"><span class="cls_009">Source deployment models</span><span class="cls_004">   In the open source community there are several operating</span></div>
<div style="position:absolute;left:63.87px;top:367.44px" class="cls_004"><span class="cls_004">system distributions that deploy packages not (primarily) in binary form but in source form.</span></div>
<div style="position:absolute;left:63.87px;top:379.39px" class="cls_004"><span class="cls_004">The main advantage of source deployment is that it allows greater flexibility by allowing</span></div>
<div style="position:absolute;left:63.87px;top:391.35px" class="cls_004"><span class="cls_004">users to make specific build time configuration choices.  For instance, we can optimise</span></div>
<div style="position:absolute;left:63.87px;top:403.30px" class="cls_004"><span class="cls_004">components for our specific processor architecture, or remove all unneeded optional func-</span></div>
<div style="position:absolute;left:63.87px;top:415.26px" class="cls_004"><span class="cls_004">tionality in components. Whether this is actually a desirable feature for end-users is up for</span></div>
<div style="position:absolute;left:63.87px;top:427.21px" class="cls_004"><span class="cls_004">debate, but the ability to easily construct a customised set of component instances is quite</span></div>
<div style="position:absolute;left:63.87px;top:439.17px" class="cls_004"><span class="cls_004">valuable to some users, such as developers, system administrators, deployers of complex</span></div>
<div style="position:absolute;left:63.87px;top:451.12px" class="cls_004"><span class="cls_004">installations, and distributors.</span></div>
<div style="position:absolute;left:73.84px;top:463.27px" class="cls_004"><span class="cls_004">The archetypical source deployment system is the FreeBSD Ports Collection [73]. Pack-</span></div>
<div style="position:absolute;left:63.87px;top:475.23px" class="cls_004"><span class="cls_004">ages in source form (called ports) are essentially Makefiles [56] that describe how to recur-</span></div>
<div style="position:absolute;left:63.87px;top:487.18px" class="cls_004"><span class="cls_004">sively build the dependencies of the package, download the sources of the package, apply</span></div>
<div style="position:absolute;left:63.87px;top:499.14px" class="cls_004"><span class="cls_004">possible FreeBSD-specific patches, build the package, and finally install it in the file sys-</span></div>
<div style="position:absolute;left:63.87px;top:511.09px" class="cls_004"><span class="cls_004">tem. By passing arguments to Make (or editing the Makefile, associated files, and options</span></div>
<div style="position:absolute;left:63.87px;top:523.05px" class="cls_004"><span class="cls_004">in global configuration files), the component can be adapted to local requirements.</span></div>
<div style="position:absolute;left:73.84px;top:535.20px" class="cls_004"><span class="cls_004">An obvious downside to source deployment is its rather considerable resource consump-</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">tion. While binary deployment only requires disk space for the binaries, and possibly net-</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">work resources for obtaining the binary package, source deployment requires resources to</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">obtain and store the sources, CPU time and memory to build the package, and disk space</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">for temporary files and the final results. To make matters worse, binary deployment only</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">11</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:12420px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background020.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">1. Introduction</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">involves runtime dependencies, while source deployment may involve additional depen-</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">dencies that are only used at build time, such as compilers.  Unsurprisingly, FreeBSD</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">therefore also offers a binary deployment option, called packages, which are pre-built</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">ports. However, ports and packages are not quite integrated: for instance, when installing</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">a port, dependencies that might be installed using packages are still built from source.</span></div>
<div style="position:absolute;left:69.68px;top:105.14px" class="cls_004"><span class="cls_004">A further problem with source deployment is that it increases the risk of deployment</span></div>
<div style="position:absolute;left:59.72px;top:117.10px" class="cls_004"><span class="cls_004">failure, as now not just runtime dependencies but also build-time dependencies can affect</span></div>
<div style="position:absolute;left:59.72px;top:129.05px" class="cls_004"><span class="cls_004">the result of the deployment. For instance, if the user’s installed C compiler is not quite</span></div>
<div style="position:absolute;left:59.72px;top:141.01px" class="cls_004"><span class="cls_004">what a component’s developer tested against, there is a slight probability that the com-</span></div>
<div style="position:absolute;left:59.72px;top:152.96px" class="cls_004"><span class="cls_004">ponent fails to build or run correctly—and the product of sufficiently many slight failure</span></div>
<div style="position:absolute;left:59.72px;top:164.92px" class="cls_004"><span class="cls_004">probabilities is a large probability.</span></div>
<div style="position:absolute;left:59.72px;top:193.25px" class="cls_009"><span class="cls_009">Windows and Mac OS</span><span class="cls_004">   Windows and Mac OS X tend to use monolithic deployment</span></div>
<div style="position:absolute;left:59.72px;top:205.21px" class="cls_004"><span class="cls_004">for applications: except for some large-grained dependencies on the operating system en-</span></div>
<div style="position:absolute;left:59.72px;top:217.17px" class="cls_004"><span class="cls_004">vironment (e.g., on the kernel, the core GUI libraries, or Direct X), dependencies tend</span></div>
<div style="position:absolute;left:59.72px;top:229.12px" class="cls_004"><span class="cls_004">to be distributed as part of the application itself, with no sharing of dependencies be-</span></div>
<div style="position:absolute;left:59.72px;top:241.08px" class="cls_004"><span class="cls_004">tween applications.  This can be accomplished through static linking or by having dy-</span></div>
<div style="position:absolute;left:59.72px;top:253.03px" class="cls_004"><span class="cls_004">namic libraries be part of the private namespace (directory tree) of the application (e.g.,</span></div>
<div style="position:absolute;left:59.72px;top:264.99px" class="cls_007"><span class="cls_007">C:\Program Files\MyApp\Foo.DLL</span><span class="cls_004">). While this reduces deployment complexity at the end-</span></div>
<div style="position:absolute;left:59.72px;top:276.94px" class="cls_004"><span class="cls_004">user machine, it has several downsides. First, it removes sharing: if two applications use</span></div>
<div style="position:absolute;left:59.72px;top:288.90px" class="cls_004"><span class="cls_004">the “same” component, they will nevertheless end up using private copies. The result is</span></div>
<div style="position:absolute;left:59.72px;top:300.85px" class="cls_004"><span class="cls_004">increased resource consumption in terms of disk space, RAM, cache efficiency, download</span></div>
<div style="position:absolute;left:59.72px;top:312.81px" class="cls_004"><span class="cls_004">time, and so on. Clearly, it is bad if all or many of Firefox’s dependencies in Figure 1.5</span></div>
<div style="position:absolute;left:59.72px;top:324.76px" class="cls_004"><span class="cls_004">were unshared.  In the worst case, we get a quadratic blowup in the disk space require-</span></div>
<div style="position:absolute;left:59.72px;top:336.72px" class="cls_004"><span class="cls_004">ments: if we have N applications that share the same M dependencies, then we need disk</span></div>
<div style="position:absolute;left:59.72px;top:348.67px" class="cls_004"><span class="cls_004">space Θ(NM) instead of Θ(N + M). Second, it still requires the developer to obtain and</span></div>
<div style="position:absolute;left:59.72px;top:360.63px" class="cls_004"><span class="cls_004">compose the components, typically through a semi-manual process.</span></div>
<div style="position:absolute;left:69.68px;top:372.91px" class="cls_004"><span class="cls_004">Especially elegant from an end-user perspective are Mac OS’s application bundles,</span></div>
<div style="position:absolute;left:59.72px;top:384.87px" class="cls_004"><span class="cls_004">which are directory trees containing all files belonging to an application. Generally, such</span></div>
<div style="position:absolute;left:59.72px;top:396.82px" class="cls_004"><span class="cls_004">bundles are self-contained, except for operating system component dependencies.  Con-</span></div>
<div style="position:absolute;left:59.72px;top:408.78px" class="cls_004"><span class="cls_004">trary to typical Windows applications, they do not have other environment dependencies</span></div>
<div style="position:absolute;left:59.72px;top:420.73px" class="cls_004"><span class="cls_004">such as registry settings. This means that bundles can be copied or moved around in the</span></div>
<div style="position:absolute;left:59.72px;top:432.69px" class="cls_004"><span class="cls_004">file system arbitrarily. For instance, the whole of Microsoft Office X on Mac OS X can be</span></div>
<div style="position:absolute;left:59.72px;top:444.64px" class="cls_004"><span class="cls_004">copied between machines by dragging it from one disk to another. Again, the limitation of</span></div>
<div style="position:absolute;left:59.72px;top:456.60px" class="cls_004"><span class="cls_004">this approach is that it falls apart when components have dependencies on each other. That</span></div>
<div style="position:absolute;left:59.72px;top:467.53px" class="cls_004"><span class="cls_004">is, the bundle approach works only for “top level” components, i.e., end-user applications</span><span class="cls_012"><sup>4</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:59.72px;top:496.89px" class="cls_009"><span class="cls_009">.NET</span><span class="cls_004">   Historically, Windows has suffered from the DLL hell, a result of an unmanaged</span></div>
<div style="position:absolute;left:59.72px;top:508.84px" class="cls_004"><span class="cls_004">global namespace being used to store shared dependencies, e.g., the directory</span><span class="cls_007"> C:\Windows-</span></div>
<div style="position:absolute;left:59.72px;top:520.80px" class="cls_007"><span class="cls_007">\System</span><span class="cls_004">. An installation or uninstallation of one application frequently caused other ap-</span></div>
<div style="position:absolute;left:59.72px;top:532.75px" class="cls_004"><span class="cls_004">plications to break because a shared library (DLL) would be replaced with an incompat-</span></div>
<div style="position:absolute;left:59.72px;top:544.71px" class="cls_004"><span class="cls_004">ible version, or deleted altogether. This is a classic example of component interference.</span></div>
<div style="position:absolute;left:64.20px;top:565.18px" class="cls_013"><span class="cls_013"><sup>4</sup></span><span class="cls_014">For instance, the management of Mac OS X’s BSD-based Unix foundations is a complete mess, which has</span></div>
<div style="position:absolute;left:71.67px;top:575.55px" class="cls_014"><span class="cls_014">prompted the development of tools such as Fink [138], which is based on Debian’s APT system (discussed in</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">Section 7.6).</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:13110px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background021.jpg" width=481 height=680></div>
<div style="position:absolute;left:358.46px;top:17.14px" class="cls_004"><span class="cls_004">1.3. Motivation</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">Microsoft’s .NET platform [17] improves on this situation through its assemblies, which</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">are files that store code and other resources.  Assemblies can have strong names, which</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">are globally unique identifiers signed by the assembly producer. Assemblies can depend</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">on each other through these strong names.  The Global Assembly Cache (GAC) holds a</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">system-wide repository of assemblies, indexed by strong name. If assemblies in the GAC</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">differ in their strong names, they will not overwrite each other. Thus, interference does not</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">happen.</span></div>
<div style="position:absolute;left:73.84px;top:128.92px" class="cls_004"><span class="cls_004">However, the GAC is only intended for shared components. Application code and mis-</span></div>
<div style="position:absolute;left:63.87px;top:140.87px" class="cls_004"><span class="cls_004">cellaneous resources are typically not stored in the GAC, but in application-specific di-</span></div>
<div style="position:absolute;left:63.87px;top:152.83px" class="cls_004"><span class="cls_004">rectories, e.g.,</span><span class="cls_007"> C:\Program Files\MyApp</span><span class="cls_004">. That is, management of those components must</span></div>
<div style="position:absolute;left:63.87px;top:164.78px" class="cls_004"><span class="cls_004">be handled through other mechanisms. Also, the GAC only holds components that use a</span></div>
<div style="position:absolute;left:63.87px;top:176.74px" class="cls_004"><span class="cls_004">specific component technology—.NET assemblies.</span></div>
<div style="position:absolute;left:63.87px;top:204.33px" class="cls_009"><span class="cls_009">Other systems</span><span class="cls_004">   The Zero Install system [112] installs components on demand from net-</span></div>
<div style="position:absolute;left:63.87px;top:216.28px" class="cls_004"><span class="cls_004">work repositories.  On-demand installation is enabled by using a virtual file system that</span></div>
<div style="position:absolute;left:63.87px;top:228.24px" class="cls_004"><span class="cls_004">intercepts file system requests for component files. For instance, when a process accesses</span></div>
<div style="position:absolute;left:63.87px;top:240.19px" class="cls_007"><span class="cls_007">/uri/0install/abiword.org/abiword</span><span class="cls_004">, and this file is not already present in the local component</span></div>
<div style="position:absolute;left:63.87px;top:252.15px" class="cls_004"><span class="cls_004">cache, it is fetched from a repository, at which point the requesting process resumes. Users</span></div>
<div style="position:absolute;left:63.87px;top:264.10px" class="cls_004"><span class="cls_004">can independently install software in this manner, and are unaffected by the actions of other</span></div>
<div style="position:absolute;left:63.87px;top:276.06px" class="cls_004"><span class="cls_004">users. Unfortunately, systems depending on non-portable extensions to the file system face</span></div>
<div style="position:absolute;left:63.87px;top:286.99px" class="cls_004"><span class="cls_004">difficulty in gaining wide adoption</span><span class="cls_012"><sup>5</sup></span><span class="cls_004">. This is especially the case for deployment systems as</span></div>
<div style="position:absolute;left:63.87px;top:299.97px" class="cls_004"><span class="cls_004">they should support a wide variety of platforms.</span></div>
<div style="position:absolute;left:63.87px;top:331.71px" class="cls_011"><span class="cls_011">1.3. Motivation</span></div>
<div style="position:absolute;left:63.87px;top:357.29px" class="cls_004"><span class="cls_004">From the previous discussion of existing deployment systems it should be clear that they</span></div>
<div style="position:absolute;left:63.87px;top:369.24px" class="cls_004"><span class="cls_004">lack important features to support safe and efficient deployment. In particular, they have</span></div>
<div style="position:absolute;left:63.87px;top:381.20px" class="cls_004"><span class="cls_004">some or all of the following problems:</span></div>
<div style="position:absolute;left:78.82px;top:401.70px" class="cls_004"><span class="cls_004">• Dependency specifications are not validated, leading to incomplete deployment.</span></div>
<div style="position:absolute;left:78.82px;top:422.40px" class="cls_004"><span class="cls_004">• Dependency specifications are inexact (e.g., nominal).</span></div>
<div style="position:absolute;left:78.82px;top:443.10px" class="cls_004"><span class="cls_004">• It is not possible to deploy multiple versions or variants of a component side-by-side.</span></div>
<div style="position:absolute;left:78.82px;top:463.80px" class="cls_004"><span class="cls_004">• Components can interfere with each other.</span></div>
<div style="position:absolute;left:78.82px;top:484.49px" class="cls_004"><span class="cls_004">• It is not possible to roll back to previous configurations.</span></div>
<div style="position:absolute;left:78.82px;top:505.19px" class="cls_004"><span class="cls_004">• Upgrade actions are not atomic.</span></div>
<div style="position:absolute;left:78.82px;top:525.89px" class="cls_004"><span class="cls_004">• Applications must be monolithic, i.e., they must statically contain all their depen-</span></div>
<div style="position:absolute;left:88.78px;top:537.84px" class="cls_004"><span class="cls_004">dencies.</span></div>
<div style="position:absolute;left:68.36px;top:555.72px" class="cls_013"><span class="cls_013"><sup>5</sup></span><span class="cls_014">For instance, Apple is moving away from resource forks to bundles in recent releases of its Mac OS. The</span></div>
<div style="position:absolute;left:75.83px;top:566.09px" class="cls_014"><span class="cls_014">former approach stores streams of metadata (such as icons) in files in addition to its regular data contents,</span></div>
<div style="position:absolute;left:75.83px;top:575.55px" class="cls_014"><span class="cls_014">which is not portable. The latter approach on the other hand uses directory trees of regular files to keep such</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">data elements together, which is portable.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">13</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:13800px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background022.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">1. Introduction</span></div>
<div style="position:absolute;left:74.66px;top:45.04px" class="cls_004"><span class="cls_004">• Deployment actions can only be performed by administrators, not by unprivileged</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">users.</span></div>
<div style="position:absolute;left:74.66px;top:75.84px" class="cls_004"><span class="cls_004">• There is no link between binaries and the sources and build processes that built them.</span></div>
<div style="position:absolute;left:74.66px;top:94.69px" class="cls_004"><span class="cls_004">• The system supports either source deployment or binary deployment, but not both;</span></div>
<div style="position:absolute;left:84.62px;top:106.64px" class="cls_004"><span class="cls_004">or it supports both but in a non-unified way.</span></div>
<div style="position:absolute;left:74.66px;top:125.49px" class="cls_004"><span class="cls_004">• It is difficult to adapt components.</span></div>
<div style="position:absolute;left:74.66px;top:144.34px" class="cls_004"><span class="cls_004">• Component composition is manual.</span></div>
<div style="position:absolute;left:74.66px;top:163.19px" class="cls_004"><span class="cls_004">• The component framework is narrowly restricted to components written in a specific</span></div>
<div style="position:absolute;left:84.62px;top:175.14px" class="cls_004"><span class="cls_004">programming language or framework.</span></div>
<div style="position:absolute;left:74.66px;top:193.99px" class="cls_004"><span class="cls_004">• The system depends on non-portable techniques.</span></div>
<div style="position:absolute;left:69.68px;top:211.76px" class="cls_004"><span class="cls_004">The objective of the research described in this thesis is to develop a deployment system</span></div>
<div style="position:absolute;left:59.72px;top:223.71px" class="cls_004"><span class="cls_004">that does not have these problems.</span></div>
<div style="position:absolute;left:59.72px;top:253.90px" class="cls_011"><span class="cls_011">1.4. The Nix deployment system</span></div>
<div style="position:absolute;left:59.72px;top:279.12px" class="cls_004"><span class="cls_004">This thesis describes the Nix deployment system, which overcomes the limitations of con-</span></div>
<div style="position:absolute;left:59.72px;top:291.07px" class="cls_004"><span class="cls_004">temporary deployment tools described above. I describe the concepts and implementation</span></div>
<div style="position:absolute;left:59.72px;top:303.03px" class="cls_004"><span class="cls_004">(how it works), the underlying principles (why it works), our experiences and empirical</span></div>
<div style="position:absolute;left:59.72px;top:314.98px" class="cls_004"><span class="cls_004">validation (that it works), and the application areas to which it can be applied (where it</span></div>
<div style="position:absolute;left:59.72px;top:326.94px" class="cls_004"><span class="cls_004">works).</span></div>
<div style="position:absolute;left:69.68px;top:338.89px" class="cls_004"><span class="cls_004">The main idea of the Nix approach is to store software components in isolation from each</span></div>
<div style="position:absolute;left:59.72px;top:350.85px" class="cls_004"><span class="cls_004">other in a central component store, under path names that contain cryptographic hashes of</span></div>
<div style="position:absolute;left:59.72px;top:362.80px" class="cls_004"><span class="cls_004">all inputs involved in building the component, such as</span><span class="cls_007"> /nix/store/rwmfbhb2znwp...-firefox-</span></div>
<div style="position:absolute;left:59.72px;top:374.76px" class="cls_007"><span class="cls_007">1.0.4</span><span class="cls_004">. As I show in this thesis, this prevents undeclared dependencies and enables support</span></div>
<div style="position:absolute;left:59.72px;top:386.71px" class="cls_004"><span class="cls_004">for side-by-side existence of component versions and variants.</span></div>
<div style="position:absolute;left:59.72px;top:412.75px" class="cls_009"><span class="cls_009">Availability</span><span class="cls_004">   At the time of writing, the Nix system is available as free software at the</span></div>
<div style="position:absolute;left:59.72px;top:424.71px" class="cls_004"><span class="cls_004">homepage of the TraCE project [161].</span></div>
<div style="position:absolute;left:59.72px;top:454.90px" class="cls_011"><span class="cls_011">1.5. Contributions</span></div>
<div style="position:absolute;left:59.72px;top:480.11px" class="cls_004"><span class="cls_004">The main contribution of this thesis is the development of a purely functional deployment</span></div>
<div style="position:absolute;left:59.72px;top:492.07px" class="cls_004"><span class="cls_004">model, which we implemented in the Nix system.  In this model a binary component is</span></div>
<div style="position:absolute;left:59.72px;top:504.02px" class="cls_004"><span class="cls_004">uniquely defined by the declared inputs used to build the component. This enables arbitrary</span></div>
<div style="position:absolute;left:59.72px;top:515.98px" class="cls_004"><span class="cls_004">component instances to exist side by side. I show how such a model can be “retrofitted”</span></div>
<div style="position:absolute;left:59.72px;top:527.93px" class="cls_004"><span class="cls_004">onto existing software that was designed without such a model in mind.</span></div>
<div style="position:absolute;left:69.68px;top:539.89px" class="cls_004"><span class="cls_004">Concretely, the contributions of this thesis are the following.</span></div>
<div style="position:absolute;left:74.66px;top:559.11px" class="cls_004"><span class="cls_004">• The cryptographic hashing scheme used by the Nix component store prevents un-</span></div>
<div style="position:absolute;left:84.62px;top:571.07px" class="cls_004"><span class="cls_004">declared dependencies, giving us complete deployment.  Furthermore it provides</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">support for side-by-side existence of component versions and variants.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">14</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:14490px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background023.jpg" width=481 height=680></div>
<div style="position:absolute;left:347.64px;top:17.14px" class="cls_004"><span class="cls_004">1.5. Contributions</span></div>
<div style="position:absolute;left:78.82px;top:45.04px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:45.04px" class="cls_004"><span class="cls_004">Isolation between components prevents interference.</span></div>
<div style="position:absolute;left:78.82px;top:64.96px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:64.96px" class="cls_004"><span class="cls_004">Users can install software independently from each other, without requiring mutual</span></div>
<div style="position:absolute;left:88.78px;top:76.92px" class="cls_004"><span class="cls_004">trust relations. Components that are common between users are shared, i.e., stored</span></div>
<div style="position:absolute;left:88.78px;top:88.88px" class="cls_004"><span class="cls_004">only once.</span></div>
<div style="position:absolute;left:78.82px;top:108.80px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:108.80px" class="cls_004"><span class="cls_004">Upgrades are atomic; there is no time window in which the system is in an inconsis-</span></div>
<div style="position:absolute;left:88.78px;top:120.76px" class="cls_004"><span class="cls_004">tent state.</span></div>
<div style="position:absolute;left:78.82px;top:140.68px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:140.68px" class="cls_004"><span class="cls_004">Nix supports O(1)-time rollbacks to previous configurations.</span></div>
<div style="position:absolute;left:78.82px;top:160.61px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:160.61px" class="cls_004"><span class="cls_004">Nix supports automatic garbage collection of unused components.</span></div>
<div style="position:absolute;left:78.82px;top:180.53px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:180.53px" class="cls_004"><span class="cls_004">The Nix component language describes not just how to build individual components,</span></div>
<div style="position:absolute;left:88.78px;top:192.49px" class="cls_004"><span class="cls_004">but also compositions. The language is a lazy, purely functional language. This is</span></div>
<div style="position:absolute;left:88.78px;top:204.44px" class="cls_004"><span class="cls_004">a good basis for a component composition language, as it allows dependencies and</span></div>
<div style="position:absolute;left:88.78px;top:216.40px" class="cls_004"><span class="cls_004">variability to be expressed in an elegant and flexible way.</span></div>
<div style="position:absolute;left:78.82px;top:236.32px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:236.32px" class="cls_004"><span class="cls_004">Nix has a transparent source/binary deployment model that marries the best parts</span></div>
<div style="position:absolute;left:88.78px;top:248.28px" class="cls_004"><span class="cls_004">of source deployment models such as the FreeBSD Ports Collection, and binary</span></div>
<div style="position:absolute;left:88.78px;top:260.23px" class="cls_004"><span class="cls_004">deployment models such as RPM. In essence, binary deployment is an automatic</span></div>
<div style="position:absolute;left:88.78px;top:272.19px" class="cls_004"><span class="cls_004">optimisation of source deployment.</span></div>
<div style="position:absolute;left:78.82px;top:292.11px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:292.11px" class="cls_004"><span class="cls_004">Nix is policy-free; it provides mechanisms to implement various deployment poli-</span></div>
<div style="position:absolute;left:88.78px;top:304.07px" class="cls_004"><span class="cls_004">cies, but does not enforce a specific one. Some policies described in this thesis are</span></div>
<div style="position:absolute;left:88.78px;top:316.02px" class="cls_004"><span class="cls_004">channels (in push and pull variants), one-click installations, and pure source deploy-</span></div>
<div style="position:absolute;left:88.78px;top:327.98px" class="cls_004"><span class="cls_004">ments.</span></div>
<div style="position:absolute;left:78.82px;top:347.90px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:347.90px" class="cls_004"><span class="cls_004">I show that a purely functional model supports efficient component upgrades despite</span></div>
<div style="position:absolute;left:88.78px;top:359.86px" class="cls_004"><span class="cls_004">the fact that a change to a fundamental component can propagate massively through</span></div>
<div style="position:absolute;left:88.78px;top:371.81px" class="cls_004"><span class="cls_004">the dependency graph.</span></div>
<div style="position:absolute;left:78.82px;top:391.74px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:391.74px" class="cls_004"><span class="cls_004">Nix supports distributed multi-platform builds in a transparent manner, i.e., a remote</span></div>
<div style="position:absolute;left:88.78px;top:403.69px" class="cls_004"><span class="cls_004">build is indistinguishable from a local build from the perspective of the user.</span></div>
<div style="position:absolute;left:78.82px;top:423.62px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:423.62px" class="cls_004"><span class="cls_004">Nix provides a good basis for the implementation of a build farm, which supports</span></div>
<div style="position:absolute;left:88.78px;top:435.57px" class="cls_004"><span class="cls_004">continuous integration and portability testing. I describe a Nix build farm that has</span></div>
<div style="position:absolute;left:88.78px;top:447.53px" class="cls_004"><span class="cls_004">greatly improved manageability over other build farms and is integrated with release</span></div>
<div style="position:absolute;left:88.78px;top:459.49px" class="cls_004"><span class="cls_004">management, that is, it builds concrete installable components that can be deployed</span></div>
<div style="position:absolute;left:88.78px;top:471.44px" class="cls_004"><span class="cls_004">directly through Nix.</span></div>
<div style="position:absolute;left:78.82px;top:491.37px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:491.37px" class="cls_004"><span class="cls_004">The use of Nix for software deployment extends naturally to the field of service de-</span></div>
<div style="position:absolute;left:88.78px;top:503.32px" class="cls_004"><span class="cls_004">ployment. Services are running processes that provide some useful facility to users,</span></div>
<div style="position:absolute;left:88.78px;top:515.28px" class="cls_004"><span class="cls_004">such as web servers. They consist of software components, static configuration and</span></div>
<div style="position:absolute;left:88.78px;top:527.23px" class="cls_004"><span class="cls_004">data, and mutable state.  The first two aspects can be managed using Nix, and its</span></div>
<div style="position:absolute;left:88.78px;top:539.19px" class="cls_004"><span class="cls_004">advantages—such as rollbacks and side-by-side deployment—apply here as well.</span></div>
<div style="position:absolute;left:78.82px;top:559.11px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:559.11px" class="cls_004"><span class="cls_004">Though Nix is typically used to build large-grained components (i.e., traditional</span></div>
<div style="position:absolute;left:88.78px;top:571.07px" class="cls_004"><span class="cls_004">packages), it can also be used to build small-grained components such as individual</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_004"><span class="cls_004">source files.  When used in this way it is a superior alternative to build managers</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">15</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:15180px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background024.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">1. Introduction</span></div>
<div style="position:absolute;left:84.62px;top:45.04px" class="cls_004"><span class="cls_004">such as Make [56], ensuring complete dependency specifications and enabling more</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">sharing between builds.</span></div>
<div style="position:absolute;left:69.68px;top:83.01px" class="cls_004"><span class="cls_004">The above may sound like a product feature list, which is not necessarily a good thing</span></div>
<div style="position:absolute;left:59.72px;top:94.97px" class="cls_004"><span class="cls_004">as it is always possible to add any feature to a system given enough ad-hockery. However,</span></div>
<div style="position:absolute;left:59.72px;top:106.92px" class="cls_004"><span class="cls_004">these contributions all follow from a small set of principles, foremost among them the</span></div>
<div style="position:absolute;left:59.72px;top:118.88px" class="cls_004"><span class="cls_004">purely functional model.</span></div>
<div style="position:absolute;left:59.72px;top:155.19px" class="cls_011"><span class="cls_011">1.6. Outline of this thesis</span></div>
<div style="position:absolute;left:59.72px;top:182.35px" class="cls_004"><span class="cls_004">This thesis is divided in four parts.  Part I (which includes this chapter) introduces the</span></div>
<div style="position:absolute;left:59.72px;top:194.31px" class="cls_004"><span class="cls_004">problem domain and motivates the Nix system. Chapter 2, “An Overview of Nix”, intro-</span></div>
<div style="position:absolute;left:59.72px;top:206.26px" class="cls_004"><span class="cls_004">duces the Nix system from a high-level perspective (i.e., that of users or authors of Nix</span></div>
<div style="position:absolute;left:59.72px;top:218.22px" class="cls_004"><span class="cls_004">components), and gives some intuitions about the underlying principles.</span></div>
<div style="position:absolute;left:69.68px;top:231.20px" class="cls_004"><span class="cls_004">Part II is about the principles and formal semantics of Nix. The basic philosophy behind</span></div>
<div style="position:absolute;left:59.72px;top:243.15px" class="cls_004"><span class="cls_004">Nix—to solve deployment problems by treating them analogously to memory management</span></div>
<div style="position:absolute;left:59.72px;top:255.11px" class="cls_004"><span class="cls_004">issues in programming languages—is introduced in Chapter 3, “Deployment as Memory</span></div>
<div style="position:absolute;left:59.72px;top:267.06px" class="cls_004"><span class="cls_004">Management”.</span></div>
<div style="position:absolute;left:69.68px;top:280.04px" class="cls_004"><span class="cls_004">The syntax and semantics of the Nix expression language—a purely functional language</span></div>
<div style="position:absolute;left:59.72px;top:292.00px" class="cls_004"><span class="cls_004">used to describe components and compositions—is given in Chapter 4, “The Nix Expres-</span></div>
<div style="position:absolute;left:59.72px;top:303.95px" class="cls_004"><span class="cls_004">sion Language”. This chapter also discusses some interesting aspects of the implementa-</span></div>
<div style="position:absolute;left:59.72px;top:315.91px" class="cls_004"><span class="cls_004">tion of the Nix expression evaluator.</span></div>
<div style="position:absolute;left:69.68px;top:328.89px" class="cls_004"><span class="cls_004">The next two chapters form the technical core of this thesis, as they describe the Nix</span></div>
<div style="position:absolute;left:59.72px;top:340.84px" class="cls_004"><span class="cls_004">component store and the fundamental operations on it. In fact, there are two models for</span></div>
<div style="position:absolute;left:59.72px;top:352.80px" class="cls_004"><span class="cls_004">the Nix store that are subtly different with important consequences. Chapter 5, “The Ex-</span></div>
<div style="position:absolute;left:59.72px;top:364.75px" class="cls_004"><span class="cls_004">tensional Model”, formalises the extensional model, which was the first model and the one</span></div>
<div style="position:absolute;left:59.72px;top:376.71px" class="cls_004"><span class="cls_004">with which we have gained the most experience. This chapter describes the objects that</span></div>
<div style="position:absolute;left:59.72px;top:388.66px" class="cls_004"><span class="cls_004">live in the Nix store, the building of Nix expressions, binary deployment as an optimisation</span></div>
<div style="position:absolute;left:59.72px;top:400.62px" class="cls_004"><span class="cls_004">of source deployment, distributed and multi-platform builds, and garbage collection.</span></div>
<div style="position:absolute;left:69.68px;top:413.60px" class="cls_004"><span class="cls_004">The extensional model however has several downsides, in particular the inability to se-</span></div>
<div style="position:absolute;left:59.72px;top:425.56px" class="cls_004"><span class="cls_004">curely share a Nix store between multiple users.  These problems are fixed in the more</span></div>
<div style="position:absolute;left:59.72px;top:437.51px" class="cls_004"><span class="cls_004">recent intensional model, described in Chapter 6, “The Intensional Model”.</span></div>
<div style="position:absolute;left:69.68px;top:450.49px" class="cls_004"><span class="cls_004">Part III discusses in detail the various applications of Nix. Chapter 7, “Software Deploy-</span></div>
<div style="position:absolute;left:59.72px;top:462.45px" class="cls_004"><span class="cls_004">ment”, is about Nix’s raison d’être, software deployment. It describes principles for Nix</span></div>
<div style="position:absolute;left:59.72px;top:474.40px" class="cls_004"><span class="cls_004">expression writers that help ensure correct deployment, and various policies that deploy</span></div>
<div style="position:absolute;left:59.72px;top:486.36px" class="cls_004"><span class="cls_004">components to clients. The main vehicle for this discussion is the Nix Packages collection</span></div>
<div style="position:absolute;left:59.72px;top:498.31px" class="cls_004"><span class="cls_004">(Nixpkgs), a large set of existing Unix components that we deploy through Nix. Most of</span></div>
<div style="position:absolute;left:59.72px;top:510.27px" class="cls_004"><span class="cls_004">our experience with the Nix system is in the context of the Nix Packages collection, so this</span></div>
<div style="position:absolute;left:59.72px;top:522.22px" class="cls_004"><span class="cls_004">chapter provides a certain level of empirical validation for the Nix approach.</span></div>
<div style="position:absolute;left:69.68px;top:535.20px" class="cls_004"><span class="cls_004">Chapter 8, “Continuous Integration and Release Management”, shows that Nix pro-</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">vides a solid basis for the implementation of a build farm, which is a facility that automati-</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">cally builds software components from a version management repository. This is useful to</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">support continuous integration testing, which provides developers with almost immediate</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">feedback as to whether their changes integrate cleanly with the work of other developers.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">16</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:15870px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background025.jpg" width=481 height=680></div>
<div style="position:absolute;left:310.09px;top:17.14px" class="cls_004"><span class="cls_004">1.7. Notational conventions</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">Also, a Nix build farm can produce concrete releases that can be automatically deployed</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">to user machines, for instance through the channel mechanism described in Chapter 7.</span></div>
<div style="position:absolute;left:73.84px;top:69.24px" class="cls_004"><span class="cls_004">Chapter 9, “Service Deployment”, takes Nix beyond deployment of software compo-</span></div>
<div style="position:absolute;left:63.87px;top:81.20px" class="cls_004"><span class="cls_004">nents and into the realm of service deployment. It shows that Nix extends gracefully into</span></div>
<div style="position:absolute;left:63.87px;top:93.15px" class="cls_004"><span class="cls_004">this domain using several examples of production services deployed using Nix.</span></div>
<div style="position:absolute;left:73.84px;top:105.40px" class="cls_004"><span class="cls_004">Chapter 10, “Build Management”, extends Nix in another direction, towards support for</span></div>
<div style="position:absolute;left:63.87px;top:117.35px" class="cls_004"><span class="cls_004">low-level build management. As stated above, Nix provides exactly the right technology</span></div>
<div style="position:absolute;left:63.87px;top:129.31px" class="cls_004"><span class="cls_004">to implement a build manager that fixes the problems of most contemporary build tools.</span></div>
<div style="position:absolute;left:63.87px;top:157.44px" class="cls_009"><span class="cls_009">Roadmap</span><span class="cls_004">   Different readers will find different parts of this thesis of interest. Chapter 2,</span></div>
<div style="position:absolute;left:63.87px;top:169.40px" class="cls_004"><span class="cls_004">“An Overview of Nix” should be read by anyone. The semantics of the Nix system in Part II</span></div>
<div style="position:absolute;left:63.87px;top:181.35px" class="cls_004"><span class="cls_004">can be skipped—initially, at least—by readers who are interested in Nix as a tool, but is</span></div>
<div style="position:absolute;left:63.87px;top:193.31px" class="cls_004"><span class="cls_004">required reading for those who wish to modify Nix itself. Nix users will be most interested</span></div>
<div style="position:absolute;left:63.87px;top:205.26px" class="cls_004"><span class="cls_004">in the various applications discussed in Part III. Chapter 7, “Software Deployment” on</span></div>
<div style="position:absolute;left:63.87px;top:217.22px" class="cls_004"><span class="cls_004">deployment should not be skipped as it provides an in-depth discussion on Nix expressions,</span></div>
<div style="position:absolute;left:63.87px;top:229.17px" class="cls_004"><span class="cls_004">builders, and deployment mechanisms and policies that are also relevant to the subsequent</span></div>
<div style="position:absolute;left:63.87px;top:241.13px" class="cls_004"><span class="cls_004">application chapters.</span></div>
<div style="position:absolute;left:73.84px;top:253.38px" class="cls_004"><span class="cls_004">Nix users and developers will also find the online manual useful [161].</span></div>
<div style="position:absolute;left:63.87px;top:281.51px" class="cls_009"><span class="cls_009">Origins</span><span class="cls_004">   Parts of this thesis are adapted from earlier publications. Chapter 2, “An Over-</span></div>
<div style="position:absolute;left:63.87px;top:293.46px" class="cls_004"><span class="cls_004">view of Nix” is very loosely based on the LISA ’04 paper “Nix:  A Safe and Policy-</span></div>
<div style="position:absolute;left:63.87px;top:305.42px" class="cls_004"><span class="cls_004">Free System for Software Deployment”, co-authored with Merijn de Jonge and Eelco</span></div>
<div style="position:absolute;left:63.87px;top:317.37px" class="cls_004"><span class="cls_004">Visser [50]. Chapter 3, “Deployment as Memory Management” is based on Sections 3-6 of</span></div>
<div style="position:absolute;left:63.87px;top:329.33px" class="cls_004"><span class="cls_004">the ICSE 2004 paper “Imposing a Memory Management Discipline on Software Deploy-</span></div>
<div style="position:absolute;left:63.87px;top:341.28px" class="cls_004"><span class="cls_004">ment”, written with Eelco Visser and Merijn de Jonge [52]. Chapter 6, “The Intensional</span></div>
<div style="position:absolute;left:63.87px;top:353.24px" class="cls_004"><span class="cls_004">Model” is based on the ASE 2005 paper “Secure Sharing Between Untrusted Users in a</span></div>
<div style="position:absolute;left:63.87px;top:365.20px" class="cls_004"><span class="cls_004">Transparent Source/Binary Deployment Model” [48].  Section 7.5 on patch deployment</span></div>
<div style="position:absolute;left:63.87px;top:377.15px" class="cls_004"><span class="cls_004">appeared as the CBSE 2005 paper “Efficient Upgrading in a Purely Functional Compo-</span></div>
<div style="position:absolute;left:63.87px;top:389.11px" class="cls_004"><span class="cls_004">nent Deployment Model” [47]. Chapter 9, “Service Deployment” is based on the SCM-12</span></div>
<div style="position:absolute;left:63.87px;top:401.06px" class="cls_004"><span class="cls_004">paper “Service Configuration Management”, written with Martin Bravenboer and Eelco</span></div>
<div style="position:absolute;left:63.87px;top:413.02px" class="cls_004"><span class="cls_004">Visser [49].  Snippets of Section 10.2 were taken from the SCM-11 paper “Integrating</span></div>
<div style="position:absolute;left:63.87px;top:424.97px" class="cls_004"><span class="cls_004">Software Construction and Software Deployment” [46].</span></div>
<div style="position:absolute;left:63.87px;top:457.25px" class="cls_011"><span class="cls_011">1.7. Notational conventions</span></div>
<div style="position:absolute;left:63.87px;top:483.02px" class="cls_004"><span class="cls_004">Part II of this thesis contains a number of algorithms in a pseudo-code notation in an im-</span></div>
<div style="position:absolute;left:63.87px;top:494.98px" class="cls_004"><span class="cls_004">perative style with some functional elements.  Keywords in algorithms are in boldface,</span></div>
<div style="position:absolute;left:63.87px;top:506.93px" class="cls_004"><span class="cls_004">variables are in italic, and function names are in</span><span class="cls_007"> sans serif</span><span class="cls_004">. Callouts like this</span><span class="cls_014"> </span><span class="cls_056">1</span><span class="cls_059"> </span><span class="cls_004"> are fre-</span></div>
<div style="position:absolute;left:63.87px;top:518.89px" class="cls_004"><span class="cls_004">quently used to refer to points of interest in algorithms and listings from the text. Variable</span></div>
<div style="position:absolute;left:63.87px;top:530.84px" class="cls_004"><span class="cls_004">assignment is written x ← value.</span></div>
<div style="position:absolute;left:73.84px;top:543.09px" class="cls_004"><span class="cls_004">Sets are written in curly braces, e.g., {1, 2, 3}. Since many algorithms frequently extend</span></div>
<div style="position:absolute;left:341.70px;top:557.25px" class="cls_004"><span class="cls_004">← set which is syn-</span></div>
<div style="position:absolute;left:243.77px;top:571.07px" class="cls_004"><span class="cls_004">← {2, 3} extends the set stored in x with the</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">elements 2 and 3.</span></div>
<div style="position:absolute;left:412.21px;top:624.86px" class="cls_004"><span class="cls_004">17</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:16560px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background026.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">1. Introduction</span></div>
<div style="position:absolute;left:69.68px;top:45.04px" class="cls_004"><span class="cls_004">Set comprehensions are a concise notation for set construction: {expr | conditions} pro-</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">duces a set by applying the expression expr to all values from a (usually implicit) universe</span></div>
<div style="position:absolute;left:59.72px;top:67.92px" class="cls_004"><span class="cls_004">that meet the predicate conditions. For example, {x</span><span class="cls_012"><sup>2</sup></span><span class="cls_004"> | x ∈ {2, 3, 4} ∧ x = 3} produces the</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">set {4, 16}.</span></div>
<div style="position:absolute;left:69.68px;top:92.86px" class="cls_004"><span class="cls_004">Ordered lists are written between square brackets, e.g., [1, 2, 1, 3]. Lists can contain ele-</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">ments multiple times. Lists are sometimes manipulated in a functional (Haskell-like [135])</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">style using the function</span><span class="cls_007"> map</span><span class="cls_004"> and λ -abstraction: x ←</span><span class="cls_007"> map</span><span class="cls_004">(λ v . f (v), y) constructs a list x by</span></div>
<div style="position:absolute;left:59.72px;top:127.70px" class="cls_004"><span class="cls_004">applying a function f (v) to each element in the list x. For instance,</span><span class="cls_007"> map</span><span class="cls_004">(λ x . x</span><span class="cls_012"><sup>2</sup></span><span class="cls_004">, [4, 2, 6])</span></div>
<div style="position:absolute;left:59.72px;top:140.68px" class="cls_004"><span class="cls_004">produces the list [16, 4, 36]. Tuples or pairs are enclosed in parentheses, e.g., (a, b, c).</span></div>
<div style="position:absolute;left:69.68px;top:152.64px" class="cls_004"><span class="cls_004">Throughout this thesis, storage sizes are given in IEC units [33]: 1 KiB = 1024 bytes,</span></div>
<div style="position:absolute;left:59.72px;top:163.57px" class="cls_004"><span class="cls_004">1 MiB = 1024</span><span class="cls_012"><sup>2</sup></span><span class="cls_004"> bytes, and 1 GiB = 1024</span><span class="cls_012"><sup>3</sup></span><span class="cls_004"> bytes.</span></div>
<div style="position:absolute;left:69.68px;top:176.55px" class="cls_004"><span class="cls_004">Data types are defined in a Haskell-like notation. For instance, the definition</span></div>
<div style="position:absolute;left:89.60px;top:197.91px" class="cls_004"><span class="cls_004">data</span><span class="cls_007"> Foo</span><span class="cls_004"> =</span><span class="cls_007"> Foo</span><span class="cls_004"> {</span></div>
<div style="position:absolute;left:104.55px;top:209.87px" class="cls_007"><span class="cls_007">x </span><span class="cls_004">: </span><span class="cls_007">String</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:104.55px;top:221.82px" class="cls_007"><span class="cls_007">ys</span><span class="cls_004"> : [</span><span class="cls_007">String</span><span class="cls_004">],</span></div>
<div style="position:absolute;left:104.55px;top:233.78px" class="cls_007"><span class="cls_007">zs</span><span class="cls_004"> : {</span><span class="cls_007">String</span><span class="cls_004">}</span></div>
<div style="position:absolute;left:89.60px;top:245.73px" class="cls_004"><span class="cls_004">}</span></div>
<div style="position:absolute;left:59.72px;top:267.03px" class="cls_004"><span class="cls_004">defines a data type</span><span class="cls_007"> Foo</span><span class="cls_004"> with three fields: a string</span><span class="cls_007"> x</span><span class="cls_004">, a list of strings</span><span class="cls_007"> ys</span><span class="cls_004">, and a set of strings</span></div>
<div style="position:absolute;left:59.72px;top:278.99px" class="cls_007"><span class="cls_007">zs</span><span class="cls_004">. An example of the construction of a value of this type is as follows:</span></div>
<div style="position:absolute;left:84.62px;top:300.90px" class="cls_007"><span class="cls_007">Foo</span><span class="cls_004"> {x =</span><span class="cls_007"> "test"</span><span class="cls_004">, ys = [</span><span class="cls_007">"hello"</span><span class="cls_004">,</span><span class="cls_007"> "world"</span><span class="cls_004">], zs = 0}</span></div>
<div style="position:absolute;left:59.72px;top:322.82px" class="cls_004"><span class="cls_004">In addition, types can have unnamed fields and multiple constructors. For example, the</span></div>
<div style="position:absolute;left:59.72px;top:334.78px" class="cls_004"><span class="cls_004">definition</span></div>
<div style="position:absolute;left:84.62px;top:356.70px" class="cls_004"><span class="cls_004">data</span><span class="cls_007"> Tree</span><span class="cls_004"> =</span><span class="cls_007"> Leaf String</span><span class="cls_004"> |</span><span class="cls_007"> Branch Tree Tree</span></div>
<div style="position:absolute;left:59.72px;top:378.61px" class="cls_004"><span class="cls_004">defines a binary tree type with strings stored in the leaves. An example value is</span></div>
<div style="position:absolute;left:84.62px;top:400.53px" class="cls_007"><span class="cls_007">Branch</span><span class="cls_004"> (</span><span class="cls_007">Leaf "a"</span><span class="cls_004">) (</span><span class="cls_007">Branch</span><span class="cls_004"> (</span><span class="cls_007">Leaf "b"</span><span class="cls_004">) (</span><span class="cls_007">Leaf "c"</span><span class="cls_004">)).</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">18</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:17250px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background027.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:89.25px" class="cls_006"><span class="cls_006">2. An Overview of Nix</span></div>
<div style="position:absolute;left:63.87px;top:131.52px" class="cls_004"><span class="cls_004">The previous chapter discussed the features that we require from a software deployment</span></div>
<div style="position:absolute;left:63.87px;top:143.48px" class="cls_004"><span class="cls_004">system, as well as the shortcomings of current technology.  The subject of this thesis is</span></div>
<div style="position:absolute;left:63.87px;top:155.43px" class="cls_004"><span class="cls_004">the Nix deployment system, which addresses many of these problems. This chapter gives</span></div>
<div style="position:absolute;left:63.87px;top:167.39px" class="cls_004"><span class="cls_004">a gentle introduction to Nix from a user perspective (where “user” refers to component</span></div>
<div style="position:absolute;left:63.87px;top:179.35px" class="cls_004"><span class="cls_004">deployers as well as end-users). The succeeding parts of this thesis will present a more</span></div>
<div style="position:absolute;left:63.87px;top:191.30px" class="cls_004"><span class="cls_004">formal exposition of Nix’s semantics (Part II) and applications (Part III).</span></div>
<div style="position:absolute;left:63.87px;top:224.42px" class="cls_011"><span class="cls_011">2.1. The Nix store</span></div>
<div style="position:absolute;left:63.87px;top:250.48px" class="cls_004"><span class="cls_004">Nix is a system for software deployment. The term component will be used to denote the</span></div>
<div style="position:absolute;left:63.87px;top:262.44px" class="cls_004"><span class="cls_004">basic units of deployment. These are simply sets of files that implement some arbitrary</span></div>
<div style="position:absolute;left:63.87px;top:274.39px" class="cls_004"><span class="cls_004">functionality through an interface. In fact, Nix does not really care what a component ac-</span></div>
<div style="position:absolute;left:63.87px;top:286.35px" class="cls_004"><span class="cls_004">tually is. As far as Nix is concerned a component is just a set of files in a file system. That</span></div>
<div style="position:absolute;left:63.87px;top:298.30px" class="cls_004"><span class="cls_004">is, we have a very weak notion of component, weaker even than the commonly used defi-</span></div>
<div style="position:absolute;left:63.87px;top:310.26px" class="cls_004"><span class="cls_004">nition in [155]. (What we call a component typically corresponds to the ambiguous notion</span></div>
<div style="position:absolute;left:63.87px;top:322.21px" class="cls_004"><span class="cls_004">of a package in package management systems. Nix’s notion of components is discussed</span></div>
<div style="position:absolute;left:63.87px;top:334.17px" class="cls_004"><span class="cls_004">further in Section 3.1.)</span></div>
<div style="position:absolute;left:73.84px;top:346.57px" class="cls_004"><span class="cls_004">Nix stores components in a component store, also called the Nix store.  The store is</span></div>
<div style="position:absolute;left:63.87px;top:358.52px" class="cls_004"><span class="cls_004">simply a designated directory in the file system, usually</span><span class="cls_007"> /nix/store</span><span class="cls_004">.  The entries in that</span></div>
<div style="position:absolute;left:63.87px;top:370.48px" class="cls_004"><span class="cls_004">directory are components (and some other auxiliary files discussed later). Each component</span></div>
<div style="position:absolute;left:63.87px;top:382.43px" class="cls_004"><span class="cls_004">is stored in isolation; no two components have the same file name in the store.</span></div>
<div style="position:absolute;left:73.84px;top:394.83px" class="cls_004"><span class="cls_004">A subset of a typical Nix store is shown in Figure 2.1. It contains a number of applica-</span></div>
<div style="position:absolute;left:63.87px;top:406.79px" class="cls_004"><span class="cls_004">tions—GNU Hello 2.1.1 (a toy program that prints “Hello World”, Subversion 1.1.4 (a ver-</span></div>
<div style="position:absolute;left:63.87px;top:418.74px" class="cls_004"><span class="cls_004">sion management system), and Subversion 1.2.0—along with some of their dependencies.</span></div>
<div style="position:absolute;left:63.87px;top:430.70px" class="cls_004"><span class="cls_004">These components are not single files, but directory trees. For instance, Subversion con-</span></div>
<div style="position:absolute;left:63.87px;top:442.66px" class="cls_004"><span class="cls_004">sists of a directory called</span><span class="cls_007"> bin</span><span class="cls_004"> containing a program called</span><span class="cls_007"> svn</span><span class="cls_004">, and a directory</span><span class="cls_007"> lib</span><span class="cls_004"> containing</span></div>
<div style="position:absolute;left:63.87px;top:454.61px" class="cls_004"><span class="cls_004">many more files belonging to the component. (For simplicity, many files and dependencies</span></div>
<div style="position:absolute;left:63.87px;top:466.57px" class="cls_004"><span class="cls_004">have been omitted from the example.) The arrows denote runtime dependencies between</span></div>
<div style="position:absolute;left:63.87px;top:478.52px" class="cls_004"><span class="cls_004">components, which will be described shortly.</span></div>
<div style="position:absolute;left:73.84px;top:490.92px" class="cls_004"><span class="cls_004">The notable feature in Figure 2.1 is the names of the components in the Nix store,</span></div>
<div style="position:absolute;left:63.87px;top:502.88px" class="cls_004"><span class="cls_004">such as</span><span class="cls_007"> /nix/store/bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004">.  The initial part of the file names, e.g.,</span></div>
<div style="position:absolute;left:63.87px;top:514.83px" class="cls_007"><span class="cls_007">bwacc7a5c5n3...</span><span class="cls_004">, is what gives Nix the ability to prevent undeclared dependencies and</span></div>
<div style="position:absolute;left:63.87px;top:526.79px" class="cls_004"><span class="cls_004">component interference. It is a representation of the cryptographic hash of all inputs in-</span></div>
<div style="position:absolute;left:63.87px;top:538.74px" class="cls_004"><span class="cls_004">volved in building the component.</span></div>
<div style="position:absolute;left:73.84px;top:550.15px" class="cls_004"><span class="cls_004">Cryptographic hash functions are hash functions that map an arbitrary-length input onto</span></div>
<div style="position:absolute;left:63.87px;top:561.10px" class="cls_004"><span class="cls_004">a fixed-length bit string.  They have the property that they are collision-resistant:  it is</span></div>
<div style="position:absolute;left:63.87px;top:572.06px" class="cls_004"><span class="cls_004">computationally infeasible to find two inputs that hash to the same value. Cryptographic</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">hashes are discussed in more detail in Section 5.1. Nix uses 160-bit hashes represented in</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">19</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:17940px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background028.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2.</span></div>
<div style="position:absolute;left:72.17px;top:17.14px" class="cls_004"><span class="cls_004">An Overview of Nix</span></div>
<div style="position:absolute;left:94.71px;top:44.40px" class="cls_027"><span class="cls_027">/nix/store</span></div>
<div style="position:absolute;left:267.28px;top:44.40px" class="cls_027"><span class="cls_027">/nix/store</span></div>
<div style="position:absolute;left:104.66px;top:54.35px" class="cls_027"><span class="cls_027">bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:277.23px;top:54.35px" class="cls_029"><span class="cls_029">bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:114.60px;top:64.29px" class="cls_027"><span class="cls_027">bin</span></div>
<div style="position:absolute;left:287.17px;top:64.29px" class="cls_029"><span class="cls_029">bin</span></div>
<div style="position:absolute;left:124.54px;top:74.24px" class="cls_027"><span class="cls_027">hello</span></div>
<div style="position:absolute;left:297.11px;top:74.24px" class="cls_029"><span class="cls_029">hello</span></div>
<div style="position:absolute;left:114.60px;top:84.18px" class="cls_027"><span class="cls_027">man</span></div>
<div style="position:absolute;left:287.17px;top:84.18px" class="cls_029"><span class="cls_029">man</span></div>
<div style="position:absolute;left:124.54px;top:94.12px" class="cls_027"><span class="cls_027">man1</span></div>
<div style="position:absolute;left:297.11px;top:94.12px" class="cls_029"><span class="cls_029">man1</span></div>
<div style="position:absolute;left:134.49px;top:104.07px" class="cls_027"><span class="cls_027">hello1</span></div>
<div style="position:absolute;left:307.06px;top:104.07px" class="cls_029"><span class="cls_029">hello1</span></div>
<div style="position:absolute;left:104.66px;top:113.99px" class="cls_027"><span class="cls_027">72by2iw5wd8i...-glibc-2.3.5</span></div>
<div style="position:absolute;left:277.23px;top:113.99px" class="cls_028"><span class="cls_028">72by2iw5wd8i...-glibc-2.3.5</span></div>
<div style="position:absolute;left:114.60px;top:123.96px" class="cls_027"><span class="cls_027">lib</span></div>
<div style="position:absolute;left:287.17px;top:123.96px" class="cls_028"><span class="cls_028">lib</span></div>
<div style="position:absolute;left:124.54px;top:133.90px" class="cls_027"><span class="cls_027">libc.so.6</span></div>
<div style="position:absolute;left:297.11px;top:133.90px" class="cls_028"><span class="cls_028">libc.so.6</span></div>
<div style="position:absolute;left:104.66px;top:143.85px" class="cls_027"><span class="cls_027">v2cc475f6nv1...-subversion-1.1.4</span></div>
<div style="position:absolute;left:277.23px;top:143.85px" class="cls_028"><span class="cls_028">v2cc475f6nv1...-subversion-1.1.4</span></div>
<div style="position:absolute;left:114.60px;top:153.79px" class="cls_027"><span class="cls_027">bin</span></div>
<div style="position:absolute;left:287.17px;top:153.79px" class="cls_028"><span class="cls_028">bin</span></div>
<div style="position:absolute;left:124.54px;top:163.73px" class="cls_027"><span class="cls_027">svn</span></div>
<div style="position:absolute;left:297.11px;top:163.73px" class="cls_028"><span class="cls_028">svn</span></div>
<div style="position:absolute;left:114.60px;top:173.68px" class="cls_027"><span class="cls_027">lib</span></div>
<div style="position:absolute;left:287.17px;top:173.68px" class="cls_028"><span class="cls_028">lib</span></div>
<div style="position:absolute;left:124.54px;top:183.62px" class="cls_027"><span class="cls_027">libsvn...so</span></div>
<div style="position:absolute;left:297.11px;top:183.62px" class="cls_028"><span class="cls_028">libsvn...so</span></div>
<div style="position:absolute;left:104.66px;top:193.57px" class="cls_027"><span class="cls_027">5jq6jgkamxjj...-openssl-0.9.7d</span></div>
<div style="position:absolute;left:277.23px;top:193.57px" class="cls_028"><span class="cls_028">5jq6jgkamxjj...-openssl-0.9.7d</span></div>
<div style="position:absolute;left:114.52px;top:203.51px" class="cls_027"><span class="cls_027">lib</span></div>
<div style="position:absolute;left:287.09px;top:203.51px" class="cls_028"><span class="cls_028">lib</span></div>
<div style="position:absolute;left:124.54px;top:213.46px" class="cls_027"><span class="cls_027">libssl.so.0.9.7</span></div>
<div style="position:absolute;left:297.11px;top:213.46px" class="cls_028"><span class="cls_028">libssl.so.0.9.7</span></div>
<div style="position:absolute;left:104.66px;top:223.40px" class="cls_027"><span class="cls_027">h7yw7a257m1i...-db4-4.3.28</span></div>
<div style="position:absolute;left:277.23px;top:223.40px" class="cls_028"><span class="cls_028">h7yw7a257m1i...-db4-4.3.28</span></div>
<div style="position:absolute;left:114.52px;top:233.34px" class="cls_027"><span class="cls_027">lib</span></div>
<div style="position:absolute;left:287.09px;top:233.34px" class="cls_028"><span class="cls_028">lib</span></div>
<div style="position:absolute;left:124.54px;top:243.29px" class="cls_027"><span class="cls_027">libdb-4.so</span></div>
<div style="position:absolute;left:297.11px;top:243.29px" class="cls_028"><span class="cls_028">libdb-4.so</span></div>
<div style="position:absolute;left:104.66px;top:253.23px" class="cls_027"><span class="cls_027">dg7c6zr5vqrj...-subversion-1.2.0</span></div>
<div style="position:absolute;left:277.23px;top:253.23px" class="cls_029"><span class="cls_029">dg7c6zr5vqrj...-subversion-1.2.0</span></div>
<div style="position:absolute;left:114.60px;top:263.18px" class="cls_027"><span class="cls_027">bin</span></div>
<div style="position:absolute;left:287.17px;top:263.18px" class="cls_029"><span class="cls_029">bin</span></div>
<div style="position:absolute;left:124.54px;top:273.12px" class="cls_027"><span class="cls_027">svn</span></div>
<div style="position:absolute;left:297.11px;top:273.12px" class="cls_029"><span class="cls_029">svn</span></div>
<div style="position:absolute;left:114.60px;top:283.07px" class="cls_027"><span class="cls_027">lib</span></div>
<div style="position:absolute;left:287.17px;top:283.07px" class="cls_029"><span class="cls_029">lib</span></div>
<div style="position:absolute;left:124.54px;top:293.01px" class="cls_027"><span class="cls_027">libsvn...so</span></div>
<div style="position:absolute;left:297.11px;top:293.01px" class="cls_029"><span class="cls_029">libsvn...so</span></div>
<div style="position:absolute;left:104.66px;top:302.95px" class="cls_027"><span class="cls_027">8ggmblhvzciv...-openssl-0.9.7f</span></div>
<div style="position:absolute;left:277.23px;top:302.95px" class="cls_029"><span class="cls_029">8ggmblhvzciv...-openssl-0.9.7f</span></div>
<div style="position:absolute;left:114.52px;top:312.90px" class="cls_027"><span class="cls_027">lib</span></div>
<div style="position:absolute;left:287.09px;top:312.90px" class="cls_029"><span class="cls_029">lib</span></div>
<div style="position:absolute;left:124.82px;top:322.84px" class="cls_027"><span class="cls_027">libssl.so.0.9.7</span></div>
<div style="position:absolute;left:297.39px;top:322.84px" class="cls_029"><span class="cls_029">libssl.so.0.9.7</span></div>
<div style="position:absolute;left:100.84px;top:345.38px" class="cls_004"><span class="cls_004">Figure 2.1.: The Nix store</span></div>
<div style="position:absolute;left:261.92px;top:345.38px" class="cls_004"><span class="cls_004">Figure 2.2.: Closure in the store</span></div>
<div style="position:absolute;left:59.72px;top:377.33px" class="cls_004"><span class="cls_004">a base-32</span></div>
<div style="position:absolute;left:100.76px;top:377.33px" class="cls_004"><span class="cls_004">notation, so each hash is 32 characters long. In this thesis, hashes are abridged</span></div>
<div style="position:absolute;left:59.72px;top:388.28px" class="cls_004"><span class="cls_004">to ellipses (</span><span class="cls_007">...</span><span class="cls_004">) most of the time for reasons of legibility. The full path of a directory entry</span></div>
<div style="position:absolute;left:59.72px;top:399.24px" class="cls_004"><span class="cls_004">in the Nix store is referred to as its store path. An example of a full store path is:</span></div>
<div style="position:absolute;left:84.62px;top:419.40px" class="cls_015"><span class="cls_015">/nix/store/bwacc7a5c5n3qx37nz5drwcgd2lv89w6-hello-2.1.1</span></div>
<div style="position:absolute;left:69.68px;top:429.04px" class="cls_004"><span class="cls_004">So the file</span><span class="cls_007"> bin/hello</span><span class="cls_004"> in that component has the full path</span></div>
<div style="position:absolute;left:84.62px;top:449.19px" class="cls_015"><span class="cls_015">/nix/store/bwacc7a5c5n3qx37nz5drwcgd2lv89w6-hello-2.1.1/bin/hello</span></div>
<div style="position:absolute;left:69.68px;top:459.82px" class="cls_004"><span class="cls_004">The hash is computed over all inputs, including the following:</span></div>
<div style="position:absolute;left:74.66px;top:479.65px" class="cls_004"><span class="cls_004">• The sources of the components.</span></div>
<div style="position:absolute;left:74.66px;top:499.53px" class="cls_004"><span class="cls_004">• The script that performed the build.</span></div>
<div style="position:absolute;left:74.66px;top:519.41px" class="cls_004"><span class="cls_004">• Any arguments or environment variables [152] passed to the build script.</span></div>
<div style="position:absolute;left:74.66px;top:539.28px" class="cls_004"><span class="cls_004">• All build time dependencies, typically including the compiler, linker, any libraries</span></div>
<div style="position:absolute;left:84.62px;top:551.24px" class="cls_004"><span class="cls_004">used at build time, standard Unix tools such as</span><span class="cls_007"> cp</span><span class="cls_004"> and</span><span class="cls_007"> tar</span><span class="cls_004">, the shell, and so on.</span></div>
<div style="position:absolute;left:69.68px;top:571.07px" class="cls_004"><span class="cls_004">Cryptographic hashes in store paths serve two main goals.  They prevent interference</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">between components, and they allow complete identification of dependencies. The lack</span></div>
<div style="position:absolute;left:59.72px;top:624.86px" class="cls_004"><span class="cls_004">20</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:18630px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background029.jpg" width=481 height=680></div>
<div style="position:absolute;left:347.46px;top:17.14px" class="cls_004"><span class="cls_004">2.1. The Nix store</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">of these two properties is the cause for the vast majority of correctness and flexibility</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">problems faced by conventional deployment systems, as we saw in Section 1.2.</span></div>
<div style="position:absolute;left:63.87px;top:85.99px" class="cls_009"><span class="cls_009">Preventing interference</span><span class="cls_004">   Since the hash is computed over all inputs to the build process</span></div>
<div style="position:absolute;left:63.87px;top:97.94px" class="cls_004"><span class="cls_004">of the component, any change, no matter how slight, will be reflected in the hash. This</span></div>
<div style="position:absolute;left:63.87px;top:109.90px" class="cls_004"><span class="cls_004">includes changes to the dependencies; the hash is computed recursively. Thus, the hash</span></div>
<div style="position:absolute;left:63.87px;top:121.85px" class="cls_004"><span class="cls_004">essentially provides a unique identifier for a configuration. If two component compositions</span></div>
<div style="position:absolute;left:63.87px;top:133.81px" class="cls_004"><span class="cls_004">differ in any way, they will occupy different paths in the store (except for dependencies that</span></div>
<div style="position:absolute;left:63.87px;top:145.76px" class="cls_004"><span class="cls_004">they have in common). Installation or uninstallation of a configuration therefore will not</span></div>
<div style="position:absolute;left:63.87px;top:157.72px" class="cls_004"><span class="cls_004">interfere with any other configuration.</span></div>
<div style="position:absolute;left:73.84px;top:170.12px" class="cls_004"><span class="cls_004">For instance, in the Nix store in Figure 2.1 there are two versions of Subversion. They</span></div>
<div style="position:absolute;left:63.87px;top:182.08px" class="cls_004"><span class="cls_004">were built from different sources, and so their hashes differ.  Additionally, Subversion</span></div>
<div style="position:absolute;left:63.87px;top:194.03px" class="cls_004"><span class="cls_004">1.2.0 uses a newer version of the OpenSSL cryptographic library. This newer version of</span></div>
<div style="position:absolute;left:63.87px;top:205.99px" class="cls_004"><span class="cls_004">OpenSSL likewise exists in a path different from the old OpenSSL. Thus, even though</span></div>
<div style="position:absolute;left:63.87px;top:217.94px" class="cls_004"><span class="cls_004">installing a new Subversion entails installing a new OpenSSL, the old Subversion instance</span></div>
<div style="position:absolute;left:63.87px;top:229.90px" class="cls_004"><span class="cls_004">is not affected, since it continues to use the old OpenSSL.</span></div>
<div style="position:absolute;left:73.84px;top:242.30px" class="cls_004"><span class="cls_004">Recursive hash computation causes changes to a component to “propagate” through the</span></div>
<div style="position:absolute;left:63.87px;top:254.25px" class="cls_004"><span class="cls_004">dependency graph. This is illustrated in Figure 2.3, which shows the hash components of</span></div>
<div style="position:absolute;left:63.87px;top:266.21px" class="cls_004"><span class="cls_004">the store paths computed for the Mozilla Firefox component (a web browser) and some of</span></div>
<div style="position:absolute;left:63.87px;top:278.17px" class="cls_004"><span class="cls_004">its build time dependencies, both before and after a change is made to one of those depen-</span></div>
<div style="position:absolute;left:63.87px;top:290.12px" class="cls_004"><span class="cls_004">dencies. (An edge from a node A to a node B denotes that the build result of A is an input to</span></div>
<div style="position:absolute;left:63.87px;top:302.08px" class="cls_004"><span class="cls_004">the build process of B.) Specifically, the GTK GUI library dependency is updated from ver-</span></div>
<div style="position:absolute;left:63.87px;top:314.03px" class="cls_004"><span class="cls_004">sion 2.2.4 to 2.4.13. That is, its source bundle (</span><span class="cls_007">gtk+-2.2.4.tar.bz2</span><span class="cls_004"> and</span><span class="cls_007"> gtk+-2.4.13.tar.bz2</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:63.87px;top:325.99px" class="cls_004"><span class="cls_004">respectively) changes. This change propagates through the dependency graph, causing dif-</span></div>
<div style="position:absolute;left:63.87px;top:337.94px" class="cls_004"><span class="cls_004">ferent store paths to be computed for the GTK component and the Firefox component.</span></div>
<div style="position:absolute;left:63.87px;top:349.90px" class="cls_004"><span class="cls_004">However, components that do not depend on GTK, such as Glibc (the GNU C Library),</span></div>
<div style="position:absolute;left:63.87px;top:361.85px" class="cls_004"><span class="cls_004">are unaffected.</span></div>
<div style="position:absolute;left:73.84px;top:374.25px" class="cls_004"><span class="cls_004">An important point here is that upgrading only happens by rebuilding the component in</span></div>
<div style="position:absolute;left:63.87px;top:386.21px" class="cls_004"><span class="cls_004">question and all components that depend on it. We never perform a destructive upgrade.</span></div>
<div style="position:absolute;left:63.87px;top:398.17px" class="cls_004"><span class="cls_004">Components never change after they have been built—they are marked as read-only in the</span></div>
<div style="position:absolute;left:63.87px;top:410.12px" class="cls_004"><span class="cls_004">file system. Assuming that the build process for a component is deterministic, this means</span></div>
<div style="position:absolute;left:63.87px;top:422.08px" class="cls_004"><span class="cls_004">that the hash identifies the contents of the components at all times, not only just after it has</span></div>
<div style="position:absolute;left:63.87px;top:434.03px" class="cls_004"><span class="cls_004">been built. Conversely, the build-time inputs determine the contents of the component.</span></div>
<div style="position:absolute;left:73.84px;top:446.43px" class="cls_004"><span class="cls_004">Therefore we call this a purely functional model.  In purely functional programming</span></div>
<div style="position:absolute;left:63.87px;top:458.39px" class="cls_004"><span class="cls_004">languages such as Haskell [135], as in mathematics, the result of a function call depends</span></div>
<div style="position:absolute;left:63.87px;top:470.34px" class="cls_004"><span class="cls_004">exclusively on the definition of the function and on the arguments. In Nix, the contents of</span></div>
<div style="position:absolute;left:63.87px;top:482.30px" class="cls_004"><span class="cls_004">a component depend exclusively on the build inputs. The advantage of a purely functional</span></div>
<div style="position:absolute;left:63.87px;top:494.25px" class="cls_004"><span class="cls_004">model is that we obtain strong guarantees about components, such as non-interference.</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_009"><span class="cls_009">Identifying dependencies</span><span class="cls_004">   The use of cryptographic hashes in component file names</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">also prevents the use of undeclared dependencies, which (as we saw in Section 1.2) is the</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">major cause of incomplete deployment. The reason that incomplete dependency informa-</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">tion occurs is that there is generally nothing that prevents a component from accessing</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">another component, either at build time or at runtime. For instance, a line in a build script</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">or Makefile such as</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">21</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:19320px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background030.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2. An Overview of Nix</span></div>
<div style="position:absolute;left:146.74px;top:46.48px" class="cls_030"><span class="cls_030">ja7kjr1njh6b...-</span></div>
<div style="position:absolute;left:320.70px;top:48.97px" class="cls_031"><span class="cls_031">ja7kjr1njh6b...-</span></div>
<div style="position:absolute;left:144.21px;top:52.26px" class="cls_030"><span class="cls_030">glibc-2.3.5.tar.bz2</span></div>
<div style="position:absolute;left:318.21px;top:54.65px" class="cls_031"><span class="cls_031">glibc-2.3.5.tar.bz2</span></div>
<div style="position:absolute;left:62.61px;top:77.18px" class="cls_030"><span class="cls_030">pmdmxsff5kpm...-</span></div>
<div style="position:absolute;left:144.94px;top:77.18px" class="cls_030"><span class="cls_030">72by2iw5wd8i...-</span></div>
<div style="position:absolute;left:235.13px;top:79.15px" class="cls_031"><span class="cls_031">pmdmxsff5kpm...-</span></div>
<div style="position:absolute;left:318.92px;top:79.15px" class="cls_031"><span class="cls_031">72by2iw5wd8i...-</span></div>
<div style="position:absolute;left:65.13px;top:82.95px" class="cls_030"><span class="cls_030">gcc-3.4.3.tar.bz2</span></div>
<div style="position:absolute;left:151.80px;top:82.95px" class="cls_030"><span class="cls_030">glibc-2.3.5</span></div>
<div style="position:absolute;left:237.61px;top:84.84px" class="cls_031"><span class="cls_031">gcc-3.4.3.tar.bz2</span></div>
<div style="position:absolute;left:325.67px;top:84.84px" class="cls_031"><span class="cls_031">glibc-2.3.5</span></div>
<div style="position:absolute;left:65.49px;top:111.12px" class="cls_030"><span class="cls_030">x3cgx0xj1p4i...-</span></div>
<div style="position:absolute;left:114.24px;top:111.12px" class="cls_030"><span class="cls_030">acyn3qg8z5y4...-</span></div>
<div style="position:absolute;left:237.97px;top:112.53px" class="cls_031"><span class="cls_031">x3cgx0xj1p4i...-</span></div>
<div style="position:absolute;left:287.68px;top:112.53px" class="cls_031"><span class="cls_031">cak0k28vxcsh...-</span></div>
<div style="position:absolute;left:72.72px;top:116.90px" class="cls_030"><span class="cls_030">gcc-3.4.3</span></div>
<div style="position:absolute;left:113.52px;top:116.90px" class="cls_030"><span class="cls_030">gtk+-2.2.4.tar.bz2</span></div>
<div style="position:absolute;left:245.07px;top:118.21px" class="cls_031"><span class="cls_031">gcc-3.4.3</span></div>
<div style="position:absolute;left:285.55px;top:118.21px" class="cls_031"><span class="cls_031">gtk+-2.4.13.tar.bz2</span></div>
<div style="position:absolute;left:119.66px;top:145.06px" class="cls_030"><span class="cls_030">zmhd227j57rx...-</span></div>
<div style="position:absolute;left:191.52px;top:145.06px" class="cls_030"><span class="cls_030">lrclv7w3fb13...-</span></div>
<div style="position:absolute;left:293.36px;top:145.91px" class="cls_031"><span class="cls_031">j4v4n2an42jw...-</span></div>
<div style="position:absolute;left:364.73px;top:145.91px" class="cls_031"><span class="cls_031">lrclv7w3fb13...-</span></div>
<div style="position:absolute;left:126.52px;top:150.84px" class="cls_030"><span class="cls_030">gtk+-2.2.4</span></div>
<div style="position:absolute;left:189.35px;top:150.84px" class="cls_030"><span class="cls_030">firefox-1.0.tar.bz2</span></div>
<div style="position:absolute;left:299.04px;top:151.59px" class="cls_031"><span class="cls_031">gtk+-2.4.13</span></div>
<div style="position:absolute;left:362.60px;top:151.59px" class="cls_031"><span class="cls_031">firefox-1.0.tar.bz2</span></div>
<div style="position:absolute;left:140.96px;top:179.01px" class="cls_030"><span class="cls_030">mkmpxqr8d7f7...-</span></div>
<div style="position:absolute;left:315.73px;top:179.28px" class="cls_031"><span class="cls_031">r0ndfgl4w95m...-</span></div>
<div style="position:absolute;left:148.55px;top:184.78px" class="cls_030"><span class="cls_030">firefox-1.0</span></div>
<div style="position:absolute;left:322.47px;top:184.97px" class="cls_031"><span class="cls_031">firefox-1.0</span></div>
<div style="position:absolute;left:131.20px;top:197.61px" class="cls_004"><span class="cls_004">Before</span></div>
<div style="position:absolute;left:306.81px;top:197.61px" class="cls_004"><span class="cls_004">After</span></div>
<div style="position:absolute;left:59.72px;top:223.79px" class="cls_004"><span class="cls_004">Figure 2.3.: Propagation of dependency changes through the store paths of the build-time</span></div>
<div style="position:absolute;left:108.42px;top:235.75px" class="cls_004"><span class="cls_004">component dependency graph</span></div>
<div style="position:absolute;left:84.62px;top:274.30px" class="cls_015"><span class="cls_015">gcc  -o  program  main.c  ui.c  -lssl</span></div>
<div style="position:absolute;left:59.72px;top:290.84px" class="cls_004"><span class="cls_004">which links a program consisting of two C modules against a library named</span><span class="cls_007"> ssl</span><span class="cls_004">, causes</span></div>
<div style="position:absolute;left:59.72px;top:301.77px" class="cls_004"><span class="cls_004">the linker to search in a set of standard locations for a library called</span><span class="cls_007"> ssl</span><span class="cls_012"><sup>1</sup></span><span class="cls_004">. These standard</span></div>
<div style="position:absolute;left:59.72px;top:314.75px" class="cls_004"><span class="cls_004">locations typically include “global” system directories such as</span><span class="cls_007"> /usr/lib</span><span class="cls_004"> on Unix systems. If</span></div>
<div style="position:absolute;left:59.72px;top:326.70px" class="cls_004"><span class="cls_004">the library happens to exist in one of those directories, we have incurred a dependency.</span></div>
<div style="position:absolute;left:59.72px;top:338.66px" class="cls_004"><span class="cls_004">However, there is nothing that forces us to include this dependency in the dependency</span></div>
<div style="position:absolute;left:59.72px;top:350.61px" class="cls_004"><span class="cls_004">specifications of the deployment system (e.g., in the RPM spec file of Figure 1.2).</span></div>
<div style="position:absolute;left:69.68px;top:363.19px" class="cls_004"><span class="cls_004">At runtime we have the same problem.  Since components can perform arbitrary I/O</span></div>
<div style="position:absolute;left:59.72px;top:375.15px" class="cls_004"><span class="cls_004">actions, they can load and use other components.  For instance, if the library</span><span class="cls_007"> ssl</span><span class="cls_004"> used</span></div>
<div style="position:absolute;left:59.72px;top:387.10px" class="cls_004"><span class="cls_004">above is a dynamic library, then</span><span class="cls_007"> program</span><span class="cls_004"> will contain an entry in its dynamic linkage</span></div>
<div style="position:absolute;left:59.72px;top:399.06px" class="cls_004"><span class="cls_004">meta-information that causes the dynamic linker to search for the library when</span><span class="cls_007"> program</span><span class="cls_004"> is</span></div>
<div style="position:absolute;left:59.72px;top:411.01px" class="cls_004"><span class="cls_004">started. The dynamic linker similarly searches in global locations such as</span><span class="cls_007"> /lib</span><span class="cls_004"> and</span><span class="cls_007"> /usr/lib</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:423.59px" class="cls_004"><span class="cls_004">Of course, there are countless mechanisms other than static or dynamic linking that es-</span></div>
<div style="position:absolute;left:59.72px;top:435.55px" class="cls_004"><span class="cls_004">tablish a component composition. Some examples are including C header files, importing</span></div>
<div style="position:absolute;left:59.72px;top:447.50px" class="cls_004"><span class="cls_004">Java classes at compile time, calling external programs found through the</span><span class="cls_007"> PATH</span><span class="cls_004"> environ-</span></div>
<div style="position:absolute;left:59.72px;top:459.46px" class="cls_004"><span class="cls_004">ment variable, and loading help files at runtime.</span></div>
<div style="position:absolute;left:69.68px;top:472.04px" class="cls_004"><span class="cls_004">The hashing scheme neatly prevents these problems by not storing components in global</span></div>
<div style="position:absolute;left:59.72px;top:483.99px" class="cls_004"><span class="cls_004">locations, but in isolation from each other. For instance, assuming that all components in</span></div>
<div style="position:absolute;left:59.72px;top:495.95px" class="cls_004"><span class="cls_004">the system are stored in the Nix store, the linker line</span></div>
<div style="position:absolute;left:84.62px;top:522.00px" class="cls_015"><span class="cls_015">gcc  -o  program  main.c  ui.c  -lssl</span></div>
<div style="position:absolute;left:59.72px;top:538.55px" class="cls_004"><span class="cls_004">will simply fail to find</span><span class="cls_007"> libssl</span><span class="cls_004">.  Unless the path to an OpenSSL instance (e.g.,</span><span class="cls_007"> /nix/store/-</span></div>
<div style="position:absolute;left:59.72px;top:550.50px" class="cls_007"><span class="cls_007">5jq6jgkamxjj...-openssl-0.9.7d</span><span class="cls_004">) was explicitly fed into the build process and added to the</span></div>
<div style="position:absolute;left:59.72px;top:562.46px" class="cls_004"><span class="cls_004">linker’s search path, no such instance will be found by the linker.</span></div>
<div style="position:absolute;left:64.20px;top:584.11px" class="cls_013"><span class="cls_013"><sup>1</sup></span><span class="cls_014">To be precise,</span><span class="cls_016"> libssl.a</span><span class="cls_014"> or</span><span class="cls_016"> libssl.so</span><span class="cls_014"> on Unix.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">22</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:20010px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background031.jpg" width=481 height=680></div>
<div style="position:absolute;left:347.46px;top:17.14px" class="cls_004"><span class="cls_004">2.1. The Nix store</span></div>
<div style="position:absolute;left:67.26px;top:49.73px" class="cls_015"><span class="cls_015">00000000</span></div>
<div style="position:absolute;left:109.59px;top:49.73px" class="cls_015"><span class="cls_015">7f 45 4c 46 01 01 01 00</span></div>
<div style="position:absolute;left:215.42px;top:49.73px" class="cls_015"><span class="cls_015">00 00 00 00 00 00 00 00</span></div>
<div style="position:absolute;left:321.25px;top:49.73px" class="cls_015"><span class="cls_015">|.ELF</span></div>
<div style="position:absolute;left:393.21px;top:49.73px" class="cls_015"><span class="cls_015">|</span></div>
<div style="position:absolute;left:67.26px;top:59.19px" class="cls_015"><span class="cls_015">00000010</span></div>
<div style="position:absolute;left:109.59px;top:59.19px" class="cls_015"><span class="cls_015">02 00 03 00 01 00 00 00</span></div>
<div style="position:absolute;left:215.42px;top:59.19px" class="cls_015"><span class="cls_015">40 bb 04 08 34 00 00 00</span></div>
<div style="position:absolute;left:321.25px;top:59.19px" class="cls_015"><span class="cls_015">|</span></div>
<div style="position:absolute;left:359.34px;top:59.19px" class="cls_015"><span class="cls_015">@...4...|</span></div>
<div style="position:absolute;left:67.26px;top:78.12px" class="cls_015"><span class="cls_015">00000130</span></div>
<div style="position:absolute;left:109.59px;top:78.12px" class="cls_015"><span class="cls_015">04 00 00 00 2f 6e 69 78</span></div>
<div style="position:absolute;left:215.42px;top:78.12px" class="cls_015"><span class="cls_015">2f 73 74 6f 72 65 2f 37</span></div>
<div style="position:absolute;left:321.25px;top:78.12px" class="cls_015"><span class="cls_015">|</span></div>
<div style="position:absolute;left:342.41px;top:78.12px" class="cls_015"><span class="cls_015">/nix/store/7|</span></div>
<div style="position:absolute;left:67.26px;top:87.58px" class="cls_015"><span class="cls_015">00000140</span></div>
<div style="position:absolute;left:109.59px;top:87.58px" class="cls_015"><span class="cls_015">32 62 79 32 69 77 35 77</span></div>
<div style="position:absolute;left:215.42px;top:87.58px" class="cls_015"><span class="cls_015">64 38 69 68 72 35 79 37</span></div>
<div style="position:absolute;left:321.25px;top:87.58px" class="cls_015"><span class="cls_015">|2by2iw5wd8ihr5y7|</span></div>
<div style="position:absolute;left:67.26px;top:97.05px" class="cls_015"><span class="cls_015">00000150</span></div>
<div style="position:absolute;left:109.59px;top:97.05px" class="cls_015"><span class="cls_015">6e 31 31 31 6a 66 77 6c</span></div>
<div style="position:absolute;left:215.42px;top:97.05px" class="cls_015"><span class="cls_015">37 33 71 32 68 36 37</span></div>
<div style="position:absolute;left:304.32px;top:97.05px" class="cls_015"><span class="cls_015">2d</span></div>
<div style="position:absolute;left:321.25px;top:97.05px" class="cls_015"><span class="cls_015">|n111jfwl73q2h67-|</span></div>
<div style="position:absolute;left:67.26px;top:106.51px" class="cls_015"><span class="cls_015">00000160</span></div>
<div style="position:absolute;left:109.59px;top:106.51px" class="cls_015"><span class="cls_015">67 6c 69 62 63 2d 32 2e</span></div>
<div style="position:absolute;left:215.42px;top:106.51px" class="cls_015"><span class="cls_015">33 2e 35 2f 6c 69 62 2f</span></div>
<div style="position:absolute;left:321.25px;top:106.51px" class="cls_015"><span class="cls_015">|glibc-2.3.5/lib/|</span></div>
<div style="position:absolute;left:67.26px;top:115.98px" class="cls_015"><span class="cls_015">00000170</span></div>
<div style="position:absolute;left:109.59px;top:115.98px" class="cls_015"><span class="cls_015">6c 64 2d 6c 69 6e 75 78</span></div>
<div style="position:absolute;left:215.42px;top:115.98px" class="cls_015"><span class="cls_015">2e 73 6f 2e 32 00 00 00</span></div>
<div style="position:absolute;left:321.25px;top:115.98px" class="cls_015"><span class="cls_015">|ld-linux.so.2...|</span></div>
<div style="position:absolute;left:67.26px;top:134.91px" class="cls_015"><span class="cls_015">00002670</span></div>
<div style="position:absolute;left:109.59px;top:134.91px" class="cls_015"><span class="cls_015">73 74 6f 72 65 2f 35 6a</span></div>
<div style="position:absolute;left:215.42px;top:134.91px" class="cls_015"><span class="cls_015">71 36 6a 67 6b 61 6d 78</span></div>
<div style="position:absolute;left:321.25px;top:134.91px" class="cls_015"><span class="cls_015">|store/5jq6jgkamx|</span></div>
<div style="position:absolute;left:67.26px;top:144.37px" class="cls_015"><span class="cls_015">00002680</span></div>
<div style="position:absolute;left:109.59px;top:144.37px" class="cls_015"><span class="cls_015">6a 6a 64 64 6c 61 76 67</span></div>
<div style="position:absolute;left:215.42px;top:144.37px" class="cls_015"><span class="cls_015">76 63 39 6e 76 30 6c 72</span></div>
<div style="position:absolute;left:321.25px;top:144.37px" class="cls_015"><span class="cls_015">|jjddlavgvc9nv0lr|</span></div>
<div style="position:absolute;left:67.26px;top:153.84px" class="cls_015"><span class="cls_015">00002690</span></div>
<div style="position:absolute;left:109.09px;top:153.84px" class="cls_015"><span class="cls_015">6d 38 66 79 73 37  2d 6f</span></div>
<div style="position:absolute;left:215.42px;top:153.84px" class="cls_015"><span class="cls_015">70 65 6e 73 73 6c 2d 30</span></div>
<div style="position:absolute;left:321.25px;top:153.84px" class="cls_015"><span class="cls_015">|m8fys7-openssl-0|</span></div>
<div style="position:absolute;left:67.26px;top:163.30px" class="cls_015"><span class="cls_015">000026a0</span></div>
<div style="position:absolute;left:109.59px;top:163.30px" class="cls_015"><span class="cls_015">2e 39 2e 37 64 2f 6c 69</span></div>
<div style="position:absolute;left:215.42px;top:163.30px" class="cls_015"><span class="cls_015">62 3a 2f 6e 69 78 2f 73</span></div>
<div style="position:absolute;left:321.25px;top:163.30px" class="cls_015"><span class="cls_015">|.9.7d/lib:/nix/s|</span></div>
<div style="position:absolute;left:129.81px;top:188.14px" class="cls_004"><span class="cls_004">Figure 2.4.: Retained dependencies in the</span><span class="cls_007"> svn</span><span class="cls_004"> executable</span></div>
<div style="position:absolute;left:73.84px;top:220.48px" class="cls_004"><span class="cls_004">Also, we go to some lengths to ensure that component builders are pure, that is, not</span></div>
<div style="position:absolute;left:63.87px;top:232.44px" class="cls_004"><span class="cls_004">influenced by outside factors.  For example, the builder is called with an empty set of</span></div>
<div style="position:absolute;left:63.87px;top:244.39px" class="cls_004"><span class="cls_004">environment variables (such as the</span><span class="cls_007"> PATH</span><span class="cls_004"> environment variable, which is used by Unix</span></div>
<div style="position:absolute;left:63.87px;top:256.35px" class="cls_004"><span class="cls_004">shells to locate programs) to prevent user settings such as search paths from reaching tools</span></div>
<div style="position:absolute;left:63.87px;top:268.30px" class="cls_004"><span class="cls_004">invoked by the builder. Similarly, at runtime on Linux systems, we use a patched dynamic</span></div>
<div style="position:absolute;left:63.87px;top:280.26px" class="cls_004"><span class="cls_004">linker that does not search in any default locations—so if a dynamic library is not explicitly</span></div>
<div style="position:absolute;left:63.87px;top:292.21px" class="cls_004"><span class="cls_004">declared with its full path in an executable, the dynamic linker will not find it.</span></div>
<div style="position:absolute;left:73.84px;top:304.32px" class="cls_004"><span class="cls_004">Thus, when the developer or deployer fails to specify a dependency explicitly (in the Nix</span></div>
<div style="position:absolute;left:63.87px;top:316.27px" class="cls_004"><span class="cls_004">expression formalism, discussed below), the component will fail deterministically. That</span></div>
<div style="position:absolute;left:63.87px;top:328.23px" class="cls_004"><span class="cls_004">is, it will not succeed if the dependency already happens to be available in the Nix store,</span></div>
<div style="position:absolute;left:63.87px;top:340.18px" class="cls_004"><span class="cls_004">without having been specified as an input. By contrast, the deployment systems discussed</span></div>
<div style="position:absolute;left:63.87px;top:352.14px" class="cls_004"><span class="cls_004">in Section 1.2 allow components to build or run successfully even if some dependencies</span></div>
<div style="position:absolute;left:63.87px;top:364.09px" class="cls_004"><span class="cls_004">are not declared.</span></div>
<div style="position:absolute;left:63.87px;top:391.44px" class="cls_009"><span class="cls_009">Retained dependencies</span><span class="cls_004">   A rather tricky aspect to dependency identification is the oc-</span></div>
<div style="position:absolute;left:63.87px;top:403.40px" class="cls_004"><span class="cls_004">currence of retained dependencies.  This is what happens when the build process of a</span></div>
<div style="position:absolute;left:63.87px;top:415.35px" class="cls_004"><span class="cls_004">component stores a path to a dependency in the component. For instance, the linker invo-</span></div>
<div style="position:absolute;left:63.87px;top:427.31px" class="cls_004"><span class="cls_004">cation above will store the path of the OpenSSL library in</span><span class="cls_007"> program</span><span class="cls_004">, i.e.,</span><span class="cls_007"> program</span><span class="cls_004"> will have</span></div>
<div style="position:absolute;left:63.87px;top:439.26px" class="cls_004"><span class="cls_004">a “hard-coded” reference to</span><span class="cls_007"> /nix/store/5jq6jgkamxjj...-openssl-0.9.7d/lib/libssl.so</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:451.37px" class="cls_004"><span class="cls_004">Figure 2.4 shows a dump of parts of the Subversion executable stored in the file</span><span class="cls_007"> /nix/-</span></div>
<div style="position:absolute;left:63.87px;top:463.32px" class="cls_007"><span class="cls_007">store/v2cc475f6nv1...-subversion-1.1.4/bin/svn</span><span class="cls_004">. Offsets are on the left, a hexadecimal rep-</span></div>
<div style="position:absolute;left:63.87px;top:475.28px" class="cls_004"><span class="cls_004">resentation in the middle, and an ASCII representation on the right. The build process for</span></div>
<div style="position:absolute;left:63.87px;top:487.23px" class="cls_004"><span class="cls_004">Subversion has caused a reference to the aforementioned OpenSSL instance to be stored in</span></div>
<div style="position:absolute;left:63.87px;top:499.19px" class="cls_004"><span class="cls_004">the program’s executable image. The path of OpenSSL has been stored in the</span><span class="cls_007"> RPATH</span><span class="cls_004"> field</span></div>
<div style="position:absolute;left:63.87px;top:511.14px" class="cls_004"><span class="cls_004">of the header of the ELF executable, which specifies a list of directories to be searched</span></div>
<div style="position:absolute;left:63.87px;top:523.10px" class="cls_004"><span class="cls_004">by the dynamic linker at runtime [160].  Even though our patched dynamic linker does</span></div>
<div style="position:absolute;left:63.87px;top:535.05px" class="cls_004"><span class="cls_004">not search in</span><span class="cls_007"> /nix/store/5jq6jgkamxjj...-openssl-0.9.7d/lib</span><span class="cls_004"> by default, it will find the library</span></div>
<div style="position:absolute;left:63.87px;top:547.01px" class="cls_004"><span class="cls_004">anyway through the executable’s</span><span class="cls_007"> RPATH</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:559.11px" class="cls_004"><span class="cls_004">This might appear to be bad news for our attempts to prevent undeclared dependencies.</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">Of course, we happen to know the internal structure of Unix executables, so for this specific</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">file format we can discover retained dependencies. But we do not know the format of every</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">23</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:20700px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background032.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2. An Overview of Nix</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">file type, and we do not wish to commit ourselves to a single component composition</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">mechanism. E.g., Java and .NET can find retained dependencies by looking at class files</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">and assemblies, respectively, but only for their specific dynamic linkage mechanisms (and</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">not for dependencies loaded at runtime).</span></div>
<div style="position:absolute;left:69.68px;top:93.17px" class="cls_004"><span class="cls_004">The hashing scheme comes to the rescue once more. The hash part of component paths</span></div>
<div style="position:absolute;left:59.72px;top:105.12px" class="cls_004"><span class="cls_004">is highly distinctive, e.g.,</span><span class="cls_007"> 5jq6jgkamxjj</span></div>
<div style="position:absolute;left:230.15px;top:105.12px" class="cls_004"><span class="cls_004">Therefore we can discover retained dependen-</span></div>
<div style="position:absolute;left:59.72px;top:117.08px" class="cls_004"><span class="cls_004">cies generically, independent of specific file formats, by scanning for occurrences of hash</span></div>
<div style="position:absolute;left:59.72px;top:129.03px" class="cls_004"><span class="cls_004">parts.  For instance, the executable image in Figure 2.4 contains the highlighted string</span></div>
<div style="position:absolute;left:59.72px;top:140.99px" class="cls_007"><span class="cls_007">5jq6jgkamxjj...</span><span class="cls_004">, which is evidence that an execution of the</span><span class="cls_007"> svn</span><span class="cls_004"> program might need that</span></div>
<div style="position:absolute;left:59.72px;top:152.94px" class="cls_004"><span class="cls_004">particular OpenSSL instance. Likewise, we can see that it has a retained dependency on</span></div>
<div style="position:absolute;left:59.72px;top:164.90px" class="cls_004"><span class="cls_004">some Glibc instance (</span><span class="cls_007">/nix/store/72by2iw5wd8i</span></div>
<div style="position:absolute;left:254.71px;top:164.90px" class="cls_004"><span class="cls_004">Thus, we automatically add these as run-</span></div>
<div style="position:absolute;left:59.72px;top:176.85px" class="cls_004"><span class="cls_004">time dependencies of the Subversion component. Using this scanning approach, we find</span></div>
<div style="position:absolute;left:59.72px;top:188.81px" class="cls_004"><span class="cls_004">the runtime dependencies indicated in Figure 2.1.</span></div>
<div style="position:absolute;left:69.68px;top:201.07px" class="cls_004"><span class="cls_004">This approach might seem a bit dodgy. After all, what happens when a file name is rep-</span></div>
<div style="position:absolute;left:59.72px;top:213.02px" class="cls_004"><span class="cls_004">resented in a non-standard way, e.g., in UTF-16 [34, Section 2.5] or when the executable</span></div>
<div style="position:absolute;left:59.72px;top:224.98px" class="cls_004"><span class="cls_004">is compressed? In Chapter 3 the dependency problem is cast in terms of memory man-</span></div>
<div style="position:absolute;left:59.72px;top:236.93px" class="cls_004"><span class="cls_004">agement in programming languages, which justifies the scanning approach as an analogue</span></div>
<div style="position:absolute;left:59.72px;top:248.89px" class="cls_004"><span class="cls_004">of conservative garbage collection. Whether this is a legitimate approach is an empirical</span></div>
<div style="position:absolute;left:59.72px;top:260.84px" class="cls_004"><span class="cls_004">question, which is addressed in Section 7.1.5.</span></div>
<div style="position:absolute;left:69.68px;top:273.11px" class="cls_004"><span class="cls_004">Note that strictly speaking it is not the use of cryptographic hashes per se, but globally</span></div>
<div style="position:absolute;left:59.72px;top:285.06px" class="cls_004"><span class="cls_004">unique identifiers in file names that make this work. A sufficiently long pseudo-random</span></div>
<div style="position:absolute;left:59.72px;top:297.02px" class="cls_004"><span class="cls_004">number also does the trick. However, the hashes are needed to prevent interference, while</span></div>
<div style="position:absolute;left:59.72px;top:308.97px" class="cls_004"><span class="cls_004">at the same time preventing unnecessary duplication of identical components (which would</span></div>
<div style="position:absolute;left:59.72px;top:320.93px" class="cls_004"><span class="cls_004">happen with random paths).</span></div>
<div style="position:absolute;left:59.72px;top:349.13px" class="cls_009"><span class="cls_009">Closures</span><span class="cls_004">   Section 1.2 first stated the goal of complete deployment: safe deployment re-</span></div>
<div style="position:absolute;left:59.72px;top:361.09px" class="cls_004"><span class="cls_004">quires that there are no missing dependencies. This means that we need to deploy closures</span></div>
<div style="position:absolute;left:59.72px;top:373.05px" class="cls_004"><span class="cls_004">of components under the “depends-on” relation.  That is, when we deploy (i.e., copy) a</span></div>
<div style="position:absolute;left:59.72px;top:385.00px" class="cls_004"><span class="cls_004">component X to a client machine, and X depends on Y , then we also need to deploy Y to</span></div>
<div style="position:absolute;left:59.72px;top:396.96px" class="cls_004"><span class="cls_004">the client machine.</span></div>
<div style="position:absolute;left:69.68px;top:409.22px" class="cls_004"><span class="cls_004">The hash scanning approach gives us all runtime dependencies of a component, while</span></div>
<div style="position:absolute;left:59.72px;top:421.17px" class="cls_004"><span class="cls_004">hashes themselves prevent undeclared build-time dependencies.  Furthermore, these de-</span></div>
<div style="position:absolute;left:59.72px;top:433.13px" class="cls_004"><span class="cls_004">pendencies are exact, not nominal (see page 8). Thus, Nix knows the entire dependency</span></div>
<div style="position:absolute;left:59.72px;top:445.08px" class="cls_004"><span class="cls_004">graph, both at build time and runtime. With full knowledge of the dependency graph, Nix</span></div>
<div style="position:absolute;left:59.72px;top:457.04px" class="cls_004"><span class="cls_004">can compute closures of components. Figure 2.2 shows the closure of the Subversion 1.1.4</span></div>
<div style="position:absolute;left:59.72px;top:468.99px" class="cls_004"><span class="cls_004">instance in the Nix store, found by transitively following all dependency arrows.</span></div>
<div style="position:absolute;left:69.68px;top:481.25px" class="cls_004"><span class="cls_004">In summary, the purely functional model, and its concrete implementation in the form</span></div>
<div style="position:absolute;left:59.72px;top:493.21px" class="cls_004"><span class="cls_004">of the hashing approach used by the Nix store, prevents interference and enables complete</span></div>
<div style="position:absolute;left:59.72px;top:505.16px" class="cls_004"><span class="cls_004">deployment.  It makes deployment much more likely to be correct, and is therefore one</span></div>
<div style="position:absolute;left:59.72px;top:517.12px" class="cls_004"><span class="cls_004">of the major results of this thesis. However, the purely functional model does provoke a</span></div>
<div style="position:absolute;left:59.72px;top:529.07px" class="cls_004"><span class="cls_004">number of questions, such as:</span></div>
<div style="position:absolute;left:74.66px;top:549.92px" class="cls_004"><span class="cls_004">• Hashes do not appear to be very user-friendly.  Can we hide them from users in</span></div>
<div style="position:absolute;left:84.62px;top:561.87px" class="cls_004"><span class="cls_004">everyday interaction?</span></div>
<div style="position:absolute;left:74.66px;top:583.02px" class="cls_004"><span class="cls_004">• Can we deploy upgrades efficiently? That is, suppose that we want to upgrade Glibc</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">24</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:21390px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background033.jpg" width=481 height=680></div>
<div style="position:absolute;left:338.48px;top:17.14px" class="cls_004"><span class="cls_004">2.2. Nix expressions</span></div>
<div style="position:absolute;left:88.78px;top:45.04px" class="cls_004"><span class="cls_004">(a dependency of all other components in Figure 2.1).  Can we prevent a costly</span></div>
<div style="position:absolute;left:88.78px;top:56.99px" class="cls_004"><span class="cls_004">redownload of all dependent components?</span></div>
<div style="position:absolute;left:63.87px;top:77.47px" class="cls_004"><span class="cls_004">As we will see in the remainder of this thesis, the answer to these questions is “yes”.</span></div>
<div style="position:absolute;left:63.87px;top:109.14px" class="cls_011"><span class="cls_011">2.2. Nix expressions</span></div>
<div style="position:absolute;left:63.87px;top:134.70px" class="cls_004"><span class="cls_004">Nix components are built from Nix expressions. The language of Nix expressions is a sim-</span></div>
<div style="position:absolute;left:63.87px;top:146.66px" class="cls_004"><span class="cls_004">ple purely functional language used to describe components and the compositions thereof.</span></div>
<div style="position:absolute;left:73.84px;top:158.79px" class="cls_004"><span class="cls_004">This section introduces the Nix expression language using a simple example. In com-</span></div>
<div style="position:absolute;left:63.87px;top:170.75px" class="cls_004"><span class="cls_004">puter science’s finest tradition we will start with “Hello World”; to be precise, a Nix ex-</span></div>
<div style="position:absolute;left:63.87px;top:182.70px" class="cls_004"><span class="cls_004">pression that builds the GNU Hello package. GNU Hello is a program that prints out the</span></div>
<div style="position:absolute;left:63.87px;top:194.66px" class="cls_004"><span class="cls_004">text</span><span class="cls_007"> Hello World</span><span class="cls_004"> and so “allows nonprogrammers to use a classic computer science tool</span></div>
<div style="position:absolute;left:63.87px;top:206.61px" class="cls_004"><span class="cls_004">which would otherwise be unavailable to them” [67]. It is representative of what one must</span></div>
<div style="position:absolute;left:63.87px;top:218.57px" class="cls_004"><span class="cls_004">do to deploy a component using Nix. Generally, to deploy a component one performs the</span></div>
<div style="position:absolute;left:63.87px;top:230.52px" class="cls_004"><span class="cls_004">following three steps:</span></div>
<div style="position:absolute;left:78.82px;top:251.00px" class="cls_004"><span class="cls_004">• Write a Nix expression for the component (Figure 2.6), which describes all the in-</span></div>
<div style="position:absolute;left:88.78px;top:262.95px" class="cls_004"><span class="cls_004">puts involved in building the component, such as dependencies (other components</span></div>
<div style="position:absolute;left:88.78px;top:274.91px" class="cls_004"><span class="cls_004">required by the component), sources, and so on.</span></div>
<div style="position:absolute;left:78.82px;top:295.56px" class="cls_004"><span class="cls_004">• Write a builder (Figure 2.7)—typically a shell script—that actually builds the com-</span></div>
<div style="position:absolute;left:88.78px;top:307.51px" class="cls_004"><span class="cls_004">ponent from the inputs.</span></div>
<div style="position:absolute;left:78.82px;top:328.17px" class="cls_004"><span class="cls_004">• Create a composition (Figure 2.8). The Nix expression written in the first step is a</span></div>
<div style="position:absolute;left:88.78px;top:340.12px" class="cls_004"><span class="cls_004">function: in order to build a concrete component, it requires that the dependencies are</span></div>
<div style="position:absolute;left:88.78px;top:352.08px" class="cls_004"><span class="cls_004">filled in. To compose the component with its dependencies, we must write another</span></div>
<div style="position:absolute;left:88.78px;top:364.03px" class="cls_004"><span class="cls_004">Nix expression that calls the function with appropriate arguments.</span></div>
<div style="position:absolute;left:63.87px;top:391.56px" class="cls_009"><span class="cls_009">The Nix Packages collection</span><span class="cls_004">   The GNU Hello example is taken from the Nix Packages</span></div>
<div style="position:absolute;left:63.87px;top:403.51px" class="cls_004"><span class="cls_004">collection (Nixpkgs), a large set of Nix expressions for common and not-so-common soft-</span></div>
<div style="position:absolute;left:63.87px;top:415.47px" class="cls_004"><span class="cls_004">ware components. Since Nixpkgs contains many components and also describes their com-</span></div>
<div style="position:absolute;left:63.87px;top:427.42px" class="cls_004"><span class="cls_004">positions, many files are involved in building a component. It is useful to have a mental pic-</span></div>
<div style="position:absolute;left:63.87px;top:439.38px" class="cls_004"><span class="cls_004">ture of how the different parts fit together. Figure 2.5 shows the directory structure of parts</span></div>
<div style="position:absolute;left:63.87px;top:451.33px" class="cls_004"><span class="cls_004">of the Nix Packages collection, including some of the Nix expressions, builders, and mis-</span></div>
<div style="position:absolute;left:63.87px;top:463.29px" class="cls_004"><span class="cls_004">cellaneous inputs contained therein. The function that builds Hello components is defined</span></div>
<div style="position:absolute;left:63.87px;top:475.24px" class="cls_004"><span class="cls_004">in</span><span class="cls_007"> pkgs/applications/misc/hello/default.nix</span><span class="cls_004">. Likewise, many other components are defined,</span></div>
<div style="position:absolute;left:63.87px;top:487.20px" class="cls_004"><span class="cls_004">hierarchically organised by component purpose or topic. Builders are placed in the same</span></div>
<div style="position:absolute;left:63.87px;top:499.15px" class="cls_004"><span class="cls_004">directory as the Nix expression that uses them, e.g.,</span><span class="cls_007"> pkgs/applications/misc/hello/builder.sh</span></div>
<div style="position:absolute;left:63.87px;top:511.11px" class="cls_004"><span class="cls_004">for the Hello build script.</span></div>
<div style="position:absolute;left:73.84px;top:523.25px" class="cls_004"><span class="cls_004">Compositions are defined in</span><span class="cls_007"> pkgs/system/all-packages-generic.nix</span><span class="cls_004">, which imports the</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">various component-specific Nix expressions and puts them all together.  The file has</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_007"><span class="cls_007">generic</span><span class="cls_004"> in its name because it is itself a function that returns compositions for vari-</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">ous machine architecture and operating system platforms. The function</span><span class="cls_007"> pkgs/system/all-</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_007"><span class="cls_007">packages.nix</span><span class="cls_004"> does actually evaluate to a set of concrete components that can be built and</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">installed on the current platform.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">25</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:22080px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background034.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2.</span></div>
<div style="position:absolute;left:72.17px;top:17.14px" class="cls_004"><span class="cls_004">An Overview of Nix</span></div>
<div style="position:absolute;left:157.43px;top:49.35px" class="cls_016"><span class="cls_016">nixpkgs</span></div>
<div style="position:absolute;left:173.37px;top:58.82px" class="cls_016"><span class="cls_016">pkgs</span></div>
<div style="position:absolute;left:189.31px;top:68.33px" class="cls_016"><span class="cls_016">applications</span></div>
<div style="position:absolute;left:205.25px;top:78.50px" class="cls_016"><span class="cls_016">misc</span></div>
<div style="position:absolute;left:221.19px;top:87.97px" class="cls_016"><span class="cls_016">hello</span></div>
<div style="position:absolute;left:237.13px;top:97.51px" class="cls_016"><span class="cls_016">default.nix</span></div>
<div style="position:absolute;left:237.13px;top:106.89px" class="cls_016"><span class="cls_016">builder.sh</span></div>
<div style="position:absolute;left:205.25px;top:115.57px" class="cls_016"><span class="cls_016">networking</span></div>
<div style="position:absolute;left:221.19px;top:125.79px" class="cls_016"><span class="cls_016">browsers</span></div>
<div style="position:absolute;left:237.13px;top:135.34px" class="cls_016"><span class="cls_016">firefox</span></div>
<div style="position:absolute;left:253.07px;top:144.81px" class="cls_016"><span class="cls_016">default.nix</span></div>
<div style="position:absolute;left:253.07px;top:154.18px" class="cls_016"><span class="cls_016">builder.sh</span></div>
<div style="position:absolute;left:253.07px;top:162.92px" class="cls_016"><span class="cls_016">writable-copies.patch</span></div>
<div style="position:absolute;left:189.31px;top:172.35px" class="cls_016"><span class="cls_016">development</span></div>
<div style="position:absolute;left:205.25px;top:182.53px" class="cls_016"><span class="cls_016">libraries</span></div>
<div style="position:absolute;left:221.19px;top:191.24px" class="cls_016"><span class="cls_016">glibc</span></div>
<div style="position:absolute;left:237.13px;top:201.54px" class="cls_016"><span class="cls_016">default.nix</span></div>
<div style="position:absolute;left:237.13px;top:210.91px" class="cls_016"><span class="cls_016">builder.sh</span></div>
<div style="position:absolute;left:205.25px;top:219.64px" class="cls_016"><span class="cls_016">compilers</span></div>
<div style="position:absolute;left:221.19px;top:228.42px" class="cls_016"><span class="cls_016">gcc</span></div>
<div style="position:absolute;left:205.25px;top:248.01px" class="cls_016"><span class="cls_016">interpreters</span></div>
<div style="position:absolute;left:221.19px;top:257.48px" class="cls_016"><span class="cls_016">perl</span></div>
<div style="position:absolute;left:189.31px;top:276.25px" class="cls_016"><span class="cls_016">system</span></div>
<div style="position:absolute;left:205.25px;top:285.79px" class="cls_016"><span class="cls_016">all-packages-generic.nix</span></div>
<div style="position:absolute;left:205.25px;top:295.25px" class="cls_016"><span class="cls_016">all-packages.nix</span></div>
<div style="position:absolute;left:205.25px;top:305.46px" class="cls_016"><span class="cls_016">stdenvs.nix</span></div>
<div style="position:absolute;left:126.85px;top:326.85px" class="cls_004"><span class="cls_004">Figure</span></div>
<div style="position:absolute;left:155.36px;top:326.85px" class="cls_004"><span class="cls_004">2.5.: Organisation of the Nix Packages collection</span></div>
<div style="position:absolute;left:69.68px;top:357.42px" class="cls_004"><span class="cls_004">There is nothing in Nix that requires this organisation; it is merely a useful convention.</span></div>
<div style="position:absolute;left:59.72px;top:369.38px" class="cls_004"><span class="cls_004">It is perfectly possible to place component expressions and builders in the same directory</span></div>
<div style="position:absolute;left:59.72px;top:381.33px" class="cls_004"><span class="cls_004">by naming them appropriately, e.g.,</span><span class="cls_007"> hello.nix</span><span class="cls_004">,</span><span class="cls_007"> hello-builder.sh</span><span class="cls_004">,</span><span class="cls_007"> firefox.nix</span><span class="cls_004">, and so on. It is</span></div>
<div style="position:absolute;left:59.72px;top:393.29px" class="cls_004"><span class="cls_004">also possible to put all Nix expressions in a single file, e.g., put everything in</span><span class="cls_007"> all-packages-</span></div>
<div style="position:absolute;left:59.72px;top:405.24px" class="cls_007"><span class="cls_007">generic.nix</span><span class="cls_004">, which of course would make this file quickly spiral out of control.  In fact,</span></div>
<div style="position:absolute;left:59.72px;top:417.20px" class="cls_004"><span class="cls_004">it is not even necessary to define components as functions and compose them separately,</span></div>
<div style="position:absolute;left:59.72px;top:429.15px" class="cls_004"><span class="cls_004">as done in the 3-step procedure above; we could remove all variability and write Nix</span></div>
<div style="position:absolute;left:59.72px;top:441.11px" class="cls_004"><span class="cls_004">expressions that describe exactly one build action, rather than a family of build actions.</span></div>
<div style="position:absolute;left:59.72px;top:453.06px" class="cls_004"><span class="cls_004">Clearly, that is not a very general approach.</span></div>
<div style="position:absolute;left:69.68px;top:465.02px" class="cls_004"><span class="cls_004">We now look at the parts that constitute the Hello component in detail.</span></div>
<div style="position:absolute;left:59.72px;top:491.21px" class="cls_009"><span class="cls_009">Nix expression for the Hello component</span><span class="cls_004">   Figure 2.6 shows a Nix expression for GNU</span></div>
<div style="position:absolute;left:59.72px;top:503.17px" class="cls_004"><span class="cls_004">Hello. It has a number of salient features:</span></div>
<div style="position:absolute;left:74.26px;top:525.24px" class="cls_056"><span class="cls_056">2</span></div>
<div style="position:absolute;left:84.62px;top:523.25px" class="cls_004"><span class="cls_004">This states that the expression is a function that expects to be called with three ar-</span></div>
<div style="position:absolute;left:84.62px;top:535.20px" class="cls_004"><span class="cls_004">guments:</span><span class="cls_007"> stdenv</span><span class="cls_004">,</span><span class="cls_007"> fetchurl</span><span class="cls_004">, and</span><span class="cls_007"> perl</span><span class="cls_004">. They are needed to build Hello, but we don’t</span></div>
<div style="position:absolute;left:84.62px;top:547.16px" class="cls_004"><span class="cls_004">know how to build them here; that’s why they are function arguments.</span><span class="cls_007"> stdenv</span><span class="cls_004"> is a</span></div>
<div style="position:absolute;left:84.62px;top:559.11px" class="cls_004"><span class="cls_004">component that is used by almost all Nix Packages components; it provides a “stan-</span></div>
<div style="position:absolute;left:84.62px;top:571.07px" class="cls_004"><span class="cls_004">dard” environment consisting of the things one expects in a basic Unix environment:</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">a C/C++ compiler (GCC, to be precise), the Bash shell, fundamental Unix tools</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">26</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:22770px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background035.jpg" width=481 height=680></div>
<div style="position:absolute;left:338.48px;top:17.14px" class="cls_004"><span class="cls_004">2.2. Nix expressions</span></div>
<div style="position:absolute;left:67.26px;top:50.61px" class="cls_015"><span class="cls_015">{stdenv,  fetchurl,  perl}:</span></div>
<div style="position:absolute;left:191.02px;top:47.34px" class="cls_056"><span class="cls_056">2</span></div>
<div style="position:absolute;left:67.26px;top:72.52px" class="cls_015"><span class="cls_015">stdenv.mkDerivation  {</span></div>
<div style="position:absolute;left:172.19px;top:69.26px" class="cls_056"><span class="cls_056">3</span></div>
<div style="position:absolute;left:76.67px;top:83.48px" class="cls_015"><span class="cls_015">name  =  "hello-2.1.1";</span></div>
<div style="position:absolute;left:181.60px;top:80.22px" class="cls_056"><span class="cls_056">4</span></div>
<div style="position:absolute;left:76.67px;top:94.44px" class="cls_015"><span class="cls_015">builder  =  ./builder.sh;</span></div>
<div style="position:absolute;left:191.02px;top:91.18px" class="cls_056"><span class="cls_056">5</span></div>
<div style="position:absolute;left:76.67px;top:105.40px" class="cls_015"><span class="cls_015">src  =  fetchurl  {</span></div>
<div style="position:absolute;left:158.07px;top:102.14px" class="cls_056"><span class="cls_056">6</span></div>
<div style="position:absolute;left:86.09px;top:116.36px" class="cls_015"><span class="cls_015">url  =  </span><A HREF="http://ftp.gnu.org/pub/gnu/hello/hello-2.1.1.tar.gz;/">http://ftp.gnu.org/pub/gnu/hello/hello-2.1.1.tar.gz;</A> </div>
<div style="position:absolute;left:86.09px;top:127.32px" class="cls_015"><span class="cls_015">md5  =  "70c9ccf9fac07f762c24f2df2290784d";</span></div>
<div style="position:absolute;left:76.67px;top:138.28px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:76.67px;top:149.24px" class="cls_015"><span class="cls_015">inherit  perl;</span></div>
<div style="position:absolute;left:143.96px;top:145.97px" class="cls_056"><span class="cls_056">7</span></div>
<div style="position:absolute;left:67.26px;top:160.20px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:77.29px;top:176.79px" class="cls_004"><span class="cls_004">Figure 2.6.:</span><span class="cls_007"> pkgs/applications/misc/hello/default.nix</span><span class="cls_004">: Nix expression for GNU Hello</span></div>
<div style="position:absolute;left:88.78px;top:209.25px" class="cls_004"><span class="cls_004">such as</span><span class="cls_007"> cp</span><span class="cls_004">,</span><span class="cls_007"> grep</span><span class="cls_004">,</span><span class="cls_007"> tar</span><span class="cls_004">, etc.</span><span class="cls_007"> fetchurl</span><span class="cls_004"> is a function that downloads files.</span><span class="cls_007"> perl</span><span class="cls_004"> is the Perl</span></div>
<div style="position:absolute;left:88.78px;top:221.21px" class="cls_004"><span class="cls_004">interpreter.</span></div>
<div style="position:absolute;left:88.78px;top:237.56px" class="cls_004"><span class="cls_004">Nix functions generally have the form</span><span class="cls_007"> {</span><span class="cls_004">x</span><span class="cls_007">,</span><span class="cls_004"> y</span><span class="cls_007">, ...,</span><span class="cls_004"> z</span><span class="cls_007">}:</span><span class="cls_004"> e where x, y, etc. are the names</span></div>
<div style="position:absolute;left:88.78px;top:249.52px" class="cls_004"><span class="cls_004">of the expected arguments, and where e is the body (result) of the function. So here,</span></div>
<div style="position:absolute;left:88.78px;top:261.47px" class="cls_004"><span class="cls_004">the entire remainder of the file is the body of the function; when given the required</span></div>
<div style="position:absolute;left:88.78px;top:273.43px" class="cls_004"><span class="cls_004">arguments, the body describes how to build an instance of the Hello component.</span></div>
<div style="position:absolute;left:78.42px;top:296.18px" class="cls_056"><span class="cls_056">3</span></div>
<div style="position:absolute;left:88.78px;top:294.19px" class="cls_004"><span class="cls_004">The result of the function in this case is a derivation. This is Nix-speak for a com-</span></div>
<div style="position:absolute;left:88.78px;top:306.15px" class="cls_004"><span class="cls_004">ponent build action, which derives the component from its inputs.  We perform a</span></div>
<div style="position:absolute;left:88.78px;top:318.10px" class="cls_004"><span class="cls_004">derivation by calling</span><span class="cls_007"> stdenv.mkDerivation</span><span class="cls_004">.</span><span class="cls_007"> mkDerivation</span><span class="cls_004"> is a function provided by</span></div>
<div style="position:absolute;left:88.78px;top:329.03px" class="cls_007"><span class="cls_007">stdenv</span><span class="cls_004"> that builds a component from a set of attributes</span><span class="cls_012"><sup>2</sup></span><span class="cls_004">. An attribute set is just a</span></div>
<div style="position:absolute;left:88.78px;top:342.01px" class="cls_004"><span class="cls_004">list of key/value pairs where each value is an arbitrary Nix expression. They take the</span></div>
<div style="position:absolute;left:88.78px;top:353.97px" class="cls_004"><span class="cls_004">general form</span><span class="cls_007"> {name</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> = expr</span><span class="cls_012"><sub>1</sub></span><span class="cls_007">; ... name</span><span class="cls_012"><sub>n</sub></span><span class="cls_007"> = expr</span><span class="cls_012"><sub>n</sub></span><span class="cls_007">;}</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:88.78px;top:370.32px" class="cls_004"><span class="cls_004">The attributes given to</span><span class="cls_007"> stdenv.mkDerivation</span><span class="cls_004"> are the concrete inputs to the build ac-</span></div>
<div style="position:absolute;left:88.78px;top:382.28px" class="cls_004"><span class="cls_004">tion.</span></div>
<div style="position:absolute;left:78.42px;top:405.03px" class="cls_056"><span class="cls_056">4</span></div>
<div style="position:absolute;left:88.78px;top:403.04px" class="cls_004"><span class="cls_004">A few of the attributes to derivations are special. The attribute</span><span class="cls_007"> name</span><span class="cls_004"> specifies the</span></div>
<div style="position:absolute;left:88.78px;top:415.00px" class="cls_004"><span class="cls_004">symbolic name and version of the component. It is appended to the cryptographic</span></div>
<div style="position:absolute;left:88.78px;top:426.95px" class="cls_004"><span class="cls_004">hash in store paths (see, e.g., Figure 2.1). Nix doesn’t care very much about it most</span></div>
<div style="position:absolute;left:88.78px;top:438.91px" class="cls_004"><span class="cls_004">of the time.</span></div>
<div style="position:absolute;left:78.42px;top:461.66px" class="cls_056"><span class="cls_056">5</span></div>
<div style="position:absolute;left:88.78px;top:459.67px" class="cls_004"><span class="cls_004">The attribute</span><span class="cls_007"> builder</span><span class="cls_004"> specifies the script that actually builds the component.  This</span></div>
<div style="position:absolute;left:88.78px;top:471.62px" class="cls_004"><span class="cls_004">attribute can sometimes be omitted, in which case</span><span class="cls_007"> stdenv.mkDerivation</span><span class="cls_004"> will fill in</span></div>
<div style="position:absolute;left:88.78px;top:483.58px" class="cls_004"><span class="cls_004">a default builder (which essentially performs a “standard” Unix component build</span></div>
<div style="position:absolute;left:88.78px;top:495.53px" class="cls_004"><span class="cls_004">sequence consisting of the commands</span><span class="cls_007"> configure; make; make install</span><span class="cls_004">). Hello is suf-</span></div>
<div style="position:absolute;left:88.78px;top:507.49px" class="cls_004"><span class="cls_004">ficiently simple that the default builder suffices; but in this case, for educational</span></div>
<div style="position:absolute;left:88.78px;top:519.44px" class="cls_004"><span class="cls_004">purposes an actual builder is shown in Figure 2.7, discussed below.</span></div>
<div style="position:absolute;left:78.42px;top:542.20px" class="cls_056"><span class="cls_056">6</span></div>
<div style="position:absolute;left:88.78px;top:540.21px" class="cls_004"><span class="cls_004">The builder has to know what the sources of the component are. Here, the attribute</span></div>
<div style="position:absolute;left:88.78px;top:552.16px" class="cls_007"><span class="cls_007">src</span><span class="cls_004"> is bound to the result of a call to the</span><span class="cls_007"> fetchurl</span><span class="cls_004"> function. Given a URL and an MD5</span></div>
<div style="position:absolute;left:88.78px;top:564.12px" class="cls_004"><span class="cls_004">hash of the expected contents of the file at that URL, this function builds a derivation</span></div>
<div style="position:absolute;left:68.36px;top:584.11px" class="cls_013"><span class="cls_013"><sup>2</sup></span><span class="cls_016">mkDerivation</span><span class="cls_014"> is actually a wrapper around the primitive operation</span><span class="cls_016"> derivation</span><span class="cls_014">, shown on page 80.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">27</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:23460px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background036.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2. An Overview of Nix</span></div>
<div style="position:absolute;left:63.10px;top:50.61px" class="cls_015"><span class="cls_015">source  $stdenv/setup</span></div>
<div style="position:absolute;left:163.33px;top:47.34px" class="cls_056"><span class="cls_056">8</span></div>
<div style="position:absolute;left:63.10px;top:72.52px" class="cls_015"><span class="cls_015">PATH=$perl/bin:$PATH</span></div>
<div style="position:absolute;left:163.33px;top:69.26px" class="cls_056"><span class="cls_056">9</span></div>
<div style="position:absolute;left:63.10px;top:94.44px" class="cls_015"><span class="cls_015">tar  xvfz  $src</span></div>
<div style="position:absolute;left:130.39px;top:91.18px" class="cls_056"><span class="cls_056">10</span></div>
<div style="position:absolute;left:63.10px;top:105.40px" class="cls_015"><span class="cls_015">cd  hello-*</span></div>
<div style="position:absolute;left:63.10px;top:116.36px" class="cls_015"><span class="cls_015">./configure  --prefix=$out</span></div>
<div style="position:absolute;left:186.86px;top:113.10px" class="cls_056"><span class="cls_056">11</span></div>
<div style="position:absolute;left:63.10px;top:127.32px" class="cls_015"><span class="cls_015">make</span></div>
<div style="position:absolute;left:88.03px;top:124.06px" class="cls_056"><span class="cls_056">12</span></div>
<div style="position:absolute;left:63.10px;top:138.28px" class="cls_015"><span class="cls_015">make  install</span></div>
<div style="position:absolute;left:89.31px;top:154.12px" class="cls_004"><span class="cls_004">Figure 2.7.:</span><span class="cls_007"> pkgs/applications/misc/hello/builder.sh</span><span class="cls_004">: Builder for GNU Hello</span></div>
<div style="position:absolute;left:84.62px;top:185.00px" class="cls_004"><span class="cls_004">that downloads the file and checks its hash. So the sources are dependencies that like</span></div>
<div style="position:absolute;left:84.62px;top:196.95px" class="cls_004"><span class="cls_004">all other dependencies are built before Hello itself is built.</span></div>
<div style="position:absolute;left:84.62px;top:212.60px" class="cls_004"><span class="cls_004">Instead of</span><span class="cls_007"> src</span><span class="cls_004"> any other name could have been used, and in fact there can be any</span></div>
<div style="position:absolute;left:84.62px;top:224.55px" class="cls_004"><span class="cls_004">number of sources (bound to different attributes). However,</span><span class="cls_007"> src</span><span class="cls_004"> is customary, and it</span></div>
<div style="position:absolute;left:84.62px;top:236.51px" class="cls_004"><span class="cls_004">is also expected by the default builder (which we don’t use in this example).</span></div>
<div style="position:absolute;left:74.26px;top:257.84px" class="cls_056"><span class="cls_056">7</span></div>
<div style="position:absolute;left:84.62px;top:255.85px" class="cls_004"><span class="cls_004">Since the derivation requires Perl, we have to pass the value of the</span><span class="cls_007"> perl</span><span class="cls_004"> function</span></div>
<div style="position:absolute;left:84.62px;top:267.81px" class="cls_004"><span class="cls_004">argument to the builder. All attributes in the set are actually passed as environment</span></div>
<div style="position:absolute;left:84.62px;top:279.76px" class="cls_004"><span class="cls_004">variables to the builder, so declaring an attribute</span></div>
<div style="position:absolute;left:106.54px;top:303.36px" class="cls_015"><span class="cls_015">perl  =  perl;</span></div>
<div style="position:absolute;left:84.62px;top:317.44px" class="cls_004"><span class="cls_004">will do the trick: it binds an attribute</span><span class="cls_007"> perl</span><span class="cls_004"> to the function argument which also hap-</span></div>
<div style="position:absolute;left:84.62px;top:329.40px" class="cls_004"><span class="cls_004">pens to be called</span><span class="cls_007"> perl</span><span class="cls_004">. However, this looks a bit silly, so there is a shorter syntax.</span></div>
<div style="position:absolute;left:84.62px;top:341.36px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> inherit</span><span class="cls_004"> keyword causes the specified attributes to be bound to whatever variables</span></div>
<div style="position:absolute;left:84.62px;top:353.31px" class="cls_004"><span class="cls_004">with the same name happen to be in scope.</span></div>
<div style="position:absolute;left:59.72px;top:379.57px" class="cls_009"><span class="cls_009">Builder for the Hello component</span><span class="cls_004">   Figure 2.7 shows the builder for GNU Hello. To build</span></div>
<div style="position:absolute;left:59.72px;top:391.53px" class="cls_004"><span class="cls_004">a component, Nix executes the builder. The attributes in the attribute set of the derivation</span></div>
<div style="position:absolute;left:59.72px;top:403.48px" class="cls_004"><span class="cls_004">are passed as environment variables. Attribute values that evaluate to derivations (such as</span></div>
<div style="position:absolute;left:59.72px;top:415.44px" class="cls_007"><span class="cls_007">perl</span><span class="cls_004">, which below in Figure 2.8 is bound to a derivation) are built recursively. The paths</span></div>
<div style="position:absolute;left:59.72px;top:427.39px" class="cls_004"><span class="cls_004">of the resulting components are passed through the corresponding environment variables.</span></div>
<div style="position:absolute;left:59.72px;top:439.35px" class="cls_004"><span class="cls_004">The special environment variable</span><span class="cls_007"> out</span><span class="cls_004"> holds the intended output path.  This is where the</span></div>
<div style="position:absolute;left:59.72px;top:451.30px" class="cls_004"><span class="cls_004">builder should store its result.</span></div>
<div style="position:absolute;left:69.68px;top:463.26px" class="cls_004"><span class="cls_004">The build script for Hello is a typical Unix build script: it unpacks the sources, runs a</span></div>
<div style="position:absolute;left:59.72px;top:475.21px" class="cls_007"><span class="cls_007">configure</span><span class="cls_004"> script that detects platform characteristics and generates Makefiles, runs</span><span class="cls_007"> make</span><span class="cls_004"> to</span></div>
<div style="position:absolute;left:59.72px;top:487.17px" class="cls_004"><span class="cls_004">compile the program, and finally runs</span><span class="cls_007"> make install</span><span class="cls_004"> to copy it to its intended location in the</span></div>
<div style="position:absolute;left:59.72px;top:499.12px" class="cls_004"><span class="cls_004">file system. However, there are some Nix-specific points:</span></div>
<div style="position:absolute;left:74.26px;top:519.87px" class="cls_056"><span class="cls_056">8</span></div>
<div style="position:absolute;left:84.62px;top:517.88px" class="cls_004"><span class="cls_004">When Nix runs a builder, it initially completely clears all environment variables (ex-</span></div>
<div style="position:absolute;left:84.62px;top:529.83px" class="cls_004"><span class="cls_004">cept for the attributes declared in the derivation). For example, the</span><span class="cls_007"> PATH</span><span class="cls_004"> variable is</span></div>
<div style="position:absolute;left:84.62px;top:540.76px" class="cls_004"><span class="cls_004">empty</span><span class="cls_012"><sup>3</sup></span><span class="cls_004">. This is done to prevent undeclared inputs from being used in the build pro-</span></div>
<div style="position:absolute;left:84.62px;top:553.74px" class="cls_004"><span class="cls_004">cess. If for example the</span><span class="cls_007"> PATH</span><span class="cls_004"> contained</span><span class="cls_007"> /usr/bin</span><span class="cls_004">, then the builder might accidentally</span></div>
<div style="position:absolute;left:84.62px;top:565.70px" class="cls_004"><span class="cls_004">use</span><span class="cls_007"> /usr/bin/gcc</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:64.20px;top:584.11px" class="cls_013"><span class="cls_013"><sup>3</sup></span><span class="cls_014">Actually, it is initialised to</span><span class="cls_016"> /path-not-set</span><span class="cls_014"> to prevent Bash from setting it to a default value.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">28</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:24150px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background037.jpg" width=481 height=680></div>
<div style="position:absolute;left:338.48px;top:17.14px" class="cls_004"><span class="cls_004">2.2. Nix expressions</span></div>
<div style="position:absolute;left:88.78px;top:45.04px" class="cls_004"><span class="cls_004">The first step is therefore to set up the environment so that the tools included in the</span></div>
<div style="position:absolute;left:88.78px;top:56.99px" class="cls_004"><span class="cls_004">standard environment are available. This is done by calling the</span><span class="cls_007"> setup</span><span class="cls_004"> script of the</span></div>
<div style="position:absolute;left:88.78px;top:68.95px" class="cls_004"><span class="cls_004">standard environment. The environment variable</span><span class="cls_007"> stdenv</span><span class="cls_004"> points to the location of the</span></div>
<div style="position:absolute;left:88.78px;top:80.90px" class="cls_004"><span class="cls_004">standard environment being used. (It wasn’t specified explicitly as an attribute in the</span></div>
<div style="position:absolute;left:88.78px;top:92.86px" class="cls_004"><span class="cls_004">Hello expression in Figure 2.6, but</span><span class="cls_007"> mkDerivation</span><span class="cls_004"> adds it automatically.)</span></div>
<div style="position:absolute;left:78.42px;top:116.65px" class="cls_056"><span class="cls_056">9</span></div>
<div style="position:absolute;left:88.78px;top:114.66px" class="cls_004"><span class="cls_004">Since Hello needs Perl, we have to make sure that Perl is in the</span><span class="cls_007"> PATH</span><span class="cls_004">. The</span><span class="cls_007"> perl</span><span class="cls_004"> en-</span></div>
<div style="position:absolute;left:88.78px;top:126.61px" class="cls_004"><span class="cls_004">vironment variable points to the location of the Perl component (since it was passed</span></div>
<div style="position:absolute;left:88.78px;top:138.57px" class="cls_004"><span class="cls_004">in as an attribute to the derivation), so the shell expression</span><span class="cls_007"> $perl/bin</span><span class="cls_004"> evaluates to the</span></div>
<div style="position:absolute;left:88.78px;top:150.52px" class="cls_004"><span class="cls_004">directory containing the Perl interpreter.</span></div>
<div style="position:absolute;left:74.43px;top:174.31px" class="cls_056"><span class="cls_056">10</span></div>
<div style="position:absolute;left:88.78px;top:172.32px" class="cls_004"><span class="cls_004">Now we have to unpack the sources. The</span><span class="cls_007"> src</span><span class="cls_004"> attribute was bound to the result of</span></div>
<div style="position:absolute;left:88.78px;top:184.28px" class="cls_004"><span class="cls_004">fetching the Hello source distribution from the network, so the</span><span class="cls_007"> src</span><span class="cls_004"> environment vari-</span></div>
<div style="position:absolute;left:88.78px;top:196.23px" class="cls_004"><span class="cls_004">able points to the location in the Nix store to which the distribution was downloaded.</span></div>
<div style="position:absolute;left:88.78px;top:208.19px" class="cls_004"><span class="cls_004">After unpacking, we change to the resulting source directory.</span></div>
<div style="position:absolute;left:74.43px;top:231.98px" class="cls_056"><span class="cls_056">11</span></div>
<div style="position:absolute;left:88.78px;top:229.98px" class="cls_004"><span class="cls_004">GNU Hello is a typical Autoconf-based package. Autoconf [64, 172] is a tool that</span></div>
<div style="position:absolute;left:88.78px;top:241.94px" class="cls_004"><span class="cls_004">allows a source-based package to automatically adapt itself to its environment by de-</span></div>
<div style="position:absolute;left:88.78px;top:253.89px" class="cls_004"><span class="cls_004">tecting properties such as availability and paths of libraries and other dependencies,</span></div>
<div style="position:absolute;left:88.78px;top:265.85px" class="cls_004"><span class="cls_004">quirks in the C compiler, and so on. Autoconf-based packages always have a script</span></div>
<div style="position:absolute;left:88.78px;top:277.80px" class="cls_004"><span class="cls_004">called</span><span class="cls_007"> configure</span><span class="cls_004"> that performs these tests and generates files such as Makefiles, C</span></div>
<div style="position:absolute;left:88.78px;top:289.76px" class="cls_004"><span class="cls_004">header files (e.g.,</span><span class="cls_007"> config.h</span><span class="cls_004">), etc. Thus, we first have to run Hello’s</span><span class="cls_007"> configure</span><span class="cls_004"> script</span></div>
<div style="position:absolute;left:88.78px;top:301.71px" class="cls_004"><span class="cls_004">(which was generated by Autoconf). The store path where the component is to be</span></div>
<div style="position:absolute;left:88.78px;top:313.67px" class="cls_004"><span class="cls_004">stored, is passed in through the environment variable</span><span class="cls_007"> out</span><span class="cls_004">. Here we tell</span><span class="cls_007"> configure</span><span class="cls_004"> to</span></div>
<div style="position:absolute;left:88.78px;top:325.62px" class="cls_004"><span class="cls_004">produce Makefiles that will build and install a component in the intended output path</span></div>
<div style="position:absolute;left:88.78px;top:337.58px" class="cls_004"><span class="cls_004">in the Nix store.</span></div>
<div style="position:absolute;left:74.43px;top:361.37px" class="cls_056"><span class="cls_056">12</span></div>
<div style="position:absolute;left:88.78px;top:359.38px" class="cls_004"><span class="cls_004">Finally we build Hello (</span><span class="cls_007">make</span><span class="cls_004">) and install it into the location specified by the</span><span class="cls_007"> out</span></div>
<div style="position:absolute;left:88.78px;top:371.33px" class="cls_004"><span class="cls_004">variable (</span><span class="cls_007">make install</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:63.87px;top:400.43px" class="cls_009"><span class="cls_009">Composition of the Hello component</span><span class="cls_004">   Since the Nix expression for Hello in Figure 2.6</span></div>
<div style="position:absolute;left:63.87px;top:412.39px" class="cls_004"><span class="cls_004">is a function, we cannot use it directly to build and install a Hello component. We need</span></div>
<div style="position:absolute;left:63.87px;top:424.34px" class="cls_004"><span class="cls_004">to compose it first; that is, we have to call the function with the expected arguments. In</span></div>
<div style="position:absolute;left:63.87px;top:436.30px" class="cls_004"><span class="cls_004">the Nix Packages collection this is done in the file</span><span class="cls_007"> pkgs/system/all-packages-generic.nix</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:63.87px;top:448.25px" class="cls_004"><span class="cls_004">where all Nix expressions for components are imported and called with the appropriate</span></div>
<div style="position:absolute;left:63.87px;top:460.21px" class="cls_004"><span class="cls_004">arguments. This is a large file, but the parts relevant to Hello are shown in Figure 2.8.</span></div>
<div style="position:absolute;left:74.43px;top:485.99px" class="cls_056"><span class="cls_056">13</span></div>
<div style="position:absolute;left:88.78px;top:484.00px" class="cls_004"><span class="cls_004">This file defines a set of attributes, all of which in this case evaluate to concrete</span></div>
<div style="position:absolute;left:88.78px;top:495.95px" class="cls_004"><span class="cls_004">derivations (i.e., not functions).  In fact, we define a mutually recursive set of at-</span></div>
<div style="position:absolute;left:88.78px;top:506.88px" class="cls_004"><span class="cls_004">tributes using the keyword</span><span class="cls_007"> rec</span><span class="cls_004">. That is, the attributes can refer to each other</span><span class="cls_012"><sup>4</sup></span><span class="cls_004">. This</span></div>
<div style="position:absolute;left:88.78px;top:519.86px" class="cls_004"><span class="cls_004">is precisely what we want, namely, “plug” the various components into each other.</span></div>
<div style="position:absolute;left:74.43px;top:543.65px" class="cls_056"><span class="cls_056">14</span></div>
<div style="position:absolute;left:88.78px;top:541.66px" class="cls_004"><span class="cls_004">Here we import the Nix expression for GNU Hello. The import operation just loads</span></div>
<div style="position:absolute;left:88.78px;top:553.62px" class="cls_004"><span class="cls_004">and returns the specified Nix expression. In fact, we could just have put the contents</span></div>
<div style="position:absolute;left:68.36px;top:574.65px" class="cls_013"><span class="cls_013"><sup>4</sup></span><span class="cls_014">While attributes can refer to values defined in the same scope, derivations cannot be mutual dependencies:</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">such derivations would be impossible to build (see also Lemma 3 on page 130).</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">29</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:24840px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background038.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2. An Overview of Nix</span></div>
<div style="position:absolute;left:63.10px;top:66.78px" class="cls_015"><span class="cls_015">rec  {</span></div>
<div style="position:absolute;left:92.74px;top:63.52px" class="cls_056"><span class="cls_056">13</span></div>
<div style="position:absolute;left:72.52px;top:88.70px" class="cls_015"><span class="cls_015">hello  =  (import  ../applications/misc/hello</span></div>
<div style="position:absolute;left:276.28px;top:85.43px" class="cls_056"><span class="cls_056">14</span></div>
<div style="position:absolute;left:290.35px;top:88.70px" class="cls_015"><span class="cls_015">{</span></div>
<div style="position:absolute;left:301.16px;top:85.43px" class="cls_056"><span class="cls_056">15</span></div>
<div style="position:absolute;left:81.93px;top:99.66px" class="cls_015"><span class="cls_015">inherit  fetchurl  stdenv  perl;</span></div>
<div style="position:absolute;left:72.52px;top:110.61px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:72.52px;top:132.53px" class="cls_015"><span class="cls_015">perl  =  (import  ../development/interpreters/perl)  {</span></div>
<div style="position:absolute;left:313.93px;top:129.27px" class="cls_056"><span class="cls_056">16</span></div>
<div style="position:absolute;left:81.93px;top:143.49px" class="cls_015"><span class="cls_015">inherit  fetchurl  stdenv;</span></div>
<div style="position:absolute;left:72.52px;top:154.45px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:72.52px;top:176.37px" class="cls_015"><span class="cls_015">fetchurl  =  (import  ../build-support/fetchurl)  {</span></div>
<div style="position:absolute;left:81.93px;top:187.33px" class="cls_015"><span class="cls_015">inherit  stdenv;  ...</span></div>
<div style="position:absolute;left:72.52px;top:198.29px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:72.52px;top:220.20px" class="cls_015"><span class="cls_015">stdenv  =  ...;</span></div>
<div style="position:absolute;left:63.10px;top:231.16px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:59.72px;top:256.12px" class="cls_004"><span class="cls_004">Figure 2.8.:</span><span class="cls_007"> pkgs/system/all-packages-generic.nix</span><span class="cls_004">: Composition of GNU Hello and other</span></div>
<div style="position:absolute;left:108.42px;top:268.08px" class="cls_004"><span class="cls_004">components</span></div>
<div style="position:absolute;left:84.62px;top:300.62px" class="cls_004"><span class="cls_004">of Figure 2.6 in</span><span class="cls_007"> all-packages-generic.nix</span><span class="cls_004"> at this point; this is completely equivalent,</span></div>
<div style="position:absolute;left:84.62px;top:312.57px" class="cls_004"><span class="cls_004">but it would make the file rather bulky.</span></div>
<div style="position:absolute;left:84.62px;top:329.00px" class="cls_004"><span class="cls_004">Relative paths such as</span><span class="cls_007"> ../applications/misc/hello</span><span class="cls_004"> are relative to the directory of the Nix</span></div>
<div style="position:absolute;left:84.62px;top:340.96px" class="cls_004"><span class="cls_004">expression that contains them, rather than the current directory or some global search</span></div>
<div style="position:absolute;left:84.62px;top:352.92px" class="cls_004"><span class="cls_004">path.  Since the expression in Figure 2.8 is stored in</span><span class="cls_007"> pkgs/system/all-packages-</span></div>
<div style="position:absolute;left:84.62px;top:364.87px" class="cls_007"><span class="cls_007">generic.nix</span><span class="cls_004">, this relative path resolves to</span><span class="cls_007"> pkgs/applications/misc/hello</span><span class="cls_004">, which is the</span></div>
<div style="position:absolute;left:84.62px;top:376.83px" class="cls_004"><span class="cls_004">directory of the Nix expression in Figure 2.6.</span></div>
<div style="position:absolute;left:84.62px;top:393.26px" class="cls_004"><span class="cls_004">Note  that  we  refer  to</span><span class="cls_007">  ../applications/misc/hello</span><span class="cls_004">,  not</span><span class="cls_007">  ../applications/misc/hello/-</span></div>
<div style="position:absolute;left:84.62px;top:405.21px" class="cls_007"><span class="cls_007">default.nix</span><span class="cls_004">. The latter is actually equivalent to the former in the case of directories;</span></div>
<div style="position:absolute;left:84.62px;top:417.17px" class="cls_004"><span class="cls_004">when importing a path referring to a directory, Nix automatically appends</span><span class="cls_007"> /default.nix</span></div>
<div style="position:absolute;left:84.62px;top:429.12px" class="cls_004"><span class="cls_004">to the path.</span></div>
<div style="position:absolute;left:70.28px;top:452.03px" class="cls_056"><span class="cls_056">15</span></div>
<div style="position:absolute;left:84.62px;top:450.04px" class="cls_004"><span class="cls_004">This is where the actual composition takes place. Here we call the function imported</span></div>
<div style="position:absolute;left:84.62px;top:461.99px" class="cls_004"><span class="cls_004">from</span><span class="cls_007"> ../applications/misc/hello</span><span class="cls_004"> with an attribute set containing the arguments that the</span></div>
<div style="position:absolute;left:84.62px;top:473.95px" class="cls_004"><span class="cls_004">function expects, namely</span><span class="cls_007"> fetchurl</span><span class="cls_004">,</span><span class="cls_007"> stdenv</span><span class="cls_004">, and</span><span class="cls_007"> perl</span><span class="cls_004">.  We use the inherit construct</span></div>
<div style="position:absolute;left:84.62px;top:485.90px" class="cls_004"><span class="cls_004">again to copy the attributes defined in the surrounding scope (we could also have</span></div>
<div style="position:absolute;left:84.62px;top:497.86px" class="cls_004"><span class="cls_004">written</span><span class="cls_007"> fetchurl = fetchurl;</span><span class="cls_004">, etc.). Note that Nix function arguments are not positional;</span></div>
<div style="position:absolute;left:84.62px;top:509.81px" class="cls_004"><span class="cls_004">Nix functions just expect an attribute set containing attributes corresponding to the</span></div>
<div style="position:absolute;left:84.62px;top:521.77px" class="cls_004"><span class="cls_004">declared (formal) arguments.</span></div>
<div style="position:absolute;left:84.62px;top:538.20px" class="cls_004"><span class="cls_004">The result of this function call is an actual derivation that can be built by Nix (since</span></div>
<div style="position:absolute;left:84.62px;top:550.16px" class="cls_004"><span class="cls_004">when we fill in the arguments of the function, what we get is its body, which is the</span></div>
<div style="position:absolute;left:84.62px;top:562.11px" class="cls_004"><span class="cls_004">call to</span><span class="cls_007"> stdenv.mkDerivation</span><span class="cls_004"> in Figure 2.6).</span></div>
<div style="position:absolute;left:70.28px;top:585.01px" class="cls_056"><span class="cls_056">16</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">Likewise, concrete instances of Perl,</span><span class="cls_007"> fetchurl</span><span class="cls_004">, and the standard environment are con-</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">30</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:25530px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background039.jpg" width=481 height=680></div>
<div style="position:absolute;left:338.48px;top:17.14px" class="cls_004"><span class="cls_004">2.2. Nix expressions</span></div>
<div style="position:absolute;left:88.78px;top:45.04px" class="cls_004"><span class="cls_004">structed by calling their functions with the appropriate arguments.</span></div>
<div style="position:absolute;left:88.78px;top:60.97px" class="cls_004"><span class="cls_004">The attribute</span><span class="cls_007"> fetchurl</span><span class="cls_004"> actually does not evaluate to a derivation, but to a function that</span></div>
<div style="position:absolute;left:88.78px;top:72.92px" class="cls_004"><span class="cls_004">takes arguments</span><span class="cls_007"> url</span><span class="cls_004"> and</span><span class="cls_007"> md5</span><span class="cls_004">, as seen in Figure 2.6. This is an example of partial</span></div>
<div style="position:absolute;left:88.78px;top:84.88px" class="cls_004"><span class="cls_004">parameterisation.</span></div>
<div style="position:absolute;left:73.84px;top:106.74px" class="cls_004"><span class="cls_004">Thus, the value bound to the</span><span class="cls_007"> hello</span><span class="cls_004"> attribute in Figure 2.8 represents a derivation of an</span></div>
<div style="position:absolute;left:63.87px;top:118.69px" class="cls_004"><span class="cls_004">instance of Hello, as well as of all its dependencies.</span></div>
<div style="position:absolute;left:73.84px;top:130.65px" class="cls_004"><span class="cls_004">Surprisingly, describing not just components but also compositions is not a common</span></div>
<div style="position:absolute;left:63.87px;top:142.60px" class="cls_004"><span class="cls_004">feature of the component description formalisms of deployment systems.  For instance,</span></div>
<div style="position:absolute;left:63.87px;top:154.56px" class="cls_004"><span class="cls_004">RPM spec files (see page 6) describe how to build components, but not how to build the</span></div>
<div style="position:absolute;left:63.87px;top:166.52px" class="cls_004"><span class="cls_004">dependencies—even though the dependencies can have a profound effect on the build re-</span></div>
<div style="position:absolute;left:63.87px;top:178.47px" class="cls_004"><span class="cls_004">sult. The actual composition is left implicit. Nominal dependency specifications are used</span></div>
<div style="position:absolute;left:63.87px;top:190.43px" class="cls_004"><span class="cls_004">to require the presence of certain dependencies, but as we have seen, nominal dependency</span></div>
<div style="position:absolute;left:63.87px;top:202.38px" class="cls_004"><span class="cls_004">specifications are insufficient. Formalisms such as RPM spec files therefore woefully un-</span></div>
<div style="position:absolute;left:63.87px;top:214.34px" class="cls_004"><span class="cls_004">derspecify components.  Only a full set of RPM spec files closed under the dependency</span></div>
<div style="position:absolute;left:63.87px;top:226.29px" class="cls_004"><span class="cls_004">relation fully describes a component build (disregarding, of course, the real possibility of</span></div>
<div style="position:absolute;left:63.87px;top:238.25px" class="cls_004"><span class="cls_004">undeclared dependencies and other environmental influences).</span></div>
<div style="position:absolute;left:63.87px;top:264.76px" class="cls_009"><span class="cls_009">A slightly more complex example</span><span class="cls_004">   Figure 2.9 shows a Nix expression that demonstrates</span></div>
<div style="position:absolute;left:63.87px;top:276.72px" class="cls_004"><span class="cls_004">some additional language features. It contains a function that produces Subversion com-</span></div>
<div style="position:absolute;left:63.87px;top:288.67px" class="cls_004"><span class="cls_004">ponents.  Subversion [31, 137] is a version management system [159, 180].  Subversion</span></div>
<div style="position:absolute;left:63.87px;top:300.63px" class="cls_004"><span class="cls_004">clients can access a central version management repository through various means: local</span></div>
<div style="position:absolute;left:63.87px;top:312.58px" class="cls_004"><span class="cls_004">file system access, WebDAV (an extension to HTTP to support authoring and version-</span></div>
<div style="position:absolute;left:63.87px;top:324.54px" class="cls_004"><span class="cls_004">ing [30]), and the specialised</span><span class="cls_007"> svnserve</span><span class="cls_004"> protocol. These various access methods lead to a</span></div>
<div style="position:absolute;left:63.87px;top:335.47px" class="cls_004"><span class="cls_004">number of optional features, which in turn lead to optional dependencies</span><span class="cls_012"><sup>5</sup></span><span class="cls_004">:</span></div>
<div style="position:absolute;left:78.82px;top:356.37px" class="cls_004"><span class="cls_004">• Subversion has two storage back-ends for repositories: one that uses a built-in file</span></div>
<div style="position:absolute;left:88.78px;top:368.33px" class="cls_004"><span class="cls_004">system based storage, and one that uses the external Berkeley DB embedded database</span></div>
<div style="position:absolute;left:88.78px;top:380.28px" class="cls_004"><span class="cls_004">library. Use of the latter back-end induces a dependency on the Berkeley DB com-</span></div>
<div style="position:absolute;left:88.78px;top:392.24px" class="cls_004"><span class="cls_004">ponent.</span></div>
<div style="position:absolute;left:78.82px;top:412.14px" class="cls_004"><span class="cls_004">• Subversion can build an Apache module that allows it to act as a WebDAV server for</span></div>
<div style="position:absolute;left:88.78px;top:424.10px" class="cls_004"><span class="cls_004">remote clients. This feature requires the Apache HTTPD server component.</span></div>
<div style="position:absolute;left:78.82px;top:444.00px" class="cls_004"><span class="cls_004">• Subversion can access remote WebDAV repositories over HTTP by default. If access</span></div>
<div style="position:absolute;left:88.78px;top:455.95px" class="cls_004"><span class="cls_004">over HTTPS (i.e., HTTP encrypted over the Secure Sockets Layer [76]) is desired,</span></div>
<div style="position:absolute;left:88.78px;top:467.91px" class="cls_004"><span class="cls_004">then it requires the OpenSSL cryptographic library component.</span></div>
<div style="position:absolute;left:78.82px;top:487.81px" class="cls_004"><span class="cls_004">• Data sent over HTTP connections can be compressed using the Zlib algorithm,</span></div>
<div style="position:absolute;left:88.78px;top:499.77px" class="cls_004"><span class="cls_004">which requires the Zlib library component.</span></div>
<div style="position:absolute;left:73.84px;top:519.65px" class="cls_004"><span class="cls_004">In other words, Subversion has quite a bit of build-time variability. Figure 2.9 shows</span></div>
<div style="position:absolute;left:63.87px;top:531.60px" class="cls_004"><span class="cls_004">how such variability can be expressed in the Nix expression language. For instance, the</span></div>
<div style="position:absolute;left:63.87px;top:543.56px" class="cls_004"><span class="cls_004">optional support for SSL encryption is expressed by giving the function a Boolean param-</span></div>
<div style="position:absolute;left:63.87px;top:555.51px" class="cls_004"><span class="cls_004">eter</span><span class="cls_007"> sslSupport</span><span class="cls_014"> </span><span class="cls_056">17</span><span class="cls_004"> that specifies whether to build a Subversion instance with SSL support.</span></div>
<div style="position:absolute;left:68.36px;top:574.65px" class="cls_013"><span class="cls_013"><sup>5</sup></span><span class="cls_014">There are actually even more dependencies than listed here, such as bindings for various languages. These</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">have been omitted to keep the example short.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">31</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:26220px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background040.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2. An Overview of Nix</span></div>
<div style="position:absolute;left:63.10px;top:49.95px" class="cls_015"><span class="cls_015">{ bdbSupport  ?  false</span></div>
<div style="position:absolute;left:63.10px;top:60.90px" class="cls_015"><span class="cls_015">, httpServer  ?  false</span></div>
<div style="position:absolute;left:63.10px;top:71.86px" class="cls_015"><span class="cls_015">, sslSupport  ?  false</span></div>
<div style="position:absolute;left:163.33px;top:68.60px" class="cls_056"><span class="cls_056">17</span></div>
<div style="position:absolute;left:63.10px;top:82.82px" class="cls_015"><span class="cls_015">, compressionSupport  ?  false</span></div>
<div style="position:absolute;left:63.10px;top:93.78px" class="cls_015"><span class="cls_015">, stdenv,  fetchurl</span></div>
<div style="position:absolute;left:63.10px;top:104.74px" class="cls_015"><span class="cls_015">, openssl  ?  null</span></div>
<div style="position:absolute;left:144.50px;top:101.48px" class="cls_056"><span class="cls_056">18</span><span class="cls_061"> </span><span class="cls_015">,  httpd  ?  null,  db4  ?  null,  expat,  zlib  ?  null</span></div>
<div style="position:absolute;left:63.10px;top:115.70px" class="cls_015"><span class="cls_015">}:</span></div>
<div style="position:absolute;left:63.10px;top:137.62px" class="cls_015"><span class="cls_015">assert  bdbSupport  ->  db4  !=  null;</span></div>
<div style="position:absolute;left:224.51px;top:134.35px" class="cls_056"><span class="cls_056">19</span></div>
<div style="position:absolute;left:63.10px;top:148.58px" class="cls_015"><span class="cls_015">assert  httpServer  ->  httpd  !=  null  &&  httpd.expat  ==  expat;</span></div>
<div style="position:absolute;left:346.87px;top:145.31px" class="cls_056"><span class="cls_056">20</span></div>
<div style="position:absolute;left:63.10px;top:159.53px" class="cls_015"><span class="cls_015">assert  sslSupport  ->  openssl  !=  null  &&</span></div>
<div style="position:absolute;left:72.52px;top:170.49px" class="cls_015"><span class="cls_015">(httpServer  ->  httpd.openssl  ==  openssl);</span></div>
<div style="position:absolute;left:63.10px;top:181.45px" class="cls_015"><span class="cls_015">assert  compressionSupport  ->  zlib  !=  null;</span></div>
<div style="position:absolute;left:63.10px;top:203.37px" class="cls_015"><span class="cls_015">stdenv.mkDerivation  {</span></div>
<div style="position:absolute;left:72.52px;top:214.33px" class="cls_015"><span class="cls_015">name  =  "subversion-1.2.1";</span></div>
<div style="position:absolute;left:72.52px;top:236.25px" class="cls_015"><span class="cls_015">builder  =  ./builder.sh;</span></div>
<div style="position:absolute;left:72.52px;top:247.21px" class="cls_015"><span class="cls_015">src  =  fetchurl  {</span></div>
<div style="position:absolute;left:81.93px;top:258.16px" class="cls_015"><span class="cls_015">url  =  </span><A HREF="http://subversion.tigris.org/downloads/subversion-1.2.1.tar.bz2;/">http://subversion.tigris.org/downloads/subversion-1.2.1.tar.bz2;</A> </div>
<div style="position:absolute;left:81.93px;top:269.12px" class="cls_015"><span class="cls_015">md5  =  "0b546195ca794c327c6830f2e88661f7";</span></div>
<div style="position:absolute;left:72.52px;top:280.08px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:72.52px;top:302.00px" class="cls_015"><span class="cls_015">openssl  =  if  sslSupport  then  openssl  else  null;</span></div>
<div style="position:absolute;left:299.81px;top:298.74px" class="cls_056"><span class="cls_056">21</span></div>
<div style="position:absolute;left:72.52px;top:312.96px" class="cls_015"><span class="cls_015">zlib  =  if  compressionSupport  then  zlib  else  null;</span></div>
<div style="position:absolute;left:72.52px;top:323.92px" class="cls_015"><span class="cls_015">httpd  =  if  httpServer  then  httpd  else  null;</span></div>
<div style="position:absolute;left:72.52px;top:334.88px" class="cls_015"><span class="cls_015">db4  =  if  bdbSupport  then  db4  else  null;</span></div>
<div style="position:absolute;left:72.52px;top:356.79px" class="cls_015"><span class="cls_015">inherit  expat  bdbSupport  httpServer  sslSupport;</span></div>
<div style="position:absolute;left:63.10px;top:367.75px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:59.72px;top:392.71px" class="cls_004"><span class="cls_004">Figure 2.9.:</span><span class="cls_007"> pkgs/applications/version-management/subversion/default.nix</span><span class="cls_004">: Nix expression</span></div>
<div style="position:absolute;left:108.42px;top:404.67px" class="cls_004"><span class="cls_004">for Subversion</span></div>
<div style="position:absolute;left:59.72px;top:433.89px" class="cls_004"><span class="cls_004">This is distinct from the passing of the actual OpenSSL dependency</span><span class="cls_014"> </span><span class="cls_056">18</span><span class="cls_004"> in order to separate</span></div>
<div style="position:absolute;left:59.72px;top:445.84px" class="cls_004"><span class="cls_004">logical features from the dependencies required to implement them, if any. Many features</span></div>
<div style="position:absolute;left:59.72px;top:457.80px" class="cls_004"><span class="cls_004">require no dependencies, or require multiple dependencies. The list of function arguments</span></div>
<div style="position:absolute;left:59.72px;top:469.76px" class="cls_004"><span class="cls_004">also shows the language feature of default arguments, which are arguments that may be</span></div>
<div style="position:absolute;left:59.72px;top:481.71px" class="cls_004"><span class="cls_004">omitted when the function is called. If they are omitted, the default is used instead.</span></div>
<div style="position:absolute;left:69.68px;top:493.67px" class="cls_004"><span class="cls_004">A call to the Subversion function (e.g., in</span><span class="cls_007"> all-packages-generic.nix</span><span class="cls_004">) to build a minimal</span></div>
<div style="position:absolute;left:59.72px;top:505.62px" class="cls_004"><span class="cls_004">Subversion component will look like this:</span></div>
<div style="position:absolute;left:84.62px;top:529.04px" class="cls_015"><span class="cls_015">subversion  =  (import  .../subversion)  {</span></div>
<div style="position:absolute;left:94.04px;top:540.00px" class="cls_015"><span class="cls_015">inherit  fetchurl  stdenv  expat;</span></div>
<div style="position:absolute;left:84.62px;top:550.96px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:59.72px;top:564.86px" class="cls_004"><span class="cls_004">On the other hand, the following call builds a full-featured Subversion component:</span></div>
<div style="position:absolute;left:84.62px;top:588.28px" class="cls_015"><span class="cls_015">subversion  =  (import  .../subversion)  {</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">32</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:26910px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background041.jpg" width=481 height=680></div>
<div style="position:absolute;left:338.48px;top:17.14px" class="cls_004"><span class="cls_004">2.2. Nix expressions</span></div>
<div style="position:absolute;left:98.19px;top:50.30px" class="cls_015"><span class="cls_015">inherit  fetchurl  stdenv  openssl  db4  expat  zlib;</span></div>
<div style="position:absolute;left:98.19px;top:61.25px" class="cls_015"><span class="cls_015">httpd  =  apacheHttpd;</span></div>
<div style="position:absolute;left:98.19px;top:72.21px" class="cls_015"><span class="cls_015">localServer  =  true;</span></div>
<div style="position:absolute;left:98.19px;top:83.17px" class="cls_015"><span class="cls_015">httpServer  =  true;</span></div>
<div style="position:absolute;left:98.19px;top:94.13px" class="cls_015"><span class="cls_015">sslSupport  =  true;</span></div>
<div style="position:absolute;left:98.19px;top:105.09px" class="cls_015"><span class="cls_015">compressionSupport  =  true;</span></div>
<div style="position:absolute;left:88.78px;top:116.05px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:73.84px;top:136.70px" class="cls_004"><span class="cls_004">There are some other language aspects worth noting in Figure 2.9. Assertions enable</span></div>
<div style="position:absolute;left:63.87px;top:148.65px" class="cls_004"><span class="cls_004">consistency checking between components and feature selections.  The assertion in</span><span class="cls_014"> </span><span class="cls_056">19</span></div>
<div style="position:absolute;left:63.87px;top:160.61px" class="cls_004"><span class="cls_004">verifies that if Berkeley DB support is requested, the</span><span class="cls_007"> db4</span><span class="cls_004"> dependency should not be</span><span class="cls_007"> null</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:172.56px" class="cls_004"><span class="cls_004">The value</span><span class="cls_007"> null</span><span class="cls_004"> is a special constant that allows components to be omitted, which would be</span></div>
<div style="position:absolute;left:63.87px;top:184.52px" class="cls_004"><span class="cls_004">wrong here. Note that the default for the</span><span class="cls_007"> db4</span><span class="cls_004"> argument is in fact</span><span class="cls_007"> null</span><span class="cls_004">, which is appropriate</span></div>
<div style="position:absolute;left:63.87px;top:196.47px" class="cls_004"><span class="cls_004">for</span><span class="cls_007"> bdbSupport</span><span class="cls_004">’s default of</span><span class="cls_007"> false</span><span class="cls_004">. But if the function is called with</span><span class="cls_007"> bdbSupport</span><span class="cls_004"> set to</span><span class="cls_007"> true</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:63.87px;top:208.43px" class="cls_004"><span class="cls_004">then the assertion protects the user against forgetting to specify the</span><span class="cls_007"> db4</span><span class="cls_004"> parameter.</span></div>
<div style="position:absolute;left:73.84px;top:222.37px" class="cls_004"><span class="cls_004">The next two assertions</span><span class="cls_014"> </span><span class="cls_056">20</span><span class="cls_004"> express consistency requirements between components. The</span></div>
<div style="position:absolute;left:63.87px;top:234.33px" class="cls_004"><span class="cls_004">first one states that if the Apache WebDAV module is to be built, then Apache’s</span><span class="cls_007"> expat</span></div>
<div style="position:absolute;left:63.87px;top:246.28px" class="cls_004"><span class="cls_004">dependency (Expat is an XML parsing library) should be exactly equal to Subversion’s</span></div>
<div style="position:absolute;left:63.87px;top:258.24px" class="cls_007"><span class="cls_007">expat</span><span class="cls_004"> dependency, where “exactly equal” means that they should be in the same store path.</span></div>
<div style="position:absolute;left:63.87px;top:270.20px" class="cls_004"><span class="cls_004">This is because the dynamic libraries of Apache and Subversion will end up being linked</span></div>
<div style="position:absolute;left:63.87px;top:282.15px" class="cls_004"><span class="cls_004">against each other. If both bring in different instances of Expat, a runtime link error will</span></div>
<div style="position:absolute;left:63.87px;top:294.11px" class="cls_004"><span class="cls_004">ensue.  Hence the requirement that both Expats are to be the same.  Likewise, if SSL</span></div>
<div style="position:absolute;left:63.87px;top:306.06px" class="cls_004"><span class="cls_004">and WebDAV support are enabled, Apache and Subversion should use the same OpenSSL</span></div>
<div style="position:absolute;left:63.87px;top:318.02px" class="cls_004"><span class="cls_004">libraries.</span></div>
<div style="position:absolute;left:73.84px;top:331.96px" class="cls_004"><span class="cls_004">As in the Hello example, the dependencies must be passed to the build script. But we</span></div>
<div style="position:absolute;left:63.87px;top:343.92px" class="cls_004"><span class="cls_004">only pass the optional dependencies if their corresponding features are enabled</span><span class="cls_014"> </span><span class="cls_056">21</span><span class="cls_059"> </span><span class="cls_004">. If they</span></div>
<div style="position:absolute;left:63.87px;top:355.87px" class="cls_004"><span class="cls_004">are disabled, the value</span><span class="cls_007"> null</span><span class="cls_004"> is passed to the builder (</span><span class="cls_007">null</span><span class="cls_004"> corresponds to an empty string in</span></div>
<div style="position:absolute;left:63.87px;top:367.83px" class="cls_004"><span class="cls_004">the environment variables). This is to relieve the programmer from having to figure out</span></div>
<div style="position:absolute;left:63.87px;top:379.78px" class="cls_004"><span class="cls_004">at the call site what specific dependencies should be passed for a given feature selection.</span></div>
<div style="position:absolute;left:63.87px;top:391.74px" class="cls_004"><span class="cls_004">After all, that would break abstraction—such decisions should be made by the component’s</span></div>
<div style="position:absolute;left:63.87px;top:403.69px" class="cls_004"><span class="cls_004">Nix expression, not by the caller. Thus, the caller can always pass all dependencies, and</span></div>
<div style="position:absolute;left:63.87px;top:415.65px" class="cls_004"><span class="cls_004">the component’s Nix expression will figure out what dependencies to use. As we will see</span></div>
<div style="position:absolute;left:63.87px;top:427.60px" class="cls_004"><span class="cls_004">in Section 4.1 (page 62), unused dependencies will not be evaluated, let alone be built,</span></div>
<div style="position:absolute;left:63.87px;top:439.56px" class="cls_004"><span class="cls_004">due to the fact that Nix expressions are a lazy language (values are only computed when</span></div>
<div style="position:absolute;left:63.87px;top:451.52px" class="cls_004"><span class="cls_004">needed).</span></div>
<div style="position:absolute;left:73.84px;top:465.46px" class="cls_004"><span class="cls_004">Figure 2.10 shows the builder for the Subversion component, just to give an idea of what</span></div>
<div style="position:absolute;left:63.87px;top:477.42px" class="cls_004"><span class="cls_004">is involved in getting a non-trivial piece of software to work in Nix. This builder is at a</span></div>
<div style="position:absolute;left:63.87px;top:489.37px" class="cls_004"><span class="cls_004">higher level than the one we have seen previously for Hello (Figure 2.7), as it uses the</span></div>
<div style="position:absolute;left:63.87px;top:501.33px" class="cls_004"><span class="cls_004">generic builder, which is a shell function defined by the standard environment that takes</span></div>
<div style="position:absolute;left:63.87px;top:513.28px" class="cls_004"><span class="cls_004">care of building most Unix components with little or no customisation. Most modern Unix</span></div>
<div style="position:absolute;left:63.87px;top:525.24px" class="cls_004"><span class="cls_004">software has a standard build interface consisting of the following sequence of commands:</span></div>
<div style="position:absolute;left:88.78px;top:555.40px" class="cls_015"><span class="cls_015">tar  xvf  ...sources.tar</span></div>
<div style="position:absolute;left:88.78px;top:566.36px" class="cls_015"><span class="cls_015">./configure</span></div>
<div style="position:absolute;left:88.78px;top:577.32px" class="cls_015"><span class="cls_015">make</span></div>
<div style="position:absolute;left:88.78px;top:588.28px" class="cls_015"><span class="cls_015">make  install</span></div>
<div style="position:absolute;left:412.21px;top:624.86px" class="cls_004"><span class="cls_004">33</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:27600px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background042.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2. An Overview of Nix</span></div>
<div style="position:absolute;left:63.10px;top:50.61px" class="cls_015"><span class="cls_015">buildInputs="$openssl  $zlib  $db4</span></div>
<div style="position:absolute;left:218.41px;top:50.61px" class="cls_015"><span class="cls_015">$httpd  $expat"</span></div>
<div style="position:absolute;left:290.40px;top:47.34px" class="cls_056"><span class="cls_056">22</span></div>
<div style="position:absolute;left:63.10px;top:61.57px" class="cls_015"><span class="cls_015">source  $stdenv/setup</span></div>
<div style="position:absolute;left:63.10px;top:83.48px" class="cls_015"><span class="cls_015">configureFlags="--without-gdbm  --disable-static"</span></div>
<div style="position:absolute;left:63.10px;top:105.40px" class="cls_015"><span class="cls_015">if  test  "$bdbSupport";  then</span></div>
<div style="position:absolute;left:196.27px;top:102.14px" class="cls_056"><span class="cls_056">23</span></div>
<div style="position:absolute;left:81.93px;top:116.36px" class="cls_015"><span class="cls_015">configureFlags="--with-berkeley-db=$db4</span></div>
<div style="position:absolute;left:270.18px;top:116.36px" class="cls_015"><span class="cls_015">$configureFlags"</span></div>
<div style="position:absolute;left:63.10px;top:127.32px" class="cls_015"><span class="cls_015">fi</span></div>
<div style="position:absolute;left:63.10px;top:149.24px" class="cls_015"><span class="cls_015">if  test  "$sslSupport";  then</span></div>
<div style="position:absolute;left:81.93px;top:160.20px" class="cls_015"><span class="cls_015">configureFlags="--with-ssl  --with-libs=$openssl  $configureFlags"</span></div>
<div style="position:absolute;left:63.10px;top:171.15px" class="cls_015"><span class="cls_015">fi</span></div>
<div style="position:absolute;left:63.10px;top:193.07px" class="cls_015"><span class="cls_015">if  test  "$httpServer";  then</span></div>
<div style="position:absolute;left:81.93px;top:204.03px" class="cls_015"><span class="cls_015">configureFlags="--with-apxs=$httpd/bin/apxs  --with-apr=$httpd  ..."</span></div>
<div style="position:absolute;left:81.93px;top:214.99px" class="cls_015"><span class="cls_015">makeFlags="APACHE_LIBEXECDIR=$out/modules  $makeFlags"</span></div>
<div style="position:absolute;left:63.10px;top:225.95px" class="cls_015"><span class="cls_015">else</span></div>
<div style="position:absolute;left:81.93px;top:236.91px" class="cls_015"><span class="cls_015">configureFlags="--without-apxs  $configureFlags"</span></div>
<div style="position:absolute;left:63.10px;top:247.87px" class="cls_015"><span class="cls_015">fi</span></div>
<div style="position:absolute;left:63.10px;top:269.78px" class="cls_015"><span class="cls_015">installFlags="$makeFlags"</span></div>
<div style="position:absolute;left:63.10px;top:291.70px" class="cls_015"><span class="cls_015">genericBuild</span></div>
<div style="position:absolute;left:125.68px;top:288.44px" class="cls_056"><span class="cls_056">24</span></div>
<div style="position:absolute;left:59.72px;top:317.91px" class="cls_004"><span class="cls_004">Figure 2.10.:</span><span class="cls_007"> pkgs/applications/version-management/subversion/builder.sh</span><span class="cls_004">:   Builder</span></div>
<div style="position:absolute;left:406.40px;top:317.91px" class="cls_004"><span class="cls_004">for</span></div>
<div style="position:absolute;left:113.40px;top:329.86px" class="cls_004"><span class="cls_004">Subversion</span></div>
<div style="position:absolute;left:59.72px;top:359.78px" class="cls_004"><span class="cls_004">This is in essence what the generic builder does. For many components, a simple call</span><span class="cls_014"> </span><span class="cls_056">24</span><span class="cls_004"> to</span></div>
<div style="position:absolute;left:59.72px;top:371.73px" class="cls_004"><span class="cls_004">the generic builder suffices. The generic builder is discussed in more detail in Section 7.1.2.</span></div>
<div style="position:absolute;left:69.68px;top:383.69px" class="cls_004"><span class="cls_004">So the effort to build Subversion is quite modest: it is a matter of calling Subversion’s</span></div>
<div style="position:absolute;left:59.72px;top:395.64px" class="cls_007"><span class="cls_007">configure</span><span class="cls_004"> script with the appropriate flags to tell it where it can find the dependencies. For</span></div>
<div style="position:absolute;left:59.72px;top:407.60px" class="cls_004"><span class="cls_004">instance, the configure flags to enable and locate Berkeley DB are set in</span><span class="cls_014"> </span><span class="cls_056">23</span><span class="cls_059"> </span><span class="cls_004">.  Actually,</span></div>
<div style="position:absolute;left:59.72px;top:419.55px" class="cls_004"><span class="cls_004">following the Autoconf philosophy of auto-detecting system capabilities, some of the op-</span></div>
<div style="position:absolute;left:59.72px;top:431.51px" class="cls_004"><span class="cls_004">tional features are enabled automatically if the corresponding dependency is found. For</span></div>
<div style="position:absolute;left:59.72px;top:443.46px" class="cls_004"><span class="cls_004">example, Zlib compression support is enabled automatically if</span><span class="cls_007"> configure</span><span class="cls_004"> finds Zlib in the</span></div>
<div style="position:absolute;left:59.72px;top:455.42px" class="cls_004"><span class="cls_004">compiler and linker search path. The variable</span><span class="cls_007"> buildInputs</span><span class="cls_004"> contains a list of components that</span></div>
<div style="position:absolute;left:59.72px;top:467.37px" class="cls_004"><span class="cls_004">should be added to such search paths; thus all components added in</span><span class="cls_014"> </span><span class="cls_056">22</span><span class="cls_004"> are in the scope of</span></div>
<div style="position:absolute;left:59.72px;top:479.33px" class="cls_004"><span class="cls_004">the compiler and linker.</span></div>
<div style="position:absolute;left:69.68px;top:491.28px" class="cls_004"><span class="cls_004">This concludes the brief overview of the Nix expression language. Chapter 4 provides a</span></div>
<div style="position:absolute;left:59.72px;top:503.24px" class="cls_004"><span class="cls_004">more in-depth discussion of the syntax and semantics of the language.</span></div>
<div style="position:absolute;left:59.72px;top:533.90px" class="cls_011"><span class="cls_011">2.3. Package management</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_009"><span class="cls_009">Installing</span><span class="cls_004">   Now that we have written Nix expressions for Hello, we want to build and</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">install the component. That is, we want to reach a state where the Hello component is in</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">some way “available” to the user. In a Unix system, this means that the application should</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">34</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:28290px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background043.jpg" width=481 height=680></div>
<div style="position:absolute;left:315.80px;top:17.14px" class="cls_004"><span class="cls_004">2.3. Package management</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">be in the user’s search path:</span></div>
<div style="position:absolute;left:88.78px;top:68.94px" class="cls_015"><span class="cls_015">$ hello</span></div>
<div style="position:absolute;left:88.78px;top:79.90px" class="cls_015"><span class="cls_015">Hello,  world!</span></div>
<div style="position:absolute;left:63.87px;top:94.29px" class="cls_004"><span class="cls_004">while in different settings it might mean that the application becomes available as an icon</span></div>
<div style="position:absolute;left:63.87px;top:106.24px" class="cls_004"><span class="cls_004">on the desktop, or as a menu item in the Start Menu.</span></div>
<div style="position:absolute;left:73.84px;top:118.20px" class="cls_004"><span class="cls_004">On Unix, operations such as installation, upgrading, and uninstallation are performed</span></div>
<div style="position:absolute;left:63.87px;top:130.15px" class="cls_004"><span class="cls_004">through the command</span><span class="cls_007"> nix-env</span><span class="cls_004">, which manipulates so-called user environments—the views</span></div>
<div style="position:absolute;left:63.87px;top:142.11px" class="cls_004"><span class="cls_004">on “available” components (discussed below on page 36). For instance,</span></div>
<div style="position:absolute;left:88.78px;top:166.01px" class="cls_015"><span class="cls_015">$ nix-env  -f  .../all-packages.nix  -i  hello</span></div>
<div style="position:absolute;left:88.78px;top:176.97px" class="cls_015"><span class="cls_015">installing  `hello-2.1.1'</span></div>
<div style="position:absolute;left:63.87px;top:191.36px" class="cls_004"><span class="cls_004">evaluates the Nix expression in</span><span class="cls_007"> all-packages.nix</span><span class="cls_004">, looks for a derivation with symbolic name</span></div>
<div style="position:absolute;left:63.87px;top:203.31px" class="cls_007"><span class="cls_007">hello</span><span class="cls_004">, builds the derivation, and makes the result available to the user. The building of the</span></div>
<div style="position:absolute;left:63.87px;top:215.27px" class="cls_004"><span class="cls_004">derivation is a recursive process: Nix will first build the dependencies of Hello, which</span></div>
<div style="position:absolute;left:63.87px;top:227.22px" class="cls_004"><span class="cls_004">entails building their dependencies, and so on.  However, if a derivation has been built</span></div>
<div style="position:absolute;left:63.87px;top:239.18px" class="cls_004"><span class="cls_004">previously, it will not be rebuilt.</span></div>
<div style="position:absolute;left:63.87px;top:265.64px" class="cls_009"><span class="cls_009">Queries</span><span class="cls_004">   It is of course possible to query the set of installed components:</span></div>
<div style="position:absolute;left:88.78px;top:289.54px" class="cls_015"><span class="cls_015">$ nix-env  -q</span></div>
<div style="position:absolute;left:88.78px;top:300.50px" class="cls_015"><span class="cls_015">hello-2.1.1</span></div>
<div style="position:absolute;left:63.87px;top:314.89px" class="cls_004"><span class="cls_004">This query prints the set of components in the current user environment. Likewise, it is</span></div>
<div style="position:absolute;left:63.87px;top:326.84px" class="cls_004"><span class="cls_004">possible to query which components are available for installation in a Nix expression:</span></div>
<div style="position:absolute;left:88.78px;top:350.74px" class="cls_015"><span class="cls_015">$ nix-env  -f  .../all-packages.nix  -qa</span></div>
<div style="position:absolute;left:88.78px;top:361.70px" class="cls_015"><span class="cls_015">a52dec-0.7.4</span></div>
<div style="position:absolute;left:88.78px;top:372.66px" class="cls_015"><span class="cls_015">acrobat-reader-7.0</span></div>
<div style="position:absolute;left:88.78px;top:383.62px" class="cls_015"><span class="cls_015">alsa-lib-1.0.9</span></div>
<div style="position:absolute;left:88.78px;top:394.58px" class="cls_015"><span class="cls_015">ant-blackdown-1.4.2</span></div>
<div style="position:absolute;left:88.78px;top:405.54px" class="cls_015"><span class="cls_015">ant-j2sdk-1.4.2</span></div>
<div style="position:absolute;left:88.78px;top:416.50px" class="cls_015"><span class="cls_015">ant-j2sdk-1.5.0</span></div>
<div style="position:absolute;left:63.87px;top:441.84px" class="cls_004"><span class="cls_004">It is usually not convenient to specify the Nix expression all the time. Therefore it is possi-</span></div>
<div style="position:absolute;left:63.87px;top:453.80px" class="cls_004"><span class="cls_004">ble to specify a specific Nix expression as the default for package management operations:</span></div>
<div style="position:absolute;left:88.78px;top:477.70px" class="cls_015"><span class="cls_015">$ nix-env  -I  .../all-packages.nix</span></div>
<div style="position:absolute;left:63.87px;top:492.09px" class="cls_004"><span class="cls_004">All subsequent</span><span class="cls_007"> nix-env</span><span class="cls_004"> invocations will then use this file if no expression is explicitly</span></div>
<div style="position:absolute;left:63.87px;top:504.04px" class="cls_004"><span class="cls_004">specified.</span></div>
<div style="position:absolute;left:63.87px;top:530.50px" class="cls_009"><span class="cls_009">Upgrades and rollbacks</span><span class="cls_004">   When a new version of the set of Nix expressions that contains</span></div>
<div style="position:absolute;left:63.87px;top:542.46px" class="cls_004"><span class="cls_004">Hello comes along, we can upgrade the installed Hello:</span></div>
<div style="position:absolute;left:88.78px;top:566.36px" class="cls_015"><span class="cls_015">$ hello  -v</span></div>
<div style="position:absolute;left:88.78px;top:577.32px" class="cls_015"><span class="cls_015">hello  -  GNU  hello  2.1.1</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">35</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:28980px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background044.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2. An Overview of Nix</span></div>
<div style="position:absolute;left:84.62px;top:50.30px" class="cls_015"><span class="cls_015">$ nix-env  -f  .../all-packages.nix  -i  hello</span></div>
<div style="position:absolute;left:84.62px;top:61.25px" class="cls_015"><span class="cls_015">upgrading  `hello-2.1.1'  to  `hello-2.1.2'</span></div>
<div style="position:absolute;left:84.62px;top:83.17px" class="cls_015"><span class="cls_015">$ hello  -v</span></div>
<div style="position:absolute;left:84.62px;top:94.13px" class="cls_015"><span class="cls_015">hello  -  GNU  hello  2.1.2</span></div>
<div style="position:absolute;left:69.68px;top:108.25px" class="cls_004"><span class="cls_004">This is standard procedure for a package management system, completely analogous to,</span></div>
<div style="position:absolute;left:59.72px;top:120.21px" class="cls_004"><span class="cls_004">e.g.,</span><span class="cls_007"> rpm -i hello</span><span class="cls_004"> and</span><span class="cls_007"> rpm -U hello</span><span class="cls_004">. However, if it turns out that the new version of Hello</span></div>
<div style="position:absolute;left:59.72px;top:132.16px" class="cls_004"><span class="cls_004">does not meet our requirements, we can roll back to the previous version:</span></div>
<div style="position:absolute;left:84.62px;top:155.80px" class="cls_015"><span class="cls_015">$ nix-env  --rollback</span></div>
<div style="position:absolute;left:84.62px;top:177.71px" class="cls_015"><span class="cls_015">$ hello  -v</span></div>
<div style="position:absolute;left:84.62px;top:188.67px" class="cls_015"><span class="cls_015">hello  -  GNU  hello  2.1.1</span></div>
<div style="position:absolute;left:69.68px;top:202.79px" class="cls_004"><span class="cls_004">The reason that this is possible is that the new version of Hello resides in a different path</span></div>
<div style="position:absolute;left:59.72px;top:214.75px" class="cls_004"><span class="cls_004">in the Nix store, since at least some inputs of the build process of the new Hello must be</span></div>
<div style="position:absolute;left:59.72px;top:226.70px" class="cls_004"><span class="cls_004">different (e.g., its sources and its</span><span class="cls_007"> name</span><span class="cls_004"> attribute). The old one is still there. There is no</span></div>
<div style="position:absolute;left:59.72px;top:238.66px" class="cls_004"><span class="cls_004">destructive upgrading: in the purely functional model, components never change after they</span></div>
<div style="position:absolute;left:59.72px;top:250.61px" class="cls_004"><span class="cls_004">have been built.</span></div>
<div style="position:absolute;left:59.72px;top:277.02px" class="cls_009"><span class="cls_009">User environments</span><span class="cls_004">   User environments are Nix’s mechanism for allowing different users</span></div>
<div style="position:absolute;left:59.72px;top:288.97px" class="cls_004"><span class="cls_004">to have different configurations, and to do atomic upgrades and rollbacks. Clearly, we want</span></div>
<div style="position:absolute;left:59.72px;top:300.93px" class="cls_004"><span class="cls_004">to abstract over store paths; it would not do for users to have to type</span></div>
<div style="position:absolute;left:84.62px;top:324.56px" class="cls_015"><span class="cls_015">$ /nix/store/dpmvp969yhdq...-subversion-1.1.3/bin/svn</span></div>
<div style="position:absolute;left:59.72px;top:338.68px" class="cls_004"><span class="cls_004">to start a program.</span></div>
<div style="position:absolute;left:69.68px;top:350.64px" class="cls_004"><span class="cls_004">Of course we could set up the</span><span class="cls_007"> PATH</span><span class="cls_004"> environment variable to include the</span><span class="cls_007"> bin</span><span class="cls_004"> direc-</span></div>
<div style="position:absolute;left:59.72px;top:362.59px" class="cls_004"><span class="cls_004">tory of every component we want to use, but this is not very convenient since changing</span></div>
<div style="position:absolute;left:59.72px;top:374.55px" class="cls_007"><span class="cls_007">PATH</span><span class="cls_004"> doesn’t take effect for already existing processes. The solution Nix uses is to cre-</span></div>
<div style="position:absolute;left:59.72px;top:386.50px" class="cls_004"><span class="cls_004">ate directory trees of symlinks to activated components (similar to systems such as GNU</span></div>
<div style="position:absolute;left:59.72px;top:397.43px" class="cls_004"><span class="cls_004">Stow [78])</span><span class="cls_012"><sup>6</sup></span><span class="cls_004">.  These are called user environments and they are components themselves</span></div>
<div style="position:absolute;left:59.72px;top:410.41px" class="cls_004"><span class="cls_004">(though automatically generated by</span><span class="cls_007"> nix-env</span><span class="cls_004">), so they too reside in the Nix store. In Fig-</span></div>
<div style="position:absolute;left:59.72px;top:422.37px" class="cls_004"><span class="cls_004">ure 2.11 the user environment</span><span class="cls_007"> /nix/store/0c1p5z4kda11...-user-env</span><span class="cls_004"> contains a symlink to</span></div>
<div style="position:absolute;left:59.72px;top:434.32px" class="cls_004"><span class="cls_004">just Subversion 1.1.2 (dashed arrows in the figure indicate symlinks).  This is what we</span></div>
<div style="position:absolute;left:59.72px;top:446.28px" class="cls_004"><span class="cls_004">would have obtained if we had performed</span></div>
<div style="position:absolute;left:84.62px;top:469.91px" class="cls_015"><span class="cls_015">$ nix-env  -i  subversion</span></div>
<div style="position:absolute;left:59.72px;top:484.03px" class="cls_004"><span class="cls_004">on a set of Nix expressions that contained Subversion 1.1.2.</span></div>
<div style="position:absolute;left:69.68px;top:495.99px" class="cls_004"><span class="cls_004">This does not in itself solve the problem, of course; a user would not want to type</span></div>
<div style="position:absolute;left:59.72px;top:507.94px" class="cls_007"><span class="cls_007">/nix/store/0c1p5z4kda11...-user-env/bin/svn</span><span class="cls_004"> either. This is why there are symlinks outside</span></div>
<div style="position:absolute;left:59.72px;top:519.90px" class="cls_004"><span class="cls_004">of the store that point to the user environments in the store, e.g., the symlinks</span><span class="cls_007"> default-42-</span></div>
<div style="position:absolute;left:59.72px;top:531.85px" class="cls_007"><span class="cls_007">link</span><span class="cls_004"> and</span><span class="cls_007"> default-43-link</span><span class="cls_004"> in the example. These are called generations since whenever one</span></div>
<div style="position:absolute;left:59.72px;top:543.81px" class="cls_004"><span class="cls_004">performs a</span><span class="cls_007"> nix-env</span><span class="cls_004"> operation, a new user environment is generated based on the current</span></div>
<div style="position:absolute;left:59.72px;top:555.76px" class="cls_004"><span class="cls_004">one. For instance, generation 43 was created from generation 42 when the user executed</span></div>
<div style="position:absolute;left:64.20px;top:574.65px" class="cls_013"><span class="cls_013"><sup>6</sup></span><span class="cls_014">While this approach is rather Unix-specific, user environments can be implemented in many other ways, as is</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">discussed in Section 7.2.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">36</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:29670px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background045.jpg" width=481 height=680></div>
<div style="position:absolute;left:315.80px;top:17.14px" class="cls_004"><span class="cls_004">2.3. Package management</span></div>
<div style="position:absolute;left:65.91px;top:44.26px" class="cls_032"><span class="cls_032">PATH=~/.nix-profile/bin</span></div>
<div style="position:absolute;left:176.03px;top:44.26px" class="cls_032"><span class="cls_032">/nix/var/nix/profiles</span></div>
<div style="position:absolute;left:282.44px;top:44.26px" class="cls_032"><span class="cls_032">/nix/store</span></div>
<div style="position:absolute;left:188.23px;top:56.45px" class="cls_032"><span class="cls_032">default</span></div>
<div style="position:absolute;left:294.66px;top:56.45px" class="cls_032"><span class="cls_032">0c1p5z4kda11...-user-env</span></div>
<div style="position:absolute;left:100.45px;top:68.64px" class="cls_032"><span class="cls_032">/home/alice</span></div>
<div style="position:absolute;left:306.86px;top:68.64px" class="cls_032"><span class="cls_032">bin</span></div>
<div style="position:absolute;left:112.64px;top:80.84px" class="cls_032"><span class="cls_032">.nix-profile</span></div>
<div style="position:absolute;left:188.23px;top:80.84px" class="cls_032"><span class="cls_032">default-42-link</span></div>
<div style="position:absolute;left:319.05px;top:80.84px" class="cls_032"><span class="cls_032">svn</span></div>
<div style="position:absolute;left:182.27px;top:91.13px" class="cls_033"><span class="cls_033">switch</span></div>
<div style="position:absolute;left:294.53px;top:93.03px" class="cls_032"><span class="cls_032">3aw2pdyx2jfc...-user-env</span></div>
<div style="position:absolute;left:100.85px;top:105.22px" class="cls_032"><span class="cls_032">/home/bob</span></div>
<div style="position:absolute;left:188.23px;top:105.22px" class="cls_032"><span class="cls_032">default-43-link</span></div>
<div style="position:absolute;left:306.86px;top:105.22px" class="cls_032"><span class="cls_032">bin</span></div>
<div style="position:absolute;left:113.05px;top:117.41px" class="cls_032"><span class="cls_032">.nix-profile</span></div>
<div style="position:absolute;left:319.01px;top:117.41px" class="cls_032"><span class="cls_032">firefox</span></div>
<div style="position:absolute;left:188.23px;top:129.26px" class="cls_032"><span class="cls_032">carol</span></div>
<div style="position:absolute;left:319.01px;top:129.60px" class="cls_032"><span class="cls_032">svn</span></div>
<div style="position:absolute;left:100.85px;top:141.79px" class="cls_032"><span class="cls_032">/home/carol</span></div>
<div style="position:absolute;left:294.70px;top:141.79px" class="cls_032"><span class="cls_032">5mq2jcn36ldl...-subversion-1.1.2</span></div>
<div style="position:absolute;left:113.05px;top:153.98px" class="cls_032"><span class="cls_032">.nix-profile</span></div>
<div style="position:absolute;left:188.23px;top:153.65px" class="cls_032"><span class="cls_032">carol-23-link</span></div>
<div style="position:absolute;left:306.86px;top:153.98px" class="cls_032"><span class="cls_032">bin</span></div>
<div style="position:absolute;left:319.05px;top:166.18px" class="cls_032"><span class="cls_032">svn</span></div>
<div style="position:absolute;left:294.66px;top:178.37px" class="cls_032"><span class="cls_032">dpmvp969yhdq...-subversion-1.1.3</span></div>
<div style="position:absolute;left:306.82px;top:190.56px" class="cls_032"><span class="cls_032">bin</span></div>
<div style="position:absolute;left:319.01px;top:202.75px" class="cls_032"><span class="cls_032">svn</span></div>
<div style="position:absolute;left:294.12px;top:214.94px" class="cls_032"><span class="cls_032">g32imf68vvbw...-firefox-1.0.1</span></div>
<div style="position:absolute;left:306.31px;top:227.13px" class="cls_032"><span class="cls_032">bin</span></div>
<div style="position:absolute;left:319.01px;top:239.32px" class="cls_032"><span class="cls_032">firefox</span></div>
<div style="position:absolute;left:178.61px;top:264.25px" class="cls_004"><span class="cls_004">Figure 2.11.: User environments</span></div>
<div style="position:absolute;left:88.78px;top:303.15px" class="cls_015"><span class="cls_015">$ nix-env  -i  subversion  firefox</span></div>
<div style="position:absolute;left:63.87px;top:320.21px" class="cls_004"><span class="cls_004">on a set of Nix expressions that contained Firefox and a new version of Subversion.</span></div>
<div style="position:absolute;left:73.84px;top:332.96px" class="cls_004"><span class="cls_004">Generations are grouped together into profiles so that different users don’t interfere with</span></div>
<div style="position:absolute;left:63.87px;top:344.91px" class="cls_004"><span class="cls_004">each other (unless they share a profile). For example, the links</span><span class="cls_007"> default-42-link</span><span class="cls_004"> and</span><span class="cls_007"> default-</span></div>
<div style="position:absolute;left:63.87px;top:356.87px" class="cls_007"><span class="cls_007">43-link</span><span class="cls_004"> are part of the profile called</span><span class="cls_007"> default</span><span class="cls_004">. The file</span><span class="cls_007"> default</span><span class="cls_004"> itself is a symlink that points</span></div>
<div style="position:absolute;left:63.87px;top:368.82px" class="cls_004"><span class="cls_004">to the current generation. When we perform a</span><span class="cls_007"> nix-env</span><span class="cls_004"> operation, a new user environment</span></div>
<div style="position:absolute;left:63.87px;top:380.78px" class="cls_004"><span class="cls_004">and generation link are created based on the current one, and finally the</span><span class="cls_007"> default</span><span class="cls_004"> symlink is</span></div>
<div style="position:absolute;left:63.87px;top:392.73px" class="cls_004"><span class="cls_004">made to point at the new generation.</span></div>
<div style="position:absolute;left:73.84px;top:405.49px" class="cls_004"><span class="cls_004">Upgrades are atomic. This means that a user can never observe that an upgrade is “half-</span></div>
<div style="position:absolute;left:63.87px;top:417.44px" class="cls_004"><span class="cls_004">way through”; the user either sees all the components of the old user environment, or all the</span></div>
<div style="position:absolute;left:63.87px;top:429.40px" class="cls_004"><span class="cls_004">components of the new user environment. This is a major improvement over most deploy-</span></div>
<div style="position:absolute;left:63.87px;top:441.35px" class="cls_004"><span class="cls_004">ment systems which work by destructive upgrading. Due to the purely functional model,</span></div>
<div style="position:absolute;left:63.87px;top:453.31px" class="cls_004"><span class="cls_004">as we are building new components (including user environments, which are components</span></div>
<div style="position:absolute;left:63.87px;top:465.26px" class="cls_004"><span class="cls_004">also), the components in the user’s current user environment are left entirely untouched.</span></div>
<div style="position:absolute;left:63.87px;top:477.22px" class="cls_004"><span class="cls_004">They are not in any way changed.  The last step in the upgrade—switching the current</span></div>
<div style="position:absolute;left:63.87px;top:489.17px" class="cls_004"><span class="cls_004">generation symlink—can be performed in an atomic action on Unix.</span></div>
<div style="position:absolute;left:73.84px;top:501.93px" class="cls_004"><span class="cls_004">Different users can have different profiles. The user’s current profile is pointed to by the</span></div>
<div style="position:absolute;left:63.87px;top:513.88px" class="cls_004"><span class="cls_004">symlink</span><span class="cls_007"> ~/.nix-profile</span><span class="cls_004"> (where</span><span class="cls_007"> ~</span><span class="cls_004"> denotes the user’s home directory). Putting the directory</span></div>
<div style="position:absolute;left:63.87px;top:525.84px" class="cls_007"><span class="cls_007">~/.nix-profile/bin</span><span class="cls_004"> in the user’s</span><span class="cls_007"> PATH</span><span class="cls_004"> environment variables completes the user environments</span></div>
<div style="position:absolute;left:63.87px;top:537.79px" class="cls_004"><span class="cls_004">picture (Figure 2.11), for if we now resolve the chain of symlinks from</span><span class="cls_007"> ~/.nix-profile/bin</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:63.87px;top:549.75px" class="cls_004"><span class="cls_004">we eventually end up in the</span><span class="cls_007"> bin</span><span class="cls_004"> directory of the current user environment, which in turn</span></div>
<div style="position:absolute;left:63.87px;top:561.70px" class="cls_004"><span class="cls_004">contains symlinks to the activated applications. A user can create or switch to a new profile:</span></div>
<div style="position:absolute;left:88.78px;top:588.28px" class="cls_015"><span class="cls_015">$ nix-env  --switch-profile  /nix/var/nix/profiles/my-new-profile</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">37</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:30360px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background046.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2. An Overview of Nix</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">which will simply flip the</span><span class="cls_007"> ~/.nix-profile</span><span class="cls_004"> symlink to the specified profile. Subsequent</span><span class="cls_007"> nix-env</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">operations will then create new generations in this profile.</span></div>
<div style="position:absolute;left:59.72px;top:89.57px" class="cls_009"><span class="cls_009">Uninstalling and garbage collection</span><span class="cls_004">   A component can be removed from a user envi-</span></div>
<div style="position:absolute;left:59.72px;top:101.53px" class="cls_004"><span class="cls_004">ronment:</span></div>
<div style="position:absolute;left:84.62px;top:129.01px" class="cls_015"><span class="cls_015">$ nix-env  -e  hello</span></div>
<div style="position:absolute;left:84.62px;top:139.97px" class="cls_015"><span class="cls_015">uninstalling  `hello-2.1.1'</span></div>
<div style="position:absolute;left:84.62px;top:161.89px" class="cls_015"><span class="cls_015">$ hello  -v</span></div>
<div style="position:absolute;left:84.62px;top:172.85px" class="cls_015"><span class="cls_015">bash:  hello:  No  such  file  or  directory</span></div>
<div style="position:absolute;left:69.68px;top:190.82px" class="cls_004"><span class="cls_004">However,</span><span class="cls_007"> nix-env -e</span><span class="cls_004"> does not actually remove the component from the Nix store. This is</span></div>
<div style="position:absolute;left:59.72px;top:202.78px" class="cls_004"><span class="cls_004">because the component might still be in use by the user environment of another user, or be</span></div>
<div style="position:absolute;left:59.72px;top:214.73px" class="cls_004"><span class="cls_004">a dependency of a component in some environment. More importantly, if the component</span></div>
<div style="position:absolute;left:59.72px;top:226.69px" class="cls_004"><span class="cls_004">were removed, it would no longer be possible to perform a rollback.</span></div>
<div style="position:absolute;left:69.68px;top:239.74px" class="cls_004"><span class="cls_004">To reclaim disk space, it is necessary to periodically run the garbage collector, which</span></div>
<div style="position:absolute;left:59.72px;top:251.70px" class="cls_004"><span class="cls_004">deletes from the store any components not reachable from any generation of any user</span></div>
<div style="position:absolute;left:59.72px;top:263.65px" class="cls_004"><span class="cls_004">environment. (Reachability is defined with respect to the runtime dependencies found by</span></div>
<div style="position:absolute;left:59.72px;top:275.61px" class="cls_004"><span class="cls_004">the hash scanning approach discussed earlier, and in more detail in Section 3.4.) That is,</span></div>
<div style="position:absolute;left:59.72px;top:287.56px" class="cls_004"><span class="cls_004">the generations are roots of the garbage collector.</span></div>
<div style="position:absolute;left:69.68px;top:300.62px" class="cls_004"><span class="cls_004">This means that the Hello component cannot be garbage collected until the old gener-</span></div>
<div style="position:absolute;left:59.72px;top:312.57px" class="cls_004"><span class="cls_004">ations that included it are gone. The following command removes any generations of the</span></div>
<div style="position:absolute;left:59.72px;top:324.53px" class="cls_004"><span class="cls_004">user’s profile except the current:</span></div>
<div style="position:absolute;left:84.62px;top:352.01px" class="cls_015"><span class="cls_015">$ nix-env  --remove-generations  old</span></div>
<div style="position:absolute;left:59.72px;top:369.98px" class="cls_004"><span class="cls_004">Note that this removes the ability to roll back to any configuration prior to the invocation of</span></div>
<div style="position:absolute;left:59.72px;top:381.94px" class="cls_004"><span class="cls_004">this command. Thus, the user should only perform this operation when sure that rollback</span></div>
<div style="position:absolute;left:59.72px;top:393.89px" class="cls_004"><span class="cls_004">is not necessary.</span></div>
<div style="position:absolute;left:69.68px;top:406.95px" class="cls_004"><span class="cls_004">After we have removed the old generations, the Hello component has become garbage,</span></div>
<div style="position:absolute;left:59.72px;top:418.91px" class="cls_004"><span class="cls_004">assuming no generations of other profiles reach it. Thus an execution of the garbage col-</span></div>
<div style="position:absolute;left:59.72px;top:430.86px" class="cls_004"><span class="cls_004">lector will remove the component from the Nix store:</span></div>
<div style="position:absolute;left:84.62px;top:458.35px" class="cls_015"><span class="cls_015">$ nix-store  --gc</span></div>
<div style="position:absolute;left:84.62px;top:469.31px" class="cls_015"><span class="cls_015">deleting  `/nix/store/bwacc7a5c5n3...-hello-2.1.1'</span></div>
<div style="position:absolute;left:59.72px;top:498.24px" class="cls_004"><span class="cls_004">(The command</span><span class="cls_007"> nix-store</span><span class="cls_004"> performs “low-level” Nix store operations.)</span></div>
<div style="position:absolute;left:69.68px;top:511.29px" class="cls_004"><span class="cls_004">The advantage of garbage collection of components is that users never need to consider</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">whether some dependency might still be needed.  A common phenomenon in many de-</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">ployment systems is that users are asked to confirm whether it is safe to remove some</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">component (e.g., “Should Windows delete</span><span class="cls_007"> foo.dll</span><span class="cls_004">?”).  Since Nix ensures reliable depen-</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">dency information, garbage collection can be safe and automatic. The act of uninstallation</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">is a logical action concerning only top-level components (i.e., applications), not dependen-</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">cies that should remain hidden to users.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">38</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:31050px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background047.jpg" width=481 height=680></div>
<div style="position:absolute;left:334.95px;top:17.14px" class="cls_004"><span class="cls_004">2.4. Store derivations</span></div>
<div style="position:absolute;left:71.57px;top:50.81px" class="cls_034"><span class="cls_034">outside the Nix store</span></div>
<div style="position:absolute;left:292.80px;top:50.81px" class="cls_034"><span class="cls_034">in the Nix store</span></div>
<div style="position:absolute;left:94.17px;top:70.05px" class="cls_034"><span class="cls_034">Nix</span></div>
<div style="position:absolute;left:156.70px;top:70.05px" class="cls_034"><span class="cls_034">translation</span></div>
<div style="position:absolute;left:230.28px;top:70.05px" class="cls_034"><span class="cls_034">store</span></div>
<div style="position:absolute;left:296.17px;top:70.05px" class="cls_034"><span class="cls_034">building</span></div>
<div style="position:absolute;left:363.02px;top:70.05px" class="cls_034"><span class="cls_034">store derivation</span></div>
<div style="position:absolute;left:84.07px;top:77.74px" class="cls_034"><span class="cls_034">expressions</span></div>
<div style="position:absolute;left:149.48px;top:77.74px" class="cls_034"><span class="cls_034">(nix-instantiate)</span></div>
<div style="position:absolute;left:221.62px;top:77.74px" class="cls_034"><span class="cls_034">derivations</span></div>
<div style="position:absolute;left:281.26px;top:77.74px" class="cls_034"><span class="cls_034">(nix-store --realise)</span></div>
<div style="position:absolute;left:374.56px;top:77.74px" class="cls_034"><span class="cls_034">outputs</span></div>
<div style="position:absolute;left:139.32px;top:115.19px" class="cls_004"><span class="cls_004">Figure 2.12.: Two-stage building of Nix expressions</span></div>
<div style="position:absolute;left:63.87px;top:141.98px" class="cls_011"><span class="cls_011">2.4. Store derivations</span></div>
<div style="position:absolute;left:63.87px;top:167.20px" class="cls_004"><span class="cls_004">So how do we build components from Nix expressions? This could be expressed directly</span></div>
<div style="position:absolute;left:63.87px;top:179.15px" class="cls_004"><span class="cls_004">in terms of Nix expressions, but there are several reasons why this is a bad idea. First, the</span></div>
<div style="position:absolute;left:63.87px;top:191.11px" class="cls_004"><span class="cls_004">language of Nix expressions is fairly high-level, and as the primary interface for develop-</span></div>
<div style="position:absolute;left:63.87px;top:203.06px" class="cls_004"><span class="cls_004">ers, subject to evolution; i.e., the language might change to accommodate new features.</span></div>
<div style="position:absolute;left:63.87px;top:215.02px" class="cls_004"><span class="cls_004">However, this means that we would have to be able to deal with variability in the Nix</span></div>
<div style="position:absolute;left:63.87px;top:226.98px" class="cls_004"><span class="cls_004">expression language itself: several versions of the language would need to be able to co-</span></div>
<div style="position:absolute;left:63.87px;top:238.93px" class="cls_004"><span class="cls_004">exist in the store. Second, the richness of the language is nice for users but complicates</span></div>
<div style="position:absolute;left:63.87px;top:250.89px" class="cls_004"><span class="cls_004">the sorts of operations that we want to perform (e.g., building and deployment).  Third,</span></div>
<div style="position:absolute;left:63.87px;top:262.84px" class="cls_004"><span class="cls_004">Nix expressions cannot easily be identified uniquely.  Since Nix expressions can import</span></div>
<div style="position:absolute;left:63.87px;top:274.80px" class="cls_004"><span class="cls_004">other expressions scattered all over the file system, it is not straightforward to generate an</span></div>
<div style="position:absolute;left:63.87px;top:286.75px" class="cls_004"><span class="cls_004">identifier (such as a cryptographic hash) that uniquely identifies the expression. Finally, a</span></div>
<div style="position:absolute;left:63.87px;top:298.71px" class="cls_004"><span class="cls_004">monolithic architecture makes it hard to use different component specification formalisms</span></div>
<div style="position:absolute;left:63.87px;top:310.66px" class="cls_004"><span class="cls_004">on top of the Nix system (e.g., we could retarget Makefiles to use Nix as a back-end).</span></div>
<div style="position:absolute;left:73.84px;top:322.62px" class="cls_004"><span class="cls_004">For these reasons Nix expressions are not built directly; rather, they are translated to</span></div>
<div style="position:absolute;left:63.87px;top:334.57px" class="cls_004"><span class="cls_004">the more primitive language of store derivations, which encode single component build</span></div>
<div style="position:absolute;left:63.87px;top:346.53px" class="cls_004"><span class="cls_004">actions. This is analogous to the way that compilers generally do the bulk of their work</span></div>
<div style="position:absolute;left:63.87px;top:358.48px" class="cls_004"><span class="cls_004">on simpler intermediate representations of the code being compiled, rather than on a full-</span></div>
<div style="position:absolute;left:63.87px;top:370.44px" class="cls_004"><span class="cls_004">blown language with all its complexities. Store derivations are placed in the Nix store, and</span></div>
<div style="position:absolute;left:63.87px;top:382.39px" class="cls_004"><span class="cls_004">as such have a store path too. The advantage of this two-level build process is that the paths</span></div>
<div style="position:absolute;left:63.87px;top:394.35px" class="cls_004"><span class="cls_004">of store derivations give us a unique identification of objects of source deployment, just as</span></div>
<div style="position:absolute;left:63.87px;top:406.30px" class="cls_004"><span class="cls_004">paths of binary components uniquely identify objects of binary deployment.</span></div>
<div style="position:absolute;left:73.84px;top:418.26px" class="cls_004"><span class="cls_004">Figure 2.12 outlines this two-stage build process: Nix expressions are first translated</span></div>
<div style="position:absolute;left:63.87px;top:430.21px" class="cls_004"><span class="cls_004">to store derivations that live in the Nix store and that each describe a single build action</span></div>
<div style="position:absolute;left:63.87px;top:442.17px" class="cls_004"><span class="cls_004">with all variability removed.  These store derivations can then be built, which results in</span></div>
<div style="position:absolute;left:63.87px;top:454.12px" class="cls_004"><span class="cls_004">derivation outputs that also live in the Nix store.</span></div>
<div style="position:absolute;left:73.84px;top:466.08px" class="cls_004"><span class="cls_004">The exact details of the translation of Nix derivation expressions into store derivations is</span></div>
<div style="position:absolute;left:63.87px;top:478.03px" class="cls_004"><span class="cls_004">not important here; the process is fully described in Section 5.4. What matters is that each</span></div>
<div style="position:absolute;left:63.87px;top:489.99px" class="cls_004"><span class="cls_004">derivation is translated recursively into a store derivation.  This translation is performed</span></div>
<div style="position:absolute;left:63.87px;top:501.94px" class="cls_004"><span class="cls_004">automatically by</span><span class="cls_007"> nix-env</span><span class="cls_004">, but it can also be done explicitly through the command</span><span class="cls_007"> nix-</span></div>
<div style="position:absolute;left:63.87px;top:513.90px" class="cls_007"><span class="cls_007">instantiate</span><span class="cls_004">. For instance, supposing that</span><span class="cls_007"> foo.nix</span><span class="cls_004"> is a Nix expression that selects the value</span></div>
<div style="position:absolute;left:63.87px;top:525.85px" class="cls_007"><span class="cls_007">hello</span><span class="cls_004"> from</span><span class="cls_007"> all-packages-generic.nix</span><span class="cls_004"> in Figure 2.8, then applying</span><span class="cls_007"> nix-instantiate</span><span class="cls_004"> will yield</span></div>
<div style="position:absolute;left:63.87px;top:537.81px" class="cls_004"><span class="cls_004">the following:</span></div>
<div style="position:absolute;left:88.78px;top:559.69px" class="cls_015"><span class="cls_015">$ nix-instantiate  foo.nix</span></div>
<div style="position:absolute;left:88.78px;top:570.65px" class="cls_015"><span class="cls_015">/nix/store/1ja1w63wbk5qrscwg4wmzk9cbri4iykx-hello-2.1.1.drv</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">That is, the expression</span><span class="cls_007"> foo.nix</span><span class="cls_004"> is evaluated, and the resulting top-level derivation is trans-</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">39</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:31740px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background048.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2. An Overview of Nix</span></div>
<div style="position:absolute;left:68.09px;top:47.13px" class="cls_035"><span class="cls_035">{</span></div>
<div style="position:absolute;left:82.53px;top:47.13px" class="cls_036"><span class="cls_036">output</span><span class="cls_035"> =</span><span class="cls_036"> "/nix/store/bwacc7a5c5n3...-hello-2.1.1"</span><span class="cls_014"> </span><span class="cls_056">25</span></div>
<div style="position:absolute;left:69.08px;top:58.09px" class="cls_035"><span class="cls_035">,</span></div>
<div style="position:absolute;left:82.53px;top:58.09px" class="cls_036"><span class="cls_036">inputDrvs</span><span class="cls_035"> = {</span><span class="cls_014"> </span><span class="cls_056">26</span></div>
<div style="position:absolute;left:91.50px;top:69.05px" class="cls_036"><span class="cls_036">"/nix/store/7mwh9alhscz7...-bash-3.0.drv"</span><span class="cls_035">,</span></div>
<div style="position:absolute;left:91.50px;top:80.01px" class="cls_036"><span class="cls_036">"/nix/store/fi8m2vldnrxq...-hello-2.1.1.tar.gz.drv"</span><span class="cls_035">,</span></div>
<div style="position:absolute;left:91.50px;top:90.97px" class="cls_036"><span class="cls_036">"/nix/store/khllx1q519r3...-stdenv-linux.drv"</span><span class="cls_035">,</span></div>
<div style="position:absolute;left:91.50px;top:101.93px" class="cls_036"><span class="cls_036">"/nix/store/mjdfbi6dcyz7...-perl-5.8.6.drv"</span><span class="cls_014"> </span><span class="cls_056">27</span><span class="cls_035"> }</span></div>
<div style="position:absolute;left:82.53px;top:112.88px" class="cls_035"><span class="cls_035">}</span></div>
<div style="position:absolute;left:69.08px;top:123.84px" class="cls_035"><span class="cls_035">,</span></div>
<div style="position:absolute;left:82.53px;top:123.84px" class="cls_036"><span class="cls_036">inputSrcs</span><span class="cls_035"> = {</span><span class="cls_036">"/nix/store/d74lr8jfsvdh...-builder.sh"</span><span class="cls_035">}</span><span class="cls_014"> </span><span class="cls_056">28</span></div>
<div style="position:absolute;left:69.08px;top:134.80px" class="cls_035"><span class="cls_035">,</span></div>
<div style="position:absolute;left:82.53px;top:134.80px" class="cls_036"><span class="cls_036">system</span><span class="cls_035"> =</span><span class="cls_036"> "i686-linux"</span><span class="cls_014"> </span><span class="cls_056">29</span></div>
<div style="position:absolute;left:69.08px;top:145.76px" class="cls_035"><span class="cls_035">,</span></div>
<div style="position:absolute;left:82.53px;top:145.76px" class="cls_036"><span class="cls_036">builder</span><span class="cls_035"> =</span><span class="cls_036"> "/nix/store/3nca8lmpr8gg...-bash-3.0/bin/sh"</span><span class="cls_014"> </span><span class="cls_056">30</span></div>
<div style="position:absolute;left:69.08px;top:156.72px" class="cls_035"><span class="cls_035">,</span></div>
<div style="position:absolute;left:82.53px;top:156.72px" class="cls_036"><span class="cls_036">args</span><span class="cls_035"> = [</span><span class="cls_036">"-e"</span><span class="cls_035">,</span><span class="cls_036"> "/nix/store/d74lr8jfsvdh...-builder.sh"</span><span class="cls_035">]</span><span class="cls_014"> </span><span class="cls_056">31</span></div>
<div style="position:absolute;left:69.08px;top:167.68px" class="cls_035"><span class="cls_035">,</span></div>
<div style="position:absolute;left:82.53px;top:167.68px" class="cls_036"><span class="cls_036">envVars</span><span class="cls_035"> = {</span><span class="cls_014"> </span><span class="cls_056">32</span></div>
<div style="position:absolute;left:91.50px;top:178.64px" class="cls_035"><span class="cls_035">(</span><span class="cls_036">"builder"</span><span class="cls_035">,</span><span class="cls_036"> "/nix/store/3nca8lmpr8gg...-bash-3.0/bin/sh"</span><span class="cls_035">),</span></div>
<div style="position:absolute;left:91.50px;top:189.60px" class="cls_035"><span class="cls_035">(</span><span class="cls_036">"name"</span><span class="cls_035">,</span><span class="cls_036"> "hello-2.1.1"</span><span class="cls_035">),</span></div>
<div style="position:absolute;left:91.50px;top:200.56px" class="cls_035"><span class="cls_035">(</span><span class="cls_036">"out"</span><span class="cls_035">,</span><span class="cls_036"> "/nix/store/bwacc7a5c5n3...-hello-2.1.1"</span><span class="cls_035">),</span></div>
<div style="position:absolute;left:91.50px;top:211.51px" class="cls_035"><span class="cls_035">(</span><span class="cls_036">"perl"</span><span class="cls_035">,</span><span class="cls_036"> "/nix/store/h87pfv8klr4p...-perl-5.8.6"</span><span class="cls_035">),</span></div>
<div style="position:absolute;left:258.35px;top:212.51px" class="cls_056"><span class="cls_056">33</span></div>
<div style="position:absolute;left:91.50px;top:222.47px" class="cls_035"><span class="cls_035">(</span><span class="cls_036">"src"</span><span class="cls_035">,</span><span class="cls_036"> "/nix/store/h6gq0lmj9lkg...-hello-2.1.1.tar.gz"</span><span class="cls_035">),</span></div>
<div style="position:absolute;left:91.50px;top:233.43px" class="cls_035"><span class="cls_035">(</span><span class="cls_036">"stdenv"</span><span class="cls_035">,</span><span class="cls_036"> "/nix/store/hhxbaln5n11c...-stdenv-linux"</span><span class="cls_035">),</span></div>
<div style="position:absolute;left:91.50px;top:244.39px" class="cls_035"><span class="cls_035">(</span><span class="cls_036">"system"</span><span class="cls_035">,</span><span class="cls_036"> "i686-linux"</span><span class="cls_035">),</span></div>
<div style="position:absolute;left:91.50px;top:255.35px" class="cls_035"><span class="cls_035">(</span><span class="cls_036">"gtk"</span><span class="cls_035">,</span><span class="cls_036"> "/store/8yzprq56x5fa...-gtk+-2.6.6"</span><span class="cls_035">),</span></div>
<div style="position:absolute;left:82.53px;top:266.31px" class="cls_035"><span class="cls_035">}</span></div>
<div style="position:absolute;left:68.09px;top:277.27px" class="cls_035"><span class="cls_035">}</span></div>
<div style="position:absolute;left:110.62px;top:300.66px" class="cls_004"><span class="cls_004">Figure 2.13.: Store derivation for the</span><span class="cls_007"> hello</span><span class="cls_004"> attribute in Figure</span></div>
<div style="position:absolute;left:354.66px;top:300.66px" class="cls_004"><span class="cls_004">2.8</span></div>
<div style="position:absolute;left:59.72px;top:334.36px" class="cls_004"><span class="cls_004">lated to a store derivation which is placed in</span><span class="cls_007"> /nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span><span class="cls_004">. All</span></div>
<div style="position:absolute;left:59.72px;top:346.32px" class="cls_004"><span class="cls_004">input derivations of</span><span class="cls_007"> hello</span><span class="cls_004"> are recursively translated and placed in the store as well.</span></div>
<div style="position:absolute;left:69.68px;top:359.10px" class="cls_004"><span class="cls_004">The store derivation in</span></div>
<div style="position:absolute;left:173.86px;top:359.10px" class="cls_007"><span class="cls_007">/nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span><span class="cls_004">  is shown in Fig-</span></div>
<div style="position:absolute;left:59.72px;top:370.03px" class="cls_004"><span class="cls_004">ure 2.13</span><span class="cls_012"><sup>7</sup></span><span class="cls_004">.  It lists all information necessary to build the component, with references to</span></div>
<div style="position:absolute;left:59.72px;top:383.01px" class="cls_004"><span class="cls_004">the store derivations of dependencies:</span></div>
<div style="position:absolute;left:70.28px;top:407.41px" class="cls_056"><span class="cls_056">25</span></div>
<div style="position:absolute;left:84.62px;top:405.42px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> output</span><span class="cls_004"> field specifies the path that will be built by this derivation, if and when it</span></div>
<div style="position:absolute;left:84.62px;top:416.35px" class="cls_004"><span class="cls_004">is built</span><span class="cls_012"><sup>8</sup></span><span class="cls_004">. It is computed essentially by hashing the store derivation with the</span><span class="cls_007"> output</span></div>
<div style="position:absolute;left:84.62px;top:429.33px" class="cls_004"><span class="cls_004">field cleared.</span></div>
<div style="position:absolute;left:70.28px;top:454.56px" class="cls_056"><span class="cls_056">26</span></div>
<div style="position:absolute;left:84.62px;top:452.57px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> inputDrvs</span><span class="cls_004"> field contains the paths of all the input derivations. These have to be</span></div>
<div style="position:absolute;left:84.62px;top:464.52px" class="cls_004"><span class="cls_004">built before we can build this derivation.</span></div>
<div style="position:absolute;left:70.28px;top:489.75px" class="cls_056"><span class="cls_056">28</span></div>
<div style="position:absolute;left:84.62px;top:487.76px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> inputSrcs</span><span class="cls_004"> field contains the paths of all input sources in the Nix store.  The</span></div>
<div style="position:absolute;left:84.62px;top:499.71px" class="cls_004"><span class="cls_004">Hello Nix expression in Figure 2.8 referred to a local file</span><span class="cls_007"> builder.sh</span><span class="cls_004">. This file has</span></div>
<div style="position:absolute;left:84.62px;top:511.67px" class="cls_004"><span class="cls_004">been copied by</span><span class="cls_007"> nix-instantiate</span><span class="cls_004"> to the Nix store, since everything used by the build</span></div>
<div style="position:absolute;left:84.62px;top:523.62px" class="cls_004"><span class="cls_004">process must be inside the Nix store to prevent undeclared dependencies.</span></div>
<div style="position:absolute;left:64.20px;top:545.94px" class="cls_013"><span class="cls_013"><sup>7</sup></span><span class="cls_014">This is a pretty-printed representation of the actual store derivation, which is encoded as an ATerm [166].</span></div>
<div style="position:absolute;left:71.67px;top:556.30px" class="cls_014"><span class="cls_014">Figure 5.8 on page 105 shows the actual ATerm.</span></div>
<div style="position:absolute;left:64.20px;top:565.18px" class="cls_013"><span class="cls_013"><sup>8</sup></span><span class="cls_014">This field exists in the extensional model described in Chapter 5, where the output path is computed in advance,</span></div>
<div style="position:absolute;left:71.67px;top:575.55px" class="cls_014"><span class="cls_014">but not in the intensional model described in Chapter 6, where it is only known after the derivation has been</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">built.</span></div>
<div style="position:absolute;left:59.72px;top:624.86px" class="cls_004"><span class="cls_004">40</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:32430px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background049.jpg" width=481 height=680></div>
<div style="position:absolute;left:334.95px;top:17.14px" class="cls_004"><span class="cls_004">2.4. Store derivations</span></div>
<div style="position:absolute;left:74.43px;top:47.03px" class="cls_056"><span class="cls_056">29</span></div>
<div style="position:absolute;left:88.78px;top:45.04px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> system</span><span class="cls_004"> field specifies the hardware and operating system system on which the</span></div>
<div style="position:absolute;left:88.78px;top:56.99px" class="cls_004"><span class="cls_004">derivation is to be built. This field is part of the hash computation, so derivations</span></div>
<div style="position:absolute;left:88.78px;top:68.95px" class="cls_004"><span class="cls_004">for different systems (e.g.,</span><span class="cls_007"> i686-linux</span><span class="cls_004"> versus</span><span class="cls_007"> powerpc-darwin</span><span class="cls_004">) result in different store</span></div>
<div style="position:absolute;left:88.78px;top:80.90px" class="cls_004"><span class="cls_004">paths.</span></div>
<div style="position:absolute;left:74.43px;top:104.96px" class="cls_056"><span class="cls_056">30</span></div>
<div style="position:absolute;left:88.78px;top:102.97px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> builder</span><span class="cls_004"> field is the program to be executed. The reader might wonder about the</span></div>
<div style="position:absolute;left:88.78px;top:114.92px" class="cls_004"><span class="cls_004">apparent mismatch between the builder declared in Figure 2.6 and the one specified</span></div>
<div style="position:absolute;left:88.78px;top:126.88px" class="cls_004"><span class="cls_004">here. This is because the function</span><span class="cls_007"> stdenv.mkDerivation</span><span class="cls_004"> massages the arguments it</span></div>
<div style="position:absolute;left:88.78px;top:138.83px" class="cls_004"><span class="cls_004">receives a bit, substituting a shell binary as the actual builder, with the original shell</span></div>
<div style="position:absolute;left:88.78px;top:150.79px" class="cls_004"><span class="cls_004">script passed to the shell binary as a command line argument.</span></div>
<div style="position:absolute;left:74.43px;top:174.84px" class="cls_056"><span class="cls_056">31</span></div>
<div style="position:absolute;left:88.78px;top:172.85px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> args</span><span class="cls_004"> field lists the command line arguments to be passed to the builder.</span></div>
<div style="position:absolute;left:74.43px;top:196.90px" class="cls_056"><span class="cls_056">32</span></div>
<div style="position:absolute;left:88.78px;top:194.91px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> envVars</span><span class="cls_004"> field lists the environment variables to be passed to the builder.</span></div>
<div style="position:absolute;left:73.84px;top:216.43px" class="cls_004"><span class="cls_004">Note that</span><span class="cls_007"> inputDrvs</span><span class="cls_004"> and</span><span class="cls_007"> envVars</span><span class="cls_004"> specify different paths for corresponding depen-</span></div>
<div style="position:absolute;left:63.87px;top:228.39px" class="cls_004"><span class="cls_004">dencies.  For example, Hello’s Perl dependency is built by the derivation stored in</span></div>
<div style="position:absolute;left:63.87px;top:240.34px" class="cls_007"><span class="cls_007">/nix/store/mjdfbi6dcyz7...-perl-5.8.6.drv</span><span class="cls_014"> </span><span class="cls_056">27</span><span class="cls_059"> </span><span class="cls_004">. The</span><span class="cls_007"> output</span><span class="cls_004"> path of this derivation is</span><span class="cls_007"> /nix/store/-</span></div>
<div style="position:absolute;left:63.87px;top:252.30px" class="cls_007"><span class="cls_007">h87pfv8klr4p...-perl-5.8.6</span><span class="cls_014"> </span><span class="cls_056">33</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:281.76px" class="cls_009"><span class="cls_009">Building store derivations</span><span class="cls_004">   Store derivations can be built by calling the command</span><span class="cls_007"> nix-</span></div>
<div style="position:absolute;left:63.87px;top:293.71px" class="cls_007"><span class="cls_007">store --realise</span><span class="cls_004">, which “realises” the effect of a derivation in the file system. It builds the</span></div>
<div style="position:absolute;left:63.87px;top:305.67px" class="cls_004"><span class="cls_004">derivation (if the output path of the derivation does not exist already), and prints the output</span></div>
<div style="position:absolute;left:63.87px;top:317.62px" class="cls_004"><span class="cls_004">path.</span></div>
<div style="position:absolute;left:88.78px;top:343.41px" class="cls_015"><span class="cls_015">$ nix-store  --realise  /nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span></div>
<div style="position:absolute;left:88.78px;top:365.33px" class="cls_015"><span class="cls_015">/nix/store/bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:73.84px;top:381.60px" class="cls_004"><span class="cls_004">Nix users do not generally have to deal with store derivations. For instance, the</span><span class="cls_007"> nix-env</span></div>
<div style="position:absolute;left:63.87px;top:393.55px" class="cls_004"><span class="cls_004">command hides them entirely—the user interacts only with high-level Nix expressions,</span></div>
<div style="position:absolute;left:63.87px;top:405.51px" class="cls_004"><span class="cls_004">which is really just a fancy wrapper around the two commands above.  However, store</span></div>
<div style="position:absolute;left:63.87px;top:417.46px" class="cls_004"><span class="cls_004">derivations are important when implementing deployment policies. Their relevance is that</span></div>
<div style="position:absolute;left:63.87px;top:429.42px" class="cls_004"><span class="cls_004">they give us a way to uniquely identify a component both in source and binary form,</span></div>
<div style="position:absolute;left:63.87px;top:441.37px" class="cls_004"><span class="cls_004">through the paths of the store derivation and the output, respectively. This can be used to</span></div>
<div style="position:absolute;left:63.87px;top:453.33px" class="cls_004"><span class="cls_004">implement a variety of deployment policies, as we will see in Section 2.5.</span></div>
<div style="position:absolute;left:63.87px;top:482.79px" class="cls_009"><span class="cls_009">Closures revisited</span><span class="cls_004">   A crucial operation for deployment is to query the closure of a store</span></div>
<div style="position:absolute;left:63.87px;top:494.75px" class="cls_004"><span class="cls_004">path under the dependency relation, as discussed in Section 2.1. Nix maintains this infor-</span></div>
<div style="position:absolute;left:63.87px;top:506.70px" class="cls_004"><span class="cls_004">mation for all paths in the Nix store. For instance, the closure of the Hello component can</span></div>
<div style="position:absolute;left:63.87px;top:518.66px" class="cls_004"><span class="cls_004">be found as follows:</span></div>
<div style="position:absolute;left:88.78px;top:544.44px" class="cls_015"><span class="cls_015">$ nix-store  -qR  /nix/store/bwacc7a5c5n3...-hello-2.1.1/bin/hello</span></div>
<div style="position:absolute;left:88.78px;top:555.40px" class="cls_015"><span class="cls_015">/nix/store/72by2iw5wd8i...-glibc-2.3.5</span></div>
<div style="position:absolute;left:88.78px;top:566.36px" class="cls_015"><span class="cls_015">/nix/store/bg6gi7s8mxir...-linux-headers-2.6.11.12-i386</span></div>
<div style="position:absolute;left:88.78px;top:577.32px" class="cls_015"><span class="cls_015">/nix/store/bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:88.78px;top:588.28px" class="cls_015"><span class="cls_015">/nix/store/q2pw1vn87327...-gcc-3.4.4</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">41</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:33120px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background050.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2. An Overview of Nix</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">This means that when we deploy this instance of Hello, we must copy all four of the paths</span></div>
<div style="position:absolute;left:59.72px;top:55.97px" class="cls_004"><span class="cls_004">listed here</span><span class="cls_012"><sup>9</sup></span><span class="cls_004">. When we copy these paths, we have binary deployment. It should be pointed</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">out that</span><span class="cls_007"> /nix/store/h87pfv8klr4p...-perl-5.8.6</span><span class="cls_004"> is not in the closure, since it is not referenced</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">from the Hello binary or any of the paths referenced by it. That is, Perl is exclusively a</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">build-time dependency.</span></div>
<div style="position:absolute;left:69.68px;top:103.82px" class="cls_004"><span class="cls_004">Similarly, we can query the closure of the store derivation:</span></div>
<div style="position:absolute;left:84.62px;top:123.19px" class="cls_015"><span class="cls_015">$ nix-store  -qR  /nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span></div>
<div style="position:absolute;left:84.62px;top:134.14px" class="cls_015"><span class="cls_015">/nix/store/0m055mdm0v5z...-perl-5.8.6.tar.bz2.drv</span></div>
<div style="position:absolute;left:84.62px;top:145.10px" class="cls_015"><span class="cls_015">/nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span></div>
<div style="position:absolute;left:84.62px;top:156.06px" class="cls_015"><span class="cls_015">/nix/store/d74lr8jfsvdh...-builder.sh</span></div>
<div style="position:absolute;left:84.62px;top:167.02px" class="cls_015"><span class="cls_015">...  (98  more  paths  omitted)  ...</span></div>
<div style="position:absolute;left:69.68px;top:176.87px" class="cls_004"><span class="cls_004">Copying these paths gives us source deployment, since the store derivations describe</span></div>
<div style="position:absolute;left:59.72px;top:188.83px" class="cls_004"><span class="cls_004">build actions from source.</span></div>
<div style="position:absolute;left:69.68px;top:199.78px" class="cls_004"><span class="cls_004">It is also possible to combine the two:</span></div>
<div style="position:absolute;left:84.62px;top:219.15px" class="cls_015"><span class="cls_015">$ nix-store  -qR  --include-outputs  \</span></div>
<div style="position:absolute;left:103.45px;top:230.11px" class="cls_015"><span class="cls_015">/nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span></div>
<div style="position:absolute;left:84.62px;top:241.07px" class="cls_015"><span class="cls_015">/nix/store/0m055mdm0v5z...-perl-5.8.6.tar.bz2.drv</span></div>
<div style="position:absolute;left:84.62px;top:252.03px" class="cls_015"><span class="cls_015">/nix/store/h87pfv8klr4p...-perl-5.8.6</span></div>
<div style="position:absolute;left:84.62px;top:262.99px" class="cls_015"><span class="cls_015">/nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span></div>
<div style="position:absolute;left:84.62px;top:273.95px" class="cls_015"><span class="cls_015">/nix/store/bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:84.62px;top:284.90px" class="cls_015"><span class="cls_015">/nix/store/d74lr8jfsvdh...-builder.sh</span></div>
<div style="position:absolute;left:84.62px;top:295.86px" class="cls_015"><span class="cls_015">...  (155  more  paths  omitted)  ...</span></div>
<div style="position:absolute;left:69.68px;top:305.71px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> --include-outputs</span><span class="cls_004"> flag causes the closures of the outputs of derivations to be in-</span></div>
<div style="position:absolute;left:59.72px;top:317.67px" class="cls_004"><span class="cls_004">cluded. It is worth noting that this set is more than the union of the two sets above, since</span></div>
<div style="position:absolute;left:59.72px;top:329.62px" class="cls_004"><span class="cls_004">there are many output paths of derivations that are not in the closure of the Hello binary.</span></div>
<div style="position:absolute;left:59.72px;top:341.58px" class="cls_004"><span class="cls_004">For instance, though the Hello binary does not reference Perl, the Perl binary is included</span></div>
<div style="position:absolute;left:59.72px;top:353.53px" class="cls_004"><span class="cls_004">here because its derivation is included.</span></div>
<div style="position:absolute;left:59.72px;top:383.83px" class="cls_011"><span class="cls_011">2.5. Deployment models</span></div>
<div style="position:absolute;left:59.72px;top:409.05px" class="cls_004"><span class="cls_004">What we have described above is not deployment—it is build management combined with</span></div>
<div style="position:absolute;left:59.72px;top:421.00px" class="cls_004"><span class="cls_004">local package management. The calls to</span><span class="cls_007"> nix-env</span><span class="cls_004"> build components locally, and construct</span></div>
<div style="position:absolute;left:59.72px;top:432.96px" class="cls_004"><span class="cls_004">user environments out of the build results. To perform actual software deployment, it is</span></div>
<div style="position:absolute;left:59.72px;top:444.91px" class="cls_004"><span class="cls_004">necessary to get the Nix expressions to the client machines. Nix in itself does not provide</span></div>
<div style="position:absolute;left:59.72px;top:456.87px" class="cls_004"><span class="cls_004">any specific way to do so. Rather, it provides the mechanisms to allow various deployment</span></div>
<div style="position:absolute;left:59.72px;top:468.82px" class="cls_004"><span class="cls_004">policies. The commands</span><span class="cls_007"> nix-instantiate</span><span class="cls_004"> and</span><span class="cls_007"> nix-store</span><span class="cls_004"> provide the fundamental mechanisms.</span></div>
<div style="position:absolute;left:59.72px;top:480.78px" class="cls_004"><span class="cls_004">(The command</span><span class="cls_007"> nix-env</span><span class="cls_004"> implemented on top of these already implements a bit of policy,</span></div>
<div style="position:absolute;left:59.72px;top:492.74px" class="cls_004"><span class="cls_004">namely, user environments.)</span></div>
<div style="position:absolute;left:69.68px;top:504.69px" class="cls_004"><span class="cls_004">Here are some examples of deployment models implemented and used in practice to</span></div>
<div style="position:absolute;left:59.72px;top:516.65px" class="cls_004"><span class="cls_004">distribute the Nix expressions of the Nix Packages collection:</span></div>
<div style="position:absolute;left:74.66px;top:534.90px" class="cls_004"><span class="cls_004">• Manual download. A user can manually download releases of the Nix Packages</span></div>
<div style="position:absolute;left:84.62px;top:546.86px" class="cls_004"><span class="cls_004">collection as</span><span class="cls_007"> tar</span><span class="cls_004"> archives, unpack them, and apply</span><span class="cls_007"> nix-env</span><span class="cls_004"> to install components.</span></div>
<div style="position:absolute;left:64.20px;top:565.18px" class="cls_013"><span class="cls_013"><sup>9</sup></span><span class="cls_014">In case the reader is wondering:  the quite unnecessary dependency on</span><span class="cls_016"> linux-headers</span><span class="cls_014"> is through</span><span class="cls_016"> glibc</span><span class="cls_014">; see</span></div>
<div style="position:absolute;left:71.67px;top:575.55px" class="cls_014"><span class="cls_014">Section 6.7. The dependency on</span><span class="cls_016"> gcc</span><span class="cls_014"> is entirely unnecessary and does not occur in the “production” version</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">of Hello, which uses the utility</span><span class="cls_016"> patchelf</span><span class="cls_014"> (page 179) to prevent this retained dependency.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">42</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:33810px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background051.jpg" width=481 height=680></div>
<div style="position:absolute;left:321.82px;top:17.14px" class="cls_004"><span class="cls_004">2.5. Deployment models</span></div>
<div style="position:absolute;left:88.78px;top:45.04px" class="cls_004"><span class="cls_004">The downside to this approach is that it is rather laborious; in particular, it is not</span></div>
<div style="position:absolute;left:88.78px;top:56.99px" class="cls_004"><span class="cls_004">easy to stay up-to-date with new releases.</span></div>
<div style="position:absolute;left:78.82px;top:82.43px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:82.43px" class="cls_004"><span class="cls_004">Updating through a version management system. As a refinement to the previous</span></div>
<div style="position:absolute;left:88.78px;top:94.39px" class="cls_004"><span class="cls_004">model, the set of Nix expressions can be distributed through a version management</span></div>
<div style="position:absolute;left:88.78px;top:106.34px" class="cls_004"><span class="cls_004">system. For example, Nixpkgs can be obtained from its Subversion repository. After</span></div>
<div style="position:absolute;left:88.78px;top:118.30px" class="cls_004"><span class="cls_004">the initial checkout into a local working copy, staying up-to-date is a simple matter</span></div>
<div style="position:absolute;left:88.78px;top:130.25px" class="cls_004"><span class="cls_004">of running an update operation on the working copy. An added advantage is that it</span></div>
<div style="position:absolute;left:88.78px;top:142.21px" class="cls_004"><span class="cls_004">becomes easy to maintain local modifications to the Nix expressions.</span></div>
<div style="position:absolute;left:78.82px;top:167.64px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:167.64px" class="cls_004"><span class="cls_004">Channels.  A more sophisticated model is the notion of channels.  A channel is</span></div>
<div style="position:absolute;left:88.78px;top:179.60px" class="cls_004"><span class="cls_004">a URL that points to a</span><span class="cls_007"> tar</span><span class="cls_004"> archive of Nix expressions.  A user can subscribe to a</span></div>
<div style="position:absolute;left:88.78px;top:191.55px" class="cls_004"><span class="cls_004">channel:</span></div>
<div style="position:absolute;left:110.70px;top:221.25px" class="cls_015"><span class="cls_015">$ nix-channel  --add  </span><A HREF="http://server/channels/nixpkgs-stable/">http://server/channels/nixpkgs-stable</A> </div>
<div style="position:absolute;left:88.78px;top:241.43px" class="cls_004"><span class="cls_004">Then, the command</span></div>
<div style="position:absolute;left:110.70px;top:271.13px" class="cls_015"><span class="cls_015">$ nix-channel  --update</span></div>
<div style="position:absolute;left:88.78px;top:291.31px" class="cls_004"><span class="cls_004">downloads the Nix expressions from the subscribed channels and makes them the</span></div>
<div style="position:absolute;left:88.78px;top:303.26px" class="cls_004"><span class="cls_004">default for</span><span class="cls_007"> nix-env</span><span class="cls_004"> operations. That is, an operation such as</span></div>
<div style="position:absolute;left:110.70px;top:332.96px" class="cls_015"><span class="cls_015">$ nix-env  -i  firefox</span></div>
<div style="position:absolute;left:88.78px;top:353.14px" class="cls_004"><span class="cls_004">will install a derivation named</span><span class="cls_007"> firefox</span><span class="cls_004"> from one of the subscribed channels. In par-</span></div>
<div style="position:absolute;left:88.78px;top:365.09px" class="cls_004"><span class="cls_004">ticular, it is easy to keep the entire system up-to-date:</span></div>
<div style="position:absolute;left:110.70px;top:394.79px" class="cls_015"><span class="cls_015">$ nix-channel  --update</span></div>
<div style="position:absolute;left:110.70px;top:405.75px" class="cls_015"><span class="cls_015">$ nix-env  -u  '*'</span></div>
<div style="position:absolute;left:88.78px;top:425.93px" class="cls_004"><span class="cls_004">where</span><span class="cls_007"> nix-env -u ’*’</span><span class="cls_004"> updates all installed components in the user environment to the</span></div>
<div style="position:absolute;left:88.78px;top:437.89px" class="cls_004"><span class="cls_004">latest versions available in the subscribed channels.</span></div>
<div style="position:absolute;left:78.82px;top:463.32px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:463.32px" class="cls_004"><span class="cls_004">One-click installations.  When a user wants to install a specific program, by far</span></div>
<div style="position:absolute;left:88.78px;top:475.28px" class="cls_004"><span class="cls_004">the easiest method is to simply install it by clicking on it on some distribution web</span></div>
<div style="position:absolute;left:88.78px;top:487.23px" class="cls_004"><span class="cls_004">page.  Of course, this should also install all dependencies.  An example of such</span></div>
<div style="position:absolute;left:88.78px;top:499.19px" class="cls_004"><span class="cls_004">one-click installations is shown in Figure 2.14 (along with direct download of the</span></div>
<div style="position:absolute;left:88.78px;top:511.14px" class="cls_004"><span class="cls_004">Nix expressions, and channel subscription information). Users can click on links on</span></div>
<div style="position:absolute;left:88.78px;top:523.10px" class="cls_004"><span class="cls_004">release web pages to install specific components into their user environments. The</span></div>
<div style="position:absolute;left:88.78px;top:535.05px" class="cls_004"><span class="cls_004">links lead to small files containing the information necessary to install the component</span></div>
<div style="position:absolute;left:88.78px;top:547.01px" class="cls_004"><span class="cls_004">(e.g., Nix expressions), while the installation of the component is performed by a</span></div>
<div style="position:absolute;left:88.78px;top:558.96px" class="cls_004"><span class="cls_004">simple tool associated with the MIME type [74] of those files.</span></div>
<div style="position:absolute;left:73.84px;top:583.02px" class="cls_004"><span class="cls_004">Chapter 7 looks at the wide variety of deployment policies in much greater detail.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">43</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:34500px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background052.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2. An Overview of Nix</span></div>
<div style="position:absolute;left:62.89px;top:314.58px" class="cls_004"><span class="cls_004">Figure 2.14.: Deployment policies: direct download, channels, and one-click installation</span></div>
<div style="position:absolute;left:59.72px;top:344.74px" class="cls_011"><span class="cls_011">2.6. Transparent source/binary deployment</span></div>
<div style="position:absolute;left:59.72px;top:370.97px" class="cls_004"><span class="cls_004">The Nix model as described above is a source deployment model. Nix expressions describe</span></div>
<div style="position:absolute;left:59.72px;top:381.90px" class="cls_004"><span class="cls_004">how to build components from source</span><span class="cls_012"><sup>10</sup></span><span class="cls_004">.  A source deployment model is convenient for</span></div>
<div style="position:absolute;left:59.72px;top:394.88px" class="cls_004"><span class="cls_004">deployers because they do not need to create binary packages explicitly. It also gives users</span></div>
<div style="position:absolute;left:59.72px;top:406.83px" class="cls_004"><span class="cls_004">the freedom to make local modifications and feature selections.</span></div>
<div style="position:absolute;left:69.68px;top:419.32px" class="cls_004"><span class="cls_004">However, building all dependencies is rather slow.  For the Hello component in Nix</span></div>
<div style="position:absolute;left:59.72px;top:430.25px" class="cls_004"><span class="cls_004">Packages</span><span class="cls_012"><sup>11</sup></span><span class="cls_004">, it entails building 63 derivations, including the builds of</span></div>
<div style="position:absolute;left:84.62px;top:453.80px" class="cls_007"><span class="cls_007">hello-2.1.1,  stdenv-linux,  gcc-3.4.4,  bash-3.0,  gnutar-1.15.1,  curl-7.14.0,</span></div>
<div style="position:absolute;left:84.62px;top:465.76px" class="cls_007"><span class="cls_007">binutils-2.16.1,  gnupatch-2.5.4,  gnused-4.1.4,  patchelf-0.1pre2286,  linux-</span></div>
<div style="position:absolute;left:84.62px;top:477.71px" class="cls_007"><span class="cls_007">headers-2.6.11.12-i386,  zlib-1.2.2,  bzip2-1.0.3,  findutils-4.2.20,  gnugrep-</span></div>
<div style="position:absolute;left:84.62px;top:489.67px" class="cls_007"><span class="cls_007">2.5.1a, coreutils-5.2.1, perl-5.8.6, gcc-3.4.4, gnumake-3.80, gzip-1.3.3, gawk-</span></div>
<div style="position:absolute;left:84.62px;top:500.62px" class="cls_007"><span class="cls_007">3.1.4, pcre-6.0, glibc-2.3.5, diffutils-2.8.1, gcc-3.4.4</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:59.72px;top:522.15px" class="cls_004"><span class="cls_004">the</span><span class="cls_007"> fetchurl</span><span class="cls_004"> downloads of the sources of those packages, and some derivations for the boot-</span></div>
<div style="position:absolute;left:59.72px;top:534.11px" class="cls_004"><span class="cls_004">strapping of</span><span class="cls_007"> stdenv</span><span class="cls_004"> (e.g., the statically linked compiler used to compile</span><span class="cls_007"> gcc-3.4.4</span><span class="cls_004">); with</span></div>
<div style="position:absolute;left:61.21px;top:555.40px" class="cls_013"><span class="cls_013"><sup>10</sup></span><span class="cls_014">As we will see in Section 7.1.4, it is possible to support binary-only packages by using a “trivial” builder</span></div>
<div style="position:absolute;left:71.67px;top:565.76px" class="cls_014"><span class="cls_014">that just fetches a binary distribution of a component, unpacks it and copies it to</span><span class="cls_016"> $out</span><span class="cls_014">. This is how the Nix</span></div>
<div style="position:absolute;left:71.67px;top:575.23px" class="cls_014"><span class="cls_014">Packages collection supports components such as Adobe Reader.</span></div>
<div style="position:absolute;left:61.21px;top:584.11px" class="cls_013"><span class="cls_013"><sup>11</sup></span><span class="cls_014">Data based on</span><span class="cls_016"> nixpkgs-0.9pre3252</span><span class="cls_014"> on</span><span class="cls_016"> i686-linux</span><span class="cls_014">.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">44</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:35190px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background053.jpg" width=481 height=680></div>
<div style="position:absolute;left:248.86px;top:17.14px" class="cls_004"><span class="cls_004">2.6. Transparent source/binary deployment</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">downloads of source archives totalling 130 megabytes; and with the build results occupy-</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">ing 357 megabytes of disk space (although most of it can be garbage collected).</span></div>
<div style="position:absolute;left:73.84px;top:69.41px" class="cls_004"><span class="cls_004">Thus, source deployment is clearly awful for most end-users, who do not have the re-</span></div>
<div style="position:absolute;left:63.87px;top:81.36px" class="cls_004"><span class="cls_004">sources or patience for a full build from source of the entire dependency graph.</span></div>
<div style="position:absolute;left:73.84px;top:93.78px" class="cls_004"><span class="cls_004">However, Nix allows the best of both worlds—source deployment and binary deploy-</span></div>
<div style="position:absolute;left:63.87px;top:105.74px" class="cls_004"><span class="cls_004">ment—through its transparent source/binary deployment model. The idea is that pre-built</span></div>
<div style="position:absolute;left:63.87px;top:117.69px" class="cls_004"><span class="cls_004">derivation outputs are made available in some central repository accessible to the client</span></div>
<div style="position:absolute;left:63.87px;top:129.65px" class="cls_004"><span class="cls_004">machines, such as a web server or installation CD-ROM. For instance, a component dis-</span></div>
<div style="position:absolute;left:63.87px;top:141.60px" class="cls_004"><span class="cls_004">tributor or system administrator can pre-build components, then push (upload) them to a</span></div>
<div style="position:absolute;left:63.87px;top:153.56px" class="cls_004"><span class="cls_004">server using PUT requests:</span></div>
<div style="position:absolute;left:88.78px;top:179.12px" class="cls_015"><span class="cls_015">$ nix-push  </span><A HREF="http://server/dist/">http://server/dist/</A>  $(nix-instantiate  foo.nix)</div>
<div style="position:absolute;left:63.87px;top:195.17px" class="cls_004"><span class="cls_004">This will build the derivations in</span><span class="cls_007"> foo.nix</span><span class="cls_004">, if necessary, and upload it and all its dependencies</span></div>
<div style="position:absolute;left:63.87px;top:207.13px" class="cls_004"><span class="cls_004">to the indicated site. For instance, the path</span><span class="cls_007"> /nix/store/mkmpxqr8d7f7...-firefox-1.0</span><span class="cls_004"> will be</span></div>
<div style="position:absolute;left:63.87px;top:219.08px" class="cls_004"><span class="cls_004">archived and compressed into an archive</span><span class="cls_007"> yq318j8lal09...-firefox.nar.bz2</span><span class="cls_004"> and uploaded to</span></div>
<div style="position:absolute;left:63.87px;top:231.04px" class="cls_004"><span class="cls_004">the server. Such a file is called a substitute, since a client machine can substitute it for a</span></div>
<div style="position:absolute;left:63.87px;top:242.99px" class="cls_004"><span class="cls_004">build. The server provides a manifest of all available substitutes. An example entry in the</span></div>
<div style="position:absolute;left:63.87px;top:253.92px" class="cls_004"><span class="cls_004">manifest is</span><span class="cls_012"><sup>12</sup></span><span class="cls_004">:</span></div>
<div style="position:absolute;left:88.78px;top:280.51px" class="cls_015"><span class="cls_015">{ StorePath:  /nix/store/mkmpxqr8d7f7...-firefox-1.0</span></div>
<div style="position:absolute;left:98.19px;top:291.47px" class="cls_015"><span class="cls_015">NarURL:  </span><A HREF="http://server/dist/yq318j8lal09...-firefox.nar.bz2/">http://server/dist/yq318j8lal09...-firefox.nar.bz2</A> </div>
<div style="position:absolute;left:98.19px;top:302.43px" class="cls_015"><span class="cls_015">Size:  11480169  }</span></div>
<div style="position:absolute;left:63.87px;top:318.48px" class="cls_004"><span class="cls_004">which states that to create store path</span><span class="cls_007"> /nix/store/mkmpxqr8d7f7...-firefox-1.0</span><span class="cls_004">, Nix can down-</span></div>
<div style="position:absolute;left:63.87px;top:330.43px" class="cls_004"><span class="cls_004">load and unpack URL</span><span class="cls_007"> http://server/dist/yq318j8lal09...-firefox.nar.bz2</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:342.85px" class="cls_004"><span class="cls_004">To use these substitutes, client machines must register the fact that they are available</span></div>
<div style="position:absolute;left:63.87px;top:354.80px" class="cls_004"><span class="cls_004">using the command</span><span class="cls_007"> nix-pull</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:88.78px;top:380.37px" class="cls_015"><span class="cls_015">$ nix-pull  </span><A HREF="http://server/dist/">http://server/dist</A> </div>
<div style="position:absolute;left:63.87px;top:396.42px" class="cls_004"><span class="cls_004">This does not actually download any of the substitutes, it merely registers their availability.</span></div>
<div style="position:absolute;left:63.87px;top:408.37px" class="cls_004"><span class="cls_004">When the user subsequently attempts to install a Nix expression, and Nix when building</span></div>
<div style="position:absolute;left:63.87px;top:420.33px" class="cls_004"><span class="cls_004">some store path p notices that it knows a substitute for p, it will download the substitute</span></div>
<div style="position:absolute;left:63.87px;top:432.28px" class="cls_004"><span class="cls_004">and unpack it instead of building from source.</span></div>
<div style="position:absolute;left:73.84px;top:444.70px" class="cls_004"><span class="cls_004">Thus, from a user perspective, source deployment automatically optimises into binary</span></div>
<div style="position:absolute;left:63.87px;top:456.65px" class="cls_004"><span class="cls_004">deployment.  This is good: binary deployment can be considered a partial evaluation of</span></div>
<div style="position:absolute;left:63.87px;top:468.61px" class="cls_004"><span class="cls_004">source deployment with respect to a specific platform, and such optimisations should be</span></div>
<div style="position:absolute;left:63.87px;top:480.56px" class="cls_004"><span class="cls_004">“invisible”.</span></div>
<div style="position:absolute;left:73.84px;top:492.98px" class="cls_004"><span class="cls_004">However, if the user has made modifications to parts of the Nix expression, it is possible</span></div>
<div style="position:absolute;left:63.87px;top:504.93px" class="cls_004"><span class="cls_004">that some or all of the store paths will be different.  In that case, the substitutes fail to</span></div>
<div style="position:absolute;left:63.87px;top:516.89px" class="cls_004"><span class="cls_004">be applicable and Nix will build from source.  Thus, binary deployment automatically</span></div>
<div style="position:absolute;left:63.87px;top:528.84px" class="cls_004"><span class="cls_004">“degrades” back to source deployment.</span></div>
<div style="position:absolute;left:73.84px;top:541.26px" class="cls_004"><span class="cls_004">The transparent source/binary model therefore combines the flexibility of source de-</span></div>
<div style="position:absolute;left:63.87px;top:553.22px" class="cls_004"><span class="cls_004">ployment systems such as Gentoo with the efficiency of binary deployment systems such</span></div>
<div style="position:absolute;left:63.87px;top:565.17px" class="cls_004"><span class="cls_004">as RPM.</span></div>
<div style="position:absolute;left:65.37px;top:584.11px" class="cls_013"><span class="cls_013"><sup>12</sup></span><span class="cls_014">This is somewhat simplified. The full details of</span><span class="cls_016"> nix-push</span><span class="cls_014"> manifests are in Section 7.3.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">45</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:35880px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background054.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">2. An Overview of Nix</span></div>
<div style="position:absolute;left:69.68px;top:45.04px" class="cls_004"><span class="cls_004">Of course, the deployment models described in Section 2.5 support transparent source/-</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">binary deployment. For instance, a Nix channel contains not just a set of Nix expressions,</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">but also the URL of a manifest that clients can pull when they update from the channel.</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">Thus, subscribers to the channel automatically get binary deployment for those derivations</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">in the channel that have been pre-built.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">46</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:36570px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background055.jpg" width=481 height=680></div>
<div style="position:absolute;left:214.69px;top:211.75px" class="cls_006"><span class="cls_006">Part II.</span></div>
<div style="position:absolute;left:176.10px;top:257.85px" class="cls_010"><span class="cls_010">Foundations</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">47</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:37260px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background056.jpg" width=481 height=680></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:37260px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background057.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:88.81px" class="cls_006"><span class="cls_006">3. Deployment as Memory Management</span></div>
<div style="position:absolute;left:63.87px;top:128.51px" class="cls_004"><span class="cls_004">The previous chapter introduced the Nix system. It obtains isolation and non-interference</span></div>
<div style="position:absolute;left:63.87px;top:140.47px" class="cls_004"><span class="cls_004">between components using a Nix store that stores components under file names that contain</span></div>
<div style="position:absolute;left:63.87px;top:152.42px" class="cls_004"><span class="cls_004">a unique cryptographic hash of the component. However, some of the underlying concepts</span></div>
<div style="position:absolute;left:63.87px;top:164.38px" class="cls_004"><span class="cls_004">might seem a bit suspicious! For instance, storing components in an essentially flat, rigid</span></div>
<div style="position:absolute;left:63.87px;top:176.33px" class="cls_004"><span class="cls_004">“address space” of components is very different from the way software is typically stored</span></div>
<div style="position:absolute;left:63.87px;top:187.26px" class="cls_004"><span class="cls_004">in most operating systems</span><span class="cls_012"><sup>1</sup></span><span class="cls_004">.  And the hash scanning technique to identify dependencies</span></div>
<div style="position:absolute;left:63.87px;top:200.24px" class="cls_004"><span class="cls_004">clearly cannot work in all circumstances.</span></div>
<div style="position:absolute;left:73.84px;top:212.20px" class="cls_004"><span class="cls_004">The purpose of this chapter is to “derive” the basic design of the Nix store by relating</span></div>
<div style="position:absolute;left:63.87px;top:224.16px" class="cls_004"><span class="cls_004">the main issues in software deployment to those in memory management in conventional</span></div>
<div style="position:absolute;left:63.87px;top:236.11px" class="cls_004"><span class="cls_004">programming languages. As we shall see, conventional deployment tools treat the file sys-</span></div>
<div style="position:absolute;left:63.87px;top:248.07px" class="cls_004"><span class="cls_004">tem as a chaotic, unstructured component store, similar to how an assembler programmer</span></div>
<div style="position:absolute;left:63.87px;top:260.02px" class="cls_004"><span class="cls_004">would treat memory. In contrast, modern programming languages impose a certain disci-</span></div>
<div style="position:absolute;left:63.87px;top:271.98px" class="cls_004"><span class="cls_004">pline on memory, such as rigidly defined object layouts and prohibitions against arbitrary</span></div>
<div style="position:absolute;left:63.87px;top:283.93px" class="cls_004"><span class="cls_004">pointer formation, to enable features such as garbage collection and pointer safety. The</span></div>
<div style="position:absolute;left:63.87px;top:295.89px" class="cls_004"><span class="cls_004">idea is that by establishing a mapping between notions in the two fields, solutions from</span></div>
<div style="position:absolute;left:63.87px;top:307.84px" class="cls_004"><span class="cls_004">one field carry over to the other. In particular, the techniques used in conservative garbage</span></div>
<div style="position:absolute;left:63.87px;top:319.80px" class="cls_004"><span class="cls_004">collection serve as a sort of apologia for the hash scanning approach used to find runtime</span></div>
<div style="position:absolute;left:63.87px;top:331.75px" class="cls_004"><span class="cls_004">dependencies.</span></div>
<div style="position:absolute;left:63.87px;top:361.84px" class="cls_011"><span class="cls_011">3.1. What is a component?</span></div>
<div style="position:absolute;left:63.87px;top:387.05px" class="cls_004"><span class="cls_004">It is useful to first say some things about what it is that we are deploying.  Of course,</span></div>
<div style="position:absolute;left:63.87px;top:399.01px" class="cls_004"><span class="cls_004">we deploy software (although in Chapter 9 on service deployment, we will also see some</span></div>
<div style="position:absolute;left:63.87px;top:410.96px" class="cls_004"><span class="cls_004">things being deployed that cannot be called software proper), but what are the units of</span></div>
<div style="position:absolute;left:63.87px;top:422.92px" class="cls_004"><span class="cls_004">deployment? That is, what do we call the smallest meaningful artifacts that are subject to</span></div>
<div style="position:absolute;left:63.87px;top:434.87px" class="cls_004"><span class="cls_004">deployment? It is quite customary in some communities to call these packages, but this</span></div>
<div style="position:absolute;left:63.87px;top:446.83px" class="cls_004"><span class="cls_004">term has the problem that it implies that the artifact is in packaged form. For instance, a</span></div>
<div style="position:absolute;left:63.87px;top:458.78px" class="cls_007"><span class="cls_007">.RPM</span><span class="cls_004"> file is a package, but what do we call the corresponding installed object? In RPM</span></div>
<div style="position:absolute;left:63.87px;top:470.74px" class="cls_004"><span class="cls_004">terminology, this is also a package, and so the term is ambiguous.</span></div>
<div style="position:absolute;left:73.84px;top:482.69px" class="cls_004"><span class="cls_004">In the Component-Based Software Engineering (CBSE) community, the term compo-</span></div>
<div style="position:absolute;left:63.87px;top:494.65px" class="cls_004"><span class="cls_004">nent is used for units of deployment. Like some other terms in computer science (such as</span></div>
<div style="position:absolute;left:63.87px;top:506.60px" class="cls_004"><span class="cls_004">object), this term is overloaded almost to the point of uselessness. In fact, Czyperski [154,</span></div>
<div style="position:absolute;left:63.87px;top:518.56px" class="cls_004"><span class="cls_004">Chapter 11] surveys fourteen different definitions. Some definitions are not meaningfully</span></div>
<div style="position:absolute;left:63.87px;top:530.52px" class="cls_004"><span class="cls_004">distinguishable from the notion of a module, or are used to identify any code reuse mech-</span></div>
<div style="position:absolute;left:63.87px;top:542.47px" class="cls_004"><span class="cls_004">anism.</span></div>
<div style="position:absolute;left:73.84px;top:554.43px" class="cls_004"><span class="cls_004">Despite the multitude of definitions, I shall use the term anyway, because I believe that</span></div>
<div style="position:absolute;left:63.87px;top:566.38px" class="cls_004"><span class="cls_004">the essential aspect that should be captured by a definition of components is deployment.</span></div>
<div style="position:absolute;left:68.36px;top:584.11px" class="cls_013"><span class="cls_013"><sup>1</sup></span><span class="cls_014">Indeed, no Linux distribution based on Nix will ever be compliant with the Linux Standards Base [82, 81]!</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">49</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:37950px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background058.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">3. Deployment as Memory Management</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">Otherwise, the notion of component does not essentially add anything not already provided</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">by concepts such as module, class, method, function, and other organisational structures</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">provided by programming languages.  Components in CBSE have many other concerns</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">than deployment aspects, such as interfaces, contracts, composition techniques, verifica-</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">tion of performance and other extra-functional requirements, and so on. However, a dis-</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">cussion at CBSE-2005 revealed that packaging and deployment were the only aspects on</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">which there was a consensus that they should be provided by a component-based system.</span></div>
<div style="position:absolute;left:69.68px;top:128.73px" class="cls_004"><span class="cls_004">In this thesis, I will use the following definition of “software component”:</span></div>
<div style="position:absolute;left:74.66px;top:147.99px" class="cls_004"><span class="cls_004">• A software component is a software artifact that is subject to automatic composition.</span></div>
<div style="position:absolute;left:84.62px;top:159.94px" class="cls_004"><span class="cls_004">It can require, and be required by, other components.</span></div>
<div style="position:absolute;left:74.66px;top:179.54px" class="cls_004"><span class="cls_004">• A software component is a unit of deployment.</span></div>
<div style="position:absolute;left:59.72px;top:198.80px" class="cls_004"><span class="cls_004">The first property is of course entailed by the etymology of the word component, except</span></div>
<div style="position:absolute;left:59.72px;top:210.75px" class="cls_004"><span class="cls_004">for the stipulation that a composition can be established automatically. Thus, source code</span></div>
<div style="position:absolute;left:59.72px;top:222.71px" class="cls_004"><span class="cls_004">fragments printed in a book, while composable through human intervention, are not com-</span></div>
<div style="position:absolute;left:59.72px;top:234.66px" class="cls_004"><span class="cls_004">ponents. The second property implies that the purpose of the notion of a component is to</span></div>
<div style="position:absolute;left:59.72px;top:246.62px" class="cls_004"><span class="cls_004">be the principal object of deployment.</span></div>
<div style="position:absolute;left:69.68px;top:258.57px" class="cls_004"><span class="cls_004">This definition has some important implications.  For instance, it does not say any-</span></div>
<div style="position:absolute;left:59.72px;top:270.53px" class="cls_004"><span class="cls_004">thing about whether components are in “source” or “binary” form, since such a distinction</span></div>
<div style="position:absolute;left:59.72px;top:282.48px" class="cls_004"><span class="cls_004">is rather technology-specific (e.g., what does it mean for interpreted languages such as</span></div>
<div style="position:absolute;left:59.72px;top:294.44px" class="cls_004"><span class="cls_004">Python?). But since it has to be automatically composable, it must come with all the nec-</span></div>
<div style="position:absolute;left:59.72px;top:306.39px" class="cls_004"><span class="cls_004">essary infrastructure to support automatic composition. For instance, mere source code is</span></div>
<div style="position:absolute;left:59.72px;top:318.35px" class="cls_004"><span class="cls_004">not a component, but source code with the necessary meta-information—such as Make-</span></div>
<div style="position:absolute;left:59.72px;top:330.30px" class="cls_004"><span class="cls_004">files, configuration and build scripts, deployment descriptors, and so on—is a component.</span></div>
<div style="position:absolute;left:59.72px;top:342.26px" class="cls_004"><span class="cls_004">So a Python source file in itself is not a component. But it is when placed in an RPM pack-</span></div>
<div style="position:absolute;left:59.72px;top:354.21px" class="cls_004"><span class="cls_004">age or combined with a Nix expression, since that meta-information makes the component</span></div>
<div style="position:absolute;left:59.72px;top:366.17px" class="cls_004"><span class="cls_004">available for automatic composition.</span></div>
<div style="position:absolute;left:69.68px;top:378.12px" class="cls_004"><span class="cls_004">A subtle point is what we mean by “software.” Of course, software is a specification that</span></div>
<div style="position:absolute;left:59.72px;top:390.08px" class="cls_004"><span class="cls_004">can be executed automatically by a computer (possibly with the aid of other software, such</span></div>
<div style="position:absolute;left:59.72px;top:402.03px" class="cls_004"><span class="cls_004">as an interpreter), but not every constituent part of a software system is executable; some</span></div>
<div style="position:absolute;left:59.72px;top:413.99px" class="cls_004"><span class="cls_004">of it (such as data) is an adjunct to execution. This means that not all software components</span></div>
<div style="position:absolute;left:59.72px;top:425.94px" class="cls_004"><span class="cls_004">need to contain executable code themselves, but are intended for ultimate composition with</span></div>
<div style="position:absolute;left:59.72px;top:437.90px" class="cls_004"><span class="cls_004">an executable component that uses them. For instance, in a software system with an online</span></div>
<div style="position:absolute;left:59.72px;top:449.85px" class="cls_004"><span class="cls_004">help feature, it might be useful to split off the online help into a separate component so that</span></div>
<div style="position:absolute;left:59.72px;top:461.81px" class="cls_004"><span class="cls_004">it can be installed optionally.</span></div>
<div style="position:absolute;left:69.68px;top:473.77px" class="cls_004"><span class="cls_004">The definition above can be considered the greatest common denominator of a number</span></div>
<div style="position:absolute;left:59.72px;top:485.72px" class="cls_004"><span class="cls_004">of influential definitions. Czyperski [154, Section 4.1.5] gives the following definition:</span></div>
<div style="position:absolute;left:94.59px;top:506.81px" class="cls_004"><span class="cls_004">“A software component is a unit of composition with contractually specified</span></div>
<div style="position:absolute;left:84.62px;top:518.76px" class="cls_004"><span class="cls_004">interfaces and explicit context dependencies only. A software component can</span></div>
<div style="position:absolute;left:84.62px;top:530.72px" class="cls_004"><span class="cls_004">be deployed independently and is subject to composition by third parties.”</span></div>
<div style="position:absolute;left:69.68px;top:551.81px" class="cls_004"><span class="cls_004">The important aspects of this definition are the following:</span></div>
<div style="position:absolute;left:74.66px;top:571.07px" class="cls_004"><span class="cls_004">• A component is a unit of independent deployment. Since it is a unit, it does not</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">have to support partial deployment—the component must be deployed in its entirety.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">50</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:38640px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background059.jpg" width=481 height=680></div>
<div style="position:absolute;left:313.43px;top:17.14px" class="cls_004"><span class="cls_004">3.1. What is a component?</span></div>
<div style="position:absolute;left:88.78px;top:45.04px" class="cls_004"><span class="cls_004">Since it is independently deployable, it should not cause interference with its target</span></div>
<div style="position:absolute;left:88.78px;top:56.99px" class="cls_004"><span class="cls_004">environment, such as other components.</span></div>
<div style="position:absolute;left:78.82px;top:76.56px" class="cls_004"><span class="cls_004">• Thus it must have explicit context dependencies only, since otherwise it would place</span></div>
<div style="position:absolute;left:88.78px;top:88.51px" class="cls_004"><span class="cls_004">requirements (such as component dependencies) on its target environment that are</span></div>
<div style="position:absolute;left:88.78px;top:100.47px" class="cls_004"><span class="cls_004">not formally specified by its deployment metadata.</span></div>
<div style="position:absolute;left:78.82px;top:120.03px" class="cls_004"><span class="cls_004">• It has contractually specified interfaces, which enable it to be subject to third-party</span></div>
<div style="position:absolute;left:88.78px;top:131.99px" class="cls_004"><span class="cls_004">composition, i.e., it is possible for other people’s components to use the component.</span></div>
<div style="position:absolute;left:78.82px;top:151.55px" class="cls_004"><span class="cls_004">• It has no externally observable state.  Different uses of the component over time</span></div>
<div style="position:absolute;left:88.78px;top:163.50px" class="cls_004"><span class="cls_004">should not interfere with each other. Note that this does not mean that the code of</span></div>
<div style="position:absolute;left:88.78px;top:175.46px" class="cls_004"><span class="cls_004">the component must have no side effects, i.e., should be written in a purely func-</span></div>
<div style="position:absolute;left:88.78px;top:187.41px" class="cls_004"><span class="cls_004">tional language. It is perfectly fine for an execution involving the component, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:199.37px" class="cls_004"><span class="cls_004">the classes and objects loaded from a component, to have side effects. But the com-</span></div>
<div style="position:absolute;left:88.78px;top:211.32px" class="cls_004"><span class="cls_004">ponent should not modify its on-disk representation or other static resources in a way</span></div>
<div style="position:absolute;left:88.78px;top:223.28px" class="cls_004"><span class="cls_004">that affects future uses of the component. This is exactly the case with Nix compo-</span></div>
<div style="position:absolute;left:88.78px;top:235.24px" class="cls_004"><span class="cls_004">nents: they can be entirely impure dynamically, but their static representation—the</span></div>
<div style="position:absolute;left:88.78px;top:247.19px" class="cls_004"><span class="cls_004">files on disk—never changes after they have been built.</span></div>
<div style="position:absolute;left:73.84px;top:266.39px" class="cls_004"><span class="cls_004">These properties do not always hold for the things that one might want to deploy. For</span></div>
<div style="position:absolute;left:63.87px;top:278.35px" class="cls_004"><span class="cls_004">instance, Mozilla Firefox 1.0 (unless specially prodded not to do so) wants to make modifi-</span></div>
<div style="position:absolute;left:63.87px;top:290.30px" class="cls_004"><span class="cls_004">cations to some of its own files when started for the first time, violating the requirement of</span></div>
<div style="position:absolute;left:63.87px;top:302.26px" class="cls_004"><span class="cls_004">having no externally observable state. This is bad because it makes security difficult (the</span></div>
<div style="position:absolute;left:63.87px;top:314.21px" class="cls_004"><span class="cls_004">files in question should be writable by all potential users), and hinders proper identification</span></div>
<div style="position:absolute;left:63.87px;top:326.17px" class="cls_004"><span class="cls_004">in the sense of configuration management (since the “same” component has different con-</span></div>
<div style="position:absolute;left:63.87px;top:338.12px" class="cls_004"><span class="cls_004">tents over time). Likewise, many components are not intended for third-party composition,</span></div>
<div style="position:absolute;left:63.87px;top:350.08px" class="cls_004"><span class="cls_004">but are rather specifically tied to certain other components and do not have a well-defined</span></div>
<div style="position:absolute;left:63.87px;top:362.03px" class="cls_004"><span class="cls_004">interface. The reason why such components are separate, rather than combined into a sin-</span></div>
<div style="position:absolute;left:63.87px;top:373.99px" class="cls_004"><span class="cls_004">gle component, is typically to allow optional functionality to be omitted, or for licensing</span></div>
<div style="position:absolute;left:63.87px;top:385.94px" class="cls_004"><span class="cls_004">reasons (e.g., some clients not being entitled to access the full feature set of a system).</span></div>
<div style="position:absolute;left:73.84px;top:397.90px" class="cls_004"><span class="cls_004">This thesis’s definition differs from Czyperski’s in a number of ways:</span></div>
<div style="position:absolute;left:78.82px;top:417.10px" class="cls_004"><span class="cls_004">• It does not require explicit context dependencies, it merely states that components</span></div>
<div style="position:absolute;left:88.78px;top:429.05px" class="cls_004"><span class="cls_004">can have dependencies.  Many components have implicit dependencies—which is</span></div>
<div style="position:absolute;left:88.78px;top:441.01px" class="cls_004"><span class="cls_004">what makes correct deployment so difficult.  Of course, to ensure correct deploy-</span></div>
<div style="position:absolute;left:88.78px;top:452.96px" class="cls_004"><span class="cls_004">ment, it is necessary to make implicit dependencies explicit.</span></div>
<div style="position:absolute;left:78.82px;top:472.53px" class="cls_004"><span class="cls_004">• It does not require the possibility of third-party composition. As explained above,</span></div>
<div style="position:absolute;left:88.78px;top:484.48px" class="cls_004"><span class="cls_004">many components are not in fact usefully reusable by third parties.</span></div>
<div style="position:absolute;left:78.82px;top:504.05px" class="cls_004"><span class="cls_004">• It does not require contractually specified interfaces. It is enough for components to</span></div>
<div style="position:absolute;left:88.78px;top:516.00px" class="cls_004"><span class="cls_004">be composable automatically, which requires some kind of formal interface (since</span></div>
<div style="position:absolute;left:88.78px;top:527.96px" class="cls_004"><span class="cls_004">it can be used automatically), but this can be as weak as a symbol table in an ELF</span></div>
<div style="position:absolute;left:88.78px;top:539.91px" class="cls_004"><span class="cls_004">library [160], or the existence of a named function in a Perl module.</span></div>
<div style="position:absolute;left:73.84px;top:559.11px" class="cls_004"><span class="cls_004">Czarnecki and Eisenecker [40] have an even more minimalistic definition: components</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">are simply the “building blocks” of software systems that should be composable as easily</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">and flexibly as possible in order to maximise reuse and minimise duplication. However,</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">51</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:39330px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background060.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">3. Deployment as Memory Management</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">this definition has the problem that it makes a component nothing more than a general term</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">for reuse mechanisms, as stated above. This is intentional: the authors feel that component</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">is a “natural concept” for which it is hard to give a rigid definition. But a definition that is</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">overly broad is not very useful.</span></div>
<div style="position:absolute;left:69.68px;top:92.94px" class="cls_004"><span class="cls_004">Meyer [119] defines a component as a “modular unit” that can be used by other compo-</span></div>
<div style="position:absolute;left:59.72px;top:104.89px" class="cls_004"><span class="cls_004">nents, possesses an “official usage description” enabling its use by other components, and</span></div>
<div style="position:absolute;left:59.72px;top:116.85px" class="cls_004"><span class="cls_004">is not “tied to any fixed set of clients”. The definition used here does not have the latter</span></div>
<div style="position:absolute;left:59.72px;top:128.80px" class="cls_004"><span class="cls_004">two requirements (many components have poorly defined or missing usage descriptions,</span></div>
<div style="position:absolute;left:59.72px;top:140.76px" class="cls_004"><span class="cls_004">or are specific to a particular client, as argued above).</span></div>
<div style="position:absolute;left:69.68px;top:152.79px" class="cls_004"><span class="cls_004">So the definition of component used in this thesis is quite minimal. I do not mean to</span></div>
<div style="position:absolute;left:59.72px;top:164.74px" class="cls_004"><span class="cls_004">imply that a stronger notion of component is not useful or appropriate in many cases. For</span></div>
<div style="position:absolute;left:59.72px;top:176.70px" class="cls_004"><span class="cls_004">instance, component technologies that require strong contracts from components are very</span></div>
<div style="position:absolute;left:59.72px;top:188.65px" class="cls_004"><span class="cls_004">valuable. But such kinds of “high level” composition aspects are not the subject of this</span></div>
<div style="position:absolute;left:59.72px;top:200.61px" class="cls_004"><span class="cls_004">thesis. This thesis is about the “low level” aspect of storage of components: how can we</span></div>
<div style="position:absolute;left:59.72px;top:212.56px" class="cls_004"><span class="cls_004">store components so that they do not interfere with each other, that their dependencies are</span></div>
<div style="position:absolute;left:59.72px;top:224.52px" class="cls_004"><span class="cls_004">known, and so on? That is, it is about components in the file system.</span></div>
<div style="position:absolute;left:59.72px;top:251.46px" class="cls_009"><span class="cls_009">Components in the file system</span><span class="cls_004">   In this thesis, I shall further restrict the notion of a</span></div>
<div style="position:absolute;left:59.72px;top:263.41px" class="cls_004"><span class="cls_004">software component to things that have an independent representation in the file system,</span></div>
<div style="position:absolute;left:59.72px;top:275.37px" class="cls_004"><span class="cls_004">i.e., a component consists of a set of files. Of course components do not have to exist as</span></div>
<div style="position:absolute;left:59.72px;top:287.32px" class="cls_004"><span class="cls_004">discrete objects in the file system. They might be stored in a database (as suggested, e.g.,</span></div>
<div style="position:absolute;left:59.72px;top:299.28px" class="cls_004"><span class="cls_004">by the Java Language Specification [79, Section 7.2.2]). But this is quite rare, so we will</span></div>
<div style="position:absolute;left:59.72px;top:311.23px" class="cls_004"><span class="cls_004">not consider it.</span></div>
<div style="position:absolute;left:69.68px;top:323.26px" class="cls_004"><span class="cls_004">Through the file system, components can require functionality from other components,</span></div>
<div style="position:absolute;left:59.72px;top:335.22px" class="cls_004"><span class="cls_004">and they can provide it.  Thus, components need to be plugged into each other, i.e., be</span></div>
<div style="position:absolute;left:59.72px;top:347.17px" class="cls_004"><span class="cls_004">composed.  There are many mechanisms by which a composition can be realised, such</span></div>
<div style="position:absolute;left:59.72px;top:359.13px" class="cls_004"><span class="cls_004">as static linking, dynamic linking, inclusion of source files, and so on; and these are just</span></div>
<div style="position:absolute;left:59.72px;top:371.08px" class="cls_004"><span class="cls_004">general classes of composition technologies. Concrete realisation mechanisms are legion:</span></div>
<div style="position:absolute;left:59.72px;top:383.04px" class="cls_004"><span class="cls_004">Unix static libraries, ELF dynamic libraries, Java JAR files, C preprocessor directives,</span></div>
<div style="position:absolute;left:59.72px;top:394.99px" class="cls_004"><span class="cls_004">.NET assemblies, Perl modules, configuration files, etc.  These mechanisms also have</span></div>
<div style="position:absolute;left:59.72px;top:406.95px" class="cls_004"><span class="cls_004">various binding times: some are typically used at build time, others at runtime, with the</span></div>
<div style="position:absolute;left:59.72px;top:418.90px" class="cls_004"><span class="cls_004">more nebulous notions of packaging time and installation time thrown in for good measure.</span></div>
<div style="position:absolute;left:69.68px;top:430.93px" class="cls_004"><span class="cls_004">But what they all have in common is that the composition must be established in the</span></div>
<div style="position:absolute;left:59.72px;top:442.89px" class="cls_004"><span class="cls_004">file system.  That is, since the components exist in the file system, to compose them,</span></div>
<div style="position:absolute;left:59.72px;top:454.84px" class="cls_004"><span class="cls_004">the composition mechanism must be able to find them in the file system. This aspect of</span></div>
<div style="position:absolute;left:59.72px;top:466.80px" class="cls_004"><span class="cls_004">composition—establishing the “physical” composition,” so to speak—is often overlooked</span></div>
<div style="position:absolute;left:59.72px;top:478.75px" class="cls_004"><span class="cls_004">in the component-based software engineering literature as well as in programming sys-</span></div>
<div style="position:absolute;left:59.72px;top:490.71px" class="cls_004"><span class="cls_004">tems. This is unfortunate, since the difficulty in correctly and efficiently establishing and</span></div>
<div style="position:absolute;left:59.72px;top:502.67px" class="cls_004"><span class="cls_004">managing the composition in the file system is the major source of deployment problems.</span></div>
<div style="position:absolute;left:59.72px;top:533.75px" class="cls_011"><span class="cls_011">3.2. The file system as memory</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">In this section I recast the deployment problems identified in the introduction in terms of</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">concepts from the domain of memory management in programming languages. That we</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">can do this is not surprising: after all, file systems on the one hand and RAM on the other</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">52</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:40020px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background061.jpg" width=481 height=680></div>
<div style="position:absolute;left:294.88px;top:17.14px" class="cls_004"><span class="cls_004">3.2. The file system as memory</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">hand are just two different levels in the storage hierarchy.  Where programs manipulate</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">memory cells, deployment operations manipulate the file system. This analogy reveals that</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">the safeguards against abuse of memory applied by programming languages are absent in</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">deployment, and suggests that we can make deployment safe by trying to impose similar</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">safeguards.</span></div>
<div style="position:absolute;left:73.84px;top:105.25px" class="cls_004"><span class="cls_004">Components, as defined above, exist in the file system and can be accessed through</span></div>
<div style="position:absolute;left:63.87px;top:117.20px" class="cls_004"><span class="cls_004">paths, sequences of file names that specify a traversal through the directory hierarchy,</span></div>
<div style="position:absolute;left:63.87px;top:129.16px" class="cls_004"><span class="cls_004">such as</span><span class="cls_007"> /usr/bin/gcc</span><span class="cls_004">. We can view a path as an address. Then a string representing a path</span></div>
<div style="position:absolute;left:63.87px;top:141.11px" class="cls_004"><span class="cls_004">is a pointer, and accessing a file through a path is a pointer dereference. Thus, component</span></div>
<div style="position:absolute;left:63.87px;top:153.07px" class="cls_004"><span class="cls_004">interference due to file overwriting can be viewed as an address collision problem: two</span></div>
<div style="position:absolute;left:63.87px;top:165.02px" class="cls_004"><span class="cls_004">components occupy overlapping parts of the address space.</span></div>
<div style="position:absolute;left:73.84px;top:177.41px" class="cls_004"><span class="cls_004">Furthermore, we can view components as representations of values or objects. Just as</span></div>
<div style="position:absolute;left:63.87px;top:189.37px" class="cls_004"><span class="cls_004">objects in a programming language can have references to other objects, so components</span></div>
<div style="position:absolute;left:63.87px;top:201.32px" class="cls_004"><span class="cls_004">can have references to other components. If dereferencing a pointer is not possible because</span></div>
<div style="position:absolute;left:63.87px;top:213.28px" class="cls_004"><span class="cls_004">a file does not exist, we have the deployment equivalent of a dangling pointer.</span></div>
<div style="position:absolute;left:73.84px;top:225.66px" class="cls_004"><span class="cls_004">A component A is dependent on a component B if the set of files that constitutes A</span></div>
<div style="position:absolute;left:63.87px;top:237.62px" class="cls_004"><span class="cls_004">enables an execution involving A to dereference pointers to the files constituting B.  It</span></div>
<div style="position:absolute;left:63.87px;top:249.57px" class="cls_004"><span class="cls_004">enables an execution to dereference B (rather than that it necessarily must dereference B),</span></div>
<div style="position:absolute;left:63.87px;top:261.53px" class="cls_004"><span class="cls_004">since A itself might not be executed or even be executable; e.g., when A is a configuration</span></div>
<div style="position:absolute;left:63.87px;top:273.48px" class="cls_004"><span class="cls_004">file containing a path to B, and this file is read by some other component C.</span></div>
<div style="position:absolute;left:73.84px;top:285.87px" class="cls_004"><span class="cls_004">For example, suppose that we have an application that is dynamically linked against a</span></div>
<div style="position:absolute;left:63.87px;top:297.83px" class="cls_004"><span class="cls_004">file</span><span class="cls_007"> /lib/libc.so</span><span class="cls_004">, the GNU C library on Linux systems. This means that the executable image</span></div>
<div style="position:absolute;left:63.87px;top:309.78px" class="cls_004"><span class="cls_004">of the application contains an instruction to the dynamic linker to load the file</span><span class="cls_007"> /lib/libc.so</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:321.74px" class="cls_004"><span class="cls_004">Thus, the application enables a pointer to that file, since execution of the application will</span></div>
<div style="position:absolute;left:63.87px;top:333.69px" class="cls_004"><span class="cls_004">cause a dereference of that file when it is started. But if the file is missing, the deployed</span></div>
<div style="position:absolute;left:63.87px;top:345.65px" class="cls_004"><span class="cls_004">application contains a dangling pointer. Such dangling pointers are the result of incomplete</span></div>
<div style="position:absolute;left:63.87px;top:357.60px" class="cls_004"><span class="cls_004">deployment, and they must be prevented.</span></div>
<div style="position:absolute;left:73.84px;top:369.99px" class="cls_004"><span class="cls_004">To prevent dangling pointers, we should consider the various ways through which a</span></div>
<div style="position:absolute;left:63.87px;top:381.94px" class="cls_004"><span class="cls_004">component A can cause a dereference of a pointer to another component B. Since compo-</span></div>
<div style="position:absolute;left:63.87px;top:393.90px" class="cls_004"><span class="cls_004">nents are analogous to objects, we can provide analogues to the ways in which a method</span></div>
<div style="position:absolute;left:63.87px;top:405.85px" class="cls_004"><span class="cls_004">of a class can obtain and dereference a pointer to another object.</span></div>
<div style="position:absolute;left:73.84px;top:418.24px" class="cls_004"><span class="cls_004">First, a pointer to B can be obtained and dereferenced by A at runtime. This is a form</span></div>
<div style="position:absolute;left:63.87px;top:430.20px" class="cls_004"><span class="cls_004">of late binding, since the pointer is not passed in when it is built, but rather when it is</span></div>
<div style="position:absolute;left:63.87px;top:442.15px" class="cls_004"><span class="cls_004">executed.  This may happen through environment variables (such as the</span><span class="cls_007"> PATH</span><span class="cls_004"> program</span></div>
<div style="position:absolute;left:63.87px;top:454.11px" class="cls_004"><span class="cls_004">search path on Windows and Unix), program arguments, function arguments (in the case</span></div>
<div style="position:absolute;left:63.87px;top:466.06px" class="cls_004"><span class="cls_004">of a library), registry settings, user interaction, and so on. Conceptually, this is similar to</span></div>
<div style="position:absolute;left:63.87px;top:478.02px" class="cls_004"><span class="cls_004">the following pseudo-Java:</span></div>
<div style="position:absolute;left:93.76px;top:500.36px" class="cls_004"><span class="cls_004">class</span><span class="cls_007"> Foo</span><span class="cls_004"> {</span></div>
<div style="position:absolute;left:108.71px;top:512.32px" class="cls_007"><span class="cls_007">Foo</span><span class="cls_004">() {}</span></div>
<div style="position:absolute;left:108.71px;top:524.28px" class="cls_004"><span class="cls_004">int</span><span class="cls_007"> run</span><span class="cls_004">(</span><span class="cls_007">Bar</span><span class="cls_004"> y) { return y.</span><span class="cls_007">doIt</span><span class="cls_004">(); }</span></div>
<div style="position:absolute;left:93.76px;top:536.23px" class="cls_004"><span class="cls_004">}</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">We can consider the constructor method</span><span class="cls_007"> Foo</span><span class="cls_004">() to be the build time of the objects of class</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_007"><span class="cls_007">Foo</span><span class="cls_004">, while the method</span><span class="cls_007"> run</span><span class="cls_004"> corresponds to the runtime. Thus any arguments passed to the</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">constructor are analogous to build-time dependencies, while arguments passed to</span><span class="cls_007"> run</span><span class="cls_004"> are</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">53</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:40710px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background062.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">3. Deployment as Memory Management</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">analogous to runtime dependencies. In this case, an instance of</span><span class="cls_007"> Foo</span><span class="cls_004"> obtains a pointer to an</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">instance of</span><span class="cls_007"> Bar</span><span class="cls_004"> at runtime.</span></div>
<div style="position:absolute;left:69.68px;top:68.95px" class="cls_004"><span class="cls_004">Second, a pointer to B can be obtained and dereferenced by A at build time.  In this</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">case, a pointer is passed in at build-time and is completely “consumed”, meaning that B is</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">not needed subsequently. It can therefore no longer cause a dangling pointer. Examples</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">include pointers to static libraries or the compiler, which are not usually retained in the</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">result. This is comparable to a constructor that uses a pointer to another object to compute</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">some derived value but that does not store the pointer itself:</span></div>
<div style="position:absolute;left:89.60px;top:147.26px" class="cls_004"><span class="cls_004">class</span><span class="cls_007"> Foo</span><span class="cls_004"> {</span></div>
<div style="position:absolute;left:104.55px;top:159.22px" class="cls_004"><span class="cls_004">int x;</span></div>
<div style="position:absolute;left:104.55px;top:171.18px" class="cls_007"><span class="cls_007">Foo</span><span class="cls_004">(</span><span class="cls_007">Bar</span><span class="cls_004"> y) { x = y.</span><span class="cls_007">doIt</span><span class="cls_004">(); }</span></div>
<div style="position:absolute;left:104.55px;top:183.13px" class="cls_004"><span class="cls_004">int</span><span class="cls_007"> run</span><span class="cls_004">() { return x; }</span></div>
<div style="position:absolute;left:89.60px;top:195.09px" class="cls_004"><span class="cls_004">}</span></div>
<div style="position:absolute;left:69.68px;top:213.44px" class="cls_004"><span class="cls_004">Third, a pointer to B can be obtained by A at build time and dereferenced at runtime.</span></div>
<div style="position:absolute;left:59.72px;top:225.40px" class="cls_004"><span class="cls_004">In this case, a pointer to B is passed to and saved in the build process that constructed A,</span></div>
<div style="position:absolute;left:59.72px;top:237.35px" class="cls_004"><span class="cls_004">and is dereferenced during program execution. This is the notion of retained dependencies</span></div>
<div style="position:absolute;left:59.72px;top:249.31px" class="cls_004"><span class="cls_004">described on page 23. It happens often with Unix-style dynamically linked libraries: the</span></div>
<div style="position:absolute;left:59.72px;top:261.26px" class="cls_004"><span class="cls_004">build of an application stores the full path to the library in the</span><span class="cls_007"> RPATH</span><span class="cls_004"> of the application</span></div>
<div style="position:absolute;left:59.72px;top:273.22px" class="cls_004"><span class="cls_004">binary (see page 23), which is used to locate the library at program startup. This is equiv-</span></div>
<div style="position:absolute;left:59.72px;top:285.17px" class="cls_004"><span class="cls_004">alent to the constructor of an object storing a pointer that was passed in, which is later</span></div>
<div style="position:absolute;left:59.72px;top:297.13px" class="cls_004"><span class="cls_004">dereferenced:</span></div>
<div style="position:absolute;left:89.60px;top:313.61px" class="cls_004"><span class="cls_004">class</span><span class="cls_007"> Foo</span><span class="cls_004"> {</span></div>
<div style="position:absolute;left:104.55px;top:325.56px" class="cls_007"><span class="cls_007">Bar</span><span class="cls_004"> x;</span></div>
<div style="position:absolute;left:104.55px;top:337.52px" class="cls_007"><span class="cls_007">Foo</span><span class="cls_004">(</span><span class="cls_007">Bar</span><span class="cls_004"> y) { x = y; }</span></div>
<div style="position:absolute;left:104.55px;top:349.47px" class="cls_004"><span class="cls_004">int</span><span class="cls_007"> run</span><span class="cls_004">() { return x.</span><span class="cls_007">doIt</span><span class="cls_004">(); }</span></div>
<div style="position:absolute;left:89.60px;top:361.43px" class="cls_004"><span class="cls_004">}</span></div>
<div style="position:absolute;left:59.72px;top:379.78px" class="cls_004"><span class="cls_004">Here, the execution of the constructor is similar to the construction of a component, and</span></div>
<div style="position:absolute;left:59.72px;top:391.74px" class="cls_004"><span class="cls_004">the execution of method</span><span class="cls_007"> run()</span><span class="cls_004"> is similar to the use of a component.</span></div>
<div style="position:absolute;left:69.68px;top:403.69px" class="cls_004"><span class="cls_004">Finally, and orthogonal to the previous methods, a pointer to B can be obtained using</span></div>
<div style="position:absolute;left:59.72px;top:415.65px" class="cls_004"><span class="cls_004">pointer arithmetic. Since paths are represented as strings, any form of string manipulation</span></div>
<div style="position:absolute;left:59.72px;top:427.60px" class="cls_004"><span class="cls_004">such as concatenation may be used to obtain new paths. If we have a pointer to</span><span class="cls_007"> /usr/bin</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:59.72px;top:439.56px" class="cls_004"><span class="cls_004">then we may append the string</span><span class="cls_007"> gcc</span><span class="cls_004"> to obtain</span><span class="cls_007"> /usr/bin/gcc</span><span class="cls_004">. Note that the names to be ap-</span></div>
<div style="position:absolute;left:59.72px;top:451.52px" class="cls_004"><span class="cls_004">pended may be obtained by dereferencing directories, that is, reading their contents.</span></div>
<div style="position:absolute;left:69.68px;top:463.47px" class="cls_004"><span class="cls_004">It follows from the above that it is hard to find the set of pointers that can be dereferenced</span></div>
<div style="position:absolute;left:59.72px;top:475.43px" class="cls_004"><span class="cls_004">by a component. First, pointers may already be present in the source. Second, pointers</span></div>
<div style="position:absolute;left:59.72px;top:487.38px" class="cls_004"><span class="cls_004">passed in at build-time may or may not be stored in the component. Obviously, we do not</span></div>
<div style="position:absolute;left:59.72px;top:499.34px" class="cls_004"><span class="cls_004">want to distribute a compiler along with an application just because it was used to build</span></div>
<div style="position:absolute;left:59.72px;top:511.29px" class="cls_004"><span class="cls_004">it—but other build-time components, such as dynamic libraries, should be. Finally, pointer</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">arithmetic can be used to obtain new pointers in uncontrolled ways. For correct software</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">deployment it is essential that no dangling pointers can occur. Thus, we need a method to</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">prevent these.</span></div>
<div style="position:absolute;left:69.68px;top:559.11px" class="cls_004"><span class="cls_004">Figure 3.1 summarises the mapping of concepts between the domain of memory man-</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">agement in programming language implementation on the one hand, and deployment on</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">the other hand. (The third set of correspondences is first discussed in Section 3.4.)</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">54</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:41400px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background063.jpg" width=481 height=680></div>
<div style="position:absolute;left:367.38px;top:17.14px" class="cls_004"><span class="cls_004">3.3. Closures</span></div>
<div style="position:absolute;left:88.80px;top:43.84px" class="cls_004"><span class="cls_004">Programming Language Domain</span></div>
<div style="position:absolute;left:259.96px;top:43.84px" class="cls_004"><span class="cls_004">Deployment Domain</span></div>
<div style="position:absolute;left:223.38px;top:58.59px" class="cls_004"><span class="cls_004">Concepts</span></div>
<div style="position:absolute;left:192.88px;top:70.94px" class="cls_004"><span class="cls_004">memory</span></div>
<div style="position:absolute;left:238.04px;top:70.94px" class="cls_004"><span class="cls_004">⇔  disk</span></div>
<div style="position:absolute;left:163.53px;top:82.90px" class="cls_004"><span class="cls_004">objects (values)</span></div>
<div style="position:absolute;left:238.04px;top:82.90px" class="cls_004"><span class="cls_004">⇔  components</span></div>
<div style="position:absolute;left:187.91px;top:94.85px" class="cls_004"><span class="cls_004">addresses</span></div>
<div style="position:absolute;left:238.04px;top:94.85px" class="cls_004"><span class="cls_004">⇔  path names</span></div>
<div style="position:absolute;left:148.92px;top:106.81px" class="cls_004"><span class="cls_004">pointer dereference</span></div>
<div style="position:absolute;left:238.04px;top:106.81px" class="cls_004"><span class="cls_004">⇔  I/O</span></div>
<div style="position:absolute;left:154.97px;top:118.76px" class="cls_004"><span class="cls_004">pointer arithmetic</span></div>
<div style="position:absolute;left:238.04px;top:118.76px" class="cls_004"><span class="cls_004">⇔  string operations</span></div>
<div style="position:absolute;left:160.50px;top:130.72px" class="cls_004"><span class="cls_004">dangling pointer</span></div>
<div style="position:absolute;left:238.04px;top:130.72px" class="cls_004"><span class="cls_004">⇔  reference to absent component</span></div>
<div style="position:absolute;left:176.56px;top:142.67px" class="cls_004"><span class="cls_004">object graph</span></div>
<div style="position:absolute;left:238.04px;top:142.67px" class="cls_004"><span class="cls_004">⇔  dependency graph</span></div>
<div style="position:absolute;left:195.42px;top:155.03px" class="cls_004"><span class="cls_004">Kinds of dependencies</span></div>
<div style="position:absolute;left:72.02px;top:167.38px" class="cls_004"><span class="cls_004">calling already constructed object with</span></div>
<div style="position:absolute;left:238.04px;top:167.38px" class="cls_004"><span class="cls_004">⇔  runtime dependency through late bind-</span></div>
<div style="position:absolute;left:72.02px;top:179.34px" class="cls_004"><span class="cls_004">reference to other object</span></div>
<div style="position:absolute;left:259.96px;top:179.34px" class="cls_004"><span class="cls_004">ing</span></div>
<div style="position:absolute;left:72.02px;top:189.86px" class="cls_004"><span class="cls_004">calling constructor with reference to</span></div>
<div style="position:absolute;left:238.04px;top:189.86px" class="cls_004"><span class="cls_004">⇔  build-time dependency</span></div>
<div style="position:absolute;left:72.02px;top:201.82px" class="cls_004"><span class="cls_004">other object, not stored</span></div>
<div style="position:absolute;left:72.02px;top:212.34px" class="cls_004"><span class="cls_004">calling constructor with reference to</span></div>
<div style="position:absolute;left:238.04px;top:212.34px" class="cls_004"><span class="cls_004">⇔  retained dependency</span></div>
<div style="position:absolute;left:72.02px;top:224.30px" class="cls_004"><span class="cls_004">other object, stored</span></div>
<div style="position:absolute;left:159.66px;top:235.22px" class="cls_004"><span class="cls_004">Pointer discipline vs. deployment styles</span></div>
<div style="position:absolute;left:72.02px;top:247.57px" class="cls_004"><span class="cls_004">languages with total absence of pointer</span></div>
<div style="position:absolute;left:238.04px;top:247.57px" class="cls_004"><span class="cls_004">⇔  typical Unix-style deployment</span></div>
<div style="position:absolute;left:72.02px;top:259.53px" class="cls_004"><span class="cls_004">discipline (e.g., assembler)</span></div>
<div style="position:absolute;left:72.02px;top:270.06px" class="cls_004"><span class="cls_004">languages with enough pointer disci-</span></div>
<div style="position:absolute;left:238.04px;top:270.06px" class="cls_004"><span class="cls_004">⇔  Nix</span></div>
<div style="position:absolute;left:72.02px;top:282.01px" class="cls_004"><span class="cls_004">pline to support conservative garbage</span></div>
<div style="position:absolute;left:72.02px;top:293.97px" class="cls_004"><span class="cls_004">collection (e.g., C, C++)</span></div>
<div style="position:absolute;left:72.02px;top:304.49px" class="cls_004"><span class="cls_004">languages with full pointer discipline</span></div>
<div style="position:absolute;left:238.04px;top:304.49px" class="cls_004"><span class="cls_004">⇔  an as-yet unknown deployment style</span></div>
<div style="position:absolute;left:72.02px;top:316.45px" class="cls_004"><span class="cls_004">(e.g., Java, Haskell)</span></div>
<div style="position:absolute;left:259.96px;top:316.45px" class="cls_004"><span class="cls_004">not enabled by contemporary operat-</span></div>
<div style="position:absolute;left:259.96px;top:328.40px" class="cls_004"><span class="cls_004">ing systems</span></div>
<div style="position:absolute;left:126.86px;top:348.67px" class="cls_004"><span class="cls_004">Figure 3.1.: Deployment / memory management analogies</span></div>
<div style="position:absolute;left:63.87px;top:375.69px" class="cls_011"><span class="cls_011">3.3. Closures</span></div>
<div style="position:absolute;left:63.87px;top:400.91px" class="cls_004"><span class="cls_004">As noted above, dangling pointers in components are a root cause of deployment failure.</span></div>
<div style="position:absolute;left:63.87px;top:412.86px" class="cls_004"><span class="cls_004">Thus, to ensure successful software deployment, we must copy to the target system not just</span></div>
<div style="position:absolute;left:63.87px;top:424.82px" class="cls_004"><span class="cls_004">the files that make up the component, but also all files to which it has pointers. Formally,</span></div>
<div style="position:absolute;left:63.87px;top:436.77px" class="cls_004"><span class="cls_004">the set of files to be included in the distribution of a component is the closure of the set</span></div>
<div style="position:absolute;left:63.87px;top:448.73px" class="cls_004"><span class="cls_004">of files in the component under the points-to relationship. Informally, a file that is part of</span></div>
<div style="position:absolute;left:63.87px;top:460.68px" class="cls_004"><span class="cls_004">a component is characterised as a tuple (p, c) where p is the path where the file is stored,</span></div>
<div style="position:absolute;left:63.87px;top:472.64px" class="cls_004"><span class="cls_004">and c is the contents required at that path. The contents of a path include not just the file</span></div>
<div style="position:absolute;left:63.87px;top:484.59px" class="cls_004"><span class="cls_004">contents if p is a regular file, but also metadata such as access permissions. In addition,</span></div>
<div style="position:absolute;left:63.87px;top:496.55px" class="cls_004"><span class="cls_004">the file may be a directory, in which case the contents include a mapping from directory</span></div>
<div style="position:absolute;left:63.87px;top:508.50px" class="cls_004"><span class="cls_004">entry names to the contents of these directory entries. This will be made more precise in</span></div>
<div style="position:absolute;left:63.87px;top:520.46px" class="cls_004"><span class="cls_004">Section 5.2.1.</span></div>
<div style="position:absolute;left:73.84px;top:531.39px" class="cls_004"><span class="cls_004">Now the closure of a set of files C is the smallest set C</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ⊇ C satisfying</span></div>
<div style="position:absolute;left:88.78px;top:550.22px" class="cls_004"><span class="cls_004">∀(p, c) ∈ C</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> : ∀p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004"> ∈</span><span class="cls_007"> references</span><span class="cls_004">(c) : ∃(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, c</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">) ∈ C</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> : p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004"> = p</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">where</span><span class="cls_007"> references</span><span class="cls_004">(c) denotes the set of pointers contained in the contents of c. That is, if a</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">path p is in the closure, then the paths to which it has pointers must be as well.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">55</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:42090px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background064.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">3. Deployment as Memory Management</span></div>
<div style="position:absolute;left:69.68px;top:45.04px" class="cls_004"><span class="cls_004">By definition, a closure does not contain dangling pointers.  A closure can therefore</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">be distributed correctly to and deployed on another system. Unfortunately, as mentioned</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">in Section 3.2, it is not possible in general to determine the set</span><span class="cls_007"> references</span><span class="cls_004">(c) because of</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">retained dependencies and pointer arithmetic.  In the next section, I propose a heuristic</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">approach to reliably determine this set.</span></div>
<div style="position:absolute;left:59.72px;top:125.41px" class="cls_011"><span class="cls_011">3.4. A pointer discipline</span></div>
<div style="position:absolute;left:59.72px;top:151.27px" class="cls_004"><span class="cls_004">In the previous section we saw that correct deployment without dangling pointers can be</span></div>
<div style="position:absolute;left:59.72px;top:163.23px" class="cls_004"><span class="cls_004">achieved by deploying file system closures. Unfortunately, determining the complete set</span></div>
<div style="position:absolute;left:59.72px;top:175.18px" class="cls_004"><span class="cls_004">of pointers is hard.</span></div>
<div style="position:absolute;left:69.68px;top:187.48px" class="cls_004"><span class="cls_004">In the domain of programming languages, we see the same problem. Languages such as</span></div>
<div style="position:absolute;left:59.72px;top:199.43px" class="cls_004"><span class="cls_004">C [106, 100] and C++ [153, 101] allow arbitrary pointer arithmetic (adding or subtracting</span></div>
<div style="position:absolute;left:59.72px;top:211.39px" class="cls_004"><span class="cls_004">integers to pointers, or casting between integers and pointers). In addition, compilers for</span></div>
<div style="position:absolute;left:59.72px;top:223.34px" class="cls_004"><span class="cls_004">these languages do not generally emit runtime information regarding record and stack lay-</span></div>
<div style="position:absolute;left:59.72px;top:235.30px" class="cls_004"><span class="cls_004">outs that enable one to determine the full pointer graph. Among other things, this makes</span></div>
<div style="position:absolute;left:59.72px;top:247.25px" class="cls_004"><span class="cls_004">it impossible to implement garbage collectors [104, 179] that can accurately distinguish</span></div>
<div style="position:absolute;left:59.72px;top:259.21px" class="cls_004"><span class="cls_004">between garbage and live objects. Garbage collectors consist of two logical phases [179].</span></div>
<div style="position:absolute;left:59.72px;top:271.17px" class="cls_004"><span class="cls_004">In the detection phase, the collector discovers which objects on the heap are “live,” i.e.,</span></div>
<div style="position:absolute;left:59.72px;top:283.12px" class="cls_004"><span class="cls_004">reachable by following pointers from the stack, registers, and global variables.  In the</span></div>
<div style="position:absolute;left:59.72px;top:295.08px" class="cls_004"><span class="cls_004">reclamation phase, all objects that are not live (i.e., dead) are freed. To find live objects in</span></div>
<div style="position:absolute;left:59.72px;top:307.03px" class="cls_004"><span class="cls_004">the detection phase, it must be clear what the pointers are. For instance, the collector must</span></div>
<div style="position:absolute;left:59.72px;top:318.99px" class="cls_004"><span class="cls_004">know what words on the stack are pointers, and not, say, integers.</span></div>
<div style="position:absolute;left:69.68px;top:331.28px" class="cls_004"><span class="cls_004">Other languages address this problem by imposing a pointer discipline:  the layouts</span></div>
<div style="position:absolute;left:59.72px;top:343.24px" class="cls_004"><span class="cls_004">of memory objects (including the positions of pointers) are known, and programs cannot</span></div>
<div style="position:absolute;left:59.72px;top:355.19px" class="cls_004"><span class="cls_004">manipulate pointers arbitrarily. For example, Java does not permit casting between integers</span></div>
<div style="position:absolute;left:59.72px;top:367.15px" class="cls_004"><span class="cls_004">and pointers, or direct pointer arithmetic.  Along with runtime information of memory</span></div>
<div style="position:absolute;left:59.72px;top:379.10px" class="cls_004"><span class="cls_004">layouts, this enables precise determination of the pointer graph.</span></div>
<div style="position:absolute;left:69.68px;top:391.40px" class="cls_004"><span class="cls_004">For file systems the problem is that arbitrary pointer arithmetic is allowed and that we</span></div>
<div style="position:absolute;left:59.72px;top:403.35px" class="cls_004"><span class="cls_004">do not know where pointers are stored in files. Certainly, if we restrict ourselves to compo-</span></div>
<div style="position:absolute;left:59.72px;top:415.31px" class="cls_004"><span class="cls_004">nents consisting of certain kinds of files, such as Java class files, we can determine at least</span></div>
<div style="position:absolute;left:59.72px;top:427.26px" class="cls_004"><span class="cls_004">part of the pointer graph statically, for instance by looking at the classes imported by a Java</span></div>
<div style="position:absolute;left:59.72px;top:439.22px" class="cls_004"><span class="cls_004">class file. However, this information is still not sufficient due to the possibility of dynamic</span></div>
<div style="position:absolute;left:59.72px;top:451.17px" class="cls_004"><span class="cls_004">class loading. Since the dependency information cannot be guaranteed to be complete and</span></div>
<div style="position:absolute;left:59.72px;top:463.13px" class="cls_004"><span class="cls_004">because this technique is not generally applicable, this approach does not suffice.</span></div>
<div style="position:absolute;left:69.68px;top:475.43px" class="cls_004"><span class="cls_004">The solution to proper dependency identification comes from conservative garbage col-</span></div>
<div style="position:absolute;left:59.72px;top:487.38px" class="cls_004"><span class="cls_004">lection [15, 14]. This is a technique to provide garbage collection for languages that have</span></div>
<div style="position:absolute;left:59.72px;top:499.34px" class="cls_004"><span class="cls_004">pointer arithmetic and no runtime memory layout information, such as C and C++. Conser-</span></div>
<div style="position:absolute;left:59.72px;top:511.29px" class="cls_004"><span class="cls_004">vative garbage collection works by constructing a pointer graph during the detection phase</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">by assuming that anything that looks like a valid pointer, is a valid pointer. For instance,</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">if we see a bit pattern in memory corresponding to a pointer to some address p, and p is</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">in fact part of an allocated part of memory, the object containing p is considered live. Of</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">course, this assumption might be wrong: the bit pattern might simply encode an integer, a</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">floating point number, and so on. But conservative garbage collection errs on the side of</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">caution: a misclassification causes a possibly dead object to be considered live, preventing</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">56</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:42780px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background065.jpg" width=481 height=680></div>
<div style="position:absolute;left:323.11px;top:17.14px" class="cls_004"><span class="cls_004">3.4. A pointer discipline</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">it from being reclaimed. The worst that can happen as a result is that we might run out of</span></div>
<div style="position:absolute;left:63.87px;top:55.97px" class="cls_004"><span class="cls_004">memory. Since misclassifications are rare, such cases are unlikely to occur</span><span class="cls_012"><sup>2</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:69.28px" class="cls_004"><span class="cls_004">Since there is a correspondence between objects in memory and files in a file system, we</span></div>
<div style="position:absolute;left:63.87px;top:81.23px" class="cls_004"><span class="cls_004">would like to borrow from conservative garbage collection techniques. That is, we want</span></div>
<div style="position:absolute;left:63.87px;top:93.19px" class="cls_004"><span class="cls_004">to borrow the concept of conservatively scanning for pointers from the detection phase.</span></div>
<div style="position:absolute;left:63.87px;top:105.14px" class="cls_004"><span class="cls_004">Specifically, we want to scan the contents of files (of which we do not know the layout),</span></div>
<div style="position:absolute;left:63.87px;top:117.10px" class="cls_004"><span class="cls_004">and if we see a string of characters that looks like a file name, we assume that the file being</span></div>
<div style="position:absolute;left:63.87px;top:129.05px" class="cls_004"><span class="cls_004">scanned has a pointer to the file indicated by the name. But there are two problems with</span></div>
<div style="position:absolute;left:63.87px;top:141.01px" class="cls_004"><span class="cls_004">this idea. First, there might be many false positives: the fact that the strings</span><span class="cls_007"> usr</span><span class="cls_004">,</span><span class="cls_007"> bin</span><span class="cls_004"> and</span></div>
<div style="position:absolute;left:63.87px;top:152.96px" class="cls_007"><span class="cls_007">gcc</span><span class="cls_004"> occur in a component, does not necessarily imply that the component is dependent</span></div>
<div style="position:absolute;left:63.87px;top:164.92px" class="cls_004"><span class="cls_004">on</span><span class="cls_007"> /usr/bin/gcc</span><span class="cls_004">). But more importantly, arbitrary pointer arithmetic makes it possible that</span></div>
<div style="position:absolute;left:63.87px;top:176.87px" class="cls_004"><span class="cls_004">even files that are not referenced, might still be dereferenced at runtime through pointers</span></div>
<div style="position:absolute;left:63.87px;top:188.83px" class="cls_004"><span class="cls_004">computed at runtime.</span></div>
<div style="position:absolute;left:73.84px;top:201.11px" class="cls_004"><span class="cls_004">There is a reason that conservative garbage collection works in languages such as C—</span></div>
<div style="position:absolute;left:63.87px;top:213.06px" class="cls_004"><span class="cls_004">namely, that they actually do have a minimal pointer discipline.  For instance, pointer</span></div>
<div style="position:absolute;left:63.87px;top:225.02px" class="cls_004"><span class="cls_004">arithmetic is not allowed to increment or decrement a pointer beyond the boundaries of</span></div>
<div style="position:absolute;left:63.87px;top:236.97px" class="cls_004"><span class="cls_004">the object that it originally pointed to. Of course, the compiler has no way to verify the</span></div>
<div style="position:absolute;left:63.87px;top:248.93px" class="cls_004"><span class="cls_004">validity of such arithmetic, but programmers are well aware of the fact that a C fragment</span></div>
<div style="position:absolute;left:63.87px;top:260.88px" class="cls_004"><span class="cls_004">like</span></div>
<div style="position:absolute;left:88.78px;top:286.05px" class="cls_015"><span class="cls_015">char  *  p  =  malloc(100);</span></div>
<div style="position:absolute;left:88.78px;top:307.96px" class="cls_015"><span class="cls_015">char  *  q  =  p  +  200;  /*  ouch!  */</span></div>
<div style="position:absolute;left:88.78px;top:318.92px" class="cls_015"><span class="cls_015">printf("%c",  *q);</span></div>
<div style="position:absolute;left:63.87px;top:334.57px" class="cls_004"><span class="cls_004">is quite illegal. Thus, correct C programs will work with a conservative garbage collector.</span></div>
<div style="position:absolute;left:73.84px;top:346.85px" class="cls_004"><span class="cls_004">But even this minimal pointer discipline is absent in general component storage in the</span></div>
<div style="position:absolute;left:63.87px;top:358.80px" class="cls_004"><span class="cls_004">file system! Tools can perform arbitrary pointer arithmetic on paths to produce pointers to</span></div>
<div style="position:absolute;left:63.87px;top:370.76px" class="cls_004"><span class="cls_004">any file in the file system. Most tools don’t, but even in a limited sense it is a problem. For</span></div>
<div style="position:absolute;left:63.87px;top:382.71px" class="cls_004"><span class="cls_004">instance, once the C compiler has a pointer to</span><span class="cls_007"> /usr/include</span><span class="cls_004">, it will happily dereference that</span></div>
<div style="position:absolute;left:63.87px;top:394.67px" class="cls_004"><span class="cls_004">directory and produce pointers to all the files in it. In a way, how we store components</span></div>
<div style="position:absolute;left:63.87px;top:406.62px" class="cls_004"><span class="cls_004">in the file system in conventional deployment systems is reminiscent of programming in</span></div>
<div style="position:absolute;left:63.87px;top:418.58px" class="cls_004"><span class="cls_004">assembler—there is perfect freedom, and because of that freedom, all bets are off and we</span></div>
<div style="position:absolute;left:63.87px;top:430.54px" class="cls_004"><span class="cls_004">can make no statements about the structure of memory objects (see the bottom third of</span></div>
<div style="position:absolute;left:63.87px;top:442.49px" class="cls_004"><span class="cls_004">Figure 3.1).</span></div>
<div style="position:absolute;left:73.84px;top:454.77px" class="cls_004"><span class="cls_004">So we have to impose a discipline on the storage of components. There are two aspects</span></div>
<div style="position:absolute;left:63.87px;top:466.73px" class="cls_004"><span class="cls_004">to this:</span></div>
<div style="position:absolute;left:78.82px;top:487.63px" class="cls_004"><span class="cls_004">• Pointers have to be shaped in such a way that they are reliably recognisable. Short</span></div>
<div style="position:absolute;left:88.78px;top:499.58px" class="cls_004"><span class="cls_004">strings such as</span><span class="cls_007"> bin</span><span class="cls_004"> offer too much opportunity for misdetection.</span></div>
<div style="position:absolute;left:78.82px;top:520.81px" class="cls_004"><span class="cls_004">• Components have to be separated from each other. The constituent files of multiple</span></div>
<div style="position:absolute;left:88.78px;top:532.77px" class="cls_004"><span class="cls_004">components should not be mixed. Otherwise a tool can “hop” from one component</span></div>
<div style="position:absolute;left:88.78px;top:544.72px" class="cls_004"><span class="cls_004">to another through pointer arithmetic.</span></div>
<div style="position:absolute;left:68.36px;top:565.18px" class="cls_013"><span class="cls_013"><sup>2</sup></span><span class="cls_014">But note that a system using conservative garbage collection can be vulnerable to denial-of-service attacks</span></div>
<div style="position:absolute;left:75.83px;top:575.55px" class="cls_014"><span class="cls_014">if an attacker has an opportunity to feed it data (e.g., strings) that contains many bit patterns that might be</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">misidentified as pointers.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">57</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:43470px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background066.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">3. Deployment as Memory Management</span></div>
<div style="position:absolute;left:69.68px;top:45.04px" class="cls_004"><span class="cls_004">The Nix store introduced in Section 2.1 satisfies both requirements.  Components are</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">stored in isolation from each other in paths such as</span><span class="cls_007"> /nix/store/bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">which include long, distinctive strings such as</span><span class="cls_007"> bwacc7a5c5n3</span></div>
<div style="position:absolute;left:321.48px;top:68.95px" class="cls_004"><span class="cls_004">The latter is suitable for</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">pointer scanning, contrary to, say,</span><span class="cls_007"> hello</span><span class="cls_004">. Thus, if we find the ASCII string</span><span class="cls_007"> bwacc7a5c5n3...</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">in a different component, we can conclude that there is a dependency; and if we don’t find</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">the string, we can conclude that no such dependency exists between the two components.</span></div>
<div style="position:absolute;left:69.68px;top:116.77px" class="cls_004"><span class="cls_004">As noted in Section 3.2, the build of a component may retain a pointer to another com-</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">ponent, thus propagating a dependency to later points on the deployment timeline. In con-</span></div>
<div style="position:absolute;left:59.72px;top:140.68px" class="cls_004"><span class="cls_004">ventional deployment systems, these dependencies have to be specified separately, with all</span></div>
<div style="position:absolute;left:59.72px;top:152.64px" class="cls_004"><span class="cls_004">the risks inherent in manual specification. By analysing those files of a component that are</span></div>
<div style="position:absolute;left:59.72px;top:164.59px" class="cls_004"><span class="cls_004">part of a distribution (in source or binary form) or of an installation, we can automatically</span></div>
<div style="position:absolute;left:59.72px;top:176.55px" class="cls_004"><span class="cls_004">detect timeline dependencies, such as build-time and runtime dependencies.</span></div>
<div style="position:absolute;left:59.72px;top:203.05px" class="cls_009"><span class="cls_009">Pointer hiding</span><span class="cls_004">   What are the risks of this approach, i.e., when does it fail to detect depen-</span></div>
<div style="position:absolute;left:59.72px;top:215.01px" class="cls_004"><span class="cls_004">dencies? It has exactly the same limitation as conservative garbage collection in program-</span></div>
<div style="position:absolute;left:59.72px;top:226.96px" class="cls_004"><span class="cls_004">ming languages, namely, the failure to detect pointers due to pointer hiding. Pointer hiding</span></div>
<div style="position:absolute;left:59.72px;top:238.92px" class="cls_004"><span class="cls_004">occurs when a pointer is encoded in such a way that it is not recognised by the scanner (a</span></div>
<div style="position:absolute;left:59.72px;top:250.87px" class="cls_004"><span class="cls_004">false negative). For example, in C we can do the following:</span></div>
<div style="position:absolute;left:84.62px;top:274.96px" class="cls_015"><span class="cls_015">char  *  p  =  malloc(...);</span></div>
<div style="position:absolute;left:84.62px;top:285.92px" class="cls_015"><span class="cls_015">unsigned  int  x  =  ~((unsigned  int)  p);  /*  invert  all  bits  */</span></div>
<div style="position:absolute;left:84.62px;top:296.88px" class="cls_015"><span class="cls_015">p = 0;</span></div>
<div style="position:absolute;left:84.62px;top:307.84px" class="cls_015"><span class="cls_015">...  /*  run  the  collector  */</span></div>
<div style="position:absolute;left:84.62px;top:318.80px" class="cls_015"><span class="cls_015">p = (char *) ~x;</span></div>
<div style="position:absolute;left:59.72px;top:333.37px" class="cls_004"><span class="cls_004">That is, we allocate a pointer, then cast it to an integer, flip all the bits in the integer, and</span></div>
<div style="position:absolute;left:59.72px;top:345.32px" class="cls_004"><span class="cls_004">clear the original pointer. Later, we invert the integer again, and cast it back to a pointer,</span></div>
<div style="position:absolute;left:59.72px;top:357.28px" class="cls_004"><span class="cls_004">thus recovering the original pointer. However, if the garbage collector runs in between, it</span></div>
<div style="position:absolute;left:59.72px;top:369.23px" class="cls_004"><span class="cls_004">will not be able to detect that the referenced memory object if alive, since x does not look</span></div>
<div style="position:absolute;left:59.72px;top:381.19px" class="cls_004"><span class="cls_004">like a pointer to that object. Likewise, the collector can be fooled by writing a pointer to</span></div>
<div style="position:absolute;left:59.72px;top:393.15px" class="cls_004"><span class="cls_004">disk and reading it back later.</span></div>
<div style="position:absolute;left:69.68px;top:404.07px" class="cls_004"><span class="cls_004">With components in the file system, there are similar risks</span><span class="cls_012"><sup>3</sup></span><span class="cls_004">. If the collector searches for</span></div>
<div style="position:absolute;left:59.72px;top:417.06px" class="cls_004"><span class="cls_004">ASCII representations of the hash parts of component names, then anything that causes</span></div>
<div style="position:absolute;left:59.72px;top:429.01px" class="cls_004"><span class="cls_004">those hash parts to be not represented as contiguous ASCII strings will break the detec-</span></div>
<div style="position:absolute;left:59.72px;top:440.97px" class="cls_004"><span class="cls_004">tion. Obviously, flipping the bit representation of the ASCII string will accomplish that,</span></div>
<div style="position:absolute;left:59.72px;top:452.92px" class="cls_004"><span class="cls_004">but this is unlikely to happen in real software.  More likely is that the file name will be</span></div>
<div style="position:absolute;left:59.72px;top:464.88px" class="cls_004"><span class="cls_004">split in some way. Path components are a common place to split path names:</span><span class="cls_007"> /nix/store/-</span></div>
<div style="position:absolute;left:59.72px;top:476.83px" class="cls_007"><span class="cls_007">bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004"> might be represented as a list</span><span class="cls_007"> ["nix", "store", "bwacc7a5c5n3...-</span></div>
<div style="position:absolute;left:59.72px;top:488.79px" class="cls_007"><span class="cls_007">hello-2.1.1"]</span><span class="cls_004">. This is why we scan for just the hash part, not the whole store path. Tools</span></div>
<div style="position:absolute;left:59.72px;top:500.74px" class="cls_004"><span class="cls_004">are unlikely to split inside path components since substrings of path components have no</span></div>
<div style="position:absolute;left:59.72px;top:512.70px" class="cls_004"><span class="cls_004">general semantic meaning.</span></div>
<div style="position:absolute;left:69.68px;top:524.65px" class="cls_004"><span class="cls_004">More threatening is the use of another representation than ASCII. For instance, if paths</span></div>
<div style="position:absolute;left:59.72px;top:536.61px" class="cls_004"><span class="cls_004">are represented in UTF-16 [34, Section 2.5], Nix’s scanner will not find them. Of course,</span></div>
<div style="position:absolute;left:64.20px;top:555.72px" class="cls_013"><span class="cls_013"><sup>3</sup></span><span class="cls_014">In all fairness, the risks are potentially a bit bigger in the file system than in C. The C standard leaves the</span></div>
<div style="position:absolute;left:71.67px;top:566.09px" class="cls_014"><span class="cls_014">semantics of the code example above implementation-defined. So most things that can cause pointer hiding</span></div>
<div style="position:absolute;left:71.67px;top:575.55px" class="cls_014"><span class="cls_014">are not used by educated C programmers in general.  On the plus side, the chance of a false positive is</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">practically non-existent.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">58</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:44160px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background067.jpg" width=481 height=680></div>
<div style="position:absolute;left:357.43px;top:17.14px" class="cls_004"><span class="cls_004">3.5. Persistence</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">the scanner can easily be adapted to support such encodings. Another concern that is harder</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">to support is compressed executables. The best solution here is not to use such facilities if</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">they are available.</span></div>
<div style="position:absolute;left:73.84px;top:80.92px" class="cls_004"><span class="cls_004">Ultimately, how well the scanning approach works is an empirical question. As we shall</span></div>
<div style="position:absolute;left:63.87px;top:92.88px" class="cls_004"><span class="cls_004">see in Chapter 7, scanning works very well in practice, as evidenced by the large set of</span></div>
<div style="position:absolute;left:63.87px;top:104.83px" class="cls_004"><span class="cls_004">components in the Nix Packages collection, which have not yielded a single example of</span></div>
<div style="position:absolute;left:63.87px;top:116.79px" class="cls_004"><span class="cls_004">a hidden pointer. Admittedly, this result may be dependent on the characteristics of the</span></div>
<div style="position:absolute;left:63.87px;top:128.74px" class="cls_004"><span class="cls_004">components being deployed; namely, they are Unix components, which do not typically</span></div>
<div style="position:absolute;left:63.87px;top:140.70px" class="cls_004"><span class="cls_004">feature compressed executables, and store filenames almost invariably in plain ASCII.</span></div>
<div style="position:absolute;left:63.87px;top:171.46px" class="cls_011"><span class="cls_011">3.5. Persistence</span></div>
<div style="position:absolute;left:63.87px;top:196.71px" class="cls_004"><span class="cls_004">The technique of pointer scanning, as described in the previous section, solves the problem</span></div>
<div style="position:absolute;left:63.87px;top:208.66px" class="cls_004"><span class="cls_004">of reliable identification of component dependencies.  Here I describe a solution to the</span></div>
<div style="position:absolute;left:63.87px;top:220.62px" class="cls_004"><span class="cls_004">problem of component interference, which occurs when two components occupy the same</span></div>
<div style="position:absolute;left:63.87px;top:232.57px" class="cls_004"><span class="cls_004">addresses in the file system. When we deploy software by copying a file system closure to</span></div>
<div style="position:absolute;left:63.87px;top:244.53px" class="cls_004"><span class="cls_004">another system, we run the risk of overwriting other software. The underlying problem is</span></div>
<div style="position:absolute;left:63.87px;top:256.48px" class="cls_004"><span class="cls_004">similar to that in the notion of persistence in programming languages, which is essentially</span></div>
<div style="position:absolute;left:63.87px;top:268.44px" class="cls_004"><span class="cls_004">the migration of data from one address space to another (such as a later invocation of a</span></div>
<div style="position:absolute;left:63.87px;top:280.39px" class="cls_004"><span class="cls_004">process). We cannot simply dump the data of one address space and reload them at the</span></div>
<div style="position:absolute;left:63.87px;top:292.35px" class="cls_004"><span class="cls_004">same addresses in the other address space, since those may already be occupied (or may</span></div>
<div style="position:absolute;left:63.87px;top:304.30px" class="cls_004"><span class="cls_004">be invalid). This problem is solved by serialising the data, that is, by writing it to disk in a</span></div>
<div style="position:absolute;left:63.87px;top:316.26px" class="cls_004"><span class="cls_004">format that abstracts over memory locations.</span></div>
<div style="position:absolute;left:73.84px;top:328.23px" class="cls_004"><span class="cls_004">Unfortunately, it is hard to apply an analogue of serialisation to software deployment,</span></div>
<div style="position:absolute;left:63.87px;top:339.16px" class="cls_004"><span class="cls_004">because it requires changing pointers, which may not be reliably possible in files</span><span class="cls_012"><sup>4</sup></span><span class="cls_004">.  For</span></div>
<div style="position:absolute;left:63.87px;top:352.14px" class="cls_004"><span class="cls_004">instance, a tempting approach is to rename the files in a closure to addresses not existing</span></div>
<div style="position:absolute;left:63.87px;top:364.09px" class="cls_004"><span class="cls_004">on the target system. To do this, we also have to change the corresponding pointers in the</span></div>
<div style="position:absolute;left:63.87px;top:376.05px" class="cls_004"><span class="cls_004">files. However, patching files in such a manner might cause the affected components to</span></div>
<div style="position:absolute;left:63.87px;top:388.00px" class="cls_004"><span class="cls_004">break, e.g., due to internal checksums on files being invalidated in the process.</span></div>
<div style="position:absolute;left:73.84px;top:399.98px" class="cls_004"><span class="cls_004">Thus, we should choose addresses in such a way as to minimise the chance of address</span></div>
<div style="position:absolute;left:63.87px;top:411.93px" class="cls_004"><span class="cls_004">collision. To make our scanning approach work, we already need long, recognisable ele-</span></div>
<div style="position:absolute;left:63.87px;top:423.89px" class="cls_004"><span class="cls_004">ments in these file names, such as the base-32 representations of 160-bit values used in Nix.</span></div>
<div style="position:absolute;left:63.87px;top:435.84px" class="cls_004"><span class="cls_004">Not every selection of values prevents collisions: e.g., using a combination of the name</span></div>
<div style="position:absolute;left:63.87px;top:447.80px" class="cls_004"><span class="cls_004">and version number of a component is insufficient, since there frequently are incompatible</span></div>
<div style="position:absolute;left:63.87px;top:459.75px" class="cls_004"><span class="cls_004">instances even for the same version of a component.</span></div>
<div style="position:absolute;left:73.84px;top:471.72px" class="cls_004"><span class="cls_004">Another approach is to select random addresses whenever we build a component. This</span></div>
<div style="position:absolute;left:63.87px;top:483.68px" class="cls_004"><span class="cls_004">works, but it is extremely inefficient; components that are functionally equal would obtain</span></div>
<div style="position:absolute;left:63.87px;top:495.63px" class="cls_004"><span class="cls_004">different addresses on every build, and therefore might be stored many times on the same</span></div>
<div style="position:absolute;left:63.87px;top:507.59px" class="cls_004"><span class="cls_004">system. That is, there is a complete lack of sharing: equal components are not stored at</span></div>
<div style="position:absolute;left:63.87px;top:519.54px" class="cls_004"><span class="cls_004">the same address.</span></div>
<div style="position:absolute;left:73.84px;top:531.51px" class="cls_004"><span class="cls_004">Hence, we observe a tension between the desire for sharing on the one hand, and the</span></div>
<div style="position:absolute;left:63.87px;top:543.47px" class="cls_004"><span class="cls_004">avoidance of collisions on the other hand. The solution is another notion from memory</span></div>
<div style="position:absolute;left:63.87px;top:555.42px" class="cls_004"><span class="cls_004">management. Maximal sharing [166] is the property of a storage system that two values</span></div>
<div style="position:absolute;left:68.36px;top:574.65px" class="cls_013"><span class="cls_013"><sup>4</sup></span><span class="cls_014">But if we assume that we can rewrite pointers, then we can do something very similar to serialisation. The</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">implications of this assumption (which turns out to be quite reasonable) are explored in Chapter 6.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">59</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:44850px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background068.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">3. Deployment as Memory Management</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">occupy the same address in memory, if and only if they are equal (under some notion of</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">equality). This minimises memory usage in most cases.</span></div>
<div style="position:absolute;left:69.68px;top:68.95px" class="cls_004"><span class="cls_004">The notion of maximal sharing is also applicable to deployment. We define two compo-</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">nents to be equal if and only if the inputs to their builds are equal. The inputs of a build</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">include any file system addresses passed to it, and aspects like the processor and operating</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">system on which it is performed.  We can then use a cryptographic hash [145] of these</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">inputs as the recognisable part of the file name of a component.  Cryptographic hashes</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">are used because they have good collision resistance, making the chance of a collision</span></div>
<div style="position:absolute;left:59.72px;top:140.68px" class="cls_004"><span class="cls_004">negligible. In essence, hashes thus act as unique “product codes” for components. This</span></div>
<div style="position:absolute;left:59.72px;top:152.64px" class="cls_004"><span class="cls_004">is somewhat similar to global unique identifiers in COM [16], except that these apply to</span></div>
<div style="position:absolute;left:59.72px;top:164.59px" class="cls_004"><span class="cls_004">interfaces, not implementations, and are not computed deterministically. In summary, this</span></div>
<div style="position:absolute;left:59.72px;top:176.55px" class="cls_004"><span class="cls_004">approach solves the problem of component interference at local sites and between sites</span></div>
<div style="position:absolute;left:59.72px;top:188.50px" class="cls_004"><span class="cls_004">by imposing a single global address space on components.  The implementation of this</span></div>
<div style="position:absolute;left:59.72px;top:200.46px" class="cls_004"><span class="cls_004">approach is discussed in Chapter 5.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">60</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:45540px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background069.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:89.53px" class="cls_006"><span class="cls_006">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:63.87px;top:132.45px" class="cls_004"><span class="cls_004">This chapter describes the Nix expression language, the formalism used to describe compo-</span></div>
<div style="position:absolute;left:63.87px;top:144.41px" class="cls_004"><span class="cls_004">nents and compositions. It first motivates why a lazy functional language is an appropriate</span></div>
<div style="position:absolute;left:63.87px;top:156.36px" class="cls_004"><span class="cls_004">choice. It then gives a full description of the syntax and semantics of the language. Fi-</span></div>
<div style="position:absolute;left:63.87px;top:168.32px" class="cls_004"><span class="cls_004">nally, it discusses some of the more interesting aspects of the implementation of the Nix</span></div>
<div style="position:absolute;left:63.87px;top:180.27px" class="cls_004"><span class="cls_004">expression evaluator.</span></div>
<div style="position:absolute;left:63.87px;top:214.90px" class="cls_011"><span class="cls_011">4.1. Motivation</span></div>
<div style="position:absolute;left:63.87px;top:241.49px" class="cls_004"><span class="cls_004">The Nix expression language is a simple, untyped, purely functional language. It is not a</span></div>
<div style="position:absolute;left:63.87px;top:253.44px" class="cls_004"><span class="cls_004">general purpose programming language. Its only purpose is to describe components and</span></div>
<div style="position:absolute;left:63.87px;top:265.40px" class="cls_004"><span class="cls_004">compositions. A component is created through the</span><span class="cls_007"> derivation</span><span class="cls_004"> primitive operation, which</span></div>
<div style="position:absolute;left:63.87px;top:277.35px" class="cls_004"><span class="cls_004">accepts all information necessary to build the component. This includes its dependencies,</span></div>
<div style="position:absolute;left:63.87px;top:289.31px" class="cls_004"><span class="cls_004">which are other derivations or sources.</span></div>
<div style="position:absolute;left:63.87px;top:319.79px" class="cls_009"><span class="cls_009">Purely functional language</span><span class="cls_004">   A purely functional language gives us a clean component</span></div>
<div style="position:absolute;left:63.87px;top:331.74px" class="cls_004"><span class="cls_004">description formalism.  The notion that components can be produced by functions that</span></div>
<div style="position:absolute;left:63.87px;top:343.70px" class="cls_004"><span class="cls_004">accept values for the variation points in the component, is much more flexible than, say, a</span></div>
<div style="position:absolute;left:63.87px;top:355.65px" class="cls_004"><span class="cls_004">language that binds such variation points using global variables.</span></div>
<div style="position:absolute;left:73.84px;top:368.33px" class="cls_004"><span class="cls_004">Consider the ATerm library [166], which is a small library for term manipulation. It has</span></div>
<div style="position:absolute;left:63.87px;top:380.28px" class="cls_004"><span class="cls_004">several build-time options, in particular an option that specifies whether the domain feature</span></div>
<div style="position:absolute;left:63.87px;top:392.24px" class="cls_004"><span class="cls_004">“maximal sharing” is enabled. This setting is vitally important, as it completely changes</span></div>
<div style="position:absolute;left:63.87px;top:404.19px" class="cls_004"><span class="cls_004">the semantics of the library. Thus a build with maximal sharing cannot be substituted by</span></div>
<div style="position:absolute;left:63.87px;top:416.15px" class="cls_004"><span class="cls_004">a build without maximal sharing, and vice versa. Now suppose that we have a component</span></div>
<div style="position:absolute;left:63.87px;top:428.10px" class="cls_004"><span class="cls_004">consisting of two programs,</span><span class="cls_007"> foo</span><span class="cls_004"> and</span><span class="cls_007"> bar</span><span class="cls_004">, that require the ATerm library with and without</span></div>
<div style="position:absolute;left:63.87px;top:440.06px" class="cls_004"><span class="cls_004">maximal sharing respectively. In a purely functional language, this is easy to model. We</span></div>
<div style="position:absolute;left:63.87px;top:452.02px" class="cls_004"><span class="cls_004">just make a function for the ATerm library:</span></div>
<div style="position:absolute;left:88.78px;top:478.36px" class="cls_015"><span class="cls_015">aterm  =  {maximalSharing}:  derivation  {...};</span></div>
<div style="position:absolute;left:63.87px;top:495.19px" class="cls_004"><span class="cls_004">We can now call this function twice with different values, in the derivations of</span><span class="cls_007"> foo</span><span class="cls_004"> and</span><span class="cls_007"> bar</span></div>
<div style="position:absolute;left:63.87px;top:507.14px" class="cls_004"><span class="cls_004">respectively:</span></div>
<div style="position:absolute;left:88.78px;top:533.48px" class="cls_015"><span class="cls_015">foo  =  derivation  {  ...</span></div>
<div style="position:absolute;left:98.19px;top:544.44px" class="cls_015"><span class="cls_015">buildInputs  =  [  (aterm  {maximalSharing  =  true;})  ];</span></div>
<div style="position:absolute;left:88.78px;top:555.40px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:88.78px;top:566.36px" class="cls_015"><span class="cls_015">bar  =  derivation  {  ...</span></div>
<div style="position:absolute;left:98.19px;top:577.32px" class="cls_015"><span class="cls_015">buildInputs  =  [  (aterm  {maximalSharing  =  false;})  ];</span></div>
<div style="position:absolute;left:88.78px;top:588.28px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">61</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:46230px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background070.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:69.68px;top:45.04px" class="cls_004"><span class="cls_004">Imagine that we had a formalism that used global variables to bind variation points</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">such as</span><span class="cls_007"> maximalSharing</span><span class="cls_004">. If the language were a Makefile-like declarative formalism, then</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">it would be quite hard to implement this example.  Makefiles [56] are a formalism to</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">describe the construction of (small-grained) components.  Variability in a component is</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">typically expressed by setting variables, e.g.,</span></div>
<div style="position:absolute;left:84.62px;top:116.66px" class="cls_015"><span class="cls_015">MAX_SHARING  =  1  #  or  0</span></div>
<div style="position:absolute;left:84.62px;top:127.62px" class="cls_015"><span class="cls_015">CFLAGS  =  -DMAX_SHARING=$(MAX_SHARING)</span></div>
<div style="position:absolute;left:84.62px;top:138.58px" class="cls_015"><span class="cls_015">aterm:  ...</span></div>
<div style="position:absolute;left:84.62px;top:149.54px" class="cls_015"><span class="cls_015">foo:  aterm</span></div>
<div style="position:absolute;left:84.62px;top:160.50px" class="cls_015"><span class="cls_015">bar:  aterm</span></div>
<div style="position:absolute;left:59.72px;top:174.78px" class="cls_004"><span class="cls_004">It is not clear how to build</span><span class="cls_007"> foo</span><span class="cls_004"> and</span><span class="cls_007"> bar</span><span class="cls_004"> in both variants concurrently. In Make, it is typ-</span></div>
<div style="position:absolute;left:59.72px;top:186.74px" class="cls_004"><span class="cls_004">ically very hard to build a component in multiple configurations that exist side-by-side.</span></div>
<div style="position:absolute;left:59.72px;top:198.69px" class="cls_004"><span class="cls_004">If it is done at all, it is usually accomplished through ad hoc tricks such as calling Make</span></div>
<div style="position:absolute;left:59.72px;top:210.65px" class="cls_004"><span class="cls_004">recursively with different flags, giving the build result a different name for each call.</span></div>
<div style="position:absolute;left:69.68px;top:222.60px" class="cls_004"><span class="cls_004">If the formalism were imperative, then it would be possible. Such a style might look</span></div>
<div style="position:absolute;left:59.72px;top:234.56px" class="cls_004"><span class="cls_004">like this:</span></div>
<div style="position:absolute;left:84.62px;top:258.36px" class="cls_015"><span class="cls_015">maxSharing  =  true;</span></div>
<div style="position:absolute;left:84.62px;top:269.32px" class="cls_015"><span class="cls_015">foo(aterm());</span></div>
<div style="position:absolute;left:84.62px;top:280.28px" class="cls_015"><span class="cls_015">maxSharing  =  false;</span></div>
<div style="position:absolute;left:84.62px;top:291.24px" class="cls_015"><span class="cls_015">bar(aterm());</span></div>
<div style="position:absolute;left:59.72px;top:305.52px" class="cls_004"><span class="cls_004">But this has the same problems that imperative programming has in general.  Since the</span></div>
<div style="position:absolute;left:59.72px;top:317.48px" class="cls_004"><span class="cls_004">order in which statements are executed matters, it is hard to see exactly what goes into a</span></div>
<div style="position:absolute;left:59.72px;top:329.43px" class="cls_004"><span class="cls_004">build function such as</span><span class="cls_007"> aterm()</span><span class="cls_004">. Of course, in a trivial example like this, it is doable. But</span></div>
<div style="position:absolute;left:59.72px;top:341.39px" class="cls_004"><span class="cls_004">once we get many functions, variables, and potential control-flow paths, it may become</span></div>
<div style="position:absolute;left:59.72px;top:353.34px" class="cls_004"><span class="cls_004">very hard to comprehend what is happening. Note that this is the case even if variables are</span></div>
<div style="position:absolute;left:59.72px;top:365.30px" class="cls_004"><span class="cls_004">not global. For instance,</span><span class="cls_007"> maxSharing</span><span class="cls_004"> could be a field of the</span><span class="cls_007"> aterm</span><span class="cls_004"> object. But even then</span></div>
<div style="position:absolute;left:59.72px;top:377.26px" class="cls_004"><span class="cls_004">the execution order frustrates comprehension.</span></div>
<div style="position:absolute;left:69.68px;top:389.21px" class="cls_004"><span class="cls_004">Interestingly, most true component-level formalisms do not specify compositions at all,</span></div>
<div style="position:absolute;left:59.72px;top:401.17px" class="cls_004"><span class="cls_004">just components.</span></div>
<div style="position:absolute;left:134.37px;top:401.17px" class="cls_004"><span class="cls_004">(With “component-level” I mean that they work at the level of large-</span></div>
<div style="position:absolute;left:59.72px;top:413.12px" class="cls_004"><span class="cls_004">grained components, like RPM spec files do, rather than at the level of small-grained com-</span></div>
<div style="position:absolute;left:59.72px;top:425.08px" class="cls_004"><span class="cls_004">ponents, like Makefiles.) An RPM spec file for instance specifies a component build action,</span></div>
<div style="position:absolute;left:59.72px;top:437.03px" class="cls_004"><span class="cls_004">which can include variables that can be set when the</span><span class="cls_007"> rpmbuild</span><span class="cls_004"> tool is called, but there is no</span></div>
<div style="position:absolute;left:59.72px;top:448.99px" class="cls_004"><span class="cls_004">way for one RPM spec file to declare that it needs the result of another RPM spec file with</span></div>
<div style="position:absolute;left:59.72px;top:460.94px" class="cls_004"><span class="cls_004">certain variables set to certain values. In any case RPM will not recursively build those</span></div>
<div style="position:absolute;left:59.72px;top:472.90px" class="cls_004"><span class="cls_004">dependencies, let alone with the desired variable values (since it has no way to prevent</span></div>
<div style="position:absolute;left:59.72px;top:484.85px" class="cls_004"><span class="cls_004">collisions between the various builds).</span></div>
<div style="position:absolute;left:69.68px;top:496.81px" class="cls_004"><span class="cls_004">Other essentially functional build formalisms are Amake and Odin, discussed in Sec-</span></div>
<div style="position:absolute;left:59.72px;top:508.76px" class="cls_004"><span class="cls_004">tion 10.3.</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_009"><span class="cls_009">Laziness</span><span class="cls_004">   A lazy language only evaluates values when they are needed. This is a very</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">useful property for a component description language. Here are some concrete examples</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">of why this is useful.</span></div>
<div style="position:absolute;left:69.68px;top:571.07px" class="cls_004"><span class="cls_004">It is possible to define large sets of components concurrently (i.e., in a single file or ex-</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">pression), without having to build them all. For instance, the Nix expression</span><span class="cls_007"> pkgs/system-</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">62</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:46920px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background071.jpg" width=481 height=680></div>
<div style="position:absolute;left:358.46px;top:17.14px" class="cls_004"><span class="cls_004">4.1. Motivation</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_007"><span class="cls_007">/all-packages-generic.nix</span><span class="cls_004"> in the Nix Packages collection returns a large attribute set of</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">derivations:</span></div>
<div style="position:absolute;left:88.78px;top:82.52px" class="cls_015"><span class="cls_015">rec  {</span></div>
<div style="position:absolute;left:98.19px;top:93.48px" class="cls_015"><span class="cls_015">stdenv  =  derivation  {  ...  };</span></div>
<div style="position:absolute;left:98.19px;top:104.44px" class="cls_015"><span class="cls_015">glibc  =  derivation  {  ...  };</span></div>
<div style="position:absolute;left:98.19px;top:115.40px" class="cls_015"><span class="cls_015">gcc  =  derivation  {  ...  };</span></div>
<div style="position:absolute;left:98.19px;top:126.36px" class="cls_015"><span class="cls_015">hello  =  derivation  {  ...  };</span></div>
<div style="position:absolute;left:98.19px;top:137.32px" class="cls_015"><span class="cls_015">subversion  derivation  {  ...  };</span></div>
<div style="position:absolute;left:98.19px;top:148.28px" class="cls_015"><span class="cls_015">firefox  =  derivation  {  ...  };</span></div>
<div style="position:absolute;left:88.78px;top:159.24px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:63.87px;top:175.25px" class="cls_004"><span class="cls_004">and hundreds more. Since the language is lazy, the right-hand sides of the attributes will</span></div>
<div style="position:absolute;left:63.87px;top:187.21px" class="cls_004"><span class="cls_004">not be evaluated until they are actually needed, if at all.  For instance, if we install any</span></div>
<div style="position:absolute;left:63.87px;top:199.16px" class="cls_004"><span class="cls_004">specific component from this set, say,</span><span class="cls_007"> nix-env -i hello</span><span class="cls_004">, then only the</span><span class="cls_007"> hello</span><span class="cls_004"> value will be</span></div>
<div style="position:absolute;left:63.87px;top:211.12px" class="cls_004"><span class="cls_004">evaluated (although it may in turn require other values to be evaluated, such as</span><span class="cls_007"> stdenv</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:73.84px;top:223.52px" class="cls_004"><span class="cls_004">Laziness also allows greater efficiency if only parts of a complex data structure are</span></div>
<div style="position:absolute;left:63.87px;top:235.48px" class="cls_004"><span class="cls_004">needed.  Take the operation</span><span class="cls_007"> nix-env -qa</span><span class="cls_004">, which prints the</span><span class="cls_007"> name</span><span class="cls_004"> attribute of all top-level</span></div>
<div style="position:absolute;left:63.87px;top:247.43px" class="cls_004"><span class="cls_004">derivations in a Nix expression:</span></div>
<div style="position:absolute;left:88.78px;top:272.96px" class="cls_015"><span class="cls_015">$ nix-env  -f  ./pkgs/system/i686-linux.nix  -qa</span></div>
<div style="position:absolute;left:88.78px;top:283.92px" class="cls_015"><span class="cls_015">a52dec-0.7.4</span></div>
<div style="position:absolute;left:88.78px;top:294.88px" class="cls_015"><span class="cls_015">acrobat-reader-7.0</span></div>
<div style="position:absolute;left:88.78px;top:305.84px" class="cls_015"><span class="cls_015">alsa-lib-1.0.9</span></div>
<div style="position:absolute;left:88.78px;top:316.80px" class="cls_015"><span class="cls_015">ant-blackdown-1.4.2</span></div>
<div style="position:absolute;left:88.78px;top:327.76px" class="cls_015"><span class="cls_015">ant-j2sdk-1.4.2</span></div>
<div style="position:absolute;left:88.78px;top:338.71px" class="cls_015"><span class="cls_015">ant-j2sdk-1.5.0</span></div>
<div style="position:absolute;left:63.87px;top:365.69px" class="cls_004"><span class="cls_004">This operation is quite fast:  it takes around 0.6 seconds on an Athlon XP 2600 on an</span></div>
<div style="position:absolute;left:63.87px;top:377.64px" class="cls_004"><span class="cls_004">expression containing 417 top-level derivations.  But the</span><span class="cls_007"> derivation</span><span class="cls_004"> calls for those 417</span></div>
<div style="position:absolute;left:63.87px;top:389.60px" class="cls_004"><span class="cls_004">derivations potentially need to do a lot of work, as we will see in Section 5.4: they have to</span></div>
<div style="position:absolute;left:63.87px;top:401.55px" class="cls_004"><span class="cls_004">copy sources to the Nix store, compute cryptographic hashes, and so on. But that work is</span></div>
<div style="position:absolute;left:63.87px;top:413.51px" class="cls_004"><span class="cls_004">actually attached to two attributes returned from</span><span class="cls_007"> derivation</span><span class="cls_004">, namely</span><span class="cls_007"> drvPath</span><span class="cls_004"> and</span><span class="cls_007"> outPath</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:63.87px;top:425.46px" class="cls_004"><span class="cls_004">which compute the derivation and output store paths. As long as those attributes are not</span></div>
<div style="position:absolute;left:63.87px;top:437.42px" class="cls_004"><span class="cls_004">used, they are not computed.  Above, this was the case, since</span><span class="cls_007"> nix-env -qa</span><span class="cls_004"> only uses the</span></div>
<div style="position:absolute;left:63.87px;top:449.37px" class="cls_007"><span class="cls_007">name</span><span class="cls_004"> attribute. But if we force the computation of either of those two attributes:</span></div>
<div style="position:absolute;left:88.78px;top:474.90px" class="cls_015"><span class="cls_015">$ nix-env  -f  ./pkgs/system/i686-linux.nix  -qa  --drv-path</span></div>
<div style="position:absolute;left:88.78px;top:485.86px" class="cls_015"><span class="cls_015">a52dec-0.7.4</span></div>
<div style="position:absolute;left:178.20px;top:485.86px" class="cls_015"><span class="cls_015">/nix/store/spkk...-a52dec-0.7.4.drv</span></div>
<div style="position:absolute;left:88.78px;top:496.82px" class="cls_015"><span class="cls_015">acrobat-reader-7.0  /nix/store/1fdl...-acrobat-reader-7.0.drv</span></div>
<div style="position:absolute;left:88.78px;top:507.78px" class="cls_015"><span class="cls_015">alsa-lib-1.0.9</span></div>
<div style="position:absolute;left:178.20px;top:507.78px" class="cls_015"><span class="cls_015">/nix/store/5a7h...-alsa-lib-1.0.9.drv</span></div>
<div style="position:absolute;left:63.87px;top:534.75px" class="cls_004"><span class="cls_004">then the operation takes much longer: 2.7 seconds.</span></div>
<div style="position:absolute;left:73.84px;top:547.16px" class="cls_004"><span class="cls_004">Laziness allows arguments to be passed to functions that may not be used. In the Subver-</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">sion example (Figure 2.9), the Subversion function passes dependencies such as</span><span class="cls_007"> openssl</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">and</span><span class="cls_007"> httpd</span><span class="cls_004"> that are only passed to the derivation if the corresponding domain feature is set,</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">e.g.,</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">63</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:47610px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background072.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:84.62px;top:50.30px" class="cls_015"><span class="cls_015">{ ...,  sslSupport,  openssl,  ...  }:</span></div>
<div style="position:absolute;left:84.62px;top:61.25px" class="cls_015"><span class="cls_015">derivation  {</span></div>
<div style="position:absolute;left:94.04px;top:72.21px" class="cls_015"><span class="cls_015">openssl  =  if  sslSupport  then  openssl  else  null;</span></div>
<div style="position:absolute;left:84.62px;top:83.17px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:59.72px;top:99.68px" class="cls_004"><span class="cls_004">That is, the derivation’s</span><span class="cls_007"> openssl</span><span class="cls_004"> attribute is set to</span><span class="cls_007"> null</span><span class="cls_004"> if SSL support is disabled, regardless</span></div>
<div style="position:absolute;left:59.72px;top:111.63px" class="cls_004"><span class="cls_004">of the value of the</span><span class="cls_007"> openssl</span><span class="cls_004"> function parameter. This allows us to unconditionally pass an</span></div>
<div style="position:absolute;left:59.72px;top:123.59px" class="cls_004"><span class="cls_004">instance of</span><span class="cls_007"> openssl</span><span class="cls_004"> in the function call in</span><span class="cls_007"> all-packages-generic.nix</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:84.62px;top:149.60px" class="cls_015"><span class="cls_015">subversion  =  import  .../subversion  {</span></div>
<div style="position:absolute;left:94.04px;top:160.56px" class="cls_015"><span class="cls_015">inherit  openssl;</span></div>
<div style="position:absolute;left:94.04px;top:171.52px" class="cls_015"><span class="cls_015">sslSupport  =  false;  #  set  to  `true'  if  you  want  SSL  support</span></div>
<div style="position:absolute;left:84.62px;top:182.48px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:59.72px;top:198.98px" class="cls_004"><span class="cls_004">Thanks to laziness, OpenSSL will only be built if SSL support is enabled, despite the fact</span></div>
<div style="position:absolute;left:59.72px;top:210.94px" class="cls_004"><span class="cls_004">that it is always passed as an argument. This simplifies the call sites. Without laziness, the</span></div>
<div style="position:absolute;left:59.72px;top:222.89px" class="cls_004"><span class="cls_004">caller would have the responsibility to ensure that no unnecessary dependencies are passed</span></div>
<div style="position:absolute;left:59.72px;top:234.85px" class="cls_004"><span class="cls_004">to the derivation, thus breaking abstraction.</span></div>
<div style="position:absolute;left:59.72px;top:268.89px" class="cls_011"><span class="cls_011">4.2. Syntax</span></div>
<div style="position:absolute;left:59.72px;top:295.26px" class="cls_004"><span class="cls_004">This section presents the syntax of the Nix expression language using the Syntax Definition</span></div>
<div style="position:absolute;left:59.72px;top:307.22px" class="cls_004"><span class="cls_004">Formalism [175, 90], which has the following useful properties:</span></div>
<div style="position:absolute;left:74.66px;top:328.98px" class="cls_004"><span class="cls_004">• It is scannerless:  the lexical syntax and the high-level “context-free syntax” are</span></div>
<div style="position:absolute;left:84.62px;top:340.93px" class="cls_004"><span class="cls_004">specified in the same formalism. Thus, no separate lexical scanner is necessary. The</span></div>
<div style="position:absolute;left:84.62px;top:352.89px" class="cls_004"><span class="cls_004">result is a single context-free grammar.</span></div>
<div style="position:absolute;left:74.66px;top:375.26px" class="cls_004"><span class="cls_004">• It supports generalised LR (GLR) parsing.  Most context-free parsers (e.g., LL(k)</span></div>
<div style="position:absolute;left:84.62px;top:387.21px" class="cls_004"><span class="cls_004">and LR(k) parsers, for fixed k) suffer from bounded look-ahead: they must choose</span></div>
<div style="position:absolute;left:84.62px;top:399.17px" class="cls_004"><span class="cls_004">between different productions on the basis of a fixed number of tokens.  This is</span></div>
<div style="position:absolute;left:84.62px;top:411.12px" class="cls_004"><span class="cls_004">inconvenient for language implementors, since they must deal with the resulting</span></div>
<div style="position:absolute;left:84.62px;top:423.08px" class="cls_004"><span class="cls_004">parse conflicts. For instance, the input fragment</span><span class="cls_007"> "{x"</span><span class="cls_004"> could be start of an attribute set</span></div>
<div style="position:absolute;left:84.62px;top:434.01px" class="cls_004"><span class="cls_004">(e.g.,</span><span class="cls_007"> {x=123;}</span><span class="cls_004">), or a function definition (e.g.,</span><span class="cls_007"> {x}: x</span><span class="cls_004">)</span><span class="cls_012"><sup>1</sup></span><span class="cls_004">. This requires the programmer</span></div>
<div style="position:absolute;left:84.62px;top:446.99px" class="cls_004"><span class="cls_004">to introduce additional production rules to resolve the conflict. Since generalised LR</span></div>
<div style="position:absolute;left:84.62px;top:458.94px" class="cls_004"><span class="cls_004">parsing has unbounded look-ahead, such grammar transformations are unnecessary.</span></div>
<div style="position:absolute;left:84.62px;top:470.90px" class="cls_004"><span class="cls_004">Another advantage of GLR is that since it supports arbitrary context-free grammars</span></div>
<div style="position:absolute;left:84.62px;top:482.85px" class="cls_004"><span class="cls_004">(including ambiguous ones), it allows grammars to be composed. This makes it easy</span></div>
<div style="position:absolute;left:84.62px;top:494.81px" class="cls_004"><span class="cls_004">to extend programming languages [19].</span></div>
<div style="position:absolute;left:74.66px;top:517.18px" class="cls_004"><span class="cls_004">• It is a declarative formalism that specifies a grammar separate from any particular</span></div>
<div style="position:absolute;left:84.62px;top:529.13px" class="cls_004"><span class="cls_004">programming language (contrary to, say, Yacc [103]). This is the main reason why</span></div>
<div style="position:absolute;left:84.62px;top:541.09px" class="cls_004"><span class="cls_004">I use SDF in this chapter: it allows the entire language to be described in a concise,</span></div>
<div style="position:absolute;left:84.62px;top:553.04px" class="cls_004"><span class="cls_004">readable and directly usable formalism, with little meta-syntactic overhead.</span></div>
<div style="position:absolute;left:64.20px;top:574.65px" class="cls_013"><span class="cls_013"><sup>1</sup></span><span class="cls_014">Actually, this is the only shift/reduce conflict in the language, so generalised LR parsing is not that important</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">here, except that it enables scannerless parsing.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">64</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:48300px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background073.jpg" width=481 height=680></div>
<div style="position:absolute;left:374.57px;top:17.14px" class="cls_004"><span class="cls_004">4.2. Syntax</span></div>
<div style="position:absolute;left:73.84px;top:45.04px" class="cls_004"><span class="cls_004">The current Nix implementation unfortunately does not use the SDF parser (</span><span class="cls_007">sglr</span><span class="cls_004">) for</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">performance reasons (scannerless parsing in particular is expensive). Rather, it uses Bi-</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">son [66], which is the GNU implementation of Yacc [103]. It recently added support for</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">GLR parsing, but still requires a separate lexical scanner. The Flex lexical scanner gener-</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">ator [130], an implementation of Lex [113], is used for lexical analysis.</span></div>
<div style="position:absolute;left:73.84px;top:105.07px" class="cls_004"><span class="cls_004">The following is a brief overview of SDF necessary to understand the Nix grammar. A</span></div>
<div style="position:absolute;left:63.87px;top:117.02px" class="cls_004"><span class="cls_004">full specification of SDF can be found in [175].  An SDF grammar contains production</span></div>
<div style="position:absolute;left:63.87px;top:128.98px" class="cls_004"><span class="cls_004">rules of the form</span></div>
<div style="position:absolute;left:88.78px;top:151.39px" class="cls_004"><span class="cls_004">symbols → nt</span></div>
<div style="position:absolute;left:63.87px;top:173.81px" class="cls_004"><span class="cls_004">where symbols is a sequence of terminals and non-terminals, and nt is the non-terminal pro-</span></div>
<div style="position:absolute;left:63.87px;top:185.77px" class="cls_004"><span class="cls_004">duced by the production rule. This notation is somewhat untraditional: most context-free</span></div>
<div style="position:absolute;left:63.87px;top:197.72px" class="cls_004"><span class="cls_004">grammar formalisms are written the other way around (nt ← symbols or nt → symbols).</span></div>
<div style="position:absolute;left:63.87px;top:209.68px" class="cls_004"><span class="cls_004">The left-hand side can contain various types of syntactic sugar:</span></div>
<div style="position:absolute;left:78.82px;top:230.35px" class="cls_004"><span class="cls_004">• Regular expressions to denote lexical elements.</span></div>
<div style="position:absolute;left:78.82px;top:251.27px" class="cls_004"><span class="cls_004">• The usual EBNF constructs: repetition (</span><span class="cls_007">S*</span><span class="cls_004">), choice (</span><span class="cls_007">S?</span><span class="cls_004">), and grouping (</span><span class="cls_007">(S)</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:73.84px;top:271.95px" class="cls_004"><span class="cls_004">SDF has two kinds of productions: those defining the lexical syntax, and those defining</span></div>
<div style="position:absolute;left:63.87px;top:283.90px" class="cls_004"><span class="cls_004">the context-free syntax. Lexical syntax is used to define the tokens of the language. An</span></div>
<div style="position:absolute;left:63.87px;top:295.86px" class="cls_004"><span class="cls_004">example of the first is the definition of the non-terminal for identifiers:</span></div>
<div style="position:absolute;left:88.78px;top:320.79px" class="cls_015"><span class="cls_015">lexical  syntax</span></div>
<div style="position:absolute;left:98.19px;top:331.75px" class="cls_015"><span class="cls_015">[a-zA-Z\_][a-zA-Z0-9\_\']*  ->  Id</span></div>
<div style="position:absolute;left:63.87px;top:347.17px" class="cls_004"><span class="cls_004">This defines identifiers using a regular expression: they start with a letter or underscore,</span></div>
<div style="position:absolute;left:63.87px;top:359.13px" class="cls_004"><span class="cls_004">and are followed by zero or more letters, digits, underscores, and accents.</span></div>
<div style="position:absolute;left:73.84px;top:371.33px" class="cls_004"><span class="cls_004">Layout—whitespace and comments that can occur anywhere between tokens—is also</span></div>
<div style="position:absolute;left:63.87px;top:383.29px" class="cls_004"><span class="cls_004">defined using lexical syntax productions. For example, the production</span></div>
<div style="position:absolute;left:98.19px;top:408.22px" class="cls_015"><span class="cls_015">[\  \t\n]  ->  LAYOUT</span></div>
<div style="position:absolute;left:63.87px;top:423.64px" class="cls_004"><span class="cls_004">says that spaces, tabs and newlines are all layout. There is a built-in production that says</span></div>
<div style="position:absolute;left:63.87px;top:435.59px" class="cls_004"><span class="cls_004">that sequences of layout are also layout. The non-terminal</span><span class="cls_007"> LAYOUT</span><span class="cls_004"> has a special status,</span></div>
<div style="position:absolute;left:63.87px;top:447.55px" class="cls_004"><span class="cls_004">as it is automatically inserted between all symbols in the productions of the context-free</span></div>
<div style="position:absolute;left:63.87px;top:459.50px" class="cls_004"><span class="cls_004">syntax.</span></div>
<div style="position:absolute;left:73.84px;top:470.68px" class="cls_004"><span class="cls_004">For example, the following context-free syntax</span><span class="cls_012"><sup>2</sup></span><span class="cls_004"> rule defines a production for a simple</span></div>
<div style="position:absolute;left:63.87px;top:483.66px" class="cls_004"><span class="cls_004">expression language:</span></div>
<div style="position:absolute;left:88.78px;top:508.60px" class="cls_015"><span class="cls_015">context-free  syntax</span></div>
<div style="position:absolute;left:98.19px;top:519.56px" class="cls_015"><span class="cls_015">Expr  "+"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:63.87px;top:534.98px" class="cls_004"><span class="cls_004">This rule is (essentially) desugared to</span></div>
<div style="position:absolute;left:98.19px;top:559.91px" class="cls_015"><span class="cls_015">LAYOUT?  Expr  LAYOUT?  "+"  LAYOUT?  Expr  LAYOUT?  ->  Expr</span></div>
<div style="position:absolute;left:68.36px;top:574.65px" class="cls_013"><span class="cls_013"><sup>2</sup></span><span class="cls_014">The term “context-free syntax” in SDF is a bit confusing, as both its “lexical syntax” and “context-free syntax”</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">are combined to a single context-free grammar.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">65</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:48990px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background074.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:69.68px;top:45.04px" class="cls_004"><span class="cls_004">SDF allows priorities and associativities to be defined to disambiguate otherwise am-</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">biguous grammars. The following example defines left-associative productions for addi-</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">tion and multiplication in a simple expression language, and then defines that multiplica-</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">tion takes precedence over addition:</span></div>
<div style="position:absolute;left:84.62px;top:103.97px" class="cls_015"><span class="cls_015">context-free  syntax</span></div>
<div style="position:absolute;left:94.04px;top:114.93px" class="cls_015"><span class="cls_015">Expr  "+"  Expr  ->  Expr  {left}</span></div>
<div style="position:absolute;left:94.04px;top:125.89px" class="cls_015"><span class="cls_015">Expr  "*"  Expr  ->  Expr  {left}</span></div>
<div style="position:absolute;left:84.62px;top:136.85px" class="cls_015"><span class="cls_015">context-free  priorities</span></div>
<div style="position:absolute;left:94.04px;top:147.81px" class="cls_015"><span class="cls_015">Expr  "*"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:84.62px;top:158.76px" class="cls_015"><span class="cls_015">> Expr  "+"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:69.68px;top:172.31px" class="cls_004"><span class="cls_004">Finally, there are typically all sorts of ambiguities between the lexical elements of a lan-</span></div>
<div style="position:absolute;left:59.72px;top:184.27px" class="cls_004"><span class="cls_004">guage. For instance, the string</span><span class="cls_007"> if</span><span class="cls_004"> can be parsed as the identifier</span><span class="cls_007"> "if"</span><span class="cls_004">, a sequence of identifiers</span></div>
<div style="position:absolute;left:59.72px;top:196.22px" class="cls_007"><span class="cls_007">i</span><span class="cls_004"> and</span><span class="cls_007"> f</span><span class="cls_004">, and the keyword</span><span class="cls_007"> if</span><span class="cls_004"> (assuming that the language has a production containing such a</span></div>
<div style="position:absolute;left:59.72px;top:208.18px" class="cls_004"><span class="cls_004">keyword). The SDF features of rejects and follow restrictions enforce the correct parsing.</span></div>
<div style="position:absolute;left:59.72px;top:220.13px" class="cls_004"><span class="cls_004">This declaration says that</span><span class="cls_007"> if</span><span class="cls_004"> should not be parsed as an identifier:</span></div>
<div style="position:absolute;left:84.62px;top:243.20px" class="cls_015"><span class="cls_015">lexical  syntax</span></div>
<div style="position:absolute;left:94.04px;top:254.16px" class="cls_015"><span class="cls_015">"if"  ->  Id  {reject}</span></div>
<div style="position:absolute;left:59.72px;top:267.71px" class="cls_004"><span class="cls_004">Technically, this defines a production that whenever it matches at some point with the</span></div>
<div style="position:absolute;left:59.72px;top:279.66px" class="cls_004"><span class="cls_004">input, it causes any other</span><span class="cls_007"> Id</span><span class="cls_004"> production for those same characters to be rejected. To prevent</span></div>
<div style="position:absolute;left:59.72px;top:291.62px" class="cls_004"><span class="cls_004">a sequence of identifier characters from being interpreted as a sequence of identifiers, a</span></div>
<div style="position:absolute;left:59.72px;top:303.57px" class="cls_004"><span class="cls_004">follow restriction can be used:</span></div>
<div style="position:absolute;left:84.62px;top:326.64px" class="cls_015"><span class="cls_015">lexical  restrictions</span></div>
<div style="position:absolute;left:94.04px;top:337.59px" class="cls_015"><span class="cls_015">Id  -/-  [a-zA-Z0-9\_\']</span></div>
<div style="position:absolute;left:59.72px;top:351.14px" class="cls_004"><span class="cls_004">This says that an</span><span class="cls_007"> Id</span><span class="cls_004"> cannot be followed by a character matching the given character class.</span></div>
<div style="position:absolute;left:59.72px;top:363.10px" class="cls_004"><span class="cls_004">Thus,</span><span class="cls_007"> xy</span><span class="cls_004"> cannot be parsed as the identifiers</span><span class="cls_007"> x</span><span class="cls_004"> and</span><span class="cls_007"> y</span><span class="cls_004">, since</span><span class="cls_007"> x</span><span class="cls_004"> is followed by a letter.</span></div>
<div style="position:absolute;left:59.72px;top:390.57px" class="cls_008"><span class="cls_008">4.2.1. Lexical syntax</span></div>
<div style="position:absolute;left:59.72px;top:410.04px" class="cls_004"><span class="cls_004">We start with the lexical syntax of Nix expressions. It is divided into two parts: the defini-</span></div>
<div style="position:absolute;left:59.72px;top:422.00px" class="cls_004"><span class="cls_004">tion of the layout, and of the actual information-carrying tokens of the language.</span></div>
<div style="position:absolute;left:69.68px;top:433.95px" class="cls_004"><span class="cls_004">Figure 4.1 shows the SDF module that defines the layout of the language. (SDF gram-</span></div>
<div style="position:absolute;left:59.72px;top:445.91px" class="cls_004"><span class="cls_004">mars are modular in order to allow the different aspects of a language to be defined sepa-</span></div>
<div style="position:absolute;left:59.72px;top:457.87px" class="cls_004"><span class="cls_004">rately, and to make it easier to combine grammars.) Layout consists of whitespace (spaces,</span></div>
<div style="position:absolute;left:59.72px;top:469.82px" class="cls_004"><span class="cls_004">tabs and newlines) and comments. It is worth noting that the language supports two styles</span></div>
<div style="position:absolute;left:59.72px;top:481.78px" class="cls_004"><span class="cls_004">of comments:</span></div>
<div style="position:absolute;left:84.62px;top:504.84px" class="cls_015"><span class="cls_015">(x:  x)  #  Single-line  comments  like  this</span></div>
<div style="position:absolute;left:84.62px;top:515.80px" class="cls_015"><span class="cls_015">"foo"  +  /*  Multi-line</span></div>
<div style="position:absolute;left:94.04px;top:526.76px" class="cls_015"><span class="cls_015">comments  like  this  */  "bar"</span></div>
<div style="position:absolute;left:69.68px;top:540.31px" class="cls_004"><span class="cls_004">Figure 4.2 defines the remainder of the lexical syntax of the language. The token types</span></div>
<div style="position:absolute;left:59.72px;top:552.26px" class="cls_004"><span class="cls_004">defined here are identifiers (which are exactly as described in the</span><span class="cls_007"> Id</span><span class="cls_004"> example above), and</span></div>
<div style="position:absolute;left:59.72px;top:564.22px" class="cls_004"><span class="cls_004">various kinds of constants defined using regular expressions. These are:</span></div>
<div style="position:absolute;left:74.66px;top:583.02px" class="cls_004"><span class="cls_004">• Natural numbers (</span><span class="cls_007">Int</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">66</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:49680px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background075.jpg" width=481 height=680></div>
<div style="position:absolute;left:374.57px;top:17.14px" class="cls_004"><span class="cls_004">4.2. Syntax</span></div>
<div style="position:absolute;left:67.26px;top:49.20px" class="cls_015"><span class="cls_015">module  Nix-Layout</span></div>
<div style="position:absolute;left:67.26px;top:60.16px" class="cls_015"><span class="cls_015">exports</span></div>
<div style="position:absolute;left:76.67px;top:71.12px" class="cls_015"><span class="cls_015">sorts  HashComment  Asterisk  Comment</span></div>
<div style="position:absolute;left:76.67px;top:82.08px" class="cls_015"><span class="cls_015">lexical  syntax</span></div>
<div style="position:absolute;left:86.09px;top:93.03px" class="cls_015"><span class="cls_015">[\  \t\n]</span></div>
<div style="position:absolute;left:142.56px;top:93.03px" class="cls_015"><span class="cls_015">->  LAYOUT</span></div>
<div style="position:absolute;left:86.09px;top:103.99px" class="cls_015"><span class="cls_015">HashComment  ->  LAYOUT</span></div>
<div style="position:absolute;left:86.09px;top:114.95px" class="cls_015"><span class="cls_015">Comment</span></div>
<div style="position:absolute;left:142.56px;top:114.95px" class="cls_015"><span class="cls_015">->  LAYOUT</span></div>
<div style="position:absolute;left:86.09px;top:125.91px" class="cls_015"><span class="cls_015">"#"  ~[\n]*  ->  HashComment</span></div>
<div style="position:absolute;left:86.09px;top:136.87px" class="cls_015"><span class="cls_015">"/*"  (  ~[\*]  |  Asterisk  )*  "*/"  ->  Comment</span></div>
<div style="position:absolute;left:86.09px;top:147.83px" class="cls_015"><span class="cls_015">[\*]  ->  Asterisk</span></div>
<div style="position:absolute;left:76.67px;top:158.79px" class="cls_015"><span class="cls_015">lexical  restrictions</span></div>
<div style="position:absolute;left:86.09px;top:169.75px" class="cls_015"><span class="cls_015">Asterisk  -/-  [\/]</span></div>
<div style="position:absolute;left:86.09px;top:180.71px" class="cls_015"><span class="cls_015">HashComment  -/-  ~[\n]</span></div>
<div style="position:absolute;left:76.67px;top:191.66px" class="cls_015"><span class="cls_015">context-free  restrictions</span></div>
<div style="position:absolute;left:86.09px;top:202.62px" class="cls_015"><span class="cls_015">LAYOUT?  -/-  [\  \t\n]</span></div>
<div style="position:absolute;left:166.31px;top:219.21px" class="cls_004"><span class="cls_004">Figure 4.1.: Layout in Nix expressions</span></div>
<div style="position:absolute;left:78.82px;top:251.53px" class="cls_004"><span class="cls_004">• Strings (</span><span class="cls_007">Str</span><span class="cls_004">) enclosed between double quotes. Characters are escaped by prefixing</span></div>
<div style="position:absolute;left:88.78px;top:263.49px" class="cls_004"><span class="cls_004">them with a backslash.</span></div>
<div style="position:absolute;left:78.82px;top:283.96px" class="cls_004"><span class="cls_004">• Paths (</span><span class="cls_007">Path</span><span class="cls_004">) are essentially sequences of characters with at least one forward slash in</span></div>
<div style="position:absolute;left:88.78px;top:295.92px" class="cls_004"><span class="cls_004">them. To be precise, they are sequences of path components separated by slashes. A</span></div>
<div style="position:absolute;left:88.78px;top:306.85px" class="cls_004"><span class="cls_004">path component consists of one or more letters, digits, and some other characters</span><span class="cls_012"><sup>3</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:88.78px;top:319.83px" class="cls_004"><span class="cls_004">The initial path component, i.e., the one before the first slash, may be omitted. If it</span></div>
<div style="position:absolute;left:88.78px;top:331.78px" class="cls_004"><span class="cls_004">is omitted, we have an absolute path, e.g.,</span><span class="cls_007"> /home/alice/.profile</span><span class="cls_004">. If it is present, we</span></div>
<div style="position:absolute;left:88.78px;top:343.74px" class="cls_004"><span class="cls_004">have a relative path, e.g.,</span><span class="cls_007"> ../../foo/builder.sh</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:78.82px;top:364.21px" class="cls_004"><span class="cls_004">• URIs (</span><span class="cls_007">Uri</span><span class="cls_004">) are a convenience for the specification of URIs in, e.g., calls to the func-</span></div>
<div style="position:absolute;left:88.78px;top:376.17px" class="cls_004"><span class="cls_004">tion</span><span class="cls_007"> fetchurl</span><span class="cls_004">. The advantage of having URIs as a language construct over simply us-</span></div>
<div style="position:absolute;left:88.78px;top:388.12px" class="cls_004"><span class="cls_004">ing strings is that the user gets syntax checking, and can omit the enclosing quotes.</span></div>
<div style="position:absolute;left:88.78px;top:400.08px" class="cls_004"><span class="cls_004">The regular expression for URIs used here follows [12, Appendix A].</span></div>
<div style="position:absolute;left:73.84px;top:420.41px" class="cls_004"><span class="cls_004">The remainder of Figure 4.2 is concerned with rejects and follow restrictions.  Note</span></div>
<div style="position:absolute;left:63.87px;top:432.37px" class="cls_004"><span class="cls_004">that the keywords of the language (used in the context-free syntax below) must be given</span></div>
<div style="position:absolute;left:63.87px;top:444.32px" class="cls_004"><span class="cls_004">twice, first to reject them as identifiers, and second to prevent them from being followed</span></div>
<div style="position:absolute;left:63.87px;top:456.28px" class="cls_004"><span class="cls_004">by identifier characters (e.g.,</span><span class="cls_007"> ifx</span><span class="cls_004"> should not be parsed as the keyword</span><span class="cls_007"> if</span><span class="cls_004"> followed by the</span></div>
<div style="position:absolute;left:63.87px;top:468.23px" class="cls_004"><span class="cls_004">variable</span><span class="cls_007"> x</span><span class="cls_004">). That we have to specify keywords twice is a current infelicity of SDF.</span></div>
<div style="position:absolute;left:73.84px;top:480.33px" class="cls_004"><span class="cls_004">Also note that Booleans (</span><span class="cls_007">true</span><span class="cls_004"> and</span><span class="cls_007"> false</span><span class="cls_004">) are not specially defined here. Rather,</span><span class="cls_007"> true</span><span class="cls_004"> and</span></div>
<div style="position:absolute;left:63.87px;top:492.28px" class="cls_007"><span class="cls_007">false</span><span class="cls_004"> are parsed as identifiers and interpreted as built-in nullary functions during execution,</span></div>
<div style="position:absolute;left:63.87px;top:504.24px" class="cls_004"><span class="cls_004">as discussed in the semantics below.</span></div>
<div style="position:absolute;left:63.87px;top:532.71px" class="cls_008"><span class="cls_008">4.2.2. Context-free syntax</span></div>
<div style="position:absolute;left:63.87px;top:552.45px" class="cls_004"><span class="cls_004">Figure 4.3 shows the context-free syntax of the language.  A parse of a Nix expression</span></div>
<div style="position:absolute;left:63.87px;top:564.40px" class="cls_004"><span class="cls_004">must match an</span><span class="cls_007"> Expr</span><span class="cls_004"> non-terminal</span><span class="cls_014"> </span><span class="cls_056">34</span><span class="cls_059"> </span><span class="cls_004">. Almost all productions here produce</span><span class="cls_007"> Expr</span><span class="cls_004">s. In that</span></div>
<div style="position:absolute;left:68.36px;top:584.11px" class="cls_013"><span class="cls_013"><sup>3</sup></span><span class="cls_014">So currently there is no way to define paths that contain characters not in this set.</span></div>
<div style="position:absolute;left:412.21px;top:624.86px" class="cls_004"><span class="cls_004">67</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:50370px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background076.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:63.10px;top:49.20px" class="cls_015"><span class="cls_015">module  Nix-Lexicals</span></div>
<div style="position:absolute;left:63.10px;top:60.16px" class="cls_015"><span class="cls_015">exports</span></div>
<div style="position:absolute;left:72.52px;top:71.12px" class="cls_015"><span class="cls_015">sorts  Id  Int  Str  Path  Uri</span></div>
<div style="position:absolute;left:72.52px;top:82.08px" class="cls_015"><span class="cls_015">lexical  syntax</span></div>
<div style="position:absolute;left:81.93px;top:93.03px" class="cls_015"><span class="cls_015">[a-zA-Z\_][a-zA-Z0-9\_\']*  ->  Id</span></div>
<div style="position:absolute;left:81.93px;top:103.99px" class="cls_015"><span class="cls_015">"rec"  |  "let"  |  "if"  |  "then"  |  "else"  |</span></div>
<div style="position:absolute;left:81.93px;top:114.95px" class="cls_015"><span class="cls_015">"assert"  |  "with"  |  "inherit"  ->  Id  {reject}</span></div>
<div style="position:absolute;left:81.93px;top:136.87px" class="cls_015"><span class="cls_015">[0-9]+  ->  Int</span></div>
<div style="position:absolute;left:81.93px;top:158.79px" class="cls_015"><span class="cls_015">"\""  ~[\n\"]*  "\""  ->  Str</span></div>
<div style="position:absolute;left:81.93px;top:180.71px" class="cls_015"><span class="cls_015">[a-zA-Z0-9\.\_\-\+]*  ("/"[a-zA-Z0-9\.\_\-\+]+)+  ->  Path</span></div>
<div style="position:absolute;left:81.93px;top:202.62px" class="cls_015"><span class="cls_015">[a-zA-Z]  [a-zA-Z0-9\+\-\.]*  ":"</span></div>
<div style="position:absolute;left:91.34px;top:213.58px" class="cls_015"><span class="cls_015">[a-zA-Z0-9\%\/\?\:\@\&\=\+\$\,\-\_\.\!\~\*\']*</span></div>
<div style="position:absolute;left:91.34px;top:224.54px" class="cls_015"><span class="cls_015">->  Uri</span></div>
<div style="position:absolute;left:72.52px;top:246.46px" class="cls_015"><span class="cls_015">lexical  restrictions</span></div>
<div style="position:absolute;left:81.93px;top:257.42px" class="cls_015"><span class="cls_015">Id  -/-  [a-zA-Z0-9\_\']</span></div>
<div style="position:absolute;left:81.93px;top:268.38px" class="cls_015"><span class="cls_015">Int  -/-  [0-9]</span></div>
<div style="position:absolute;left:81.93px;top:279.34px" class="cls_015"><span class="cls_015">Path  -/-  [a-zA-Z0-9\.\_\-\+\/]</span></div>
<div style="position:absolute;left:81.93px;top:290.29px" class="cls_015"><span class="cls_015">Uri  -/-  [a-zA-Z0-9\%\/\?\:\@\&\=\+\$\,\-\_\.\!\~\*\']</span></div>
<div style="position:absolute;left:81.93px;top:301.25px" class="cls_015"><span class="cls_015">"rec"  "let"  "if"  "then"  "else"</span></div>
<div style="position:absolute;left:81.93px;top:312.21px" class="cls_015"><span class="cls_015">"assert"  "with"  "inherit"  -/-  [A-Za-z0-9\_\']</span></div>
<div style="position:absolute;left:146.87px;top:328.93px" class="cls_004"><span class="cls_004">Figure 4.2.: Lexical syntax of Nix expressions</span></div>
<div style="position:absolute;left:59.72px;top:358.76px" class="cls_004"><span class="cls_004">respect the Nix expression grammar is quite flat: for instance, there is no separate gram-</span></div>
<div style="position:absolute;left:59.72px;top:370.71px" class="cls_004"><span class="cls_004">matical level for concepts such as modules, function definitions, and so on. Everything is</span></div>
<div style="position:absolute;left:59.72px;top:382.67px" class="cls_004"><span class="cls_004">an expression.</span></div>
<div style="position:absolute;left:69.68px;top:394.62px" class="cls_004"><span class="cls_004">The first production just injects the non-terminals for constants into</span><span class="cls_007"> Expr</span><span class="cls_014"> </span><span class="cls_056">35</span><span class="cls_059"> </span><span class="cls_004">. Of course,</span></div>
<div style="position:absolute;left:59.72px;top:406.58px" class="cls_004"><span class="cls_004">expressions can be enclosed in parentheses to override the normal precedence rules</span><span class="cls_014"> </span><span class="cls_056">36</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:418.54px" class="cls_004"><span class="cls_004">The language has two types of functions.  The first</span><span class="cls_014"> </span><span class="cls_056">37</span><span class="cls_059"> </span><span class="cls_004"> takes a single argument.  For</span></div>
<div style="position:absolute;left:59.72px;top:430.49px" class="cls_004"><span class="cls_004">instance, the (anonymous) identity function can be defined as follows:</span></div>
<div style="position:absolute;left:84.62px;top:452.46px" class="cls_015"><span class="cls_015">x:  x</span></div>
<div style="position:absolute;left:59.72px;top:464.91px" class="cls_004"><span class="cls_004">Of course, this style of function is just a plain λ -abstraction from the λ -calculus [10], as we</span></div>
<div style="position:absolute;left:59.72px;top:476.87px" class="cls_004"><span class="cls_004">will see in the discussion of the semantics below. Though this style only allows functions</span></div>
<div style="position:absolute;left:59.72px;top:488.82px" class="cls_004"><span class="cls_004">with a single argument, since this is a functional language we can still define (in a sense)</span></div>
<div style="position:absolute;left:59.72px;top:500.78px" class="cls_004"><span class="cls_004">functions with multiple arguments, e.g.,</span></div>
<div style="position:absolute;left:84.62px;top:522.75px" class="cls_015"><span class="cls_015">x:  y:  x  +  y</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">which is a function taking an argument</span><span class="cls_007"> x</span><span class="cls_004"> that returns another function that accepts an</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">argument</span><span class="cls_007"> y</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:559.11px" class="cls_004"><span class="cls_004">The second style of function definition</span><span class="cls_014"> </span><span class="cls_056">38</span><span class="cls_059"> </span><span class="cls_004">, which we have seen in Section 2.2, is more</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">important in this language. It takes an attribute set and binds the attributes defined therein</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">to local variables. Thus,</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">68</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:51060px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background077.jpg" width=481 height=680></div>
<div style="position:absolute;left:374.57px;top:17.14px" class="cls_004"><span class="cls_004">4.2. Syntax</span></div>
<div style="position:absolute;left:67.26px;top:108.85px" class="cls_015"><span class="cls_015">module  Nix-Exprs</span></div>
<div style="position:absolute;left:67.26px;top:119.81px" class="cls_015"><span class="cls_015">imports  Nix-Lexicals</span></div>
<div style="position:absolute;left:67.26px;top:130.77px" class="cls_015"><span class="cls_015">exports</span></div>
<div style="position:absolute;left:76.67px;top:141.73px" class="cls_015"><span class="cls_015">sorts  Expr  Formal  Bind  ExprList</span></div>
<div style="position:absolute;left:76.67px;top:152.69px" class="cls_015"><span class="cls_015">context-free  start-symbols  Expr</span></div>
<div style="position:absolute;left:228.67px;top:149.43px" class="cls_056"><span class="cls_056">34</span></div>
<div style="position:absolute;left:76.67px;top:163.65px" class="cls_015"><span class="cls_015">context-free  syntax</span></div>
<div style="position:absolute;left:86.09px;top:185.57px" class="cls_015"><span class="cls_015">Id  |  Int  |  Str  |  Uri  |  Path  ->  Expr</span></div>
<div style="position:absolute;left:256.90px;top:182.30px" class="cls_056"><span class="cls_056">35</span></div>
<div style="position:absolute;left:86.09px;top:207.48px" class="cls_015"><span class="cls_015">"("  Expr  ")"  ->  Expr</span></div>
<div style="position:absolute;left:186.31px;top:204.22px" class="cls_056"><span class="cls_056">36</span></div>
<div style="position:absolute;left:86.09px;top:229.40px" class="cls_015"><span class="cls_015">Id  ":"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:181.60px;top:226.14px" class="cls_056"><span class="cls_056">37</span></div>
<div style="position:absolute;left:86.09px;top:251.32px" class="cls_015"><span class="cls_015">"{"  {Formal  ","}*  "}"  ":"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:271.02px;top:248.06px" class="cls_056"><span class="cls_056">38</span></div>
<div style="position:absolute;left:86.09px;top:262.28px" class="cls_015"><span class="cls_015">Id</span></div>
<div style="position:absolute;left:142.56px;top:262.28px" class="cls_015"><span class="cls_015">->  Formal</span></div>
<div style="position:absolute;left:86.09px;top:273.24px" class="cls_015"><span class="cls_015">Id  "?"  Expr  ->  Formal</span></div>
<div style="position:absolute;left:86.09px;top:295.15px" class="cls_015"><span class="cls_015">Expr  Expr  ->  Expr</span></div>
<div style="position:absolute;left:172.19px;top:291.89px" class="cls_056"><span class="cls_056">39</span></div>
<div style="position:absolute;left:86.09px;top:317.07px" class="cls_015"><span class="cls_015">"assert"  Expr  ";"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:86.09px;top:338.99px" class="cls_015"><span class="cls_015">"with"  Expr  ";"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:223.96px;top:335.73px" class="cls_056"><span class="cls_056">40</span></div>
<div style="position:absolute;left:86.09px;top:360.91px" class="cls_015"><span class="cls_015">"{"  Bind*  "}"  ->  Expr</span></div>
<div style="position:absolute;left:191.02px;top:357.64px" class="cls_056"><span class="cls_056">41</span></div>
<div style="position:absolute;left:86.09px;top:371.87px" class="cls_015"><span class="cls_015">"rec"  "{"  Bind*  "}"  ->  Expr</span></div>
<div style="position:absolute;left:86.09px;top:382.83px" class="cls_015"><span class="cls_015">"let"  "{"  Bind*  "}"  ->  Expr</span></div>
<div style="position:absolute;left:86.09px;top:404.74px" class="cls_015"><span class="cls_015">Expr  "."  Id  ->  Expr</span></div>
<div style="position:absolute;left:86.09px;top:426.66px" class="cls_015"><span class="cls_015">Id  "="  Expr  ";"</span></div>
<div style="position:absolute;left:246.10px;top:426.66px" class="cls_015"><span class="cls_015">->  Bind</span></div>
<div style="position:absolute;left:285.14px;top:423.40px" class="cls_056"><span class="cls_056">42</span></div>
<div style="position:absolute;left:86.09px;top:437.62px" class="cls_015"><span class="cls_015">"inherit"  ("("  Expr  ")")?  Id*  ";"</span></div>
<div style="position:absolute;left:246.10px;top:437.62px" class="cls_015"><span class="cls_015">->  Bind</span></div>
<div style="position:absolute;left:86.09px;top:459.54px" class="cls_015"><span class="cls_015">"["  ExprList  "]"  ->  Expr</span></div>
<div style="position:absolute;left:205.14px;top:456.27px" class="cls_056"><span class="cls_056">43</span></div>
<div style="position:absolute;left:86.09px;top:470.50px" class="cls_015"><span class="cls_015">""  ->  ExprList</span></div>
<div style="position:absolute;left:86.09px;top:481.46px" class="cls_015"><span class="cls_015">Expr  ExprList  ->  ExprList</span></div>
<div style="position:absolute;left:86.09px;top:503.37px" class="cls_015"><span class="cls_015">"if"  Expr  "then"  Expr  "else"  Expr</span></div>
<div style="position:absolute;left:246.10px;top:503.37px" class="cls_015"><span class="cls_015">->  Expr</span></div>
<div style="position:absolute;left:285.14px;top:500.11px" class="cls_056"><span class="cls_056">44</span></div>
<div style="position:absolute;left:140.79px;top:521.21px" class="cls_004"><span class="cls_004">Figure 4.3.: Context-free syntax of Nix expressions</span></div>
<div style="position:absolute;left:412.21px;top:624.86px" class="cls_004"><span class="cls_004">69</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:51750px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background078.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:84.62px;top:50.30px" class="cls_015"><span class="cls_015">{x,  y}:  x  +  y</span></div>
<div style="position:absolute;left:59.72px;top:65.64px" class="cls_004"><span class="cls_004">declares a function that accepts an attribute set with attributes</span><span class="cls_007"> x</span><span class="cls_004"> and</span><span class="cls_007"> y</span><span class="cls_004"> (and nothing else),</span></div>
<div style="position:absolute;left:59.72px;top:77.60px" class="cls_004"><span class="cls_004">and the expression</span></div>
<div style="position:absolute;left:84.62px;top:102.46px" class="cls_015"><span class="cls_015">({x,  y}:  x  +  y)  {y  =  "bar";  x  =  "foo";}</span></div>
<div style="position:absolute;left:59.72px;top:117.81px" class="cls_004"><span class="cls_004">yields</span><span class="cls_007"> "foobar"</span><span class="cls_004">. The formal (expected) argument can have a default value, allowing it to be</span></div>
<div style="position:absolute;left:59.72px;top:129.77px" class="cls_004"><span class="cls_004">omitted. So</span></div>
<div style="position:absolute;left:84.62px;top:154.63px" class="cls_015"><span class="cls_015">({x,  y  ?  "bar"}:  x  +  y)  {x  =  "foo";}</span></div>
<div style="position:absolute;left:59.72px;top:169.98px" class="cls_004"><span class="cls_004">also evaluates to</span><span class="cls_007"> "foobar"</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:182.16px" class="cls_004"><span class="cls_004">Following the tradition of most functional languages, function calls are written by juxta-</span></div>
<div style="position:absolute;left:59.72px;top:194.12px" class="cls_004"><span class="cls_004">position, i.e.,</span><span class="cls_007"> f x</span><span class="cls_004"> instead of, say,</span><span class="cls_007"> f(x)</span><span class="cls_004">. Whether the absence of an argument delimeter makes</span></div>
<div style="position:absolute;left:59.72px;top:206.07px" class="cls_004"><span class="cls_004">function calls more or less readable is a matter of controversy. However, most calls in Nix</span></div>
<div style="position:absolute;left:59.72px;top:218.03px" class="cls_004"><span class="cls_004">expressions pass argument sets, which are enclosed in curly braces and therefore delimited</span></div>
<div style="position:absolute;left:59.72px;top:229.98px" class="cls_004"><span class="cls_004">anyway (i.e.,</span><span class="cls_007"> f {</span><span class="cls_004">attrs</span><span class="cls_007">}</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:69.68px;top:242.16px" class="cls_004"><span class="cls_004">Assertions have been discussed in Section 2.2 (page 33). With expressions</span><span class="cls_014"> </span><span class="cls_056">40</span><span class="cls_004"> allow all</span></div>
<div style="position:absolute;left:59.72px;top:254.12px" class="cls_004"><span class="cls_004">attributes in an attribute set to be added to the lexical scope. For example,</span></div>
<div style="position:absolute;left:84.62px;top:278.98px" class="cls_015"><span class="cls_015">with  {y  =  "bar";  x  =  "foo";};  x  +  y</span></div>
<div style="position:absolute;left:59.72px;top:294.33px" class="cls_004"><span class="cls_004">evaluates to</span><span class="cls_007"> "foobar"</span><span class="cls_004">; the variables</span><span class="cls_007"> x</span><span class="cls_004"> and</span><span class="cls_007"> y</span><span class="cls_004"> defined in the attribute set are in scope in the</span></div>
<div style="position:absolute;left:59.72px;top:306.29px" class="cls_004"><span class="cls_004">expression</span><span class="cls_007"> x + y</span><span class="cls_004">. This construct is primarily useful in conjunction with</span><span class="cls_007"> import</span><span class="cls_004">, allowing</span></div>
<div style="position:absolute;left:59.72px;top:318.24px" class="cls_004"><span class="cls_004">values to be “included” from an attribute set defined in a file:</span></div>
<div style="position:absolute;left:84.62px;top:343.11px" class="cls_015"><span class="cls_015">with  (import  ./definitions.nix);  x  +  y</span></div>
<div style="position:absolute;left:59.72px;top:358.46px" class="cls_004"><span class="cls_004">In essence, this enables a “conventional” module system: commonly used definitions can</span></div>
<div style="position:absolute;left:59.72px;top:370.41px" class="cls_004"><span class="cls_004">be placed in a separate file, and imported into the lexical scope of an expression in another</span></div>
<div style="position:absolute;left:59.72px;top:382.37px" class="cls_004"><span class="cls_004">file. But note that contrary to most module systems,</span><span class="cls_007"> with</span><span class="cls_004"> and</span><span class="cls_007"> import</span><span class="cls_004"> enable a “policy-free”</span></div>
<div style="position:absolute;left:59.72px;top:394.32px" class="cls_004"><span class="cls_004">module system: for instance, imports can occur in any expression, not just at top level.</span></div>
<div style="position:absolute;left:69.68px;top:406.50px" class="cls_004"><span class="cls_004">The various types of attribute set definitions</span></div>
<div style="position:absolute;left:256.99px;top:406.50px" class="cls_056"><span class="cls_056">41</span><span class="cls_059"> </span><span class="cls_004">—plain, recursive, and lets—are dis-</span></div>
<div style="position:absolute;left:59.72px;top:418.46px" class="cls_004"><span class="cls_004">cussed in more detail below. All three contain lists of attributes enclosed in curly braces.</span></div>
<div style="position:absolute;left:59.72px;top:430.41px" class="cls_004"><span class="cls_004">There are two kinds of attribute definitions</span><span class="cls_014"> </span><span class="cls_056">42</span><span class="cls_059"> </span><span class="cls_004">: plain name/value pairs, and</span><span class="cls_007"> inherit</span><span class="cls_004">s, which</span></div>
<div style="position:absolute;left:59.72px;top:442.37px" class="cls_004"><span class="cls_004">copy the value of an attribute from the surrounding lexical scope or an optional expression.</span></div>
<div style="position:absolute;left:69.68px;top:454.55px" class="cls_004"><span class="cls_004">Lists</span><span class="cls_014"> </span><span class="cls_056">43</span><span class="cls_004"> are enclosed in square brackets, and the list elements are juxtaposed, not sepa-</span></div>
<div style="position:absolute;left:59.72px;top:466.50px" class="cls_004"><span class="cls_004">rated by an explicit delimiter. For instance,</span></div>
<div style="position:absolute;left:84.62px;top:491.37px" class="cls_015"><span class="cls_015">[1  2  3]</span></div>
<div style="position:absolute;left:59.72px;top:506.72px" class="cls_004"><span class="cls_004">is a list of three elements. More importantly,</span></div>
<div style="position:absolute;left:84.62px;top:531.58px" class="cls_015"><span class="cls_015">[a  b  c]</span></div>
<div style="position:absolute;left:59.72px;top:545.90px" class="cls_004"><span class="cls_004">is also a list of three elements, not a call to function</span><span class="cls_007"> a</span><span class="cls_004"> with arguments</span><span class="cls_007"> b</span><span class="cls_004"> and</span><span class="cls_007"> c</span><span class="cls_012"><sup>4</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:559.11px" class="cls_004"><span class="cls_004">Finally, the language has conditionals</span><span class="cls_014"> </span><span class="cls_056">44</span><span class="cls_059"> </span><span class="cls_004">. There is only an</span><span class="cls_007"> if...then...else</span><span class="cls_004"> construct and</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">no</span><span class="cls_007"> if...then</span><span class="cls_004">, since the latter does not make sense in a functional setting as it leaves the</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">value of the expression undefined in case of a</span><span class="cls_007"> false</span><span class="cls_004"> condition. Assertions already serve this</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">70</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:52440px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background079.jpg" width=481 height=680></div>
<div style="position:absolute;left:361.29px;top:17.14px" class="cls_004"><span class="cls_004">4.3. Semantics</span></div>
<div style="position:absolute;left:86.09px;top:49.95px" class="cls_015"><span class="cls_015">Expr  "=="  Expr  ->  Expr  {non-assoc}</span></div>
<div style="position:absolute;left:86.09px;top:60.90px" class="cls_015"><span class="cls_015">Expr  "!="  Expr  ->  Expr  {non-assoc}</span></div>
<div style="position:absolute;left:86.09px;top:82.82px" class="cls_015"><span class="cls_015">"!"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:86.09px;top:93.78px" class="cls_015"><span class="cls_015">Expr  "&&"  Expr  ->  Expr  {right}</span></div>
<div style="position:absolute;left:86.09px;top:104.74px" class="cls_015"><span class="cls_015">Expr  "||"  Expr  ->  Expr  {right}</span></div>
<div style="position:absolute;left:86.09px;top:115.70px" class="cls_015"><span class="cls_015">Expr  "->"  Expr  ->  Expr  {right}</span></div>
<div style="position:absolute;left:86.09px;top:137.62px" class="cls_015"><span class="cls_015">Expr  "//"  Expr  ->  Expr  {right}</span></div>
<div style="position:absolute;left:86.09px;top:148.58px" class="cls_015"><span class="cls_015">Expr  "~"  Expr  ->  Expr  {non-assoc}</span></div>
<div style="position:absolute;left:86.09px;top:159.53px" class="cls_015"><span class="cls_015">Expr  "?"  Id  ->  Expr</span></div>
<div style="position:absolute;left:86.09px;top:170.49px" class="cls_015"><span class="cls_015">Expr  "+"  Expr  ->  Expr  {left}</span></div>
<div style="position:absolute;left:118.22px;top:188.33px" class="cls_004"><span class="cls_004">Figure 4.4.: Context-free syntax of Nix expressions: Operators</span></div>
<div style="position:absolute;left:63.87px;top:221.76px" class="cls_004"><span class="cls_004">purpose—they abort evaluation if the condition is</span><span class="cls_007"> false</span><span class="cls_004">. Note that due to the absence of an</span></div>
<div style="position:absolute;left:63.87px;top:233.71px" class="cls_007"><span class="cls_007">if...then</span><span class="cls_004">, there is no “dangling else” problem.</span></div>
<div style="position:absolute;left:73.84px;top:246.36px" class="cls_004"><span class="cls_004">Figure 4.4 continues the context-free syntax. It defines operators, along with their asso-</span></div>
<div style="position:absolute;left:63.87px;top:258.31px" class="cls_004"><span class="cls_004">ciativities. The meaning of the operators is given below.</span></div>
<div style="position:absolute;left:73.84px;top:270.96px" class="cls_004"><span class="cls_004">Figure 4.5 defines the relative precedences of all language constructs. Functions bind the</span></div>
<div style="position:absolute;left:63.87px;top:282.91px" class="cls_004"><span class="cls_004">weakest, and thus the body of a function extends maximally to the right unless the function</span></div>
<div style="position:absolute;left:63.87px;top:294.87px" class="cls_004"><span class="cls_004">is enclosed in parentheses. Assertions, with-expressions and conditions are the next level,</span></div>
<div style="position:absolute;left:63.87px;top:306.82px" class="cls_004"><span class="cls_004">followed by the operators. Function application binds very strongly. These priorities cause</span></div>
<div style="position:absolute;left:63.87px;top:318.78px" class="cls_004"><span class="cls_004">the following example expression:</span></div>
<div style="position:absolute;left:88.78px;top:345.04px" class="cls_015"><span class="cls_015">{x}:  assert  true;  f  x  !=  !g  y</span></div>
<div style="position:absolute;left:63.87px;top:361.78px" class="cls_004"><span class="cls_004">to be parsed as:</span></div>
<div style="position:absolute;left:88.78px;top:388.03px" class="cls_015"><span class="cls_015">({x}:  (assert  (true);  ((f  x)  !=  (!(g  y)))))</span></div>
<div style="position:absolute;left:63.87px;top:417.25px" class="cls_011"><span class="cls_011">4.3. Semantics</span></div>
<div style="position:absolute;left:63.87px;top:443.78px" class="cls_004"><span class="cls_004">This section gives the formal semantics of the Nix expression language.</span></div>
<div style="position:absolute;left:63.87px;top:475.30px" class="cls_008"><span class="cls_008">4.3.1. Basic values</span></div>
<div style="position:absolute;left:63.87px;top:496.09px" class="cls_004"><span class="cls_004">The basic (data) values of the Nix expression language, in addition to natural numbers,</span></div>
<div style="position:absolute;left:63.87px;top:508.04px" class="cls_004"><span class="cls_004">strings, paths, and URIs described above, are the following:</span></div>
<div style="position:absolute;left:78.82px;top:530.04px" class="cls_004"><span class="cls_004">• Null values, denoted as the built-in nullary function</span><span class="cls_007"> null</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:78.82px;top:552.73px" class="cls_004"><span class="cls_004">• Booleans, denoted as the built-in nullary functions</span><span class="cls_007"> true</span><span class="cls_004"> and</span><span class="cls_007"> false</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:68.36px;top:574.65px" class="cls_013"><span class="cls_013"><sup>4</sup></span><span class="cls_014">The reason that there is a</span><span class="cls_016"> ExprList</span><span class="cls_014"> non-terminal is actually for this very reason: we cannot write</span><span class="cls_016"> Expr*</span><span class="cls_014"> in the</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">production rule for lists, since then we are not able to give it a priority relative to function calls.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">71</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:53130px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background080.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4.</span></div>
<div style="position:absolute;left:72.17px;top:17.14px" class="cls_004"><span class="cls_004">The Nix Expression Language</span></div>
<div style="position:absolute;left:72.52px;top:49.20px" class="cls_015"><span class="cls_015">context-free  priorities</span></div>
<div style="position:absolute;left:81.93px;top:60.16px" class="cls_015"><span class="cls_015">Expr  "."  Id  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:71.12px" class="cls_015"><span class="cls_015">> Expr  ExprList  ->  ExprList</span></div>
<div style="position:absolute;left:72.52px;top:82.08px" class="cls_015"><span class="cls_015">> Expr  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:93.03px" class="cls_015"><span class="cls_015">> Expr  "~"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:103.99px" class="cls_015"><span class="cls_015">> Expr  "?"  Id  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:114.95px" class="cls_015"><span class="cls_015">> Expr  "+"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:125.91px" class="cls_015"><span class="cls_015">> "!"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:136.87px" class="cls_015"><span class="cls_015">> Expr  "//"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:147.83px" class="cls_015"><span class="cls_015">> Expr  "=="  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:158.79px" class="cls_015"><span class="cls_015">> Expr  "!="  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:169.75px" class="cls_015"><span class="cls_015">> Expr  "&&"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:180.71px" class="cls_015"><span class="cls_015">> Expr  "||"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:191.66px" class="cls_015"><span class="cls_015">> Expr  "->"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:202.62px" class="cls_015"><span class="cls_015">> "if"  Expr  "then"  Expr  "else"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:213.58px" class="cls_015"><span class="cls_015">> "assert"  Expr  ";"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:224.54px" class="cls_015"><span class="cls_015">> "with"  Expr  ";"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:235.50px" class="cls_015"><span class="cls_015">> Id  ":"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:72.52px;top:246.46px" class="cls_015"><span class="cls_015">> "{"  {Formal  ","}*  "}"  ":"  Expr  ->  Expr</span></div>
<div style="position:absolute;left:115.44px;top:264.30px" class="cls_004"><span class="cls_004">Figure 4.5.: Context-free syntax of Nix expressions: Priorities</span></div>
<div style="position:absolute;left:74.66px;top:294.67px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:294.67px" class="cls_004"><span class="cls_004">Subpaths are a somewhat obscure language feature that allows files in derivations to</span></div>
<div style="position:absolute;left:84.62px;top:306.62px" class="cls_004"><span class="cls_004">be referenced from other derivations. This is useful if a derivation (as is typical) pro-</span></div>
<div style="position:absolute;left:84.62px;top:318.58px" class="cls_004"><span class="cls_004">duces a directory tree, and we are interested in a particular file in that tree. Suppose</span></div>
<div style="position:absolute;left:84.62px;top:330.53px" class="cls_004"><span class="cls_004">that we have a variable</span><span class="cls_007"> perl</span><span class="cls_004"> that refers to a derivation that builds Perl. The output</span></div>
<div style="position:absolute;left:84.62px;top:342.49px" class="cls_004"><span class="cls_004">of this derivation is a directory at some path p. Suppose now that we want to use</span></div>
<div style="position:absolute;left:84.62px;top:354.44px" class="cls_004"><span class="cls_004">the Perl interpreter as the builder of some other derivation. However, the interpreter</span></div>
<div style="position:absolute;left:84.62px;top:366.40px" class="cls_004"><span class="cls_004">is a program stored not at p but at p +</span><span class="cls_007"> "/bin/perl"</span><span class="cls_004">. With subpaths, we can write the</span></div>
<div style="position:absolute;left:84.62px;top:378.35px" class="cls_004"><span class="cls_004">following:</span></div>
<div style="position:absolute;left:106.54px;top:401.70px" class="cls_015"><span class="cls_015">derivation  {  ...</span></div>
<div style="position:absolute;left:115.95px;top:412.66px" class="cls_015"><span class="cls_015">builder  =  perl  ~  /bin/perl;</span></div>
<div style="position:absolute;left:106.54px;top:423.62px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:84.62px;top:437.45px" class="cls_004"><span class="cls_004">The operator</span><span class="cls_015"> ~</span><span class="cls_004"> is the constructor of subpath values. We need subpaths in order to</span></div>
<div style="position:absolute;left:84.62px;top:449.41px" class="cls_004"><span class="cls_004">maintain the proper dependency relation between derivations. The above might have</span></div>
<div style="position:absolute;left:84.62px;top:461.36px" class="cls_004"><span class="cls_004">been written as:</span></div>
<div style="position:absolute;left:106.54px;top:484.71px" class="cls_015"><span class="cls_015">derivation  {  ...</span></div>
<div style="position:absolute;left:115.95px;top:495.67px" class="cls_015"><span class="cls_015">builder  =  perl.outPath  +  "/bin/perl";</span></div>
<div style="position:absolute;left:106.54px;top:506.63px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:84.62px;top:520.46px" class="cls_004"><span class="cls_004">That is, we compute the path of the builder through ordinary string concatenation</span></div>
<div style="position:absolute;left:84.62px;top:532.42px" class="cls_004"><span class="cls_004">(the</span><span class="cls_007"> outPath</span><span class="cls_004"> attribute contains the computed store path of the</span><span class="cls_007"> perl</span><span class="cls_004"> derivation). As</span></div>
<div style="position:absolute;left:84.62px;top:544.37px" class="cls_004"><span class="cls_004">we shall see in Section 5.4, this derivation will not properly identify</span><span class="cls_007"> perl</span><span class="cls_004"> as one of</span></div>
<div style="position:absolute;left:84.62px;top:555.30px" class="cls_004"><span class="cls_004">its dependencies. It will just have an opaque string value for its</span><span class="cls_007"> builder</span><span class="cls_004"> attribute</span><span class="cls_012"><sup>5</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:64.20px;top:574.65px" class="cls_013"><span class="cls_013"><sup>5</sup></span><span class="cls_014">Currently, direct references to</span><span class="cls_016"> outPath</span><span class="cls_014"> are not disallowed, so this unsafe example is actually possible. It can be</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">disallowed by restricting access to the</span><span class="cls_016"> outPath</span><span class="cls_014"> and</span><span class="cls_016"> drvPath</span><span class="cls_014"> attributes described in Section 5.4.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">72</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:53820px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background081.jpg" width=481 height=680></div>
<div style="position:absolute;left:361.29px;top:17.14px" class="cls_004"><span class="cls_004">4.3. Semantics</span></div>
<div style="position:absolute;left:73.84px;top:45.04px" class="cls_004"><span class="cls_004">All path values are internally in canonical form, meaning that they are not relative to</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">the current directory (i.e., start with</span><span class="cls_007"> /</span><span class="cls_004">), do not contain</span><span class="cls_007"> .</span><span class="cls_004">  or</span><span class="cls_007"> ..</span><span class="cls_004">  elements, do not contain</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">redundant separators (e.g.,</span><span class="cls_007"> //</span><span class="cls_004">), and do not end in a separator. Any relative paths in a Nix</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">expression are absolutised relative to the directory that contained the expression. For in-</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">stance, if the expression</span><span class="cls_007"> /foo/bar/expr.nix</span><span class="cls_004"> contains a path</span><span class="cls_007"> ../bla/builder.sh</span><span class="cls_004">, it is absolutised</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">to</span><span class="cls_007"> /foo/bla/builder.sh</span><span class="cls_004">. Sometimes Nix expressions are not specified in a file but given on</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">the command line or passed through standard input, e.g., in</span><span class="cls_007"> nix-env</span><span class="cls_004"> and</span><span class="cls_007"> nix-instantiate</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">Such paths are absolutised relative to the current directory. In the semantic rules below we</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">will make use of a function</span><span class="cls_007"> canonicalise</span><span class="cls_004">(p, d) (whose definition is omitted on grounds of</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">dullness) that yields a canonical representation of path p, absolutised relative to directory</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">d if necessary.</span></div>
<div style="position:absolute;left:63.87px;top:193.24px" class="cls_008"><span class="cls_008">4.3.2. Compound values</span></div>
<div style="position:absolute;left:63.87px;top:213.04px" class="cls_004"><span class="cls_004">The language has two ways to form compound data structures: lists and attribute sets.</span></div>
<div style="position:absolute;left:63.87px;top:240.50px" class="cls_009"><span class="cls_009">Lists</span><span class="cls_004">   Lists are enclosed in square brackets, as described above. List elements are lazy, so</span></div>
<div style="position:absolute;left:63.87px;top:252.45px" class="cls_004"><span class="cls_004">they are only evaluated when needed. Currently, the language has very limited facilities for</span></div>
<div style="position:absolute;left:63.87px;top:264.41px" class="cls_004"><span class="cls_004">list manipulation. There is a built-in function</span><span class="cls_007"> map</span><span class="cls_004"> that applies a function to all elements in</span></div>
<div style="position:absolute;left:63.87px;top:276.36px" class="cls_004"><span class="cls_004">a list. Lists can be included in derivations, as we will see in Section 5.4. Other than that,</span></div>
<div style="position:absolute;left:63.87px;top:288.32px" class="cls_004"><span class="cls_004">there are no operations on lists.</span></div>
<div style="position:absolute;left:63.87px;top:315.78px" class="cls_009"><span class="cls_009">Attribute sets</span><span class="cls_004">   The most important data type in the language is the attribute set, which is</span></div>
<div style="position:absolute;left:63.87px;top:327.73px" class="cls_004"><span class="cls_004">a set of name/value pairs, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:352.42px" class="cls_015"><span class="cls_015">{ x = "foo"; y = 123; }</span></div>
<div style="position:absolute;left:63.87px;top:367.60px" class="cls_004"><span class="cls_004">Attribute names are identifiers, and attribute values are arbitrary expressions. The order of</span></div>
<div style="position:absolute;left:63.87px;top:379.56px" class="cls_004"><span class="cls_004">attributes is irrelevant, but any atttribute name can occur only once in a set. Attributes can</span></div>
<div style="position:absolute;left:63.87px;top:391.51px" class="cls_004"><span class="cls_004">be selected using the</span><span class="cls_007"> .</span><span class="cls_004"> operator:</span></div>
<div style="position:absolute;left:88.78px;top:416.20px" class="cls_015"><span class="cls_015">{ x = "foo"; y = 123; }.y</span></div>
<div style="position:absolute;left:63.87px;top:431.38px" class="cls_004"><span class="cls_004">This expression evaluates to</span><span class="cls_007"> 123</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:443.51px" class="cls_004"><span class="cls_004">Recursive attribute sets allow attribute values to refer to each other. They are constructed</span></div>
<div style="position:absolute;left:63.87px;top:455.46px" class="cls_004"><span class="cls_004">using the</span><span class="cls_007"> rec</span><span class="cls_004"> keyword. Formally, each attribute in the set is added to the scope of the entire</span></div>
<div style="position:absolute;left:63.87px;top:467.42px" class="cls_004"><span class="cls_004">attribute set. Hence,</span></div>
<div style="position:absolute;left:88.78px;top:492.11px" class="cls_015"><span class="cls_015">rec  {  x  =  y;  y  =  123;  }.x</span></div>
<div style="position:absolute;left:63.87px;top:507.29px" class="cls_004"><span class="cls_004">evaluates to</span><span class="cls_007"> 123</span><span class="cls_004">.  If</span><span class="cls_007"> rec</span><span class="cls_004"> were omitted, the identifier</span><span class="cls_007"> y</span><span class="cls_004"> in the definition of the attribute</span><span class="cls_007"> x</span></div>
<div style="position:absolute;left:63.87px;top:519.24px" class="cls_004"><span class="cls_004">would refer to some</span><span class="cls_007"> y</span><span class="cls_004"> bound in the surrounding scope. Recursive attribute sets introduce</span></div>
<div style="position:absolute;left:63.87px;top:531.20px" class="cls_004"><span class="cls_004">the possibility of recursion, including non-termination:</span></div>
<div style="position:absolute;left:88.78px;top:555.89px" class="cls_015"><span class="cls_015">rec  {  x  =  x;  }.x</span></div>
<div style="position:absolute;left:73.84px;top:571.07px" class="cls_004"><span class="cls_004">A let-expression, constructed using the</span><span class="cls_007"> let</span><span class="cls_004"> keyword, is syntactic sugar for a recursive</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">attribute set that automatically selects the special attribute</span><span class="cls_007"> body</span><span class="cls_004"> from the set. Thus,</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">73</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:54510px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background082.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:84.62px;top:50.30px" class="cls_015"><span class="cls_015">let  {  body  =  a  ++  b;  a  =  "foo";  b  =  "bar";  }</span></div>
<div style="position:absolute;left:59.72px;top:68.76px" class="cls_004"><span class="cls_004">evaluates to</span><span class="cls_007"> "foobar"</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:81.97px" class="cls_004"><span class="cls_004">As we saw above, when defining an attribute set, attributes values can be inherited from</span></div>
<div style="position:absolute;left:59.72px;top:93.93px" class="cls_004"><span class="cls_004">the surrounding lexical scope or from other attribute sets. The expression</span></div>
<div style="position:absolute;left:84.62px;top:121.91px" class="cls_015"><span class="cls_015">x:  {  inherit  x;  y  =  123;  }</span></div>
<div style="position:absolute;left:59.72px;top:140.36px" class="cls_004"><span class="cls_004">defines a function that returns an attribute set with two attributes:</span><span class="cls_007"> x</span><span class="cls_004"> which is inherited from</span></div>
<div style="position:absolute;left:59.72px;top:152.32px" class="cls_004"><span class="cls_004">the function argument named</span><span class="cls_007"> x</span><span class="cls_004">, and</span><span class="cls_007"> y</span><span class="cls_004"> which is declared normally. The</span><span class="cls_007"> inherit</span><span class="cls_004"> construct is</span></div>
<div style="position:absolute;left:59.72px;top:164.28px" class="cls_004"><span class="cls_004">just syntactic sugar. The example above could also be written as</span></div>
<div style="position:absolute;left:84.62px;top:192.25px" class="cls_015"><span class="cls_015">x:  {  x  =  x;  y  =  123;  }</span></div>
<div style="position:absolute;left:59.72px;top:210.71px" class="cls_004"><span class="cls_004">Note that the right-hand side of the attribute</span><span class="cls_007"> x = x</span><span class="cls_004"> refers to the function argument</span><span class="cls_007"> x</span><span class="cls_004">, not to</span></div>
<div style="position:absolute;left:59.72px;top:222.67px" class="cls_004"><span class="cls_004">the attribute</span><span class="cls_007"> x</span><span class="cls_004">. Thus,</span><span class="cls_007"> x = x</span><span class="cls_004"> is not a recursive definition.</span></div>
<div style="position:absolute;left:69.68px;top:235.88px" class="cls_004"><span class="cls_004">Likewise, attributes can be inherited from other attribute sets:</span></div>
<div style="position:absolute;left:84.62px;top:263.86px" class="cls_015"><span class="cls_015">rec  {</span></div>
<div style="position:absolute;left:94.04px;top:274.82px" class="cls_015"><span class="cls_015">as1  =  {x  =  1;  y  =  2;  z  =  3;};</span></div>
<div style="position:absolute;left:94.04px;top:285.78px" class="cls_015"><span class="cls_015">as2  =  {inherit  (as1)  x  y;  z  =  4;};</span></div>
<div style="position:absolute;left:84.62px;top:296.74px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:59.72px;top:315.20px" class="cls_004"><span class="cls_004">Here the set</span><span class="cls_007"> as2</span><span class="cls_004"> copies attributes</span><span class="cls_007"> x</span><span class="cls_004"> and</span><span class="cls_007"> y</span><span class="cls_004"> from set</span><span class="cls_007"> as1</span><span class="cls_004">. It desugars to</span></div>
<div style="position:absolute;left:84.62px;top:343.17px" class="cls_015"><span class="cls_015">rec  {</span></div>
<div style="position:absolute;left:94.04px;top:354.13px" class="cls_015"><span class="cls_015">as1  =  {x  =  1;  y  =  2;  z  =  3;};</span></div>
<div style="position:absolute;left:94.04px;top:365.09px" class="cls_015"><span class="cls_015">as2  =  {x  =  as1.x;  y  =  as1.y;  z  =  4;};</span></div>
<div style="position:absolute;left:84.62px;top:376.05px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:69.68px;top:394.51px" class="cls_004"><span class="cls_004">However, the situation is a bit more complicated for</span><span class="cls_007"> rec</span><span class="cls_004"> attribute sets, whose attributes</span></div>
<div style="position:absolute;left:59.72px;top:406.46px" class="cls_004"><span class="cls_004">are mutually recursive, i.e., are in each other’s scope. The intended semantics of</span><span class="cls_007"> inherit</span><span class="cls_004"> is</span></div>
<div style="position:absolute;left:59.72px;top:418.42px" class="cls_004"><span class="cls_004">still the same: values are inherited from the surrounding scope. But simply desugaring is</span></div>
<div style="position:absolute;left:59.72px;top:430.37px" class="cls_004"><span class="cls_004">no longer enough. So if we desugar</span></div>
<div style="position:absolute;left:84.62px;top:458.35px" class="cls_015"><span class="cls_015">x:  rec  {  inherit  x;  y  =  123;  }</span></div>
<div style="position:absolute;left:59.72px;top:476.81px" class="cls_004"><span class="cls_004">to</span></div>
<div style="position:absolute;left:84.62px;top:504.79px" class="cls_015"><span class="cls_015">x:  rec  {  x  =  x;  y  =  123;  }</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">we have incorrectly created an infinite recursion: the attribute</span><span class="cls_007"> x</span><span class="cls_004"> now evaluates to itself,</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">rather than the value of the function argument</span><span class="cls_007"> x</span><span class="cls_004">. For this reason</span><span class="cls_007"> rec</span><span class="cls_004"> is actually internally</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">stored as two sets of attributes: the recursive attributes, and the non-recursive attributes.</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">The latter are simply the inherited attributes. We denote this internally used representation</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">of</span><span class="cls_007"> rec</span><span class="cls_004"> sets as</span><span class="cls_007"> rec {</span><span class="cls_004">as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">/as</span><span class="cls_012"><sub>2</sub></span><span class="cls_007">}</span><span class="cls_004">, where as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> and as</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> are the recursive and non-recursive attributes,</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">respectively.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">74</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:55200px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background083.jpg" width=481 height=680></div>
<div style="position:absolute;left:361.29px;top:17.14px" class="cls_004"><span class="cls_004">4.3. Semantics</span></div>
<div style="position:absolute;left:198.87px;top:38.85px" class="cls_004"><span class="cls_004">{</span></div>
<div style="position:absolute;left:206.89px;top:49.10px" class="cls_004"><span class="cls_004">e  if (x ⇝ e) ∈ subs</span></div>
<div style="position:absolute;left:72.24px;top:55.89px" class="cls_007"><span class="cls_007">subst</span><span class="cls_004">(subs, x)</span></div>
<div style="position:absolute;left:188.91px;top:55.89px" class="cls_004"><span class="cls_004">=</span></div>
<div style="position:absolute;left:206.89px;top:63.45px" class="cls_004"><span class="cls_004">x  otherwise</span></div>
<div style="position:absolute;left:72.24px;top:82.79px" class="cls_007"><span class="cls_007">subst</span><span class="cls_004">(subs, {as})</span></div>
<div style="position:absolute;left:188.92px;top:82.79px" class="cls_004"><span class="cls_004">= {</span><span class="cls_007">map</span><span class="cls_004">(λ </span><span class="cls_037">〈</span><span class="cls_004">n = e</span><span class="cls_037">〉</span><span class="cls_004">.</span><span class="cls_037">〈</span><span class="cls_004">n =</span><span class="cls_007"> subst</span><span class="cls_004">(subs, e)</span><span class="cls_037">〉</span><span class="cls_004">, as)}</span></div>
<div style="position:absolute;left:72.24px;top:109.69px" class="cls_007"><span class="cls_007">subst</span><span class="cls_004">(subs,</span><span class="cls_007"> rec</span><span class="cls_004"> {as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">/as</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">})</span></div>
<div style="position:absolute;left:188.92px;top:108.17px" class="cls_004"><span class="cls_004">=</span><span class="cls_007"> rec</span><span class="cls_004"> {</span><span class="cls_007"> map</span><span class="cls_004">(λ </span><span class="cls_037">〈</span><span class="cls_004">n = e</span><span class="cls_037">〉</span><span class="cls_004">.</span><span class="cls_037">〈</span><span class="cls_004">n =</span><span class="cls_007"> subst</span><span class="cls_004">(subs</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, e)</span><span class="cls_037">〉</span><span class="cls_004">, as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:214.65px;top:124.64px" class="cls_004"><span class="cls_004">/</span><span class="cls_007"> map</span><span class="cls_004">(λ </span><span class="cls_037">〈</span><span class="cls_004">n = e</span><span class="cls_037">〉</span><span class="cls_004">.</span><span class="cls_037">〈</span><span class="cls_004">n =</span><span class="cls_007"> subst</span><span class="cls_004">(subs, e)</span><span class="cls_037">〉</span><span class="cls_004">, as</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">)}</span></div>
<div style="position:absolute;left:92.17px;top:135.27px" class="cls_004"><span class="cls_004">where subs</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> = {x ⇝ e|x ⇝ e ∈ subs ∧ x ∈</span><span class="cls_007"> names</span><span class="cls_004">(as)}</span></div>
<div style="position:absolute;left:72.24px;top:163.49px" class="cls_007"><span class="cls_007">subst</span><span class="cls_004">(subs,</span><span class="cls_007"> let</span><span class="cls_004"> {as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">/as</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">})</span></div>
<div style="position:absolute;left:188.92px;top:163.49px" class="cls_004"><span class="cls_004">= analogous to the</span><span class="cls_007"> rec</span><span class="cls_004"> case</span></div>
<div style="position:absolute;left:72.24px;top:190.39px" class="cls_007"><span class="cls_007">subst</span><span class="cls_004">(subs, x</span><span class="cls_007">:</span><span class="cls_004"> e)</span></div>
<div style="position:absolute;left:188.92px;top:189.07px" class="cls_004"><span class="cls_004">= x</span><span class="cls_007">: subst</span><span class="cls_004">(subs</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">,e)</span></div>
<div style="position:absolute;left:92.17px;top:201.03px" class="cls_004"><span class="cls_004">where subs</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> = {x</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> ⇝ e|x</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> ⇝ e ∈ subs ∧ x = x</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">}</span></div>
<div style="position:absolute;left:72.24px;top:229.24px" class="cls_007"><span class="cls_007">subst</span><span class="cls_004">(subs,</span><span class="cls_007"> {</span><span class="cls_004">fs</span><span class="cls_007">}:</span><span class="cls_004"> e)</span></div>
<div style="position:absolute;left:188.91px;top:227.93px" class="cls_004"><span class="cls_004">=</span><span class="cls_007"> {</span><span class="cls_004">fs</span><span class="cls_007">}: subst</span><span class="cls_004">(subs</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, e)</span></div>
<div style="position:absolute;left:92.17px;top:239.88px" class="cls_004"><span class="cls_004">where subs</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> = {x ⇝ e|x ⇝ e ∈ subs ∧ x ∈</span><span class="cls_007"> argNames</span><span class="cls_004">(fs)}</span></div>
<div style="position:absolute;left:179.00px;top:265.89px" class="cls_004"><span class="cls_004">Figure 4.6.:</span><span class="cls_007"> subst</span><span class="cls_004">: Substitutions</span></div>
<div style="position:absolute;left:63.87px;top:296.75px" class="cls_008"><span class="cls_008">4.3.3. Substitutions</span></div>
<div style="position:absolute;left:63.87px;top:315.20px" class="cls_004"><span class="cls_004">Variable substitution is an important operation in the evaluation process</span><span class="cls_012"><sup>6</sup></span><span class="cls_004">. The substitution</span></div>
<div style="position:absolute;left:63.87px;top:328.18px" class="cls_004"><span class="cls_004">function</span><span class="cls_007"> subst</span><span class="cls_004">(subs, e) performs a set of substitutions subs in the expression e.  The set</span></div>
<div style="position:absolute;left:63.87px;top:340.14px" class="cls_004"><span class="cls_004">subs consists of substitutions of the form x ⇝ e that replace a variable x with an expression</span></div>
<div style="position:absolute;left:63.87px;top:352.09px" class="cls_004"><span class="cls_004">e.</span></div>
<div style="position:absolute;left:73.84px;top:364.05px" class="cls_004"><span class="cls_004">Here and in the semantic rules below, the variable e ranges over expressions, x over vari-</span></div>
<div style="position:absolute;left:63.87px;top:376.00px" class="cls_004"><span class="cls_004">ables, p over paths, s over strings, and n over attribute names, with subscripts as appropri-</span></div>
<div style="position:absolute;left:63.87px;top:387.96px" class="cls_004"><span class="cls_004">ate. The members of attribute sets are denoted collectively as as, and we write </span><span class="cls_037">〈</span><span class="cls_004">n</span><span class="cls_007"> =</span><span class="cls_004"> e</span><span class="cls_037">〉</span><span class="cls_004"> ∈ as</span></div>
<div style="position:absolute;left:63.87px;top:399.91px" class="cls_004"><span class="cls_004">to denote that the attribute set as has an attribute named n with value e. The arguments of</span></div>
<div style="position:absolute;left:63.87px;top:411.87px" class="cls_004"><span class="cls_004">a multi-argument function are denoted as fs (for “formals”).</span></div>
<div style="position:absolute;left:73.84px;top:423.82px" class="cls_004"><span class="cls_004">The auxiliary function</span><span class="cls_007"> names</span><span class="cls_004">(as) yields the set of attribute names occurring in the left</span></div>
<div style="position:absolute;left:63.87px;top:435.78px" class="cls_004"><span class="cls_004">hand side of a set of attributes as.  Likewise,</span><span class="cls_007"> argNames</span><span class="cls_004">(fs) yields the set of names of</span></div>
<div style="position:absolute;left:63.87px;top:447.73px" class="cls_004"><span class="cls_004">formal arguments from a set of formal arguments (note that formal arguments can also</span></div>
<div style="position:absolute;left:63.87px;top:459.69px" class="cls_004"><span class="cls_004">contain defaults, which are left out by this function).</span></div>
<div style="position:absolute;left:73.84px;top:471.64px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> subst</span><span class="cls_004"> replaces all free variables for which there is a substitution. A variable</span></div>
<div style="position:absolute;left:63.87px;top:483.60px" class="cls_004"><span class="cls_004">is free in a subexpression if it is not bound by any of its enclosing expressions. Variables</span></div>
<div style="position:absolute;left:63.87px;top:495.55px" class="cls_004"><span class="cls_004">are bound in functions and in recursive attribute sets. In recursive attribute sets, only the</span></div>
<div style="position:absolute;left:63.87px;top:507.51px" class="cls_004"><span class="cls_004">recursive attributes (as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">) bind variables; the non-recursive attributes (as</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">) do not.  The</span></div>
<div style="position:absolute;left:63.87px;top:519.46px" class="cls_004"><span class="cls_004">function</span><span class="cls_007"> subst</span><span class="cls_004"> is shown in Figure 4.6. For all cases not specifically mentioned here, the</span></div>
<div style="position:absolute;left:63.87px;top:531.42px" class="cls_004"><span class="cls_004">substitution is recursively applied to all subexpressions. For instance, for function calls the</span></div>
<div style="position:absolute;left:63.87px;top:543.37px" class="cls_004"><span class="cls_004">following substitution is applied:</span></div>
<div style="position:absolute;left:88.78px;top:564.81px" class="cls_007"><span class="cls_007">subst</span><span class="cls_004">(subs, e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">) =</span><span class="cls_007"> subst</span><span class="cls_004">(subs, e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">)</span><span class="cls_007"> subst</span><span class="cls_004">(subs, e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:68.36px;top:584.11px" class="cls_013"><span class="cls_013"><sup>6</sup></span><span class="cls_014">The term substitution in this section has no relation to Nix’s substitute mechanism.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">75</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:55890px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background084.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">It is assumed that the substitution terms (i.e., the expressions in subs) contain no free</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">variables, so</span><span class="cls_007"> subst</span><span class="cls_004"> does not have to perform renaming to prevent name capture; the style</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">of evaluation used below allows us to get away with this.</span></div>
<div style="position:absolute;left:59.72px;top:102.47px" class="cls_008"><span class="cls_008">4.3.4. Evaluation rules</span></div>
<div style="position:absolute;left:59.72px;top:123.95px" class="cls_004"><span class="cls_004">The operational semantics of the language is specified using semantic rules of the form</span></div>
<div style="position:absolute;left:59.72px;top:135.91px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> → e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> that transform expression e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> into e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">. Rules may only be applied to closed terms,</span></div>
<div style="position:absolute;left:59.72px;top:147.86px" class="cls_004"><span class="cls_004">i.e., terms that have no free variables.  Thus it is not allowed to arbitrary apply rules to</span></div>
<div style="position:absolute;left:59.72px;top:159.82px" class="cls_004"><span class="cls_004">subterms.</span></div>
<div style="position:absolute;left:69.68px;top:172.83px" class="cls_004"><span class="cls_004">An expression e is in normal form if no rules are applicable. Not all normal forms are</span></div>
<div style="position:absolute;left:59.72px;top:184.78px" class="cls_004"><span class="cls_004">acceptable evaluation results. For example, no rule applies to the following expressions:</span></div>
<div style="position:absolute;left:84.62px;top:212.13px" class="cls_015"><span class="cls_015">x</span></div>
<div style="position:absolute;left:84.62px;top:223.09px" class="cls_015"><span class="cls_015">123  x</span></div>
<div style="position:absolute;left:84.62px;top:234.05px" class="cls_015"><span class="cls_015">assert  false;  123</span></div>
<div style="position:absolute;left:84.62px;top:245.01px" class="cls_015"><span class="cls_015">{x  =  123;}.y</span></div>
<div style="position:absolute;left:84.62px;top:255.97px" class="cls_015"><span class="cls_015">({x}:  x)  {y  =  123;}</span></div>
<div style="position:absolute;left:59.72px;top:273.80px" class="cls_004"><span class="cls_004">The predicate</span><span class="cls_007"> good</span><span class="cls_004">(e) defines whether an expression is a valid evaluation result. It is true</span></div>
<div style="position:absolute;left:59.72px;top:285.75px" class="cls_004"><span class="cls_004">if e is a basic or compound value or a function (lambda), and false otherwise. Since rules</span></div>
<div style="position:absolute;left:59.72px;top:297.71px" class="cls_004"><span class="cls_004">are only allowed to be applied to an expression at top level (i.e., not to subexpressions),</span></div>
<div style="position:absolute;left:59.72px;top:309.67px" class="cls_004"><span class="cls_004">a good normal form is in weak head normal form (WHNF) [133, Section 11.3.1]. Weak</span></div>
<div style="position:absolute;left:59.72px;top:321.62px" class="cls_004"><span class="cls_004">head normal form differs from the notion of head normal form in that right-hand sides of</span></div>
<div style="position:absolute;left:59.72px;top:333.58px" class="cls_004"><span class="cls_004">functions need not be normalised. A nice property of this style of evaluation is that there</span></div>
<div style="position:absolute;left:59.72px;top:345.53px" class="cls_004"><span class="cls_004">can be no name capture [10], which simplifies the evaluation machinery.</span></div>
<div style="position:absolute;left:292.94px;top:356.75px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:69.68px;top:359.79px" class="cls_004"><span class="cls_004">An expression e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> is said to evaluate to e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">, notation e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:289.80px;top:359.79px" class="cls_004"><span class="cls_004">→ e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">, if there exists a sequence</span></div>
<div style="position:absolute;left:59.72px;top:371.75px" class="cls_004"><span class="cls_004">of zero or more applications of semantic rules to e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">  that transform it into e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">  such that</span></div>
<div style="position:absolute;left:59.72px;top:383.70px" class="cls_004"><span class="cls_004">good(e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">) is true; i.e., the normal form must be good. In the implementation, if the normal</span></div>
<div style="position:absolute;left:59.72px;top:395.66px" class="cls_004"><span class="cls_004">form of e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> is not good, its evaluation triggers a runtime error (e.g., “undefined variable” or</span></div>
<div style="position:absolute;left:59.72px;top:407.61px" class="cls_004"><span class="cls_004">“assertion failed”).</span></div>
<div style="position:absolute;left:69.68px;top:420.62px" class="cls_004"><span class="cls_004">Not all expressions have a normal form. For instance, the expression</span></div>
<div style="position:absolute;left:84.62px;top:447.97px" class="cls_015"><span class="cls_015">(rec  {x  =  x;}).x</span></div>
<div style="position:absolute;left:59.72px;top:465.81px" class="cls_004"><span class="cls_004">does not terminate. But if evaluation does terminate, there must be a single normal form.</span></div>
<div style="position:absolute;left:59.72px;top:477.76px" class="cls_004"><span class="cls_004">That is, evaluation is confluent [5]. The confluence property follows from the fact that at</span></div>
<div style="position:absolute;left:59.72px;top:489.72px" class="cls_004"><span class="cls_004">most one rule applies to any expression. The implementation detects some types of infinite</span></div>
<div style="position:absolute;left:59.72px;top:501.67px" class="cls_004"><span class="cls_004">recursion, as discussed below.</span></div>
<div style="position:absolute;left:69.68px;top:514.68px" class="cls_004"><span class="cls_004">The semantic rules are stated below in the following general form:</span></div>
<div style="position:absolute;left:147.15px;top:536.66px" class="cls_004"><span class="cls_004">condition</span></div>
<div style="position:absolute;left:84.87px;top:543.41px" class="cls_004"><span class="cls_004">R</span><span class="cls_014">ULE</span><span class="cls_004">-N</span><span class="cls_014">AME</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:153.09px;top:549.95px" class="cls_004"><span class="cls_004">e→e</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:59.72px;top:570.04px" class="cls_004"><span class="cls_004">That is, we can conclude that e evaluates to e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> (e → e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">), if the proposition condition holds.</span></div>
<div style="position:absolute;left:59.72px;top:582.00px" class="cls_004"><span class="cls_004">If there are no conditions, the rule is simply written as R</span><span class="cls_014">ULE</span><span class="cls_004">-N</span><span class="cls_014">AME</span><span class="cls_004"> : e → e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">76</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:56580px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background085.jpg" width=481 height=680></div>
<div style="position:absolute;left:361.29px;top:17.14px" class="cls_004"><span class="cls_004">4.3. Semantics</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_009"><span class="cls_009">Attribute sets</span><span class="cls_004">   The S</span><span class="cls_014">ELECT</span><span class="cls_004"> rule implements attribute selection. This rule governs suc-</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">cessful selection, i.e., it applies only if the given attribute name exists in the attribute set.</span></div>
<div style="position:absolute;left:137.10px;top:76.75px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> {</span><span class="cls_004">as</span><span class="cls_007">}</span><span class="cls_004"> ∧ </span><span class="cls_037">〈</span><span class="cls_004">n</span><span class="cls_007"> =</span><span class="cls_004"> e</span><span class="cls_012"><sup>′</sup></span><span class="cls_037">〉</span><span class="cls_004"> ∈ as</span></div>
<div style="position:absolute;left:89.03px;top:84.52px" class="cls_004"><span class="cls_004">S</span><span class="cls_014">ELECT</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:160.27px;top:91.07px" class="cls_004"><span class="cls_004">e</span><span class="cls_007">.</span><span class="cls_004">n → e</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:63.87px;top:106.80px" class="cls_004"><span class="cls_004">Note that there is no rule for failure. If attribute n is not in as, evaluation fails and a nice</span></div>
<div style="position:absolute;left:63.87px;top:118.75px" class="cls_004"><span class="cls_004">error message is printed in the actual implementation.</span></div>
<div style="position:absolute;left:73.84px;top:130.71px" class="cls_004"><span class="cls_004">A recursive attribute set  is desugared to a normal attribute set by replacing all occur-</span></div>
<div style="position:absolute;left:63.87px;top:142.66px" class="cls_004"><span class="cls_004">rences of references to the attributes with the recursive attribute set. For instance, if e =</span></div>
<div style="position:absolute;left:63.87px;top:154.62px" class="cls_007"><span class="cls_007">rec {x = f x y; y = x;}</span><span class="cls_004">, then e is desugared to</span></div>
<div style="position:absolute;left:88.78px;top:176.89px" class="cls_015"><span class="cls_015">{ x = f (e.x) (e.y);</span></div>
<div style="position:absolute;left:98.19px;top:187.85px" class="cls_015"><span class="cls_015">y = e.x;</span></div>
<div style="position:absolute;left:88.78px;top:198.81px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:63.87px;top:211.57px" class="cls_004"><span class="cls_004">or in full,</span></div>
<div style="position:absolute;left:88.78px;top:233.85px" class="cls_015"><span class="cls_015">{ x = f ((rec {x = f x y; y = x;}).x)</span></div>
<div style="position:absolute;left:126.43px;top:244.80px" class="cls_015"><span class="cls_015">((rec  {x  =  f  x  y;  y  =  x;}).y);</span></div>
<div style="position:absolute;left:98.19px;top:255.76px" class="cls_015"><span class="cls_015">y = (rec {x = f x y; y = x;}).x;</span></div>
<div style="position:absolute;left:88.78px;top:266.72px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:73.84px;top:279.48px" class="cls_004"><span class="cls_004">This desugaring is implemented by the R</span><span class="cls_014">EC</span><span class="cls_004"> rule:</span></div>
<div style="position:absolute;left:89.03px;top:299.01px" class="cls_004"><span class="cls_004">R</span><span class="cls_014">EC </span><span class="cls_004">:</span><span class="cls_007"> rec {</span><span class="cls_004">as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">/as</span><span class="cls_012"><sub>2</sub></span><span class="cls_007">}</span><span class="cls_004"> →</span><span class="cls_007"> {subst</span><span class="cls_004">(subs,{as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">})∪as</span><span class="cls_012"><sub>2</sub></span><span class="cls_007">}</span></div>
<div style="position:absolute;left:63.87px;top:318.55px" class="cls_004"><span class="cls_004">where</span></div>
<div style="position:absolute;left:88.78px;top:338.08px" class="cls_004"><span class="cls_004">subs = {n ⇝</span><span class="cls_007"> (rec</span><span class="cls_004"> {as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">/as</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">}</span><span class="cls_007">).n</span><span class="cls_004"> | n ∈</span><span class="cls_007"> names</span><span class="cls_004">(as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> ∪ as</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">)}</span></div>
<div style="position:absolute;left:63.87px;top:357.61px" class="cls_004"><span class="cls_004">Contrary to what the reader might expect, this substitution does not lead to a potential ex-</span></div>
<div style="position:absolute;left:63.87px;top:369.56px" class="cls_004"><span class="cls_004">plosion in the size of expressions in our implementation, since we use ATerms that employ</span></div>
<div style="position:absolute;left:63.87px;top:381.52px" class="cls_004"><span class="cls_004">maximal sharing to store equal subterms exactly once, as discussed in Section 4.4.</span></div>
<div style="position:absolute;left:73.84px;top:393.47px" class="cls_004"><span class="cls_004">A let-expression is just syntactic sugar that automatically selects the attribute</span><span class="cls_007"> body</span><span class="cls_004"> from</span></div>
<div style="position:absolute;left:63.87px;top:405.43px" class="cls_004"><span class="cls_004">a recursive set of attributes:</span></div>
<div style="position:absolute;left:89.03px;top:424.96px" class="cls_004"><span class="cls_004">L</span><span class="cls_014">ET </span><span class="cls_004">:</span><span class="cls_007"> let {</span><span class="cls_004">as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">/as</span><span class="cls_012"><sub>2</sub></span><span class="cls_007">}</span><span class="cls_004"> →</span><span class="cls_007"> (rec {</span><span class="cls_004">as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">/as</span><span class="cls_012"><sub>2</sub></span><span class="cls_007">}).body</span></div>
<div style="position:absolute;left:63.87px;top:451.06px" class="cls_009"><span class="cls_009">Function calls</span><span class="cls_004">   Function calls to single-argument functions (i.e., lambdas) are just plain</span></div>
<div style="position:absolute;left:63.87px;top:463.01px" class="cls_004"><span class="cls_004">β -reduction in the λ -calculus [10].</span></div>
<div style="position:absolute;left:193.56px;top:480.84px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:179.60px;top:483.89px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:190.42px;top:483.89px" class="cls_004"><span class="cls_004">→ x</span><span class="cls_007">:</span><span class="cls_004"> e</span><span class="cls_012"><sub>3</sub></span></div>
<div style="position:absolute;left:88.78px;top:490.63px" class="cls_004"><span class="cls_004">β-R</span><span class="cls_014">EDUCE</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:143.85px;top:497.47px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> subst</span><span class="cls_004">({x ⇝ e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">},e</span><span class="cls_012"><sub>3</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:63.87px;top:515.28px" class="cls_004"><span class="cls_004">As we shall see in Theorem 2 (page 85), the expression e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">  contains no free variables.</span></div>
<div style="position:absolute;left:63.87px;top:527.24px" class="cls_004"><span class="cls_004">Therefore, there is no danger of name capture in</span><span class="cls_007"> subst</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:539.19px" class="cls_004"><span class="cls_004">Multi-argument function calls, i.e., functions that accept and open an attribute set, are a</span></div>
<div style="position:absolute;left:63.87px;top:551.15px" class="cls_004"><span class="cls_004">bit more complicated:</span></div>
<div style="position:absolute;left:161.62px;top:568.89px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:225.27px;top:568.89px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:147.66px;top:571.93px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:158.48px;top:571.93px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> {</span><span class="cls_004">fs</span><span class="cls_007">}:</span><span class="cls_004"> e</span><span class="cls_012"><sub>3</sub></span><span class="cls_004"> ∧ e</span><span class="cls_012"><sub>2</sub></span></div>
<div style="position:absolute;left:222.13px;top:571.93px" class="cls_004"><span class="cls_004">→ {as} ∧ match</span></div>
<div style="position:absolute;left:88.78px;top:578.68px" class="cls_004"><span class="cls_004">β-R</span><span class="cls_014">EDUCE</span><span class="cls_004">’ :</span></div>
<div style="position:absolute;left:172.69px;top:585.51px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> subst</span><span class="cls_004">(subs,e</span><span class="cls_012"><sub>3</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">77</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:57270px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background086.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">where</span></div>
<div style="position:absolute;left:86.09px;top:69.86px" class="cls_004"><span class="cls_004">match = (∀n ∈</span><span class="cls_007"> names</span><span class="cls_004">(as) : n ∈</span><span class="cls_007"> argNames</span><span class="cls_004">(fs)) ∧ (∀n ∈ fs : n ∈</span><span class="cls_007"> names</span><span class="cls_004">(as))</span></div>
<div style="position:absolute;left:92.58px;top:84.81px" class="cls_004"><span class="cls_004">subs = {n ⇝</span><span class="cls_007"> arg</span><span class="cls_004">(n) | n ∈</span><span class="cls_007"> argNames</span><span class="cls_004">(fs)}</span></div>
<div style="position:absolute;left:122.46px;top:92.77px" class="cls_004"><span class="cls_004">{</span></div>
<div style="position:absolute;left:130.48px;top:103.01px" class="cls_004"><span class="cls_004">e  if </span><span class="cls_037">〈</span><span class="cls_004">n = e</span><span class="cls_037">〉</span><span class="cls_004"> ∈ as</span></div>
<div style="position:absolute;left:84.62px;top:109.81px" class="cls_007"><span class="cls_007">arg</span><span class="cls_004">(n) =</span></div>
<div style="position:absolute;left:130.48px;top:117.36px" class="cls_004"><span class="cls_004">e  if n ∈</span><span class="cls_007"> names</span><span class="cls_004">(as) ∧ n ? e ∈ fs</span></div>
<div style="position:absolute;left:59.72px;top:142.88px" class="cls_004"><span class="cls_004">Note that a multi-argument function call is strict in its argument—the attribute set—but</span></div>
<div style="position:absolute;left:59.72px;top:154.83px" class="cls_004"><span class="cls_004">not in the values of the attributes. The Boolean value match ascertains whether each actual</span></div>
<div style="position:absolute;left:59.72px;top:166.79px" class="cls_004"><span class="cls_004">argument matches a formal argument, and whether each formal argument without a default</span></div>
<div style="position:absolute;left:59.72px;top:178.74px" class="cls_004"><span class="cls_004">matches an actual argument (note that ∀n ∈ fs does not apply to the formal arguments with</span></div>
<div style="position:absolute;left:59.72px;top:190.70px" class="cls_004"><span class="cls_004">defaults, which would be ∀n</span><span class="cls_007"> ?</span><span class="cls_004"> e ∈ fs). The function</span><span class="cls_007"> arg</span><span class="cls_004">(n) determines the actual value to</span></div>
<div style="position:absolute;left:59.72px;top:202.65px" class="cls_004"><span class="cls_004">use for formal argument n, taking it from as if it has an attribute n, and using the default in</span></div>
<div style="position:absolute;left:59.72px;top:214.61px" class="cls_004"><span class="cls_004">fs otherwise.</span></div>
<div style="position:absolute;left:59.72px;top:249.12px" class="cls_009"><span class="cls_009">Conditionals</span><span class="cls_004">   Conditional expressions first evaluate the condition expression.  It must</span></div>
<div style="position:absolute;left:59.72px;top:261.08px" class="cls_004"><span class="cls_004">evaluate to a Boolean. (Evaluation fails if it is not.) The conditional then evaluates to one</span></div>
<div style="position:absolute;left:59.72px;top:273.03px" class="cls_004"><span class="cls_004">of its alternatives.</span></div>
<div style="position:absolute;left:171.80px;top:294.00px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:321.53px;top:294.00px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:157.84px;top:297.05px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:168.66px;top:297.05px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:307.57px;top:297.05px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:318.40px;top:297.05px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:85.98px;top:303.80px" class="cls_004"><span class="cls_004">I</span><span class="cls_014">F</span><span class="cls_004">T</span><span class="cls_014">HEN</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:239.47px;top:303.80px" class="cls_004"><span class="cls_004">I</span><span class="cls_014">F</span><span class="cls_004">E</span><span class="cls_014">LSE</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:127.30px;top:310.63px" class="cls_007"><span class="cls_007">if</span><span class="cls_004"> e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> then</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_007"> else</span><span class="cls_004"> e</span><span class="cls_012"><sub>3</sub></span><span class="cls_004"> → e</span><span class="cls_012"><sub>2</sub></span></div>
<div style="position:absolute;left:278.58px;top:310.63px" class="cls_007"><span class="cls_007">if</span><span class="cls_004"> e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> then</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_007"> else</span><span class="cls_004"> e</span><span class="cls_012"><sub>3</sub></span><span class="cls_004"> → e</span><span class="cls_012"><sub>3</sub></span></div>
<div style="position:absolute;left:59.72px;top:342.56px" class="cls_009"><span class="cls_009">Assertions</span><span class="cls_004">   An assertion</span><span class="cls_007"> assert</span><span class="cls_004"> e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007">;</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> evaluates to e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> if e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> evaluates to</span><span class="cls_007"> true</span><span class="cls_004">. Otherwise,</span></div>
<div style="position:absolute;left:59.72px;top:354.52px" class="cls_004"><span class="cls_004">evaluation fails.</span></div>
<div style="position:absolute;left:158.61px;top:375.49px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:144.65px;top:378.54px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:155.47px;top:378.54px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:85.98px;top:385.28px" class="cls_004"><span class="cls_004">A</span><span class="cls_014">SSERT </span><span class="cls_004">:</span></div>
<div style="position:absolute;left:127.71px;top:392.11px" class="cls_007"><span class="cls_007">assert</span><span class="cls_004"> e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007">;</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> → e</span><span class="cls_012"><sub>2</sub></span></div>
<div style="position:absolute;left:59.72px;top:423.93px" class="cls_009"><span class="cls_009">Withs</span><span class="cls_004">   With-expressions</span><span class="cls_007"> with</span><span class="cls_004"> e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007">;</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> substitute the attributes defined in the attribute set e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:59.72px;top:435.89px" class="cls_004"><span class="cls_004">into the resulting expression e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:203.16px;top:458.91px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:189.20px;top:461.96px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:200.03px;top:461.96px" class="cls_004"><span class="cls_004">→ {as}</span></div>
<div style="position:absolute;left:84.87px;top:468.71px" class="cls_004"><span class="cls_004">W</span><span class="cls_014">ITH</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:117.67px;top:475.54px" class="cls_007"><span class="cls_007">with</span><span class="cls_004"> e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007">;</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> subst</span><span class="cls_004">({n ⇝ e | </span><span class="cls_037">〈</span><span class="cls_004">n</span><span class="cls_007"> =</span><span class="cls_004"> e</span><span class="cls_037">〉</span><span class="cls_004"> ∈ as}, e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:59.72px;top:508.34px" class="cls_009"><span class="cls_009">Operators</span><span class="cls_004">   The equality operators are defined as follows.</span></div>
<div style="position:absolute;left:133.53px;top:531.37px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:174.54px;top:531.37px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:258.39px;top:531.37px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:299.40px;top:531.37px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:119.57px;top:534.42px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:130.39px;top:533.39px" class="cls_004"><span class="cls_004">→e</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:171.40px;top:533.39px" class="cls_004"><span class="cls_004">→e</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:244.43px;top:534.42px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:255.25px;top:533.39px" class="cls_004"><span class="cls_004">→e</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:296.26px;top:533.39px" class="cls_004"><span class="cls_004">→e</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:84.87px;top:539.45px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">E</span><span class="cls_014">Q</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:146.99px;top:534.42px" class="cls_012"><span class="cls_012">1 </span><span class="cls_004">∧e</span><span class="cls_012">2</span></div>
<div style="position:absolute;left:188.00px;top:533.39px" class="cls_012"><span class="cls_012">2</span><span class="cls_004">∧e</span><span class="cls_012">1</span><span class="cls_004"> =e</span><span class="cls_012">2</span></div>
<div style="position:absolute;left:271.85px;top:534.42px" class="cls_012"><span class="cls_012">1 </span><span class="cls_004">∧e</span><span class="cls_012">2</span></div>
<div style="position:absolute;left:312.86px;top:533.39px" class="cls_012"><span class="cls_012">2</span><span class="cls_004">∧e</span><span class="cls_012">1</span><span class="cls_004"> =e</span><span class="cls_012">2</span></div>
<div style="position:absolute;left:143.94px;top:548.05px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> ==</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:267.26px;top:548.05px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> ==</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:59.72px;top:570.04px" class="cls_004"><span class="cls_004">Equality between expressions (e</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:192.01px;top:571.07px" class="cls_012"><span class="cls_012">1</span><span class="cls_004"> =</span></div>
<div style="position:absolute;left:209.77px;top:570.04px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:214.19px;top:571.07px" class="cls_012"><span class="cls_012">2</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:225.45px;top:571.07px" class="cls_004"><span class="cls_004">is syntactic.  Of course, inequality (e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> !=</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">) is</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">defined as the negation of equality.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">78</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:57960px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background087.jpg" width=481 height=680></div>
<div style="position:absolute;left:361.29px;top:17.14px" class="cls_004"><span class="cls_004">4.3. Semantics</span></div>
<div style="position:absolute;left:73.84px;top:45.04px" class="cls_004"><span class="cls_004">The Boolean operators are straightforward, although it is worth noting that conjunction</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">and disjunction (“and” and “or”) are lazy, i.e., “short-circuited”.</span></div>
<div style="position:absolute;left:146.11px;top:82.53px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:229.58px;top:82.53px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:88.18px;top:86.84px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">N</span><span class="cls_014">EG</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:139.77px;top:96.11px" class="cls_007"><span class="cls_007">!</span><span class="cls_004">e →</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:220.15px;top:96.11px" class="cls_007"><span class="cls_007">!</span><span class="cls_004">e →</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:166.21px;top:112.38px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:234.11px;top:112.38px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:152.25px;top:115.43px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:163.07px;top:115.43px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:220.15px;top:115.43px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:382.07px;top:115.43px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:88.18px;top:120.43px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">A</span><span class="cls_014">ND</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:139.47px;top:129.00px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> &&</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:231.37px;top:129.00px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> &&</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:334.48px;top:129.00px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> &&</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:162.99px;top:145.97px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:234.11px;top:145.97px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:149.03px;top:149.02px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:159.85px;top:149.02px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:220.15px;top:149.02px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:385.15px;top:149.02px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:88.18px;top:154.51px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">O</span><span class="cls_014">R</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:139.47px;top:162.60px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> || e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:236.13px;top:162.60px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> || e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:339.24px;top:162.60px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> || e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:163.39px;top:180.05px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:234.11px;top:180.05px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:149.43px;top:183.10px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:160.25px;top:183.10px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:220.15px;top:183.10px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:382.07px;top:183.10px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:88.18px;top:188.10px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">I</span><span class="cls_014">MPL</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:139.47px;top:196.68px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> → e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:232.65px;top:196.68px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> → e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:335.76px;top:196.68px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> → e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:73.84px;top:219.45px" class="cls_004"><span class="cls_004">The update operator e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> //</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> yields the right-biased union of the attribute sets e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> and e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">,</span></div>
<div style="position:absolute;left:63.87px;top:231.40px" class="cls_004"><span class="cls_004">that is, the set consisting of the attributes in e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> and e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">, with attributes in e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> overriding those</span></div>
<div style="position:absolute;left:63.87px;top:243.36px" class="cls_004"><span class="cls_004">in e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> if there are name conflicts.</span></div>
<div style="position:absolute;left:172.77px;top:265.19px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:158.81px;top:268.24px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:225.03px;top:268.24px" class="cls_004"><span class="cls_004">→ {as</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">}</span></div>
<div style="position:absolute;left:89.03px;top:274.99px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">U</span><span class="cls_014">PDATE </span><span class="cls_004">:</span></div>
<div style="position:absolute;left:144.41px;top:281.82px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> //</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> → {</span><span class="cls_007">rightUnion</span><span class="cls_004">(as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">,as</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">)}</span></div>
<div style="position:absolute;left:63.87px;top:304.39px" class="cls_004"><span class="cls_004">where</span></div>
<div style="position:absolute;left:88.78px;top:328.67px" class="cls_007"><span class="cls_007">rightUnion</span><span class="cls_004">(as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">, as</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">) = as</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> ∪ {</span><span class="cls_037">〈</span><span class="cls_004">n</span><span class="cls_007"> =</span><span class="cls_004"> e</span><span class="cls_037">〉</span><span class="cls_004"> | </span><span class="cls_037">〈</span><span class="cls_004">n</span><span class="cls_007"> =</span><span class="cls_004"> e</span><span class="cls_037">〉</span><span class="cls_004"> ∈ as</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> ∧ n ∈</span><span class="cls_007"> names</span><span class="cls_004">(as</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">)}</span></div>
<div style="position:absolute;left:73.84px;top:354.14px" class="cls_004"><span class="cls_004">Addition is defined between strings and between paths.</span></div>
<div style="position:absolute;left:163.67px;top:376.63px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:149.71px;top:379.68px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:200.99px;top:379.68px" class="cls_004"><span class="cls_004">→s</span><span class="cls_012"><sub>2</sub></span></div>
<div style="position:absolute;left:89.03px;top:386.42px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">P</span><span class="cls_014">LUS</span><span class="cls_004">S</span><span class="cls_014">TR</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:149.56px;top:393.26px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> +</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> → s</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> +</span><span class="cls_012"><sub>s</sub></span><span class="cls_004"> s</span><span class="cls_012"><sub>2</sub></span></div>
<div style="position:absolute;left:208.55px;top:405.82px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:194.59px;top:408.87px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:247.72px;top:408.87px" class="cls_004"><span class="cls_004">→p</span><span class="cls_012"><sub>2</sub></span></div>
<div style="position:absolute;left:89.03px;top:415.62px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">P</span><span class="cls_014">LUS</span><span class="cls_004">P</span><span class="cls_014">ATH </span><span class="cls_004">:</span></div>
<div style="position:absolute;left:154.54px;top:422.45px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_007"> +</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> canonicalise</span><span class="cls_004">(p</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> +</span><span class="cls_012"><sub>s</sub></span><span class="cls_007"> "/"</span><span class="cls_004">+</span><span class="cls_012"><sub>s</sub></span><span class="cls_004"> p</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:63.87px;top:445.02px" class="cls_004"><span class="cls_004">where +</span><span class="cls_012"><sub>s</sub></span><span class="cls_004"> denotes string concatenation.</span></div>
<div style="position:absolute;left:73.84px;top:458.16px" class="cls_004"><span class="cls_004">Finally, there is an operator ? to check attribute set membership. This is used to guard</span></div>
<div style="position:absolute;left:63.87px;top:470.12px" class="cls_004"><span class="cls_004">the use of attributes that may not be defined, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:497.85px" class="cls_015"><span class="cls_015">builder  =  if  args  ?  builder  then  args.builder  else  bash;</span></div>
<div style="position:absolute;left:63.87px;top:516.07px" class="cls_004"><span class="cls_004">It is implemented as follows.</span></div>
<div style="position:absolute;left:164.63px;top:541.60px" class="cls_004"><span class="cls_004">→ {as} ∧ n ∈</span><span class="cls_007"> names</span><span class="cls_004">(as)</span></div>
<div style="position:absolute;left:89.03px;top:548.35px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">H</span><span class="cls_014">AS</span><span class="cls_004">A</span><span class="cls_014">TTR</span><span class="cls_004">+ :</span></div>
<div style="position:absolute;left:184.10px;top:555.18px" class="cls_004"><span class="cls_004">e </span><span class="cls_007">?</span><span class="cls_004"> n →</span><span class="cls_007"> true</span></div>
<div style="position:absolute;left:162.33px;top:569.33px" class="cls_004"><span class="cls_004">→ {as} ∧ n ∈</span><span class="cls_007"> names</span><span class="cls_004">(as)</span></div>
<div style="position:absolute;left:89.03px;top:576.08px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">H</span><span class="cls_014">AS</span><span class="cls_004">A</span><span class="cls_014">TTR</span><span class="cls_004">- :</span></div>
<div style="position:absolute;left:180.25px;top:582.91px" class="cls_004"><span class="cls_004">e </span><span class="cls_007">?</span><span class="cls_004"> n →</span><span class="cls_007"> false</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">79</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:58650px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background088.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_009"><span class="cls_009">Primops</span><span class="cls_004">   Primitive operations, or primops, are functions that are built into the language.</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">They need not be defined or imported; they are in scope by default.  But since they are</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">normal identifiers, they can be overridden by local definitions.</span></div>
<div style="position:absolute;left:69.68px;top:81.46px" class="cls_004"><span class="cls_004">The most important primop, indeed the raison d’être for the Nix expression language,</span></div>
<div style="position:absolute;left:59.72px;top:93.42px" class="cls_004"><span class="cls_004">is the primop</span><span class="cls_007"> derivation</span><span class="cls_004">. It translates a set of attributes describing a build action to a store</span></div>
<div style="position:absolute;left:59.72px;top:105.37px" class="cls_004"><span class="cls_004">derivation, which can then be built. The translation process is performed by the function</span></div>
<div style="position:absolute;left:59.72px;top:117.33px" class="cls_007"><span class="cls_007">instantiate</span><span class="cls_004">, given in Section 5.4. What is relevant here is that</span><span class="cls_007"> instantiate</span><span class="cls_004">(as) takes a set of</span></div>
<div style="position:absolute;left:59.72px;top:129.28px" class="cls_004"><span class="cls_004">attributes as, translates them to a store derivation, and returns an identical set of attributes,</span></div>
<div style="position:absolute;left:59.72px;top:141.24px" class="cls_004"><span class="cls_004">but with three attributes added: the attribute</span><span class="cls_007"> type</span><span class="cls_004"> with string value</span><span class="cls_007"> "derivation"</span><span class="cls_004">, and the</span></div>
<div style="position:absolute;left:59.72px;top:153.19px" class="cls_004"><span class="cls_004">attributes</span><span class="cls_007"> drvPath</span><span class="cls_004"> and</span><span class="cls_007"> outPath</span><span class="cls_004"> containing the store paths of the store derivation and its</span></div>
<div style="position:absolute;left:59.72px;top:165.15px" class="cls_004"><span class="cls_004">output, respectively.</span></div>
<div style="position:absolute;left:69.68px;top:177.66px" class="cls_004"><span class="cls_004">So intuitively,</span><span class="cls_007"> derivation</span><span class="cls_004"> just calls</span><span class="cls_007"> instantiate</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:197.99px;top:201.94px" class="cls_004"><span class="cls_004">→ {as}</span></div>
<div style="position:absolute;left:84.87px;top:208.69px" class="cls_004"><span class="cls_004">D</span><span class="cls_014">ERIVATION </span><span class="cls_004">:</span></div>
<div style="position:absolute;left:146.55px;top:215.52px" class="cls_007"><span class="cls_007">derivation</span><span class="cls_004"> e → {</span><span class="cls_007">instantiate</span><span class="cls_004">(as)}</span></div>
<div style="position:absolute;left:69.68px;top:237.39px" class="cls_004"><span class="cls_004">However, as I argued at the beginning of this chapter (page 63), we want derivations to be</span></div>
<div style="position:absolute;left:59.72px;top:249.35px" class="cls_004"><span class="cls_004">very lazy: the expensive call to</span><span class="cls_007"> instantiate</span><span class="cls_004"> should only be made if we actually need</span><span class="cls_007"> drvPath</span></div>
<div style="position:absolute;left:59.72px;top:261.30px" class="cls_004"><span class="cls_004">and</span><span class="cls_007"> outPath</span><span class="cls_004">. For this reason,</span><span class="cls_007"> derivation</span><span class="cls_004"> postpones the computation of those attributes by</span></div>
<div style="position:absolute;left:59.72px;top:273.26px" class="cls_004"><span class="cls_004">using an indirection:</span></div>
<div style="position:absolute;left:205.67px;top:297.54px" class="cls_004"><span class="cls_004">→ {as}</span></div>
<div style="position:absolute;left:84.87px;top:304.29px" class="cls_004"><span class="cls_004">D</span><span class="cls_014">ERIVATION </span><span class="cls_004">:</span></div>
<div style="position:absolute;left:146.55px;top:310.83px" class="cls_007"><span class="cls_007">derivation</span><span class="cls_004"> e → {</span><span class="cls_007">rightUnion</span><span class="cls_004">(as, as</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">)}</span></div>
<div style="position:absolute;left:59.72px;top:332.44px" class="cls_004"><span class="cls_004">where</span></div>
<div style="position:absolute;left:84.62px;top:353.94px" class="cls_004"><span class="cls_004">as</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> = {</span><span class="cls_037">〈</span><span class="cls_007">type = "derivation"</span><span class="cls_037">〉</span><span class="cls_004">, </span><span class="cls_037">〈</span><span class="cls_007">drvPath =</span><span class="cls_004"> e</span><span class="cls_012"><sup>′</sup></span><span class="cls_007">.drvPath</span><span class="cls_037">〉</span><span class="cls_004">, </span><span class="cls_037">〈</span><span class="cls_007">outPath =</span><span class="cls_004"> e</span><span class="cls_012"><sup>′</sup></span><span class="cls_007">.outPath</span><span class="cls_037">〉</span><span class="cls_004">}</span></div>
<div style="position:absolute;left:89.06px;top:368.89px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> =</span><span class="cls_007"> derivation!</span><span class="cls_004"> {as}</span></div>
<div style="position:absolute;left:59.72px;top:393.44px" class="cls_004"><span class="cls_004">The internal (not user-accessible) primop</span><span class="cls_007"> derivation!</span><span class="cls_004"> performs the actual instantiation:</span></div>
<div style="position:absolute;left:84.87px;top:416.47px" class="cls_004"><span class="cls_004">D</span><span class="cls_014">ERIVATION</span><span class="cls_004">! :</span><span class="cls_007"> derivation!</span><span class="cls_004"> {as} → {</span><span class="cls_007">instantiate</span><span class="cls_004">(as)}</span></div>
<div style="position:absolute;left:59.72px;top:439.50px" class="cls_004"><span class="cls_004">Thus, when we evaluate attributes that result from a call to</span><span class="cls_007"> derivation</span><span class="cls_004">, there is essentially</span></div>
<div style="position:absolute;left:59.72px;top:451.45px" class="cls_004"><span class="cls_004">no runtime cost unless we evaluate the</span><span class="cls_007"> drvPath</span><span class="cls_004"> or</span><span class="cls_007"> outPath</span><span class="cls_004"> attributes.</span></div>
<div style="position:absolute;left:69.68px;top:463.96px" class="cls_004"><span class="cls_004">The next primop is</span><span class="cls_007"> import</span><span class="cls_004">. The unary operation</span><span class="cls_007"> import</span><span class="cls_004"> p reads the file p, parses it as a</span></div>
<div style="position:absolute;left:59.72px;top:475.92px" class="cls_004"><span class="cls_004">Nix expression, applies certain checks, and evaluates and returns the expression. The valid-</span></div>
<div style="position:absolute;left:59.72px;top:487.87px" class="cls_004"><span class="cls_004">ity checks are that the expression must be closed (i.e., not contain any unbound variables),</span></div>
<div style="position:absolute;left:59.72px;top:499.83px" class="cls_004"><span class="cls_004">that no attribute set definition defines two attributes with the same name, and similarly</span></div>
<div style="position:absolute;left:59.72px;top:511.78px" class="cls_004"><span class="cls_004">that no multi-argument function definition has two formal arguments with the same name.</span></div>
<div style="position:absolute;left:59.72px;top:523.74px" class="cls_004"><span class="cls_004">The requirement that imported expressions are closed is rather important: it implies that</span></div>
<div style="position:absolute;left:59.72px;top:535.70px" class="cls_004"><span class="cls_004">no imported expression can refer to the local scope of the caller. Also, any relative path</span></div>
<div style="position:absolute;left:59.72px;top:547.65px" class="cls_004"><span class="cls_004">constants occurring in the expression are absolutised.</span></div>
<div style="position:absolute;left:168.34px;top:571.93px" class="cls_004"><span class="cls_004">→p</span></div>
<div style="position:absolute;left:84.87px;top:578.68px" class="cls_004"><span class="cls_004">I</span><span class="cls_014">MPORT </span><span class="cls_004">:</span></div>
<div style="position:absolute;left:126.27px;top:585.51px" class="cls_007"><span class="cls_007">import</span><span class="cls_004"> e →</span><span class="cls_007"> loadExpr</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">80</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:59340px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background089.jpg" width=481 height=680></div>
<div style="position:absolute;left:339.16px;top:17.14px" class="cls_004"><span class="cls_004">4.4. Implementation</span></div>
<div style="position:absolute;left:73.84px;top:45.04px" class="cls_004"><span class="cls_004">If p denotes a directory, the path</span><span class="cls_007"> "/default.nix"</span><span class="cls_004"> is automatically appended.  This is an</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">organisational convenience for people who want to store each component’s Nix expression</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">and builder in a separate directory (as in, e.g., Figure 2.5).</span></div>
<div style="position:absolute;left:73.84px;top:80.90px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> loadExpr</span><span class="cls_004"> takes care of loading, parsing and processing the file. The astute</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">reader will note that</span><span class="cls_007"> loadExpr</span><span class="cls_004"> depends on the contents of the file system, that is, it depends</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">on some mapping of paths to file system contents.  This mapping is left implicit in the</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">evaluation rules.  It may also appear to make the evaluation calculus impure, implying</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">that equational reasoning (an important property of purely functional languages) no longer</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">holds. For instance, it might appear that</span><span class="cls_007"> import</span><span class="cls_004"> p</span><span class="cls_007"> == import</span><span class="cls_004"> p does not always evaluate to</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_007"><span class="cls_007">true</span><span class="cls_004">. However, as we will see below, due to maximal laziness this is not in fact the case.</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">The call</span><span class="cls_007"> import</span><span class="cls_004"> p is only evaluated once for a given p.</span></div>
<div style="position:absolute;left:73.84px;top:176.55px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> import</span><span class="cls_004"> primitive is overloaded to also work on derivations:</span></div>
<div style="position:absolute;left:272.90px;top:195.62px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:141.99px;top:198.66px" class="cls_004"><span class="cls_004">→ {as} ∧ </span><span class="cls_037">〈</span><span class="cls_007">"type" =</span><span class="cls_004"> e</span><span class="cls_012"><sub>t</sub></span><span class="cls_004"> </span><span class="cls_037">〉</span><span class="cls_004"> ∈ as ∧ e</span><span class="cls_012"><sub>t</sub></span></div>
<div style="position:absolute;left:269.76px;top:198.66px" class="cls_004"><span class="cls_004">→</span><span class="cls_007"> "derivation"</span></div>
<div style="position:absolute;left:281.21px;top:213.24px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:278.07px;top:216.29px" class="cls_004"><span class="cls_004">→p</span></div>
<div style="position:absolute;left:166.46px;top:216.29px" class="cls_004"><span class="cls_004">∧</span><span class="cls_037">〈</span><span class="cls_007">"drvPath" =</span><span class="cls_004"> e</span><span class="cls_012"><sub>p</sub></span><span class="cls_037">〉</span><span class="cls_004"> ∈ as ∧ e</span><span class="cls_012"><sub>p</sub></span></div>
<div style="position:absolute;left:89.03px;top:223.76px" class="cls_004"><span class="cls_004">I</span><span class="cls_014">MPORT</span><span class="cls_004">’ :</span></div>
<div style="position:absolute;left:169.71px;top:230.60px" class="cls_007"><span class="cls_007">import</span><span class="cls_004"> e →</span><span class="cls_007"> loadExpr</span><span class="cls_004">(</span><span class="cls_007">build</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:63.87px;top:249.75px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> build</span><span class="cls_004"> builds a store derivation.  It is defined in Section 5.5 and returns the</span></div>
<div style="position:absolute;left:63.87px;top:261.70px" class="cls_004"><span class="cls_004">output path of the derivation. Overloading</span><span class="cls_007"> import</span><span class="cls_004"> to work on derivations allows Nix ex-</span></div>
<div style="position:absolute;left:63.87px;top:273.66px" class="cls_004"><span class="cls_004">pressions to generate and use other Nix expressions. We will use this feature in Chapter 10</span></div>
<div style="position:absolute;left:63.87px;top:285.61px" class="cls_004"><span class="cls_004">to implement build management with Nix, as it allows the automatic generation of lists of</span></div>
<div style="position:absolute;left:63.87px;top:297.57px" class="cls_004"><span class="cls_004">inputs from other inputs (e.g., the list of header files imported by a C source file).</span></div>
<div style="position:absolute;left:73.84px;top:309.52px" class="cls_004"><span class="cls_004">Finally, the nullary primops</span><span class="cls_007"> true</span><span class="cls_004">,</span><span class="cls_007"> false</span><span class="cls_004">, and</span><span class="cls_007"> null</span><span class="cls_004"> are constant symbols: they represent</span></div>
<div style="position:absolute;left:63.87px;top:321.48px" class="cls_004"><span class="cls_004">themselves, and have no evaluation rules.  There is also an ever-growing set of utility</span></div>
<div style="position:absolute;left:63.87px;top:333.43px" class="cls_004"><span class="cls_004">functions (added in an admittedly ad hoc fashion) such as</span><span class="cls_007"> map</span><span class="cls_004">,</span><span class="cls_007"> baseNameOf</span><span class="cls_004">, and so on;</span></div>
<div style="position:absolute;left:63.87px;top:345.39px" class="cls_004"><span class="cls_004">but the semantics of those is not very relevant to a discussion of the foundations of the Nix</span></div>
<div style="position:absolute;left:63.87px;top:357.34px" class="cls_004"><span class="cls_004">expression language.</span></div>
<div style="position:absolute;left:63.87px;top:387.83px" class="cls_011"><span class="cls_011">4.4. Implementation</span></div>
<div style="position:absolute;left:63.87px;top:413.04px" class="cls_009"><span class="cls_009">Maximal laziness</span><span class="cls_004">   Nix expression evaluation is implemented using the ATerm library</span></div>
<div style="position:absolute;left:63.87px;top:425.00px" class="cls_004"><span class="cls_004">[166], which is a library for the efficient storage and runtime manipulation of terms. The</span></div>
<div style="position:absolute;left:63.87px;top:436.95px" class="cls_004"><span class="cls_004">Nix expression parser yields an ATerm encoding of the term. For example, the expression</span></div>
<div style="position:absolute;left:88.78px;top:460.30px" class="cls_015"><span class="cls_015">(x:  x)  123</span></div>
<div style="position:absolute;left:63.87px;top:474.12px" class="cls_004"><span class="cls_004">yields the ATerm</span></div>
<div style="position:absolute;left:88.78px;top:497.46px" class="cls_015"><span class="cls_015">Call(Function1("x",Var("x"),Pos("(string)",1,3)),Int(123))</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> Pos</span><span class="cls_004"> node indicates position information, which is stored for certain language con-</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">structs (notably functions and attributes) to provide better error messages.</span></div>
<div style="position:absolute;left:73.84px;top:535.20px" class="cls_004"><span class="cls_004">A very nice property of the ATerm library is its maximal sharing:  if two terms are</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">syntactically equal, then they occupy the same location in memory.  This means that a</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">shallow pointer equality test is sufficient to perform a deep syntactic equality test. Maximal</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">sharing is implemented through a hash table. Whenever a new term is created, the term is</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">looked up in the hash table. If the term already exists, the address of the term obtained from</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">81</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:60030px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background090.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:68.09px;top:46.83px" class="cls_007"><span class="cls_007">eval</span><span class="cls_004">(e) :</span></div>
<div style="position:absolute;left:83.03px;top:58.79px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> cache</span><span class="cls_004">[e] = ε :</span></div>
<div style="position:absolute;left:97.97px;top:70.74px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> cache</span><span class="cls_004">[e] =</span><span class="cls_007"> blackhole</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:112.92px;top:82.70px" class="cls_004"><span class="cls_004">Abort; infinite recursion detected.</span></div>
<div style="position:absolute;left:97.97px;top:94.75px" class="cls_004"><span class="cls_004">return</span><span class="cls_007"> cache</span><span class="cls_004">[e]</span></div>
<div style="position:absolute;left:83.03px;top:106.71px" class="cls_004"><span class="cls_004">else :</span></div>
<div style="position:absolute;left:97.97px;top:118.66px" class="cls_007"><span class="cls_007">cache</span><span class="cls_004">[e] ←</span><span class="cls_007"> blackhole</span></div>
<div style="position:absolute;left:97.97px;top:129.59px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ←</span><span class="cls_007"> eval</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(e)</span></div>
<div style="position:absolute;left:97.97px;top:141.55px" class="cls_007"><span class="cls_007">cache</span><span class="cls_004">[e] ← e</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:97.97px;top:153.50px" class="cls_004"><span class="cls_004">return e</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:176.32px;top:179.22px" class="cls_004"><span class="cls_004">Figure 4.7.: Evaluation caching</span></div>
<div style="position:absolute;left:59.72px;top:213.24px" class="cls_004"><span class="cls_004">the hash table is returned. Otherwise, the term is allocated, initialised, and added to the</span></div>
<div style="position:absolute;left:59.72px;top:225.20px" class="cls_004"><span class="cls_004">hash table. A garbage collector takes care of freeing terms that are no longer referenced.</span></div>
<div style="position:absolute;left:69.68px;top:238.14px" class="cls_004"><span class="cls_004">Maximal sharing is extremely useful in the implementation of a Nix expression inter-</span></div>
<div style="position:absolute;left:59.72px;top:250.10px" class="cls_004"><span class="cls_004">preter since it allows easy caching of evaluation results, which speeds up expression eval-</span></div>
<div style="position:absolute;left:59.72px;top:262.05px" class="cls_004"><span class="cls_004">uation by removing unnecessary evaluation of identical terms. The interpreter maintains a</span></div>
<div style="position:absolute;left:59.72px;top:274.01px" class="cls_004"><span class="cls_004">hash lookup table</span><span class="cls_007"> cache</span><span class="cls_004"> :</span><span class="cls_007"> ATerm</span><span class="cls_004"> →</span><span class="cls_007"> ATerm</span><span class="cls_004"> that maps ATerms representing Nix expressions</span></div>
<div style="position:absolute;left:59.72px;top:285.97px" class="cls_004"><span class="cls_004">to their normal form. Figure 4.7 shows pseudo-code for the caching evaluation function</span></div>
<div style="position:absolute;left:59.72px;top:297.92px" class="cls_007"><span class="cls_007">eval</span><span class="cls_004">, which “wraps” the evaluation rules defined in Section 4.3.4 in a caching layer. The</span></div>
<div style="position:absolute;left:59.72px;top:308.85px" class="cls_004"><span class="cls_004">function</span><span class="cls_007"> eval</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> simply implements those evaluation rules. It is assumed that</span><span class="cls_007"> eval</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> calls back</span></div>
<div style="position:absolute;left:346.64px;top:320.04px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:59.72px;top:323.08px" class="cls_004"><span class="cls_004">into</span><span class="cls_007"> eval</span><span class="cls_004"> to evaluate subterms (i.e., every time a rule uses the relation</span></div>
<div style="position:absolute;left:343.50px;top:323.08px" class="cls_004"><span class="cls_004">→ in a condition),</span></div>
<div style="position:absolute;left:59.72px;top:335.04px" class="cls_004"><span class="cls_004">and that it aborts with an appropriate error message if e does not evaluate to a good normal</span></div>
<div style="position:absolute;left:59.72px;top:346.99px" class="cls_004"><span class="cls_004">form. Thus we obtain the desired caching. The special value ε denotes that no mapping</span></div>
<div style="position:absolute;left:59.72px;top:357.92px" class="cls_004"><span class="cls_004">exists in the cache for the expression</span><span class="cls_012"><sup>7</sup></span><span class="cls_004">. Note that thanks to maximal sharing, the lookup</span></div>
<div style="position:absolute;left:59.72px;top:370.91px" class="cls_007"><span class="cls_007">cache</span><span class="cls_004">[e] is very cheap: it is a lookup of a pointer in a hash table.</span></div>
<div style="position:absolute;left:69.68px;top:383.85px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> eval</span><span class="cls_004"> also perform a trick known as blackholing [134, 110] that allows</span></div>
<div style="position:absolute;left:59.72px;top:395.81px" class="cls_004"><span class="cls_004">detection of certain simple kinds of infinite recursion. When we evaluate an expression e,</span></div>
<div style="position:absolute;left:59.72px;top:407.76px" class="cls_004"><span class="cls_004">we store in the cache a preliminary “fake” normal form</span><span class="cls_007"> blackhole</span><span class="cls_004">. If, during the evaluation</span></div>
<div style="position:absolute;left:59.72px;top:419.72px" class="cls_004"><span class="cls_004">of e, we need to evaluate e again, the cache will contain</span><span class="cls_007"> blackhole</span><span class="cls_004"> as the normal form for</span></div>
<div style="position:absolute;left:59.72px;top:431.67px" class="cls_004"><span class="cls_004">e. Due to the determinism and purity of the language, this necessarily indicates an infinite</span></div>
<div style="position:absolute;left:59.72px;top:443.63px" class="cls_004"><span class="cls_004">loop, since if we start evaluating e again, we will eventually encounter it another time, and</span></div>
<div style="position:absolute;left:59.72px;top:455.58px" class="cls_004"><span class="cls_004">so on.</span></div>
<div style="position:absolute;left:69.68px;top:468.53px" class="cls_004"><span class="cls_004">Note that blackholing as implemented here differs from conventional blackholing, which</span></div>
<div style="position:absolute;left:59.72px;top:480.48px" class="cls_004"><span class="cls_004">overwrites a value being evaluated with a black hole.  This allows discovery of self-</span></div>
<div style="position:absolute;left:59.72px;top:492.44px" class="cls_004"><span class="cls_004">referential values, e.g.,</span><span class="cls_007"> x = ... x ...;</span><span class="cls_004">. But it does not detect infinite recursions like this:</span></div>
<div style="position:absolute;left:84.62px;top:519.60px" class="cls_015"><span class="cls_015">(rec  {f  =  x:  f  x;}).f  10</span></div>
<div style="position:absolute;left:59.72px;top:537.24px" class="cls_004"><span class="cls_004">since every recursive call to</span><span class="cls_007"> f</span><span class="cls_004"> creates a new value of</span><span class="cls_007"> x</span><span class="cls_004">, and so blackholing will not catch</span></div>
<div style="position:absolute;left:59.72px;top:549.19px" class="cls_004"><span class="cls_004">the infinite recursion.  In contrast, our blackholing does detect it, since it is keyed on</span></div>
<div style="position:absolute;left:59.72px;top:561.15px" class="cls_004"><span class="cls_004">maximally shared ATerms that represent syntactically equal expressions.  The example</span></div>
<div style="position:absolute;left:64.20px;top:584.11px" class="cls_013"><span class="cls_013"><sup>7</sup></span><span class="cls_014">In the ATerm library, this means that the table lookup returned a null pointer.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">82</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:60720px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background091.jpg" width=481 height=680></div>
<div style="position:absolute;left:339.16px;top:17.14px" class="cls_004"><span class="cls_004">4.4. Implementation</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">above is evaluated as follows:</span></div>
<div style="position:absolute;left:176.96px;top:62.55px" class="cls_007"><span class="cls_007">(rec {f = x: f x;}).f 10</span></div>
<div style="position:absolute;left:122.13px;top:73.51px" class="cls_004"><span class="cls_004">(R</span><span class="cls_014">EC</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:157.03px;top:73.51px" class="cls_004"><span class="cls_004">→</span><span class="cls_007">  {f = x: (rec {f = x: f x;}).f x;}.f 10</span></div>
<div style="position:absolute;left:107.15px;top:85.47px" class="cls_004"><span class="cls_004">(S</span><span class="cls_014">ELECT</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:157.03px;top:85.47px" class="cls_004"><span class="cls_004">→</span><span class="cls_007">  (x: (rec {f = x: f x;}).f x) 10</span></div>
<div style="position:absolute;left:93.76px;top:97.42px" class="cls_004"><span class="cls_004">(β -R</span><span class="cls_014">EDUCE</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:157.03px;top:97.42px" class="cls_004"><span class="cls_004">→</span><span class="cls_007">  (rec {f = x: f x;}).f 10</span></div>
<div style="position:absolute;left:63.87px;top:115.81px" class="cls_004"><span class="cls_004">This final expression is equal to the first (which is blackholed at this time), and so an</span></div>
<div style="position:absolute;left:63.87px;top:127.77px" class="cls_004"><span class="cls_004">infinite recursion is signalled.</span></div>
<div style="position:absolute;left:73.84px;top:139.72px" class="cls_004"><span class="cls_004">The current evaluation cache never forgets the evaluation result of any term. This obvi-</span></div>
<div style="position:absolute;left:63.87px;top:151.68px" class="cls_004"><span class="cls_004">ously does not scale very well, so one might want to clear or prune the cache eventually,</span></div>
<div style="position:absolute;left:63.87px;top:163.63px" class="cls_004"><span class="cls_004">possibly using a least-recently used (LRU) eviction scheme. However, the size of current</span></div>
<div style="position:absolute;left:63.87px;top:175.59px" class="cls_004"><span class="cls_004">Nix expressions (such as those produced during the evaluation of Nixpkgs) has not com-</span></div>
<div style="position:absolute;left:63.87px;top:187.54px" class="cls_004"><span class="cls_004">pelled me to implement cache pruning yet. It should also be noted that due to maximal</span></div>
<div style="position:absolute;left:63.87px;top:199.50px" class="cls_004"><span class="cls_004">sharing, cached values are stored quite efficiently.</span></div>
<div style="position:absolute;left:73.84px;top:211.45px" class="cls_004"><span class="cls_004">The expression caching scheme described here makes the Nix expression evaluator max-</span></div>
<div style="position:absolute;left:63.87px;top:223.41px" class="cls_004"><span class="cls_004">imally lazy. Languages such as Haskell are non-strict, meaning that values such as func-</span></div>
<div style="position:absolute;left:63.87px;top:235.36px" class="cls_004"><span class="cls_004">tion arguments or let-bindings are evaluated only when necessary. A stronger property is</span></div>
<div style="position:absolute;left:63.87px;top:247.32px" class="cls_004"><span class="cls_004">laziness, which means that these values are evaluated at most once. (Even though the se-</span></div>
<div style="position:absolute;left:63.87px;top:259.27px" class="cls_004"><span class="cls_004">mantics of Haskell only requires non-strictness, in practice all implementations are lazy.)</span></div>
<div style="position:absolute;left:63.87px;top:271.23px" class="cls_004"><span class="cls_004">Finally, maximal laziness means that syntactically identical terms are evaluated at most</span></div>
<div style="position:absolute;left:63.87px;top:283.18px" class="cls_004"><span class="cls_004">once. This is not the case with mere laziness: a compiler is not obliged (or generally capa-</span></div>
<div style="position:absolute;left:63.87px;top:295.14px" class="cls_004"><span class="cls_004">ble) to arrange for the evaluation result of two terms occurring in different locations in the</span></div>
<div style="position:absolute;left:63.87px;top:307.09px" class="cls_004"><span class="cls_004">program, or in different invocations of a function, to be shared. For instance, there is no</span></div>
<div style="position:absolute;left:63.87px;top:319.05px" class="cls_004"><span class="cls_004">guarantee that a lazy Haskell implementation will evaluate the expression</span><span class="cls_007"> product [1..1000]</span></div>
<div style="position:absolute;left:63.87px;top:331.00px" class="cls_004"><span class="cls_004">only once when evaluating variable</span><span class="cls_007"> z</span><span class="cls_004"> in the following program:</span></div>
<div style="position:absolute;left:88.78px;top:352.86px" class="cls_015"><span class="cls_015">x = product [1..1000]</span></div>
<div style="position:absolute;left:88.78px;top:363.82px" class="cls_015"><span class="cls_015">y = product [1..1000]</span></div>
<div style="position:absolute;left:88.78px;top:374.78px" class="cls_015"><span class="cls_015">z = x + y</span></div>
<div style="position:absolute;left:73.84px;top:387.12px" class="cls_004"><span class="cls_004">Maximal laziness simplifies the implementation of the Nix expression evaluator.  For</span></div>
<div style="position:absolute;left:63.87px;top:399.07px" class="cls_004"><span class="cls_004">instance, it is not necessary to implement sharing of β -redexes.  Without sharing, it is</span></div>
<div style="position:absolute;left:63.87px;top:411.03px" class="cls_004"><span class="cls_004">typically necessary to implement the rule β -R</span><span class="cls_014">EDUCE</span><span class="cls_004"> as follows:</span></div>
<div style="position:absolute;left:181.94px;top:428.33px" class="cls_012"><span class="cls_012">∗</span></div>
<div style="position:absolute;left:167.98px;top:431.38px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span></div>
<div style="position:absolute;left:178.81px;top:431.38px" class="cls_004"><span class="cls_004">→ x</span><span class="cls_007">:</span><span class="cls_004"> e</span><span class="cls_012"><sub>3</sub></span></div>
<div style="position:absolute;left:88.78px;top:438.12px" class="cls_004"><span class="cls_004">β-R</span><span class="cls_014">EDUCE</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:143.85px;top:444.96px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> →</span><span class="cls_007"> let</span><span class="cls_004"> x</span><span class="cls_007"> =</span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_007"> in</span><span class="cls_004"> e</span><span class="cls_012"><sub>3</sub></span></div>
<div style="position:absolute;left:63.87px;top:461.38px" class="cls_004"><span class="cls_004">where we give</span><span class="cls_007"> let</span><span class="cls_004"> a special “destructive update” semantics so that the evaluation result of</span></div>
<div style="position:absolute;left:63.87px;top:473.33px" class="cls_004"><span class="cls_004">x is written back into the right-hand side of the let-binding [51].  This is typically how</span></div>
<div style="position:absolute;left:63.87px;top:485.29px" class="cls_004"><span class="cls_004">laziness is implemented in functional languages: x is a pointer that points to a piece of</span></div>
<div style="position:absolute;left:63.87px;top:497.24px" class="cls_004"><span class="cls_004">memory containing code and environment pointers (the closure or thunk [134]), which</span></div>
<div style="position:absolute;left:63.87px;top:509.20px" class="cls_004"><span class="cls_004">after evaluation is overwritten with the actual result.</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_009"><span class="cls_009">Error messages</span><span class="cls_004">   If Nix expression evaluation fails, or we import a syntactically or oth-</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">erwise invalid Nix expression, a backtrace is printed of the evaluation stack to give the user</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">some clue as to the cause of the problem. For instance, if we try to install Subversion from</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">a Nix expression that calls the one in Figure 2.9 with</span><span class="cls_007"> compressionSupport</span><span class="cls_004"> set to</span><span class="cls_007"> true</span><span class="cls_004">, but</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">with</span><span class="cls_007"> zlib</span><span class="cls_004"> set to</span><span class="cls_007"> null</span><span class="cls_004">, we get the following error message:</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">83</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:61410px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background092.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:84.62px;top:50.30px" class="cls_015"><span class="cls_015">$ nix-env  -f  ./system/populate-cache.nix  -i  subversion</span></div>
<div style="position:absolute;left:84.62px;top:61.25px" class="cls_015"><span class="cls_015">error:  while  evaluating  the  attribute  `subversion'</span></div>
<div style="position:absolute;left:94.04px;top:72.21px" class="cls_015"><span class="cls_015">at  `./system/all-packages-generic.nix',  line  1062:</span></div>
<div style="position:absolute;left:84.62px;top:83.17px" class="cls_015"><span class="cls_015">while  evaluating  the  function</span></div>
<div style="position:absolute;left:94.04px;top:94.13px" class="cls_015"><span class="cls_015">at  `(...)/subversion-1.2.x/default.nix',  line  1:</span></div>
<div style="position:absolute;left:84.62px;top:105.09px" class="cls_015"><span class="cls_015">assertion  failed</span></div>
<div style="position:absolute;left:94.04px;top:116.05px" class="cls_015"><span class="cls_015">at  `(...)/subversion-1.2.x/default.nix',  line  19</span></div>
<div style="position:absolute;left:59.72px;top:131.66px" class="cls_004"><span class="cls_004">This tells the user not only what assertion triggered the error, but also where the incor-</span></div>
<div style="position:absolute;left:59.72px;top:143.61px" class="cls_004"><span class="cls_004">rect call to the Subversion function was made (namely, in</span><span class="cls_007"> all-packages-generic.nix</span><span class="cls_004"> at line</span></div>
<div style="position:absolute;left:59.72px;top:155.57px" class="cls_004"><span class="cls_004">1062).</span></div>
<div style="position:absolute;left:69.68px;top:167.83px" class="cls_004"><span class="cls_004">Backtraces in lazy languages are tricky, as a failing value may be finally evaluated in</span></div>
<div style="position:absolute;left:59.72px;top:179.79px" class="cls_004"><span class="cls_004">a piece of code far removed from where the value was “produced” [55].  Consider for</span></div>
<div style="position:absolute;left:59.72px;top:191.74px" class="cls_004"><span class="cls_004">example:</span></div>
<div style="position:absolute;left:84.62px;top:216.87px" class="cls_015"><span class="cls_015">let  {</span></div>
<div style="position:absolute;left:94.04px;top:227.83px" class="cls_015"><span class="cls_015">f = b: {x = assert b; 123;};</span></div>
<div style="position:absolute;left:94.04px;top:238.79px" class="cls_015"><span class="cls_015">body  =  (f  false).x;</span></div>
<div style="position:absolute;left:84.62px;top:249.74px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:59.72px;top:265.35px" class="cls_004"><span class="cls_004">Its evaluation will yield the following backtrace:</span></div>
<div style="position:absolute;left:84.62px;top:290.47px" class="cls_015"><span class="cls_015">error:  while  evaluating  the  file  `foo.nix':</span></div>
<div style="position:absolute;left:84.62px;top:301.43px" class="cls_015"><span class="cls_015">while  evaluating  the  attribute  `body'  at  `foo.nix',  line  3:</span></div>
<div style="position:absolute;left:84.62px;top:312.39px" class="cls_015"><span class="cls_015">while  evaluating  the  attribute  `x'  at  `foo.nix',  line  2:</span></div>
<div style="position:absolute;left:84.62px;top:323.35px" class="cls_015"><span class="cls_015">assertion  failed  at  `foo.nix',  line  2</span></div>
<div style="position:absolute;left:59.72px;top:338.96px" class="cls_004"><span class="cls_004">Note the absense of a reference to the function</span><span class="cls_007"> f</span><span class="cls_004">. In a strict language,</span><span class="cls_007"> f</span><span class="cls_004"> would appear in the</span></div>
<div style="position:absolute;left:59.72px;top:350.91px" class="cls_004"><span class="cls_004">backtrace. But also note that since attributes are annotated with position information, we</span></div>
<div style="position:absolute;left:59.72px;top:362.87px" class="cls_004"><span class="cls_004">still get the position of the definition of the attribute</span><span class="cls_007"> x</span><span class="cls_004"> in the body of</span><span class="cls_007"> f</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:375.14px" class="cls_004"><span class="cls_004">Another problem with backtraces in lazy languages is that tail-call optimisation [151]</span></div>
<div style="position:absolute;left:59.72px;top:387.09px" class="cls_004"><span class="cls_004">may remove useful stack frames. However, the current Nix expression evaluator does not</span></div>
<div style="position:absolute;left:59.72px;top:399.05px" class="cls_004"><span class="cls_004">optimise tail-calls.</span></div>
<div style="position:absolute;left:69.68px;top:411.31px" class="cls_004"><span class="cls_004">In practice, however, the stack traces printed by Nix are very helpful in everyday use,</span></div>
<div style="position:absolute;left:59.72px;top:423.27px" class="cls_004"><span class="cls_004">as the example above shows. The trace may not show every pertinent code location, and</span></div>
<div style="position:absolute;left:59.72px;top:435.23px" class="cls_004"><span class="cls_004">it may not show them in a meaningful order, but the locations that it does give usually</span></div>
<div style="position:absolute;left:59.72px;top:447.18px" class="cls_004"><span class="cls_004">give enough of a clue to figure out the cause of the problem.  A useful improvement is</span></div>
<div style="position:absolute;left:59.72px;top:459.14px" class="cls_004"><span class="cls_004">a kind of slicing for assertion failures (which are the most common type of errors, apart</span></div>
<div style="position:absolute;left:59.72px;top:471.09px" class="cls_004"><span class="cls_004">from missing attributes or function arguments). Currently, the interpreter simply prints that</span></div>
<div style="position:absolute;left:59.72px;top:483.05px" class="cls_004"><span class="cls_004">an assertion has failed, i.e., its condition expression evaluated to</span><span class="cls_007"> false</span><span class="cls_004">. So it is useful to</span></div>
<div style="position:absolute;left:59.72px;top:495.00px" class="cls_004"><span class="cls_004">print an explanation as to why it is</span><span class="cls_007"> false</span><span class="cls_004">. For example, if a guard expression</span><span class="cls_007"> p && x != null</span></div>
<div style="position:absolute;left:59.72px;top:506.96px" class="cls_004"><span class="cls_004">evaluates to</span><span class="cls_007"> false</span><span class="cls_004">, Nix should print whether</span><span class="cls_007"> p</span><span class="cls_004"> is</span><span class="cls_007"> false</span><span class="cls_004">, or</span><span class="cls_007"> x != null</span><span class="cls_004"> is</span><span class="cls_007"> false</span><span class="cls_004">. If</span><span class="cls_007"> p</span><span class="cls_004"> is</span><span class="cls_007"> false</span><span class="cls_004">, it</span></div>
<div style="position:absolute;left:59.72px;top:518.91px" class="cls_004"><span class="cls_004">should give an explanation as to how</span><span class="cls_007"> p</span><span class="cls_004"> obtained that value. In an interpreter (as opposed</span></div>
<div style="position:absolute;left:59.72px;top:530.87px" class="cls_004"><span class="cls_004">to a compiled implementation), this is not hard to implement since the original expression</span></div>
<div style="position:absolute;left:59.72px;top:542.82px" class="cls_004"><span class="cls_004">is still known, not just its normal form.</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_009"><span class="cls_009">Optimising substitution</span><span class="cls_004">   There is an important opportunity for optimisation in the im-</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">plementation of β -reduction: if we substitute a term, e.g., replacing free occurrences of</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">84</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:62100px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background093.jpg" width=481 height=680></div>
<div style="position:absolute;left:339.16px;top:17.14px" class="cls_004"><span class="cls_004">4.4. Implementation</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">x in e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> by e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> in the β -reduction of (x : e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">) e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">, we never need to substitute under the re-</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">placements of x. Consider the expression (x : y : e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">) e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> e</span><span class="cls_012"><sub>3</sub></span><span class="cls_004">, where e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> is a large expression.</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">With normal substitution, we first replace all occurrences of x in e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> with e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">.  Then, we</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">replace all occurrences of y in the resulting term with e</span><span class="cls_012"><sub>3</sub></span><span class="cls_004">. This substitution also descends</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">into the e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> replacements of x, even though those subterms are closed. Since e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> is large, this</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">is inefficient.</span></div>
<div style="position:absolute;left:73.84px;top:116.77px" class="cls_004"><span class="cls_004">The optimisation is that we can mark replacement terms to indicate to the substitution</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">function that it need not descend into such subterms. This is possible because of the fol-</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">lowing theorems.</span></div>
<div style="position:absolute;left:63.87px;top:158.29px" class="cls_004"><span class="cls_004">Lemma 1. Every term to which a semantic rule is applied during evaluation is closed.</span></div>
<div style="position:absolute;left:63.87px;top:175.90px" class="cls_004"><span class="cls_004">Proof. The property follows by induction on the application of semantic rules. The base</span></div>
<div style="position:absolute;left:63.87px;top:187.85px" class="cls_004"><span class="cls_004">case is the initial terms produced by the parser. Here the induction hypothesis hold trivially</span></div>
<div style="position:absolute;left:63.87px;top:199.81px" class="cls_004"><span class="cls_004">since the parser checks that these terms are closed and aborts with an error otherwise.</span></div>
<div style="position:absolute;left:73.84px;top:211.76px" class="cls_004"><span class="cls_004">For the inductive step, we must show two things.</span></div>
<div style="position:absolute;left:73.84px;top:223.72px" class="cls_004"><span class="cls_004">First, we must show that each rule that takes a closed term produces a closed term. This</span></div>
<div style="position:absolute;left:63.87px;top:235.67px" class="cls_004"><span class="cls_004">can be easily verified. For instance, β -R</span><span class="cls_014">EDUCE</span><span class="cls_004"> yields the body of the function, e</span><span class="cls_012"><sub>3</sub></span><span class="cls_004">, with</span></div>
<div style="position:absolute;left:63.87px;top:247.63px" class="cls_004"><span class="cls_004">its sole free variable x substituted by the argument. e</span><span class="cls_012"><sub>3</sub></span><span class="cls_004"> cannot have additional free variables</span></div>
<div style="position:absolute;left:63.87px;top:259.58px" class="cls_004"><span class="cls_004">because the function call e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> is closed, and function calls do not bind variables. Likewise,</span></div>
<div style="position:absolute;left:63.87px;top:271.54px" class="cls_004"><span class="cls_004">the expression yielded by S</span><span class="cls_014">ELECT</span><span class="cls_004"> must be closed because the attribute set in which it was</span></div>
<div style="position:absolute;left:63.87px;top:283.49px" class="cls_004"><span class="cls_004">contained is closed, and attribute sets do not bind variables.</span></div>
<div style="position:absolute;left:73.84px;top:295.45px" class="cls_004"><span class="cls_004">Second, we must show that subterms evaluated in the conditions of rules are closed. This</span></div>
<div style="position:absolute;left:63.87px;top:307.40px" class="cls_004"><span class="cls_004">can also be easily verified. For instance, β -R</span><span class="cls_014">EDUCE</span><span class="cls_004"> recursively evaluates the expression</span></div>
<div style="position:absolute;left:63.87px;top:319.36px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> in a function call e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">. Since by the induction hypothesis e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> is closed, it follows that</span></div>
<div style="position:absolute;left:63.87px;top:331.31px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> is also closed, as function calls do not bind variables.</span></div>
<div style="position:absolute;left:63.87px;top:350.66px" class="cls_004"><span class="cls_004">Theorem 2. All substitution terms occurring during evaluation are closed.</span></div>
<div style="position:absolute;left:63.87px;top:368.27px" class="cls_004"><span class="cls_004">Proof. This property follows by inspecting all calls to</span><span class="cls_007"> subst</span><span class="cls_004"> in the evaluation rules and</span></div>
<div style="position:absolute;left:63.87px;top:380.22px" class="cls_004"><span class="cls_004">observing that the substitution terms (i.e., the expressions in subs) are always closed. For</span></div>
<div style="position:absolute;left:63.87px;top:392.18px" class="cls_004"><span class="cls_004">instance, in the rule β -R</span><span class="cls_014">EDUCE</span><span class="cls_004">, subs = {x ⇝ e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">}.  The term e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">  is closed because by</span></div>
<div style="position:absolute;left:63.87px;top:404.13px" class="cls_004"><span class="cls_004">Lemma 1 the call e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> is closed, and function calls bind no variables. A similar argument</span></div>
<div style="position:absolute;left:63.87px;top:416.09px" class="cls_004"><span class="cls_004">holds for the</span><span class="cls_007"> subst</span><span class="cls_004"> calls in R</span><span class="cls_014">EC</span><span class="cls_004">, β -R</span><span class="cls_014">EDUCE</span><span class="cls_004">’ and W</span><span class="cls_014">ITH</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:435.43px" class="cls_004"><span class="cls_004">Since substitution terms are always closed, we can adapt the variable case of the substi-</span></div>
<div style="position:absolute;left:63.87px;top:447.39px" class="cls_004"><span class="cls_004">tution function</span><span class="cls_007"> subst</span><span class="cls_004"> in Figure 4.6 as follows:</span></div>
<div style="position:absolute;left:156.14px;top:458.21px" class="cls_004"><span class="cls_004"></span></div>
<div style="position:absolute;left:156.14px;top:467.17px" class="cls_004"><span class="cls_004"></span><span class="cls_007">closed</span><span class="cls_004">(e)  if (x ⇝</span><span class="cls_007"> closed</span><span class="cls_004">(e)) ∈ subs</span></div>
<div style="position:absolute;left:88.78px;top:481.62px" class="cls_007"><span class="cls_007">subst</span><span class="cls_004">(subs, x) =</span></div>
<div style="position:absolute;left:164.99px;top:482.00px" class="cls_007"><span class="cls_007">closed</span><span class="cls_004">(e)  if (x ⇝ e) ∈ subs</span></div>
<div style="position:absolute;left:156.14px;top:488.09px" class="cls_004"><span class="cls_004"></span></div>
<div style="position:absolute;left:164.99px;top:496.34px" class="cls_004"><span class="cls_004">x</span></div>
<div style="position:absolute;left:213.02px;top:496.34px" class="cls_004"><span class="cls_004">otherwise</span></div>
<div style="position:absolute;left:63.87px;top:516.18px" class="cls_004"><span class="cls_004">That is, replacement terms e are placed inside a wrapper</span><span class="cls_007"> closed</span><span class="cls_004">(e). (The first case merely</span></div>
<div style="position:absolute;left:63.87px;top:528.14px" class="cls_004"><span class="cls_004">prevents redundant wrapping, e.g.,</span><span class="cls_007"> closed</span><span class="cls_004">(</span><span class="cls_007">closed</span><span class="cls_004">(e)), which reduces the effectiveness of</span></div>
<div style="position:absolute;left:63.87px;top:540.09px" class="cls_004"><span class="cls_004">caching and blackholing.)  The wrapper denotes that e is a closed subterm under which</span></div>
<div style="position:absolute;left:63.87px;top:552.05px" class="cls_004"><span class="cls_004">no substitution is necessary, since it has no free variables. To actually make use of this</span></div>
<div style="position:absolute;left:63.87px;top:564.00px" class="cls_004"><span class="cls_004">optimisation, we also add a case to</span><span class="cls_007"> subst</span><span class="cls_004"> to stop at</span><span class="cls_007"> closed</span><span class="cls_004"> terms:</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_007"><span class="cls_007">subst</span><span class="cls_004">(subs,</span><span class="cls_007"> closed</span><span class="cls_004">(e)) =</span><span class="cls_007"> closed</span><span class="cls_004">(e)</span></div>
<div style="position:absolute;left:412.21px;top:624.86px" class="cls_004"><span class="cls_004">85</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:62790px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background094.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">4. The Nix Expression Language</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">Of course, during evaluation we must get rid of</span><span class="cls_007"> closed</span><span class="cls_004"> eventually. That’s easy:</span></div>
<div style="position:absolute;left:84.87px;top:66.96px" class="cls_004"><span class="cls_004">C</span><span class="cls_014">LOSED </span><span class="cls_004">:</span><span class="cls_007"> closed</span><span class="cls_004">(e) → e</span></div>
<div style="position:absolute;left:59.72px;top:88.88px" class="cls_004"><span class="cls_004">as a closed term is semantically equivalent to the term that it wraps.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">86</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:63480px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background095.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:88.98px" class="cls_006"><span class="cls_006">5. The Extensional Model</span></div>
<div style="position:absolute;left:63.87px;top:130.61px" class="cls_004"><span class="cls_004">In Chapter 2, we have seen that Nix offers many advantages over existing deployment</span></div>
<div style="position:absolute;left:63.87px;top:142.57px" class="cls_004"><span class="cls_004">systems, such as reliable dependency information, side-by-side deployment of versions</span></div>
<div style="position:absolute;left:63.87px;top:154.52px" class="cls_004"><span class="cls_004">and variants, atomic upgrades and rollbacks, and so on. And as explained in Chapter 3,</span></div>
<div style="position:absolute;left:63.87px;top:166.48px" class="cls_004"><span class="cls_004">it obtains these properties by imposing a “pointer discipline” on file systems, thus treat-</span></div>
<div style="position:absolute;left:63.87px;top:178.43px" class="cls_004"><span class="cls_004">ing the component deployment problem similar to memory management in programming</span></div>
<div style="position:absolute;left:63.87px;top:190.39px" class="cls_004"><span class="cls_004">languages.</span></div>
<div style="position:absolute;left:73.84px;top:202.52px" class="cls_004"><span class="cls_004">The current and subsequent chapter formalise the operation of the Nix system.  This</span></div>
<div style="position:absolute;left:63.87px;top:214.47px" class="cls_004"><span class="cls_004">includes the translation of Nix expressions into store derivations, building store derivations,</span></div>
<div style="position:absolute;left:63.87px;top:226.43px" class="cls_004"><span class="cls_004">the substitute mechanism, garbage collection, the invariants of the Nix store that must hold</span></div>
<div style="position:absolute;left:63.87px;top:238.38px" class="cls_004"><span class="cls_004">to ensure correct deployment, and so on.</span></div>
<div style="position:absolute;left:73.84px;top:250.52px" class="cls_004"><span class="cls_004">There are actually two different variants or models of Nix. The original model is the</span></div>
<div style="position:absolute;left:63.87px;top:262.47px" class="cls_004"><span class="cls_004">extensional model, described in this chapter. It is the model with which we have had the</span></div>
<div style="position:absolute;left:63.87px;top:274.43px" class="cls_004"><span class="cls_004">most experience. It implements all of the deployment properties described in Chapter 2.</span></div>
<div style="position:absolute;left:63.87px;top:286.38px" class="cls_004"><span class="cls_004">The next chapter describes the intensional model which is more powerful in that it allows</span></div>
<div style="position:absolute;left:63.87px;top:298.34px" class="cls_004"><span class="cls_004">the sharing of a Nix store between mutually untrusted users; however, it also places slightly</span></div>
<div style="position:absolute;left:63.87px;top:310.29px" class="cls_004"><span class="cls_004">stricter requirements on components. Most of the aspects of the extensional model carry</span></div>
<div style="position:absolute;left:63.87px;top:322.25px" class="cls_004"><span class="cls_004">over without modification to the intensional model.</span></div>
<div style="position:absolute;left:73.84px;top:334.38px" class="cls_004"><span class="cls_004">This chapter discusses all aspects of the semantics of the extensional model: the basics of</span></div>
<div style="position:absolute;left:63.87px;top:346.33px" class="cls_004"><span class="cls_004">cryptographic hashing (Section 5.1), the notion of File System Objects and the organisation</span></div>
<div style="position:absolute;left:63.87px;top:358.29px" class="cls_004"><span class="cls_004">of the Nix store (Section 5.2), the operation of adding sources and other “atomic” values</span></div>
<div style="position:absolute;left:63.87px;top:370.24px" class="cls_004"><span class="cls_004">to the store (Section 5.3), translating Nix expressions to store derivations (Section 5.4),</span></div>
<div style="position:absolute;left:63.87px;top:382.20px" class="cls_004"><span class="cls_004">building store derivations (Section 5.5), and garbage collection (Section 5.6). It concludes</span></div>
<div style="position:absolute;left:63.87px;top:394.15px" class="cls_004"><span class="cls_004">with an explanation of the notion of extensionality (Section 5.7), which sets up the next</span></div>
<div style="position:absolute;left:63.87px;top:406.11px" class="cls_004"><span class="cls_004">chapter on the intensional model.</span></div>
<div style="position:absolute;left:63.87px;top:437.75px" class="cls_011"><span class="cls_011">5.1. Cryptographic hashes</span></div>
<div style="position:absolute;left:63.87px;top:463.30px" class="cls_004"><span class="cls_004">Since Nix heavily uses cryptographic hash functions in store paths and in other places,</span></div>
<div style="position:absolute;left:63.87px;top:475.25px" class="cls_004"><span class="cls_004">this section introduces some properties and notations that will be used in the remainder of</span></div>
<div style="position:absolute;left:63.87px;top:487.21px" class="cls_004"><span class="cls_004">Part II.</span></div>
<div style="position:absolute;left:73.84px;top:499.34px" class="cls_004"><span class="cls_004">A hash function [36] is a function h : A → B that maps values from a possibly infinite</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">domain A onto a finite range B. For instance, h(x ∈ N) = x mod 27 is a hash function that</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">maps natural numbers to the numbers [0..26].  Given value x ∈ A and y = h(x) ∈ B, the</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">value x is called the preimage and y is called the hash of x. Since A is typically larger than</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">B, there must necessarily exist values x</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">, x</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> ∈ A such that h(x) = h(y). These are collisions</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">of the hash function h. A good hash function will have the property that collisions can be</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">expected to occur with low probability given the sets of values that will be fed into the hash</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">function in typical usage patterns.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">87</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:64170px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background096.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:69.68px;top:45.04px" class="cls_004"><span class="cls_004">A cryptographic hash function [145] is a hash function that maps arbitrary-length byte</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">sequences onto fixed-length byte sequences, with a number of special properties:</span></div>
<div style="position:absolute;left:74.66px;top:74.26px" class="cls_004"><span class="cls_004">• Preimage resistance: given a value y ∈ B, it should be computationally infeasible to</span></div>
<div style="position:absolute;left:84.62px;top:86.22px" class="cls_004"><span class="cls_004">find an x ∈ A such that y = h(x). Computational infeasibility means that ideally the</span></div>
<div style="position:absolute;left:84.62px;top:98.17px" class="cls_004"><span class="cls_004">most efficient way to find x is a brute-force attack, that is, trying all possible values</span></div>
<div style="position:absolute;left:84.62px;top:110.13px" class="cls_004"><span class="cls_004">in A. This means computing |A|/2 hashes on average.</span></div>
<div style="position:absolute;left:74.66px;top:128.73px" class="cls_004"><span class="cls_004">• Collision resistance: it should be infeasible to find any x</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">, x</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> ∈ A such that h(x</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">) =</span></div>
<div style="position:absolute;left:84.62px;top:140.68px" class="cls_004"><span class="cls_004">h(x</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">). Due to the birthday paradox [145], a brute√</span><span class="cls_059">rce</span><span class="cls_004"> attack will find a collision</span></div>
<div style="position:absolute;left:84.62px;top:151.30px" class="cls_004"><span class="cls_004">with probability</span><span class="cls_012"><sup>1</sup></span></div>
<div style="position:absolute;left:295.47px;top:152.64px" class="cls_004"><span class="cls_004">|B| hashes.</span></div>
<div style="position:absolute;left:152.24px;top:152.64px" class="cls_012"><span class="cls_012">2</span><span class="cls_004"> aftercomputingapproximately</span></div>
<div style="position:absolute;left:74.66px;top:171.23px" class="cls_004"><span class="cls_004">• Second preimage resistance: given an x</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> ∈ A, it should be infeasible to find another</span></div>
<div style="position:absolute;left:84.62px;top:183.19px" class="cls_004"><span class="cls_004">x</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> ∈ A such that h(x</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">) = h(x</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">). The difference with collision resistance is that here</span></div>
<div style="position:absolute;left:84.62px;top:195.14px" class="cls_004"><span class="cls_004">x</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> is given.</span></div>
<div style="position:absolute;left:69.68px;top:212.41px" class="cls_004"><span class="cls_004">For our purposes collision resistance and second preimage resistance are what matters—</span></div>
<div style="position:absolute;left:59.72px;top:224.37px" class="cls_004"><span class="cls_004">it should not be feasible to find collisions. This is since we do not ever want two different</span></div>
<div style="position:absolute;left:59.72px;top:236.32px" class="cls_004"><span class="cls_004">components in the Nix store to be stored in the same store path. Preimage resistance—</span></div>
<div style="position:absolute;left:59.72px;top:248.28px" class="cls_004"><span class="cls_004">infeasibility of inverting the hash—is not important. We do not care if it is possible to find</span></div>
<div style="position:absolute;left:59.72px;top:260.23px" class="cls_004"><span class="cls_004">a component given a store path.</span></div>
<div style="position:absolute;left:69.68px;top:272.19px" class="cls_004"><span class="cls_004">Prominent examples of cryptographic hash functions are MD5 [141] and SHA-1 [127].</span></div>
<div style="position:absolute;left:59.72px;top:284.14px" class="cls_004"><span class="cls_004">Nix initially used MD5, which produces 128-bit hashes. However, MD5 has recently been</span></div>
<div style="position:absolute;left:59.72px;top:296.10px" class="cls_004"><span class="cls_004">broken [178] in the sense that it is now possible to find collisions with a work effort of a</span></div>
<div style="position:absolute;left:59.72px;top:308.05px" class="cls_004"><span class="cls_004">few hours on conventional hardware. That is, collision resistance has been broken, but this</span></div>
<div style="position:absolute;left:59.72px;top:320.01px" class="cls_004"><span class="cls_004">technique does not find preimages or second preimages.</span></div>
<div style="position:absolute;left:69.68px;top:331.96px" class="cls_004"><span class="cls_004">In the context of Nix, a collision attack such as the one against MD5 means that it</span></div>
<div style="position:absolute;left:59.72px;top:343.92px" class="cls_004"><span class="cls_004">is possible to construct two components that hash to the same store path. Specifically, an</span></div>
<div style="position:absolute;left:59.72px;top:355.87px" class="cls_004"><span class="cls_004">attacker could create two components, one benevolent and one malevolent (e.g., containing</span></div>
<div style="position:absolute;left:59.72px;top:367.83px" class="cls_004"><span class="cls_004">a Trojan horse—a malicious component masquerading as legitimate software), with the</span></div>
<div style="position:absolute;left:59.72px;top:379.78px" class="cls_004"><span class="cls_004">same MD5 hash.  The attacker would then publish a Nix expression that uses</span><span class="cls_007"> fetchurl</span></div>
<div style="position:absolute;left:59.72px;top:391.74px" class="cls_004"><span class="cls_004">to download the benevolent component from a server, and finally replace the benevolent</span></div>
<div style="position:absolute;left:59.72px;top:403.69px" class="cls_004"><span class="cls_004">component with the malevolent one on the server. Since on download the hash continues</span></div>
<div style="position:absolute;left:59.72px;top:415.65px" class="cls_004"><span class="cls_004">to match, the deception would not be noticed. Constructing such components is quite easy</span></div>
<div style="position:absolute;left:59.72px;top:427.60px" class="cls_004"><span class="cls_004">(see, e.g., [156, Section 8.4.4], and [120, 105] for examples of the construction of harmless</span></div>
<div style="position:absolute;left:59.72px;top:439.56px" class="cls_004"><span class="cls_004">and harmful executables with matching MD5 hashes). Thus collisions of the underlying</span></div>
<div style="position:absolute;left:59.72px;top:451.52px" class="cls_004"><span class="cls_004">hash are a serious concern.</span></div>
<div style="position:absolute;left:69.68px;top:463.47px" class="cls_004"><span class="cls_004">SHA-1 is a very widely used hash function. It produces 160 bit hashes, making it more</span></div>
<div style="position:absolute;left:59.72px;top:474.40px" class="cls_004"><span class="cls_004">resistant to birthday attacks in theory as it requires 2</span><span class="cls_012"><sup>80</sup></span><span class="cls_004"> hashes on average in a brute-force</span></div>
<div style="position:absolute;left:59.72px;top:487.38px" class="cls_004"><span class="cls_004">attack. However, recent attacks [177, 146] have reduced the effort of finding a collision to</span></div>
<div style="position:absolute;left:59.72px;top:498.31px" class="cls_004"><span class="cls_004">less than 2</span><span class="cls_012"><sup>63</sup></span><span class="cls_004"> hashes. This is still a substantial effort, but it creates enough doubt regarding</span></div>
<div style="position:absolute;left:59.72px;top:511.29px" class="cls_004"><span class="cls_004">the future security of SHA-1 to require a transition away from it (“Attacks always get</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">better; they never get worse.” [147]).</span></div>
<div style="position:absolute;left:69.68px;top:535.20px" class="cls_004"><span class="cls_004">There are a number of strengthened variants of SHA-1 that produce larger hashes. These</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">are SHA-224, SHA-256, SHA-384, and SHA-512 [127]. While there are strong doubts</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">about the future security of these hashes, they represent the best choice until a next-</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">generation hash function becomes available (e.g., through a similar process as the AES</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">selection [126]).</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">88</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:64860px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background097.jpg" width=481 height=680></div>
<div style="position:absolute;left:315.64px;top:17.14px" class="cls_004"><span class="cls_004">5.1. Cryptographic hashes</span></div>
<div style="position:absolute;left:73.84px;top:45.04px" class="cls_004"><span class="cls_004">The Nix system uses SHA-256 hashes.  However, MD5 and SHA-1 are available in</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">functions such as</span><span class="cls_007"> fetchurl</span><span class="cls_004"> for compatibility.  The use of these hashes is still safe if they</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">apply to components from a trusted source, since it remains infeasible for a third-party</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">attacker to find second preimages. However, we should migrate away from these hashes to</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">SHA-256.</span></div>
<div style="position:absolute;left:63.87px;top:119.32px" class="cls_009"><span class="cls_009">Notation</span><span class="cls_004">   Byte sequences are finite-length sequences of bytes. The size of byte sequence</span></div>
<div style="position:absolute;left:63.87px;top:131.27px" class="cls_004"><span class="cls_004">c is denoted |c|. Given a byte sequence c of size |c|, we write c[i], 0 ≤ i &lt; |c| to denote</span></div>
<div style="position:absolute;left:63.87px;top:143.23px" class="cls_004"><span class="cls_004">the (i + 1)’th byte in the sequence. In examples, we write byte sequences initialised from</span></div>
<div style="position:absolute;left:63.87px;top:155.18px" class="cls_004"><span class="cls_004">ASCII characters between quotes, e.g.,</span><span class="cls_007"> "Hello"</span><span class="cls_004"> is a byte sequence of length 5.</span></div>
<div style="position:absolute;left:73.84px;top:167.14px" class="cls_004"><span class="cls_004">Given a byte sequence c, we write</span><span class="cls_007"> h</span><span class="cls_004"> =</span><span class="cls_007"> hash</span><span class="cls_012"><sub>t</sub></span><span class="cls_004"> (c) to denote the byte sequence obtained</span></div>
<div style="position:absolute;left:63.87px;top:179.09px" class="cls_004"><span class="cls_004">from the cryptographic hash function algorithm t, where t ∈ {</span><span class="cls_007">md5</span><span class="cls_004">,</span><span class="cls_007"> sha1</span><span class="cls_004">,</span><span class="cls_007"> sha256</span><span class="cls_004">}.</span></div>
<div style="position:absolute;left:73.84px;top:191.05px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> printHash</span><span class="cls_012"><sub>16</sub></span><span class="cls_004"> returns a hexadecimal string representation of a byte sequence,</span></div>
<div style="position:absolute;left:63.87px;top:203.00px" class="cls_004"><span class="cls_004">useful for printing hashes. It is defined as follows:</span></div>
<div style="position:absolute;left:88.78px;top:224.53px" class="cls_007"><span class="cls_007">printHash</span><span class="cls_012"><sub>16</sub></span><span class="cls_004">(c) =</span></div>
<div style="position:absolute;left:166.64px;top:222.28px" class="cls_038"><span class="cls_038">∑</span><span class="cls_004"> (</span><span class="cls_007">digits</span><span class="cls_012">16</span><span class="cls_004">[c[i]div16]+</span><span class="cls_007">digits</span><span class="cls_012">16</span><span class="cls_004">[c[i]mod16])</span></div>
<div style="position:absolute;left:159.47px;top:237.93px" class="cls_012"><span class="cls_012">0≤i&lt;|c|</span></div>
<div style="position:absolute;left:63.87px;top:255.51px" class="cls_004"><span class="cls_004">where + and ∑ denote string concatenation, and</span><span class="cls_007"> digits</span><span class="cls_012"><sub>16</sub></span><span class="cls_004"> is the byte sequence of hexadeci-</span></div>
<div style="position:absolute;left:63.87px;top:267.46px" class="cls_004"><span class="cls_004">mal ASCII characters, i.e.,</span><span class="cls_007"> "0123456789abcdef"</span><span class="cls_004">. For example,</span></div>
<div style="position:absolute;left:88.78px;top:288.99px" class="cls_007"><span class="cls_007">printHash</span><span class="cls_012"><sub>16</sub></span><span class="cls_004">(</span><span class="cls_007">hash</span><span class="cls_039"><sub>md5</sub></span><span class="cls_004">(</span><span class="cls_007">"Hello World"</span><span class="cls_004">)) =</span><span class="cls_007"> "b10a8db164e0754105b7a99be72e3fe5"</span></div>
<div style="position:absolute;left:73.84px;top:310.52px" class="cls_004"><span class="cls_004">There is also a function</span><span class="cls_007"> printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004"> that returns a base-32 string representation of a byte</span></div>
<div style="position:absolute;left:63.87px;top:321.14px" class="cls_004"><span class="cls_004">sequence. It produces representations of length ⌈|c| × 8/ lg 32⌉ = ⌈|c| ×</span><span class="cls_012"><sup>8</sup></span></div>
<div style="position:absolute;left:356.66px;top:322.48px" class="cls_012"><span class="cls_012">5</span><span class="cls_004">⌉.Sincethisis</span></div>
<div style="position:absolute;left:63.87px;top:334.43px" class="cls_004"><span class="cls_004">shorter than the representations produced by</span><span class="cls_007"> printHash</span><span class="cls_012"><sub>16</sub></span><span class="cls_004"> (which have length |c| × 2), it is</span></div>
<div style="position:absolute;left:63.87px;top:346.39px" class="cls_004"><span class="cls_004">useful inter alia for the representation of hashes in store paths. It is defined as follows:</span></div>
<div style="position:absolute;left:88.78px;top:367.92px" class="cls_007"><span class="cls_007">printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004">(c) =</span></div>
<div style="position:absolute;left:175.47px;top:365.66px" class="cls_038"><span class="cls_038">∑</span><span class="cls_007">  digits</span><span class="cls_012">32</span><span class="cls_004">[(</span></div>
<div style="position:absolute;left:246.02px;top:365.66px" class="cls_038"><span class="cls_038">∑</span><span class="cls_004"> c[ j] × 256</span><span class="cls_012"><sup>j</sup></span><span class="cls_004"> )/32</span><span class="cls_012"><sup>i</sup></span><span class="cls_004"> mod 32]</span></div>
<div style="position:absolute;left:159.47px;top:381.24px" class="cls_012"><span class="cls_012">⌈|c|×</span><span class="cls_013"><sup>8</sup></span></div>
<div style="position:absolute;left:238.21px;top:381.32px" class="cls_012"><span class="cls_012">0≤ j&lt;|c|</span></div>
<div style="position:absolute;left:177.03px;top:382.75px" class="cls_013"><span class="cls_013">5</span><span class="cls_012">⌉>i≥0</span></div>
<div style="position:absolute;left:63.87px;top:401.26px" class="cls_004"><span class="cls_004">That is, interpreting c as a base-256 encoding of some number, with digits from least</span></div>
<div style="position:absolute;left:63.87px;top:413.21px" class="cls_004"><span class="cls_004">significant to most significant (i.e., a little-endian number), we print the number in base-</span></div>
<div style="position:absolute;left:63.87px;top:425.17px" class="cls_004"><span class="cls_004">32 with digits from most significant to least significant.</span></div>
<div style="position:absolute;left:294.81px;top:425.17px" class="cls_004"><span class="cls_004">(Note that the outer summation</span></div>
<div style="position:absolute;left:63.87px;top:437.12px" class="cls_004"><span class="cls_004">denotes string concatenation, while the inner summation denotes integer addition.) The set</span></div>
<div style="position:absolute;left:63.87px;top:449.08px" class="cls_004"><span class="cls_004">of digits is</span></div>
<div style="position:absolute;left:88.78px;top:470.61px" class="cls_007"><span class="cls_007">digits</span><span class="cls_012"><sub>32</sub></span><span class="cls_004"> =</span><span class="cls_007"> "0123456789abcdfghijklmnpqrsvwxyz"</span></div>
<div style="position:absolute;left:63.87px;top:492.14px" class="cls_004"><span class="cls_004">i.e., the alphanumerics excepting the letters</span><span class="cls_007"> e</span><span class="cls_004">,</span><span class="cls_007"> o</span><span class="cls_004">,</span><span class="cls_007"> u</span><span class="cls_004">, and</span><span class="cls_007"> t</span><span class="cls_004">. This is to reduce the possibility</span></div>
<div style="position:absolute;left:63.87px;top:504.09px" class="cls_004"><span class="cls_004">that hash representations contain character sequences that are potentially offensive to some</span></div>
<div style="position:absolute;left:63.87px;top:516.05px" class="cls_004"><span class="cls_004">users (a known possibility with alphanumeric representations of numbers [11]). Here is an</span></div>
<div style="position:absolute;left:63.87px;top:528.00px" class="cls_004"><span class="cls_004">example of</span><span class="cls_007"> printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004">:</span></div>
<div style="position:absolute;left:88.78px;top:549.54px" class="cls_007"><span class="cls_007">printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004">(</span><span class="cls_007">hash</span><span class="cls_039"><sub>sha1</sub></span><span class="cls_004">(</span><span class="cls_007">"Hello World"</span><span class="cls_004">)) =</span><span class="cls_007"> "s23c9fs0v32pf6bhmcph5rbqsyl5ak8a"</span></div>
<div style="position:absolute;left:73.84px;top:571.07px" class="cls_004"><span class="cls_004">It is sometimes necessary to truncate a hash to a specific number of bytes n. For instance,</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">below we will truncate 32-byte SHA-256 hashes to 20 bytes (of course, this reduces the</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">89</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:65550px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background098.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">security of the hash).  This truncation is done by cyclically XORing the input with an</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">initially zero-filled byte array of length n. Formally, the result of</span><span class="cls_007"> truncate</span><span class="cls_004">(n, c) is defined</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">by the equation</span></div>
<div style="position:absolute;left:181.38px;top:83.30px" class="cls_035"><span class="cls_035">⊕</span></div>
<div style="position:absolute;left:84.62px;top:91.07px" class="cls_007"><span class="cls_007">truncate</span><span class="cls_004">(n, c)[i] =</span></div>
<div style="position:absolute;left:218.79px;top:91.07px" class="cls_004"><span class="cls_004">c[ j]</span></div>
<div style="position:absolute;left:158.61px;top:105.48px" class="cls_012"><span class="cls_012">0≤ j&lt;|c|, j mod n=i</span></div>
<div style="position:absolute;left:59.72px;top:123.65px" class="cls_004"><span class="cls_004">where ⊕ denotes the XOR operator.</span></div>
<div style="position:absolute;left:59.72px;top:154.90px" class="cls_011"><span class="cls_011">5.2. The Nix store</span></div>
<div style="position:absolute;left:59.72px;top:181.50px" class="cls_008"><span class="cls_008">5.2.1. File system objects</span></div>
<div style="position:absolute;left:59.72px;top:200.15px" class="cls_004"><span class="cls_004">The Nix store is a directory in the file system that contains file system objects (FSOs)</span><span class="cls_012"><sup>1</sup></span><span class="cls_004">, such</span></div>
<div style="position:absolute;left:59.72px;top:213.13px" class="cls_004"><span class="cls_004">as files and directories. In the context of the Nix store, FSOs typically represent software</span></div>
<div style="position:absolute;left:59.72px;top:225.09px" class="cls_004"><span class="cls_004">components, user environments and store derivations. As we shall see below, Nix must</span></div>
<div style="position:absolute;left:59.72px;top:237.04px" class="cls_004"><span class="cls_004">perform various operations on FSOs, such as computing cryptographic hashes over their</span></div>
<div style="position:absolute;left:59.72px;top:249.00px" class="cls_004"><span class="cls_004">contents, scanning for strings, rewriting strings, and so on. Thus, it is useful to formalise</span></div>
<div style="position:absolute;left:59.72px;top:260.95px" class="cls_004"><span class="cls_004">the notion of FSOs.</span></div>
<div style="position:absolute;left:69.68px;top:273.01px" class="cls_004"><span class="cls_004">Operating systems have different kinds of objects that live in a file system. All modern</span></div>
<div style="position:absolute;left:59.72px;top:284.97px" class="cls_004"><span class="cls_004">operating systems at the very least have hierarchical directories and files that consist of</span></div>
<div style="position:absolute;left:59.72px;top:296.92px" class="cls_004"><span class="cls_004">unstructured sequences of bytes (as opposed to, say, files consisting of records). Beyond</span></div>
<div style="position:absolute;left:59.72px;top:308.88px" class="cls_004"><span class="cls_004">that, there are many extensions:</span></div>
<div style="position:absolute;left:74.66px;top:329.11px" class="cls_004"><span class="cls_004">• Symbolic links on Unix.</span></div>
<div style="position:absolute;left:74.66px;top:349.45px" class="cls_004"><span class="cls_004">• Permissions, ranging from MS-DOS’s read-only attribute, through Unix’s access</span></div>
<div style="position:absolute;left:84.62px;top:361.41px" class="cls_004"><span class="cls_004">rights, to complex Access Control Lists (Windows NT, various Unixes).</span></div>
<div style="position:absolute;left:74.66px;top:381.75px" class="cls_004"><span class="cls_004">• Extended attributes (OS/2, Windows NT) that allow arbitrary name/value pairs to be</span></div>
<div style="position:absolute;left:84.62px;top:393.70px" class="cls_004"><span class="cls_004">associated with files.</span></div>
<div style="position:absolute;left:74.66px;top:414.04px" class="cls_004"><span class="cls_004">• Streams (Windows NT) or resource forks (Mac OS) that extend the notion of a file</span></div>
<div style="position:absolute;left:84.62px;top:426.00px" class="cls_004"><span class="cls_004">as a sequence of bytes to being sequences of bytes.</span></div>
<div style="position:absolute;left:74.66px;top:446.34px" class="cls_004"><span class="cls_004">• Forests of directory hierarchies (e.g., as formed by drive letters in Windows).</span></div>
<div style="position:absolute;left:74.66px;top:466.68px" class="cls_004"><span class="cls_004">• Hard links that turn file systems into directed acyclic graphs instead of trees.</span></div>
<div style="position:absolute;left:74.66px;top:487.02px" class="cls_004"><span class="cls_004">• Device nodes, FIFOs, named pipes, sockets, and other types of files with special</span></div>
<div style="position:absolute;left:84.62px;top:498.97px" class="cls_004"><span class="cls_004">semantics.</span></div>
<div style="position:absolute;left:69.68px;top:519.21px" class="cls_004"><span class="cls_004">Fortunately, for our purposes—which is storing components in the Nix store—most of</span></div>
<div style="position:absolute;left:59.72px;top:531.16px" class="cls_004"><span class="cls_004">these features are either not relevant (drive letters, device nodes, etc.), can be ignored (hard</span></div>
<div style="position:absolute;left:59.72px;top:543.12px" class="cls_004"><span class="cls_004">links), or are never used in practice (streams). Some others, such as permissions, we will</span></div>
<div style="position:absolute;left:59.72px;top:555.07px" class="cls_004"><span class="cls_004">ignore to make life simpler.</span></div>
<div style="position:absolute;left:64.20px;top:574.65px" class="cls_013"><span class="cls_013"><sup>1</sup></span><span class="cls_014">In the Unix tradition, the term file refers to any file system object (i.e., an FSO), while the term regular file</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">refers to what most people call a file. This thesis uses the term FSO to avoid the ambiguity.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">90</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:66240px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background099.jpg" width=481 height=680></div>
<div style="position:absolute;left:347.46px;top:17.14px" class="cls_004"><span class="cls_004">5.2. The Nix store</span></div>
<div style="position:absolute;left:72.24px;top:46.83px" class="cls_004"><span class="cls_004">data</span><span class="cls_007"> FSO</span><span class="cls_004"> =</span><span class="cls_007"> Regular Executable ByteStream</span></div>
<div style="position:absolute;left:118.08px;top:61.78px" class="cls_004"><span class="cls_004">|</span><span class="cls_007"> Directory</span><span class="cls_004"> [(</span><span class="cls_007">FileName</span><span class="cls_004">,</span><span class="cls_007"> FSO</span><span class="cls_004">)]</span></div>
<div style="position:absolute;left:118.08px;top:76.72px" class="cls_004"><span class="cls_004">|</span><span class="cls_007"> SymLink ByteStream</span></div>
<div style="position:absolute;left:72.24px;top:100.63px" class="cls_004"><span class="cls_004">data</span><span class="cls_007"> Executable</span><span class="cls_004"> =</span><span class="cls_007"> Executable</span></div>
<div style="position:absolute;left:143.55px;top:115.57px" class="cls_004"><span class="cls_004">|</span><span class="cls_007"> NonExecutable</span></div>
<div style="position:absolute;left:142.44px;top:140.26px" class="cls_004"><span class="cls_004">Figure 5.1.: Abstract syntax for file system objects</span></div>
<div style="position:absolute;left:73.84px;top:171.82px" class="cls_004"><span class="cls_004">What we absolutely cannot ignore for deployment of Unix software is regular files,</span></div>
<div style="position:absolute;left:63.87px;top:183.78px" class="cls_004"><span class="cls_004">directories, and symbolic links. Also, while we can get away with disregarding most file</span></div>
<div style="position:absolute;left:63.87px;top:194.71px" class="cls_004"><span class="cls_004">permissions, the executable bit must be maintained</span><span class="cls_012"><sup>2</sup></span><span class="cls_004">. This leads to the grammar for FSOs</span></div>
<div style="position:absolute;left:63.87px;top:207.69px" class="cls_004"><span class="cls_004">shown in Figure 5.1. (The data type for FSOs shown in this figure uses the Haskell-like</span></div>
<div style="position:absolute;left:63.87px;top:219.64px" class="cls_004"><span class="cls_004">notation described in Section 1.7.) A</span><span class="cls_007"> ByteStream</span><span class="cls_004"> is a sequence of 0 or more bytes, and</span></div>
<div style="position:absolute;left:63.87px;top:231.60px" class="cls_004"><span class="cls_004">a</span><span class="cls_007"> FileName</span><span class="cls_004"> is a sequence of 1 or more bytes not equal to 0. For example, the file system</span></div>
<div style="position:absolute;left:63.87px;top:243.55px" class="cls_004"><span class="cls_004">object</span></div>
<div style="position:absolute;left:93.76px;top:264.43px" class="cls_007"><span class="cls_007">Directory</span><span class="cls_004"> [</span></div>
<div style="position:absolute;left:108.71px;top:276.39px" class="cls_004"><span class="cls_004">(</span><span class="cls_007">"foo"</span><span class="cls_004">,</span><span class="cls_007"> Regular NonExecutable "Hello World"</span><span class="cls_004">),</span></div>
<div style="position:absolute;left:108.71px;top:288.34px" class="cls_004"><span class="cls_004">(</span><span class="cls_007">"bar"</span><span class="cls_004">,</span><span class="cls_007"> Directory</span><span class="cls_004"> [</span></div>
<div style="position:absolute;left:123.65px;top:300.30px" class="cls_004"><span class="cls_004">(</span><span class="cls_007">"xyzzy"</span><span class="cls_004">,</span><span class="cls_007"> Symlink "../foo"</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:108.71px;top:312.35px" class="cls_004"><span class="cls_004">])</span></div>
<div style="position:absolute;left:93.76px;top:324.31px" class="cls_004"><span class="cls_004">]</span></div>
<div style="position:absolute;left:63.87px;top:345.01px" class="cls_004"><span class="cls_004">defines a directory with two files: a non-executable file</span><span class="cls_007"> foo</span><span class="cls_004"> with contents</span><span class="cls_007"> Hello World</span><span class="cls_004">, and a</span></div>
<div style="position:absolute;left:63.87px;top:356.96px" class="cls_004"><span class="cls_004">subdirectory</span><span class="cls_007"> bar</span><span class="cls_004"> containing a symlink called</span><span class="cls_007"> xyzzy</span><span class="cls_004"> to</span><span class="cls_007"> foo</span><span class="cls_004"> in the parent directory. Note that</span></div>
<div style="position:absolute;left:63.87px;top:368.92px" class="cls_004"><span class="cls_004">the top-level directory is anonymous. Also note that we do not keep any meta-information</span></div>
<div style="position:absolute;left:63.87px;top:380.87px" class="cls_004"><span class="cls_004">about files other than the executable bit; notably, time stamps are discarded.</span></div>
<div style="position:absolute;left:73.84px;top:392.83px" class="cls_004"><span class="cls_004">The type of FSOs defined in Figure 5.1 is not actually used in the implementation of Nix.</span></div>
<div style="position:absolute;left:63.87px;top:404.78px" class="cls_004"><span class="cls_004">They are merely a device used in this chapter to formalise certain aspects of the operation</span></div>
<div style="position:absolute;left:63.87px;top:416.74px" class="cls_004"><span class="cls_004">of Nix. In the pseudo-code algorithms in this chapter, I will use the imperative functions</span></div>
<div style="position:absolute;left:63.87px;top:428.69px" class="cls_004"><span class="cls_004">fso ←</span><span class="cls_007"> readPath</span><span class="cls_004">(p) to denote reading the FSO fso stored at path p, and</span><span class="cls_007"> writePath</span><span class="cls_004">(p, fso)</span></div>
<div style="position:absolute;left:63.87px;top:440.65px" class="cls_004"><span class="cls_004">to denote writing FSO fso to path p. For presentational simplicity, I ignore error handling</span></div>
<div style="position:absolute;left:63.87px;top:452.60px" class="cls_004"><span class="cls_004">aspects.</span></div>
<div style="position:absolute;left:73.84px;top:464.56px" class="cls_004"><span class="cls_004">To perform operations on FSOs such as computing cryptographic hashes, scanning for</span></div>
<div style="position:absolute;left:63.87px;top:476.51px" class="cls_004"><span class="cls_004">references, and so on, it is useful to be able to serialise FSOs into byte sequences, which</span></div>
<div style="position:absolute;left:63.87px;top:488.47px" class="cls_004"><span class="cls_004">can then be deserialised back into FSOs that are stored in the file system. Examples of</span></div>
<div style="position:absolute;left:63.87px;top:500.42px" class="cls_004"><span class="cls_004">such serialisations are the ZIP and TAR file formats.  However, for our purposes these</span></div>
<div style="position:absolute;left:63.87px;top:512.38px" class="cls_004"><span class="cls_004">formats have two problems:</span></div>
<div style="position:absolute;left:78.82px;top:531.82px" class="cls_004"><span class="cls_004">• They do not have a canonical serialisation, meaning that given an FSO, there can</span></div>
<div style="position:absolute;left:88.78px;top:543.78px" class="cls_004"><span class="cls_004">be many different serialisations. For instance, TAR files can have variable amounts</span></div>
<div style="position:absolute;left:88.78px;top:555.73px" class="cls_004"><span class="cls_004">of padding between archive members; and some archive formats leave the order</span></div>
<div style="position:absolute;left:68.36px;top:574.65px" class="cls_013"><span class="cls_013"><sup>2</sup></span><span class="cls_014">Nix should also support</span><span class="cls_016"> setuid</span><span class="cls_014"> executables, which are programs that are executed under a different user ID</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">than the caller. However, it is not entirely clear how to support these in a clean way.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">91</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:66930px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background100.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:84.62px;top:45.04px" class="cls_004"><span class="cls_004">of directory entries undefined. This is bad because we use serialisation to compute</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">cryptographic hashes over FSOs, and therefore require the serialisation to be unique.</span></div>
<div style="position:absolute;left:84.62px;top:68.95px" class="cls_004"><span class="cls_004">Otherwise, the hash value can depend on implementation details or environment</span></div>
<div style="position:absolute;left:84.62px;top:80.90px" class="cls_004"><span class="cls_004">settings of the serialiser. The canonicity of archives will be particularly important in</span></div>
<div style="position:absolute;left:84.62px;top:92.86px" class="cls_004"><span class="cls_004">Section 7.5, when we apply binary patches to archives.</span></div>
<div style="position:absolute;left:74.66px;top:111.29px" class="cls_004"><span class="cls_004">• They store more information than we have in our notion of FSOs, such as time</span></div>
<div style="position:absolute;left:84.62px;top:123.25px" class="cls_004"><span class="cls_004">stamps.  This can cause FSOs that Nix should consider equal to hash to different</span></div>
<div style="position:absolute;left:84.62px;top:134.18px" class="cls_004"><span class="cls_004">values on different machines, just because the dates differ.</span><span class="cls_012"><sup>3</sup></span></div>
<div style="position:absolute;left:74.66px;top:153.64px" class="cls_004"><span class="cls_004">• As a practical consideration, the TAR format is the only truly universal format in the</span></div>
<div style="position:absolute;left:84.62px;top:165.59px" class="cls_004"><span class="cls_004">Unix environment. It has many problems, such as an inability to deal with long file</span></div>
<div style="position:absolute;left:84.62px;top:176.52px" class="cls_004"><span class="cls_004">names and files larger than 2</span><span class="cls_012"><sup>33</sup></span><span class="cls_004"> bytes.  Current implementations such as GNU Tar</span></div>
<div style="position:absolute;left:84.62px;top:189.50px" class="cls_004"><span class="cls_004">work around these limitations in various ways.</span></div>
<div style="position:absolute;left:69.68px;top:206.45px" class="cls_004"><span class="cls_004">For these reasons, Nix has its very own archive format—the Nix Archive (NAR) format.</span></div>
<div style="position:absolute;left:59.72px;top:218.40px" class="cls_004"><span class="cls_004">Figure 5.2 shows the serialisation function</span><span class="cls_007"> serialise</span><span class="cls_004">(fso) that converts an FSO to a byte</span></div>
<div style="position:absolute;left:59.72px;top:230.36px" class="cls_004"><span class="cls_004">sequence containing a NAR archive. The auxiliary function</span><span class="cls_007"> concatMap</span><span class="cls_004">( f , xs) applies the</span></div>
<div style="position:absolute;left:59.72px;top:242.31px" class="cls_004"><span class="cls_004">function f to every element of the list xs and concatenates the resulting byte sequences.</span></div>
<div style="position:absolute;left:59.72px;top:254.27px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> sortEntries</span><span class="cls_004"> sorts the list of entries in a directory by name, comparing the</span></div>
<div style="position:absolute;left:59.72px;top:266.22px" class="cls_004"><span class="cls_004">byte sequences of the names lexicographically. The function</span><span class="cls_007"> serialise</span><span class="cls_004"> is typically used in</span></div>
<div style="position:absolute;left:59.72px;top:278.18px" class="cls_004"><span class="cls_004">conjunction with</span><span class="cls_007"> readPath</span><span class="cls_004">, e.g.,</span></div>
<div style="position:absolute;left:84.62px;top:296.37px" class="cls_004"><span class="cls_004">c ← </span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p)).</span></div>
<div style="position:absolute;left:69.68px;top:314.56px" class="cls_004"><span class="cls_004">Of course, there is also a deserialisation operation</span><span class="cls_007"> deserialise(c)</span><span class="cls_004"> (typically used with</span></div>
<div style="position:absolute;left:59.72px;top:326.51px" class="cls_007"><span class="cls_007">writePath</span><span class="cls_004">) that converts a byte sequence c containing a NAR archive to an FSO. It is the</span></div>
<div style="position:absolute;left:59.72px;top:338.47px" class="cls_004"><span class="cls_004">inverse of</span><span class="cls_007"> serialise</span><span class="cls_004"> and is not shown here. The following identity holds:</span></div>
<div style="position:absolute;left:84.62px;top:356.66px" class="cls_007"><span class="cls_007">deserialise</span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(fso)) = fso</span></div>
<div style="position:absolute;left:59.72px;top:374.85px" class="cls_004"><span class="cls_004">Note that</span><span class="cls_007"> deserialise</span><span class="cls_004"> is a partial function, since most byte sequences are not valid NAR</span></div>
<div style="position:absolute;left:59.72px;top:386.80px" class="cls_004"><span class="cls_004">archives.</span></div>
<div style="position:absolute;left:59.72px;top:413.85px" class="cls_008"><span class="cls_008">5.2.2. Store paths</span></div>
<div style="position:absolute;left:59.72px;top:433.33px" class="cls_004"><span class="cls_004">A store object is a top-level file system object in the Nix store, that is, a direct child of</span></div>
<div style="position:absolute;left:59.72px;top:445.29px" class="cls_004"><span class="cls_004">the Nix store directory. Indirect subdirectories of the Nix store are not store objects (but</span></div>
<div style="position:absolute;left:59.72px;top:457.24px" class="cls_004"><span class="cls_004">contained in FSOs that are store objects).</span></div>
<div style="position:absolute;left:69.68px;top:469.20px" class="cls_004"><span class="cls_004">A store path is the full path of a store object. It has the following anatomy:</span></div>
<div style="position:absolute;left:84.62px;top:487.39px" class="cls_004"><span class="cls_004">storeDir</span><span class="cls_007">/</span><span class="cls_004">hashPart</span><span class="cls_007">-</span><span class="cls_004">name</span></div>
<div style="position:absolute;left:59.72px;top:505.58px" class="cls_004"><span class="cls_004">The first part is the path of the Nix store, denoted storeDir. The second is a 160-bit cryp-</span></div>
<div style="position:absolute;left:59.72px;top:517.53px" class="cls_004"><span class="cls_004">tographic hash in base-32 representation. Finally, there is a symbolic name intended for</span></div>
<div style="position:absolute;left:59.72px;top:529.49px" class="cls_004"><span class="cls_004">human consumption. An example of a store path is:</span></div>
<div style="position:absolute;left:84.62px;top:548.67px" class="cls_007"><span class="cls_007">/nix/store/bwacc7a5c5n3qx37nz5drwcgd2lv89w6-hello-2.1.1</span></div>
<div style="position:absolute;left:64.20px;top:565.18px" class="cls_013"><span class="cls_013"><sup>3</sup></span><span class="cls_014">This is no longer a big issue, since Nix nowadays canonicalises all FSOs added to the store by setting irrelevant</span></div>
<div style="position:absolute;left:71.67px;top:575.55px" class="cls_014"><span class="cls_014">metadata to fixed values (see page 112). For instance, it sets the time stamps on all files to 0 (1 Jan 1970,</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">00:00:00 UTC). However, metadata such as the last-accessed time stamp might still cause non-canonicity.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">92</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:67620px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background101.jpg" width=481 height=680></div>
<div style="position:absolute;left:347.46px;top:17.14px" class="cls_004"><span class="cls_004">5.2.</span></div>
<div style="position:absolute;left:367.39px;top:17.14px" class="cls_004"><span class="cls_004">The Nix store</span></div>
<div style="position:absolute;left:72.24px;top:45.81px" class="cls_007"><span class="cls_007">serialise</span><span class="cls_004">(fso) =</span><span class="cls_007"> str</span><span class="cls_004">(</span><span class="cls_007">"nix-archive-1"</span><span class="cls_004">) +</span><span class="cls_007"> serialise</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(fso)</span></div>
<div style="position:absolute;left:72.24px;top:69.72px" class="cls_007"><span class="cls_007">serialise</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(fso) =</span><span class="cls_007"> str</span><span class="cls_004">(</span><span class="cls_007">"("</span><span class="cls_004">) +</span><span class="cls_007"> seralise</span><span class="cls_012"><sup>′′</sup></span><span class="cls_004">(fso) +</span><span class="cls_007"> str</span><span class="cls_004">(</span><span class="cls_007">")"</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:72.24px;top:93.63px" class="cls_007"><span class="cls_007">serialise</span><span class="cls_012"><sup>′′</sup></span><span class="cls_004">(</span><span class="cls_007">Regular</span><span class="cls_004"> exec contents) =</span></div>
<div style="position:absolute;left:82.21px;top:106.61px" class="cls_007"><span class="cls_007">str</span><span class="cls_004">(</span><span class="cls_007">"type"</span><span class="cls_004">) +</span><span class="cls_007"> str</span><span class="cls_004">(</span><span class="cls_007">"regular"</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:91.05px;top:110.58px" class="cls_004"><span class="cls_004">{</span></div>
<div style="position:absolute;left:82.21px;top:120.83px" class="cls_004"><span class="cls_004">+</span><span class="cls_007">  str</span><span class="cls_004">(</span><span class="cls_007">"executable"</span><span class="cls_004">)+</span><span class="cls_007">str</span><span class="cls_004">(</span><span class="cls_007">""</span><span class="cls_004">),ifexec=</span><span class="cls_007">Executable</span></div>
<div style="position:absolute;left:99.07px;top:135.18px" class="cls_007"><span class="cls_007">""</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:213.06px;top:135.18px" class="cls_004"><span class="cls_004">if exec =</span><span class="cls_007"> NonExecutable</span></div>
<div style="position:absolute;left:82.21px;top:148.44px" class="cls_004"><span class="cls_004">+</span><span class="cls_007">str</span><span class="cls_004">(</span><span class="cls_007">"contents"</span><span class="cls_004">) +</span><span class="cls_007"> str</span><span class="cls_004">(contents)</span></div>
<div style="position:absolute;left:72.24px;top:171.33px" class="cls_007"><span class="cls_007">serialise</span><span class="cls_012"><sup>′′</sup></span><span class="cls_004">(</span><span class="cls_007">SymLink</span><span class="cls_004"> target) =</span></div>
<div style="position:absolute;left:82.21px;top:184.31px" class="cls_007"><span class="cls_007">str</span><span class="cls_004">(</span><span class="cls_007">"type"</span><span class="cls_004">) +</span><span class="cls_007"> str</span><span class="cls_004">(</span><span class="cls_007">"symlink"</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:82.21px;top:196.26px" class="cls_004"><span class="cls_004">+</span><span class="cls_007">str</span><span class="cls_004">(</span><span class="cls_007">"target"</span><span class="cls_004">) +</span><span class="cls_007"> str</span><span class="cls_004">(target)</span></div>
<div style="position:absolute;left:72.24px;top:219.15px" class="cls_007"><span class="cls_007">serialise</span><span class="cls_012"><sup>′′</sup></span><span class="cls_004">(</span><span class="cls_007">Directory</span><span class="cls_004"> entries) =</span></div>
<div style="position:absolute;left:82.21px;top:232.13px" class="cls_007"><span class="cls_007">str</span><span class="cls_004">(</span><span class="cls_007">"type"</span><span class="cls_004">) +</span><span class="cls_007"> str</span><span class="cls_004">(</span><span class="cls_007">"directory"</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:82.21px;top:244.08px" class="cls_004"><span class="cls_004">+</span><span class="cls_007">concatMap</span><span class="cls_004">(</span><span class="cls_007">serialiseEntry</span><span class="cls_004">,</span><span class="cls_007"> sortEntries</span><span class="cls_004">(entries))</span></div>
<div style="position:absolute;left:72.24px;top:267.99px" class="cls_007"><span class="cls_007">serialiseEntry</span><span class="cls_004">((name, fso)) =</span></div>
<div style="position:absolute;left:82.21px;top:279.95px" class="cls_007"><span class="cls_007">str</span><span class="cls_004">(</span><span class="cls_007">"entry"</span><span class="cls_004">) +</span><span class="cls_007"> str</span><span class="cls_004">(</span><span class="cls_007">"("</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:82.21px;top:291.90px" class="cls_004"><span class="cls_004">+</span><span class="cls_007">str</span><span class="cls_004">(</span><span class="cls_007">"name"</span><span class="cls_004">) +</span><span class="cls_007"> str</span><span class="cls_004">(name)</span></div>
<div style="position:absolute;left:82.21px;top:302.83px" class="cls_004"><span class="cls_004">+</span><span class="cls_007">str</span><span class="cls_004">(</span><span class="cls_007">"node"</span><span class="cls_004">) +</span><span class="cls_007"> serialise</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(fso)</span></div>
<div style="position:absolute;left:82.21px;top:315.81px" class="cls_004"><span class="cls_004">+</span><span class="cls_007">str</span><span class="cls_004">(</span><span class="cls_007">")"</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:72.24px;top:339.72px" class="cls_007"><span class="cls_007">str</span><span class="cls_004">(s) =</span><span class="cls_007"> int</span><span class="cls_004">(|s|) +</span><span class="cls_007"> pad</span><span class="cls_004">(s)</span></div>
<div style="position:absolute;left:72.24px;top:351.68px" class="cls_007"><span class="cls_007">int</span><span class="cls_004">(n) = the 64-bit little endian representation of the number n</span></div>
<div style="position:absolute;left:72.24px;top:363.63px" class="cls_007"><span class="cls_007">pad</span><span class="cls_004">(s) = the byte sequence s, padded with 0s to a multiple of 8</span></div>
<div style="position:absolute;left:327.08px;top:363.63px" class="cls_004"><span class="cls_004">bytes</span></div>
<div style="position:absolute;left:103.58px;top:388.32px" class="cls_004"><span class="cls_004">Figure 5.2.:</span><span class="cls_007"> serialise</span><span class="cls_004">: Serialising file system objects into NAR archive</span></div>
<div style="position:absolute;left:63.87px;top:420.60px" class="cls_004"><span class="cls_004">On the other hand,</span></div>
<div style="position:absolute;left:88.78px;top:443.74px" class="cls_007"><span class="cls_007">/nix/store/bwacc7a5c5n3qx37nz5drwcgd2lv89w6-hello-2.1.1/bin/hello</span></div>
<div style="position:absolute;left:63.87px;top:464.89px" class="cls_004"><span class="cls_004">is not a store path (but it has a prefix that is a store path).</span></div>
<div style="position:absolute;left:73.84px;top:476.96px" class="cls_004"><span class="cls_004">Usually, storeDir is</span><span class="cls_007"> /nix/store</span><span class="cls_004">, and in this thesis we will tacitly assume that it is.</span></div>
<div style="position:absolute;left:408.48px;top:476.96px" class="cls_004"><span class="cls_004">For</span></div>
<div style="position:absolute;left:63.87px;top:488.91px" class="cls_004"><span class="cls_004">binary deployment purposes (Section 5.5.3), it is important that Nix store locations on the</span></div>
<div style="position:absolute;left:63.87px;top:500.87px" class="cls_004"><span class="cls_004">source and target machines match.</span></div>
<div style="position:absolute;left:73.84px;top:512.94px" class="cls_004"><span class="cls_004">The symbolic name consists of one or more characters drawn from the set of letters (in</span></div>
<div style="position:absolute;left:63.87px;top:524.89px" class="cls_004"><span class="cls_004">either case), digits, and the special characters in the set</span><span class="cls_007"> "+-._?="</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:536.96px" class="cls_004"><span class="cls_004">We will assume that store paths are always fully canonicalised (see page 73), i.e., they</span></div>
<div style="position:absolute;left:63.87px;top:548.92px" class="cls_004"><span class="cls_004">are absolute, do not contain</span><span class="cls_007"> .</span><span class="cls_004"> or</span><span class="cls_007"> ..</span><span class="cls_004"> elements, and do not have redundant separators (</span><span class="cls_007">/</span><span class="cls_004">). The</span></div>
<div style="position:absolute;left:63.87px;top:560.88px" class="cls_004"><span class="cls_004">store path above is in canonical form; a non-canonical example of the same path is:</span></div>
<div style="position:absolute;left:88.78px;top:584.02px" class="cls_007"><span class="cls_007">/nix/../nix//./store/bwacc7a5c5n3qx37nz5drwcgd2lv89w6-hello-2.1.1/</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">93</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:68310px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background102.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:69.68px;top:45.04px" class="cls_004"><span class="cls_004">No component of the store location storeDir is allowed to be a symbolic link.  The</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">reason is that some builders canonicalise paths by resolving symlink components. These</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">paths may then be stored in derivation outputs as retained dependencies. Then, if storeDir</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">has different symlink components on different machines, builds on these machines might</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">not be interchangeable.</span></div>
<div style="position:absolute;left:69.68px;top:104.82px" class="cls_004"><span class="cls_004">In the remainder, we denote the infinite set of syntactically correct store paths as</span><span class="cls_007"> Path</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">Syntactic correctness depends on the value of storeDir—the location of the Nix store—but</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">we leave that implicit. We will use the convenience function</span><span class="cls_007"> hashPart</span><span class="cls_004">(p) to extract the</span></div>
<div style="position:absolute;left:59.72px;top:140.68px" class="cls_004"><span class="cls_004">hash part of a store path. Likewise,</span><span class="cls_007"> namePart</span><span class="cls_004">(p) yields the symbolic name part of p.</span></div>
<div style="position:absolute;left:69.68px;top:152.64px" class="cls_004"><span class="cls_004">How do we compute the hash part of store paths?  The hash computation has some</span></div>
<div style="position:absolute;left:59.72px;top:164.59px" class="cls_004"><span class="cls_004">important properties. First, both the Nix store path and the symbolic name are part of the</span></div>
<div style="position:absolute;left:59.72px;top:176.55px" class="cls_004"><span class="cls_004">hash. This means that Nix stores in different locations yield different hash parts, and that</span></div>
<div style="position:absolute;left:59.72px;top:188.50px" class="cls_004"><span class="cls_004">sources or outputs that are identical except for their symbolic names have different hash</span></div>
<div style="position:absolute;left:59.72px;top:200.46px" class="cls_004"><span class="cls_004">parts. This is important because the hash scanning approach to dependency determination</span></div>
<div style="position:absolute;left:59.72px;top:212.41px" class="cls_004"><span class="cls_004">described in Section 3.4 only looks at the hash parts of paths, not the symbolic name.</span></div>
<div style="position:absolute;left:69.68px;top:224.37px" class="cls_004"><span class="cls_004">Second, different types of store objects—notably sources and outputs—have different</span></div>
<div style="position:absolute;left:59.72px;top:236.32px" class="cls_004"><span class="cls_004">hashes. This prevents users from adding sources that “impersonate” outputs. In unshared</span></div>
<div style="position:absolute;left:59.72px;top:248.28px" class="cls_004"><span class="cls_004">Nix stores, this is not a major issue, but it is important for security in a shared store that</span></div>
<div style="position:absolute;left:59.72px;top:260.23px" class="cls_004"><span class="cls_004">uses the technique described in Section 6.2 to enable sharing of locally built outputs.</span></div>
<div style="position:absolute;left:69.68px;top:272.19px" class="cls_004"><span class="cls_004">These properties are achieved in the function</span><span class="cls_007"> makePath</span><span class="cls_004">, which computes store paths as</span></div>
<div style="position:absolute;left:59.72px;top:284.14px" class="cls_004"><span class="cls_004">follows:</span></div>
<div style="position:absolute;left:84.62px;top:304.32px" class="cls_007"><span class="cls_007">makePath</span><span class="cls_004">(type, descr, name) =</span></div>
<div style="position:absolute;left:94.59px;top:319.26px" class="cls_004"><span class="cls_004">nixStore +</span><span class="cls_007"> "/"</span><span class="cls_004"> +</span><span class="cls_007"> printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004">(</span><span class="cls_007">truncate</span><span class="cls_004">(20,</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(s))) +</span><span class="cls_007"> "-"</span><span class="cls_004"> + name</span></div>
<div style="position:absolute;left:59.72px;top:339.44px" class="cls_004"><span class="cls_004">where</span></div>
<div style="position:absolute;left:84.62px;top:359.61px" class="cls_004"><span class="cls_004">s = type+</span><span class="cls_007">":sha256:"</span><span class="cls_004">+descr+</span><span class="cls_007">":"</span><span class="cls_004">+nixStore+</span><span class="cls_007">":"</span><span class="cls_004">+name</span></div>
<div style="position:absolute;left:59.72px;top:379.78px" class="cls_004"><span class="cls_004">(Examples will be shown in the remainder of this chapter.)  Thus, the hash part of the</span></div>
<div style="position:absolute;left:59.72px;top:391.74px" class="cls_004"><span class="cls_004">store path is a base-32 representation of a 160-bit truncation of a SHA-256 hash of the</span></div>
<div style="position:absolute;left:59.72px;top:403.69px" class="cls_004"><span class="cls_004">variable elements that must be represented in the hash, namely, the location of the Nix store</span></div>
<div style="position:absolute;left:59.72px;top:415.65px" class="cls_004"><span class="cls_004">nixStore, the type of the store object (e.g.,</span><span class="cls_007"> "source"</span><span class="cls_004">), a unique descriptor string describing</span></div>
<div style="position:absolute;left:59.72px;top:427.60px" class="cls_004"><span class="cls_004">the store object (e.g., a cryptographic hash of the contents of the FSO in case of sources),</span></div>
<div style="position:absolute;left:59.72px;top:439.56px" class="cls_004"><span class="cls_004">and the symbolic name.</span></div>
<div style="position:absolute;left:69.68px;top:451.52px" class="cls_004"><span class="cls_004">Why do we truncate the SHA-256 hash to 160 bits? Nix originally used base-16 (hex-</span></div>
<div style="position:absolute;left:59.72px;top:463.47px" class="cls_004"><span class="cls_004">adecimal) representations of 128-bit MD5 hashes, giving a hash part of 128/ lg 16 = 32</span></div>
<div style="position:absolute;left:59.72px;top:475.43px" class="cls_004"><span class="cls_004">characters.  Since MD5 was recently broken (see Section 5.1), a decision was made to</span></div>
<div style="position:absolute;left:59.72px;top:487.38px" class="cls_004"><span class="cls_004">switch to 160-bit SHA-1 hashes. The hexadecimal representation was at that time replaced</span></div>
<div style="position:absolute;left:59.72px;top:499.34px" class="cls_004"><span class="cls_004">with a base-32 representation, which has the pleasant property of keeping the length at</span></div>
<div style="position:absolute;left:59.72px;top:511.29px" class="cls_004"><span class="cls_004">160/ lg 32 = 32 characters. (Some builders strip off hash parts from store paths using a</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">hard-coded constant of 32 characters (clearly a bad practice), so these did not need to be</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">changed.)  However, as attacks against SHA-1 were also published, SHA-256 was used</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">instead. Unfortunately, hash parts of ⌈256/ lg 32⌉ = 52 characters are a bit too long: to-</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">gether with the symbolic name, they exceed the maximum file name lengths of some file</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">systems. In particular, the Joliet extension to ISO-9660 has a maximum file name length</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">of 64 characters [38]. This would make it difficult to burn Nix stores on a CD-ROM, a</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">94</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:69000px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background103.jpg" width=481 height=680></div>
<div style="position:absolute;left:347.46px;top:17.14px" class="cls_004"><span class="cls_004">5.2. The Nix store</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">potentially useful distribution method. For this reason the SHA-256 hash is truncated to</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">160 bits. The assumption is that this is no less secure than 160-bit SHA-1, and possibly</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">more secure due to its different structure. However, given that most modern hashes share</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">the same basic design, the security of all of them might be ephemeral.</span></div>
<div style="position:absolute;left:63.87px;top:108.48px" class="cls_008"><span class="cls_008">5.2.3. Path validity and the closure invariant</span></div>
<div style="position:absolute;left:63.87px;top:127.96px" class="cls_004"><span class="cls_004">Nix maintains meta-information about store paths in a number of database tables.  This</span></div>
<div style="position:absolute;left:63.87px;top:139.92px" class="cls_004"><span class="cls_004">information includes the following:</span></div>
<div style="position:absolute;left:78.82px;top:159.21px" class="cls_004"><span class="cls_004">• The set of valid paths, which are the paths that are “finished”, i.e., whose contents</span></div>
<div style="position:absolute;left:88.78px;top:171.16px" class="cls_004"><span class="cls_004">will no longer change.  For instance, the output path of a derivation isn’t marked</span></div>
<div style="position:absolute;left:88.78px;top:183.12px" class="cls_004"><span class="cls_004">as valid until the builder that produces it finishes successfully. The contents of an</span></div>
<div style="position:absolute;left:88.78px;top:195.07px" class="cls_004"><span class="cls_004">invalid path are undefined (except when the FSO is under construction, in which</span></div>
<div style="position:absolute;left:88.78px;top:207.03px" class="cls_004"><span class="cls_004">case a lock is used to indicate this fact, as we shall see below).</span></div>
<div style="position:absolute;left:78.82px;top:226.64px" class="cls_004"><span class="cls_004">• The references graph (i.e., the deployment analogue of the pointer graph in program-</span></div>
<div style="position:absolute;left:88.78px;top:238.59px" class="cls_004"><span class="cls_004">ming languages). For each valid path, Nix maintains the set of references to other</span></div>
<div style="position:absolute;left:88.78px;top:250.55px" class="cls_004"><span class="cls_004">valid paths discovered by scanning for hash parts.</span></div>
<div style="position:absolute;left:78.82px;top:270.16px" class="cls_004"><span class="cls_004">• The substitutes that have been registered by tools such as</span><span class="cls_007"> nix-pull</span><span class="cls_004"> (Section 2.6).</span></div>
<div style="position:absolute;left:78.82px;top:289.77px" class="cls_004"><span class="cls_004">• Traceability information: for each valid output path, Nix remembers the derivation</span></div>
<div style="position:absolute;left:88.78px;top:301.72px" class="cls_004"><span class="cls_004">that built it.</span></div>
<div style="position:absolute;left:73.84px;top:321.02px" class="cls_004"><span class="cls_004">The current Nix implementation stores this information in a transactional Berkeley DB</span></div>
<div style="position:absolute;left:63.87px;top:332.97px" class="cls_004"><span class="cls_004">database.  As we shall see, transactions are important to ensure that the store invariants</span></div>
<div style="position:absolute;left:63.87px;top:344.93px" class="cls_004"><span class="cls_004">described below always hold, that interrupted operations can be restarted, and that multiple</span></div>
<div style="position:absolute;left:63.87px;top:356.88px" class="cls_004"><span class="cls_004">operations can be safely executed in parallel.</span></div>
<div style="position:absolute;left:73.84px;top:368.84px" class="cls_004"><span class="cls_004">The most important pieces of information in the database are the set of valid paths and</span></div>
<div style="position:absolute;left:63.87px;top:380.79px" class="cls_004"><span class="cls_004">the references graph, which are defined here. The other database tables are defined below.</span></div>
<div style="position:absolute;left:63.87px;top:392.75px" class="cls_004"><span class="cls_004">The type of a database table t is given as t : A → B, where A is the type of the key and B is</span></div>
<div style="position:absolute;left:63.87px;top:404.70px" class="cls_004"><span class="cls_004">the type of the value corresponding to a key; t[x] denotes the value corresponding to key x.</span></div>
<div style="position:absolute;left:63.87px;top:416.66px" class="cls_004"><span class="cls_004">The special value ε indicates that no entry occurs for a value in the given mapping. Setting</span></div>
<div style="position:absolute;left:63.87px;top:428.61px" class="cls_004"><span class="cls_004">of table entries is denoted by t[x] ← y.</span></div>
<div style="position:absolute;left:73.84px;top:440.57px" class="cls_004"><span class="cls_004">The mapping</span><span class="cls_007"> valid</span><span class="cls_004"> :</span><span class="cls_007"> Path</span><span class="cls_004"> →</span><span class="cls_007"> Hash</span><span class="cls_004"> serves two purposes.  First, it lists the set of valid</span></div>
<div style="position:absolute;left:63.87px;top:452.52px" class="cls_004"><span class="cls_004">paths—the paths that have been successfully built, added as a source, or obtained through</span></div>
<div style="position:absolute;left:63.87px;top:464.48px" class="cls_004"><span class="cls_004">a substitute. It does not include paths that are currently being built, or that have been left</span></div>
<div style="position:absolute;left:63.87px;top:476.43px" class="cls_004"><span class="cls_004">over from failed operations. Thus,</span><span class="cls_007"> valid</span><span class="cls_004">[p] = ε means that path p is valid. The following</span></div>
<div style="position:absolute;left:63.87px;top:488.39px" class="cls_004"><span class="cls_004">invariant states that valid paths should exist.</span></div>
<div style="position:absolute;left:63.87px;top:507.68px" class="cls_004"><span class="cls_004">Invariant 1 (Validity invariant). If a path is valid, it exists in the Nix store:</span></div>
<div style="position:absolute;left:88.78px;top:528.81px" class="cls_004"><span class="cls_004">∀p ∈ </span><span class="cls_007">Path </span><span class="cls_004">: </span><span class="cls_007">valid</span><span class="cls_004">[p] = ε → </span><span class="cls_007">pathExists</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:73.84px;top:549.94px" class="cls_004"><span class="cls_004">Second, the</span><span class="cls_007"> valid</span><span class="cls_004"> mapping stores a SHA-256 cryptographic hash of the contents of each</span></div>
<div style="position:absolute;left:63.87px;top:561.89px" class="cls_004"><span class="cls_004">valid path. That is, when the path is made valid, the</span><span class="cls_007"> valid</span><span class="cls_004"> entry for the path is set as follows:</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_007"><span class="cls_007">valid</span><span class="cls_004">[p] ←</span><span class="cls_007"> "sha256:"</span><span class="cls_004"> +</span><span class="cls_007"> printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004">(</span><span class="cls_007">hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p))))</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">95</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:69690px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background104.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">(The name of the hash algorithm is incorporated to facilitate future upgrading of the hash</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">algorithm.) For instance, given a valid path</span><span class="cls_007"> /nix/store/bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004"> with an</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">FSO whose serialisation has SHA-256 hash</span><span class="cls_007"> 085xkvh8plc0...</span><span class="cls_004">, we have</span></div>
<div style="position:absolute;left:84.62px;top:90.70px" class="cls_007"><span class="cls_007">valid</span><span class="cls_004">[</span><span class="cls_007">"/nix/store/bwacc7a5c5n3...-hello-2.1.1"</span><span class="cls_004">] =</span><span class="cls_007"> "sha256:085xkvh8plc0..."</span></div>
<div style="position:absolute;left:69.68px;top:112.46px" class="cls_004"><span class="cls_004">The purpose of storing these content hashes is to detect accidental tampering with store</span></div>
<div style="position:absolute;left:59.72px;top:124.41px" class="cls_004"><span class="cls_004">objects, which are supposed to be read-only.  The command</span><span class="cls_007"> nix-store --verify --check-</span></div>
<div style="position:absolute;left:59.72px;top:136.37px" class="cls_007"><span class="cls_007">contents</span><span class="cls_004"> checks that the contents of store paths are still consistent with their stored hashes.</span></div>
<div style="position:absolute;left:59.72px;top:148.32px" class="cls_004"><span class="cls_004">That is, the following invariant must hold.</span></div>
<div style="position:absolute;left:59.72px;top:168.12px" class="cls_004"><span class="cls_004">Invariant 2 (Stored hash invariant). The contents at valid store paths correspond to the</span></div>
<div style="position:absolute;left:59.72px;top:180.07px" class="cls_004"><span class="cls_004">cryptographic hashes stored in the</span><span class="cls_007"> valid</span><span class="cls_004"> table:</span></div>
<div style="position:absolute;left:89.60px;top:201.27px" class="cls_004"><span class="cls_004">∀p ∈ </span><span class="cls_007">Path </span><span class="cls_004">: </span><span class="cls_007">valid</span><span class="cls_004">[p] = ε →</span></div>
<div style="position:absolute;left:99.57px;top:213.23px" class="cls_007"><span class="cls_007">valid</span><span class="cls_004">[p] =</span><span class="cls_007"> "sha256:"</span><span class="cls_004"> +</span><span class="cls_007"> printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004">(</span><span class="cls_007">hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p))))</span></div>
<div style="position:absolute;left:69.68px;top:235.00px" class="cls_004"><span class="cls_004">The mapping</span><span class="cls_007"> references</span><span class="cls_004"> :</span><span class="cls_007"> Path</span><span class="cls_004"> → {</span><span class="cls_007">Path</span><span class="cls_004">}  maintains the references graph, i.e., the set</span></div>
<div style="position:absolute;left:59.72px;top:246.95px" class="cls_004"><span class="cls_004">of store paths referenced by each store object.  For sources, the references are usually</span></div>
<div style="position:absolute;left:59.72px;top:258.91px" class="cls_004"><span class="cls_004">empty.  For store derivations, they are exactly the union of the store paths listed in its</span></div>
<div style="position:absolute;left:59.72px;top:270.86px" class="cls_007"><span class="cls_007">inputSrcs</span><span class="cls_004"> and</span><span class="cls_007"> inputDrvs</span><span class="cls_004"> fields. For output paths, they are found through scanning using</span></div>
<div style="position:absolute;left:59.72px;top:282.82px" class="cls_004"><span class="cls_004">the method outlined in Section 3.4. As we will see in Section 5.6.3, the</span><span class="cls_007"> references</span><span class="cls_004"> graph</span></div>
<div style="position:absolute;left:59.72px;top:294.78px" class="cls_004"><span class="cls_004">is acyclic except for trivial cycles defined by self-references, i.e., when p ∈</span><span class="cls_007"> references</span><span class="cls_004">[p].</span></div>
<div style="position:absolute;left:59.72px;top:306.73px" class="cls_004"><span class="cls_004">Self-references occur when a builder stores its output path in its output.</span></div>
<div style="position:absolute;left:69.68px;top:318.69px" class="cls_004"><span class="cls_004">An important property of the Nix store is that at all times the following invariant holds.</span></div>
<div style="position:absolute;left:59.72px;top:338.48px" class="cls_004"><span class="cls_004">Invariant 3 (Closure invariant).  The set of valid paths is closed under the</span><span class="cls_007"> references</span></div>
<div style="position:absolute;left:59.72px;top:350.43px" class="cls_004"><span class="cls_004">relation:</span></div>
<div style="position:absolute;left:84.62px;top:370.66px" class="cls_004"><span class="cls_004">∀p ∈ </span><span class="cls_007">Path </span><span class="cls_004">: </span><span class="cls_007">valid</span><span class="cls_004">[p] = ε → ∀p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ∈ </span><span class="cls_007">references</span><span class="cls_004">[p] : </span><span class="cls_007">valid</span><span class="cls_004">[p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">] = ε</span></div>
<div style="position:absolute;left:69.68px;top:393.94px" class="cls_004"><span class="cls_004">The closure of a valid path p is the set of all paths reachable by traversing references</span></div>
<div style="position:absolute;left:59.72px;top:405.90px" class="cls_004"><span class="cls_004">from p:</span></div>
<div style="position:absolute;left:184.65px;top:419.88px" class="cls_035"><span class="cls_035">⋃</span></div>
<div style="position:absolute;left:84.62px;top:427.65px" class="cls_007"><span class="cls_007">closure</span><span class="cls_004">(p) = {p} ∪</span></div>
<div style="position:absolute;left:216.11px;top:426.13px" class="cls_007"><span class="cls_007">closure</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:164.80px;top:441.38px" class="cls_012"><span class="cls_012">p</span><span class="cls_013"><sup>′</sup></span><span class="cls_012">∈</span><span class="cls_039">references</span><span class="cls_012">[p]</span></div>
<div style="position:absolute;left:59.72px;top:459.91px" class="cls_004"><span class="cls_004">As I explained in Section 2.1, the closure is vitally important for correct deployment, since</span></div>
<div style="position:absolute;left:59.72px;top:471.87px" class="cls_004"><span class="cls_004">the closure of a component is the set of paths that might be accessed in an execution</span></div>
<div style="position:absolute;left:59.72px;top:483.82px" class="cls_004"><span class="cls_004">involving the component.  The closure is what must be copied in its entirety when we</span></div>
<div style="position:absolute;left:59.72px;top:495.78px" class="cls_004"><span class="cls_004">deploy the component.  Invariant 3 (closure) and Invariant 1 (validity) together give us</span></div>
<div style="position:absolute;left:59.72px;top:507.73px" class="cls_004"><span class="cls_004">complete deployment: if a path p is valid, then all its potential runtime dependencies are</span></div>
<div style="position:absolute;left:59.72px;top:519.69px" class="cls_004"><span class="cls_004">also valid; and all these paths exist in the file system.</span></div>
<div style="position:absolute;left:69.68px;top:531.64px" class="cls_004"><span class="cls_004">The references graph is also maintained in the opposite direction. Nix maintains a map-</span></div>
<div style="position:absolute;left:59.72px;top:543.60px" class="cls_004"><span class="cls_004">ping</span><span class="cls_007"> referers</span><span class="cls_004"> :</span><span class="cls_007"> Path</span><span class="cls_004"> → {</span><span class="cls_007">Path</span><span class="cls_004">} that defines the transpose of the graph defined by the</span><span class="cls_007"> refer-</span></div>
<div style="position:absolute;left:59.72px;top:554.53px" class="cls_007"><span class="cls_007">ences</span><span class="cls_004"> mapping</span><span class="cls_012"><sup>4</sup></span><span class="cls_004">. Thus, the following invariant must hold.</span></div>
<div style="position:absolute;left:64.20px;top:574.65px" class="cls_013"><span class="cls_013"><sup>4</sup></span><span class="cls_014">The</span><span class="cls_016"> referers</span><span class="cls_014"> table should properly be spelled</span><span class="cls_016"> referrers</span><span class="cls_014">. However, the Nix implementation unwittingly followed</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">the unfortunate tradition established by the HTTP standard, which has a misspelled</span><span class="cls_016"> Referer</span><span class="cls_014"> header field [57].</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">96</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:70380px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background105.jpg" width=481 height=680></div>
<div style="position:absolute;left:375.68px;top:17.14px" class="cls_004"><span class="cls_004">5.3. Atoms</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">Invariant 4 (Integrity invariant). The graphs defined by the</span><span class="cls_007"> references</span><span class="cls_004"> and</span><span class="cls_007"> referers</span><span class="cls_004"> map-</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">pings are each other’s transposes:</span></div>
<div style="position:absolute;left:88.78px;top:75.38px" class="cls_004"><span class="cls_004">∀p, p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ∈</span><span class="cls_007"> Path</span><span class="cls_004"> : p ∈</span><span class="cls_007"> references</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">) ↔ p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ∈</span><span class="cls_007"> referers</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:73.84px;top:96.81px" class="cls_004"><span class="cls_004">We can also compute the closure of a valid path under the</span><span class="cls_007"> referers</span><span class="cls_004"> relation (the referrer</span></div>
<div style="position:absolute;left:63.87px;top:108.77px" class="cls_004"><span class="cls_004">closure):</span></div>
<div style="position:absolute;left:190.09px;top:120.91px" class="cls_035"><span class="cls_035">⋃</span></div>
<div style="position:absolute;left:88.78px;top:127.16px" class="cls_007"><span class="cls_007">closure</span><span class="cls_012"><sup>T</sup></span><span class="cls_004"> (p) = {p} ∪</span></div>
<div style="position:absolute;left:217.31px;top:127.16px" class="cls_007"><span class="cls_007">closure</span><span class="cls_012"><sup>T</sup></span><span class="cls_004"> (p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:174.49px;top:142.41px" class="cls_012"><span class="cls_012">p</span><span class="cls_013"><sup>′</sup></span><span class="cls_012">∈</span><span class="cls_039">referers</span><span class="cls_012">[p]</span></div>
<div style="position:absolute;left:63.87px;top:159.10px" class="cls_004"><span class="cls_004">This is the set of all paths that can reach path p in the</span><span class="cls_007"> references</span><span class="cls_004"> graph. Note that while</span></div>
<div style="position:absolute;left:63.87px;top:171.05px" class="cls_007"><span class="cls_007">closure</span><span class="cls_004">(p) is constant for a valid path (i.e., can never change due to the immutable nature</span></div>
<div style="position:absolute;left:63.87px;top:181.98px" class="cls_004"><span class="cls_004">of valid objects),</span><span class="cls_007"> closure</span><span class="cls_012"><sup>T</sup></span><span class="cls_004"> (p) is variable, since additional referrers can become valid (e.g.,</span></div>
<div style="position:absolute;left:63.87px;top:194.96px" class="cls_004"><span class="cls_004">due to building), and existing referrers can become invalid (due to garbage collection).</span></div>
<div style="position:absolute;left:73.84px;top:206.92px" class="cls_004"><span class="cls_004">The main application of referrers is to allow users to gain insight in the dependency</span></div>
<div style="position:absolute;left:63.87px;top:218.88px" class="cls_004"><span class="cls_004">graph. The command</span><span class="cls_007"> nix-store --query --referers</span><span class="cls_004"> allows users to query what paths refer to</span></div>
<div style="position:absolute;left:63.87px;top:230.83px" class="cls_004"><span class="cls_004">a given path. For instance,</span></div>
<div style="position:absolute;left:88.78px;top:253.41px" class="cls_015"><span class="cls_015">$ nix-store  -q  --referers  /nix/store/wa2xjf809y7k...-glibc-2.3.5</span></div>
<div style="position:absolute;left:88.78px;top:264.37px" class="cls_015"><span class="cls_015">/nix/store/vcwh8w6ryn37...-libxslt-1.1.14</span></div>
<div style="position:absolute;left:88.78px;top:275.33px" class="cls_015"><span class="cls_015">/nix/store/vfps6jpav2h6...-gnutar-1.15.1  [...]</span></div>
<div style="position:absolute;left:63.87px;top:288.39px" class="cls_004"><span class="cls_004">shows the components in the store that use a particular instance of Glibc. Likewise, the</span></div>
<div style="position:absolute;left:63.87px;top:300.34px" class="cls_004"><span class="cls_004">command</span><span class="cls_007"> nix-store --query --referers-closure</span><span class="cls_004"> prints all paths that directly or indirectly refer</span></div>
<div style="position:absolute;left:63.87px;top:312.30px" class="cls_004"><span class="cls_004">to the given path.</span></div>
<div style="position:absolute;left:63.87px;top:342.61px" class="cls_011"><span class="cls_011">5.3. Atoms</span></div>
<div style="position:absolute;left:63.87px;top:367.83px" class="cls_004"><span class="cls_004">A basic operation on the Nix store is to add atoms to the store. Atoms are store objects that</span></div>
<div style="position:absolute;left:63.87px;top:379.78px" class="cls_004"><span class="cls_004">are not derived, that is, are not built by performing a store derivation. The foremost exam-</span></div>
<div style="position:absolute;left:63.87px;top:391.74px" class="cls_004"><span class="cls_004">ples of atoms are sources referenced from derivations in Nix expressions (e.g.,</span><span class="cls_007"> builder.sh</span></div>
<div style="position:absolute;left:63.87px;top:403.69px" class="cls_004"><span class="cls_004">in Figure 2.6), and store derivations.</span></div>
<div style="position:absolute;left:73.84px;top:415.65px" class="cls_004"><span class="cls_004">The operation</span><span class="cls_007"> addToStore</span><span class="cls_004">(fso, refs, name) shown in Figure 5.3 adds an FSO fso to the</span></div>
<div style="position:absolute;left:63.87px;top:427.60px" class="cls_004"><span class="cls_004">Nix store. The store path is computed from the cryptographic hash of the serialisation of</span></div>
<div style="position:absolute;left:63.87px;top:439.56px" class="cls_004"><span class="cls_004">fso, and the symbolic name name. The</span><span class="cls_007"> references</span><span class="cls_004"> entry for the resulting path is set to refs.</span></div>
<div style="position:absolute;left:73.84px;top:451.52px" class="cls_004"><span class="cls_004">The operation works as follows. It computes the cryptographic hash over the serialisa-</span></div>
<div style="position:absolute;left:63.87px;top:463.47px" class="cls_004"><span class="cls_004">tion of the FSO, and uses that and name to construct the store path p</span><span class="cls_014"> </span><span class="cls_056">45</span><span class="cls_059"> </span><span class="cls_004">. If path p is not</span></div>
<div style="position:absolute;left:63.87px;top:475.43px" class="cls_004"><span class="cls_004">valid</span><span class="cls_014"> </span><span class="cls_056">47</span><span class="cls_059"> </span><span class="cls_004">, the FSO is written to path p</span><span class="cls_014"> </span><span class="cls_056">48</span><span class="cls_059"> </span><span class="cls_004">. The path is marked as valid, with the references</span></div>
<div style="position:absolute;left:63.87px;top:487.38px" class="cls_004"><span class="cls_004">of p set to refs</span><span class="cls_014"> </span><span class="cls_056">49</span><span class="cls_059"> </span><span class="cls_004">. The references are set by the helper function</span><span class="cls_007"> setReferences</span><span class="cls_014"> </span><span class="cls_056">50</span><span class="cls_059"> </span><span class="cls_004">, which</span></div>
<div style="position:absolute;left:63.87px;top:499.34px" class="cls_004"><span class="cls_004">also updates the corresponding referrer mappings. The remainder of the code is concerned</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">with concurrency.</span></div>
<div style="position:absolute;left:73.84px;top:523.25px" class="cls_004"><span class="cls_004">The hash part of path p is essentially a cryptographic hash of the atom being added.</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">Therefore there is a correspondence between the file name of the store object created</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">by</span><span class="cls_007"> addToStore</span><span class="cls_004">, and its contents.  As a consequence, knowing the contents of an FSO</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">(and its symbolic name) also tells one its store path. This property is known as content-</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">addressability. It does not hold for all store objects: derivation outputs are not content-</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">addressable, since their output paths are computed before they are built (as we will see in</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">97</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:71070px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background106.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:68.09px;top:46.83px" class="cls_007"><span class="cls_007">addToStore</span><span class="cls_004">(fso, refs, name) :</span></div>
<div style="position:absolute;left:83.03px;top:58.79px" class="cls_004"><span class="cls_004">c ← </span><span class="cls_007">serialise</span><span class="cls_004">(fso)</span></div>
<div style="position:absolute;left:83.03px;top:70.74px" class="cls_004"><span class="cls_004">h ← </span><span class="cls_007">hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(c)</span></div>
<div style="position:absolute;left:83.78px;top:82.70px" class="cls_004"><span class="cls_004">p ← </span><span class="cls_007">makePath</span><span class="cls_004">(</span><span class="cls_007">"source"</span><span class="cls_004">, </span><span class="cls_007">printHash</span><span class="cls_012"><sub>16</sub></span><span class="cls_004">(h), name)</span></div>
<div style="position:absolute;left:280.41px;top:84.69px" class="cls_056"><span class="cls_056">45</span></div>
<div style="position:absolute;left:83.03px;top:94.65px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> valid</span><span class="cls_004">[p] = ε :</span></div>
<div style="position:absolute;left:149.24px;top:96.65px" class="cls_056"><span class="cls_056">46</span></div>
<div style="position:absolute;left:97.97px;top:106.61px" class="cls_004"><span class="cls_004">lock ←</span><span class="cls_007"> acquirePathLock</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:97.97px;top:118.56px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> valid</span><span class="cls_004">[p] = ε :</span></div>
<div style="position:absolute;left:164.18px;top:120.56px" class="cls_056"><span class="cls_056">47</span></div>
<div style="position:absolute;left:112.92px;top:130.52px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> pathExists</span><span class="cls_004">(p) :</span></div>
<div style="position:absolute;left:127.86px;top:142.47px" class="cls_007"><span class="cls_007">deletePath</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:112.92px;top:154.53px" class="cls_007"><span class="cls_007">writePath</span><span class="cls_004">(p, fso)</span><span class="cls_014"> </span><span class="cls_056">48</span></div>
<div style="position:absolute;left:112.92px;top:166.48px" class="cls_004"><span class="cls_004">in a database transaction :</span></div>
<div style="position:absolute;left:221.39px;top:168.48px" class="cls_056"><span class="cls_056">49</span></div>
<div style="position:absolute;left:127.86px;top:178.44px" class="cls_007"><span class="cls_007">valid</span><span class="cls_004">[p] ← h</span></div>
<div style="position:absolute;left:127.86px;top:190.39px" class="cls_007"><span class="cls_007">setReferences</span><span class="cls_004">(p, refs)</span></div>
<div style="position:absolute;left:97.97px;top:202.35px" class="cls_007"><span class="cls_007">releasePathLock</span><span class="cls_004">(p, lock)</span></div>
<div style="position:absolute;left:83.03px;top:214.30px" class="cls_004"><span class="cls_004">return p</span></div>
<div style="position:absolute;left:68.09px;top:238.21px" class="cls_007"><span class="cls_007">setReferences</span><span class="cls_004">(p, refs)</span><span class="cls_014"> </span><span class="cls_056">50</span></div>
<div style="position:absolute;left:83.03px;top:250.17px" class="cls_007"><span class="cls_007">references</span><span class="cls_004">[p] ← refs</span></div>
<div style="position:absolute;left:83.03px;top:261.10px" class="cls_004"><span class="cls_004">for each p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ∈ refs :</span></div>
<div style="position:absolute;left:147.11px;top:273.33px" class="cls_012"><span class="cls_012">∪</span></div>
<div style="position:absolute;left:97.97px;top:275.35px" class="cls_007"><span class="cls_007">referers</span><span class="cls_004">[p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">]</span></div>
<div style="position:absolute;left:144.58px;top:276.38px" class="cls_004"><span class="cls_004">← {p}</span></div>
<div style="position:absolute;left:128.51px;top:301.07px" class="cls_004"><span class="cls_004">Figure 5.3.:</span><span class="cls_007"> addToStore</span><span class="cls_004">: Adding atoms to the Nix store</span></div>
<div style="position:absolute;left:59.72px;top:333.44px" class="cls_004"><span class="cls_004">Section 5.4).  This is in fact the defining characteristic of the extensional model.</span></div>
<div style="position:absolute;left:394.18px;top:333.44px" class="cls_004"><span class="cls_004">In the</span></div>
<div style="position:absolute;left:59.72px;top:345.40px" class="cls_004"><span class="cls_004">intensional model described in Chapter 6, content-addressability is extended to all store</span></div>
<div style="position:absolute;left:59.72px;top:357.35px" class="cls_004"><span class="cls_004">objects.</span></div>
<div style="position:absolute;left:59.72px;top:384.78px" class="cls_009"><span class="cls_009">Concurrency</span><span class="cls_004">   We have to take into account the remote possibility that parallel Nix pro-</span></div>
<div style="position:absolute;left:59.72px;top:396.74px" class="cls_004"><span class="cls_004">cesses simultaneously try to add the same atom. If this happens, the operations should be</span></div>
<div style="position:absolute;left:59.72px;top:408.70px" class="cls_004"><span class="cls_004">idempotent, and the contents of a path should never change after it has been marked as</span></div>
<div style="position:absolute;left:59.72px;top:420.65px" class="cls_004"><span class="cls_004">valid. There should be no race conditions, e.g.:</span></div>
<div style="position:absolute;left:72.17px;top:441.07px" class="cls_004"><span class="cls_004">1. Process A detects that the target path p is invalid, and starts writing the atom to p.</span></div>
<div style="position:absolute;left:72.17px;top:461.66px" class="cls_004"><span class="cls_004">2. Process B detects that p is invalid, and wants to write the atom to the target path, but</span></div>
<div style="position:absolute;left:84.62px;top:473.61px" class="cls_004"><span class="cls_004">there is an obstructing file at p. As it cannot make assumptions about invalid paths,</span></div>
<div style="position:absolute;left:84.62px;top:485.57px" class="cls_004"><span class="cls_004">it deletes p and starts writing the atom to p.</span></div>
<div style="position:absolute;left:72.17px;top:506.15px" class="cls_004"><span class="cls_004">3. While B is half-way through, A finishes writing and marks the path as valid. Note</span></div>
<div style="position:absolute;left:84.62px;top:518.11px" class="cls_004"><span class="cls_004">that some of A’s writes have been deleted.</span></div>
<div style="position:absolute;left:72.17px;top:538.69px" class="cls_004"><span class="cls_004">4. Before B finishes writing, A starts the builder of a derivation that has p as input. The</span></div>
<div style="position:absolute;left:84.62px;top:550.65px" class="cls_004"><span class="cls_004">builder uses the incorrect contents of p.</span></div>
<div style="position:absolute;left:69.68px;top:571.07px" class="cls_004"><span class="cls_004">There are several solutions to prevent races. The simplest one is to use a global mutex</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">lock on the Nix store for all operations that modify the store.  These operations are the</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">98</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:71760px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background107.jpg" width=481 height=680></div>
<div style="position:absolute;left:375.68px;top:17.14px" class="cls_004"><span class="cls_004">5.3. Atoms</span></div>
<div style="position:absolute;left:72.24px;top:46.83px" class="cls_007"><span class="cls_007">acquirePathLock</span><span class="cls_004">(p) :</span></div>
<div style="position:absolute;left:82.21px;top:58.79px" class="cls_004"><span class="cls_004">while true:</span></div>
<div style="position:absolute;left:92.17px;top:70.74px" class="cls_004"><span class="cls_004">fd ←</span><span class="cls_007"> open</span><span class="cls_004">(p +</span><span class="cls_007"> ".lock"</span><span class="cls_004">,</span><span class="cls_007"> O_WRONLY</span><span class="cls_004">|</span><span class="cls_007">O_CREAT</span><span class="cls_004">, 0666)</span></div>
<div style="position:absolute;left:92.17px;top:82.70px" class="cls_007"><span class="cls_007">fcntl</span><span class="cls_004">(fd,</span><span class="cls_007"> F_SETLKW</span><span class="cls_004">, ...</span><span class="cls_007">F_WRLCK</span><span class="cls_004">...)</span><span class="cls_014"> </span><span class="cls_056">51</span></div>
<div style="position:absolute;left:92.17px;top:94.65px" class="cls_004"><span class="cls_004">if size of file fd = 0 :</span></div>
<div style="position:absolute;left:180.45px;top:96.65px" class="cls_056"><span class="cls_056">52</span></div>
<div style="position:absolute;left:102.13px;top:106.61px" class="cls_004"><span class="cls_004">return fd</span><span class="cls_014"> </span><span class="cls_056">53</span></div>
<div style="position:absolute;left:92.17px;top:118.56px" class="cls_007"><span class="cls_007">close</span><span class="cls_004">(fd)</span></div>
<div style="position:absolute;left:72.24px;top:142.47px" class="cls_007"><span class="cls_007">releasePathLock</span><span class="cls_004">(p, fd) :</span></div>
<div style="position:absolute;left:92.17px;top:154.43px" class="cls_007"><span class="cls_007">deleteAndSignal</span><span class="cls_004">(p +</span><span class="cls_007"> ".lock"</span><span class="cls_004">, fd)</span></div>
<div style="position:absolute;left:72.24px;top:178.34px" class="cls_007"><span class="cls_007">deleteAndSignal</span><span class="cls_004">(p, fd) :</span></div>
<div style="position:absolute;left:92.17px;top:190.29px" class="cls_007"><span class="cls_007">deletePath</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:92.17px;top:202.25px" class="cls_007"><span class="cls_007">write</span><span class="cls_004">(fd,</span><span class="cls_007"> "deleted"</span><span class="cls_004">)</span><span class="cls_014"> </span><span class="cls_056">54</span></div>
<div style="position:absolute;left:92.17px;top:214.21px" class="cls_007"><span class="cls_007">close</span><span class="cls_004">(fd)</span><span class="cls_014"> </span><span class="cls_056">55</span></div>
<div style="position:absolute;left:105.78px;top:238.89px" class="cls_004"><span class="cls_004">Figure 5.4.:</span><span class="cls_007"> acquirePathLock</span><span class="cls_004"> and</span><span class="cls_007"> releasePathLock</span><span class="cls_004">: Locking on Unix</span></div>
<div style="position:absolute;left:63.87px;top:271.46px" class="cls_004"><span class="cls_004">addition of atoms, the building of derivations (Section 5.5), and garbage collection (Sec-</span></div>
<div style="position:absolute;left:63.87px;top:283.42px" class="cls_004"><span class="cls_004">tion 5.6). Every Nix process acquires the lock on startup, and releases it when finished.</span></div>
<div style="position:absolute;left:63.87px;top:295.37px" class="cls_004"><span class="cls_004">If the lock is already held, processes block until it becomes available. This approach is</span></div>
<div style="position:absolute;left:63.87px;top:307.33px" class="cls_004"><span class="cls_004">clearly unacceptable because of the unbounded latency it introduces for Nix operations.</span></div>
<div style="position:absolute;left:73.84px;top:319.54px" class="cls_004"><span class="cls_004">A better solution is fine-grained locking, where a process acquires a mutex lock on the</span></div>
<div style="position:absolute;left:63.87px;top:331.50px" class="cls_004"><span class="cls_004">specific store path that it wants to add. The locking operations lock ←</span><span class="cls_007"> acquirePathLock</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:63.87px;top:343.45px" class="cls_004"><span class="cls_004">and</span><span class="cls_007"> releasePathLock</span><span class="cls_004">(p, lock) essentially acquire and release a lock on a temporary file</span></div>
<div style="position:absolute;left:64.62px;top:355.41px" class="cls_004"><span class="cls_004">p</span><span class="cls_007">.lock</span><span class="cls_004">, i.e., p with the extension</span><span class="cls_007"> .lock</span><span class="cls_004"> appended.</span></div>
<div style="position:absolute;left:73.84px;top:367.63px" class="cls_004"><span class="cls_004">Figure 5.4 shows pseudo-code for an implementation of these operations on Unix.  It</span></div>
<div style="position:absolute;left:63.87px;top:379.58px" class="cls_004"><span class="cls_004">uses the POSIX standard system call</span><span class="cls_007"> fcntl</span><span class="cls_004">, which locks byte ranges in files [152].  The</span></div>
<div style="position:absolute;left:63.87px;top:391.54px" class="cls_004"><span class="cls_004">advantage of POSIX locks is that they are released automatically when the process holding</span></div>
<div style="position:absolute;left:63.87px;top:403.49px" class="cls_004"><span class="cls_004">them dies, either normally or abnormally. In contrast, the use of file existence as a mutex</span></div>
<div style="position:absolute;left:63.87px;top:415.45px" class="cls_004"><span class="cls_004">makes it harder to recover gracefully from abnormal termination and system crashes.</span></div>
<div style="position:absolute;left:73.84px;top:427.66px" class="cls_004"><span class="cls_004">A mostly aesthetic complication is that we don’t want the lock files to hang around</span></div>
<div style="position:absolute;left:63.87px;top:439.62px" class="cls_004"><span class="cls_004">indefinitely.  They should be removed when they are no longer necessary, i.e., when p</span></div>
<div style="position:absolute;left:63.87px;top:451.57px" class="cls_004"><span class="cls_004">has been registered as being valid. Deleting the lock file after we have released the lock</span></div>
<div style="position:absolute;left:63.87px;top:463.53px" class="cls_004"><span class="cls_004">introduces a subtle race, however:</span></div>
<div style="position:absolute;left:76.33px;top:484.24px" class="cls_004"><span class="cls_004">1. Process A creates the lock file p</span><span class="cls_007">.lock</span><span class="cls_004"> and locks it.</span></div>
<div style="position:absolute;left:76.33px;top:505.21px" class="cls_004"><span class="cls_004">2. Process B opens the lock file, attempts to acquire a lock, and blocks.</span></div>
<div style="position:absolute;left:76.33px;top:526.18px" class="cls_004"><span class="cls_004">3. Process A sees that p is invalid, and begins to write to p. However, it is interrupted</span></div>
<div style="position:absolute;left:88.78px;top:538.14px" class="cls_004"><span class="cls_004">before it can make p valid.</span></div>
<div style="position:absolute;left:76.33px;top:559.11px" class="cls_004"><span class="cls_004">4. As part of its cleanup, process A releases the lock, closes and deletes the lock file,</span></div>
<div style="position:absolute;left:88.78px;top:571.07px" class="cls_004"><span class="cls_004">and terminates. Note that B still has the file open; on Unix it is possible to delete</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_004"><span class="cls_004">open files.</span></div>
<div style="position:absolute;left:412.21px;top:624.87px" class="cls_004"><span class="cls_004">99</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:72450px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background108.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:72.17px;top:45.04px" class="cls_004"><span class="cls_004">5. Process B acquires the lock.</span></div>
<div style="position:absolute;left:72.17px;top:66.43px" class="cls_004"><span class="cls_004">6. Process B sees that p is invalid, and begins to write to it.</span></div>
<div style="position:absolute;left:72.17px;top:87.82px" class="cls_004"><span class="cls_004">7. Process C creates the lock file p</span><span class="cls_007">.lock</span><span class="cls_004"> and locks it. This is a different file than the one</span></div>
<div style="position:absolute;left:84.62px;top:99.77px" class="cls_004"><span class="cls_004">currently opened by B—it has a different inode number. Thus C can acquire a lock.</span></div>
<div style="position:absolute;left:72.17px;top:121.16px" class="cls_004"><span class="cls_004">8. Process C sees that p is invalid, and begins to write to it.</span></div>
<div style="position:absolute;left:72.17px;top:142.55px" class="cls_004"><span class="cls_004">9. Now processes B and C are concurrently writing to p.</span></div>
<div style="position:absolute;left:69.68px;top:163.57px" class="cls_004"><span class="cls_004">To prevent this race, we have to signal to process B that the lock file it has open has</span></div>
<div style="position:absolute;left:59.72px;top:175.53px" class="cls_004"><span class="cls_004">become “stale”, and that it should restart. This is done by the function</span><span class="cls_007"> deleteAndSignal</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:59.72px;top:187.48px" class="cls_004"><span class="cls_004">called by the deleting process: it writes an arbitrary string (the deletion token) to the deleted</span></div>
<div style="position:absolute;left:59.72px;top:199.44px" class="cls_004"><span class="cls_004">file</span><span class="cls_014"> </span><span class="cls_056">54</span><span class="cls_059"> </span><span class="cls_004">. If another process subsequently acquires a lock</span><span class="cls_014"> </span><span class="cls_056">51</span><span class="cls_059"> </span><span class="cls_004">, but sees that the size of the file</span></div>
<div style="position:absolute;left:59.72px;top:211.39px" class="cls_004"><span class="cls_004">is non-zero</span><span class="cls_014"> </span><span class="cls_056">52</span><span class="cls_059"> </span><span class="cls_004">, then it knows that its lock is stale.</span></div>
<div style="position:absolute;left:69.68px;top:223.72px" class="cls_004"><span class="cls_004">On Windows, there is a much simpler solution: we just try to delete the file, which will</span></div>
<div style="position:absolute;left:59.72px;top:235.67px" class="cls_004"><span class="cls_004">fail if it is currently opened by any other process. Thus, the file will be deleted by the last</span></div>
<div style="position:absolute;left:59.72px;top:247.63px" class="cls_004"><span class="cls_004">process to release the lock, provided no new lockers have opened the lock file.</span></div>
<div style="position:absolute;left:69.68px;top:259.95px" class="cls_004"><span class="cls_004">The dual checks for path validity are an optimisation (</span><span class="cls_056"> 46</span><span class="cls_059"> </span><span class="cls_004">,</span><span class="cls_014"> </span><span class="cls_056">47</span><span class="cls_059"> </span><span class="cls_004">). Strictly speaking, the</span></div>
<div style="position:absolute;left:59.72px;top:271.90px" class="cls_004"><span class="cls_004">initial path validity check</span><span class="cls_014"> </span><span class="cls_056">46</span><span class="cls_059"> </span><span class="cls_004"> can be omitted.  However, the extra check prevents a lock</span></div>
<div style="position:absolute;left:59.72px;top:283.86px" class="cls_004"><span class="cls_004">creation and acquisition in the common case where the path is already valid.</span></div>
<div style="position:absolute;left:59.72px;top:316.54px" class="cls_011"><span class="cls_011">5.4. Translating Nix expressions to store derivations</span></div>
<div style="position:absolute;left:59.72px;top:342.46px" class="cls_004"><span class="cls_004">Nix does most of its work on store derivations, introduced in Section 2.4. Store derivations</span></div>
<div style="position:absolute;left:59.72px;top:354.41px" class="cls_004"><span class="cls_004">are the result of the evaluation of high-level Nix expressions. Nix expressions can express</span></div>
<div style="position:absolute;left:59.72px;top:366.37px" class="cls_004"><span class="cls_004">variability, store derivations cannot—a store derivation encodes a single, specific, constant</span></div>
<div style="position:absolute;left:59.72px;top:378.32px" class="cls_004"><span class="cls_004">build action.</span></div>
<div style="position:absolute;left:69.68px;top:390.64px" class="cls_004"><span class="cls_004">The command</span><span class="cls_007"> nix-instantiate</span><span class="cls_004"> performs precisely this translation: it takes a Nix expres-</span></div>
<div style="position:absolute;left:59.72px;top:402.60px" class="cls_004"><span class="cls_004">sion and evaluates it to normal formal using the expression semantics presented in Sec-</span></div>
<div style="position:absolute;left:59.72px;top:414.55px" class="cls_004"><span class="cls_004">tion 4.3.4. The normal form should be a call to</span><span class="cls_007"> derivation</span><span class="cls_004">, or a nested structure of lists and</span></div>
<div style="position:absolute;left:59.72px;top:426.51px" class="cls_004"><span class="cls_004">attribute sets that contain calls to</span><span class="cls_007"> derivation</span><span class="cls_004">. In any case, these</span><span class="cls_007"> derivation</span><span class="cls_004"> Nix expressions</span></div>
<div style="position:absolute;left:59.72px;top:438.46px" class="cls_004"><span class="cls_004">are subsequently translated to store derivations using the method described in this section.</span></div>
<div style="position:absolute;left:69.68px;top:450.78px" class="cls_004"><span class="cls_004">The resulting store derivations can then be built, as described in the next section. The</span></div>
<div style="position:absolute;left:59.72px;top:462.74px" class="cls_004"><span class="cls_004">command</span><span class="cls_007"> nix-store --realise</span><span class="cls_004"> does exactly that. The high-level package management com-</span></div>
<div style="position:absolute;left:59.72px;top:474.69px" class="cls_004"><span class="cls_004">mand</span><span class="cls_007"> nix-env</span><span class="cls_004"> combines translation and building as a convenience to users.</span></div>
<div style="position:absolute;left:69.68px;top:487.01px" class="cls_004"><span class="cls_004">The abstract syntax of store derivations is shown in Figure 5.5 in a Haskell-like [135]</span></div>
<div style="position:absolute;left:59.72px;top:498.97px" class="cls_004"><span class="cls_004">syntax (see Section 1.7).  The store derivation example shown in Figure 2.13 is a value</span></div>
<div style="position:absolute;left:59.72px;top:510.92px" class="cls_004"><span class="cls_004">of this data type. The</span><span class="cls_007"> outputHash</span><span class="cls_004"> and</span><span class="cls_007"> outputHashAlgo</span><span class="cls_004"> fields implement so-called fixed-</span></div>
<div style="position:absolute;left:59.72px;top:522.88px" class="cls_004"><span class="cls_004">output derivations and are discussed in Section 5.4.1. The other fields were explained in</span></div>
<div style="position:absolute;left:59.72px;top:534.84px" class="cls_004"><span class="cls_004">Section 2.4.</span></div>
<div style="position:absolute;left:69.68px;top:546.13px" class="cls_004"><span class="cls_004">So suppose that we have an expression e that evaluates to</span><span class="cls_007"> derivation</span><span class="cls_004"> e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, and e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> evaluates</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">to an attribute set {as}. According to the D</span><span class="cls_014">ERIVATION</span><span class="cls_004"> and D</span><span class="cls_014">ERIVATION</span><span class="cls_004">! rules (page 80),</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">e then (essentially) evaluates to the result of calling</span><span class="cls_007"> instantiate</span><span class="cls_004">(as).</span><span class="cls_007"> instantiate</span><span class="cls_004"> is a function</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">that translates the argument attribute set of a call to</span><span class="cls_007"> derivation</span><span class="cls_004"> to a store derivation, writes</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">100</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:73140px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background109.jpg" width=481 height=680></div>
<div style="position:absolute;left:212.59px;top:17.14px" class="cls_004"><span class="cls_004">5.4. Translating Nix expressions to store derivations</span></div>
<div style="position:absolute;left:72.24px;top:46.83px" class="cls_004"><span class="cls_004">data</span><span class="cls_007"> StoreDrv</span><span class="cls_004"> =</span><span class="cls_007"> StoreDrv</span><span class="cls_004"> {</span></div>
<div style="position:absolute;left:87.19px;top:58.79px" class="cls_007"><span class="cls_007">output</span><span class="cls_004"> :</span><span class="cls_007"> Path</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:87.19px;top:70.74px" class="cls_007"><span class="cls_007">outputHash</span><span class="cls_004"> :</span><span class="cls_007"> String</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:87.19px;top:82.70px" class="cls_007"><span class="cls_007">outputHashAlgo</span><span class="cls_004"> :</span><span class="cls_007"> String</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:87.19px;top:94.65px" class="cls_007"><span class="cls_007">inputDrvs</span><span class="cls_004"> : [</span><span class="cls_007">Path</span><span class="cls_004">],</span></div>
<div style="position:absolute;left:87.19px;top:106.61px" class="cls_007"><span class="cls_007">inputSrcs</span><span class="cls_004"> : [</span><span class="cls_007">Path</span><span class="cls_004">],</span></div>
<div style="position:absolute;left:87.19px;top:118.56px" class="cls_007"><span class="cls_007">system</span><span class="cls_004"> :</span><span class="cls_007"> String</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:87.19px;top:130.52px" class="cls_007"><span class="cls_007">builder</span><span class="cls_004"> :</span><span class="cls_007"> Path</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:87.19px;top:142.47px" class="cls_007"><span class="cls_007">args</span><span class="cls_004"> : [</span><span class="cls_007">String</span><span class="cls_004">],</span></div>
<div style="position:absolute;left:87.19px;top:154.43px" class="cls_007"><span class="cls_007">envVars</span><span class="cls_004"> : [(</span><span class="cls_007">String</span><span class="cls_004">,</span><span class="cls_007"> String</span><span class="cls_004">)]</span></div>
<div style="position:absolute;left:72.24px;top:166.38px" class="cls_004"><span class="cls_004">}</span></div>
<div style="position:absolute;left:148.09px;top:191.07px" class="cls_004"><span class="cls_004">Figure 5.5.: Abstract syntax of store derivations</span></div>
<div style="position:absolute;left:63.87px;top:222.10px" class="cls_004"><span class="cls_004">as a side-effect the store derivation to the Nix store</span><span class="cls_012"><sup>5</sup></span><span class="cls_004">, and returns the original attribute set,</span></div>
<div style="position:absolute;left:63.87px;top:235.08px" class="cls_004"><span class="cls_004">with the following three attributes added:</span></div>
<div style="position:absolute;left:78.82px;top:255.02px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> drvPath</span><span class="cls_004"> contains the path of the store derivation.</span></div>
<div style="position:absolute;left:78.82px;top:274.96px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> outPath</span><span class="cls_004"> contains the output path of the store derivation, that is, d.</span><span class="cls_007">output</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:78.82px;top:294.90px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> type</span><span class="cls_004"> is set to the value</span><span class="cls_007"> "derivation"</span><span class="cls_004">. This allows</span><span class="cls_007"> instantiate</span><span class="cls_004"> to detect that attribute sets</span></div>
<div style="position:absolute;left:88.78px;top:306.86px" class="cls_004"><span class="cls_004">occurring in its arguments are actually subderivations. It also allows</span><span class="cls_007"> nix-instantiate</span></div>
<div style="position:absolute;left:88.78px;top:318.81px" class="cls_004"><span class="cls_004">and</span><span class="cls_007"> nix-env</span><span class="cls_004"> to see whether evaluation results are actually derivations.</span></div>
<div style="position:absolute;left:73.84px;top:338.75px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> instantiate</span><span class="cls_004"> is shown in Figure 5.6.  Its main job is to construct a store</span></div>
<div style="position:absolute;left:63.87px;top:350.71px" class="cls_004"><span class="cls_004">derivation</span><span class="cls_014"> </span><span class="cls_056">56</span><span class="cls_004"> which is written to the Nix store using</span><span class="cls_007"> addToStore</span><span class="cls_014"> </span><span class="cls_056">65</span><span class="cls_059"> </span><span class="cls_004">. The hard part is in</span></div>
<div style="position:absolute;left:63.87px;top:362.66px" class="cls_004"><span class="cls_004">filling in the fields of the store derivation from the attributes as. In particular, we need to</span></div>
<div style="position:absolute;left:63.87px;top:374.62px" class="cls_004"><span class="cls_004">compute the following bits of information:</span></div>
<div style="position:absolute;left:78.82px;top:394.56px" class="cls_004"><span class="cls_004">• We need an output path (the field</span><span class="cls_007"> output</span><span class="cls_004">). The output path reflects all information</span></div>
<div style="position:absolute;left:88.78px;top:406.51px" class="cls_004"><span class="cls_004">that goes into the derivation.  Therefore we initially leave</span><span class="cls_007"> output</span><span class="cls_004"> empty</span><span class="cls_014"> </span><span class="cls_056">57</span><span class="cls_059"> </span><span class="cls_004">, then</span></div>
<div style="position:absolute;left:88.78px;top:418.47px" class="cls_004"><span class="cls_004">compute a cryptographic hash over this initial derivation and use</span><span class="cls_007"> makePath</span><span class="cls_004"> to con-</span></div>
<div style="position:absolute;left:88.78px;top:430.42px" class="cls_004"><span class="cls_004">struct the actual path</span><span class="cls_014"> </span><span class="cls_056">64</span><span class="cls_059"> </span><span class="cls_004">. The hash is computed using the function</span><span class="cls_007"> hashDrv</span><span class="cls_004">, which</span></div>
<div style="position:absolute;left:88.78px;top:442.38px" class="cls_004"><span class="cls_004">conceptually just computes a SHA-256 hash over a concrete syntax representation</span></div>
<div style="position:absolute;left:88.78px;top:454.33px" class="cls_004"><span class="cls_004">of the store derivation. However, the notion of fixed-output derivations complicates</span></div>
<div style="position:absolute;left:88.78px;top:466.29px" class="cls_004"><span class="cls_004">matters a bit. The actual operation of</span><span class="cls_007"> hashDrv</span><span class="cls_004"> is discussed below. The final output</span></div>
<div style="position:absolute;left:88.78px;top:478.24px" class="cls_004"><span class="cls_004">path is also placed in the</span><span class="cls_007"> out</span><span class="cls_004"> environment variable, in order to communicate the path</span></div>
<div style="position:absolute;left:88.78px;top:490.20px" class="cls_004"><span class="cls_004">to the builder.</span></div>
<div style="position:absolute;left:78.82px;top:510.14px" class="cls_004"><span class="cls_004">• We need to compute the environment variable bindings</span><span class="cls_007"> envVars</span><span class="cls_014"> </span><span class="cls_056">63</span><span class="cls_059"> </span><span class="cls_004">.</span><span class="cls_007"> envVars</span><span class="cls_004"> is a set</span></div>
<div style="position:absolute;left:88.78px;top:522.10px" class="cls_004"><span class="cls_004">of name/value tuples. Each attribute </span><span class="cls_037">〈</span><span class="cls_004">n = e</span><span class="cls_037">〉</span><span class="cls_004"> in {as} is mapped to an environment</span></div>
<div style="position:absolute;left:88.78px;top:534.05px" class="cls_004"><span class="cls_004">variable binding. This translation is done by the function</span><span class="cls_007"> processBinding</span><span class="cls_004"> shown in</span></div>
<div style="position:absolute;left:88.78px;top:546.01px" class="cls_004"><span class="cls_004">Figure 5.7.  It takes e and returns, among other things, a string representation of</span></div>
<div style="position:absolute;left:68.36px;top:565.18px" class="cls_013"><span class="cls_013"><sup>5</sup></span><span class="cls_014">Aficionados of purely functional programming languages may be dismayed by the impurity of producing a</span></div>
<div style="position:absolute;left:75.83px;top:575.55px" class="cls_014"><span class="cls_014">store derivation as a side-effect. However, the side-effect is not observable in the Nix expression evaluation,</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">and the idempotency of the operation ensures that equational reasoning still holds.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">101</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:73830px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background110.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:68.09px;top:46.83px" class="cls_007"><span class="cls_007">instantiate</span><span class="cls_004">(as) :</span></div>
<div style="position:absolute;left:83.03px;top:58.79px" class="cls_004"><span class="cls_004">name ←</span><span class="cls_007"> eval</span><span class="cls_004">(as.</span><span class="cls_007">name</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:83.03px;top:70.74px" class="cls_004"><span class="cls_004">if name ends in</span><span class="cls_007"> ".drv"</span><span class="cls_004"> : abort</span></div>
<div style="position:absolute;left:83.03px;top:82.70px" class="cls_004"><span class="cls_004">if name contains invalid characters : abort</span></div>
<div style="position:absolute;left:83.03px;top:94.65px" class="cls_004"><span class="cls_004">d ← </span><span class="cls_007">StoreDrv </span><span class="cls_004">{</span><span class="cls_014"> </span><span class="cls_056">56</span></div>
<div style="position:absolute;left:97.97px;top:106.61px" class="cls_007"><span class="cls_007">output</span><span class="cls_004"> =</span><span class="cls_007"> ""</span><span class="cls_014"> </span><span class="cls_056">57</span></div>
<div style="position:absolute;left:97.97px;top:118.56px" class="cls_007"><span class="cls_007">outputHash</span><span class="cls_004"> =</span><span class="cls_007"> eval</span><span class="cls_004">(as.</span><span class="cls_007">outputHash</span><span class="cls_004">) if attr. exists,</span><span class="cls_007">  ""</span><span class="cls_004"> otherwise</span></div>
<div style="position:absolute;left:97.97px;top:130.52px" class="cls_007"><span class="cls_007">outputHashAlgo</span><span class="cls_004"> =</span><span class="cls_007"> ""</span><span class="cls_014"> </span><span class="cls_056">58</span></div>
<div style="position:absolute;left:112.92px;top:142.47px" class="cls_004"><span class="cls_004">(</span><span class="cls_007">"r:"</span><span class="cls_004"> if</span><span class="cls_007"> eval</span><span class="cls_004">(as.</span><span class="cls_007">outputHashMode</span><span class="cls_004">) =</span><span class="cls_007"> "recursive"</span><span class="cls_004">,</span><span class="cls_007"> ""</span><span class="cls_004"> otherwise) +</span></div>
<div style="position:absolute;left:112.92px;top:154.43px" class="cls_004"><span class="cls_004">(</span><span class="cls_007">eval</span><span class="cls_004">(as.</span><span class="cls_007">outputHashAlgo</span><span class="cls_004">) if attr. exists,</span><span class="cls_007">  ""</span><span class="cls_004"> otherwise)</span></div>
<div style="position:absolute;left:97.97px;top:166.38px" class="cls_007"><span class="cls_007">inputDrvs</span><span class="cls_004"> = {</span><span class="cls_007">processBinding</span><span class="cls_004">(e).</span><span class="cls_007">drvs</span><span class="cls_004"> | </span><span class="cls_037">〈</span><span class="cls_004">n = e</span><span class="cls_037">〉</span><span class="cls_004"> ∈ as}</span><span class="cls_014"> </span><span class="cls_056">59</span></div>
<div style="position:absolute;left:97.97px;top:178.34px" class="cls_007"><span class="cls_007">inputSrcs</span><span class="cls_004"> = {</span><span class="cls_007">processBinding</span><span class="cls_004">(e).</span><span class="cls_007">srcs</span><span class="cls_004"> | </span><span class="cls_037">〈</span><span class="cls_004">n = e</span><span class="cls_037">〉</span><span class="cls_004"> ∈ as}</span><span class="cls_014"> </span><span class="cls_056">60</span></div>
<div style="position:absolute;left:97.97px;top:190.29px" class="cls_007"><span class="cls_007">system</span><span class="cls_004"> =</span><span class="cls_007"> eval</span><span class="cls_004">(as.</span><span class="cls_007">system</span><span class="cls_004">) // Must evaluate to a string.</span></div>
<div style="position:absolute;left:97.97px;top:202.25px" class="cls_007"><span class="cls_007">builder</span><span class="cls_004"> =</span><span class="cls_007"> concSp</span><span class="cls_004">(</span><span class="cls_007">processBinding</span><span class="cls_004">(as.</span><span class="cls_007">builder</span><span class="cls_004">).</span><span class="cls_007">res</span><span class="cls_004">)</span><span class="cls_014"> </span><span class="cls_056">61</span></div>
<div style="position:absolute;left:97.97px;top:214.21px" class="cls_007"><span class="cls_007">args</span><span class="cls_004"> =</span><span class="cls_007"> map</span><span class="cls_004">(λ e .</span><span class="cls_007"> processBinding</span><span class="cls_004">(e).</span><span class="cls_007">res</span><span class="cls_004">, as.</span><span class="cls_007">args</span><span class="cls_004">)</span><span class="cls_014"> </span><span class="cls_056">62</span></div>
<div style="position:absolute;left:97.97px;top:226.16px" class="cls_007"><span class="cls_007">envVars</span><span class="cls_004"> = {(n,</span><span class="cls_007"> concSp</span><span class="cls_004">(</span><span class="cls_007">processBinding</span><span class="cls_004">(e).</span><span class="cls_007">res</span><span class="cls_004">)) | </span><span class="cls_037">〈</span><span class="cls_004">n = e</span><span class="cls_037">〉</span><span class="cls_004"> ∈ as}</span><span class="cls_014"> </span><span class="cls_056">63</span></div>
<div style="position:absolute;left:107.94px;top:238.12px" class="cls_004"><span class="cls_004">∪ {(</span><span class="cls_007">out</span><span class="cls_004">,</span><span class="cls_007"> ""</span><span class="cls_004">)}</span></div>
<div style="position:absolute;left:83.03px;top:250.07px" class="cls_004"><span class="cls_004">}</span></div>
<div style="position:absolute;left:83.03px;top:262.03px" class="cls_004"><span class="cls_004">d.</span><span class="cls_007">output</span><span class="cls_004"> ←</span><span class="cls_007"> makePath</span><span class="cls_004">(</span><span class="cls_007">"output:out"</span><span class="cls_004">,</span><span class="cls_007"> hashDrv</span><span class="cls_004">(d), name)</span><span class="cls_014"> </span><span class="cls_056">64</span></div>
<div style="position:absolute;left:83.03px;top:273.98px" class="cls_004"><span class="cls_004">d.envVars[</span><span class="cls_007">"out"</span><span class="cls_004">] ← d.</span><span class="cls_007">output</span></div>
<div style="position:absolute;left:83.78px;top:285.94px" class="cls_004"><span class="cls_004">p ← </span><span class="cls_007">addToStore</span><span class="cls_004">(</span><span class="cls_007">printDrv</span><span class="cls_004">(d), d.</span><span class="cls_007">inputDrvs</span><span class="cls_004"> ∪ d.</span><span class="cls_007">inputSrcs</span><span class="cls_004">, name+</span><span class="cls_007">".drv"</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:376.96px;top:287.93px" class="cls_056"><span class="cls_056">65</span></div>
<div style="position:absolute;left:83.03px;top:297.89px" class="cls_004"><span class="cls_004">return {</span><span class="cls_007">outPath</span><span class="cls_004"> = d.</span><span class="cls_007">output</span><span class="cls_004">,</span><span class="cls_007"> drvPath</span><span class="cls_004"> = p}</span></div>
<div style="position:absolute;left:81.21px;top:322.58px" class="cls_004"><span class="cls_004">Figure 5.6.:</span><span class="cls_007"> instantiate</span><span class="cls_004">: Instantiation of store derivations from a Nix expression</span></div>
<div style="position:absolute;left:84.62px;top:355.55px" class="cls_004"><span class="cls_004">the normal form of e.</span><span class="cls_007"> processBinding</span><span class="cls_004"> is discussed in more detail below. However, it</span></div>
<div style="position:absolute;left:84.62px;top:367.51px" class="cls_004"><span class="cls_004">should be pointed out here that</span><span class="cls_007"> processBinding</span><span class="cls_004"> returns a list of strings, since attribute</span></div>
<div style="position:absolute;left:84.62px;top:379.46px" class="cls_004"><span class="cls_004">values can be lists of values. For instance, it is common to communicate a list of</span></div>
<div style="position:absolute;left:84.62px;top:391.42px" class="cls_004"><span class="cls_004">paths of components to a builder:</span></div>
<div style="position:absolute;left:106.54px;top:417.46px" class="cls_015"><span class="cls_015">buildInputs  =  [libxml2  openssl  zlib];</span></div>
<div style="position:absolute;left:84.62px;top:433.99px" class="cls_004"><span class="cls_004">Since  the  value  of  an  environment  variable  is  a  plain  string,  the  list  of</span></div>
<div style="position:absolute;left:84.62px;top:445.94px" class="cls_004"><span class="cls_004">strings returned by</span><span class="cls_007"> processBinding</span><span class="cls_004"> is concatenated with spaces separating the el-</span></div>
<div style="position:absolute;left:84.62px;top:457.90px" class="cls_004"><span class="cls_004">ements;  e.g.,</span><span class="cls_007"> "/nix/store/ngp50703j8qn...-libxml2-2.6.17</span><span class="cls_004">⊔</span><span class="cls_007">/nix/store/8ggmblhvzciv...-</span></div>
<div style="position:absolute;left:84.62px;top:469.85px" class="cls_007"><span class="cls_007">openssl-0.9.7f</span><span class="cls_004">⊔</span><span class="cls_007">/nix/store/kiqnkwp5sqdg...-zlib-1.2.1"</span><span class="cls_004"> where ⊔ denotes a space.</span></div>
<div style="position:absolute;left:74.66px;top:491.64px" class="cls_004"><span class="cls_004">• Likewise,</span><span class="cls_007"> processBinding</span><span class="cls_004"> is used to set the command-line arguments from the</span><span class="cls_007"> args</span></div>
<div style="position:absolute;left:84.62px;top:503.59px" class="cls_004"><span class="cls_004">attribute</span><span class="cls_014"> </span><span class="cls_056">62</span><span class="cls_059"> </span><span class="cls_004">, and the builder from the</span><span class="cls_007"> builder</span><span class="cls_004"> attribute</span><span class="cls_014"> </span><span class="cls_056">61</span><span class="cls_059"> </span><span class="cls_004">. Since</span><span class="cls_007"> args</span><span class="cls_004"> is a list, we do</span></div>
<div style="position:absolute;left:84.62px;top:515.55px" class="cls_004"><span class="cls_004">not need to concatenate the strings returned by</span><span class="cls_007"> processBindings</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:74.66px;top:537.33px" class="cls_004"><span class="cls_004">• The</span><span class="cls_007"> system</span><span class="cls_004"> field is initialised from the</span><span class="cls_007"> system</span><span class="cls_004"> attribute.</span></div>
<div style="position:absolute;left:74.66px;top:559.11px" class="cls_004"><span class="cls_004">• The set of input derivations</span><span class="cls_007"> inputDrvs</span><span class="cls_004"> (the build-time dependencies) is the set of</span></div>
<div style="position:absolute;left:84.62px;top:571.07px" class="cls_004"><span class="cls_004">store paths of derivations that occur in the attributes</span><span class="cls_014"> </span><span class="cls_056">59</span><span class="cls_059"> </span><span class="cls_004">. These are discovered by</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_007"><span class="cls_007">processBinding</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">102</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:74520px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background111.jpg" width=481 height=680></div>
<div style="position:absolute;left:212.59px;top:17.14px" class="cls_004"><span class="cls_004">5.4. Translating Nix expressions to store derivations</span></div>
<div style="position:absolute;left:72.24px;top:46.83px" class="cls_007"><span class="cls_007">processBinding</span><span class="cls_004">(e) :</span></div>
<div style="position:absolute;left:87.19px;top:58.79px" class="cls_004"><span class="cls_004">e</span><span class="cls_012">′</span><span class="cls_004"> ← </span><span class="cls_007">eval</span><span class="cls_004">(e)</span></div>
<div style="position:absolute;left:87.19px;top:69.72px" class="cls_004"><span class="cls_004">if e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> =</span><span class="cls_007"> true</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:102.13px;top:82.70px" class="cls_004"><span class="cls_004">return {</span><span class="cls_007">drvs</span><span class="cls_004"> = 0,</span><span class="cls_007"> srcs</span><span class="cls_004"> = 0,</span><span class="cls_007"> res</span><span class="cls_004"> = [</span><span class="cls_007">"1"</span><span class="cls_004">]}</span></div>
<div style="position:absolute;left:87.19px;top:93.73px" class="cls_004"><span class="cls_004">if e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> =</span><span class="cls_007"> false</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:102.13px;top:106.71px" class="cls_004"><span class="cls_004">return {</span><span class="cls_007">drvs</span><span class="cls_004"> = 0,</span><span class="cls_007"> srcs</span><span class="cls_004"> = 0,</span><span class="cls_007"> res</span><span class="cls_004"> = [</span><span class="cls_007">""</span><span class="cls_004">]}</span></div>
<div style="position:absolute;left:87.19px;top:117.74px" class="cls_004"><span class="cls_004">if e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> = a string s :</span></div>
<div style="position:absolute;left:102.13px;top:130.72px" class="cls_004"><span class="cls_004">return {</span><span class="cls_007">drvs</span><span class="cls_004"> = 0,</span><span class="cls_007"> srcs</span><span class="cls_004"> = 0,</span><span class="cls_007"> res</span><span class="cls_004"> = [s]}</span></div>
<div style="position:absolute;left:87.19px;top:141.75px" class="cls_004"><span class="cls_004">if e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> =</span><span class="cls_007"> null</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:102.13px;top:154.73px" class="cls_004"><span class="cls_004">return {</span><span class="cls_007">drvs</span><span class="cls_004"> = 0,</span><span class="cls_007"> srcs</span><span class="cls_004"> = 0,</span><span class="cls_007"> res</span><span class="cls_004"> = [</span><span class="cls_007">""</span><span class="cls_004">]}</span></div>
<div style="position:absolute;left:87.19px;top:165.76px" class="cls_004"><span class="cls_004">if e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> = a path p :</span></div>
<div style="position:absolute;left:157.98px;top:168.78px" class="cls_056"><span class="cls_056">66</span></div>
<div style="position:absolute;left:102.88px;top:177.71px" class="cls_004"><span class="cls_004">p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ←</span><span class="cls_007"> addToStore</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p), 0,</span><span class="cls_007"> baseName</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:102.13px;top:189.67px" class="cls_004"><span class="cls_004">return {</span><span class="cls_007">drvs</span><span class="cls_004"> = 0,</span><span class="cls_007"> srcs</span><span class="cls_004"> = {p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">},</span><span class="cls_007"> res</span><span class="cls_004"> = [p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">]}</span></div>
<div style="position:absolute;left:87.19px;top:201.62px" class="cls_004"><span class="cls_004">if e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> = an attribute set {as} with as.</span><span class="cls_007">type</span><span class="cls_004"> =</span><span class="cls_007"> "derivation"</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:314.03px;top:204.64px" class="cls_056"><span class="cls_056">67</span></div>
<div style="position:absolute;left:102.13px;top:214.60px" class="cls_004"><span class="cls_004">// Note that {as} is the result of a call to</span><span class="cls_007"> derivation</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:102.13px;top:226.56px" class="cls_004"><span class="cls_004">return {</span><span class="cls_007">drvs</span><span class="cls_004"> = {</span><span class="cls_007">eval</span><span class="cls_004">(as.</span><span class="cls_007">drvPath</span><span class="cls_004">)},</span><span class="cls_007"> srcs</span><span class="cls_004"> = 0,</span><span class="cls_007"> res</span><span class="cls_004"> = [</span><span class="cls_007">eval</span><span class="cls_004">(as.</span><span class="cls_007">outPath</span><span class="cls_004">)]}</span></div>
<div style="position:absolute;left:87.19px;top:237.49px" class="cls_004"><span class="cls_004">if e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> = a list [ls] :</span></div>
<div style="position:absolute;left:159.44px;top:240.51px" class="cls_056"><span class="cls_056">68</span></div>
<div style="position:absolute;left:102.88px;top:250.47px" class="cls_004"><span class="cls_004">ps ←</span><span class="cls_007"> map</span><span class="cls_004">(</span><span class="cls_007">processBinding</span><span class="cls_004">, ls)</span></div>
<div style="position:absolute;left:102.13px;top:262.42px" class="cls_004"><span class="cls_004">return</span></div>
<div style="position:absolute;left:112.09px;top:268.40px" class="cls_004"><span class="cls_004">{</span><span class="cls_007"> drvs</span><span class="cls_004"> = </span><span class="cls_035"><sup>⋃</sup></span></div>
<div style="position:absolute;left:156.68px;top:268.40px" class="cls_012"><span class="cls_012">p∈ps</span><span class="cls_004"> p.</span><span class="cls_007">drvs</span><span class="cls_004">,</span><span class="cls_007">srcs</span><span class="cls_004">=</span><span class="cls_035">⋃</span><span class="cls_012">p∈ps</span><span class="cls_004"> p.</span><span class="cls_007">srcs</span></div>
<div style="position:absolute;left:112.09px;top:286.61px" class="cls_004"><span class="cls_004">,</span><span class="cls_007"> res</span><span class="cls_004"> =</span><span class="cls_007"> concatMap</span><span class="cls_004">(λ p . p.</span><span class="cls_007">res</span><span class="cls_004">, ps)}</span></div>
<div style="position:absolute;left:87.19px;top:298.57px" class="cls_004"><span class="cls_004">abort</span></div>
<div style="position:absolute;left:122.63px;top:323.26px" class="cls_004"><span class="cls_004">Figure 5.7.:</span><span class="cls_007"> processBinding</span><span class="cls_004">: Processing derivation attributes</span></div>
<div style="position:absolute;left:78.82px;top:356.31px" class="cls_004"><span class="cls_004">• The set of input sources</span><span class="cls_007"> inputSrcs</span><span class="cls_004"> is the set of store paths of sources that occur in</span></div>
<div style="position:absolute;left:88.78px;top:368.27px" class="cls_004"><span class="cls_004">the attributes</span><span class="cls_014"> </span><span class="cls_056">60</span><span class="cls_059"> </span><span class="cls_004">. These are also discovered by</span><span class="cls_007"> processBinding</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:406.55px" class="cls_009"><span class="cls_009">Processing the attributes</span><span class="cls_004">   Clearly, the core of the translation is the function</span><span class="cls_007"> process-</span></div>
<div style="position:absolute;left:63.87px;top:418.50px" class="cls_007"><span class="cls_007">Binding</span><span class="cls_004">, shown in Figure 5.7. It evaluates a Nix expression, inspects it, and returns three</span></div>
<div style="position:absolute;left:63.87px;top:430.46px" class="cls_004"><span class="cls_004">pieces of information in a structure:</span></div>
<div style="position:absolute;left:78.82px;top:451.90px" class="cls_004"><span class="cls_004">• A list of strings that represent the normal form of the expression (</span><span class="cls_007">res</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:78.82px;top:473.84px" class="cls_004"><span class="cls_004">• The set of store paths of derivations occurring in the expression (</span><span class="cls_007">drvs</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:78.82px;top:495.79px" class="cls_004"><span class="cls_004">• The set of store paths of sources occurring in the expression (</span><span class="cls_007">srcs</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:73.84px;top:517.23px" class="cls_004"><span class="cls_004">Simple values like strings, Booleans, and</span><span class="cls_007"> null</span><span class="cls_004"> map to singleton string lists. For instance,</span></div>
<div style="position:absolute;left:63.87px;top:529.18px" class="cls_007"><span class="cls_007">true</span><span class="cls_004"> is translated to</span><span class="cls_007"> ["1"]</span><span class="cls_004">, and</span><span class="cls_007"> false</span><span class="cls_004"> is translated to</span><span class="cls_007"> [""]</span><span class="cls_004">. The latter is so that we can write in</span></div>
<div style="position:absolute;left:63.87px;top:541.14px" class="cls_004"><span class="cls_004">shell scripts:</span></div>
<div style="position:absolute;left:88.78px;top:566.84px" class="cls_015"><span class="cls_015">if  test  -n  "$var";  then  ...  fi</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">to test whether Boolean variable</span><span class="cls_007"> $var</span><span class="cls_004"> is set.</span></div>
<div style="position:absolute;left:407.23px;top:624.86px" class="cls_004"><span class="cls_004">103</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:75210px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background112.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:69.68px;top:45.04px" class="cls_004"><span class="cls_004">For lists,</span><span class="cls_007"> processBinding</span><span class="cls_004"> is applied recursively to the list elements</span><span class="cls_014"> </span><span class="cls_056">68</span><span class="cls_059"> </span><span class="cls_004">.  The resulting</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">string lists are concatenated into a single list.  Thus, nested lists are allowed; they are</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">flattened automatically.</span></div>
<div style="position:absolute;left:69.68px;top:80.90px" class="cls_004"><span class="cls_004">For paths,</span><span class="cls_007"> processBinding</span><span class="cls_004"> copies the referenced FSO to the Nix store using</span><span class="cls_007"> addToStore</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">and returns the resulting path in</span><span class="cls_007"> srcs</span><span class="cls_004"> and</span><span class="cls_007"> res</span><span class="cls_014"> </span><span class="cls_056">66</span><span class="cls_059"> </span><span class="cls_004">. Thus all referenced sources end up in the</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">Nix store. The file name of the source (returned by the function</span><span class="cls_007"> baseName</span><span class="cls_004">) is used as the</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">symbolic name of the store path.</span></div>
<div style="position:absolute;left:69.68px;top:128.73px" class="cls_004"><span class="cls_004">For attribute sets,</span><span class="cls_007"> processBinding</span><span class="cls_004"> checks whether the</span><span class="cls_007"> type</span><span class="cls_004"> attribute of the derivation (if</span></div>
<div style="position:absolute;left:59.72px;top:140.68px" class="cls_004"><span class="cls_004">present) is equal to</span><span class="cls_007"> derivation</span><span class="cls_004">. If so, the value denotes the result of a call to</span><span class="cls_007"> derivation</span><span class="cls_004">. This</span></div>
<div style="position:absolute;left:59.72px;top:152.64px" class="cls_004"><span class="cls_004">is where</span><span class="cls_007"> instantiate</span><span class="cls_004"> recurses into subderivations:</span><span class="cls_007"> instantiate</span><span class="cls_004"> calls</span><span class="cls_007"> processBinding</span><span class="cls_004">, which</span></div>
<div style="position:absolute;left:59.72px;top:164.59px" class="cls_004"><span class="cls_004">calls</span><span class="cls_007"> eval</span><span class="cls_004">, which eventually calls</span><span class="cls_007"> instantiate</span><span class="cls_004"> for derivations occurring in the input attributes.</span></div>
<div style="position:absolute;left:69.68px;top:176.55px" class="cls_004"><span class="cls_004">Let us look at an example. Suppose that we have a derivation</span></div>
<div style="position:absolute;left:84.62px;top:200.16px" class="cls_015"><span class="cls_015">args  =  ["-e"  ./builder.sh  python];</span></div>
<div style="position:absolute;left:59.72px;top:214.26px" class="cls_004"><span class="cls_004">where</span><span class="cls_007"> python</span><span class="cls_004"> is a variable that evaluates to another derivation. Since this is a list,</span><span class="cls_007"> process-</span></div>
<div style="position:absolute;left:59.72px;top:226.22px" class="cls_007"><span class="cls_007">Binding</span><span class="cls_004"> will recurse into the list elements. This yields the following results. For</span><span class="cls_007"> "-e"</span><span class="cls_004">, we</span></div>
<div style="position:absolute;left:59.72px;top:238.17px" class="cls_004"><span class="cls_004">get</span></div>
<div style="position:absolute;left:84.62px;top:259.38px" class="cls_004"><span class="cls_004">{</span><span class="cls_007">drvs</span><span class="cls_004"> = 0,</span><span class="cls_007"> srcs</span><span class="cls_004"> = 0,</span><span class="cls_007"> res</span><span class="cls_004"> = [</span><span class="cls_007">"-e"</span><span class="cls_004">]}.</span></div>
<div style="position:absolute;left:69.68px;top:280.58px" class="cls_004"><span class="cls_004">For</span><span class="cls_007"> ./builder.sh</span><span class="cls_004">, the file</span><span class="cls_007"> builder.sh</span><span class="cls_004"> in the current directory is added to the Nix store using</span></div>
<div style="position:absolute;left:59.72px;top:292.54px" class="cls_007"><span class="cls_007">addToStore</span><span class="cls_004">. Supposing that the file has SHA-256 hash</span><span class="cls_007"> 49b96daeab53...</span><span class="cls_004"> in hexadecimal,</span></div>
<div style="position:absolute;left:59.72px;top:304.50px" class="cls_007"><span class="cls_007">addToStore</span><span class="cls_004"> will call</span><span class="cls_007"> makePath</span><span class="cls_004"> with the following arguments:</span></div>
<div style="position:absolute;left:84.62px;top:325.70px" class="cls_007"><span class="cls_007">makePath</span><span class="cls_004">(</span><span class="cls_007">"source"</span><span class="cls_004">,</span><span class="cls_007"> "49b96daeab53..."</span><span class="cls_004">,</span><span class="cls_007"> "builder.sh"</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:59.72px;top:346.91px" class="cls_007"><span class="cls_007">makePath</span><span class="cls_004"> constructs the hash part by hashing and truncating the following string</span></div>
<div style="position:absolute;left:84.62px;top:370.52px" class="cls_015"><span class="cls_015">source:sha256:49b96daeab53...:/nix/store:builder.sh</span></div>
<div style="position:absolute;left:59.72px;top:384.62px" class="cls_004"><span class="cls_004">into</span><span class="cls_007"> 043577cf3vlb</span></div>
<div style="position:absolute;left:143.45px;top:384.62px" class="cls_004"><span class="cls_004">The store path thus becomes</span><span class="cls_007"> /nix/store/043577cf3vlb...-builder.sh</span><span class="cls_004">, and</span></div>
<div style="position:absolute;left:59.72px;top:396.58px" class="cls_007"><span class="cls_007">processBinding</span><span class="cls_004"> returns</span></div>
<div style="position:absolute;left:84.62px;top:417.78px" class="cls_004"><span class="cls_004">{</span><span class="cls_007"> drvs</span><span class="cls_004"> = 0,</span><span class="cls_007"> srcs</span><span class="cls_004"> = {</span><span class="cls_007">/nix/store/043577cf3vlb...-builder.sh</span><span class="cls_004">}</span></div>
<div style="position:absolute;left:86.84px;top:432.73px" class="cls_004"><span class="cls_004">,</span><span class="cls_007"> res</span><span class="cls_004"> = [</span><span class="cls_007">"/nix/store/043577cf3vlb...-builder.sh"</span><span class="cls_004">] }.</span></div>
<div style="position:absolute;left:69.68px;top:453.93px" class="cls_004"><span class="cls_004">For</span><span class="cls_007"> python</span><span class="cls_004">, if we suppose that it evaluates to an attribute set with</span><span class="cls_007"> drvPath = /nix/store/-</span></div>
<div style="position:absolute;left:59.72px;top:465.89px" class="cls_007"><span class="cls_007">mi4p0ck4jqds...-python-2.4.1.drv</span><span class="cls_004"> and</span><span class="cls_007"> outPath = /nix/store/s3dc4m2zg9bb...-python-2.4.1</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:59.72px;top:477.85px" class="cls_007"><span class="cls_007">processBinding</span><span class="cls_004"> returns</span></div>
<div style="position:absolute;left:84.62px;top:499.05px" class="cls_004"><span class="cls_004">{</span><span class="cls_007"> drvs</span><span class="cls_004"> = {</span><span class="cls_007">/nix/store/mi4p0ck4jqds...-python-2.4.1.drv</span><span class="cls_004">},</span><span class="cls_007"> srcs</span><span class="cls_004"> = 0</span></div>
<div style="position:absolute;left:86.84px;top:514.00px" class="cls_004"><span class="cls_004">,</span><span class="cls_007"> res</span><span class="cls_004"> = [</span><span class="cls_007">"/nix/store/s3dc4m2zg9bb...-python-2.4.1"</span><span class="cls_004">] }.</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">Note that the path of the store derivation is placed in</span><span class="cls_007"> drvs</span><span class="cls_004"> (and will therefore eventually end</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">up in the</span><span class="cls_007"> inputDrvs</span><span class="cls_004"> of the referring derivation), since the derivation is needed to recursively</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">build this dependency when we build the current derivation. On the other hand, the path of</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">the output of the derivation is placed in</span><span class="cls_007"> res</span><span class="cls_004"> (and will end up in an environment variable or</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">command-line argument), since that is what the builder is interested in.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">104</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:75900px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background113.jpg" width=481 height=680></div>
<div style="position:absolute;left:212.59px;top:17.14px" class="cls_004"><span class="cls_004">5.4. Translating Nix expressions to store derivations</span></div>
<div style="position:absolute;left:67.26px;top:49.73px" class="cls_015"><span class="cls_015">Derive(</span></div>
<div style="position:absolute;left:75.73px;top:59.19px" class="cls_015"><span class="cls_015">[("out","/nix/store/bwacc7a5c5n3...-hello-2.1.1","","")],</span></div>
<div style="position:absolute;left:75.73px;top:68.66px" class="cls_015"><span class="cls_015">[("/nix/store/7mwh9alhscz7...-bash-3.0.drv",["out"]),</span></div>
<div style="position:absolute;left:79.96px;top:78.12px" class="cls_015"><span class="cls_015">("/nix/store/fi8m2vldnrxq...-hello-2.1.1.tar.gz.drv",["out"]),</span></div>
<div style="position:absolute;left:79.96px;top:87.58px" class="cls_015"><span class="cls_015">("/nix/store/khllx1q519r3...-stdenv-linux.drv",["out"]),</span></div>
<div style="position:absolute;left:79.96px;top:97.05px" class="cls_015"><span class="cls_015">("/nix/store/mjdfbi6dcyz7...-perl-5.8.6.drv",["out"])],</span></div>
<div style="position:absolute;left:75.73px;top:106.51px" class="cls_015"><span class="cls_015">["/nix/store/d74lr8jfsvdh...-builder.sh"],</span></div>
<div style="position:absolute;left:75.73px;top:115.98px" class="cls_015"><span class="cls_015">"i686-linux",</span></div>
<div style="position:absolute;left:75.73px;top:125.44px" class="cls_015"><span class="cls_015">"/nix/store/3nca8lmpr8gg...-bash-3.0/bin/sh",</span></div>
<div style="position:absolute;left:75.73px;top:134.91px" class="cls_015"><span class="cls_015">["-e","/nix/store/d74lr8jfsvdh...-builder.sh"],</span></div>
<div style="position:absolute;left:75.73px;top:144.37px" class="cls_015"><span class="cls_015">[("builder","/nix/store/3nca8lmpr8gg...-bash-3.0/bin/sh"),</span></div>
<div style="position:absolute;left:79.96px;top:153.84px" class="cls_015"><span class="cls_015">("name","hello-2.1.1"),</span></div>
<div style="position:absolute;left:79.96px;top:163.30px" class="cls_015"><span class="cls_015">("out","/nix/store/bwacc7a5c5n3...-hello-2.1.1"),</span></div>
<div style="position:absolute;left:79.96px;top:172.77px" class="cls_015"><span class="cls_015">("perl","/nix/store/h87pfv8klr4p...-perl-5.8.6"),</span></div>
<div style="position:absolute;left:79.96px;top:182.23px" class="cls_015"><span class="cls_015">("src","/nix/store/h6gq0lmj9lkg...-hello-2.1.1.tar.gz"),</span></div>
<div style="position:absolute;left:79.96px;top:191.69px" class="cls_015"><span class="cls_015">("stdenv","/nix/store/hhxbaln5n11c...-stdenv-linux"),</span></div>
<div style="position:absolute;left:79.96px;top:201.16px" class="cls_015"><span class="cls_015">("system","i686-linux")] )</span></div>
<div style="position:absolute;left:129.49px;top:218.30px" class="cls_004"><span class="cls_004">Figure 5.8.: ATerm representation of the Hello derivation</span></div>
<div style="position:absolute;left:73.84px;top:250.07px" class="cls_004"><span class="cls_004">Finally, the results of the recursive calls are combined for the list, and we get</span></div>
<div style="position:absolute;left:88.78px;top:271.63px" class="cls_004"><span class="cls_004">{</span><span class="cls_007"> drvs</span><span class="cls_004"> = {</span><span class="cls_007">/nix/store/mi4p0ck4jqds...-python-2.4.1.drv</span><span class="cls_004">}</span></div>
<div style="position:absolute;left:91.00px;top:286.58px" class="cls_004"><span class="cls_004">,</span><span class="cls_007"> srcs</span><span class="cls_004"> = {</span><span class="cls_007">/nix/store/043577cf3vlb...-builder.sh</span><span class="cls_004">}</span></div>
<div style="position:absolute;left:91.00px;top:301.52px" class="cls_004"><span class="cls_004">,</span><span class="cls_007"> res</span><span class="cls_004"> = [</span><span class="cls_007">"-e" "/nix/store/043577cf3vlb...-builder.sh"</span></div>
<div style="position:absolute;left:125.86px;top:316.46px" class="cls_007"><span class="cls_007">"/nix/store/s3dc4m2zg9bb...-python-2.4."</span><span class="cls_004">] }.</span></div>
<div style="position:absolute;left:63.87px;top:342.93px" class="cls_009"><span class="cls_009">Writing the derivation</span><span class="cls_004">   When the final output path of the derivation has been computed,</span></div>
<div style="position:absolute;left:63.87px;top:354.88px" class="cls_004"><span class="cls_004">we write a string representation of the store derivation to the Nix store using</span><span class="cls_007"> addTo-</span></div>
<div style="position:absolute;left:63.87px;top:366.84px" class="cls_007"><span class="cls_007">Store</span><span class="cls_014"> </span><span class="cls_056">65</span><span class="cls_059"> </span><span class="cls_004">. The function</span><span class="cls_007"> printDrv</span><span class="cls_004"> returns a byte sequence that represents the store derivation.</span></div>
<div style="position:absolute;left:63.87px;top:378.79px" class="cls_004"><span class="cls_004">The contents of the byte sequence is a textual ATerm. ATerms [166] are a simple format</span></div>
<div style="position:absolute;left:63.87px;top:390.75px" class="cls_004"><span class="cls_004">for the exchange of terms. For the Hello example, the ATerm representation is shown in</span></div>
<div style="position:absolute;left:63.87px;top:401.68px" class="cls_004"><span class="cls_004">Figure 5.8</span><span class="cls_012"><sup>6</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:414.66px" class="cls_004"><span class="cls_004">I will not formalise the translation to ATerms here, which is straightforward. However,</span></div>
<div style="position:absolute;left:63.87px;top:426.61px" class="cls_004"><span class="cls_004">the reader may be wondering about the presence of the</span><span class="cls_007"> "out"</span><span class="cls_004"> strings in the ATerm encoding</span></div>
<div style="position:absolute;left:63.87px;top:438.57px" class="cls_004"><span class="cls_004">of the</span><span class="cls_007"> inputDrvs</span><span class="cls_004"> field, as these do not occur in the abstract syntax, and about the fact that</span></div>
<div style="position:absolute;left:63.87px;top:450.52px" class="cls_007"><span class="cls_007">output</span><span class="cls_004"> is a list here, also containing the mysterious</span><span class="cls_007"> "out"</span><span class="cls_004"> string. This is actually for future</span></div>
<div style="position:absolute;left:63.87px;top:462.48px" class="cls_004"><span class="cls_004">compatibility with a Nix semantics that supports multiple output paths. Every derivation</span></div>
<div style="position:absolute;left:63.87px;top:474.43px" class="cls_004"><span class="cls_004">would produce a set of labelled outputs, the default output having label</span><span class="cls_007"> out</span><span class="cls_004">. Multiple out-</span></div>
<div style="position:absolute;left:63.87px;top:486.39px" class="cls_004"><span class="cls_004">puts allow more fine-grained deployment. In Section 6.7, I show a semantics that supports</span></div>
<div style="position:absolute;left:63.87px;top:498.34px" class="cls_004"><span class="cls_004">this.</span></div>
<div style="position:absolute;left:73.84px;top:510.30px" class="cls_004"><span class="cls_004">Note that in the call to</span><span class="cls_007"> addToStore</span><span class="cls_004">, we set the</span><span class="cls_007"> references</span><span class="cls_004"> of the new store object to the</span></div>
<div style="position:absolute;left:63.87px;top:522.25px" class="cls_004"><span class="cls_004">union of the store derivations (</span><span class="cls_007">inputDrvs</span><span class="cls_004">) and sources (</span><span class="cls_007">inputSrcs</span><span class="cls_004">) used by the derivation.</span></div>
<div style="position:absolute;left:63.87px;top:534.21px" class="cls_004"><span class="cls_004">Thus, the references graph is maintained for store derivations.  This means that we can</span></div>
<div style="position:absolute;left:63.87px;top:546.16px" class="cls_004"><span class="cls_004">query the closure of a derivation, which is the set of files necessary to do a build of the</span></div>
<div style="position:absolute;left:68.36px;top:565.18px" class="cls_013"><span class="cls_013"><sup>6</sup></span><span class="cls_014">Whitespace has been added to improve legibility. Actual textual ATerms as produced by the function</span><span class="cls_016"> ATwrite-</span></div>
<div style="position:absolute;left:75.83px;top:575.55px" class="cls_016"><span class="cls_016">ToString()</span><span class="cls_014"> in the ATerm API do not contain whitespace. In other words,</span><span class="cls_016"> ATwriteToString()</span><span class="cls_014"> produces a canonical</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">representation of an ATerm, and thus of the store derivation it represents.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">105</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:76590px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background114.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">derivation and all its dependencies.  As we saw in Section 2.4, this is useful for source</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">deployment.</span></div>
<div style="position:absolute;left:69.68px;top:68.98px" class="cls_004"><span class="cls_004">On the other hand, the path in the</span><span class="cls_007"> output</span><span class="cls_004"> field is not a reference of the store derivation,</span></div>
<div style="position:absolute;left:59.72px;top:80.93px" class="cls_004"><span class="cls_004">since the output in general does not exist yet, and because we want garbage collection of</span></div>
<div style="position:absolute;left:59.72px;top:92.89px" class="cls_004"><span class="cls_004">derivations and outputs to be independent.</span></div>
<div style="position:absolute;left:59.72px;top:120.75px" class="cls_008"><span class="cls_008">5.4.1. Fixed-output derivations</span></div>
<div style="position:absolute;left:59.72px;top:140.27px" class="cls_004"><span class="cls_004">The only remaining aspect of the translation is the computation of the output path by</span></div>
<div style="position:absolute;left:59.72px;top:152.23px" class="cls_007"><span class="cls_007">hashDrv</span><span class="cls_004">. As stated above, conceptually the output path is constructed from a SHA-256</span></div>
<div style="position:absolute;left:59.72px;top:164.18px" class="cls_004"><span class="cls_004">hash over the ATerm representation of the initial store derivation (i.e., the one with</span><span class="cls_007"> output</span></div>
<div style="position:absolute;left:59.72px;top:176.14px" class="cls_004"><span class="cls_004">set to the empty string</span><span class="cls_014"> </span><span class="cls_056">57</span><span class="cls_059"> </span><span class="cls_004">).  However, the matter is complicated by the notion of fixed-</span></div>
<div style="position:absolute;left:59.72px;top:188.09px" class="cls_004"><span class="cls_004">output derivations.</span></div>
<div style="position:absolute;left:69.68px;top:200.07px" class="cls_004"><span class="cls_004">Fixed-output derivations are derivations of which we know the output in advance. More</span></div>
<div style="position:absolute;left:59.72px;top:212.03px" class="cls_004"><span class="cls_004">precisely, the cryptographic hash of the output path is known to the Nix expression writer.</span></div>
<div style="position:absolute;left:69.68px;top:224.01px" class="cls_004"><span class="cls_004">The rationale for fixed-output derivations is derivations such as those produced by the</span></div>
<div style="position:absolute;left:59.72px;top:235.96px" class="cls_007"><span class="cls_007">fetchurl</span><span class="cls_004"> function.  This function downloads a file from a given URL. To ensure that the</span></div>
<div style="position:absolute;left:59.72px;top:247.92px" class="cls_004"><span class="cls_004">downloaded file has not been modified, the caller must also specify a cryptographic hash</span></div>
<div style="position:absolute;left:59.72px;top:259.88px" class="cls_004"><span class="cls_004">of the file. For example,</span></div>
<div style="position:absolute;left:84.62px;top:284.14px" class="cls_015"><span class="cls_015">fetchurl  {</span></div>
<div style="position:absolute;left:94.04px;top:295.10px" class="cls_015"><span class="cls_015">url  =  </span><A HREF="http://ftp.gnu.org/pub/gnu/hello/hello-2.1.1.tar.gz;/">http://ftp.gnu.org/pub/gnu/hello/hello-2.1.1.tar.gz;</A> </div>
<div style="position:absolute;left:94.04px;top:306.05px" class="cls_015"><span class="cls_015">md5  =  "70c9ccf9fac07f762c24f2df2290784d";</span></div>
<div style="position:absolute;left:84.62px;top:317.01px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:59.72px;top:331.76px" class="cls_004"><span class="cls_004">It sometimes happens that the URL of the file changes, e.g., because servers are reorganised</span></div>
<div style="position:absolute;left:59.72px;top:343.71px" class="cls_004"><span class="cls_004">or no longer available. We then must update the call to</span><span class="cls_007"> fetchurl</span><span class="cls_004">, e.g.,</span></div>
<div style="position:absolute;left:84.62px;top:367.98px" class="cls_015"><span class="cls_015">fetchurl  {</span></div>
<div style="position:absolute;left:94.04px;top:378.94px" class="cls_015"><span class="cls_015">url  =  ftp://ftp.nluug.nl/pub/gnu/hello/hello-2.1.1.tar.gz;</span></div>
<div style="position:absolute;left:94.04px;top:389.89px" class="cls_015"><span class="cls_015">md5  =  "70c9ccf9fac07f762c24f2df2290784d";</span></div>
<div style="position:absolute;left:84.62px;top:400.85px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:59.72px;top:415.60px" class="cls_004"><span class="cls_004">If a</span><span class="cls_007"> fetchurl</span><span class="cls_004"> derivation followed the normal translation scheme, the output paths of the</span></div>
<div style="position:absolute;left:59.72px;top:427.55px" class="cls_004"><span class="cls_004">derivation and all derivations depending on it would change. For instance, if we were to</span></div>
<div style="position:absolute;left:59.72px;top:439.51px" class="cls_004"><span class="cls_004">change the URL of the Glibc source distribution—a component on which almost all other</span></div>
<div style="position:absolute;left:59.72px;top:451.46px" class="cls_004"><span class="cls_004">components depend—massive rebuilds will ensue. This is unfortunate for a change which</span></div>
<div style="position:absolute;left:59.72px;top:463.42px" class="cls_004"><span class="cls_004">we know cannot have a real effect as it propagates upwards through the dependency graph.</span></div>
<div style="position:absolute;left:69.68px;top:475.40px" class="cls_004"><span class="cls_004">Fixed-output derivations solve this problem by allowing a derivation to state to Nix that</span></div>
<div style="position:absolute;left:59.72px;top:487.36px" class="cls_004"><span class="cls_004">its output will hash to a specific value. When Nix builds the derivation (Section 5.5), it</span></div>
<div style="position:absolute;left:59.72px;top:499.31px" class="cls_004"><span class="cls_004">will hash the output and check that the hash corresponds to the declared value. If there is</span></div>
<div style="position:absolute;left:59.72px;top:511.27px" class="cls_004"><span class="cls_004">a hash mismatch, the build fails and the output is not registered as valid. For fixed-output</span></div>
<div style="position:absolute;left:59.72px;top:523.22px" class="cls_004"><span class="cls_004">derivations, the computation of the output path only depends on the declared hash and hash</span></div>
<div style="position:absolute;left:59.72px;top:535.18px" class="cls_004"><span class="cls_004">algorithm, not on any other attributes of the derivation.</span></div>
<div style="position:absolute;left:69.68px;top:547.16px" class="cls_004"><span class="cls_004">Figure 5.9 shows the definition of the</span><span class="cls_007"> fetchurl</span><span class="cls_004"> function. The expression presented here</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">is somewhat simplified from the actual expression in Nixpkgs, which accepts SHA-1 and</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">SHA-256 hashes in addition to MD5 hashes.  A fixed-derivation output is declared by</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">defining the following attributes:</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">106</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:77280px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background115.jpg" width=481 height=680></div>
<div style="position:absolute;left:212.59px;top:17.14px" class="cls_004"><span class="cls_004">5.4. Translating Nix expressions to store derivations</span></div>
<div style="position:absolute;left:67.26px;top:49.95px" class="cls_015"><span class="cls_015">{stdenv,  curl}:  #  The  `curl'  program  is  used  for  downloading.</span></div>
<div style="position:absolute;left:67.26px;top:71.86px" class="cls_015"><span class="cls_015">{url,  md5}:</span></div>
<div style="position:absolute;left:67.26px;top:93.78px" class="cls_015"><span class="cls_015">stdenv.mkDerivation  {</span></div>
<div style="position:absolute;left:76.67px;top:104.74px" class="cls_015"><span class="cls_015">name  =  baseNameOf  (toString  url);</span></div>
<div style="position:absolute;left:76.67px;top:115.70px" class="cls_015"><span class="cls_015">builder  =  ./builder.sh;</span></div>
<div style="position:absolute;left:76.67px;top:126.66px" class="cls_015"><span class="cls_015">buildInputs  =  [curl];</span></div>
<div style="position:absolute;left:76.67px;top:148.58px" class="cls_015"><span class="cls_015"># This  is  a  fixed-output  derivation;</span></div>
<div style="position:absolute;left:76.67px;top:159.53px" class="cls_015"><span class="cls_015"># the  output  has  to  have  MD5  hash  `md5'.</span></div>
<div style="position:absolute;left:76.67px;top:170.49px" class="cls_015"><span class="cls_015">outputHashMode  =  "flat";</span></div>
<div style="position:absolute;left:76.67px;top:181.45px" class="cls_015"><span class="cls_015">outputHashAlgo  =  "md5";</span></div>
<div style="position:absolute;left:76.67px;top:192.41px" class="cls_015"><span class="cls_015">outputHash  =  md5;</span></div>
<div style="position:absolute;left:76.67px;top:214.33px" class="cls_015"><span class="cls_015">inherit  url;</span></div>
<div style="position:absolute;left:67.26px;top:225.29px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:73.19px;top:241.88px" class="cls_004"><span class="cls_004">Figure 5.9.:</span><span class="cls_007"> pkgs/build-support/fetchurl/default.nix</span><span class="cls_004">: fixed-output derivations in</span><span class="cls_007"> fetchurl</span></div>
<div style="position:absolute;left:78.82px;top:274.55px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:274.55px" class="cls_004"><span class="cls_004">The attribute</span><span class="cls_007"> outputHashAlgo</span><span class="cls_004"> specifies the hash algorithm:</span><span class="cls_007">  outputHashAlgo</span><span class="cls_004"> ∈ {</span></div>
<div style="position:absolute;left:88.78px;top:286.51px" class="cls_007"><span class="cls_007">"md5"</span><span class="cls_004">,</span><span class="cls_007"> "sha1"</span><span class="cls_004">,</span><span class="cls_007"> "sha256"</span><span class="cls_004">}.</span></div>
<div style="position:absolute;left:78.82px;top:307.69px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:307.69px" class="cls_004"><span class="cls_004">The attribute</span><span class="cls_007"> outputHash</span><span class="cls_004"> specifies the hash in either hexadecimal or base-32 nota-</span></div>
<div style="position:absolute;left:88.78px;top:319.65px" class="cls_004"><span class="cls_004">tion, as autodetected based on the length of the string.</span></div>
<div style="position:absolute;left:78.82px;top:340.83px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:340.83px" class="cls_004"><span class="cls_004">The attribute</span><span class="cls_007"> outputHashMode</span><span class="cls_004"> ∈ {</span><span class="cls_007">"recursive"</span><span class="cls_004">,</span><span class="cls_007"> "flat"</span><span class="cls_004">} states whether the hash is com-</span></div>
<div style="position:absolute;left:88.78px;top:352.78px" class="cls_004"><span class="cls_004">puted over the serialisation of the output path p, i.e.,</span><span class="cls_007"> hash</span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p))),</span></div>
<div style="position:absolute;left:88.78px;top:364.74px" class="cls_004"><span class="cls_004">or over the contents of the single non-executable regular file at p, respectively. The</span></div>
<div style="position:absolute;left:88.78px;top:376.69px" class="cls_004"><span class="cls_004">latter (which is the default) produces the same hashes as standard Linux commands</span></div>
<div style="position:absolute;left:88.78px;top:388.65px" class="cls_004"><span class="cls_004">such as</span><span class="cls_007"> md5sum</span><span class="cls_004"> and</span><span class="cls_007"> sha1sum</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:88.78px;top:405.22px" class="cls_004"><span class="cls_004">Recursive mode is useful for tools that download directory hierarchies instead of</span></div>
<div style="position:absolute;left:88.78px;top:417.17px" class="cls_004"><span class="cls_004">single files. For instance, Nixpkgs contains a function</span><span class="cls_007"> fetchsvn</span><span class="cls_004"> that exports revisions</span></div>
<div style="position:absolute;left:88.78px;top:429.13px" class="cls_004"><span class="cls_004">of directory hierarchies from Subversion repositories, e.g.,</span></div>
<div style="position:absolute;left:110.70px;top:454.57px" class="cls_015"><span class="cls_015">fetchsvn  {</span></div>
<div style="position:absolute;left:120.11px;top:465.53px" class="cls_015"><span class="cls_015">url  =  </span><A HREF="https://svn.cs.uu.nl:12443/repos/trace/nix/trunk;/">https://svn.cs.uu.nl:12443/repos/trace/nix/trunk;</A> </div>
<div style="position:absolute;left:120.11px;top:476.49px" class="cls_015"><span class="cls_015">rev  =  3297;</span></div>
<div style="position:absolute;left:120.11px;top:487.45px" class="cls_015"><span class="cls_015">md5  =  "2a074a3df23585c746cbcae0e93099c3";</span></div>
<div style="position:absolute;left:110.70px;top:498.41px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:88.78px;top:514.33px" class="cls_004"><span class="cls_004">For historical reasons, the</span><span class="cls_007"> outputHashMode</span><span class="cls_004"> attribute is encoded in the</span><span class="cls_007"> outputHash-</span></div>
<div style="position:absolute;left:88.78px;top:526.29px" class="cls_007"><span class="cls_007">Algo</span><span class="cls_004"> field</span><span class="cls_014"> </span><span class="cls_056">58</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:547.16px" class="cls_004"><span class="cls_004">These three attributes are used in the output path computation.  This means that, for</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">instance, the</span><span class="cls_007"> url</span><span class="cls_004"> attribute in</span><span class="cls_007"> fetchurl</span><span class="cls_004"> derivation is disregarded.  Thus, instantiation of the</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">two</span><span class="cls_007"> fetchurl</span><span class="cls_004"> calls shown above produces two store derivations that have the same</span><span class="cls_007"> output</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">field.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">107</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:77970px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background116.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:68.09px;top:46.83px" class="cls_007"><span class="cls_007">hashDrv</span><span class="cls_004">(d) :</span></div>
<div style="position:absolute;left:78.05px;top:58.79px" class="cls_004"><span class="cls_004">if d.</span><span class="cls_007">outputHash</span><span class="cls_004"> =</span><span class="cls_007"> ""</span></div>
<div style="position:absolute;left:88.01px;top:70.74px" class="cls_004"><span class="cls_004">return</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">"fixed:out:"</span><span class="cls_004"> + d.</span><span class="cls_007">outputHashAlgo</span></div>
<div style="position:absolute;left:97.97px;top:82.70px" class="cls_004"><span class="cls_004">+</span><span class="cls_007">":"</span><span class="cls_004"> + d.</span><span class="cls_007">outputHash</span></div>
<div style="position:absolute;left:97.97px;top:94.65px" class="cls_004"><span class="cls_004">+</span><span class="cls_007">":"</span><span class="cls_004"> + d.</span><span class="cls_007">output</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:78.05px;top:106.61px" class="cls_004"><span class="cls_004">else :</span></div>
<div style="position:absolute;left:88.01px;top:117.54px" class="cls_004"><span class="cls_004">d</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ← d { // I.e., d</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> is a modified copy of d</span></div>
<div style="position:absolute;left:97.97px;top:130.52px" class="cls_007"><span class="cls_007">inputDrvs</span><span class="cls_004"> = {</span><span class="cls_007">hashDrv</span><span class="cls_004">(</span><span class="cls_007">parseDrv</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p))) | p ∈ d.</span><span class="cls_007">inputDrvs</span><span class="cls_004">} )</span><span class="cls_056"> 69</span></div>
<div style="position:absolute;left:88.01px;top:142.47px" class="cls_004"><span class="cls_004">}</span></div>
<div style="position:absolute;left:88.01px;top:153.40px" class="cls_004"><span class="cls_004">return</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">printDrv</span><span class="cls_004">(d</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">))</span></div>
<div style="position:absolute;left:87.41px;top:179.12px" class="cls_004"><span class="cls_004">Figure 5.10.:</span><span class="cls_007"> hashDrv</span><span class="cls_004">: Hashing derivations modulo fixed-output derivations</span></div>
<div style="position:absolute;left:69.68px;top:211.64px" class="cls_004"><span class="cls_004">So how do we compute the hash part of the output path of a derivation? This is done</span></div>
<div style="position:absolute;left:59.72px;top:223.60px" class="cls_004"><span class="cls_004">by the function</span><span class="cls_007"> hashDrv</span><span class="cls_004">, shown in Figure 5.10. It distinguishes between two cases. If the</span></div>
<div style="position:absolute;left:59.72px;top:235.55px" class="cls_004"><span class="cls_004">derivation is a fixed-output derivation, then it computes a hash over just the</span><span class="cls_007"> outputHash</span></div>
<div style="position:absolute;left:59.72px;top:246.48px" class="cls_004"><span class="cls_004">attributes</span><span class="cls_012"><sup>7</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:259.70px" class="cls_004"><span class="cls_004">If the derivation is not a fixed-output derivation, we replace each element in the deriva-</span></div>
<div style="position:absolute;left:59.72px;top:271.66px" class="cls_004"><span class="cls_004">tion’s</span><span class="cls_007"> inputDrvs</span><span class="cls_004"> with the result of a call to</span><span class="cls_007"> hashDrv</span><span class="cls_004"> for that element.</span></div>
<div style="position:absolute;left:345.60px;top:271.66px" class="cls_004"><span class="cls_004">(The derivation at</span></div>
<div style="position:absolute;left:59.72px;top:283.61px" class="cls_004"><span class="cls_004">each store path in</span><span class="cls_007"> inputDrvs</span><span class="cls_004"> is converted from its on-disk ATerm representation back to a</span></div>
<div style="position:absolute;left:59.72px;top:295.57px" class="cls_007"><span class="cls_007">StoreDrv</span><span class="cls_004"> by the function</span><span class="cls_007"> parseDrv</span><span class="cls_004">.) In essence,</span><span class="cls_007"> hashDrv</span><span class="cls_004"> partitions store derivations into</span></div>
<div style="position:absolute;left:59.72px;top:307.52px" class="cls_004"><span class="cls_004">equivalence classes, and for hashing purpose it replaces each store path in a derivation</span></div>
<div style="position:absolute;left:59.72px;top:319.48px" class="cls_004"><span class="cls_004">graph with its equivalence class.</span></div>
<div style="position:absolute;left:69.68px;top:331.67px" class="cls_004"><span class="cls_004">The recursion in Figure 5.10 is inefficient: it will call itself once for each path by which</span></div>
<div style="position:absolute;left:59.72px;top:342.60px" class="cls_004"><span class="cls_004">a subderivation can be reached, i.e., O(V</span><span class="cls_012"><sup>k</sup></span><span class="cls_004">) times for a derivation graph with V derivations</span></div>
<div style="position:absolute;left:59.72px;top:355.58px" class="cls_004"><span class="cls_004">and with out-degree of at most k. In the actual implementation, memoisation is used to</span></div>
<div style="position:absolute;left:59.72px;top:367.54px" class="cls_004"><span class="cls_004">reduce this to O(V + E) complexity for a graph with E edges.</span></div>
<div style="position:absolute;left:59.72px;top:399.53px" class="cls_011"><span class="cls_011">5.5. Building store derivations</span></div>
<div style="position:absolute;left:59.72px;top:425.20px" class="cls_004"><span class="cls_004">After we have translated a Nix expression to a graph of store derivations, we want to</span></div>
<div style="position:absolute;left:59.72px;top:437.15px" class="cls_004"><span class="cls_004">perform the build actions described by them. The command</span><span class="cls_007"> nix-store --realise</span><span class="cls_004"> does this</span></div>
<div style="position:absolute;left:59.72px;top:449.11px" class="cls_004"><span class="cls_004">explicitly, and</span><span class="cls_007"> nix-env</span><span class="cls_004"> and</span><span class="cls_007"> nix-build</span><span class="cls_004"> do it automatically after store derivation instantiation.</span></div>
<div style="position:absolute;left:69.68px;top:461.30px" class="cls_004"><span class="cls_004">The postcondition of a successful build of a derivation is that the output path of the</span></div>
<div style="position:absolute;left:59.72px;top:473.26px" class="cls_004"><span class="cls_004">derivation is valid. This means that a successful derivation is performed only once (at least</span></div>
<div style="position:absolute;left:59.72px;top:485.21px" class="cls_004"><span class="cls_004">until the user runs the garbage collector). If the output is already valid, the build is a trivial</span></div>
<div style="position:absolute;left:59.72px;top:497.17px" class="cls_004"><span class="cls_004">operation. If it is not, the build described by the derivation is executed, and on successful</span></div>
<div style="position:absolute;left:59.72px;top:509.12px" class="cls_004"><span class="cls_004">completion the output path is registered as being valid, preventing future rebuilds.</span></div>
<div style="position:absolute;left:69.68px;top:521.32px" class="cls_004"><span class="cls_004">The build algorithm is also where binary deployment using substitutes is implemented.</span></div>
<div style="position:absolute;left:59.72px;top:533.27px" class="cls_004"><span class="cls_004">If we want to build a derivation with output path p, p is not valid, and we have a substitute</span></div>
<div style="position:absolute;left:59.72px;top:545.23px" class="cls_004"><span class="cls_004">for p, then we can execute the substitute to create p (which the substitute will generally</span></div>
<div style="position:absolute;left:64.20px;top:565.18px" class="cls_013"><span class="cls_013"><sup>7</sup></span><span class="cls_014">...as well as the</span><span class="cls_016"> output</span><span class="cls_014"> field. This field is empty when</span><span class="cls_016"> hashDrv</span><span class="cls_014"> is called for “unfinished” derivations from</span><span class="cls_016"> in-</span></div>
<div style="position:absolute;left:71.67px;top:575.55px" class="cls_016"><span class="cls_016">stantiate</span><span class="cls_014"> </span><span class="cls_056">64 </span><span class="cls_014">, but it contains an actual path when</span><span class="cls_016"> hashDrv</span><span class="cls_014"> calls itself recursively for “finished” derivations </span><span class="cls_056">69 </span><span class="cls_014">.</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">This ensures that the</span><span class="cls_016"> name</span><span class="cls_014"> attribute and the location of the store are taken into account.</span></div>
<div style="position:absolute;left:59.72px;top:624.86px" class="cls_004"><span class="cls_004">108</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:78660px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background117.jpg" width=481 height=680></div>
<div style="position:absolute;left:299.25px;top:17.14px" class="cls_004"><span class="cls_004">5.5. Building store derivations</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">do by downloading a pre-built binary and unpacking it to p).  Substitution is discussed</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">in Section 5.5.3; here we just assume that there exists a function</span><span class="cls_007"> substitute</span><span class="cls_004">(p) :</span><span class="cls_007"> Bool</span><span class="cls_004"> that</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">returns</span><span class="cls_007"> true</span><span class="cls_004"> if path p is valid or it has managed to make p valid by executing a substitute,</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">and</span><span class="cls_007"> false</span><span class="cls_004"> otherwise.</span></div>
<div style="position:absolute;left:73.84px;top:92.94px" class="cls_004"><span class="cls_004">This section shows how Nix builds store derivations. It first presents a “simple” build</span></div>
<div style="position:absolute;left:63.87px;top:104.90px" class="cls_004"><span class="cls_004">algorithm that recursively builds store derivations. Next, it introduces the concept of build</span></div>
<div style="position:absolute;left:63.87px;top:116.85px" class="cls_004"><span class="cls_004">hooks, which are a mechanism to support distributed multi-platform builds in a transpar-</span></div>
<div style="position:absolute;left:63.87px;top:128.81px" class="cls_004"><span class="cls_004">ent and centralised manner. Finally it shows a build algorithm that can perform multiple</span></div>
<div style="position:absolute;left:63.87px;top:140.76px" class="cls_004"><span class="cls_004">derivations in parallel.</span></div>
<div style="position:absolute;left:63.87px;top:168.94px" class="cls_008"><span class="cls_008">5.5.1. The simple build algorithm</span></div>
<div style="position:absolute;left:63.87px;top:188.58px" class="cls_004"><span class="cls_004">The build algorithm is shown in Figure 5.11. The function</span><span class="cls_007"> build</span><span class="cls_004"> takes as its sole argument</span></div>
<div style="position:absolute;left:63.87px;top:200.53px" class="cls_004"><span class="cls_004">the store path p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004"> of the derivation to be built. It returns the output path of the derivation</span></div>
<div style="position:absolute;left:63.87px;top:212.49px" class="cls_004"><span class="cls_004">if the build succeeds, and aborts if it does not. It consists of the following main steps:</span></div>
<div style="position:absolute;left:74.43px;top:234.66px" class="cls_056"><span class="cls_056">70</span></div>
<div style="position:absolute;left:88.78px;top:232.66px" class="cls_004"><span class="cls_004">First, we need to ensure that the derivation p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004"> exists. If it does not, it might be</span></div>
<div style="position:absolute;left:88.78px;top:244.62px" class="cls_004"><span class="cls_004">possible to obtain it through a substitute. It is a fatal error if p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004"> cannot be made</span></div>
<div style="position:absolute;left:88.78px;top:256.57px" class="cls_004"><span class="cls_004">valid. In any case, when p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004"> is valid, it is read into d, a value of the type</span><span class="cls_007"> StoreDrv</span></div>
<div style="position:absolute;left:88.78px;top:268.53px" class="cls_004"><span class="cls_004">shown in Figure 5.5.</span></div>
<div style="position:absolute;left:88.78px;top:284.64px" class="cls_004"><span class="cls_004">While the primary purpose of substitutes is to speed up the construction of deriva-</span></div>
<div style="position:absolute;left:88.78px;top:296.59px" class="cls_004"><span class="cls_004">tion outputs, they may also be used to distribute the store derivations themselves. In</span></div>
<div style="position:absolute;left:88.78px;top:308.55px" class="cls_004"><span class="cls_004">general, what we distribute to client machines are Nix expressions, and the transla-</span></div>
<div style="position:absolute;left:88.78px;top:320.50px" class="cls_004"><span class="cls_004">tion of those will cause the store derivations to be created locally. However, it is also</span></div>
<div style="position:absolute;left:88.78px;top:332.46px" class="cls_004"><span class="cls_004">possible to forego Nix expressions entirely and work directly on store derivations.</span></div>
<div style="position:absolute;left:88.78px;top:344.41px" class="cls_004"><span class="cls_004">For instance,</span><span class="cls_007"> nix-env</span><span class="cls_004"> allows one to install a store derivation directly:</span></div>
<div style="position:absolute;left:110.70px;top:368.93px" class="cls_015"><span class="cls_015">$ nix-channel  --update</span></div>
<div style="position:absolute;left:110.70px;top:379.89px" class="cls_015"><span class="cls_015">$ nix-env  -i  /nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span></div>
<div style="position:absolute;left:88.78px;top:394.89px" class="cls_004"><span class="cls_004">If</span><span class="cls_007"> /nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span><span class="cls_004"> is not valid, it is possible that a sub-</span></div>
<div style="position:absolute;left:88.78px;top:406.85px" class="cls_004"><span class="cls_004">stitute for it is available (e.g., obtained from a subscribed channel).  The primary</span></div>
<div style="position:absolute;left:88.78px;top:418.80px" class="cls_004"><span class="cls_004">advantage of skipping Nix expressions in this manner is that it makes one indepen-</span></div>
<div style="position:absolute;left:88.78px;top:430.76px" class="cls_004"><span class="cls_004">dent of the evolution of the Nix expression language, removing a possible source</span></div>
<div style="position:absolute;left:88.78px;top:442.71px" class="cls_004"><span class="cls_004">of incompatibility between the distributor and the clients. This is in fact one of the</span></div>
<div style="position:absolute;left:88.78px;top:454.67px" class="cls_004"><span class="cls_004">main advantages of the two-step build process.</span></div>
<div style="position:absolute;left:74.43px;top:476.92px" class="cls_056"><span class="cls_056">71</span></div>
<div style="position:absolute;left:88.78px;top:474.93px" class="cls_004"><span class="cls_004">We try to substitute the output path of the derivation. If it is already valid (as stated</span></div>
<div style="position:absolute;left:88.78px;top:486.88px" class="cls_004"><span class="cls_004">above,</span><span class="cls_007"> substitute</span><span class="cls_004"> checks for this trivial case), or it can be produced through a substi-</span></div>
<div style="position:absolute;left:88.78px;top:498.84px" class="cls_004"><span class="cls_004">tute, we’re done right away.</span></div>
<div style="position:absolute;left:74.43px;top:521.09px" class="cls_056"><span class="cls_056">72</span></div>
<div style="position:absolute;left:88.78px;top:519.09px" class="cls_004"><span class="cls_004">Since the output is not valid and there is no substitute, we have to perform the build</span></div>
<div style="position:absolute;left:88.78px;top:531.05px" class="cls_004"><span class="cls_004">action. We need to build all input derivations in</span><span class="cls_007"> inputDrvs</span><span class="cls_004">, or, more precisely, we</span></div>
<div style="position:absolute;left:88.78px;top:543.00px" class="cls_004"><span class="cls_004">need to ensure that the output paths of the input derivations are valid. So we recur-</span></div>
<div style="position:absolute;left:88.78px;top:554.96px" class="cls_004"><span class="cls_004">sively build the input derivations.</span></div>
<div style="position:absolute;left:88.78px;top:571.07px" class="cls_004"><span class="cls_004">Note that it is not necessary to ensure that the input sources in</span><span class="cls_007"> inputSrcs</span><span class="cls_004"> are valid.</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_004"><span class="cls_004">This is because of the closure invariant:  the</span><span class="cls_007"> inputSrcs</span><span class="cls_004"> are all in the</span><span class="cls_007"> references</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">109</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:79350px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background118.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:68.09px;top:60.05px" class="cls_007"><span class="cls_007">build</span><span class="cls_004">(p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">) :</span></div>
<div style="position:absolute;left:83.03px;top:72.01px" class="cls_004"><span class="cls_004">if ¬</span><span class="cls_007"> substitute</span><span class="cls_004">(p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">) : abort</span><span class="cls_014"> </span><span class="cls_056">70</span></div>
<div style="position:absolute;left:83.03px;top:83.96px" class="cls_004"><span class="cls_004">d ← </span><span class="cls_007">parseDrv</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">))</span></div>
<div style="position:absolute;left:83.03px;top:95.92px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> substitute</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">) : return d.</span><span class="cls_007">output</span><span class="cls_014"> </span><span class="cls_056">71</span></div>
<div style="position:absolute;left:83.03px;top:119.83px" class="cls_004"><span class="cls_004">inputs ← 0</span></div>
<div style="position:absolute;left:83.03px;top:131.78px" class="cls_004"><span class="cls_004">for each p ∈ d.</span><span class="cls_007">inputsDrvs</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:198.32px;top:133.78px" class="cls_056"><span class="cls_056">72</span></div>
<div style="position:absolute;left:97.97px;top:143.74px" class="cls_007"><span class="cls_007">build</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:97.97px;top:154.67px" class="cls_004"><span class="cls_004">d</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ←</span><span class="cls_007"> parseDrv</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:124.55px;top:168.92px" class="cls_004"><span class="cls_004">←</span><span class="cls_007"> closure</span><span class="cls_004">(d</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">.</span><span class="cls_007">output</span><span class="cls_004">)</span><span class="cls_014"> </span><span class="cls_056">73</span></div>
<div style="position:absolute;left:83.03px;top:181.90px" class="cls_004"><span class="cls_004">for each p ∈ d.</span><span class="cls_007">inputsSrcs</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:124.55px;top:196.16px" class="cls_004"><span class="cls_004">←</span><span class="cls_007"> closure</span><span class="cls_004">(p)</span><span class="cls_014"> </span><span class="cls_056">74</span></div>
<div style="position:absolute;left:83.03px;top:220.07px" class="cls_004"><span class="cls_004">lock ←</span><span class="cls_007"> acquirePathLock</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">)</span><span class="cls_014"> </span><span class="cls_056">75</span></div>
<div style="position:absolute;left:83.03px;top:232.02px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> valid</span><span class="cls_004">[d.</span><span class="cls_007">output</span><span class="cls_004">] = ε :</span></div>
<div style="position:absolute;left:97.97px;top:243.98px" class="cls_007"><span class="cls_007">releasePathLock</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">, lock)</span></div>
<div style="position:absolute;left:97.97px;top:255.93px" class="cls_004"><span class="cls_004">return d.</span><span class="cls_007">output</span></div>
<div style="position:absolute;left:83.03px;top:267.89px" class="cls_004"><span class="cls_004">if d.</span><span class="cls_007">system</span><span class="cls_004"> =</span><span class="cls_007"> thisSystem</span><span class="cls_004"> : abort</span><span class="cls_014"> </span><span class="cls_056">76</span></div>
<div style="position:absolute;left:83.03px;top:279.84px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> pathExists</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">) :</span><span class="cls_007"> deletePath</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:268.11px;top:281.84px" class="cls_056"><span class="cls_056">77</span></div>
<div style="position:absolute;left:83.78px;top:291.80px" class="cls_004"><span class="cls_004">p</span><span class="cls_012">tmp</span><span class="cls_004"> ←</span><span class="cls_007"> createTempDir</span><span class="cls_004">()</span><span class="cls_014"> </span><span class="cls_056">78</span></div>
<div style="position:absolute;left:83.03px;top:303.75px" class="cls_004"><span class="cls_004">Run d.</span><span class="cls_007">builder</span><span class="cls_004"> in an environment d.</span><span class="cls_007">envVars</span></div>
<div style="position:absolute;left:92.99px;top:315.71px" class="cls_004"><span class="cls_004">and with arguments d.</span><span class="cls_007">args</span><span class="cls_004"> and in directory p</span><span class="cls_012"><sub>tmp</sub></span></div>
<div style="position:absolute;left:289.41px;top:317.70px" class="cls_056"><span class="cls_056">79</span></div>
<div style="position:absolute;left:83.03px;top:327.66px" class="cls_004"><span class="cls_004">if the builder exits with exit code = 0 :</span></div>
<div style="position:absolute;left:97.97px;top:339.62px" class="cls_007"><span class="cls_007">deletePath</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:97.97px;top:351.58px" class="cls_004"><span class="cls_004">abort</span></div>
<div style="position:absolute;left:83.03px;top:375.49px" class="cls_007"><span class="cls_007">canonicalisePathContents</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">)</span><span class="cls_014"> </span><span class="cls_056">80</span></div>
<div style="position:absolute;left:83.03px;top:387.44px" class="cls_004"><span class="cls_004">if d.</span><span class="cls_007">outputHash</span><span class="cls_004"> =</span><span class="cls_007"> ""</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:175.06px;top:389.43px" class="cls_056"><span class="cls_056">81</span></div>
<div style="position:absolute;left:97.97px;top:399.40px" class="cls_004"><span class="cls_004">Extract mode m and hash algorithm t from d.</span><span class="cls_007">outputHashAlgo</span></div>
<div style="position:absolute;left:97.97px;top:411.35px" class="cls_004"><span class="cls_004">if m indicates flat mode :</span></div>
<div style="position:absolute;left:112.92px;top:423.31px" class="cls_004"><span class="cls_004">Check that d.</span><span class="cls_007">output</span><span class="cls_004"> is a non-executable regular file</span></div>
<div style="position:absolute;left:122.88px;top:435.26px" class="cls_004"><span class="cls_004">and that</span><span class="cls_007"> hash</span><span class="cls_012"><sub>t</sub></span><span class="cls_004"> (</span><span class="cls_007">readFile</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">)) matches d.</span><span class="cls_007">outputHash</span></div>
<div style="position:absolute;left:97.97px;top:447.22px" class="cls_004"><span class="cls_004">else :</span></div>
<div style="position:absolute;left:112.92px;top:459.17px" class="cls_004"><span class="cls_004">Check that</span><span class="cls_007"> hash</span><span class="cls_012"><sub>t</sub></span><span class="cls_004"> (</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">))) matches d.</span><span class="cls_007">outputHash</span></div>
<div style="position:absolute;left:83.03px;top:483.18px" class="cls_004"><span class="cls_004">In a database transaction :</span></div>
<div style="position:absolute;left:192.05px;top:485.17px" class="cls_056"><span class="cls_056">82</span></div>
<div style="position:absolute;left:97.97px;top:495.14px" class="cls_007"><span class="cls_007">valid</span><span class="cls_004">[d.</span><span class="cls_007">output</span><span class="cls_004">] ←</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">)))</span></div>
<div style="position:absolute;left:97.97px;top:507.09px" class="cls_007"><span class="cls_007">setReferences</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">,</span><span class="cls_007"> scanForReferences</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">, inputs))</span></div>
<div style="position:absolute;left:97.97px;top:519.05px" class="cls_007"><span class="cls_007">deriver</span><span class="cls_004">[d.</span><span class="cls_007">output</span><span class="cls_004">] ← p</span><span class="cls_012"><sub>drv</sub></span></div>
<div style="position:absolute;left:83.03px;top:531.00px" class="cls_007"><span class="cls_007">releasePathLock</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">, lock)</span></div>
<div style="position:absolute;left:83.03px;top:542.96px" class="cls_004"><span class="cls_004">return d.</span><span class="cls_007">output</span></div>
<div style="position:absolute;left:148.21px;top:567.64px" class="cls_004"><span class="cls_004">Figure 5.11.:</span><span class="cls_007"> build</span><span class="cls_004">: Building store derivations</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">110</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:80040px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background119.jpg" width=481 height=680></div>
<div style="position:absolute;left:299.25px;top:17.14px" class="cls_004"><span class="cls_004">5.5. Building store derivations</span></div>
<div style="position:absolute;left:88.78px;top:45.04px" class="cls_004"><span class="cls_004">entry for p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">  (cf. Figure 5.6), and thus validity of p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">  implies validity of each</span></div>
<div style="position:absolute;left:89.53px;top:56.99px" class="cls_004"><span class="cls_004">p ∈ </span><span class="cls_007">d.inputSrcs</span><span class="cls_004">. Likewise, we know for sure that we can load the input derivations,</span></div>
<div style="position:absolute;left:88.78px;top:68.95px" class="cls_004"><span class="cls_004">since these too are references of p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:74.43px;top:92.86px" class="cls_056"><span class="cls_056">75</span></div>
<div style="position:absolute;left:88.78px;top:90.87px" class="cls_004"><span class="cls_004">We acquire an exclusive lock on the output path. Once we have acquired the lock, we</span></div>
<div style="position:absolute;left:88.78px;top:102.82px" class="cls_004"><span class="cls_004">know that there is no other Nix process building the output path (including through</span></div>
<div style="position:absolute;left:88.78px;top:114.78px" class="cls_004"><span class="cls_004">substitutes, since as we will see,</span><span class="cls_007"> substitute</span><span class="cls_004"> also locks properly).</span></div>
<div style="position:absolute;left:88.78px;top:131.71px" class="cls_004"><span class="cls_004">However, once we have acquired the lock, it is possible that another process got</span></div>
<div style="position:absolute;left:88.78px;top:143.67px" class="cls_004"><span class="cls_004">there first, i.e., saw that the output was invalid, acquire the lock, and did the build.</span></div>
<div style="position:absolute;left:88.78px;top:155.62px" class="cls_004"><span class="cls_004">This can be detected by checking once more whether the output path is valid. If it</span></div>
<div style="position:absolute;left:88.78px;top:167.58px" class="cls_004"><span class="cls_004">is, we’re done.</span></div>
<div style="position:absolute;left:88.78px;top:184.52px" class="cls_004"><span class="cls_004">Thanks to locking and the transactional semantics of registering valid paths (step</span></div>
<div style="position:absolute;left:90.18px;top:196.47px" class="cls_056"><span class="cls_056">82</span><span class="cls_059"> </span><span class="cls_004"> described below), an interrupted operation (such as building a derivation) can</span></div>
<div style="position:absolute;left:88.78px;top:208.43px" class="cls_004"><span class="cls_004">always be restarted, requiring no further recovery. It also ensures that all operations</span></div>
<div style="position:absolute;left:88.78px;top:220.38px" class="cls_004"><span class="cls_004">are idempotent, i.e., can be repeated any number of times. Operations can also be</span></div>
<div style="position:absolute;left:88.78px;top:232.34px" class="cls_004"><span class="cls_004">run in parallel. In particular, it is safe to run multiple build actions in parallel. Since</span></div>
<div style="position:absolute;left:88.78px;top:244.29px" class="cls_004"><span class="cls_004">locking is fine-grained, as opposed to having a global lock for the entire Nix store,</span></div>
<div style="position:absolute;left:88.78px;top:256.25px" class="cls_004"><span class="cls_004">parallel execution can be used to speed up builds. If more than one CPU is available,</span></div>
<div style="position:absolute;left:88.78px;top:268.20px" class="cls_004"><span class="cls_004">this gives better resource utilisation. However, even if there is only one CPU, we may</span></div>
<div style="position:absolute;left:88.78px;top:280.16px" class="cls_004"><span class="cls_004">get a performance improvement if some of the builds are heavily I/O-bound [6].</span></div>
<div style="position:absolute;left:74.43px;top:304.07px" class="cls_056"><span class="cls_056">76</span></div>
<div style="position:absolute;left:88.78px;top:302.08px" class="cls_004"><span class="cls_004">It is only possible to build the derivation if the current machine and operating system</span></div>
<div style="position:absolute;left:88.78px;top:314.03px" class="cls_004"><span class="cls_004">match the</span><span class="cls_007"> system</span><span class="cls_004"> field of the derivation. A Nix installation on an</span><span class="cls_007"> i686-linux</span><span class="cls_004"> machine</span></div>
<div style="position:absolute;left:88.78px;top:325.99px" class="cls_004"><span class="cls_004">cannot build a derivation for a</span><span class="cls_007"> powerpc-darwin</span><span class="cls_004"> machine. The platform type of the</span></div>
<div style="position:absolute;left:88.78px;top:337.94px" class="cls_004"><span class="cls_004">running Nix instance is denoted by</span><span class="cls_007"> thisSystem</span><span class="cls_004">. However, Section 5.5.2 describes an</span></div>
<div style="position:absolute;left:88.78px;top:349.90px" class="cls_004"><span class="cls_004">extension to the build algorithm that enables distributed multi-platform builds.</span></div>
<div style="position:absolute;left:74.43px;top:373.81px" class="cls_056"><span class="cls_056">77</span></div>
<div style="position:absolute;left:88.78px;top:371.81px" class="cls_004"><span class="cls_004">It is possible that the output path already exists, even though it is not valid. Typically,</span></div>
<div style="position:absolute;left:88.78px;top:383.77px" class="cls_004"><span class="cls_004">this is because a previous build was interrupted before the builder finished or before</span></div>
<div style="position:absolute;left:88.78px;top:395.72px" class="cls_004"><span class="cls_004">the output could be registered as valid. Such a residual output can interfere with the</span></div>
<div style="position:absolute;left:88.78px;top:407.68px" class="cls_004"><span class="cls_004">build, and therefore must be deleted first.</span></div>
<div style="position:absolute;left:74.43px;top:431.59px" class="cls_056"><span class="cls_056">78</span></div>
<div style="position:absolute;left:88.78px;top:429.60px" class="cls_004"><span class="cls_004">Builds are executed in a temporary directory p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004"> that is created here (typically, it is</span></div>
<div style="position:absolute;left:88.78px;top:441.55px" class="cls_004"><span class="cls_004">a fresh subdirectory of</span><span class="cls_007"> /tmp</span><span class="cls_004">). p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004"> is deleted automatically after the builder finishes</span></div>
<div style="position:absolute;left:88.78px;top:453.51px" class="cls_004"><span class="cls_004">(not shown here). The temporary directory provides a place where the builder can</span></div>
<div style="position:absolute;left:88.78px;top:465.46px" class="cls_004"><span class="cls_004">write scratch data. For instance, the unpacking and compiling of the Hello sources</span></div>
<div style="position:absolute;left:88.78px;top:477.42px" class="cls_004"><span class="cls_004">performed by the Hello builder in Figure 2.7 is done in the temporary directory.</span></div>
<div style="position:absolute;left:88.78px;top:489.37px" class="cls_004"><span class="cls_004">The fact that the temporary directory is initially empty reduces the possibility of</span></div>
<div style="position:absolute;left:88.78px;top:501.33px" class="cls_004"><span class="cls_004">interference due to files pre-existing in the builder’s initial current directory.</span></div>
<div style="position:absolute;left:74.43px;top:525.24px" class="cls_056"><span class="cls_056">79</span></div>
<div style="position:absolute;left:88.78px;top:523.25px" class="cls_004"><span class="cls_004">Here we actually perform the build by running the executable indicated by the</span><span class="cls_007"> builder</span></div>
<div style="position:absolute;left:88.78px;top:535.20px" class="cls_004"><span class="cls_004">field of the derivation, with the command-line arguments</span><span class="cls_007"> args</span><span class="cls_004"> and the environment</span></div>
<div style="position:absolute;left:88.78px;top:547.16px" class="cls_004"><span class="cls_004">variables</span><span class="cls_007"> envVars</span><span class="cls_004">, and with the current directory set to p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004">.  Note that</span><span class="cls_007"> envVars</span></div>
<div style="position:absolute;left:88.78px;top:559.11px" class="cls_004"><span class="cls_004">specifies the complete environment; the builder does not inherit any environment</span></div>
<div style="position:absolute;left:88.78px;top:571.07px" class="cls_004"><span class="cls_004">variables from the caller of the Nix process user. This prevents interference from</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_004"><span class="cls_004">environment variables such as</span><span class="cls_007"> PATH</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">111</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:80730px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background120.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5.</span></div>
<div style="position:absolute;left:72.17px;top:17.14px" class="cls_004"><span class="cls_004">The Extensional Model</span></div>
<div style="position:absolute;left:84.62px;top:45.04px" class="cls_004"><span class="cls_004">In the real implementation some additional variables are initialised to specific val-</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">ues. The variable</span><span class="cls_007"> TMPDIR</span><span class="cls_004"> is set to p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004"> so that tools that need temporary space write</span></div>
<div style="position:absolute;left:84.62px;top:68.95px" class="cls_004"><span class="cls_004">to that directory, reducing the possibility of interference, left-over files, and security</span></div>
<div style="position:absolute;left:84.62px;top:80.90px" class="cls_004"><span class="cls_004">problems due to</span><span class="cls_007"> /tmp</span><span class="cls_004"> races. The variable</span><span class="cls_007"> HOME</span><span class="cls_004">, which points to the user’s home</span></div>
<div style="position:absolute;left:84.62px;top:92.86px" class="cls_004"><span class="cls_004">directory, is set to the meaningless value</span><span class="cls_007"> /homeless-shelter</span><span class="cls_004">. Many programs look</span></div>
<div style="position:absolute;left:84.62px;top:104.82px" class="cls_004"><span class="cls_004">up the home directory corresponding to the current user ID in</span><span class="cls_007"> /etc/passwd</span><span class="cls_004"> or similar</span></div>
<div style="position:absolute;left:84.62px;top:116.77px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> HOME</span><span class="cls_004"> is not set. Setting</span><span class="cls_007"> HOME</span><span class="cls_004"> prevents such lookups and reduces the possibil-</span></div>
<div style="position:absolute;left:84.62px;top:128.73px" class="cls_004"><span class="cls_004">ity of interference from tools that read configuration files from the home directory.</span></div>
<div style="position:absolute;left:84.62px;top:140.68px" class="cls_004"><span class="cls_004">Likewise,</span><span class="cls_007"> PATH</span><span class="cls_004"> is set to the value</span><span class="cls_007"> /path-not-set</span><span class="cls_004">, since the Unix shell initialises</span><span class="cls_007"> PATH</span></div>
<div style="position:absolute;left:84.62px;top:152.64px" class="cls_004"><span class="cls_004">to an undesirable default such as</span><span class="cls_007"> /usr/local/bin:/bin:/usr/bin</span><span class="cls_004">, which typically causes</span></div>
<div style="position:absolute;left:84.62px;top:164.59px" class="cls_004"><span class="cls_004">interference. Finally, the variable</span><span class="cls_007"> NIX_STORE</span><span class="cls_004"> is set to storeDir. Some tools need</span></div>
<div style="position:absolute;left:84.62px;top:176.55px" class="cls_004"><span class="cls_004">the location of the store for various purposes (see, e.g., Section 7.1.3).</span></div>
<div style="position:absolute;left:70.28px;top:200.06px" class="cls_056"><span class="cls_056">80</span></div>
<div style="position:absolute;left:84.62px;top:198.07px" class="cls_004"><span class="cls_004">If the build finishes successfully, the output is canonicalised by the function</span><span class="cls_007"> canon-</span></div>
<div style="position:absolute;left:84.62px;top:210.02px" class="cls_007"><span class="cls_007">icalisePathContents</span><span class="cls_004">. It sets all file system meta-information not represented in the</span></div>
<div style="position:absolute;left:84.62px;top:221.98px" class="cls_004"><span class="cls_004">canonical serialisation to fixed values. In particular, it does the following:</span></div>
<div style="position:absolute;left:96.58px;top:243.50px" class="cls_004"><span class="cls_004">- The “last modified” timestamps on files are set to 0 seconds in the Unix epoch,</span></div>
<div style="position:absolute;left:106.54px;top:255.45px" class="cls_004"><span class="cls_004">meaning 1/1/1970 00:00:00 UTC.</span></div>
<div style="position:absolute;left:96.58px;top:272.19px" class="cls_004"><span class="cls_004">- The permission on each file is set to octal 0444 or 0555, meaning that the file</span></div>
<div style="position:absolute;left:106.54px;top:284.14px" class="cls_004"><span class="cls_004">is readable by everyone and writable by nobody, but possibly has execute per-</span></div>
<div style="position:absolute;left:106.54px;top:296.10px" class="cls_004"><span class="cls_004">mission. Removing write permission prevents the path from being accidentally</span></div>
<div style="position:absolute;left:106.54px;top:308.05px" class="cls_004"><span class="cls_004">modified when it is used as an input to other derivations.</span></div>
<div style="position:absolute;left:96.58px;top:324.79px" class="cls_004"><span class="cls_004">- Special permissions, such as set-user-ID and set-group-ID [152], are removed.</span></div>
<div style="position:absolute;left:96.58px;top:341.53px" class="cls_004"><span class="cls_004">- A fatal error is flagged if a file is found that is not a regular file, a directory, or</span></div>
<div style="position:absolute;left:106.54px;top:353.48px" class="cls_004"><span class="cls_004">a symlink.</span></div>
<div style="position:absolute;left:84.62px;top:375.00px" class="cls_004"><span class="cls_004">The actual implementation of</span><span class="cls_007"> canonicalisePathContents</span><span class="cls_004">(p) is not shown here, but</span></div>
<div style="position:absolute;left:84.62px;top:386.96px" class="cls_004"><span class="cls_004">in its effect is equal to deserialising a canonical serialisation of the path:</span></div>
<div style="position:absolute;left:109.53px;top:409.67px" class="cls_007"><span class="cls_007">writePath</span><span class="cls_004">(p,</span><span class="cls_007"> readPath</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:84.62px;top:432.39px" class="cls_004"><span class="cls_004">where</span><span class="cls_007"> writePath</span><span class="cls_004"> takes care to create files with canonical values for meta-information</span></div>
<div style="position:absolute;left:84.62px;top:444.34px" class="cls_004"><span class="cls_004">not represented in the canonical serialisation.</span></div>
<div style="position:absolute;left:70.28px;top:467.85px" class="cls_056"><span class="cls_056">81</span></div>
<div style="position:absolute;left:84.62px;top:465.86px" class="cls_004"><span class="cls_004">If d is a fixed-output derivation (Section 5.4.1), then we have to check that the output</span></div>
<div style="position:absolute;left:84.62px;top:477.82px" class="cls_004"><span class="cls_004">produced by the builder matches the cryptographic hash declared in the derivation.</span></div>
<div style="position:absolute;left:84.62px;top:489.77px" class="cls_004"><span class="cls_004">Recall that there are two modes of fixed-output derivation: flat mode that requires the</span></div>
<div style="position:absolute;left:84.62px;top:501.73px" class="cls_004"><span class="cls_004">output to be single non-executable file, and recursive mode that applies to arbitrary</span></div>
<div style="position:absolute;left:84.62px;top:513.68px" class="cls_004"><span class="cls_004">outputs.  Flat mode hashes the plain file contents (read by the function</span><span class="cls_007"> readFile</span><span class="cls_004">),</span></div>
<div style="position:absolute;left:84.62px;top:525.64px" class="cls_004"><span class="cls_004">while recursive mode hashes the serialisation of the entire FSO.</span></div>
<div style="position:absolute;left:70.28px;top:549.15px" class="cls_056"><span class="cls_056">82</span></div>
<div style="position:absolute;left:84.62px;top:547.16px" class="cls_004"><span class="cls_004">Since the build has finished successfully, we must register the path as valid and set its</span></div>
<div style="position:absolute;left:84.62px;top:559.11px" class="cls_004"><span class="cls_004">references mapping. This must be done in a database transaction to maintain the in-</span></div>
<div style="position:absolute;left:84.62px;top:571.07px" class="cls_004"><span class="cls_004">variants. Thanks to the ACID properties of the underlying Berkeley DB database, it</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">is always safe to interrupt any Nix operation, and Nix can always recover gracefully</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">112</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:81420px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background121.jpg" width=481 height=680></div>
<div style="position:absolute;left:299.25px;top:17.14px" class="cls_004"><span class="cls_004">5.5. Building store derivations</span></div>
<div style="position:absolute;left:72.24px;top:46.83px" class="cls_007"><span class="cls_007">scanForReferences</span><span class="cls_004">(p, paths) :</span></div>
<div style="position:absolute;left:87.19px;top:58.79px" class="cls_004"><span class="cls_004">c ← </span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:87.19px;top:70.74px" class="cls_004"><span class="cls_004">refs ← 0</span></div>
<div style="position:absolute;left:87.19px;top:81.67px" class="cls_004"><span class="cls_004">for each p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ∈ paths :</span></div>
<div style="position:absolute;left:102.13px;top:93.63px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> find</span><span class="cls_004">(c,</span><span class="cls_007"> hashPart</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">)) = 0 :</span></div>
<div style="position:absolute;left:136.39px;top:105.86px" class="cls_012"><span class="cls_012">∪</span></div>
<div style="position:absolute;left:117.07px;top:108.91px" class="cls_004"><span class="cls_004">refs</span></div>
<div style="position:absolute;left:133.86px;top:107.88px" class="cls_004"><span class="cls_004">←{p</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:159.28px;top:108.91px" class="cls_004"><span class="cls_004">}</span></div>
<div style="position:absolute;left:87.19px;top:120.86px" class="cls_004"><span class="cls_004">return refs</span></div>
<div style="position:absolute;left:75.59px;top:145.55px" class="cls_004"><span class="cls_004">Figure 5.12.:</span><span class="cls_007"> scanForReferences</span><span class="cls_004">: Scanning for store path references in build results</span></div>
<div style="position:absolute;left:88.78px;top:178.66px" class="cls_004"><span class="cls_004">from non-corrupting crashes, including power failures. In the case of operating sys-</span></div>
<div style="position:absolute;left:88.78px;top:190.62px" class="cls_004"><span class="cls_004">tem or hardware crashes, this requires the file system containing the Nix store to be</span></div>
<div style="position:absolute;left:88.78px;top:202.57px" class="cls_004"><span class="cls_004">data-journaled [142], or to otherwise guarantee that once data has been committed</span></div>
<div style="position:absolute;left:88.78px;top:214.53px" class="cls_004"><span class="cls_004">to disk, no rollback to previous contents will occur.</span></div>
<div style="position:absolute;left:88.78px;top:231.54px" class="cls_004"><span class="cls_004">Following the stored hash invariant (page 96), the</span><span class="cls_007"> valid</span><span class="cls_004"> entry for the output path is</span></div>
<div style="position:absolute;left:88.78px;top:243.50px" class="cls_004"><span class="cls_004">set to the SHA-256 of the serialisation of the path contents.</span></div>
<div style="position:absolute;left:88.78px;top:260.51px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> references</span><span class="cls_004"> entry is set to the set of store paths referenced from the output con-</span></div>
<div style="position:absolute;left:88.78px;top:272.46px" class="cls_004"><span class="cls_004">tents. As described in Chapter 3, the references are found by scanning for the hash</span></div>
<div style="position:absolute;left:88.78px;top:284.42px" class="cls_004"><span class="cls_004">parts of the input paths. The set of input paths is the union of the closures of the</span></div>
<div style="position:absolute;left:88.78px;top:296.37px" class="cls_004"><span class="cls_004">input sources</span><span class="cls_014"> </span><span class="cls_056">74</span><span class="cls_059"> </span><span class="cls_004"> and the outputs of the input derivations</span><span class="cls_014"> </span><span class="cls_056">73</span><span class="cls_059"> </span><span class="cls_004">. Note that it is quite</span></div>
<div style="position:absolute;left:88.78px;top:308.33px" class="cls_004"><span class="cls_004">possible for the output to contain a reference to a path that is not in</span><span class="cls_007"> inputSrcs</span><span class="cls_004"> or</span></div>
<div style="position:absolute;left:88.78px;top:320.28px" class="cls_007"><span class="cls_007">inputDrvs</span><span class="cls_004">, but that is in the closure of those paths. Such a reference can be obtained</span></div>
<div style="position:absolute;left:88.78px;top:332.24px" class="cls_004"><span class="cls_004">by the builder indirectly by dereferencing one of its immediate inputs.  Given the</span></div>
<div style="position:absolute;left:88.78px;top:344.19px" class="cls_004"><span class="cls_004">full set of input paths, the function</span><span class="cls_007"> scanForReferences</span><span class="cls_004"> returns the set of referenced</span></div>
<div style="position:absolute;left:88.78px;top:356.15px" class="cls_004"><span class="cls_004">paths.</span></div>
<div style="position:absolute;left:88.78px;top:373.16px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> deriver</span><span class="cls_004"> mapping maintains a link from outputs to the derivations that built them.</span></div>
<div style="position:absolute;left:88.78px;top:385.11px" class="cls_004"><span class="cls_004">It is described below.</span></div>
<div style="position:absolute;left:63.87px;top:414.58px" class="cls_009"><span class="cls_009">Scanning for references</span><span class="cls_004">   The function</span><span class="cls_007"> scanForReferences</span><span class="cls_004">, shown in Figure 5.12, de-</span></div>
<div style="position:absolute;left:63.87px;top:426.53px" class="cls_004"><span class="cls_004">termines the references in a path p to other store paths.</span></div>
<div style="position:absolute;left:73.84px;top:439.03px" class="cls_004"><span class="cls_004">We only need to scan for store paths that are inputs, i.e., that are in the closure of</span><span class="cls_007"> in-</span></div>
<div style="position:absolute;left:63.87px;top:450.98px" class="cls_007"><span class="cls_007">putSrcs</span><span class="cls_004"> and the outputs of</span><span class="cls_007"> inputDrvs</span><span class="cls_004">. It is not necessary to scan for references to arbitrary</span></div>
<div style="position:absolute;left:63.87px;top:462.94px" class="cls_004"><span class="cls_004">store paths, since the only way that a builder can introduce a reference to a path not in the</span></div>
<div style="position:absolute;left:63.87px;top:474.89px" class="cls_004"><span class="cls_004">input set, is if it were to read the Nix store to obtain arbitrary store paths. While it is easy</span></div>
<div style="position:absolute;left:63.87px;top:486.85px" class="cls_004"><span class="cls_004">to construct a contrived builder that does this, builders do not do so in practice. Indeed,</span></div>
<div style="position:absolute;left:63.87px;top:498.80px" class="cls_004"><span class="cls_004">if this were an issue, we could block such behaviour by making the Nix store unreadable</span></div>
<div style="position:absolute;left:63.87px;top:510.76px" class="cls_004"><span class="cls_004">but traversable (i.e., by clearing read permission but enabling execute permission on the</span></div>
<div style="position:absolute;left:63.87px;top:522.71px" class="cls_004"><span class="cls_004">directory on Unix systems).</span></div>
<div style="position:absolute;left:73.84px;top:535.20px" class="cls_004"><span class="cls_004">Thus</span><span class="cls_007"> scanForReferences</span><span class="cls_004"> also takes a set of potentially referenced paths. It then searches</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">for the hash part of each path in the serialisation of the contents of the FSO at p. To re-</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">iterate from Section 3.4, we only care about the hash part because that’s the most easily</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">identifiable part of a store path, and least likely to be hidden in some way. The search for</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">the hash part is done using an ordinary string searching algorithm, denoted as</span><span class="cls_007"> find</span><span class="cls_004">(s,t),</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">113</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:82110px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background122.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">which yields the integer offsets of the occurrences of the byte sequence t in the byte se-</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">quence s (an empty set indicating no matches). If and only if there is a match, we conclude</span></div>
<div style="position:absolute;left:59.72px;top:67.92px" class="cls_004"><span class="cls_004">that path p has a reference to the store path p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:81.96px" class="cls_004"><span class="cls_004">For the string search, the Boyer-Moore algorithm [18] is particularly suited because the</span></div>
<div style="position:absolute;left:59.72px;top:93.91px" class="cls_004"><span class="cls_004">hash parts consist of a small subset of the set of byte values, allowing the algorithm to</span></div>
<div style="position:absolute;left:59.72px;top:105.87px" class="cls_004"><span class="cls_004">jump through the input quickly in many cases. For instance, if we encounter any byte not</span></div>
<div style="position:absolute;left:59.72px;top:117.82px" class="cls_004"><span class="cls_004">in the set of base-32 characters (see</span><span class="cls_007"> digits</span><span class="cls_012"><sub>32</sub></span><span class="cls_004"> in Section 5.1), we can immediately skip 32</span></div>
<div style="position:absolute;left:59.72px;top:129.78px" class="cls_004"><span class="cls_004">characters. Especially for binary files this will happen quite often. Thus it is reasonable to</span></div>
<div style="position:absolute;left:59.72px;top:141.73px" class="cls_004"><span class="cls_004">expect that the search achieves Boyer-Moore’s Θ(n/m) average running time in most cases</span></div>
<div style="position:absolute;left:59.72px;top:153.69px" class="cls_004"><span class="cls_004">(where n is the length of the serialisation in bytes, and m is the length of the hash part).</span></div>
<div style="position:absolute;left:69.68px;top:166.70px" class="cls_004"><span class="cls_004">If it is desirable to support encodings of the hash part other than plain ASCII (and to</span></div>
<div style="position:absolute;left:59.72px;top:178.65px" class="cls_004"><span class="cls_004">date, it has not been necessary to do),</span><span class="cls_007"> scanForReferences</span><span class="cls_004"> can be adapted appropriately.</span></div>
<div style="position:absolute;left:59.72px;top:190.61px" class="cls_004"><span class="cls_004">For instance, to detect UTF-16 encodings of the hash part, we should just scan for the byte</span></div>
<div style="position:absolute;left:59.72px;top:201.54px" class="cls_004"><span class="cls_004">sequence s[0] 0 s[1] 0 s[2] 0 . . . s[31] 0, where s =</span><span class="cls_007"> hashPart</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">), p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ∈ paths, and 0 denotes</span></div>
<div style="position:absolute;left:59.72px;top:213.49px" class="cls_004"><span class="cls_004">a byte with value 0</span><span class="cls_012"><sup>8</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:59.72px;top:246.84px" class="cls_009"><span class="cls_009">Traceability</span><span class="cls_004">   For many applications it is important to query which derivation built a given</span></div>
<div style="position:absolute;left:59.72px;top:258.79px" class="cls_004"><span class="cls_004">store path (if any). Section 11.1 gives the example of blacklisting, which allows users to</span></div>
<div style="position:absolute;left:59.72px;top:270.75px" class="cls_004"><span class="cls_004">determine whether the build graph of a component contains certain “bad” sources.  In</span></div>
<div style="position:absolute;left:59.72px;top:282.71px" class="cls_004"><span class="cls_004">Software Configuration Management, this is known as traceability—the ability to trace</span></div>
<div style="position:absolute;left:59.72px;top:294.66px" class="cls_004"><span class="cls_004">derived artifacts back to the source artifacts from which they were constructed.</span></div>
<div style="position:absolute;left:69.68px;top:307.67px" class="cls_004"><span class="cls_004">To enable traceability, Nix maintains a database table</span><span class="cls_007"> deriver</span><span class="cls_004"> :</span><span class="cls_007"> Path</span><span class="cls_004"> →</span><span class="cls_007"> Path</span><span class="cls_004">  that maps</span></div>
<div style="position:absolute;left:59.72px;top:319.62px" class="cls_004"><span class="cls_004">output paths built by derivations to those derivations. The following invariant maintains</span></div>
<div style="position:absolute;left:59.72px;top:331.58px" class="cls_004"><span class="cls_004">traceability.</span></div>
<div style="position:absolute;left:59.72px;top:354.67px" class="cls_004"><span class="cls_004">Invariant 5 (Traceability invariant). The deriver of a valid path p, if defined, must be a</span></div>
<div style="position:absolute;left:59.72px;top:366.62px" class="cls_004"><span class="cls_004">valid store derivation with output path p.</span></div>
<div style="position:absolute;left:84.62px;top:390.65px" class="cls_004"><span class="cls_004">∀p ∈ </span><span class="cls_007">Path </span><span class="cls_004">: (</span><span class="cls_007">valid</span><span class="cls_004">[p] = ε ∧</span><span class="cls_007">deriver</span><span class="cls_004">[p] = ε) →</span></div>
<div style="position:absolute;left:94.59px;top:405.59px" class="cls_004"><span class="cls_004">(</span><span class="cls_007">valid</span><span class="cls_004">[</span><span class="cls_007">deriver</span><span class="cls_004">[p]] = ε ∧</span><span class="cls_007"> parseDrv</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(</span><span class="cls_007">deriver</span><span class="cls_004">[p])).</span><span class="cls_007">output</span><span class="cls_004"> = p)</span></div>
<div style="position:absolute;left:69.68px;top:430.67px" class="cls_004"><span class="cls_004">However, this invariant is actually optional in the current implementation, because not</span></div>
<div style="position:absolute;left:59.72px;top:442.62px" class="cls_004"><span class="cls_004">all users want traceability. The disadvantage of full traceability is that the entire derivation</span></div>
<div style="position:absolute;left:59.72px;top:454.58px" class="cls_004"><span class="cls_004">graph of each output path has to be kept in the store for the lifetime of those paths.</span></div>
<div style="position:absolute;left:69.68px;top:467.59px" class="cls_004"><span class="cls_004">It is worth noting at this point that Nix in no way maintains a link between the build</span></div>
<div style="position:absolute;left:59.72px;top:479.54px" class="cls_004"><span class="cls_004">graph (store derivations and sources) in the Nix store on the one hand, and the Nix expres-</span></div>
<div style="position:absolute;left:59.72px;top:491.50px" class="cls_004"><span class="cls_004">sions from which they were instantiated on the other hand. If the latter are under version</span></div>
<div style="position:absolute;left:59.72px;top:503.45px" class="cls_004"><span class="cls_004">management control, there is no way to trace store paths back to the artifacts in the version</span></div>
<div style="position:absolute;left:59.72px;top:515.41px" class="cls_004"><span class="cls_004">management system from which they ultimately originated. This is most certainly a desir-</span></div>
<div style="position:absolute;left:59.72px;top:527.36px" class="cls_004"><span class="cls_004">able feature, but it is not clear how such information can be maintained without coupling</span></div>
<div style="position:absolute;left:59.72px;top:539.32px" class="cls_004"><span class="cls_004">Nix too closely to the version management system (as is the case in Vesta and ClearCase,</span></div>
<div style="position:absolute;left:59.72px;top:551.27px" class="cls_004"><span class="cls_004">which integrate version management and build management, as discussed in Section 7.6).</span></div>
<div style="position:absolute;left:64.20px;top:574.65px" class="cls_013"><span class="cls_013"><sup>8</sup></span><span class="cls_014">This assumes a little-endian encoding of UTF-16 (i.e., UTF-16LE) [34].  For the big-endian variant (UTF-</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">16BE), the 0s should prefix the hash characters.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">114</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:82800px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background123.jpg" width=481 height=680></div>
<div style="position:absolute;left:299.25px;top:17.14px" class="cls_004"><span class="cls_004">5.5.</span></div>
<div style="position:absolute;left:319.17px;top:17.14px" class="cls_004"><span class="cls_004">Building store derivations</span></div>
<div style="position:absolute;left:67.26px;top:49.95px" class="cls_015"><span class="cls_015">let  {</span></div>
<div style="position:absolute;left:76.67px;top:60.90px" class="cls_015"><span class="cls_015">pkgsLinux  =  ...;</span></div>
<div style="position:absolute;left:76.67px;top:71.86px" class="cls_015"><span class="cls_015">pkgsDarwin  =  ...;</span></div>
<div style="position:absolute;left:76.67px;top:93.78px" class="cls_015"><span class="cls_015">fooC  =  derivation  {</span></div>
<div style="position:absolute;left:86.09px;top:104.74px" class="cls_015"><span class="cls_015">name  =  "fooC";</span></div>
<div style="position:absolute;left:86.09px;top:115.70px" class="cls_015"><span class="cls_015">system  =  "i686-linux";</span></div>
<div style="position:absolute;left:86.09px;top:126.66px" class="cls_015"><span class="cls_015">src  =  ./foo.tar.gz;</span></div>
<div style="position:absolute;left:86.09px;top:137.62px" class="cls_015"><span class="cls_015">builder  =  ...;</span></div>
<div style="position:absolute;left:86.09px;top:148.58px" class="cls_015"><span class="cls_015">inherit  (pkgsLinux)  stdenv  ...  tiger;</span></div>
<div style="position:absolute;left:76.67px;top:159.53px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:76.67px;top:181.45px" class="cls_015"><span class="cls_015">fooBin  =  derivation  {</span></div>
<div style="position:absolute;left:86.09px;top:192.41px" class="cls_015"><span class="cls_015">name  =  "foo";</span></div>
<div style="position:absolute;left:86.09px;top:203.37px" class="cls_015"><span class="cls_015">system  =  "powerpc-darwin";</span></div>
<div style="position:absolute;left:86.09px;top:214.33px" class="cls_015"><span class="cls_015">src  =  fooC;</span></div>
<div style="position:absolute;left:86.09px;top:225.29px" class="cls_015"><span class="cls_015">builder  =  ...;</span></div>
<div style="position:absolute;left:86.09px;top:236.25px" class="cls_015"><span class="cls_015">inherit  (pkgsDarwin)  stdenv  ...;</span></div>
<div style="position:absolute;left:76.67px;top:247.21px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:76.67px;top:269.12px" class="cls_015"><span class="cls_015">body  =  fooBin;</span></div>
<div style="position:absolute;left:67.26px;top:280.08px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:127.05px;top:296.67px" class="cls_004"><span class="cls_004">Figure 5.13.: Example of a distributed, two-platform build</span></div>
<div style="position:absolute;left:63.87px;top:325.77px" class="cls_008"><span class="cls_008">5.5.2. Distributed builds</span></div>
<div style="position:absolute;left:63.87px;top:345.24px" class="cls_004"><span class="cls_004">The build algorithm in Figure 5.11 builds derivations only for the current platform (</span><span class="cls_007">thisSys-</span></div>
<div style="position:absolute;left:63.87px;top:357.20px" class="cls_007"><span class="cls_007">tem</span><span class="cls_004">). Through a relatively simple extension called build hooks, Nix supports distributed</span></div>
<div style="position:absolute;left:63.87px;top:369.15px" class="cls_004"><span class="cls_004">multi-platform builds.</span></div>
<div style="position:absolute;left:73.84px;top:381.11px" class="cls_004"><span class="cls_004">Figure 5.13 shows a hypothetical example of a Nix expression that requires a distributed</span></div>
<div style="position:absolute;left:63.87px;top:393.06px" class="cls_004"><span class="cls_004">multi-platform capable build system. The scenario is that we want to compile a package</span></div>
<div style="position:absolute;left:63.87px;top:405.02px" class="cls_007"><span class="cls_007">foo</span><span class="cls_004">, written in a hypothetical language called Tiger, for Mac OS X (</span><span class="cls_007">powerpc-darwin</span><span class="cls_004">). Un-</span></div>
<div style="position:absolute;left:63.87px;top:416.97px" class="cls_004"><span class="cls_004">fortunately, the Tiger compiler does not run on that platform, but it does run on Linux</span></div>
<div style="position:absolute;left:63.87px;top:428.93px" class="cls_004"><span class="cls_004">(</span><span class="cls_007">i686-linux</span><span class="cls_004">) and can compile to C code. Thus, we have two derivations. The first derivation</span></div>
<div style="position:absolute;left:63.87px;top:440.88px" class="cls_004"><span class="cls_004">compiles the</span><span class="cls_007"> foo</span><span class="cls_004"> package to C code on</span><span class="cls_007"> i686-linux</span><span class="cls_004">, and produces an output consisting of C</span></div>
<div style="position:absolute;left:63.87px;top:452.84px" class="cls_004"><span class="cls_004">source files. The second derivation compiles the C sources produced by the first derivation</span></div>
<div style="position:absolute;left:63.87px;top:464.79px" class="cls_004"><span class="cls_004">to native PowerPC code on</span><span class="cls_007"> powerpc-darwin</span><span class="cls_004">. With the build hook mechanism, we can just</span></div>
<div style="position:absolute;left:63.87px;top:476.75px" class="cls_004"><span class="cls_004">build the second derivation on any machine normally, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:498.78px" class="cls_015"><span class="cls_015">$ nix-env  -f  foo.nix  -i  foo</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">and any derivation that cannot be executed on the local machine is forwarded to a machine</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">of the appropriate type. In this way, build hooks allow us to abstract over multi-platform</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">builds.  It is not necessary for the user to interact explicitly with the various machines</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">involved in the build. In Section 9.4 we will see a powerful application of this: building</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">distributed multi-platform services.</span></div>
<div style="position:absolute;left:73.84px;top:571.07px" class="cls_004"><span class="cls_004">Build hooks are useful not just for multi-platform builds, but also to accelerate large</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">single-platform builds. For instance, Nixpkgs contains hundreds of components that need</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">115</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:83490px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background124.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">to be built for</span><span class="cls_007"> i686-linux</span><span class="cls_004">, and many of those derivations can be scheduled in parallel since</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">they do not depend on each other. The build hook mechanism allows as many derivations</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">as possible to run in parallel on the available hardware of that type.</span></div>
<div style="position:absolute;left:69.68px;top:80.90px" class="cls_004"><span class="cls_004">A build hook is a user-defined program (typically written in a scripting language like</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">Perl) that is called by Nix to perform the build on behalf of Nix. The build hook mechanism</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">is policy-free, that is, it can do anything it wants, but a build hook typically does the</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">following things:</span></div>
<div style="position:absolute;left:74.66px;top:134.46px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:134.46px" class="cls_004"><span class="cls_004">It determines whether it knows a remote machine of the appropriate platform type</span></div>
<div style="position:absolute;left:84.62px;top:146.41px" class="cls_004"><span class="cls_004">that can handle the derivation.  If not, it refuses the job, and the calling Nix pro-</span></div>
<div style="position:absolute;left:84.62px;top:158.37px" class="cls_004"><span class="cls_004">cess executes the job normally, which is to say that it runs the builder if</span><span class="cls_007"> thisSystem</span></div>
<div style="position:absolute;left:84.62px;top:170.32px" class="cls_004"><span class="cls_004">matches d.</span><span class="cls_007">system</span><span class="cls_004">, and aborts otherwise.</span></div>
<div style="position:absolute;left:74.66px;top:189.13px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:189.13px" class="cls_004"><span class="cls_004">If an appropriate machine is known, the hook can either accept the job or tell the</span></div>
<div style="position:absolute;left:84.62px;top:201.08px" class="cls_004"><span class="cls_004">calling Nix process to postpone the job. The latter is appropriate if the load on the</span></div>
<div style="position:absolute;left:84.62px;top:213.04px" class="cls_004"><span class="cls_004">selected machine is too high: it is typical to allow no more jobs to run concurrently</span></div>
<div style="position:absolute;left:84.62px;top:224.99px" class="cls_004"><span class="cls_004">on a machine than the number of CPUs.  If the hook returns a “postpone” reply,</span></div>
<div style="position:absolute;left:84.62px;top:236.95px" class="cls_004"><span class="cls_004">the calling Nix process will wait for a while, or continue with some other derivation</span></div>
<div style="position:absolute;left:84.62px;top:248.90px" class="cls_004"><span class="cls_004">(this is not supported by the algorithm in Figure 5.11, but is supported by the parallel</span></div>
<div style="position:absolute;left:84.62px;top:260.86px" class="cls_004"><span class="cls_004">algorithm in Section 5.5.4).</span></div>
<div style="position:absolute;left:74.66px;top:279.66px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:279.66px" class="cls_004"><span class="cls_004">If the hook has accepted the job, the calling Nix process will create a temporary</span></div>
<div style="position:absolute;left:84.62px;top:291.62px" class="cls_004"><span class="cls_004">directory containing all information that the hook needs to perform the build, such</span></div>
<div style="position:absolute;left:84.62px;top:303.57px" class="cls_004"><span class="cls_004">as the store paths of the inputs and output.</span></div>
<div style="position:absolute;left:74.66px;top:322.38px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:322.38px" class="cls_004"><span class="cls_004">The hook copies the FSOs denoted by the input paths (the inputs set computed in</span></div>
<div style="position:absolute;left:84.62px;top:334.33px" class="cls_004"><span class="cls_004">Figure 5.11) to the Nix store on the target machine, and registers them as valid with</span></div>
<div style="position:absolute;left:84.62px;top:346.29px" class="cls_004"><span class="cls_004">the appropriate reference graph mappings. It is important that the Nix stores on both</span></div>
<div style="position:absolute;left:84.62px;top:358.24px" class="cls_004"><span class="cls_004">machines are in the same location in the file system. The derivation itself (at p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">) is</span></div>
<div style="position:absolute;left:84.62px;top:370.20px" class="cls_004"><span class="cls_004">also copied.</span></div>
<div style="position:absolute;left:74.66px;top:389.00px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:389.00px" class="cls_004"><span class="cls_004">The hook builds the derivation on the remote machine, e.g., by using the Secure</span></div>
<div style="position:absolute;left:84.62px;top:400.96px" class="cls_004"><span class="cls_004">Shell (</span><span class="cls_007">ssh</span><span class="cls_004">) protocol [61] to run</span><span class="cls_007"> nix-store --realise</span><span class="cls_004"> remotely.</span></div>
<div style="position:absolute;left:74.66px;top:419.76px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:419.76px" class="cls_004"><span class="cls_004">If the remote build succeeds, the output at d.</span><span class="cls_007">output</span><span class="cls_004"> in the Nix store of the remote</span></div>
<div style="position:absolute;left:84.62px;top:431.72px" class="cls_004"><span class="cls_004">machine is copied back to the local Nix store.</span></div>
<div style="position:absolute;left:69.68px;top:449.40px" class="cls_004"><span class="cls_004">When the hook finishes successfully, Nix proceeds normally as if it had executed the</span></div>
<div style="position:absolute;left:59.72px;top:461.36px" class="cls_004"><span class="cls_004">builder itself, i.e., by scanning for references in the output and registering path validity.</span></div>
<div style="position:absolute;left:69.68px;top:473.31px" class="cls_004"><span class="cls_004">As stated above, this is a policy-free mechanism: it doesn’t care how the build hook</span></div>
<div style="position:absolute;left:59.72px;top:485.27px" class="cls_004"><span class="cls_004">does its work. In general, the build hook will have some configuration file listing remote</span></div>
<div style="position:absolute;left:59.72px;top:497.22px" class="cls_004"><span class="cls_004">machines, authentication information to automatically log in to those machine, and so on.</span></div>
<div style="position:absolute;left:59.72px;top:509.18px" class="cls_004"><span class="cls_004">An example of a concrete build hook is given in the context of build farms in Section 8.3.</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_009"><span class="cls_009">Hook protocol</span><span class="cls_004">   A build hook is enabled by the user by pointing the environment variable</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_007"><span class="cls_007">NIX_BUILD_HOOK</span><span class="cls_004"> at the hook.  When Nix needs to perform a build, it first executes</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">the hook to discover whether it is able and willing to perform the build. Thus the build</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">algorithm in Figure 5.11 is augmented as shown in Figure 5.14. Nix calls the hook</span><span class="cls_014"> </span><span class="cls_056">84</span><span class="cls_004"> with</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">all information that the hook needs to determine whether it can handle the job, namely:</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">116</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:84180px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background125.jpg" width=481 height=680></div>
<div style="position:absolute;left:299.25px;top:17.14px" class="cls_004"><span class="cls_004">5.5. Building store derivations</span></div>
<div style="position:absolute;left:72.24px;top:46.83px" class="cls_007"><span class="cls_007">build</span><span class="cls_004">(p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">) :</span></div>
<div style="position:absolute;left:87.19px;top:58.79px" class="cls_004"><span class="cls_004">(...elided...)</span></div>
<div style="position:absolute;left:87.19px;top:70.74px" class="cls_004"><span class="cls_004">if the environment variable</span><span class="cls_007"> NIX_BUILD_HOOK</span><span class="cls_004"> is defined :</span></div>
<div style="position:absolute;left:102.88px;top:82.70px" class="cls_004"><span class="cls_004">p</span><span class="cls_012">tmp</span><span class="cls_004"> ←</span><span class="cls_007"> createTempDir</span><span class="cls_004">()</span></div>
<div style="position:absolute;left:102.13px;top:94.65px" class="cls_004"><span class="cls_004">Write inputs ∪</span><span class="cls_007"> closure</span><span class="cls_004">(p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">) to file p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004">/</span><span class="cls_007">inputs</span></div>
<div style="position:absolute;left:102.13px;top:106.61px" class="cls_004"><span class="cls_004">Write d.</span><span class="cls_007">output</span><span class="cls_004"> to file p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004">/</span><span class="cls_007">outputs</span></div>
<div style="position:absolute;left:102.13px;top:118.56px" class="cls_004"><span class="cls_004">Write the references of inputs to file p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004">/</span><span class="cls_007">references</span></div>
<div style="position:absolute;left:102.13px;top:130.52px" class="cls_004"><span class="cls_004">(fd</span><span class="cls_012"><sub>read</sub></span><span class="cls_004"> , fd</span><span class="cls_012"><sub>write</sub></span><span class="cls_004">) ←</span><span class="cls_007"> pipe</span><span class="cls_004">()</span><span class="cls_014"> </span><span class="cls_056">83</span></div>
<div style="position:absolute;left:102.13px;top:142.47px" class="cls_004"><span class="cls_004">Asynchronously start</span><span class="cls_007"> NIX_BUILD_HOOK</span><span class="cls_004"> in directory p</span><span class="cls_012"><sub>tmp</sub></span></div>
<div style="position:absolute;left:112.09px;top:154.43px" class="cls_004"><span class="cls_004">with fd</span><span class="cls_012"><sub>write</sub></span><span class="cls_004"> attached to file descriptor 3</span></div>
<div style="position:absolute;left:112.09px;top:166.38px" class="cls_004"><span class="cls_004">and arguments [0,</span><span class="cls_007"> thisSystem</span><span class="cls_004">, d.</span><span class="cls_007">system</span><span class="cls_004">, p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">]</span><span class="cls_014"> </span><span class="cls_056">84</span></div>
<div style="position:absolute;left:102.13px;top:178.34px" class="cls_004"><span class="cls_004">reply ← read a line from fd</span><span class="cls_012"><sub>read</sub></span></div>
<div style="position:absolute;left:102.13px;top:190.29px" class="cls_004"><span class="cls_004">if reply =</span><span class="cls_007"> "accept"</span><span class="cls_004"> then :</span></div>
<div style="position:absolute;left:117.07px;top:202.25px" class="cls_004"><span class="cls_004">Wait until the hook finishes</span></div>
<div style="position:absolute;left:117.07px;top:214.21px" class="cls_004"><span class="cls_004">if the hook exited with exit code = 0 : abort</span></div>
<div style="position:absolute;left:117.07px;top:226.16px" class="cls_004"><span class="cls_004">Scan and register the path as valid, as in Figure 5.11</span></div>
<div style="position:absolute;left:117.07px;top:238.12px" class="cls_004"><span class="cls_004">return</span></div>
<div style="position:absolute;left:102.13px;top:250.07px" class="cls_004"><span class="cls_004">else if reply =</span><span class="cls_007"> "postpone"</span><span class="cls_004"> then :</span></div>
<div style="position:absolute;left:117.07px;top:262.03px" class="cls_004"><span class="cls_004">Sleep a bit, then retry; see Section 5.5.4 for a better implementation.</span></div>
<div style="position:absolute;left:102.13px;top:274.08px" class="cls_004"><span class="cls_004">else if reply =</span><span class="cls_007"> "decline"</span><span class="cls_004"> then : abort</span></div>
<div style="position:absolute;left:102.13px;top:286.04px" class="cls_004"><span class="cls_004">Fall through to normal handling...</span></div>
<div style="position:absolute;left:87.19px;top:297.99px" class="cls_004"><span class="cls_004">if d.</span><span class="cls_007">system</span><span class="cls_004"> =</span><span class="cls_007"> thisSystem</span><span class="cls_004"> : abort</span></div>
<div style="position:absolute;left:87.19px;top:309.95px" class="cls_004"><span class="cls_004">(...elided...)</span></div>
<div style="position:absolute;left:80.99px;top:334.63px" class="cls_004"><span class="cls_004">Figure 5.14.: Augmentation of</span><span class="cls_007"> build</span><span class="cls_004"> in Figure 5.11 to add support for build hooks</span></div>
<div style="position:absolute;left:78.82px;top:367.05px" class="cls_004"><span class="cls_004">• A Boolean value signifying whether the calling Nix process can execute more build</span></div>
<div style="position:absolute;left:88.78px;top:379.00px" class="cls_004"><span class="cls_004">jobs right now.  This is applicable to the parallel build algorithm shown in Sec-</span></div>
<div style="position:absolute;left:88.78px;top:390.96px" class="cls_004"><span class="cls_004">tion 5.5.4 below, where Nix can execute a user-defined number of jobs in parallel.</span></div>
<div style="position:absolute;left:78.82px;top:411.61px" class="cls_004"><span class="cls_004">• The value of</span><span class="cls_007"> thisSystem</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:78.82px;top:432.27px" class="cls_004"><span class="cls_004">• The value of d.</span><span class="cls_007">system</span><span class="cls_004">. The hook needs this to determine whether it knows a remote</span></div>
<div style="position:absolute;left:88.78px;top:444.23px" class="cls_004"><span class="cls_004">machine of the appropriate type.</span></div>
<div style="position:absolute;left:78.82px;top:464.89px" class="cls_004"><span class="cls_004">• The store path of the derivation (p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">).</span></div>
<div style="position:absolute;left:73.84px;top:485.36px" class="cls_004"><span class="cls_004">In addition, Nix creates a temporary directory containing the following files:</span></div>
<div style="position:absolute;left:78.82px;top:505.84px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> inputs</span><span class="cls_004"> contains the store paths of all inputs, along with the closure of the store deriva-</span></div>
<div style="position:absolute;left:88.78px;top:517.79px" class="cls_004"><span class="cls_004">tion itself.</span></div>
<div style="position:absolute;left:78.82px;top:538.45px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> outputs</span><span class="cls_004"> contains the store path of the output. It is outputs, plural, to support multiple</span></div>
<div style="position:absolute;left:88.78px;top:550.41px" class="cls_004"><span class="cls_004">output paths as described in Section 6.7.</span></div>
<div style="position:absolute;left:78.82px;top:571.07px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> references</span><span class="cls_004"> contains a textual representation of the references mapping of the inputs.</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_004"><span class="cls_004">After copying the inputs to the target Nix store, the command</span><span class="cls_007"> nix-store --register-</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">117</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:84870px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background126.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:84.62px;top:45.04px" class="cls_007"><span class="cls_007">validity</span><span class="cls_004"> is used to register the validity of the copied paths on the target machine. This</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">command accepts a description of the references graph in exactly this format.</span></div>
<div style="position:absolute;left:69.68px;top:77.09px" class="cls_004"><span class="cls_004">A Unix pipe is created to communicate with the hook</span><span class="cls_014"> </span><span class="cls_056">83</span><span class="cls_059"> </span><span class="cls_004">. Its write side is attached to</span></div>
<div style="position:absolute;left:59.72px;top:89.04px" class="cls_004"><span class="cls_004">file descriptor 3 in the hook child process. The hook should print one the following strings</span></div>
<div style="position:absolute;left:59.72px;top:101.00px" class="cls_004"><span class="cls_004">on file descriptor 3 (followed by a linefeed character):</span></div>
<div style="position:absolute;left:74.66px;top:121.09px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> postpone</span><span class="cls_004"> indicates that the caller should wait, typically until another job has termi-</span></div>
<div style="position:absolute;left:84.62px;top:133.04px" class="cls_004"><span class="cls_004">nated, hopefully decreasing the load on the intended target machine(s).</span></div>
<div style="position:absolute;left:74.66px;top:153.19px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> decline</span><span class="cls_004"> means that the caller should try to build the derivation itself.</span></div>
<div style="position:absolute;left:74.66px;top:173.33px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> accept</span><span class="cls_004"> means that the hook has accepted the build job.</span></div>
<div style="position:absolute;left:69.68px;top:193.42px" class="cls_004"><span class="cls_004">If the hook accepts the job, it is responsible for producing output in d.</span><span class="cls_007">output</span><span class="cls_004">.  If it</span></div>
<div style="position:absolute;left:59.72px;top:205.38px" class="cls_004"><span class="cls_004">finishes successfully, the output path is registered as valid, with the references determined</span></div>
<div style="position:absolute;left:59.72px;top:217.33px" class="cls_004"><span class="cls_004">by</span><span class="cls_007"> scanForReferences</span><span class="cls_004">, just as in Figure 5.11.</span></div>
<div style="position:absolute;left:59.72px;top:245.36px" class="cls_008"><span class="cls_008">5.5.3. Substitutes</span></div>
<div style="position:absolute;left:59.72px;top:264.94px" class="cls_004"><span class="cls_004">Substitutes are the mechanism by which Nix enables its transparent source/binary deploy-</span></div>
<div style="position:absolute;left:59.72px;top:276.89px" class="cls_004"><span class="cls_004">ment paradigm, as we saw in Section 2.6. A substitute is an invocation of some arbitrary</span></div>
<div style="position:absolute;left:59.72px;top:288.85px" class="cls_004"><span class="cls_004">program that creates a store object through some other means than normal building. It is</span></div>
<div style="position:absolute;left:59.72px;top:300.80px" class="cls_004"><span class="cls_004">primarily used to obtain the output of a derivation by downloading a pre-built FSO from a</span></div>
<div style="position:absolute;left:59.72px;top:312.76px" class="cls_004"><span class="cls_004">server rather than building the derivation from source.</span></div>
<div style="position:absolute;left:69.68px;top:324.77px" class="cls_004"><span class="cls_004">The database mapping</span><span class="cls_007"> substitutes</span><span class="cls_004"> :</span><span class="cls_007"> Path</span><span class="cls_004"> → {(</span><span class="cls_007">Path</span><span class="cls_004">, [</span><span class="cls_007">String</span><span class="cls_004">],</span><span class="cls_007"> Path</span><span class="cls_004">)} stores the substitutes</span></div>
<div style="position:absolute;left:59.72px;top:336.72px" class="cls_004"><span class="cls_004">that have been registered by user commands. The left-hand side is the store path to which</span></div>
<div style="position:absolute;left:59.72px;top:348.68px" class="cls_004"><span class="cls_004">the substitutes apply.  The right-hand side is a set of substitutes.  Each substitute is a</span></div>
<div style="position:absolute;left:59.72px;top:360.63px" class="cls_004"><span class="cls_004">three-tuple (substituter, args, deriver), where substituter is the path of the program to be</span></div>
<div style="position:absolute;left:59.72px;top:372.59px" class="cls_004"><span class="cls_004">executed to perform the substitution, args are the command-line arguments to be passed</span></div>
<div style="position:absolute;left:59.72px;top:384.55px" class="cls_004"><span class="cls_004">to that program, and deriver is the store path of the derivation that produced the FSO on</span></div>
<div style="position:absolute;left:59.72px;top:396.50px" class="cls_004"><span class="cls_004">the originating machine. The latter is necessary to maintain the deriver link for traceability</span></div>
<div style="position:absolute;left:59.72px;top:408.46px" class="cls_004"><span class="cls_004">(on installations where this is enabled). An example entry in the</span><span class="cls_007"> substitutes</span><span class="cls_004"> mapping is:</span></div>
<div style="position:absolute;left:89.60px;top:430.05px" class="cls_007"><span class="cls_007">substitutes</span><span class="cls_004">[</span><span class="cls_007">"/nix/store/bwacc7a5c5n3...-hello-2.1.1"</span><span class="cls_004">] = {</span></div>
<div style="position:absolute;left:104.55px;top:442.01px" class="cls_004"><span class="cls_004">(</span><span class="cls_007">  "download-url.sh"</span></div>
<div style="position:absolute;left:105.10px;top:453.96px" class="cls_004"><span class="cls_004">,</span></div>
<div style="position:absolute;left:118.38px;top:453.96px" class="cls_004"><span class="cls_004">[</span><span class="cls_007">"<A HREF="http://example.org/1pc7y48cs3qn/">http://example.org/1pc7y48cs3qn</A> </span></div>
<div style="position:absolute;left:265.96px;top:453.96px" class="cls_007"><span class="cls_007">nar.bz2"</span><span class="cls_004">]</span></div>
<div style="position:absolute;left:105.10px;top:465.92px" class="cls_004"><span class="cls_004">,</span></div>
<div style="position:absolute;left:118.38px;top:466.91px" class="cls_007"><span class="cls_007">"/nix/store/1ja1w63wbk5q...-hello-2.1.1.drv"</span></div>
<div style="position:absolute;left:104.55px;top:477.87px" class="cls_004"><span class="cls_004">)</span></div>
<div style="position:absolute;left:89.60px;top:489.83px" class="cls_004"><span class="cls_004">}</span></div>
<div style="position:absolute;left:59.72px;top:511.24px" class="cls_004"><span class="cls_004">which establishes a single substitute: if we want to make path</span><span class="cls_007"> /nix/store/bwacc7a5c5n3...-</span></div>
<div style="position:absolute;left:59.72px;top:523.19px" class="cls_007"><span class="cls_007">hello-2.1.1</span><span class="cls_004"> valid, we can do so by executing the program</span><span class="cls_007"> download-url.sh</span><span class="cls_004"> with argument</span></div>
<div style="position:absolute;left:59.72px;top:536.14px" class="cls_007"><span class="cls_007"> </span><A HREF="http://example.org/1pc7y48cs3qn/">http://example.org/1pc7y48cs3qn</A> </div>
<div style="position:absolute;left:201.36px;top:535.15px" class="cls_007"><span class="cls_007">nar.bz2</span><span class="cls_004">.  Here</span><span class="cls_007"> download-url.sh</span><span class="cls_004"> is presumably a pro-</span></div>
<div style="position:absolute;left:59.72px;top:547.10px" class="cls_004"><span class="cls_004">gram that downloads a file from the given URL, and uncompresses and unpacks it to store</span></div>
<div style="position:absolute;left:59.72px;top:559.06px" class="cls_004"><span class="cls_004">path</span><span class="cls_007"> /nix/store/bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:571.07px" class="cls_004"><span class="cls_004">This is another example of a policy-free mechanism: Nix does not care how the sub-</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">stitute produces the store object. It can download from a server, interactively prompt the</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">118</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:85560px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background127.jpg" width=481 height=680></div>
<div style="position:absolute;left:299.25px;top:17.14px" class="cls_004"><span class="cls_004">5.5. Building store derivations</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">user to insert an installation CD, and so on. Indeed, there is no guarantee that a substitute</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">produces correct output, which is a problem for secure deployment. The intensional model</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">discussed in Chapter 6 addresses this issue. Section 7.3 discusses the implementation of a</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">concrete binary deployment scheme based on the substitute mechanism.</span></div>
<div style="position:absolute;left:73.84px;top:92.86px" class="cls_004"><span class="cls_004">The FSOs that we obtain through substitutes typically have references, of course. For</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">instance, the Hello binary in</span><span class="cls_007"> /nix/store/bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004"> has a reference to</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_007"><span class="cls_007">/nix/store/72by2iw5wd8i...-glibc-2.3.5</span><span class="cls_004">. To maintain the closure invariant, we must ensure</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">that the latter path is valid before we download the former. Thus, the references mapping</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">for a path must be known beforehand.  This means that when a substitute is registered,</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">the references for the path in question must also be registered. Formally, this gives us the</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">following invariant.</span></div>
<div style="position:absolute;left:63.87px;top:182.71px" class="cls_004"><span class="cls_004">Invariant 6 (Reference invariant). A path that is valid or substitutable is called a usable</span></div>
<div style="position:absolute;left:63.87px;top:194.66px" class="cls_004"><span class="cls_004">path. For all usable paths, the set of references must be known:</span></div>
<div style="position:absolute;left:88.78px;top:214.31px" class="cls_004"><span class="cls_004">∀p ∈ </span><span class="cls_007">Path </span><span class="cls_004">: (</span><span class="cls_007">valid</span><span class="cls_004">[p] = ε ∨</span><span class="cls_007">substitutes</span><span class="cls_004">[p] = ε) → </span><span class="cls_007">references</span><span class="cls_004">[p] = ε</span></div>
<div style="position:absolute;left:73.84px;top:233.97px" class="cls_004"><span class="cls_004">Note that the references entry for a valid or substitutable path can be the empty set ( 0),</span></div>
<div style="position:absolute;left:63.87px;top:245.92px" class="cls_004"><span class="cls_004">it just cannot be undefined (ε).</span></div>
<div style="position:absolute;left:73.84px;top:257.88px" class="cls_004"><span class="cls_004">The command</span><span class="cls_007"> nix-store --register-substitutes</span><span class="cls_004"> registers a set of substitutes, along with the</span></div>
<div style="position:absolute;left:63.87px;top:269.83px" class="cls_004"><span class="cls_004">references of the paths to which the substitutes apply. This command is used by concrete</span></div>
<div style="position:absolute;left:63.87px;top:281.79px" class="cls_004"><span class="cls_004">deployment policies such as</span><span class="cls_007"> nix-pull</span><span class="cls_004"> (Section 2.6). For example:</span></div>
<div style="position:absolute;left:88.78px;top:304.16px" class="cls_015"><span class="cls_015">$ nix-store  --register-substitutes</span></div>
<div style="position:absolute;left:88.78px;top:315.12px" class="cls_015"><span class="cls_015">/nix/store/bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:88.78px;top:326.08px" class="cls_015"><span class="cls_015">/nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span></div>
<div style="position:absolute;left:88.78px;top:337.04px" class="cls_015"><span class="cls_015">download-url.sh</span></div>
<div style="position:absolute;left:88.78px;top:348.00px" class="cls_015"><span class="cls_015">1</span></div>
<div style="position:absolute;left:88.78px;top:358.96px" class="cls_015"><span class="cls_015"> </span><A HREF="http://example.org/1pc7y48cs3qn/">http://example.org/1pc7y48cs3qn</A> </div>
<div style="position:absolute;left:253.50px;top:358.96px" class="cls_015"><span class="cls_015">nar.bz2</span></div>
<div style="position:absolute;left:88.78px;top:369.92px" class="cls_015"><span class="cls_015">3</span></div>
<div style="position:absolute;left:88.78px;top:380.87px" class="cls_015"><span class="cls_015">/nix/store/72by2iw5wd8i...-glibc-2.3.5</span></div>
<div style="position:absolute;left:88.78px;top:391.83px" class="cls_015"><span class="cls_015">/nix/store/bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:88.78px;top:402.79px" class="cls_015"><span class="cls_015">/nix/store/q2pw1vn87327...-gcc-3.4.4</span></div>
<div style="position:absolute;left:63.87px;top:415.65px" class="cls_004"><span class="cls_004">Here a substitute is registered for the path</span><span class="cls_007"> /nix/store/bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004"> that takes</span></div>
<div style="position:absolute;left:63.87px;top:427.60px" class="cls_004"><span class="cls_004">one argument and has three references. The substitute specification on standard input lists</span></div>
<div style="position:absolute;left:63.87px;top:439.56px" class="cls_004"><span class="cls_004">the store path being substituted, its deriver (if any), the substituter program, the command-</span></div>
<div style="position:absolute;left:63.87px;top:451.52px" class="cls_004"><span class="cls_004">line arguments, and the references. The latter two are listed one per line, each list preceded</span></div>
<div style="position:absolute;left:63.87px;top:463.47px" class="cls_004"><span class="cls_004">by a line specifying its length.</span></div>
<div style="position:absolute;left:73.84px;top:475.43px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> substitute</span><span class="cls_004">(p) that tries to make a usable path p valid through substitutes is</span></div>
<div style="position:absolute;left:63.87px;top:487.38px" class="cls_004"><span class="cls_004">shown in Figure 5.15. It returns a Boolean indicating whether it succeeded in making p</span></div>
<div style="position:absolute;left:63.87px;top:499.34px" class="cls_004"><span class="cls_004">valid. If the path is already valid, we are done right away</span><span class="cls_014"> </span><span class="cls_056">85</span><span class="cls_059"> </span><span class="cls_004">. Likewise, if the path is not</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">valid but there are no substitutes, we are also done, in a negative sense</span><span class="cls_014"> </span><span class="cls_056">86</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:523.25px" class="cls_004"><span class="cls_004">Otherwise, the path is not valid but we do have substitutes, so we can hopefully build the</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">path using one of them. However, to maintain the closure invariant, we must first ensure</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">that all the paths that will be referenced by p are also valid. By the reference invariant, we</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">already know the references of p. Thus, we call</span><span class="cls_007"> substitute</span><span class="cls_004"> recursively on all references</span><span class="cls_014"> </span><span class="cls_056">87</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:571.07px" class="cls_004"><span class="cls_004">To prevent interference with potential other Nix processes while running the substitutes,</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">a lock is first acquired on the output path</span><span class="cls_014"> </span><span class="cls_056">88</span><span class="cls_059"> </span><span class="cls_004">. As in the build algorithm in Figure 5.11, it</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">119</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:86250px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background128.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:68.09px;top:46.83px" class="cls_007"><span class="cls_007">Bool substitute</span><span class="cls_004">(p) :</span></div>
<div style="position:absolute;left:83.03px;top:58.79px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> valid</span><span class="cls_004">[p] = ε : return true</span><span class="cls_014"> </span><span class="cls_056">85</span></div>
<div style="position:absolute;left:83.03px;top:70.74px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> substitutes</span><span class="cls_004">[p] = ε : return false</span><span class="cls_014"> </span><span class="cls_056">86</span></div>
<div style="position:absolute;left:83.03px;top:81.67px" class="cls_004"><span class="cls_004">for each p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ∈</span><span class="cls_007"> references</span><span class="cls_004">[p] :</span></div>
<div style="position:absolute;left:92.99px;top:93.63px" class="cls_004"><span class="cls_004">if ¬</span><span class="cls_007"> substitute</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">) : return false</span><span class="cls_014"> </span><span class="cls_056">87</span></div>
<div style="position:absolute;left:83.03px;top:118.56px" class="cls_004"><span class="cls_004">lock ←</span><span class="cls_007"> acquirePathLock</span><span class="cls_004">(p)</span><span class="cls_014"> </span><span class="cls_056">88</span></div>
<div style="position:absolute;left:83.03px;top:130.52px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> valid</span><span class="cls_004">[p] = ε : return true</span></div>
<div style="position:absolute;left:83.03px;top:142.47px" class="cls_004"><span class="cls_004">for each (program, args, deriver) ∈</span><span class="cls_007"> substitutes</span><span class="cls_004">[p] :</span></div>
<div style="position:absolute;left:291.58px;top:144.47px" class="cls_056"><span class="cls_056">89</span></div>
<div style="position:absolute;left:97.97px;top:154.43px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> pathExists</span><span class="cls_004">(p) :</span><span class="cls_007"> deletePath</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:97.97px;top:166.38px" class="cls_004"><span class="cls_004">if execution of program program with</span></div>
<div style="position:absolute;left:107.94px;top:178.34px" class="cls_004"><span class="cls_004">arguments [p] + args exits with exit code 0 :</span></div>
<div style="position:absolute;left:289.08px;top:180.33px" class="cls_056"><span class="cls_056">90</span></div>
<div style="position:absolute;left:112.92px;top:190.29px" class="cls_004"><span class="cls_004">assert(</span><span class="cls_007">pathExists</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:112.92px;top:202.25px" class="cls_007"><span class="cls_007">canonicalisePathContents</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">)</span><span class="cls_014"> </span><span class="cls_056">91</span></div>
<div style="position:absolute;left:112.92px;top:214.20px" class="cls_007"><span class="cls_007">valid</span><span class="cls_004">[p] ←</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p)))</span><span class="cls_014"> </span><span class="cls_056">92</span></div>
<div style="position:absolute;left:112.92px;top:226.16px" class="cls_007"><span class="cls_007">deriver</span><span class="cls_004">[p] ← deriver</span></div>
<div style="position:absolute;left:112.92px;top:238.12px" class="cls_007"><span class="cls_007">releasePathLock</span><span class="cls_004">(p, lock)</span></div>
<div style="position:absolute;left:112.92px;top:250.07px" class="cls_004"><span class="cls_004">return true</span></div>
<div style="position:absolute;left:83.03px;top:262.03px" class="cls_007"><span class="cls_007">releasePathLock</span><span class="cls_004">(p, lock)</span></div>
<div style="position:absolute;left:83.03px;top:273.98px" class="cls_004"><span class="cls_004">if fall-back is disabled : abort</span><span class="cls_014"> </span><span class="cls_056">93</span></div>
<div style="position:absolute;left:83.03px;top:285.94px" class="cls_004"><span class="cls_004">return false</span></div>
<div style="position:absolute;left:137.74px;top:310.62px" class="cls_004"><span class="cls_004">Figure 5.15.:</span><span class="cls_007"> substitute</span><span class="cls_004">: Substitution of store paths</span></div>
<div style="position:absolute;left:59.72px;top:342.74px" class="cls_004"><span class="cls_004">is possible that the output path has become valid between the initial validity check and the</span></div>
<div style="position:absolute;left:59.72px;top:354.70px" class="cls_004"><span class="cls_004">acquisition of the lock. Thus, a final validity check is done.</span></div>
<div style="position:absolute;left:69.68px;top:366.69px" class="cls_004"><span class="cls_004">Next, we try each substitute until one succeeds</span><span class="cls_014"> </span><span class="cls_056">89</span><span class="cls_059"> </span><span class="cls_004">.  The substitute program is called</span></div>
<div style="position:absolute;left:59.72px;top:378.64px" class="cls_004"><span class="cls_004">with as command-line arguments the target path p, and the arguments registered for the</span></div>
<div style="position:absolute;left:59.72px;top:390.60px" class="cls_004"><span class="cls_004">substitute</span><span class="cls_014"> </span><span class="cls_056">90</span><span class="cls_059"> </span><span class="cls_004">. The substitute program is supposed to produce an FSO at path p and return</span></div>
<div style="position:absolute;left:59.72px;top:402.55px" class="cls_004"><span class="cls_004">exit code 0. If so, the path’s metadata is canonicalised</span><span class="cls_014"> </span><span class="cls_056">91</span><span class="cls_059"> </span><span class="cls_004">, the path is registered as valid,</span></div>
<div style="position:absolute;left:59.72px;top:414.51px" class="cls_004"><span class="cls_004">and the deriver is set</span><span class="cls_014"> </span><span class="cls_056">92</span><span class="cls_059"> </span><span class="cls_004">. If not, the next substitute is tried until no more substitutes remain.</span></div>
<div style="position:absolute;left:69.68px;top:426.50px" class="cls_004"><span class="cls_004">Generally, it is a fatal error if all substitutes for a path fail. When</span><span class="cls_007"> substitute</span><span class="cls_004"> is called</span></div>
<div style="position:absolute;left:59.72px;top:438.45px" class="cls_004"><span class="cls_004">from a derivation build action, Nix does not automatically “fall back” to building from</span></div>
<div style="position:absolute;left:59.72px;top:450.41px" class="cls_004"><span class="cls_004">source</span><span class="cls_014"> </span><span class="cls_056">93</span><span class="cls_059"> </span><span class="cls_004">. The reason is that we presumably registered the substitute for a reason, namely,</span></div>
<div style="position:absolute;left:59.72px;top:462.37px" class="cls_004"><span class="cls_004">to avoid the overhead of a source build. If the substitute fails for a transient reason—such</span></div>
<div style="position:absolute;left:59.72px;top:474.32px" class="cls_004"><span class="cls_004">as a network outage—the user in general does not want a source build instead, but prefers</span></div>
<div style="position:absolute;left:59.72px;top:486.28px" class="cls_004"><span class="cls_004">to wait or repair the cause of the problem. However, Nix commands do accept a flag to</span></div>
<div style="position:absolute;left:59.72px;top:498.23px" class="cls_004"><span class="cls_004">enable automatic fall-back:</span></div>
<div style="position:absolute;left:84.62px;top:522.52px" class="cls_015"><span class="cls_015">$ nix-env  -i  hello  --fall-back</span></div>
<div style="position:absolute;left:84.62px;top:544.44px" class="cls_015"><span class="cls_015">downloading  `/nix/store/bwacc7a5c5n3...-hello-2.1.1'</span></div>
<div style="position:absolute;left:94.04px;top:555.40px" class="cls_015"><span class="cls_015">from  </span><A HREF="http://example.org/foo/">http://example.org/foo</A> </div>
<div style="position:absolute;left:84.62px;top:566.36px" class="cls_015"><span class="cls_015">curl:  `example.org':  no  route  to  host</span></div>
<div style="position:absolute;left:84.62px;top:577.32px" class="cls_015"><span class="cls_015">falling  back...</span></div>
<div style="position:absolute;left:84.62px;top:588.28px" class="cls_015"><span class="cls_015">building  `/nix/store/1ja1w63wbk5q...-hello-2.1.1.drv'</span></div>
<div style="position:absolute;left:59.72px;top:624.86px" class="cls_004"><span class="cls_004">120</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:86940px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background129.jpg" width=481 height=680></div>
<div style="position:absolute;left:299.25px;top:17.14px" class="cls_004"><span class="cls_004">5.5. Building store derivations</span></div>
<div style="position:absolute;left:63.87px;top:72.73px" class="cls_009"><span class="cls_009">Relation to build hooks</span><span class="cls_004">   So what is the difference between a substitute and a build hook,</span></div>
<div style="position:absolute;left:63.87px;top:84.69px" class="cls_004"><span class="cls_004">as they both short-circuit the build process?  A build hook is used to “out-source” the</span></div>
<div style="position:absolute;left:63.87px;top:96.64px" class="cls_004"><span class="cls_004">building of a derivation, while a substitute is used to reproduce an already existing build</span></div>
<div style="position:absolute;left:63.87px;top:108.60px" class="cls_004"><span class="cls_004">result. That is, build hooks operate at build time, while substitutes operate at deployment</span></div>
<div style="position:absolute;left:63.87px;top:120.55px" class="cls_004"><span class="cls_004">time. Specifically, the substitution of the output of a derivation only needs the references</span></div>
<div style="position:absolute;left:63.87px;top:132.51px" class="cls_004"><span class="cls_004">of the output (i.e., runtime dependencies) to be valid, while a build hook requires that all</span></div>
<div style="position:absolute;left:63.87px;top:144.46px" class="cls_004"><span class="cls_004">inputs of the derivation (i.e., build-time dependencies) are valid.</span></div>
<div style="position:absolute;left:73.84px;top:156.63px" class="cls_004"><span class="cls_004">For example, the GNU Hello derivation has build-time dependencies on GCC and sev-</span></div>
<div style="position:absolute;left:63.87px;top:168.58px" class="cls_004"><span class="cls_004">eral other packages, but these are not referenced from the output. Thus, if we use a sub-</span></div>
<div style="position:absolute;left:63.87px;top:180.54px" class="cls_004"><span class="cls_004">stitute to download a Hello binary, dependencies such as GCC will not be installed. But if</span></div>
<div style="position:absolute;left:63.87px;top:192.49px" class="cls_004"><span class="cls_004">we used build hooks, Nix would first install them. So while the substitutes can in principle</span></div>
<div style="position:absolute;left:63.87px;top:204.45px" class="cls_004"><span class="cls_004">be subsumed by build hooks, substitutes are much more efficient for deployment purposes</span></div>
<div style="position:absolute;left:63.87px;top:216.40px" class="cls_004"><span class="cls_004">(apart from the fact that making the build-time dependencies available may simply be un-</span></div>
<div style="position:absolute;left:63.87px;top:228.36px" class="cls_004"><span class="cls_004">acceptable in many cases, such as closed-source deployment).</span></div>
<div style="position:absolute;left:73.84px;top:240.53px" class="cls_004"><span class="cls_004">Also, substitutes allow us to forego store derivations altogether. For instance,</span><span class="cls_007"> nix-env</span></div>
<div style="position:absolute;left:63.87px;top:252.48px" class="cls_004"><span class="cls_004">can install output paths directly:</span></div>
<div style="position:absolute;left:88.78px;top:277.30px" class="cls_015"><span class="cls_015">$ nix-env  -i  /nix/store/bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:63.87px;top:292.61px" class="cls_004"><span class="cls_004">This command will make</span><span class="cls_007"> /nix/store/bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004"> valid using a substitute (if</span></div>
<div style="position:absolute;left:63.87px;top:304.56px" class="cls_004"><span class="cls_004">it wasn’t already valid). The difference with installing from a store derivation is that this</span></div>
<div style="position:absolute;left:63.87px;top:316.52px" class="cls_004"><span class="cls_004">mode of installation cannot fall back to a build from source if the substitutes fail.</span></div>
<div style="position:absolute;left:63.87px;top:345.41px" class="cls_008"><span class="cls_008">5.5.4. The parallel build algorithm</span></div>
<div style="position:absolute;left:63.87px;top:365.29px" class="cls_004"><span class="cls_004">The build algorithm described above does not always make optimal use of the available</span></div>
<div style="position:absolute;left:63.87px;top:377.24px" class="cls_004"><span class="cls_004">hardware. When multiple CPUs are available, it is a good idea to execute multiple deriva-</span></div>
<div style="position:absolute;left:63.87px;top:389.20px" class="cls_004"><span class="cls_004">tions in parallel. When substitutes are used, it may well be the case that each substitute</span></div>
<div style="position:absolute;left:63.87px;top:401.15px" class="cls_004"><span class="cls_004">only uses a fraction of the available download bandwidth, i.e., executing multiple down-</span></div>
<div style="position:absolute;left:63.87px;top:413.11px" class="cls_004"><span class="cls_004">loads in parallel might speed things up. More importantly, when build hooks are used to</span></div>
<div style="position:absolute;left:63.87px;top:425.06px" class="cls_004"><span class="cls_004">distribute build jobs to remote machines, we certainly shouldn’t wait for one job to finish</span></div>
<div style="position:absolute;left:63.87px;top:437.02px" class="cls_004"><span class="cls_004">when there are idle machines.</span></div>
<div style="position:absolute;left:73.84px;top:449.18px" class="cls_004"><span class="cls_004">This section briefly describes a parallel build algorithm that can execute multiple builds</span></div>
<div style="position:absolute;left:63.87px;top:461.14px" class="cls_004"><span class="cls_004">and substitutions simultaneously.  The parallel algorithm, rather than the one described</span></div>
<div style="position:absolute;left:63.87px;top:473.09px" class="cls_004"><span class="cls_004">above, is what is implemented in the current Nix implementation.</span></div>
<div style="position:absolute;left:73.84px;top:485.26px" class="cls_004"><span class="cls_004">The parallel build algorithm works on sets of goals. There are two types of goals:</span></div>
<div style="position:absolute;left:78.82px;top:505.82px" class="cls_004"><span class="cls_004">• A derivation goal attempts to make the output of a derivation valid.</span></div>
<div style="position:absolute;left:78.82px;top:526.60px" class="cls_004"><span class="cls_004">• A substitution goal attempts to make a path valid through substitutes.</span></div>
<div style="position:absolute;left:73.84px;top:547.16px" class="cls_004"><span class="cls_004">Each type of goal is implemented by a finite state machine. The nodes of the finite state</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">machine represent states. Each state has associated with it an action that is to be performed</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">when the state is reached. Typically, the action is to start other goals or processes. The goal</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">is then “put to sleep” until the condition associated with one of the out-going edges of the</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">121</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:87630px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background130.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:68.09px;top:46.83px" class="cls_007"><span class="cls_007">run</span><span class="cls_004">(topGoals) :</span></div>
<div style="position:absolute;left:83.03px;top:58.79px" class="cls_004"><span class="cls_004">awake ← topGoals</span></div>
<div style="position:absolute;left:83.03px;top:70.74px" class="cls_004"><span class="cls_004">while true :</span></div>
<div style="position:absolute;left:97.97px;top:82.70px" class="cls_004"><span class="cls_004">for each goal ∈ awake :</span></div>
<div style="position:absolute;left:112.92px;top:94.65px" class="cls_004"><span class="cls_004">Remove goal from awake</span></div>
<div style="position:absolute;left:112.92px;top:106.61px" class="cls_004"><span class="cls_004">Execute the action associated with the current state of goal</span></div>
<div style="position:absolute;left:112.92px;top:118.56px" class="cls_004"><span class="cls_004">if goal has reached a final state :</span></div>
<div style="position:absolute;left:127.86px;top:130.52px" class="cls_004"><span class="cls_004">Add goals waiting on goal to awake</span></div>
<div style="position:absolute;left:127.86px;top:142.47px" class="cls_004"><span class="cls_004">Remove goal from topGoals</span></div>
<div style="position:absolute;left:97.97px;top:154.43px" class="cls_004"><span class="cls_004">if topGoals = 0 : return</span></div>
<div style="position:absolute;left:97.97px;top:166.38px" class="cls_004"><span class="cls_004">Wait for termination of child processes, add corresponding goals to awake</span></div>
<div style="position:absolute;left:155.16px;top:191.07px" class="cls_004"><span class="cls_004">Figure 5.16.:</span><span class="cls_007"> run</span><span class="cls_004">: Goal execution (sketch)</span></div>
<div style="position:absolute;left:59.72px;top:224.69px" class="cls_004"><span class="cls_004">state becomes true. At this point, the goal is woken up, the transition to the corresponding</span></div>
<div style="position:absolute;left:59.72px;top:236.65px" class="cls_004"><span class="cls_004">new state is made, and the action associated with the new state is performed. This continues</span></div>
<div style="position:absolute;left:59.72px;top:248.60px" class="cls_004"><span class="cls_004">until the goal reaches a final state.</span></div>
<div style="position:absolute;left:69.68px;top:261.35px" class="cls_004"><span class="cls_004">There is a top-level function</span><span class="cls_007"> run</span><span class="cls_004"> that executes a set of initial top-level goals (all being</span></div>
<div style="position:absolute;left:59.72px;top:273.30px" class="cls_004"><span class="cls_004">in their initial state).  It is shown in Figure 5.16.  It maintains a set of “awake” goals,</span></div>
<div style="position:absolute;left:59.72px;top:285.26px" class="cls_004"><span class="cls_004">e.g., those goals that have made a transition (meaning that some event has occured that is</span></div>
<div style="position:absolute;left:59.72px;top:297.21px" class="cls_004"><span class="cls_004">relevant to the goal). Initially, the top-level goals are all awake, so their initial actions can</span></div>
<div style="position:absolute;left:59.72px;top:309.17px" class="cls_004"><span class="cls_004">be executed. If a top-level goal finishes, it is removed from the set of top-level goals, and</span></div>
<div style="position:absolute;left:59.72px;top:321.12px" class="cls_004"><span class="cls_004">the runner continues until there are no more top-level goals.</span></div>
<div style="position:absolute;left:69.68px;top:333.86px" class="cls_004"><span class="cls_004">The “events” that can wake up a goal are the termination of a child process (i.e., a</span></div>
<div style="position:absolute;left:59.72px;top:345.82px" class="cls_004"><span class="cls_004">builder, a substituter, or a build hook), or the termination of a subgoal. A subgoal of a goal</span></div>
<div style="position:absolute;left:59.72px;top:357.78px" class="cls_004"><span class="cls_004">g is a goal that g is waiting on. Subgoals can be shared. Suppose that we start the parallel</span></div>
<div style="position:absolute;left:59.72px;top:369.73px" class="cls_004"><span class="cls_004">building of top-level derivations Hello and Firefox, which both depend on the same Glibc.</span></div>
<div style="position:absolute;left:59.72px;top:381.69px" class="cls_004"><span class="cls_004">One top-level derivation will create a subgoal for Glibc and its other input derivations. It</span></div>
<div style="position:absolute;left:59.72px;top:393.64px" class="cls_004"><span class="cls_004">then goes to sleep, waiting for the subgoals to finish. When the Firefox goal is executed, it</span></div>
<div style="position:absolute;left:59.72px;top:405.60px" class="cls_004"><span class="cls_004">will see that a subgoal for Glibc already exists, and simply add itself to the list of “waiters”.</span></div>
<div style="position:absolute;left:59.72px;top:417.55px" class="cls_004"><span class="cls_004">When the Glibc goal finishes, it will wake up both the Hello and Firefox goals, allowing</span></div>
<div style="position:absolute;left:59.72px;top:429.51px" class="cls_004"><span class="cls_004">them to make progress (as soon as their other subgoals have finished too, that is).</span></div>
<div style="position:absolute;left:69.68px;top:442.25px" class="cls_004"><span class="cls_004">Figure 5.17 shows the state machine for derivation goals.  When a goal starts, it</span></div>
<div style="position:absolute;left:59.72px;top:454.20px" class="cls_004"><span class="cls_004">creates a substitution subgoal for its derivation store path (which corresponds to the</span></div>
<div style="position:absolute;left:59.72px;top:466.16px" class="cls_004"><span class="cls_004">call</span><span class="cls_007"> substitute</span><span class="cls_004">(p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">) in the simple build algorithm in Figure 5.11).  If the subgoal suc-</span></div>
<div style="position:absolute;left:59.72px;top:478.11px" class="cls_004"><span class="cls_004">ceeds, it starts a substitution subgoal for the output path (corresponding to the call</span></div>
<div style="position:absolute;left:59.72px;top:490.07px" class="cls_007"><span class="cls_007">substitute</span><span class="cls_004">(d.</span><span class="cls_007">output</span><span class="cls_004">)). If that subgoal does not succeed, we have to perform the build. So</span></div>
<div style="position:absolute;left:59.72px;top:502.03px" class="cls_004"><span class="cls_004">first the input derivations must be built, and thus derivation subgoals are created for each</span></div>
<div style="position:absolute;left:59.72px;top:513.98px" class="cls_004"><span class="cls_004">of those (corresponding to the recursive calls to</span><span class="cls_007"> build</span><span class="cls_004">). If each is successful, we can run the</span></div>
<div style="position:absolute;left:59.72px;top:525.94px" class="cls_004"><span class="cls_004">build hook, or if that yields a</span><span class="cls_007"> decline</span><span class="cls_004"> response, the builder. We limit however the number</span></div>
<div style="position:absolute;left:59.72px;top:536.86px" class="cls_004"><span class="cls_004">of child processes that can run in parallel</span><span class="cls_012"><sup>9</sup></span><span class="cls_004">. If this limit is reached, no more child processes</span></div>
<div style="position:absolute;left:59.72px;top:549.85px" class="cls_004"><span class="cls_004">can be started until one finishes (the available “build slots” are said to be exhausted), so the</span></div>
<div style="position:absolute;left:59.72px;top:561.80px" class="cls_004"><span class="cls_004">goal goes to sleep. When the hook or builder finishes successfully, the usual postprocess-</span></div>
<div style="position:absolute;left:64.20px;top:584.11px" class="cls_013"><span class="cls_013"><sup>9</sup></span><span class="cls_014">This limit can be specified using the</span><span class="cls_016"> --max-jobs</span><span class="cls_014"> N flag.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">122</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:88320px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background131.jpg" width=481 height=680></div>
<div style="position:absolute;left:299.25px;top:17.14px" class="cls_004"><span class="cls_004">5.5. Building store derivations</span></div>
<div style="position:absolute;left:112.10px;top:58.81px" class="cls_040"><span class="cls_040">INIT</span></div>
<div style="position:absolute;left:70.36px;top:65.29px" class="cls_040"><span class="cls_040">start substitution goal for store derivation</span></div>
<div style="position:absolute;left:144.93px;top:84.34px" class="cls_040"><span class="cls_040">substitution goal succeeded</span></div>
<div style="position:absolute;left:131.15px;top:103.39px" class="cls_040"><span class="cls_040">HAVE STORE DERIVATION</span></div>
<div style="position:absolute;left:124.67px;top:109.87px" class="cls_040"><span class="cls_040">start substitution goal for output path</span></div>
<div style="position:absolute;left:167.23px;top:128.92px" class="cls_040"><span class="cls_040">substitution goal failed</span></div>
<div style="position:absolute;left:151.01px;top:147.97px" class="cls_040"><span class="cls_040">NO OUTPUT</span></div>
<div style="position:absolute;left:115.35px;top:154.46px" class="cls_040"><span class="cls_040">start derivation goals for all input derivations</span></div>
<div style="position:absolute;left:85.76px;top:173.51px" class="cls_040"><span class="cls_040">substitution goal failed</span></div>
<div style="position:absolute;left:185.46px;top:173.51px" class="cls_040"><span class="cls_040">all subgoals succeeded</span></div>
<div style="position:absolute;left:181.82px;top:192.55px" class="cls_040"><span class="cls_040">TRY TO BUILD</span></div>
<div style="position:absolute;left:246.66px;top:192.55px" class="cls_040"><span class="cls_040">hook declined/postponed, or no build slot;</span></div>
<div style="position:absolute;left:358.53px;top:195.80px" class="cls_040"><span class="cls_040">substitution goal succeeded</span></div>
<div style="position:absolute;left:170.06px;top:199.04px" class="cls_040"><span class="cls_040">run the build hook / builder</span></div>
<div style="position:absolute;left:266.12px;top:199.04px" class="cls_040"><span class="cls_040">wait until a child finishes</span></div>
<div style="position:absolute;left:143.72px;top:218.09px" class="cls_040"><span class="cls_040">one or more subgoals failed</span></div>
<div style="position:absolute;left:261.66px;top:218.09px" class="cls_040"><span class="cls_040">hook or builder succeeded</span></div>
<div style="position:absolute;left:296.11px;top:237.14px" class="cls_040"><span class="cls_040">FINISHED</span></div>
<div style="position:absolute;left:207.35px;top:240.38px" class="cls_040"><span class="cls_040">hook or builder failed</span></div>
<div style="position:absolute;left:278.28px;top:243.62px" class="cls_040"><span class="cls_040">check output, scan, register</span></div>
<div style="position:absolute;left:247.47px;top:262.67px" class="cls_040"><span class="cls_040">no output</span></div>
<div style="position:absolute;left:327.72px;top:262.67px" class="cls_040"><span class="cls_040">success</span></div>
<div style="position:absolute;left:168.85px;top:280.50px" class="cls_040"><span class="cls_040">FAILED</span></div>
<div style="position:absolute;left:327.72px;top:280.50px" class="cls_040"><span class="cls_040">SUCCESS</span></div>
<div style="position:absolute;left:148.09px;top:303.40px" class="cls_004"><span class="cls_004">Figure 5.17.: State machine for derivation goals</span></div>
<div style="position:absolute;left:124.36px;top:345.31px" class="cls_041"><span class="cls_041">INIT</span></div>
<div style="position:absolute;left:157.71px;top:366.58px" class="cls_041"><span class="cls_041">path is not yet valid</span></div>
<div style="position:absolute;left:170.28px;top:389.30px" class="cls_041"><span class="cls_041">INVALID</span></div>
<div style="position:absolute;left:129.67px;top:397.04px" class="cls_041"><span class="cls_041">start substitution goals for all references</span></div>
<div style="position:absolute;left:248.58px;top:419.75px" class="cls_041"><span class="cls_041">all subgoals succeeded</span></div>
<div style="position:absolute;left:283.38px;top:442.47px" class="cls_041"><span class="cls_041">TRY NEXT</span></div>
<div style="position:absolute;left:108.40px;top:446.34px" class="cls_041"><span class="cls_041">path is already valid</span></div>
<div style="position:absolute;left:185.26px;top:446.34px" class="cls_041"><span class="cls_041">one or more subgoals failed</span></div>
<div style="position:absolute;left:274.20px;top:450.21px" class="cls_041"><span class="cls_041">pop next substitute</span></div>
<div style="position:absolute;left:204.11px;top:472.92px" class="cls_041"><span class="cls_041">no more substitutes</span></div>
<div style="position:absolute;left:263.57px;top:472.92px" class="cls_041"><span class="cls_041">have a substitute</span></div>
<div style="position:absolute;left:313.35px;top:472.92px" class="cls_041"><span class="cls_041">substitute failed</span></div>
<div style="position:absolute;left:239.40px;top:495.64px" class="cls_041"><span class="cls_041">TRY TO BUILD</span></div>
<div style="position:absolute;left:332.69px;top:495.64px" class="cls_041"><span class="cls_041">no build slot;</span></div>
<div style="position:absolute;left:174.14px;top:499.51px" class="cls_041"><span class="cls_041">FAILED</span></div>
<div style="position:absolute;left:226.35px;top:503.38px" class="cls_041"><span class="cls_041">run the substitute program</span></div>
<div style="position:absolute;left:316.25px;top:503.38px" class="cls_041"><span class="cls_041">wait until a child finishes</span></div>
<div style="position:absolute;left:209.43px;top:526.10px" class="cls_041"><span class="cls_041">substitute succeeded</span></div>
<div style="position:absolute;left:135.96px;top:547.36px" class="cls_041"><span class="cls_041">SUCCESS</span></div>
<div style="position:absolute;left:144.78px;top:572.37px" class="cls_004"><span class="cls_004">Figure 5.18.: State machine for substitution goals</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">123</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:89010px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background132.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">ing is performed: the references are determined, the content hash of the path is computed,</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">and the path is registered as valid.</span></div>
<div style="position:absolute;left:206.08px;top:56.99px" class="cls_004"><span class="cls_004">(The transitions from state F</span><span class="cls_014">INISHED</span><span class="cls_004"> are not actual</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">events, but simply the outcomes of the action associated with that state’s action.)</span></div>
<div style="position:absolute;left:69.68px;top:81.36px" class="cls_004"><span class="cls_004">Figure 5.18 shows the state machine for substitution goals.  A substitution goal first</span></div>
<div style="position:absolute;left:59.72px;top:93.31px" class="cls_004"><span class="cls_004">checks that the path is not already valid (again, the edges from I</span><span class="cls_014">NIT</span><span class="cls_004"> are not actual events).</span></div>
<div style="position:absolute;left:59.72px;top:105.27px" class="cls_004"><span class="cls_004">If it is invalid, subgoals are started to make the references of the path valid. Then, each</span></div>
<div style="position:absolute;left:59.72px;top:117.22px" class="cls_004"><span class="cls_004">substitute is tried until one succeeds.</span></div>
<div style="position:absolute;left:69.68px;top:129.63px" class="cls_004"><span class="cls_004">Normally, when a subgoal fails, its waitees (the goals waiting on it) are immediately</span></div>
<div style="position:absolute;left:59.72px;top:141.58px" class="cls_004"><span class="cls_004">woken up and fail as well (except when failure is normal, e.g., in the substitution of an</span></div>
<div style="position:absolute;left:59.72px;top:153.54px" class="cls_004"><span class="cls_004">output path). These waitees may have other subgoals that are still busy. Each goal has a</span></div>
<div style="position:absolute;left:59.72px;top:165.49px" class="cls_004"><span class="cls_004">reference count, and when the waitees kill themselves, they decrement the reference counts</span></div>
<div style="position:absolute;left:59.72px;top:177.45px" class="cls_004"><span class="cls_004">of all remaining subgoals.  If the reference count of a goal reaches 0, it is also killed.</span></div>
<div style="position:absolute;left:59.72px;top:189.40px" class="cls_004"><span class="cls_004">Associated child processes are terminated.  Thus, failure of a single subgoal propagates</span></div>
<div style="position:absolute;left:59.72px;top:201.36px" class="cls_004"><span class="cls_004">upwards, killing all other goals along the way.</span></div>
<div style="position:absolute;left:69.68px;top:213.76px" class="cls_004"><span class="cls_004">This is usually the desired behaviour, but not always. For instance, in the Nix build farm</span></div>
<div style="position:absolute;left:59.72px;top:225.72px" class="cls_004"><span class="cls_004">described in Chapter 8, the job for Nixpkgs contains hundreds of more-or-less independent</span></div>
<div style="position:absolute;left:59.72px;top:237.68px" class="cls_004"><span class="cls_004">derivations. The failure of one should not terminate the others, since the build results of</span></div>
<div style="position:absolute;left:59.72px;top:249.63px" class="cls_004"><span class="cls_004">the successful derivations can be reused in subsequent build jobs. For this reason, there</span></div>
<div style="position:absolute;left:59.72px;top:261.59px" class="cls_004"><span class="cls_004">is a flag</span><span class="cls_007"> --keep-going</span><span class="cls_004"> that has the following effect: when a subgoal fails, the waitees are</span></div>
<div style="position:absolute;left:59.72px;top:273.54px" class="cls_004"><span class="cls_004">not woken up until all their other subgoals have finished as well. At that point, the waitees</span></div>
<div style="position:absolute;left:59.72px;top:284.47px" class="cls_004"><span class="cls_004">notice the subgoal failure, and make the transition to the F</span><span class="cls_014">AILED</span><span class="cls_004"> state as well</span><span class="cls_012"><sup>10</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:59.72px;top:318.65px" class="cls_011"><span class="cls_011">5.6. Garbage collection</span></div>
<div style="position:absolute;left:59.72px;top:344.72px" class="cls_004"><span class="cls_004">Nix never deletes components from the Nix store on uninstallation or upgrade actions.</span></div>
<div style="position:absolute;left:59.72px;top:356.68px" class="cls_004"><span class="cls_004">Rather, to reclaim disk space, it is necessary to routinely run a garbage collector.</span></div>
<div style="position:absolute;left:69.68px;top:369.09px" class="cls_004"><span class="cls_004">Garbage collection in Nix is pretty much like garbage collection in programming lan-</span></div>
<div style="position:absolute;left:59.72px;top:381.04px" class="cls_004"><span class="cls_004">guages (except for one unique property discussed below). There is a pointer graph defined</span></div>
<div style="position:absolute;left:59.72px;top:393.00px" class="cls_004"><span class="cls_004">by the</span><span class="cls_007"> references</span><span class="cls_004"> relation, and there is a set of roots. The closure of the set of roots under</span></div>
<div style="position:absolute;left:59.72px;top:404.95px" class="cls_004"><span class="cls_004">the</span><span class="cls_007"> references</span><span class="cls_004"> relation is the set of live store objects—these are FSOs that are potentially</span></div>
<div style="position:absolute;left:59.72px;top:416.91px" class="cls_004"><span class="cls_004">in use, and therefore must not be deleted. All store objects that are not live are dead—these</span></div>
<div style="position:absolute;left:59.72px;top:428.86px" class="cls_004"><span class="cls_004">can be deleted safely.</span></div>
<div style="position:absolute;left:69.68px;top:441.27px" class="cls_004"><span class="cls_004">The garbage collector therefore has the following phases:</span></div>
<div style="position:absolute;left:74.66px;top:462.55px" class="cls_004"><span class="cls_004">• Determine the set of root paths.</span></div>
<div style="position:absolute;left:74.66px;top:484.28px" class="cls_004"><span class="cls_004">• Compute the live paths as the closure of the set of root paths.</span></div>
<div style="position:absolute;left:74.66px;top:506.00px" class="cls_004"><span class="cls_004">• Delete the dead paths, which are those that exist in the Nix store but are not in the</span></div>
<div style="position:absolute;left:84.62px;top:517.96px" class="cls_004"><span class="cls_004">set of live paths.</span></div>
<div style="position:absolute;left:69.68px;top:539.24px" class="cls_004"><span class="cls_004">This section first discusses how root paths are registered. Then it shows two garbage</span></div>
<div style="position:absolute;left:59.72px;top:551.19px" class="cls_004"><span class="cls_004">collection algorithms: a plain “stop-the-world” collector that blocks all other Nix actions</span></div>
<div style="position:absolute;left:59.72px;top:563.15px" class="cls_004"><span class="cls_004">while it is running, and a concurrent collector that can run in parallel with other Nix actions.</span></div>
<div style="position:absolute;left:61.21px;top:584.11px" class="cls_013"><span class="cls_013"><sup>10</sup></span><span class="cls_014">This behaviour is similar to GNU Make’s [68]</span><span class="cls_016"> -k</span><span class="cls_014"> flag.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">124</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:89700px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background133.jpg" width=481 height=680></div>
<div style="position:absolute;left:326.72px;top:17.14px" class="cls_004"><span class="cls_004">5.6. Garbage collection</span></div>
<div style="position:absolute;left:63.87px;top:44.24px" class="cls_008"><span class="cls_008">5.6.1. Garbage collection roots</span></div>
<div style="position:absolute;left:63.87px;top:64.28px" class="cls_004"><span class="cls_004">The set of roots of the garbage collector are defined as symlinks to store paths in the</span></div>
<div style="position:absolute;left:63.87px;top:76.23px" class="cls_004"><span class="cls_004">directory</span><span class="cls_007"> /nix/var/nix/gcroots</span><span class="cls_004">. Conceptually, if we for example have a store path</span><span class="cls_007"> /nix/store/-</span></div>
<div style="position:absolute;left:63.87px;top:88.19px" class="cls_007"><span class="cls_007">bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004"> that we want to be preserved, we can register it as a root as</span></div>
<div style="position:absolute;left:63.87px;top:100.14px" class="cls_004"><span class="cls_004">follows:</span></div>
<div style="position:absolute;left:88.78px;top:125.21px" class="cls_015"><span class="cls_015">$ nix-store  -r  $(nix-instantiate  foo.nix)</span></div>
<div style="position:absolute;left:88.78px;top:136.17px" class="cls_015"><span class="cls_015">/nix/store/bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:88.78px;top:158.09px" class="cls_015"><span class="cls_015">$ ln  -s  /nix/store/bwacc7a5c5n3...-hello-2.1.1  \</span></div>
<div style="position:absolute;left:107.61px;top:169.05px" class="cls_015"><span class="cls_015">/nix/var/nix/gcroots/my-root</span></div>
<div style="position:absolute;left:73.84px;top:184.60px" class="cls_004"><span class="cls_004">It is also possible to register store derivations as roots, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:209.67px" class="cls_015"><span class="cls_015">$ nix-instantiate  foo.nix</span></div>
<div style="position:absolute;left:88.78px;top:220.63px" class="cls_015"><span class="cls_015">/nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span></div>
<div style="position:absolute;left:88.78px;top:242.55px" class="cls_015"><span class="cls_015">$ ln  -s  /nix/store/1ja1w63wbk5q...-hello-2.1.1.drv  \</span></div>
<div style="position:absolute;left:107.61px;top:253.51px" class="cls_015"><span class="cls_015">/nix/var/nix/gcroots/my-root</span></div>
<div style="position:absolute;left:63.87px;top:269.06px" class="cls_004"><span class="cls_004">This causes the store derivations and its dependencies—other store derivations and</span></div>
<div style="position:absolute;left:63.87px;top:281.01px" class="cls_004"><span class="cls_004">sources—to be preserved by the collector.</span></div>
<div style="position:absolute;left:73.84px;top:293.26px" class="cls_004"><span class="cls_004">However, there is a race condition in this method of root registration.  If the garbage</span></div>
<div style="position:absolute;left:63.87px;top:305.22px" class="cls_004"><span class="cls_004">collector is ran just between the call to</span><span class="cls_007"> nix-store</span><span class="cls_004"> or</span><span class="cls_007"> nix-instantiate</span><span class="cls_004"> on the one hand, and the</span></div>
<div style="position:absolute;left:63.87px;top:317.17px" class="cls_004"><span class="cls_004">creation of the symlink on the other hand, the store object and some or all of its dependen-</span></div>
<div style="position:absolute;left:63.87px;top:329.13px" class="cls_004"><span class="cls_004">cies may be garbage collected. It is therefore possible to let the Nix tool in question create</span></div>
<div style="position:absolute;left:63.87px;top:341.09px" class="cls_004"><span class="cls_004">the root:</span></div>
<div style="position:absolute;left:88.78px;top:366.15px" class="cls_015"><span class="cls_015">$ nix-instantiate  --add-root  /nix/var/nix/gcroots/my-root  foo.nix</span></div>
<div style="position:absolute;left:88.78px;top:377.11px" class="cls_015"><span class="cls_015">/nix/var/nix/gcroots/my-root</span></div>
<div style="position:absolute;left:63.87px;top:392.67px" class="cls_004"><span class="cls_004">Through locking, Nix ensures that there is no race condition.</span></div>
<div style="position:absolute;left:73.84px;top:404.92px" class="cls_004"><span class="cls_004">Having to store links in</span><span class="cls_007"> /nix/var/nix/gcroots</span><span class="cls_004"> is often inconvenient.  Consider the Nix</span></div>
<div style="position:absolute;left:63.87px;top:416.87px" class="cls_004"><span class="cls_004">utility</span><span class="cls_007"> nix-build</span><span class="cls_004"> that instantiates and builds a Nix expression, and leaves a symlink</span><span class="cls_007"> result</span></div>
<div style="position:absolute;left:63.87px;top:428.83px" class="cls_004"><span class="cls_004">pointing to the output path of the derivation in the current directory:</span></div>
<div style="position:absolute;left:88.78px;top:453.89px" class="cls_015"><span class="cls_015">$ nix-build  ./foo.nix</span></div>
<div style="position:absolute;left:88.78px;top:475.81px" class="cls_015"><span class="cls_015">$ ls  -l  result</span></div>
<div style="position:absolute;left:88.78px;top:486.77px" class="cls_015"><span class="cls_015">lrwxr-xr-x  ...  result  ->  /nix/store/bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:88.78px;top:508.69px" class="cls_015"><span class="cls_015">$ ./result/bin/hello</span></div>
<div style="position:absolute;left:88.78px;top:519.65px" class="cls_015"><span class="cls_015">Hello,  world!</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">We want to implement</span><span class="cls_007"> nix-build</span><span class="cls_004"> so that its result is registered as a root. One way to do this</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">is to have</span><span class="cls_007"> nix-build</span><span class="cls_004"> generate a fresh symlink in</span><span class="cls_007"> /nix/var/nix/gcroots</span><span class="cls_004">, and have</span><span class="cls_007"> ./result</span><span class="cls_004"> be a</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">symlink to that. I.e., we solve the problem through an extra indirection. However, there is</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">a problem: if we delete</span><span class="cls_007"> ./result</span><span class="cls_004">, the root persists. So the user would always need to make</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">sure to delete the target of the</span><span class="cls_007"> result</span><span class="cls_004"> symlink when deleting</span><span class="cls_007"> result</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">125</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:90390px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background134.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:69.68px;top:45.04px" class="cls_004"><span class="cls_004">A better solution is the notion of indirect roots, which is in a sense the opposite solution.</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">We let</span><span class="cls_007"> ./result</span><span class="cls_004"> be a direct symlink to the store path, and create a symlink to</span><span class="cls_007"> result</span><span class="cls_004"> in the</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">designated directory</span><span class="cls_007"> /nix/var/nix/gcroots/auto</span><span class="cls_004">. For example,</span></div>
<div style="position:absolute;left:84.62px;top:90.16px" class="cls_015"><span class="cls_015">$ nix-store  -r  --add-root  ./my-root  --indirect  \</span></div>
<div style="position:absolute;left:103.45px;top:101.12px" class="cls_015"><span class="cls_015">$(nix-instantiate  foo.nix)</span></div>
<div style="position:absolute;left:84.62px;top:112.08px" class="cls_015"><span class="cls_015">./my-root</span></div>
<div style="position:absolute;left:84.62px;top:134.00px" class="cls_015"><span class="cls_015">$ ls  -l  my-root</span></div>
<div style="position:absolute;left:84.62px;top:144.96px" class="cls_015"><span class="cls_015">lrwxr-xr-x  ...  result  ->  /nix/store/bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:84.62px;top:166.87px" class="cls_015"><span class="cls_015">$ ls  -l  /nix/var/nix/gcroots/auto</span></div>
<div style="position:absolute;left:84.62px;top:177.83px" class="cls_015"><span class="cls_015">lrwxr-xr-x  ...  096hqdxcf6i2...</span></div>
<div style="position:absolute;left:235.22px;top:177.83px" class="cls_015"><span class="cls_015">->  /home/eelco/test/my-root</span></div>
<div style="position:absolute;left:84.62px;top:199.75px" class="cls_015"><span class="cls_015">$ ./my-root/bin/hello</span></div>
<div style="position:absolute;left:84.62px;top:210.71px" class="cls_015"><span class="cls_015">Hello,  world!</span></div>
<div style="position:absolute;left:59.72px;top:222.41px" class="cls_004"><span class="cls_004">The name of the symlink in</span><span class="cls_007"> auto</span><span class="cls_004"> is a cryptographic hash of the root location (e.g.,</span><span class="cls_007"> /home/-</span></div>
<div style="position:absolute;left:59.72px;top:234.36px" class="cls_007"><span class="cls_007">eelco/test/my-root</span><span class="cls_004">). This ensures that subsequent root registrations with the same location</span></div>
<div style="position:absolute;left:59.72px;top:246.32px" class="cls_004"><span class="cls_004">will overwrite each other (which is good, since it minimises the number of redundant</span></div>
<div style="position:absolute;left:59.72px;top:258.27px" class="cls_004"><span class="cls_004">symlinks in</span><span class="cls_007"> auto</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:69.68px;top:270.23px" class="cls_004"><span class="cls_004">When the garbage collector runs, it chases the symlinks defined in</span><span class="cls_007"> /nix/var/nix/gcroots/-</span></div>
<div style="position:absolute;left:59.72px;top:282.18px" class="cls_007"><span class="cls_007">auto</span><span class="cls_004">. If it encounters a dangling symlink (i.e., pointing to a non-existent path), the root</span></div>
<div style="position:absolute;left:59.72px;top:294.14px" class="cls_004"><span class="cls_004">pointer is automatically deleted. Thus, when</span><span class="cls_007"> result</span><span class="cls_004"> is removed, the root in the</span><span class="cls_007"> auto</span><span class="cls_004"> direc-</span></div>
<div style="position:absolute;left:59.72px;top:306.09px" class="cls_004"><span class="cls_004">tory will be removed as well on the next run of the garbage collector.</span></div>
<div style="position:absolute;left:69.68px;top:318.05px" class="cls_004"><span class="cls_004">Figure 5.19 shows the algorithm for finding the garbage collector roots. It returns a set</span></div>
<div style="position:absolute;left:59.72px;top:330.00px" class="cls_004"><span class="cls_004">of store paths. The closure of this set under the</span><span class="cls_007"> references</span><span class="cls_004"> relation is the set of live paths.</span></div>
<div style="position:absolute;left:69.68px;top:341.96px" class="cls_004"><span class="cls_004">By default there is a symlink in</span><span class="cls_007"> /nix/var/nix/gcroots</span><span class="cls_004"> to the directory</span><span class="cls_007"> /nix/var/nix/profiles/</span></div>
<div style="position:absolute;left:59.72px;top:353.91px" class="cls_004"><span class="cls_004">that contains the user environment generation links. Thus all user environment generations</span></div>
<div style="position:absolute;left:59.72px;top:365.87px" class="cls_004"><span class="cls_004">are roots of the garbage collector.</span></div>
<div style="position:absolute;left:59.72px;top:391.72px" class="cls_009"><span class="cls_009">Discussion</span><span class="cls_004">   Why don’t we scan the entire file system outside of the Nix store for roots?</span></div>
<div style="position:absolute;left:59.72px;top:403.68px" class="cls_004"><span class="cls_004">This is certainly possible, but I have opted for a more disciplined root registration protocol</span></div>
<div style="position:absolute;left:59.72px;top:415.63px" class="cls_004"><span class="cls_004">instead for performance reasons—scanning the entire file system might take too long. Just</span></div>
<div style="position:absolute;left:59.72px;top:427.59px" class="cls_004"><span class="cls_004">scanning for symlink targets is not overly expensive, since it is easy to recognise symlinks</span></div>
<div style="position:absolute;left:59.72px;top:439.54px" class="cls_004"><span class="cls_004">that point to the Nix store. However, to be fully general we should also scan the contents</span></div>
<div style="position:absolute;left:59.72px;top:451.50px" class="cls_004"><span class="cls_004">of regular files, just as we do with the output of a build. Since we do not know anything</span></div>
<div style="position:absolute;left:59.72px;top:463.45px" class="cls_004"><span class="cls_004">about the internal structure of those files, we have to apply</span><span class="cls_007"> scanForReferences</span><span class="cls_004"> to the entire</span></div>
<div style="position:absolute;left:59.72px;top:475.41px" class="cls_004"><span class="cls_004">file system with paths set to all current store paths. Since there can be many store paths—</span></div>
<div style="position:absolute;left:59.72px;top:487.37px" class="cls_004"><span class="cls_004">millions in large installations—this becomes prohibitively expensive.</span></div>
<div style="position:absolute;left:69.68px;top:499.32px" class="cls_004"><span class="cls_004">A possible extension to root discovery is to automatically use open store files as roots.</span></div>
<div style="position:absolute;left:59.72px;top:511.28px" class="cls_004"><span class="cls_004">In the scheme described above, it is possible that a currently executing program is garbage</span></div>
<div style="position:absolute;left:59.72px;top:523.23px" class="cls_004"><span class="cls_004">collected. For instance, the command sequence</span></div>
<div style="position:absolute;left:84.62px;top:544.44px" class="cls_015"><span class="cls_015">$ nix-env  -i  firefox</span></div>
<div style="position:absolute;left:84.62px;top:555.40px" class="cls_015"><span class="cls_015">$ firefox  &</span></div>
<div style="position:absolute;left:145.80px;top:555.40px" class="cls_015"><span class="cls_015"># start  Firefox  in  the  background</span></div>
<div style="position:absolute;left:84.62px;top:566.36px" class="cls_015"><span class="cls_015">$ nix-env  -e  firefox</span></div>
<div style="position:absolute;left:84.62px;top:577.32px" class="cls_015"><span class="cls_015">$ nix-env  --remove-generations  old</span></div>
<div style="position:absolute;left:84.62px;top:588.28px" class="cls_015"><span class="cls_015">$ nix-store  --gc</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">126</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:91080px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background135.jpg" width=481 height=680></div>
<div style="position:absolute;left:326.72px;top:17.14px" class="cls_004"><span class="cls_004">5.6.</span></div>
<div style="position:absolute;left:346.65px;top:17.14px" class="cls_004"><span class="cls_004">Garbage collection</span></div>
<div style="position:absolute;left:72.24px;top:46.83px" class="cls_007"><span class="cls_007">findRoots</span><span class="cls_004">() :</span></div>
<div style="position:absolute;left:87.19px;top:57.63px" class="cls_004"><span class="cls_004">return</span><span class="cls_007"> findRoots</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(</span><span class="cls_007">"/nix/var/nix/gcroots"</span><span class="cls_004">,</span><span class="cls_007"> false</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:72.24px;top:81.64px" class="cls_007"><span class="cls_007">findRoots</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(p, recurseSymlinks) :</span></div>
<div style="position:absolute;left:87.19px;top:94.75px" class="cls_004"><span class="cls_004">if p is a directory :</span></div>
<div style="position:absolute;left:102.13px;top:106.71px" class="cls_004"><span class="cls_004">roots ← 0</span></div>
<div style="position:absolute;left:102.13px;top:118.66px" class="cls_004"><span class="cls_004">for each directory entry n in p :</span></div>
<div style="position:absolute;left:139.32px;top:131.76px" class="cls_004"><span class="cls_004">←</span><span class="cls_007"> findRoots</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(p +</span><span class="cls_007"> "/"</span><span class="cls_004"> + n, recurseSymlinks)</span></div>
<div style="position:absolute;left:102.13px;top:144.87px" class="cls_004"><span class="cls_004">return roots</span></div>
<div style="position:absolute;left:87.19px;top:156.83px" class="cls_004"><span class="cls_004">else if p is a symlink :</span></div>
<div style="position:absolute;left:102.13px;top:168.78px" class="cls_004"><span class="cls_004">target ←</span><span class="cls_007"> targetOf</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:102.13px;top:180.74px" class="cls_004"><span class="cls_004">if target is a store path :</span></div>
<div style="position:absolute;left:117.07px;top:192.69px" class="cls_004"><span class="cls_004">return {p}</span></div>
<div style="position:absolute;left:102.13px;top:204.75px" class="cls_004"><span class="cls_004">else : // target is not a store path</span></div>
<div style="position:absolute;left:117.07px;top:216.70px" class="cls_004"><span class="cls_004">if recurseSymlinks :</span></div>
<div style="position:absolute;left:132.02px;top:228.66px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> pathExists</span><span class="cls_004">(target) :</span></div>
<div style="position:absolute;left:146.96px;top:239.46px" class="cls_004"><span class="cls_004">return</span><span class="cls_007"> findRoots</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(target,</span><span class="cls_007"> false</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:132.02px;top:252.67px" class="cls_004"><span class="cls_004">else :</span></div>
<div style="position:absolute;left:146.96px;top:264.62px" class="cls_007"><span class="cls_007">deletePath</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:164.16px;top:289.41px" class="cls_004"><span class="cls_004">Figure 5.19.:</span><span class="cls_007"> findRoots</span><span class="cls_004">: Root discovery</span></div>
<div style="position:absolute;left:63.87px;top:322.43px" class="cls_004"><span class="cls_004">will cause Firefox to be (probably) garbage collected, even though it is still running.</span></div>
<div style="position:absolute;left:73.84px;top:334.87px" class="cls_004"><span class="cls_004">There is no portable method to discover the set of open files, but on most operating</span></div>
<div style="position:absolute;left:63.87px;top:346.83px" class="cls_004"><span class="cls_004">systems there are methods to do so. For instance, on Linux the open files are the targets of</span></div>
<div style="position:absolute;left:63.87px;top:357.76px" class="cls_004"><span class="cls_004">the symlinks</span><span class="cls_007"> /proc/*/fd/*</span><span class="cls_012"><sup>11</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:371.23px" class="cls_004"><span class="cls_004">A more extreme approach is to scan for roots in memory. On Linux, the device</span><span class="cls_007"> /dev/mem</span></div>
<div style="position:absolute;left:63.87px;top:383.18px" class="cls_004"><span class="cls_004">provides access to the system’s physical memory. This has the same efficiency problem</span></div>
<div style="position:absolute;left:63.87px;top:395.14px" class="cls_004"><span class="cls_004">as scanning in regular files: since we do not know anything about the internal structure</span></div>
<div style="position:absolute;left:63.87px;top:407.09px" class="cls_004"><span class="cls_004">of the memory contents, we have to scan for hash parts.  Furthermore, since</span><span class="cls_007"> /dev/mem</span></div>
<div style="position:absolute;left:63.87px;top:419.05px" class="cls_004"><span class="cls_004">maps the physical address space, hashes may be fragmented in memory if they cross page</span></div>
<div style="position:absolute;left:63.87px;top:431.00px" class="cls_004"><span class="cls_004">boundaries; i.e., if character n of a hash is stored at address m, then character n + 1 need not</span></div>
<div style="position:absolute;left:63.87px;top:442.96px" class="cls_004"><span class="cls_004">necessarily be at address m + 1. The scanner may fail to detect references if this happens.</span></div>
<div style="position:absolute;left:63.87px;top:454.91px" class="cls_004"><span class="cls_004">So memory scanning only works well for memory devices that map virtual address spaces,</span></div>
<div style="position:absolute;left:63.87px;top:466.87px" class="cls_004"><span class="cls_004">e.g.,</span><span class="cls_007"> /proc/*/mem</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:497.27px" class="cls_008"><span class="cls_008">5.6.2. Live paths</span></div>
<div style="position:absolute;left:63.87px;top:517.67px" class="cls_004"><span class="cls_004">The live store paths are those that are reachable from the roots through the</span><span class="cls_007"> references</span></div>
<div style="position:absolute;left:63.87px;top:529.63px" class="cls_004"><span class="cls_004">relation.  However, it is useful to extend the notion of reachability a bit.  For instance,</span></div>
<div style="position:absolute;left:63.87px;top:541.58px" class="cls_004"><span class="cls_004">for some users it is desirable to keep the build-time dependencies of a component: if a</span></div>
<div style="position:absolute;left:63.87px;top:553.54px" class="cls_004"><span class="cls_004">user (e.g., a developer) often builds components from source, it is nice if a build-time</span></div>
<div style="position:absolute;left:65.37px;top:574.65px" class="cls_013"><span class="cls_013"><sup>11</sup></span><span class="cls_014">On Linux, the</span><span class="cls_016"> /proc</span><span class="cls_014"> directory contains subdirectories for each live process containing information about them,</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">e.g.,</span><span class="cls_016"> /proc/7231</span><span class="cls_014">, each having a subdirectory</span><span class="cls_016"> fd</span><span class="cls_014"> that holds symlinks to the open files of the process.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">127</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:91770px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background136.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">dependency like the compiler is retained by the garbage collector.</span></div>
<div style="position:absolute;left:69.68px;top:57.56px" class="cls_004"><span class="cls_004">As another example, consider the traceability afforded by the</span><span class="cls_007"> deriver</span><span class="cls_004"> mapping, which</span></div>
<div style="position:absolute;left:59.72px;top:69.51px" class="cls_004"><span class="cls_004">tells us which derivation built a path. Some techniques, such as the blacklisting approach</span></div>
<div style="position:absolute;left:59.72px;top:81.47px" class="cls_004"><span class="cls_004">described in Section 11.1 to enforce upgrades of insecure or otherwise “bad” components,</span></div>
<div style="position:absolute;left:59.72px;top:93.42px" class="cls_004"><span class="cls_004">rely (in part) on knowledge of the build-time dependency graph.</span></div>
<div style="position:absolute;left:69.68px;top:105.94px" class="cls_004"><span class="cls_004">For this reason, the Nix garbage collector has two options that can be set by the admin-</span></div>
<div style="position:absolute;left:59.72px;top:117.90px" class="cls_004"><span class="cls_004">istrator of a Nix installation.  They both extend the notion of liveness.  The options are</span></div>
<div style="position:absolute;left:59.72px;top:129.85px" class="cls_004"><span class="cls_004">defined in the</span><span class="cls_007"> /nix/etc/nix/nix.conf</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:74.66px;top:151.47px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> gc-keep-outputs</span><span class="cls_004">:  If</span><span class="cls_007"> true</span><span class="cls_004">,  the garbage collector will keep the outputs of non-</span></div>
<div style="position:absolute;left:84.62px;top:163.42px" class="cls_004"><span class="cls_004">garbage  derivations.   That  is,  if  derivation  p  is  live,  then  its  output  path</span></div>
<div style="position:absolute;left:84.62px;top:175.38px" class="cls_007"><span class="cls_007">parseDrv</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">)).</span><span class="cls_007">output</span><span class="cls_004"> is also live (if it is valid).  If</span><span class="cls_007"> false</span><span class="cls_004"> (which is the</span></div>
<div style="position:absolute;left:84.62px;top:187.33px" class="cls_004"><span class="cls_004">default), derivation outputs are not followed, so they will be deleted unless they are</span></div>
<div style="position:absolute;left:84.62px;top:199.29px" class="cls_004"><span class="cls_004">roots themselves (or reachable from other roots).</span></div>
<div style="position:absolute;left:84.62px;top:216.36px" class="cls_004"><span class="cls_004">Note that this is stronger than registering the output of a derivation as a separate root,</span></div>
<div style="position:absolute;left:84.62px;top:228.31px" class="cls_004"><span class="cls_004">since it is transitive. That is, it keeps not just the output of the top-level derivation,</span></div>
<div style="position:absolute;left:84.62px;top:240.27px" class="cls_004"><span class="cls_004">but also the outputs of all its subderivations. For instance, if we registered the Hello</span></div>
<div style="position:absolute;left:84.62px;top:252.22px" class="cls_004"><span class="cls_004">derivation</span><span class="cls_007"> /nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span><span class="cls_004"> as a root, then not only would</span></div>
<div style="position:absolute;left:84.62px;top:264.18px" class="cls_004"><span class="cls_004">the Hello output</span><span class="cls_007"> /nix/store/bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004"> be kept (if valid), but also the</span></div>
<div style="position:absolute;left:84.62px;top:276.13px" class="cls_004"><span class="cls_004">source distribution downloaded by</span><span class="cls_007"> fetchurl</span><span class="cls_004">, the C compiler, and so on.</span></div>
<div style="position:absolute;left:74.66px;top:298.31px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> gc-keep-derivations</span><span class="cls_004">: If</span><span class="cls_007"> true</span><span class="cls_004"> (the default), the garbage collector will keep the deriva-</span></div>
<div style="position:absolute;left:84.62px;top:310.27px" class="cls_004"><span class="cls_004">tions from which non-garbage store paths were built. That is, if store path p is live,</span></div>
<div style="position:absolute;left:84.62px;top:322.22px" class="cls_004"><span class="cls_004">then its deriver</span><span class="cls_007"> deriver</span><span class="cls_004">[p] is also live (if defined and valid).</span></div>
<div style="position:absolute;left:69.68px;top:343.84px" class="cls_004"><span class="cls_004">Thus, the first option causes liveness to flow from derivations to outputs, while the sec-</span></div>
<div style="position:absolute;left:59.72px;top:355.79px" class="cls_004"><span class="cls_004">ond causes liveness to flow from outputs to derivations. Typically, developers turn both</span></div>
<div style="position:absolute;left:59.72px;top:367.75px" class="cls_004"><span class="cls_004">options on to ensure that all build-time dependencies are kept, even when only the outputs</span></div>
<div style="position:absolute;left:59.72px;top:379.70px" class="cls_004"><span class="cls_004">are registered as roots.</span></div>
<div style="position:absolute;left:69.68px;top:392.22px" class="cls_004"><span class="cls_004">Figure 5.20 shows the computation of the set of live paths from the set of roots.  It</span></div>
<div style="position:absolute;left:59.72px;top:404.17px" class="cls_004"><span class="cls_004">performs a simple traversal through the graph of store paths with edges defined by the</span></div>
<div style="position:absolute;left:59.72px;top:416.13px" class="cls_004"><span class="cls_004">union of the</span><span class="cls_007"> references</span><span class="cls_004"> relation, and the</span><span class="cls_007"> deriver</span><span class="cls_004"> and</span><span class="cls_007"> output</span><span class="cls_004"> links.</span></div>
<div style="position:absolute;left:59.72px;top:446.95px" class="cls_008"><span class="cls_008">5.6.3. Stop-the-world garbage collection</span></div>
<div style="position:absolute;left:59.72px;top:467.50px" class="cls_004"><span class="cls_004">After we have computed the live paths, we can garbage-collect by deleting all paths that</span></div>
<div style="position:absolute;left:59.72px;top:479.45px" class="cls_004"><span class="cls_004">are not live. However, life is not quite so simple:</span></div>
<div style="position:absolute;left:74.66px;top:501.07px" class="cls_004"><span class="cls_004">• Some non-live paths are actually about to be “born”, i.e., they are currently being</span></div>
<div style="position:absolute;left:84.62px;top:513.02px" class="cls_004"><span class="cls_004">built by some derivation.</span></div>
<div style="position:absolute;left:74.66px;top:535.20px" class="cls_004"><span class="cls_004">• Paths that are garbage at the beginning of the collection might be “resurrected”.</span></div>
<div style="position:absolute;left:84.62px;top:547.16px" class="cls_004"><span class="cls_004">This is a big difference with garbage collection in general [179]. In programming</span></div>
<div style="position:absolute;left:84.62px;top:559.11px" class="cls_004"><span class="cls_004">language implementations, garbage memory objects can never become live again</span></div>
<div style="position:absolute;left:84.62px;top:571.07px" class="cls_004"><span class="cls_004">because there are no pointers to them, and pointers are only created through allo-</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">cation from the free space. Here, pointers (paths) are computed deterministically,</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">128</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:92460px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background137.jpg" width=481 height=680></div>
<div style="position:absolute;left:326.72px;top:17.14px" class="cls_004"><span class="cls_004">5.6. Garbage collection</span></div>
<div style="position:absolute;left:72.24px;top:46.83px" class="cls_007"><span class="cls_007">livePaths</span><span class="cls_004">(roots) :</span></div>
<div style="position:absolute;left:87.19px;top:58.79px" class="cls_004"><span class="cls_004">todo ← roots</span></div>
<div style="position:absolute;left:87.19px;top:70.74px" class="cls_004"><span class="cls_004">done ← /0</span></div>
<div style="position:absolute;left:87.19px;top:82.70px" class="cls_004"><span class="cls_004">while todo = 0</span></div>
<div style="position:absolute;left:102.88px;top:94.65px" class="cls_004"><span class="cls_004">p ← remove one path from todo</span></div>
<div style="position:absolute;left:102.13px;top:106.61px" class="cls_004"><span class="cls_004">if p ∈ done :</span></div>
<div style="position:absolute;left:138.66px;top:120.86px" class="cls_004"><span class="cls_004">← {p}</span></div>
<div style="position:absolute;left:137.00px;top:135.12px" class="cls_004"><span class="cls_004">←</span><span class="cls_007"> closure</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:117.07px;top:147.07px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> gc-keep-outputs</span><span class="cls_004"> =</span><span class="cls_007"> true</span><span class="cls_004"> ∧ p ends in</span><span class="cls_007"> ".drv"</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:132.02px;top:159.03px" class="cls_004"><span class="cls_004">d ← </span><span class="cls_007">parseDrv</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:132.02px;top:170.98px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> valid</span><span class="cls_004">[d.</span><span class="cls_007">output</span><span class="cls_004">] = ε :</span></div>
<div style="position:absolute;left:166.89px;top:185.24px" class="cls_004"><span class="cls_004">← {d.</span><span class="cls_007">output</span><span class="cls_004">}</span></div>
<div style="position:absolute;left:117.07px;top:197.19px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> gc-keep-derivations</span><span class="cls_004"> =</span><span class="cls_007"> true</span><span class="cls_004"> ∧</span><span class="cls_007"> deriver</span><span class="cls_004">[p] = ε ∧</span><span class="cls_007"> valid</span><span class="cls_004">[</span><span class="cls_007">deriver</span><span class="cls_004">[p]] = ε :</span></div>
<div style="position:absolute;left:151.95px;top:211.45px" class="cls_004"><span class="cls_004">← {</span><span class="cls_007">deriver</span><span class="cls_004">[p]}</span></div>
<div style="position:absolute;left:87.19px;top:223.40px" class="cls_004"><span class="cls_004">return done</span></div>
<div style="position:absolute;left:133.15px;top:248.09px" class="cls_004"><span class="cls_004">Figure 5.20.:</span><span class="cls_007"> livePaths</span><span class="cls_004">: Computing the set of live paths</span></div>
<div style="position:absolute;left:88.78px;top:281.38px" class="cls_004"><span class="cls_004">so they can be recreated.  For example, suppose that the Hello output</span><span class="cls_007"> /nix/store/-</span></div>
<div style="position:absolute;left:88.78px;top:293.34px" class="cls_007"><span class="cls_007">bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004"> is dead at the start of the collection run.  During the</span></div>
<div style="position:absolute;left:88.78px;top:305.29px" class="cls_004"><span class="cls_004">collection, a user may run</span><span class="cls_007"> nix-env -i hello</span><span class="cls_004"> and so make it reachable and live again.</span></div>
<div style="position:absolute;left:73.84px;top:327.09px" class="cls_004"><span class="cls_004">The simplest solution by far is to use “stop-the-world” garbage collection, which means</span></div>
<div style="position:absolute;left:63.87px;top:339.04px" class="cls_004"><span class="cls_004">that there are no other Nix operations while the collector is running.  A stop-the-world</span></div>
<div style="position:absolute;left:63.87px;top:351.00px" class="cls_004"><span class="cls_004">collector is shown in pseudo-code in Figure 5.21.</span></div>
<div style="position:absolute;left:73.84px;top:363.58px" class="cls_004"><span class="cls_004">Stop-the-world semantics is implemented by using a global lock. All normal Nix pro-</span></div>
<div style="position:absolute;left:63.87px;top:374.51px" class="cls_004"><span class="cls_004">cesses acquire a read (shared) lock when they start, and release it when they terminate</span><span class="cls_012"><sup>12</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:387.49px" class="cls_004"><span class="cls_004">The garbage collector, on the other hand, acquires a write (exclusive) lock on startup</span><span class="cls_014"> </span><span class="cls_056">94</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:399.44px" class="cls_004"><span class="cls_004">Thus the collector can only proceed when there are no other processes modifying the store</span></div>
<div style="position:absolute;left:63.87px;top:411.40px" class="cls_004"><span class="cls_004">or the database.  While the collector is running, new processes block until the collector</span></div>
<div style="position:absolute;left:63.87px;top:423.35px" class="cls_004"><span class="cls_004">finishes.</span></div>
<div style="position:absolute;left:73.84px;top:435.93px" class="cls_004"><span class="cls_004">The collector then finds the roots and computes the set of live paths. Next, it finds the</span></div>
<div style="position:absolute;left:63.87px;top:447.89px" class="cls_004"><span class="cls_004">set of dead paths by reading the entries in the Nix store and tossing out those that are in</span></div>
<div style="position:absolute;left:63.87px;top:459.84px" class="cls_004"><span class="cls_004">the live set</span><span class="cls_014"> </span><span class="cls_056">95</span><span class="cls_059"> </span><span class="cls_004">. The dead paths should then be deleted. However, they cannot be deleted</span></div>
<div style="position:absolute;left:63.87px;top:471.80px" class="cls_004"><span class="cls_004">in arbitrary order, since that violates the closure invariant.  This does not matter if the</span></div>
<div style="position:absolute;left:63.87px;top:483.75px" class="cls_004"><span class="cls_004">collector runs to completion, since at that time the closure invariant holds again. But if the</span></div>
<div style="position:absolute;left:63.87px;top:495.71px" class="cls_004"><span class="cls_004">collector is interrupted prematurely, we can have a store that violates the closure invariant.</span></div>
<div style="position:absolute;left:63.87px;top:507.66px" class="cls_004"><span class="cls_004">Consider a store with the Hello output and one of its dependencies, Glibc. Suppose that</span></div>
<div style="position:absolute;left:63.87px;top:519.62px" class="cls_004"><span class="cls_004">both are dead and about to be deleted. The collector deletes Glibc but is interrupted before</span></div>
<div style="position:absolute;left:63.87px;top:531.57px" class="cls_004"><span class="cls_004">it can delete Hello. Then Hello is still valid, and so if the user were to run</span><span class="cls_007"> nix-env -i hello</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:63.87px;top:543.53px" class="cls_004"><span class="cls_004">an incomplete Hello is installed into the user environment. (Note that the build algorithm</span></div>
<div style="position:absolute;left:65.37px;top:565.18px" class="cls_013"><span class="cls_013"><sup>12</sup></span><span class="cls_014">This is not shown here, but such a lock is acquired in POSIX using the system call</span><span class="cls_016"> fcntl</span><span class="cls_014">(fd,</span><span class="cls_016"> F_SETLKW</span><span class="cls_014">, ...) and</span></div>
<div style="position:absolute;left:75.83px;top:575.55px" class="cls_014"><span class="cls_014">passing a lock type</span><span class="cls_016"> F_RDLCK</span><span class="cls_014">. In contrast, the exclusive lock acquired by</span><span class="cls_016"> acquirePathLock</span><span class="cls_014"> in Figure 5.4 uses</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_016"><span class="cls_016">F_WRLCK</span><span class="cls_014">.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">129</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:93150px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background138.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:68.09px;top:46.83px" class="cls_007"><span class="cls_007">gc</span><span class="cls_004">() :</span></div>
<div style="position:absolute;left:83.03px;top:58.79px" class="cls_004"><span class="cls_004">lock ←</span><span class="cls_007"> acquirePathLock</span><span class="cls_004">(</span><span class="cls_007">"/nix/var/nix/global"</span><span class="cls_004">)</span><span class="cls_014"> </span><span class="cls_056">94</span></div>
<div style="position:absolute;left:83.03px;top:70.74px" class="cls_004"><span class="cls_004">roots ←</span><span class="cls_007"> findRoots</span><span class="cls_004">()</span></div>
<div style="position:absolute;left:83.03px;top:82.70px" class="cls_004"><span class="cls_004">live ←</span><span class="cls_007"> livePaths</span><span class="cls_004">(roots)</span></div>
<div style="position:absolute;left:83.03px;top:94.65px" class="cls_004"><span class="cls_004">dead ← /0</span></div>
<div style="position:absolute;left:83.03px;top:106.61px" class="cls_004"><span class="cls_004">for each directory entry n in the Nix store (storeDir) :</span></div>
<div style="position:absolute;left:98.72px;top:118.56px" class="cls_004"><span class="cls_004">p ← storeDir+</span><span class="cls_007">"/"</span><span class="cls_004">+n</span></div>
<div style="position:absolute;left:97.97px;top:130.52px" class="cls_004"><span class="cls_004">if p ∈ live :</span></div>
<div style="position:absolute;left:148.53px;top:132.51px" class="cls_056"><span class="cls_056">95</span></div>
<div style="position:absolute;left:134.50px;top:144.77px" class="cls_004"><span class="cls_004">← {p}</span></div>
<div style="position:absolute;left:83.03px;top:155.41px" class="cls_004"><span class="cls_004">dead</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ← topological sort of dead under the</span><span class="cls_007"> references</span><span class="cls_004"> relation</span></div>
<div style="position:absolute;left:92.99px;top:168.68px" class="cls_004"><span class="cls_004">such that p &lt; q if q ∈</span><span class="cls_007"> references</span><span class="cls_004">[p]</span><span class="cls_014"> </span><span class="cls_056">96</span></div>
<div style="position:absolute;left:83.03px;top:179.32px" class="cls_004"><span class="cls_004">for each p ∈ dead</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> (in topologically sorted order) :</span></div>
<div style="position:absolute;left:97.97px;top:192.59px" class="cls_007"><span class="cls_007">invalidatePath</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:97.97px;top:204.55px" class="cls_007"><span class="cls_007">deletePath</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:83.03px;top:216.50px" class="cls_007"><span class="cls_007">releasePathLock</span><span class="cls_004">(</span><span class="cls_007">"/nix/var/nix/global"</span><span class="cls_004">, lock)</span></div>
<div style="position:absolute;left:68.09px;top:240.41px" class="cls_007"><span class="cls_007">invalidatePath</span><span class="cls_004">(p) :</span></div>
<div style="position:absolute;left:83.03px;top:252.37px" class="cls_004"><span class="cls_004">In a database transaction:</span><span class="cls_014"> </span><span class="cls_056">97</span></div>
<div style="position:absolute;left:97.97px;top:264.32px" class="cls_007"><span class="cls_007">valid</span><span class="cls_004">[p] ← ε</span></div>
<div style="position:absolute;left:97.97px;top:275.25px" class="cls_004"><span class="cls_004">for each p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ∈</span><span class="cls_007"> references</span><span class="cls_004">[p] :</span></div>
<div style="position:absolute;left:112.92px;top:287.21px" class="cls_007"><span class="cls_007">referers</span><span class="cls_004">[p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">] ←</span><span class="cls_007"> referers</span><span class="cls_004">[p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">] − {p}</span></div>
<div style="position:absolute;left:97.97px;top:300.29px" class="cls_007"><span class="cls_007">references</span><span class="cls_004">[p] ← ε</span></div>
<div style="position:absolute;left:97.97px;top:312.25px" class="cls_007"><span class="cls_007">deriver</span><span class="cls_004">[p] ← ε</span></div>
<div style="position:absolute;left:146.25px;top:336.93px" class="cls_004"><span class="cls_004">Figure 5.21.: Stop-the-world garbage collector</span></div>
<div style="position:absolute;left:59.72px;top:370.22px" class="cls_004"><span class="cls_004">through</span><span class="cls_007"> substitute</span><span class="cls_004"> in Figure 5.15 only checks the validity of the top-level path, and not</span></div>
<div style="position:absolute;left:59.72px;top:382.17px" class="cls_004"><span class="cls_004">its references, since the closure invariant makes such a check redundant. So it is actually</span></div>
<div style="position:absolute;left:59.72px;top:394.13px" class="cls_004"><span class="cls_004">difficult to recover from an inconsistent store; we cannot just rebuild all derivations.)</span></div>
<div style="position:absolute;left:69.68px;top:406.70px" class="cls_004"><span class="cls_004">To prevent this, we need to make sure that a path is deleted before its references are</span></div>
<div style="position:absolute;left:59.72px;top:418.66px" class="cls_004"><span class="cls_004">deleted. That is, if p refers to q, then p must be deleted before q. This defines a partial</span></div>
<div style="position:absolute;left:59.72px;top:430.61px" class="cls_004"><span class="cls_004">ordering on the set of dead paths. A correct ordering on the set of dead paths that preserves</span></div>
<div style="position:absolute;left:59.72px;top:442.57px" class="cls_004"><span class="cls_004">the closure invariant can therefore be found by topologically sorting the dead paths under</span></div>
<div style="position:absolute;left:59.72px;top:454.52px" class="cls_004"><span class="cls_004">the relation &lt;, where p &lt; q if q ∈</span><span class="cls_007"> references</span><span class="cls_004">[p]</span><span class="cls_014"> </span><span class="cls_056">96</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:467.10px" class="cls_004"><span class="cls_004">Before each store object is deleted, its metadata in the database should be cleared, which</span></div>
<div style="position:absolute;left:59.72px;top:479.05px" class="cls_004"><span class="cls_004">is done by the function</span><span class="cls_007"> invalidatePath</span><span class="cls_014"> </span><span class="cls_056">97</span><span class="cls_059"> </span><span class="cls_004">. The cleanup must be done in a transaction to</span></div>
<div style="position:absolute;left:59.72px;top:491.01px" class="cls_004"><span class="cls_004">maintain database integrity.  It must also be done before path deletion to maintain the</span></div>
<div style="position:absolute;left:59.72px;top:502.96px" class="cls_004"><span class="cls_004">validity invariant (Invariant 1).</span></div>
<div style="position:absolute;left:69.68px;top:515.54px" class="cls_004"><span class="cls_004">It is easy to see that the collector in Figure 5.21 maintains the closure invariant.</span></div>
<div style="position:absolute;left:59.72px;top:537.33px" class="cls_004"><span class="cls_004">Lemma 3 (No cycles in references graph). The references graph contains no non-trivial</span></div>
<div style="position:absolute;left:59.72px;top:549.28px" class="cls_004"><span class="cls_004">cycles. A cycle is trivial if it is a self-reference, i.e., p ∈</span><span class="cls_007"> references</span><span class="cls_004">[p].</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">Proof. This property follows trivially from the fact that a path’s references must exist prior</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">to the creation of the path (since the references, determined by</span><span class="cls_007"> scanForReferences</span><span class="cls_004">, are a</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">130</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:93840px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background139.jpg" width=481 height=680></div>
<div style="position:absolute;left:326.72px;top:17.14px" class="cls_004"><span class="cls_004">5.6. Garbage collection</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">subset of the inputs in Figure 5.11). A cycle means that there must exist a path p</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> that</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">references a path p</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> that did not exist at the time p</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> was created.</span></div>
<div style="position:absolute;left:63.87px;top:77.48px" class="cls_004"><span class="cls_004">Theorem 4 (GC correctness). The garbage collector in Figure 5.21 maintains the closure</span></div>
<div style="position:absolute;left:63.87px;top:89.44px" class="cls_004"><span class="cls_004">invariant at all times.</span></div>
<div style="position:absolute;left:63.87px;top:109.57px" class="cls_004"><span class="cls_004">Proof. Assume that the invariant holds at the start of the garbage collector run. By con-</span></div>
<div style="position:absolute;left:63.87px;top:121.53px" class="cls_004"><span class="cls_004">tradiction, assume that the invariant is then violated at some point. This means that there</span></div>
<div style="position:absolute;left:63.87px;top:133.48px" class="cls_004"><span class="cls_004">exists a valid path p and an invalid path q, such that q ∈</span><span class="cls_007"> references</span><span class="cls_004">[p].  However, then</span></div>
<div style="position:absolute;left:64.62px;top:145.44px" class="cls_004"><span class="cls_004">p &lt; q under the ordering defined above, and since by Lemma 3 there are no cycles in the</span></div>
<div style="position:absolute;left:63.87px;top:157.39px" class="cls_004"><span class="cls_004">references graph, p &lt; q implies ¬(q &lt; p). This means that p must have been deleted and</span></div>
<div style="position:absolute;left:63.87px;top:169.35px" class="cls_004"><span class="cls_004">made invalid before q. Thus p is both valid and invalid, a contradiction.</span></div>
<div style="position:absolute;left:63.87px;top:197.45px" class="cls_008"><span class="cls_008">5.6.4. Concurrent garbage collection</span></div>
<div style="position:absolute;left:63.87px;top:217.06px" class="cls_004"><span class="cls_004">Stop-the-world garbage collection, while simple to implement, has very bad latency. While</span></div>
<div style="position:absolute;left:63.87px;top:229.02px" class="cls_004"><span class="cls_004">the collector runs, no other Nix processes can start (that is, they block until the collector</span></div>
<div style="position:absolute;left:63.87px;top:240.97px" class="cls_004"><span class="cls_004">finishes).  This is unacceptable, since the collector might run for a very long time.  For</span></div>
<div style="position:absolute;left:63.87px;top:252.93px" class="cls_004"><span class="cls_004">instance, in our Nix-based build farm (Chapter 8), where we run the collector once every</span></div>
<div style="position:absolute;left:63.87px;top:264.88px" class="cls_004"><span class="cls_004">few months, it can take a few hours to delete some 100 gigabytes of garbage.</span></div>
<div style="position:absolute;left:73.84px;top:276.91px" class="cls_004"><span class="cls_004">Worse, there is a liveness issue: the collector might never start.  If there always is a</span></div>
<div style="position:absolute;left:63.87px;top:288.86px" class="cls_004"><span class="cls_004">process holding a read lock, then the collector cannot acquire a write lock.  Of course,</span></div>
<div style="position:absolute;left:63.87px;top:300.82px" class="cls_004"><span class="cls_004">any such process should terminate eventually, but by that time another process may have</span></div>
<div style="position:absolute;left:63.87px;top:312.77px" class="cls_004"><span class="cls_004">acquired a read lock as well. In a build farm or a Nix store with a similarly high utilisation,</span></div>
<div style="position:absolute;left:63.87px;top:324.73px" class="cls_004"><span class="cls_004">there might never be a point in time in which there is no process holding a read lock. If</span></div>
<div style="position:absolute;left:63.87px;top:336.68px" class="cls_004"><span class="cls_004">locks are strongly fair [3], this is not a problem: the kernel will just block further attempts</span></div>
<div style="position:absolute;left:63.87px;top:348.64px" class="cls_004"><span class="cls_004">to acquire a read lock while the garbage collector is waiting for a write lock. However, this</span></div>
<div style="position:absolute;left:63.87px;top:359.57px" class="cls_004"><span class="cls_004">is not the case in general</span><span class="cls_012"><sup>13</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:372.62px" class="cls_004"><span class="cls_004">Therefore we need a concurrent garbage collector—one that can run even as other Nix</span></div>
<div style="position:absolute;left:63.87px;top:384.58px" class="cls_004"><span class="cls_004">operations are executing. This section shows first a partially concurrent collector that ad-</span></div>
<div style="position:absolute;left:63.87px;top:396.53px" class="cls_004"><span class="cls_004">dresses the liveness issue, i.e., that can run in parallel with already existing Nix processes.</span></div>
<div style="position:absolute;left:63.87px;top:408.49px" class="cls_004"><span class="cls_004">In particular, builds that are in progress (and that might take a long time to finish) do not</span></div>
<div style="position:absolute;left:63.87px;top:420.44px" class="cls_004"><span class="cls_004">prevent the collector from starting. We can then improve the latency problem by making</span></div>
<div style="position:absolute;left:63.87px;top:432.40px" class="cls_004"><span class="cls_004">this collector run incrementally.</span></div>
<div style="position:absolute;left:73.84px;top:444.42px" class="cls_004"><span class="cls_004">The main issues to consider are the following:</span></div>
<div style="position:absolute;left:78.82px;top:464.56px" class="cls_004"><span class="cls_004">• Some paths may be in use but may not yet be reachable from a root, e.g., during a</span></div>
<div style="position:absolute;left:88.78px;top:476.51px" class="cls_004"><span class="cls_004">build done by</span><span class="cls_007"> nix-env</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:78.82px;top:496.72px" class="cls_004"><span class="cls_004">• New roots may be created while the collector is running. Paths reachable from those</span></div>
<div style="position:absolute;left:88.78px;top:508.67px" class="cls_004"><span class="cls_004">roots should not be deleted.</span></div>
<div style="position:absolute;left:73.84px;top:528.81px" class="cls_004"><span class="cls_004">The solution to the first problem is to have running processes write a log of all store paths</span></div>
<div style="position:absolute;left:63.87px;top:540.76px" class="cls_004"><span class="cls_004">that they are about to access or create to a log file, which is read by the collector. Such a log</span></div>
<div style="position:absolute;left:63.87px;top:552.72px" class="cls_004"><span class="cls_004">file is per-process, e.g.,</span><span class="cls_007"> /nix/var/nix/temproots/15726</span><span class="cls_004">, where</span><span class="cls_007"> 15726</span><span class="cls_004"> is the Unix process ID.</span></div>
<div style="position:absolute;left:63.87px;top:564.67px" class="cls_004"><span class="cls_004">The store paths in those files are called temporary roots. Function</span><span class="cls_007"> addTempRoot</span><span class="cls_004">, shown in</span></div>
<div style="position:absolute;left:65.37px;top:584.11px" class="cls_013"><span class="cls_013"><sup>13</sup></span><span class="cls_014">For instance, strong fairness is not specified for POSIX’s</span><span class="cls_016"> fcntl</span><span class="cls_014"> operations.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">131</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:94530px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background140.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:68.09px;top:46.83px" class="cls_007"><span class="cls_007">addTempRoot</span><span class="cls_004">(p) :</span></div>
<div style="position:absolute;left:83.03px;top:58.79px" class="cls_004"><span class="cls_004">if this is the first call to</span><span class="cls_007"> addTempRoot</span><span class="cls_004"> in this process :</span></div>
<div style="position:absolute;left:97.97px;top:70.74px" class="cls_004"><span class="cls_004">do :</span></div>
<div style="position:absolute;left:112.92px;top:82.70px" class="cls_004"><span class="cls_004">Acquire a read lock on</span><span class="cls_007"> "/nix/var/nix/gc"</span><span class="cls_014"> </span><span class="cls_056">98</span></div>
<div style="position:absolute;left:112.92px;top:94.65px" class="cls_004"><span class="cls_004">fd ←</span><span class="cls_007"> open</span><span class="cls_004">(</span><span class="cls_007">"/nix/var/nix/temproots/"</span><span class="cls_004"> + pid,</span></div>
<div style="position:absolute;left:122.88px;top:106.61px" class="cls_007"><span class="cls_007">O_WRONLY</span><span class="cls_004">|</span><span class="cls_007">O_CREAT</span><span class="cls_004">|</span><span class="cls_007">O_TRUNC</span><span class="cls_004">, 0666)</span><span class="cls_014"> </span><span class="cls_056">99</span></div>
<div style="position:absolute;left:112.92px;top:118.56px" class="cls_004"><span class="cls_004">Release the read lock on</span><span class="cls_007"> "/nix/var/nix/gc"</span></div>
<div style="position:absolute;left:112.92px;top:130.52px" class="cls_004"><span class="cls_004">Acquire a read lock on fd</span></div>
<div style="position:absolute;left:97.97px;top:142.47px" class="cls_004"><span class="cls_004">while file fd is not empty</span><span class="cls_014"> </span><span class="cls_056">100</span></div>
<div style="position:absolute;left:83.03px;top:154.43px" class="cls_004"><span class="cls_004">Upgrade the read lock on fd to a write lock</span><span class="cls_014"> </span><span class="cls_056">101</span></div>
<div style="position:absolute;left:83.03px;top:166.38px" class="cls_004"><span class="cls_004">Write p to fd</span></div>
<div style="position:absolute;left:83.03px;top:178.34px" class="cls_004"><span class="cls_004">Downgrade the write lock on fd to a read lock</span></div>
<div style="position:absolute;left:86.01px;top:203.03px" class="cls_004"><span class="cls_004">Figure 5.22.:</span><span class="cls_007"> addTempRoot</span><span class="cls_004">: Registering a temporary garbage collection root</span></div>
<div style="position:absolute;left:59.72px;top:235.24px" class="cls_004"><span class="cls_004">Figure 5.22, shows how a process registers a store path p as a temporary root. The idea is</span></div>
<div style="position:absolute;left:59.72px;top:247.19px" class="cls_004"><span class="cls_004">that to register a root, the process must acquire a write lock on its per-process log file</span><span class="cls_014"> </span><span class="cls_056">101</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:59.72px;top:259.15px" class="cls_004"><span class="cls_004">The garbage collector, shown below, will acquire a read lock on each per-process log file.</span></div>
<div style="position:absolute;left:59.72px;top:271.10px" class="cls_004"><span class="cls_004">Thus, no process can proceed after the garbage collector has acquired a read lock on its log</span></div>
<div style="position:absolute;left:59.72px;top:283.06px" class="cls_004"><span class="cls_004">file.</span></div>
<div style="position:absolute;left:69.68px;top:295.10px" class="cls_004"><span class="cls_004">There is a mechanism in place to clean up stale log files in</span><span class="cls_007"> /nix/var/nix/temproots</span><span class="cls_004">. When</span></div>
<div style="position:absolute;left:59.72px;top:307.05px" class="cls_004"><span class="cls_004">the log file is first created</span></div>
<div style="position:absolute;left:172.31px;top:307.05px" class="cls_056"><span class="cls_056">99</span><span class="cls_059"> </span><span class="cls_004">, a read lock is acquired to enable the collector to detect</span></div>
<div style="position:absolute;left:59.72px;top:319.01px" class="cls_004"><span class="cls_004">whether the log file is stale.  If the collector can acquire a write lock on a log file, then</span></div>
<div style="position:absolute;left:59.72px;top:330.96px" class="cls_004"><span class="cls_004">apparently the corresponding process has died without removing its own log file, and thus</span></div>
<div style="position:absolute;left:59.72px;top:342.92px" class="cls_004"><span class="cls_004">the collector can remove the log file. However, to prevent a race with file creation, i.e., the</span></div>
<div style="position:absolute;left:59.72px;top:354.87px" class="cls_004"><span class="cls_004">collector removing a newly created log file before the process can acquire a lock on it, we</span></div>
<div style="position:absolute;left:59.72px;top:366.83px" class="cls_004"><span class="cls_004">use</span><span class="cls_007"> deleteSignal</span><span class="cls_004"> (page 98) to signal and detect this condition</span><span class="cls_014"> </span><span class="cls_056">100</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:378.87px" class="cls_004"><span class="cls_004">There are several instances where</span><span class="cls_007"> addTempRoot</span><span class="cls_004"> must be called:</span></div>
<div style="position:absolute;left:74.66px;top:399.04px" class="cls_004"><span class="cls_004">• In</span><span class="cls_007"> addToStore</span><span class="cls_004"> (Figure 5.3), after the call to</span><span class="cls_007"> makePath</span><span class="cls_004"> and before the first valid-</span></div>
<div style="position:absolute;left:84.62px;top:411.00px" class="cls_004"><span class="cls_004">ity check. This ensures that the results of Nix expression translation are kept until</span></div>
<div style="position:absolute;left:84.62px;top:422.95px" class="cls_004"><span class="cls_004">process termination.</span></div>
<div style="position:absolute;left:74.66px;top:443.21px" class="cls_004"><span class="cls_004">• In</span><span class="cls_007"> substitute</span><span class="cls_004"> (Figure 5.15), before the validity check. This ensures that the results of</span></div>
<div style="position:absolute;left:84.62px;top:455.17px" class="cls_004"><span class="cls_004">builds are kept until process termination.</span></div>
<div style="position:absolute;left:59.72px;top:475.34px" class="cls_004"><span class="cls_004">On the other hand, we don’t register the derivation path p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004"> in</span><span class="cls_007"> build</span><span class="cls_004"> (Figure 5.11) as a tem-</span></div>
<div style="position:absolute;left:59.72px;top:487.30px" class="cls_004"><span class="cls_004">porary root, even though p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004"> is going to be accessed. The reasoning is that registering p</span><span class="cls_012"><sub>drv</sub></span></div>
<div style="position:absolute;left:59.72px;top:499.25px" class="cls_004"><span class="cls_004">is someone else’s responsibility. For instance, in an execution of</span><span class="cls_007"> nix-env</span><span class="cls_004">, any derivation</span></div>
<div style="position:absolute;left:59.72px;top:511.21px" class="cls_004"><span class="cls_004">path will have been registered in the same process by</span><span class="cls_007"> addToStore</span><span class="cls_004"> in the Nix expression</span></div>
<div style="position:absolute;left:59.72px;top:523.16px" class="cls_004"><span class="cls_004">translation. Likewise, in a call to</span><span class="cls_007"> nix-store --realise</span><span class="cls_004">, the user is responsible for registering</span></div>
<div style="position:absolute;left:59.72px;top:535.12px" class="cls_004"><span class="cls_004">the argument as a root (e.g., by using</span><span class="cls_007"> nix-instantiate --add-root</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:69.68px;top:547.16px" class="cls_004"><span class="cls_004">The second problem—new roots being created while the collector is running—is ad-</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">dressed by blocking the creation of new roots while the collector is running.  To reg-</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">ister a permanent root, a process must first acquire a read lock on the global lock file</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_007"><span class="cls_007">"/nix/var/nix/gc"</span><span class="cls_004">. The collector on the other hand acquires a write lock and holds it during</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">132</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:95220px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background141.jpg" width=481 height=680></div>
<div style="position:absolute;left:326.72px;top:17.14px" class="cls_004"><span class="cls_004">5.6.</span></div>
<div style="position:absolute;left:346.65px;top:17.14px" class="cls_004"><span class="cls_004">Garbage collection</span></div>
<div style="position:absolute;left:72.24px;top:46.83px" class="cls_007"><span class="cls_007">gc</span><span class="cls_004">() :</span></div>
<div style="position:absolute;left:87.19px;top:58.79px" class="cls_004"><span class="cls_004">Acquire a write lock on</span><span class="cls_007"> "/nix/var/nix/gc"</span><span class="cls_014"> </span><span class="cls_056">102</span></div>
<div style="position:absolute;left:87.19px;top:70.74px" class="cls_004"><span class="cls_004">roots ←</span><span class="cls_007"> findRoots</span><span class="cls_004">()</span><span class="cls_014"> </span><span class="cls_056">103</span></div>
<div style="position:absolute;left:87.19px;top:82.70px" class="cls_004"><span class="cls_004">live ←</span><span class="cls_007"> livePaths</span><span class="cls_004">(roots)</span></div>
<div style="position:absolute;left:87.19px;top:94.65px" class="cls_004"><span class="cls_004">temp ← /0</span></div>
<div style="position:absolute;left:87.19px;top:106.61px" class="cls_004"><span class="cls_004">for each log file l in</span><span class="cls_007"> "/nix/var/nix/temproots/"</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:275.11px;top:108.60px" class="cls_056"><span class="cls_056">104</span></div>
<div style="position:absolute;left:102.13px;top:118.56px" class="cls_004"><span class="cls_004">fd ← open log file l</span></div>
<div style="position:absolute;left:102.13px;top:130.52px" class="cls_004"><span class="cls_004">if we can acquire a write lock on fd :</span></div>
<div style="position:absolute;left:117.07px;top:142.47px" class="cls_007"><span class="cls_007">deleteAndSignal</span><span class="cls_004">(l, fd)</span></div>
<div style="position:absolute;left:102.13px;top:154.53px" class="cls_004"><span class="cls_004">else :</span></div>
<div style="position:absolute;left:117.07px;top:166.48px" class="cls_004"><span class="cls_004">Acquire a read lock on fd</span></div>
<div style="position:absolute;left:138.66px;top:180.74px" class="cls_004"><span class="cls_004">← the set of paths read from fd</span></div>
<div style="position:absolute;left:106.31px;top:191.94px" class="cls_012"><span class="cls_012">∪</span></div>
<div style="position:absolute;left:87.19px;top:194.99px" class="cls_004"><span class="cls_004">live</span></div>
<div style="position:absolute;left:103.79px;top:189.01px" class="cls_004"><span class="cls_004">←</span><span class="cls_035"><sup>⋃</sup></span></div>
<div style="position:absolute;left:123.98px;top:194.99px" class="cls_012"><span class="cls_012">p∈temp</span><span class="cls_007"> closure</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:87.19px;top:205.91px" class="cls_004"><span class="cls_004">dead</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ← topological sort of dead under the</span><span class="cls_007"> references</span><span class="cls_004"> relation</span></div>
<div style="position:absolute;left:87.19px;top:217.87px" class="cls_004"><span class="cls_004">for each p ∈ dead</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> (in topologically sorted order) :</span></div>
<div style="position:absolute;left:102.13px;top:231.14px" class="cls_004"><span class="cls_004">if p ends in</span><span class="cls_007"> ".lock"</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:185.35px;top:233.13px" class="cls_056"><span class="cls_056">105</span></div>
<div style="position:absolute;left:117.07px;top:243.10px" class="cls_004"><span class="cls_004">fd</span><span class="cls_012"><sub>lock</sub></span><span class="cls_004"> ← open lock p</span></div>
<div style="position:absolute;left:117.07px;top:255.05px" class="cls_004"><span class="cls_004">if we cannot acquire a write lock on fd</span><span class="cls_012"><sub>lock</sub></span><span class="cls_004"> : skip</span></div>
<div style="position:absolute;left:102.13px;top:267.01px" class="cls_007"><span class="cls_007">invalidatePath</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:102.13px;top:278.96px" class="cls_007"><span class="cls_007">deletePath</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:102.13px;top:290.92px" class="cls_004"><span class="cls_004">if p ends in</span><span class="cls_007"> ".lock"</span><span class="cls_004"> :</span><span class="cls_007"> deleteAndSignal</span><span class="cls_004">(p, fd</span><span class="cls_012"><sub>lock</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:87.19px;top:302.87px" class="cls_004"><span class="cls_004">Release the write lock on</span><span class="cls_007"> "/nix/var/nix/gc"</span></div>
<div style="position:absolute;left:158.11px;top:327.56px" class="cls_004"><span class="cls_004">Figure 5.23.: Concurrent garbage collector</span></div>
<div style="position:absolute;left:63.87px;top:361.18px" class="cls_004"><span class="cls_004">its execution. Since adding a lock takes a small, bounded amount of time, the collector</span></div>
<div style="position:absolute;left:63.87px;top:372.11px" class="cls_004"><span class="cls_004">will quickly acquire the write lock</span><span class="cls_012"><sup>14</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:385.88px" class="cls_004"><span class="cls_004">Figure 5.23 shows the concurrent garbage collector.  It first acquires the global lock</span></div>
<div style="position:absolute;left:63.87px;top:398.83px" class="cls_007"><span class="cls_007">"/nix/var/nix/gc"</span></div>
<div style="position:absolute;left:129.68px;top:397.83px" class="cls_056"><span class="cls_056">102</span><span class="cls_059"> </span><span class="cls_004">.  This prevents new permanent roots from being created.  Thus, the</span></div>
<div style="position:absolute;left:63.87px;top:409.79px" class="cls_004"><span class="cls_004">set of permanent roots determined in</span><span class="cls_014"> </span><span class="cls_056">103</span><span class="cls_004"> cannot increase while the collector runs. It also</span></div>
<div style="position:absolute;left:63.87px;top:421.74px" class="cls_004"><span class="cls_004">blocks new Nix processes since these acquire a read lock</span><span class="cls_014"> </span><span class="cls_056">98</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:434.49px" class="cls_004"><span class="cls_004">It then reads the set of temporary roots from the per-process files in</span><span class="cls_007"> /nix/var/nix/-</span></div>
<div style="position:absolute;left:63.87px;top:446.44px" class="cls_007"><span class="cls_007">temproots/</span><span class="cls_014"> </span><span class="cls_056">104</span><span class="cls_059"> </span><span class="cls_004">.  It acquires a read lock on each file, thus blocking the creation of new</span></div>
<div style="position:absolute;left:63.87px;top:458.40px" class="cls_004"><span class="cls_004">temporary roots by the corresponding processes. Stale log files are removed here, as de-</span></div>
<div style="position:absolute;left:63.87px;top:470.35px" class="cls_004"><span class="cls_004">scribed above.</span></div>
<div style="position:absolute;left:73.84px;top:483.10px" class="cls_004"><span class="cls_004">After this, no new roots—permanent or temporary—can be created. The garbage col-</span></div>
<div style="position:absolute;left:63.87px;top:495.05px" class="cls_004"><span class="cls_004">lector can therefore proceed normally.  There are some boring details</span><span class="cls_014"> </span><span class="cls_056">105</span><span class="cls_059"> </span><span class="cls_004"> regarding the</span></div>
<div style="position:absolute;left:63.87px;top:507.01px" class="cls_004"><span class="cls_004">deletion of lock files, which we only want to delete if they are stale (left over from an in-</span></div>
<div style="position:absolute;left:63.87px;top:518.96px" class="cls_004"><span class="cls_004">terrupted operation). Staleness is discovered by attempting to obtain a write lock (without</span></div>
<div style="position:absolute;left:63.87px;top:530.92px" class="cls_004"><span class="cls_004">blocking). If this succeeds, then the lock is either stale, or a process just created it but has</span></div>
<div style="position:absolute;left:63.87px;top:542.87px" class="cls_004"><span class="cls_004">not acquired a lock on it yet. The latter case is handled by writing a deletion token to it</span></div>
<div style="position:absolute;left:65.37px;top:565.18px" class="cls_013"><span class="cls_013"><sup>14</sup></span><span class="cls_014">Strictly speaking, this is not strongly fair: it is in principle possible that there is always at least one process</span></div>
<div style="position:absolute;left:75.83px;top:575.55px" class="cls_014"><span class="cls_014">holding a read lock. However, given the typical frequency of root creation and the time it takes to do so, this</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">is extremely unlikely to occur in practice.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">133</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:95910px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background142.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">5. The Extensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">using</span><span class="cls_007"> deleteAndSignal</span><span class="cls_004">. This token is detected by</span><span class="cls_007"> addTempRoot</span><span class="cls_004">, which will restart upon</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">seeing it.</span></div>
<div style="position:absolute;left:69.68px;top:68.95px" class="cls_004"><span class="cls_004">The correctness of the algorithm follows from the observation that no Nix process will</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">access any store path that is not in the live set, since all temporary roots are known to the</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">collector through the log files, and the creation of new temporary or permanent roots is</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">blocked.</span></div>
<div style="position:absolute;left:69.68px;top:116.77px" class="cls_004"><span class="cls_004">The collector described here is still not perfectly concurrent: though it can run in parallel</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">with previously executing processes (in particular, with builders), it blocks new processes</span></div>
<div style="position:absolute;left:59.72px;top:140.68px" class="cls_004"><span class="cls_004">and new temporary roots. Thus collector execution is strongly fair but still has bad latency.</span></div>
<div style="position:absolute;left:59.72px;top:152.64px" class="cls_004"><span class="cls_004">However, this is easily fixed by making the collector incremental. The collector can simply</span></div>
<div style="position:absolute;left:59.72px;top:164.59px" class="cls_004"><span class="cls_004">periodically restart until no more garbage exists (indeed, the user is free to interrupt the</span></div>
<div style="position:absolute;left:59.72px;top:176.55px" class="cls_004"><span class="cls_004">collector if desirable).  Restarting will release the locks, allowing waiting processes to</span></div>
<div style="position:absolute;left:59.72px;top:188.50px" class="cls_004"><span class="cls_004">proceed.  An even more concurrent scheme is one where processes inform the collector</span></div>
<div style="position:absolute;left:59.72px;top:200.46px" class="cls_004"><span class="cls_004">of new temporary roots by writing them to a socket and waiting synchronously for an</span></div>
<div style="position:absolute;left:59.72px;top:212.41px" class="cls_004"><span class="cls_004">acknowledgement from the collector.</span></div>
<div style="position:absolute;left:59.72px;top:243.09px" class="cls_011"><span class="cls_011">5.7. Extensionality</span></div>
<div style="position:absolute;left:59.72px;top:268.30px" class="cls_004"><span class="cls_004">So why do we call this model extensional? The reason is that we make an assumption of</span></div>
<div style="position:absolute;left:59.72px;top:280.26px" class="cls_004"><span class="cls_004">extensional equality. Build operations in general are not pure: the contents that a builder</span></div>
<div style="position:absolute;left:59.72px;top:292.21px" class="cls_004"><span class="cls_004">stores in the output path can depend on impure factors such as the system time. For in-</span></div>
<div style="position:absolute;left:59.72px;top:304.17px" class="cls_004"><span class="cls_004">stance, linkers often store a timestamp inside the binary contents of libraries. Thus, each</span></div>
<div style="position:absolute;left:59.72px;top:316.12px" class="cls_004"><span class="cls_004">build of a derivation can produce a subtly different output.</span></div>
<div style="position:absolute;left:69.68px;top:328.08px" class="cls_004"><span class="cls_004">However, the model is that such impure influences, if they exist, do not matter in any</span></div>
<div style="position:absolute;left:59.72px;top:340.03px" class="cls_004"><span class="cls_004">significant way. For instance, timestamps stored in files generally do not affect their opera-</span></div>
<div style="position:absolute;left:59.72px;top:351.99px" class="cls_004"><span class="cls_004">tion. Hence extensional equality: two mathematical objects (such as software components)</span></div>
<div style="position:absolute;left:59.72px;top:363.94px" class="cls_004"><span class="cls_004">are considered extensionally equal if they behave the same way for any operation on them.</span></div>
<div style="position:absolute;left:59.72px;top:375.90px" class="cls_004"><span class="cls_004">That is, we do not care about their internal structure.</span></div>
<div style="position:absolute;left:69.68px;top:387.85px" class="cls_004"><span class="cls_004">Thus, while any derivation can have a potentially infinite set of output path contents</span></div>
<div style="position:absolute;left:59.72px;top:399.81px" class="cls_004"><span class="cls_004">that can be produced by an execution of its builder, we view the elements of that set as</span></div>
<div style="position:absolute;left:59.72px;top:411.76px" class="cls_004"><span class="cls_004">interchangeable.</span></div>
<div style="position:absolute;left:69.68px;top:423.72px" class="cls_004"><span class="cls_004">But this is a model—an assumption about builders.  If a builder yields a completely</span></div>
<div style="position:absolute;left:59.72px;top:435.67px" class="cls_004"><span class="cls_004">different component when invoked at a certain time of day, it is beyond the scope of the</span></div>
<div style="position:absolute;left:59.72px;top:447.63px" class="cls_004"><span class="cls_004">model. In reality, also, we can always observe inequality by observing the internal encod-</span></div>
<div style="position:absolute;left:59.72px;top:459.58px" class="cls_004"><span class="cls_004">ing of the component, since that is a permissible operation. But the model is that any such</span></div>
<div style="position:absolute;left:59.72px;top:471.54px" class="cls_004"><span class="cls_004">observation does not take place or does not have an observable effect.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">134</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:96600px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background143.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:88.81px" class="cls_006"><span class="cls_006">6. The Intensional Model</span></div>
<div style="position:absolute;left:63.87px;top:129.21px" class="cls_004"><span class="cls_004">The previous chapter discussed the extensional Nix store model. This model works very</span></div>
<div style="position:absolute;left:63.87px;top:141.16px" class="cls_004"><span class="cls_004">well, but it has one substantial limitation (as well as a few smaller ones): it does not allow</span></div>
<div style="position:absolute;left:63.87px;top:153.12px" class="cls_004"><span class="cls_004">sharing of a Nix store between arbitrary users. If we allow just anyone with an account on</span></div>
<div style="position:absolute;left:63.87px;top:165.07px" class="cls_004"><span class="cls_004">the system to run arbitrary Nix operations, we run into serious security problems:</span></div>
<div style="position:absolute;left:78.82px;top:183.58px" class="cls_004"><span class="cls_004">• A user could modify the Nix store directly and inject a Trojan horse (a malicious</span></div>
<div style="position:absolute;left:88.78px;top:195.54px" class="cls_004"><span class="cls_004">component masquerading as legitimate software) into a component used by other</span></div>
<div style="position:absolute;left:88.78px;top:207.49px" class="cls_004"><span class="cls_004">users, allowing their accounts to be compromised when they execute the component.</span></div>
<div style="position:absolute;left:78.82px;top:226.71px" class="cls_004"><span class="cls_004">• Even if direct access to the store were restricted, i.e., if all builds were performed by</span></div>
<div style="position:absolute;left:88.78px;top:238.66px" class="cls_004"><span class="cls_004">a system process on behalf of other users, it is still possible for users to “crack” the</span></div>
<div style="position:absolute;left:88.78px;top:250.62px" class="cls_004"><span class="cls_004">Nix store by starting a build that interferes with the builds of other users.</span></div>
<div style="position:absolute;left:78.82px;top:269.84px" class="cls_004"><span class="cls_004">• And even if that were not possible, the substitute mechanism is dangerous in that we</span></div>
<div style="position:absolute;left:88.78px;top:281.79px" class="cls_004"><span class="cls_004">must trust that an FSO obtained through a substitute is actually a real build result of</span></div>
<div style="position:absolute;left:88.78px;top:293.75px" class="cls_004"><span class="cls_004">the derivation from which it is claimed to have been built.</span></div>
<div style="position:absolute;left:73.84px;top:312.26px" class="cls_004"><span class="cls_004">This chapter shows a different model for the Nix store, called the intensional model, that</span></div>
<div style="position:absolute;left:63.87px;top:324.21px" class="cls_004"><span class="cls_004">allows these problems to be solved. The basic idea is to make the entire Nix store content-</span></div>
<div style="position:absolute;left:63.87px;top:336.17px" class="cls_004"><span class="cls_004">addressable, meaning that each store path has a name that corresponds to the hash of the</span></div>
<div style="position:absolute;left:63.87px;top:348.12px" class="cls_004"><span class="cls_004">contents of that path. This invariant implies that if a store path is trusted, then its contents</span></div>
<div style="position:absolute;left:63.87px;top:360.08px" class="cls_004"><span class="cls_004">are trusted as well, an improvement over the extension model in the previous chapter.</span></div>
<div style="position:absolute;left:63.87px;top:372.03px" class="cls_004"><span class="cls_004">Of course, whether to trust a store path is a different problem, but that assessment can be</span></div>
<div style="position:absolute;left:63.87px;top:383.99px" class="cls_004"><span class="cls_004">made by each individual user instead of being made globally for all users. If different users</span></div>
<div style="position:absolute;left:63.87px;top:395.94px" class="cls_004"><span class="cls_004">obtain substitutes from different sources, with different levels of trustworthiness, they do</span></div>
<div style="position:absolute;left:63.87px;top:407.90px" class="cls_004"><span class="cls_004">not interfere with each other.</span></div>
<div style="position:absolute;left:73.84px;top:419.85px" class="cls_004"><span class="cls_004">The intensional model is a more recent development than the extensional model, and it</span></div>
<div style="position:absolute;left:63.87px;top:431.81px" class="cls_004"><span class="cls_004">has only been implemented as a rough prototype. Thus some of the results in this chapter</span></div>
<div style="position:absolute;left:63.87px;top:443.76px" class="cls_004"><span class="cls_004">are somewhat more tentative in nature. However, the crucial assumption of the intensional</span></div>
<div style="position:absolute;left:63.87px;top:455.72px" class="cls_004"><span class="cls_004">model—that the technique of hash rewriting works on common components—has been</span></div>
<div style="position:absolute;left:63.87px;top:467.67px" class="cls_004"><span class="cls_004">validated on the Nix Packages collection.</span></div>
<div style="position:absolute;left:63.87px;top:498.03px" class="cls_011"><span class="cls_011">6.1. Sharing</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">This section motivates why sharing of a Nix store between multiple users is a desirable</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">property.  Sharing here means that multiple users have “write access” to the Nix store,</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">i.e., can build and install software, create user environments, and so on. This immediately</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">raises issues of trust: if not all users mutually trust each other, how can they share a store?</span></div>
<div style="position:absolute;left:73.84px;top:571.07px" class="cls_004"><span class="cls_004">It should be noted that many deployment systems do not support sharing in this sense.</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">For instance, almost all Unix deployment systems allow only the administrator (</span><span class="cls_007">root</span><span class="cls_004">) to</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">135</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:97290px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background144.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">install software. (An exception is Zero Install [112], which allows arbitrary users to install</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">software, with duplicate installations of the same component shared between users, i.e.,</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">downloaded and stored on disk only once.) So lack of sharing is not necessarily a terrible</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">limitation for a deployment system, as in many environments it is perfectly fine if only</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">the administrator can make installation decisions. Such environments include single-user</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">workstations (where the user is the administrator), small multi-user systems where all users</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">trust each other, and typical multi-user environments where it is in fact a feature if the</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">software environment can be determined exclusively by the system administrators.</span></div>
<div style="position:absolute;left:59.72px;top:161.29px" class="cls_009"><span class="cls_009">Why do we want to share Nix stores?</span><span class="cls_004">   But many environments are somewhere in be-</span></div>
<div style="position:absolute;left:59.72px;top:173.25px" class="cls_004"><span class="cls_004">tween the extremes of a single user on the one hand, and multiple users with a single</span></div>
<div style="position:absolute;left:59.72px;top:185.20px" class="cls_004"><span class="cls_004">deployment authority on the other hand. Imagine a university shell server that allows any</span></div>
<div style="position:absolute;left:59.72px;top:197.16px" class="cls_004"><span class="cls_004">student with an account to log in.  It is clearly terribly insecure to give “</span><span class="cls_007">root</span><span class="cls_004">” access to</span></div>
<div style="position:absolute;left:59.72px;top:209.12px" class="cls_004"><span class="cls_004">any student in order to install software. But on the other hand, it is also desirable to allow</span></div>
<div style="position:absolute;left:59.72px;top:221.07px" class="cls_004"><span class="cls_004">students to install software. Other examples are computational grids and hosting environ-</span></div>
<div style="position:absolute;left:59.72px;top:233.03px" class="cls_004"><span class="cls_004">ments. If the facilities of the deployment system are only available to the administrator,</span></div>
<div style="position:absolute;left:59.72px;top:244.98px" class="cls_004"><span class="cls_004">the users have to “manually” install software, e.g., by compiling from source, or by down-</span></div>
<div style="position:absolute;left:59.72px;top:256.94px" class="cls_004"><span class="cls_004">loading and unpacking pre-built binaries.  But in either case, the advantages of using a</span></div>
<div style="position:absolute;left:59.72px;top:268.89px" class="cls_004"><span class="cls_004">deployment system—such as dependency tracking—are gone and unavailable to the end-</span></div>
<div style="position:absolute;left:59.72px;top:280.85px" class="cls_004"><span class="cls_004">users. This can lead to correctness problems. For instance, if a user compiles a component</span></div>
<div style="position:absolute;left:59.72px;top:292.80px" class="cls_004"><span class="cls_004">that has a runtime dependency on a “globally” installed component, that is, one managed</span></div>
<div style="position:absolute;left:59.72px;top:304.76px" class="cls_004"><span class="cls_004">by the deployment system, then the deployment system will have no knowledge of this de-</span></div>
<div style="position:absolute;left:59.72px;top:316.71px" class="cls_004"><span class="cls_004">pendency. Thus, the deployment system may consider it safe to uninstall the dependency.</span></div>
<div style="position:absolute;left:69.68px;top:329.77px" class="cls_004"><span class="cls_004">Also, if many users need a piece of software that has not been globally provided by the</span></div>
<div style="position:absolute;left:59.72px;top:341.72px" class="cls_004"><span class="cls_004">administrator, and each of them installs it separately (e.g., in his or her account), this will</span></div>
<div style="position:absolute;left:59.72px;top:353.68px" class="cls_004"><span class="cls_004">cause a considerable amount of resource wastage in terms of disk space, memory, CPU</span></div>
<div style="position:absolute;left:59.72px;top:365.63px" class="cls_004"><span class="cls_004">time lost due to redundant dynamic link resolution, and so on.</span></div>
<div style="position:absolute;left:69.68px;top:378.69px" class="cls_004"><span class="cls_004">Another scenario where sharing is extremely valuable is in build management, i.e., in</span></div>
<div style="position:absolute;left:59.72px;top:390.64px" class="cls_004"><span class="cls_004">the domain of tools such as Make and Ant.  A typical development model in a multi-</span></div>
<div style="position:absolute;left:59.72px;top:402.60px" class="cls_004"><span class="cls_004">developer project is that developers each have a working copy of the source code, obtained</span></div>
<div style="position:absolute;left:59.72px;top:414.55px" class="cls_004"><span class="cls_004">from a version management repository. Each developer then builds the project in his or her</span></div>
<div style="position:absolute;left:59.72px;top:426.51px" class="cls_004"><span class="cls_004">own working copy. However, with large projects, the overhead of building can be quite</span></div>
<div style="position:absolute;left:59.72px;top:438.46px" class="cls_004"><span class="cls_004">substantial, sometimes in the order of hours or days. Thus it would be great if the artifacts</span></div>
<div style="position:absolute;left:59.72px;top:450.42px" class="cls_004"><span class="cls_004">created by one user could be automatically “recycled” by other users; i.e., if a user has</span></div>
<div style="position:absolute;left:59.72px;top:462.37px" class="cls_004"><span class="cls_004">to build something that has already been built previously by another user, the previous</span></div>
<div style="position:absolute;left:59.72px;top:474.33px" class="cls_004"><span class="cls_004">build result is re-used automatically. Some build systems have this feature, notably Vesta’s</span></div>
<div style="position:absolute;left:59.72px;top:486.28px" class="cls_004"><span class="cls_004">evaluator and ClearCase’s ClearMake (discussed in Section 10.3). However, these tools</span></div>
<div style="position:absolute;left:59.72px;top:498.24px" class="cls_004"><span class="cls_004">depend on non-portable techniques to implement dependency identification, as discussed</span></div>
<div style="position:absolute;left:59.72px;top:510.19px" class="cls_004"><span class="cls_004">in Chapter 10.</span></div>
<div style="position:absolute;left:69.68px;top:523.25px" class="cls_004"><span class="cls_004">Also, as we will see in Chapter 9, Nix is very useful for service deployment, e.g., a</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">concrete web server with all its software components, static configuration and static data</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">files, management scripts, and so on.  It is easy to imagine a shared system, such as a</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">hosting environment, where many different users instantiate Nix services. Many of those</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">services will overlap, e.g., because they partially use the same software components (say,</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">Apache). This common subset should be stored only once.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">136</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:97980px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background145.jpg" width=481 height=680></div>
<div style="position:absolute;left:371.25px;top:17.14px" class="cls_004"><span class="cls_004">6.1. Sharing</span></div>
<div style="position:absolute;left:73.84px;top:45.04px" class="cls_004"><span class="cls_004">Finally, sharing is especially important in Nix because derivation outputs are typically</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">not relocatable, since most outputs contain references to their own output path or to other</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">paths in the Nix store. Any user can have a private Nix store, e.g.,</span><span class="cls_007"> /home/alice/nix/store</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">However, pre-built binaries assume a particular location for the Nix store; almost always,</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">this is</span><span class="cls_007"> /nix/store</span><span class="cls_004">. Since the location of the Nix store is often stored in outputs, pre-built</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">binaries are simply not applicable to a Nix store in another location in the file system. In</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">fact, this is precisely why the location of the Nix store is part of the store path computation</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">(page 94): different hashes are computed for the same store derivations in different Nix</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">stores to prevent any possible mix-up through the substitute mechanism.</span></div>
<div style="position:absolute;left:73.84px;top:152.64px" class="cls_004"><span class="cls_004">So for these reasons it is important for a Nix store—the “heap” or address space of</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">installed components in the system—to be shareable among users. This means that users</span></div>
<div style="position:absolute;left:63.87px;top:176.55px" class="cls_004"><span class="cls_004">have not only “read” access to the components in the store, but can also run package</span></div>
<div style="position:absolute;left:63.87px;top:188.50px" class="cls_004"><span class="cls_004">management operations themselves, i.e., build, install, uninstall and upgrade components,</span></div>
<div style="position:absolute;left:63.87px;top:200.46px" class="cls_004"><span class="cls_004">both from source and from binaries through the substitute mechanism.</span></div>
<div style="position:absolute;left:63.87px;top:226.67px" class="cls_009"><span class="cls_009">The trust model</span><span class="cls_004">   Of course, sharing is not hard—secure sharing is. The difficulty lies</span></div>
<div style="position:absolute;left:63.87px;top:238.62px" class="cls_004"><span class="cls_004">in providing certain trust properties. Given a derivation d, how can a user trust that the</span></div>
<div style="position:absolute;left:63.87px;top:250.58px" class="cls_004"><span class="cls_004">contents of d.</span><span class="cls_007">output</span><span class="cls_004"> are actually the build result of this derivation, and not, say, a Trojan</span></div>
<div style="position:absolute;left:63.87px;top:262.53px" class="cls_004"><span class="cls_004">horse placed there by another user?</span></div>
<div style="position:absolute;left:73.84px;top:273.46px" class="cls_004"><span class="cls_004">The basic trust problem is as follows. A user Alice</span><span class="cls_012"><sup>1</sup></span><span class="cls_004"> has obtained a set of Nix expressions</span></div>
<div style="position:absolute;left:63.87px;top:286.44px" class="cls_004"><span class="cls_004">from a trusted source, Dave (the Distributor).  We do not define how this trust relation</span></div>
<div style="position:absolute;left:63.87px;top:298.40px" class="cls_004"><span class="cls_004">is established. The idea is that Alice trusts the producer of the Nix expressions to create</span></div>
<div style="position:absolute;left:63.87px;top:310.35px" class="cls_004"><span class="cls_004">expressions that build software that is useful, does not contain Trojans or spyware, does not</span></div>
<div style="position:absolute;left:63.87px;top:322.31px" class="cls_004"><span class="cls_004">destroy data, and so on. This type of trust cannot be established formally; the determination</span></div>
<div style="position:absolute;left:63.87px;top:334.26px" class="cls_004"><span class="cls_004">can only be made by a combination of knowledge of the producer’s history, reputation, and</span></div>
<div style="position:absolute;left:63.87px;top:346.22px" class="cls_004"><span class="cls_004">other social factors, and possibly code review (although this is beyond most users). For</span></div>
<div style="position:absolute;left:63.87px;top:358.17px" class="cls_004"><span class="cls_004">instance, a Nix user will typically trust the Nix Packages collection.</span></div>
<div style="position:absolute;left:73.84px;top:370.13px" class="cls_004"><span class="cls_004">We also assume that the set of expressions has been received unmodified by Alice, mean-</span></div>
<div style="position:absolute;left:63.87px;top:382.08px" class="cls_004"><span class="cls_004">ing that they have not been modified by a “man in the middle”. This can be ensured by</span></div>
<div style="position:absolute;left:63.87px;top:394.04px" class="cls_004"><span class="cls_004">using appropriate cryptographic techniques, e.g., verifying a digital signature on the set</span></div>
<div style="position:absolute;left:63.87px;top:405.99px" class="cls_004"><span class="cls_004">of expressions [145], or fetching them from Dave through a secure channel (e.g., HTTPS</span></div>
<div style="position:absolute;left:63.87px;top:417.95px" class="cls_004"><span class="cls_004">with a valid certificate).</span></div>
<div style="position:absolute;left:73.84px;top:429.90px" class="cls_004"><span class="cls_004">Given this trusted set of Nix expressions, the trust property that we seek to ensure is that</span></div>
<div style="position:absolute;left:63.87px;top:441.86px" class="cls_004"><span class="cls_004">if Alice installs a derivation from this Nix expression, the resulting component is one that</span></div>
<div style="position:absolute;left:63.87px;top:453.81px" class="cls_004"><span class="cls_004">has been produced by that derivation. I.e., if</span><span class="cls_007"> foo.nix</span><span class="cls_004"> is trusted, and Alice runs</span></div>
<div style="position:absolute;left:88.78px;top:476.59px" class="cls_015"><span class="cls_015">$ nix-env  -f  foo.nix  -i  bar</span></div>
<div style="position:absolute;left:63.87px;top:489.85px" class="cls_004"><span class="cls_004">to install a derivation named</span><span class="cls_007"> bar</span><span class="cls_004">, then the derivation output that is added to Alice’s user</span></div>
<div style="position:absolute;left:63.87px;top:501.81px" class="cls_004"><span class="cls_004">environment is an actual derivation output of that derivation. It should not be possible for</span></div>
<div style="position:absolute;left:63.87px;top:513.76px" class="cls_004"><span class="cls_004">other users to replace the derivation output with something else, or to interfere with the</span></div>
<div style="position:absolute;left:63.87px;top:525.72px" class="cls_004"><span class="cls_004">build of the derivation. To put it precisely, the property that we want is:</span></div>
<div style="position:absolute;left:88.78px;top:544.24px" class="cls_004"><span class="cls_004">The trust property: in a shared Nix store, if a user A installs or has installed</span></div>
<div style="position:absolute;left:88.78px;top:556.19px" class="cls_004"><span class="cls_004">a trusted Nix expression, then the closures resulting from building the store</span></div>
<div style="position:absolute;left:68.36px;top:574.65px" class="cls_013"><span class="cls_013"><sup>1</sup></span><span class="cls_014">We follow the convention of the security and cryptographic literature to denote the several roles in a protocol</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">or exchange as Alice (A), Bob (B), Carol (C), Dave (D), and so on.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">137</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:98670px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background146.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:84.62px;top:45.04px" class="cls_004"><span class="cls_004">derivations instantiated from that expression are equal to what may have been</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">produced if user A had exclusive write permission to the Nix store.</span></div>
<div style="position:absolute;left:69.68px;top:74.54px" class="cls_004"><span class="cls_004">Thus, for each user, a shared Nix store must produce the same results as if the store had</span></div>
<div style="position:absolute;left:59.72px;top:86.49px" class="cls_004"><span class="cls_004">been a single-user store owned by that user. Note a subtlety in the phrasing: I say that the</span></div>
<div style="position:absolute;left:59.72px;top:98.45px" class="cls_004"><span class="cls_004">result of building must match what may have produced in a single-user store, not what they</span></div>
<div style="position:absolute;left:59.72px;top:110.40px" class="cls_004"><span class="cls_004">would have been. This is due to indeterminism; a single derivation may produce different</span></div>
<div style="position:absolute;left:59.72px;top:122.36px" class="cls_004"><span class="cls_004">results (e.g., due to time stamps). In essence, each derivation has a possibly infinite set</span></div>
<div style="position:absolute;left:59.72px;top:134.31px" class="cls_004"><span class="cls_004">of possible build results, its output equivalence class. But we do not have a direct way to</span></div>
<div style="position:absolute;left:59.72px;top:146.27px" class="cls_004"><span class="cls_004">test set membership in this class, i.e., to verify that a particular output was produced by a</span></div>
<div style="position:absolute;left:59.72px;top:158.22px" class="cls_004"><span class="cls_004">derivation. Testing this set membership is undecidable in general.</span></div>
<div style="position:absolute;left:69.68px;top:170.18px" class="cls_004"><span class="cls_004">Informally, the trust property can be stated as follows:</span></div>
<div style="position:absolute;left:84.62px;top:187.72px" class="cls_004"><span class="cls_004">If the source of a component is trusted, then the binary that is installed in the</span></div>
<div style="position:absolute;left:84.62px;top:199.68px" class="cls_004"><span class="cls_004">user’s user environment is also trusted.</span></div>
<div style="position:absolute;left:59.72px;top:225.67px" class="cls_009"><span class="cls_009">Breaking the trust property</span><span class="cls_004">   So under what circumstances can the trust property be vi-</span></div>
<div style="position:absolute;left:59.72px;top:237.62px" class="cls_004"><span class="cls_004">olated? The principal scenarios were sketched at the beginning of this chapter. Clearly, if</span></div>
<div style="position:absolute;left:59.72px;top:249.58px" class="cls_004"><span class="cls_004">users can modify the contents of the Nix store directly, then there is no security whatsoever.</span></div>
<div style="position:absolute;left:59.72px;top:261.53px" class="cls_004"><span class="cls_004">So let’s assume that all operations on the Nix store are executed by a Nix server process</span></div>
<div style="position:absolute;left:59.72px;top:273.49px" class="cls_004"><span class="cls_004">(daemon) that performs Nix operations, such as instantiation, building and adding garbage</span></div>
<div style="position:absolute;left:59.72px;top:285.44px" class="cls_004"><span class="cls_004">collector roots, on behalf of users; and that only this server process and its children have</span></div>
<div style="position:absolute;left:59.72px;top:297.40px" class="cls_004"><span class="cls_004">write access to the store and the Nix database.</span></div>
<div style="position:absolute;left:69.68px;top:309.35px" class="cls_004"><span class="cls_004">Even if direct access to the store is prevented in this way, malicious users can still “hack”</span></div>
<div style="position:absolute;left:59.72px;top:321.31px" class="cls_004"><span class="cls_004">the store by creating and building a derivation whose builder modifies other paths than its</span></div>
<div style="position:absolute;left:59.72px;top:333.26px" class="cls_004"><span class="cls_004">output path, e.g., overwrites an already existing store object with a Trojan horse.  This</span></div>
<div style="position:absolute;left:59.72px;top:345.22px" class="cls_004"><span class="cls_004">violates the trust property, as the store object no longer corresponds to an actual output of</span></div>
<div style="position:absolute;left:59.72px;top:357.17px" class="cls_004"><span class="cls_004">its deriver.</span></div>
<div style="position:absolute;left:69.68px;top:369.13px" class="cls_004"><span class="cls_004">Then there is the substitute mechanism. Recall from Section 5.5.3 that a substitute is</span></div>
<div style="position:absolute;left:59.72px;top:381.08px" class="cls_004"><span class="cls_004">an arbitrary program that builds a store path, typically by downloading its contents from</span></div>
<div style="position:absolute;left:59.72px;top:393.04px" class="cls_004"><span class="cls_004">somewhere. How can we trust that a substitute for a derivation output path actually pro-</span></div>
<div style="position:absolute;left:59.72px;top:404.99px" class="cls_004"><span class="cls_004">duces contents that correspond to an actual output of the derivation?  So the substitute</span></div>
<div style="position:absolute;left:59.72px;top:416.95px" class="cls_004"><span class="cls_004">mechanism can be used to trivially violate the trust property.</span></div>
<div style="position:absolute;left:59.72px;top:441.94px" class="cls_009"><span class="cls_009">Sharing in the extensional model</span><span class="cls_004">   In the extensional model of the previous chapter,</span></div>
<div style="position:absolute;left:59.72px;top:452.90px" class="cls_004"><span class="cls_004">sharing a Nix store is only possible if all users of the Nix store trust each other not to violate</span></div>
<div style="position:absolute;left:59.72px;top:463.86px" class="cls_004"><span class="cls_004">the trust property.  For instance, suppose that user Alice has obtained a Nix expression</span></div>
<div style="position:absolute;left:59.72px;top:474.82px" class="cls_004"><span class="cls_004">E from a trusted source, and pulls substitutes from machine X , where X is a malicious</span></div>
<div style="position:absolute;left:59.72px;top:485.78px" class="cls_004"><span class="cls_004">machine that provides Trojaned binaries for the output paths of the derivation produced by</span></div>
<div style="position:absolute;left:59.72px;top:496.74px" class="cls_004"><span class="cls_004">E. For instance, it provides a manifest with the following substitute definition:</span></div>
<div style="position:absolute;left:84.62px;top:515.75px" class="cls_015"><span class="cls_015">{ StorePath:  /nix/store/bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:330.74px;top:512.48px" class="cls_056"><span class="cls_056">106</span></div>
<div style="position:absolute;left:94.04px;top:526.70px" class="cls_015"><span class="cls_015">NarURL:  </span><A HREF="http://haxxor.org/dist/f168bcvn27c9...-hello.nar.bz2/">http://haxxor.org/dist/f168bcvn27c9...-hello.nar.bz2</A> </div>
<div style="position:absolute;left:94.04px;top:537.66px" class="cls_015"><span class="cls_015">Size:  35182  }</span></div>
<div style="position:absolute;left:69.68px;top:547.16px" class="cls_004"><span class="cls_004">where the NAR archive</span><span class="cls_007"> f168bcvn27c9...-hello.nar.bz2</span><span class="cls_004"> unpacks to a version of Hello 2.1.1</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">containing a Trojan horse that installs a back door on Alice’s machine. (Manifests were</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">briefly discussed in Section 2.6, and will be covered in detail in Section 7.3.) When Alice</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">executes the Hello binary, her account may become compromised.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">138</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:99360px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background147.jpg" width=481 height=680></div>
<div style="position:absolute;left:347.74px;top:17.14px" class="cls_004"><span class="cls_004">6.2. Local sharing</span></div>
<div style="position:absolute;left:73.84px;top:45.04px" class="cls_004"><span class="cls_004">Suppose that subsequently Bob wants to install the same expression E. He first pulls</span></div>
<div style="position:absolute;left:63.87px;top:56.00px" class="cls_004"><span class="cls_004">from a different, trusted machine Y , obtaining a bona fide substitute:</span></div>
<div style="position:absolute;left:88.78px;top:75.57px" class="cls_015"><span class="cls_015">{ StorePath:  /nix/store/bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:334.90px;top:72.30px" class="cls_056"><span class="cls_056">107</span></div>
<div style="position:absolute;left:98.19px;top:86.52px" class="cls_015"><span class="cls_015">NarURL:  </span><A HREF="http://nix.org/dist/1hnv0817f168...-hello.nar.bz2/">http://nix.org/dist/1hnv0817f168...-hello.nar.bz2</A> </div>
<div style="position:absolute;left:98.19px;top:97.48px" class="cls_015"><span class="cls_015">Size:  34747  }</span></div>
<div style="position:absolute;left:73.84px;top:107.53px" class="cls_004"><span class="cls_004">However, this correct substitute will not avail him.  When he installs Hello from the</span></div>
<div style="position:absolute;left:63.87px;top:119.49px" class="cls_004"><span class="cls_004">trusted Nix expression (</span><span class="cls_007">nix-env -i hello</span><span class="cls_004">), Alice’s Trojaned binary will be added to his</span></div>
<div style="position:absolute;left:63.87px;top:131.44px" class="cls_004"><span class="cls_004">user environment. After all, the Hello derivation’s output path,</span><span class="cls_007"> /nix/store/bwacc7a5c5n3...-</span></div>
<div style="position:absolute;left:63.87px;top:143.40px" class="cls_007"><span class="cls_007">hello-2.1.1</span><span class="cls_004">, is already valid, and by the substitute mechanism (Figure 5.15) that is sufficient</span></div>
<div style="position:absolute;left:63.87px;top:155.35px" class="cls_004"><span class="cls_004">to finish the build of the derivation.</span></div>
<div style="position:absolute;left:73.84px;top:167.31px" class="cls_004"><span class="cls_004">The basic problem is that both substitutes want to occupy the same location in the file</span></div>
<div style="position:absolute;left:63.87px;top:179.26px" class="cls_004"><span class="cls_004">system (cf.</span></div>
<div style="position:absolute;left:115.71px;top:179.26px" class="cls_056"><span class="cls_056">106</span><span class="cls_059"> </span><span class="cls_004"> and</span><span class="cls_014"> </span><span class="cls_056">107</span><span class="cls_059"> </span><span class="cls_004">); but this is of course not possible.  Nix makes an assumption</span></div>
<div style="position:absolute;left:63.87px;top:191.22px" class="cls_004"><span class="cls_004">of extensional equality (Section 5.7): any substitute for the same path is behaviourally</span></div>
<div style="position:absolute;left:63.87px;top:203.18px" class="cls_004"><span class="cls_004">equivalent. But it has no way to verify that this assumption is valid.</span></div>
<div style="position:absolute;left:73.84px;top:215.13px" class="cls_004"><span class="cls_004">Thus, source X may claim that its substitute is an output of some derivation d; but this</span></div>
<div style="position:absolute;left:63.87px;top:227.09px" class="cls_004"><span class="cls_004">may be a lie, leading to a violating of the trust property. We can therefore only register</span></div>
<div style="position:absolute;left:63.87px;top:239.04px" class="cls_004"><span class="cls_004">substitutes from source X if all users that share the store trust source X .</span></div>
<div style="position:absolute;left:73.84px;top:251.00px" class="cls_004"><span class="cls_004">The remainder of this chapter first shows that the trust property actually can be provided</span></div>
<div style="position:absolute;left:63.87px;top:262.95px" class="cls_004"><span class="cls_004">in the extensional model for locally built derivations. Thus, users need not have mutual</span></div>
<div style="position:absolute;left:63.87px;top:274.91px" class="cls_004"><span class="cls_004">trust relations.  However, secure sharing becomes impossible once substitutes are used.</span></div>
<div style="position:absolute;left:63.87px;top:286.86px" class="cls_004"><span class="cls_004">This leads to the development of the intensional model that enables sharing of a Nix store</span></div>
<div style="position:absolute;left:63.87px;top:298.82px" class="cls_004"><span class="cls_004">even in the presence of substitutes.</span></div>
<div style="position:absolute;left:63.87px;top:329.21px" class="cls_011"><span class="cls_011">6.2. Local sharing</span></div>
<div style="position:absolute;left:63.87px;top:354.42px" class="cls_004"><span class="cls_004">As we have seen above, sharing between machines is only possible in the extensional</span></div>
<div style="position:absolute;left:63.87px;top:366.38px" class="cls_004"><span class="cls_004">model if all users have the same remote trust relations. For locally-built derivations on the</span></div>
<div style="position:absolute;left:63.87px;top:378.33px" class="cls_004"><span class="cls_004">other hand (i.e., when not using substitutes), we can allow mutually untrusted users. The</span></div>
<div style="position:absolute;left:63.87px;top:390.29px" class="cls_004"><span class="cls_004">trick is in preventing a user from influencing the build for some derivation d in such a way</span></div>
<div style="position:absolute;left:63.87px;top:402.24px" class="cls_004"><span class="cls_004">that the result is no longer a legitimate output of d.</span></div>
<div style="position:absolute;left:73.84px;top:414.20px" class="cls_004"><span class="cls_004">For instance, if Alice has direct write access to the Nix store, she can start a build of</span></div>
<div style="position:absolute;left:63.87px;top:426.15px" class="cls_004"><span class="cls_004">derivation d, then overwrite the output path with a Trojan horse. Similarly, even if builds</span></div>
<div style="position:absolute;left:63.87px;top:438.11px" class="cls_004"><span class="cls_004">are done through a server process that executes builds on behalf of users but running under</span></div>
<div style="position:absolute;left:63.87px;top:450.06px" class="cls_004"><span class="cls_004">a different user ID (</span><span class="cls_007">uid</span><span class="cls_004">), Alice can interfere with the build of d by starting a build of a</span></div>
<div style="position:absolute;left:63.87px;top:460.99px" class="cls_004"><span class="cls_004">specially crafted derivation d</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, the builder of which writes a Trojan horse to the output</span></div>
<div style="position:absolute;left:63.87px;top:473.97px" class="cls_004"><span class="cls_004">path of d.</span></div>
<div style="position:absolute;left:73.84px;top:485.93px" class="cls_004"><span class="cls_004">To ensure that the trust property holds for locally-built derivations, we therefore need to</span></div>
<div style="position:absolute;left:63.87px;top:497.88px" class="cls_004"><span class="cls_004">ensure that the following specialised property holds.</span></div>
<div style="position:absolute;left:88.78px;top:516.54px" class="cls_004"><span class="cls_004">The execution of the builder of a derivation d (d.</span><span class="cls_007">builder</span><span class="cls_004">) modifies no path in</span></div>
<div style="position:absolute;left:88.78px;top:528.50px" class="cls_004"><span class="cls_004">the Nix store other than d.</span><span class="cls_007">output</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:547.16px" class="cls_004"><span class="cls_004">We can ensure this property as follows. First, users no longer have direct write access</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">to the Nix store.  As suggested above, this is the absolute minimum measure necessary</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">to obtain secure sharing. All builds are performed by a Nix server process on behalf of</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">users.  The server runs builders under user IDs that are distinct from those of ordinary</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">139</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:100050px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background148.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">user or system processes (e.g.,</span><span class="cls_007"> nix-build-</span><span class="cls_004">{1, 2, . . . }). Also, no two concurrent builds can</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">have the same</span><span class="cls_007"> uid</span><span class="cls_004">. This prevents one builder from interfering with the output of another,</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">as illustrated above. Thus, the server maintains a “pool” of free and in-use</span><span class="cls_007"> uid</span><span class="cls_004">s that can</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">be used for building.  How a builder can create its intended output path is discussed on</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">page 157.</span></div>
<div style="position:absolute;left:69.68px;top:104.96px" class="cls_004"><span class="cls_004">When a build finishes, prior to marking the output path as</span><span class="cls_007"> valid</span><span class="cls_004">, we do the following:</span></div>
<div style="position:absolute;left:74.66px;top:125.34px" class="cls_004"><span class="cls_004">• Ensure that there are no processes left running under the</span><span class="cls_007"> uid</span><span class="cls_004"> selected for the builder.</span></div>
<div style="position:absolute;left:84.62px;top:137.29px" class="cls_004"><span class="cls_004">On modern Unix systems this can be done by performing a</span><span class="cls_007"> kill(-1, SIGKILL)</span><span class="cls_004"> opera-</span></div>
<div style="position:absolute;left:84.62px;top:149.25px" class="cls_004"><span class="cls_004">tion while executing under that</span><span class="cls_007"> uid</span><span class="cls_004">, which has the effect of sending the</span><span class="cls_007"> KILL</span><span class="cls_004"> signal</span></div>
<div style="position:absolute;left:84.62px;top:161.20px" class="cls_004"><span class="cls_004">to all processes executing under</span><span class="cls_007"> uid</span><span class="cls_004"> [99].  Older versions of the POSIX standard</span></div>
<div style="position:absolute;left:84.62px;top:173.16px" class="cls_004"><span class="cls_004">however did not mandate this behaviour [98]: on such systems, killing all processes</span></div>
<div style="position:absolute;left:84.62px;top:185.11px" class="cls_004"><span class="cls_004">running under a certain</span><span class="cls_007"> uid</span><span class="cls_004"> is tricky as it is fraught with race conditions.</span></div>
<div style="position:absolute;left:74.66px;top:205.64px" class="cls_004"><span class="cls_004">• Change ownership of the output to the global Nix user.</span></div>
<div style="position:absolute;left:74.66px;top:226.16px" class="cls_004"><span class="cls_004">• Remove write permission and any set-user-ID and set-group-ID bits (which are spe-</span></div>
<div style="position:absolute;left:84.62px;top:238.12px" class="cls_004"><span class="cls_004">cial permission bits on files that cause them to be executed with the rights of a</span></div>
<div style="position:absolute;left:84.62px;top:250.07px" class="cls_004"><span class="cls_004">different user or group—a possible security risk).</span></div>
<div style="position:absolute;left:69.68px;top:270.45px" class="cls_004"><span class="cls_004">Note that the latter two steps have a subtle race condition. For instance, if we change</span></div>
<div style="position:absolute;left:59.72px;top:282.40px" class="cls_004"><span class="cls_004">ownership first, we have the risk of inadvertently creating a</span><span class="cls_007"> setuid</span><span class="cls_004"> binary owned by the</span></div>
<div style="position:absolute;left:59.72px;top:293.33px" class="cls_004"><span class="cls_004">global Nix user</span><span class="cls_012"><sup>2</sup></span><span class="cls_004">.  If however we remove write and</span><span class="cls_007"> setuid</span><span class="cls_004"> permission first, a left-over</span></div>
<div style="position:absolute;left:59.72px;top:306.31px" class="cls_004"><span class="cls_004">process spawned by the builder could restore those permissions before the ownership is</span></div>
<div style="position:absolute;left:59.72px;top:318.27px" class="cls_004"><span class="cls_004">changed.  This is why the first step is important.  Also, on Unix, if a left-over process</span></div>
<div style="position:absolute;left:59.72px;top:330.22px" class="cls_004"><span class="cls_004">opened a file before the ownership changes, it can still write to it after the change, since</span></div>
<div style="position:absolute;left:59.72px;top:342.18px" class="cls_004"><span class="cls_004">permissions are only checked when a file is opened.</span></div>
<div style="position:absolute;left:69.68px;top:354.28px" class="cls_004"><span class="cls_004">In conclusion, in the extensional model we can do secure source-based deployment with</span></div>
<div style="position:absolute;left:59.72px;top:366.24px" class="cls_004"><span class="cls_004">sharing. Thus, the trust property is guaranteed in the absence of substitutes. Of course,</span></div>
<div style="position:absolute;left:59.72px;top:378.19px" class="cls_004"><span class="cls_004">this is not enough:  we also want transparent binary deployment through the substitute</span></div>
<div style="position:absolute;left:59.72px;top:390.15px" class="cls_004"><span class="cls_004">mechanism.</span></div>
<div style="position:absolute;left:59.72px;top:421.64px" class="cls_011"><span class="cls_011">6.3. A content-addressable store</span></div>
<div style="position:absolute;left:59.72px;top:447.14px" class="cls_004"><span class="cls_004">As we saw in Section 6.2, we can have secure sharing of locally built derivation outputs,</span></div>
<div style="position:absolute;left:59.72px;top:459.10px" class="cls_004"><span class="cls_004">but not of remotely built outputs obtained through the substitute mechanism. All users have</span></div>
<div style="position:absolute;left:59.72px;top:471.05px" class="cls_004"><span class="cls_004">to trust that the contents produced on another machine purportedly from some derivation d</span></div>
<div style="position:absolute;left:59.72px;top:483.01px" class="cls_004"><span class="cls_004">is indeed from derivation d. As stated above, such a trust relation must be global for a Nix</span></div>
<div style="position:absolute;left:59.72px;top:494.96px" class="cls_004"><span class="cls_004">installation. In this section we develop a substantially more powerful model in which this</span></div>
<div style="position:absolute;left:59.72px;top:506.92px" class="cls_004"><span class="cls_004">is not the case. We do this by moving to a fully content-addressable Nix store for all store</span></div>
<div style="position:absolute;left:59.72px;top:518.88px" class="cls_004"><span class="cls_004">objects.</span></div>
<div style="position:absolute;left:69.68px;top:530.98px" class="cls_004"><span class="cls_004">The property of content-addressability means that the address of an object is determined</span></div>
<div style="position:absolute;left:59.72px;top:542.94px" class="cls_004"><span class="cls_004">by its contents. Equivalently, if we know the contents of an object, we know its address.</span></div>
<div style="position:absolute;left:59.72px;top:554.89px" class="cls_004"><span class="cls_004">In the context of Nix, addresses are of course store paths.  We have seen in Section 5.3</span></div>
<div style="position:absolute;left:64.20px;top:574.65px" class="cls_013"><span class="cls_013"><sup>2</sup></span><span class="cls_014">Exactly to prevent this race, Linux removes</span><span class="cls_016"> setuid</span><span class="cls_014"> permission when changing ownership. However, this is not</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">standard behaviour [99].</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">140</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:100740px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background149.jpg" width=481 height=680></div>
<div style="position:absolute;left:291.58px;top:17.14px" class="cls_004"><span class="cls_004">6.3. A content-addressable store</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">(page 97) that some FSOs in the extensional model have this property. In particular, store</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">derivations and sources added to the store by</span><span class="cls_007"> instantiate</span><span class="cls_004"> have store paths that are computed</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">from their contents.  The function</span><span class="cls_007"> addToStore</span><span class="cls_004"> (Figure 5.3) computes the store path as</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">follows:</span></div>
<div style="position:absolute;left:89.53px;top:103.35px" class="cls_004"><span class="cls_004">p ← </span><span class="cls_007">makePath</span><span class="cls_004">(</span><span class="cls_007">"source"</span><span class="cls_004">, </span><span class="cls_007">printHash</span><span class="cls_012"><sub>16</sub></span><span class="cls_004">(h), name)</span></div>
<div style="position:absolute;left:63.87px;top:125.80px" class="cls_004"><span class="cls_004">Thus the store path depends entirely on the cryptographic hash h of the contents of the</span></div>
<div style="position:absolute;left:63.87px;top:137.76px" class="cls_004"><span class="cls_004">FSO being added, and its symbolic name. (So strictly speaking, these paths can only be</span></div>
<div style="position:absolute;left:63.87px;top:149.71px" class="cls_004"><span class="cls_004">considered “content-addressing” if the symbolic name is considered part of the content.)</span></div>
<div style="position:absolute;left:73.84px;top:161.93px" class="cls_004"><span class="cls_004">Since we assume that collisions of the cryptographic hash functions used in Nix do</span></div>
<div style="position:absolute;left:63.87px;top:173.89px" class="cls_004"><span class="cls_004">not occur in practice (since they are supposedly infeasible to produce), we have a one-to-</span></div>
<div style="position:absolute;left:63.87px;top:185.84px" class="cls_004"><span class="cls_004">one correspondence between paths and contents. This gives us some concrete properties.</span></div>
<div style="position:absolute;left:63.87px;top:197.80px" class="cls_004"><span class="cls_004">Given a particular FSO fso, there is at most one path whose contents are equal to fso. Also,</span></div>
<div style="position:absolute;left:63.87px;top:209.75px" class="cls_004"><span class="cls_004">assuming infeasibility of finding hash collisions and given two Nix stores both containing</span></div>
<div style="position:absolute;left:63.87px;top:221.71px" class="cls_004"><span class="cls_004">a valid path p, the FSOs stored at p must be equal (for if they are not, we have found a</span></div>
<div style="position:absolute;left:63.87px;top:233.66px" class="cls_004"><span class="cls_004">hash collision).</span></div>
<div style="position:absolute;left:73.84px;top:245.88px" class="cls_004"><span class="cls_004">Content-addressability is an extremely useful property. Recall the example on page 138,</span></div>
<div style="position:absolute;left:63.87px;top:257.84px" class="cls_004"><span class="cls_004">where Alice and Bob had different trust relations, so there were substitutes with different</span></div>
<div style="position:absolute;left:63.87px;top:269.79px" class="cls_004"><span class="cls_004">contents for a single store path.  This problem does not exist in a content-addressable</span></div>
<div style="position:absolute;left:63.87px;top:281.75px" class="cls_004"><span class="cls_004">store, since in such a system path equality (between different substitutes) implies content</span></div>
<div style="position:absolute;left:63.87px;top:293.70px" class="cls_004"><span class="cls_004">equality.</span></div>
<div style="position:absolute;left:73.84px;top:305.92px" class="cls_004"><span class="cls_004">But not all store objects in the extensional model are stored in a content-addressed way.</span></div>
<div style="position:absolute;left:63.87px;top:317.88px" class="cls_004"><span class="cls_004">Derivation outputs are not; the output path of a derivation is computed from the input</span></div>
<div style="position:absolute;left:63.87px;top:329.83px" class="cls_004"><span class="cls_004">derivation (Figure 5.6), not from the actual contents produced by the builder. Below we</span></div>
<div style="position:absolute;left:63.87px;top:341.79px" class="cls_004"><span class="cls_004">will show how we can achieve content-addressability even for derivation outputs. As we</span></div>
<div style="position:absolute;left:63.87px;top:353.74px" class="cls_004"><span class="cls_004">shall see, this is not trivial due to self-referential components.</span></div>
<div style="position:absolute;left:73.84px;top:365.96px" class="cls_004"><span class="cls_004">Once we have the property of content-addressability, different users can have different</span></div>
<div style="position:absolute;left:63.87px;top:377.92px" class="cls_004"><span class="cls_004">trust relations: for each user we can have a different derivation to output path mapping.</span></div>
<div style="position:absolute;left:63.87px;top:389.87px" class="cls_004"><span class="cls_004">This is the intensional model—equality is defined by internal contents, not by observable</span></div>
<div style="position:absolute;left:63.87px;top:401.83px" class="cls_004"><span class="cls_004">behaviour. This model is much stronger than the extensional model, since it doesn’t make</span></div>
<div style="position:absolute;left:63.87px;top:413.78px" class="cls_004"><span class="cls_004">the simplifying but unenforcible assumption of builder purity. Rather, intensionality is an</span></div>
<div style="position:absolute;left:63.87px;top:425.74px" class="cls_004"><span class="cls_004">inherent property of the system.</span></div>
<div style="position:absolute;left:63.87px;top:454.92px" class="cls_008"><span class="cls_008">6.3.1. The hash invariant</span></div>
<div style="position:absolute;left:63.87px;top:474.90px" class="cls_004"><span class="cls_004">The crucial property of the intensional model is that the Nix store is now content-</span></div>
<div style="position:absolute;left:63.87px;top:486.85px" class="cls_004"><span class="cls_004">addressable: if we know the contents of a store object, we know its store path.</span></div>
<div style="position:absolute;left:73.84px;top:499.07px" class="cls_004"><span class="cls_004">Ideally, this would mean that if an FSO has hash h, then it is stored in the Nix store at</span></div>
<div style="position:absolute;left:63.87px;top:511.03px" class="cls_004"><span class="cls_004">nixStore/h −name, where nixStore is the location of the Nix store and name is the symbolic</span></div>
<div style="position:absolute;left:63.87px;top:522.98px" class="cls_004"><span class="cls_004">name for the FSO (e.g.</span><span class="cls_007"> hello-2.1.1</span><span class="cls_004">). For instance, if a Hello FSO has truncated SHA-256</span></div>
<div style="position:absolute;left:63.87px;top:534.94px" class="cls_004"><span class="cls_004">hash</span><span class="cls_007"> lm61ss8nz7hl...</span><span class="cls_004">, then its store path would be</span><span class="cls_007"> /nix/store/lm61ss8nz7hl...-hello-2.1.1</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:547.16px" class="cls_004"><span class="cls_004">However, this is not sufficient, since the symbolic name must be taken into account in</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">the hash part of the store path as well. If the same FSO were added multiple times, but</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">with different symbolic names, the resulting store paths must not have the same hash part,</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">since our scanning approach to finding references uses only the hash part to distinguish</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">141</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:101430px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background150.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">dependencies. Therefore, in the intensional model, the function</span><span class="cls_007"> makePath</span><span class="cls_004"> that computes</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">store paths from a content hash h and a symbolic name name is defined as follows:</span></div>
<div style="position:absolute;left:84.62px;top:79.38px" class="cls_007"><span class="cls_007">makePath</span><span class="cls_004">(h, name) =</span></div>
<div style="position:absolute;left:94.59px;top:94.32px" class="cls_004"><span class="cls_004">nixStore +</span><span class="cls_007"> "/"</span><span class="cls_004"> +</span><span class="cls_007"> printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004">(</span><span class="cls_007">truncate</span><span class="cls_004">(20,</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(s))) +</span><span class="cls_007"> "-"</span><span class="cls_004"> + name</span></div>
<div style="position:absolute;left:59.72px;top:116.70px" class="cls_004"><span class="cls_004">where</span></div>
<div style="position:absolute;left:84.62px;top:139.09px" class="cls_004"><span class="cls_004">s = </span><span class="cls_007">"sha256:"</span><span class="cls_004">+</span><span class="cls_007">printHash</span><span class="cls_012"><sub>16</sub></span><span class="cls_004">(h)+</span><span class="cls_007">":"</span><span class="cls_004">+name</span></div>
<div style="position:absolute;left:59.72px;top:161.47px" class="cls_004"><span class="cls_004">Note that contrary to the definition of</span><span class="cls_007"> makePath</span><span class="cls_004"> in the extensional model (page 94), this</span></div>
<div style="position:absolute;left:59.72px;top:173.42px" class="cls_004"><span class="cls_004">function produces a store path that depends only on a cryptographic hash h of the contents</span></div>
<div style="position:absolute;left:59.72px;top:185.38px" class="cls_004"><span class="cls_004">of the FSO to be stored, and its symbolic name name.</span></div>
<div style="position:absolute;left:69.68px;top:197.57px" class="cls_004"><span class="cls_004">The hash h is the hash of the contents of the FSO being added. It is almost, but not quite,</span></div>
<div style="position:absolute;left:59.72px;top:209.52px" class="cls_004"><span class="cls_004">the SHA-256 hash over the serialisation of the FSO, i.e.,</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(fso)). As we</span></div>
<div style="position:absolute;left:59.72px;top:221.48px" class="cls_004"><span class="cls_004">shall see below, hashing is a bit more complicated due to self-referential components.</span></div>
<div style="position:absolute;left:69.68px;top:233.67px" class="cls_004"><span class="cls_004">But let’s ignore that for now. Suppose that we want to add a store object to the store that</span></div>
<div style="position:absolute;left:59.72px;top:245.62px" class="cls_004"><span class="cls_004">has SHA-256 hash</span><span class="cls_007"> 73b7e0fc5265...</span><span class="cls_004"> and symbolic name</span><span class="cls_007"> hello-2.1.1</span><span class="cls_004">. Then,</span></div>
<div style="position:absolute;left:84.62px;top:268.00px" class="cls_004"><span class="cls_004">s = </span><span class="cls_007">"sha256:"</span><span class="cls_004">+</span><span class="cls_007">"73b7e0fc5265..."</span><span class="cls_004">+</span><span class="cls_007">":"</span><span class="cls_004">+</span><span class="cls_007">"hello-2.1.1"</span></div>
<div style="position:absolute;left:90.71px;top:282.95px" class="cls_004"><span class="cls_004">=</span><span class="cls_007"> "sha256:73b7e0fc5265...:hello-2.1.1"</span></div>
<div style="position:absolute;left:59.72px;top:305.33px" class="cls_004"><span class="cls_004">and since</span></div>
<div style="position:absolute;left:84.62px;top:327.71px" class="cls_007"><span class="cls_007">printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004">(</span><span class="cls_007">truncate</span><span class="cls_004">(20,</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(s))) =</span></div>
<div style="position:absolute;left:94.59px;top:342.66px" class="cls_007"><span class="cls_007">"wf9la39rq7sx5hj0jry0mn5v48w8cmwi"</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:59.72px;top:365.04px" class="cls_004"><span class="cls_004">we obtain the store path</span></div>
<div style="position:absolute;left:84.62px;top:388.42px" class="cls_007"><span class="cls_007">/nix/store/wf9la39rq7sx5hj0jry0mn5v48w8cmwi-hello-2.1.1</span></div>
<div style="position:absolute;left:59.72px;top:409.80px" class="cls_004"><span class="cls_004">The hash part</span><span class="cls_007"> wf9la39rq7sx...</span><span class="cls_004">  is determined entirely by the contents and the symbolic</span></div>
<div style="position:absolute;left:59.72px;top:421.76px" class="cls_004"><span class="cls_004">name. There can never be another object in the store with the same contents and symbolic</span></div>
<div style="position:absolute;left:59.72px;top:433.72px" class="cls_004"><span class="cls_004">name, but with a different store path. So there is a correspondence between a store path’s</span></div>
<div style="position:absolute;left:59.72px;top:445.67px" class="cls_004"><span class="cls_004">hash part, and the contents at that store path. This is called the hash invariant, and it is</span></div>
<div style="position:absolute;left:59.72px;top:457.63px" class="cls_004"><span class="cls_004">what sets the intensional model apart from the extensional model.</span></div>
<div style="position:absolute;left:59.72px;top:478.25px" class="cls_004"><span class="cls_004">Invariant 7 (Hash invariant). The hash part of a valid store path p is determined by the</span></div>
<div style="position:absolute;left:59.72px;top:490.20px" class="cls_004"><span class="cls_004">cryptographic hash of p:</span></div>
<div style="position:absolute;left:89.60px;top:512.49px" class="cls_004"><span class="cls_004">∀p ∈ </span><span class="cls_007">Path </span><span class="cls_004">: </span><span class="cls_007">valid</span><span class="cls_004">[p] = ε → p = </span><span class="cls_007">makePath</span><span class="cls_004">(</span><span class="cls_007">valid</span><span class="cls_004">[p],</span><span class="cls_007">namePart</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:69.68px;top:535.20px" class="cls_004"><span class="cls_004">Recall that</span><span class="cls_007"> namePart</span><span class="cls_004">(p) returns the symbolic name component of path p, e.g. for</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_007"><span class="cls_007">/nix/store/bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004"> it returns</span><span class="cls_007"> hello-2.1.1</span><span class="cls_004">. Also recall that</span><span class="cls_007"> valid</span><span class="cls_004">[p] con-</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">tains the cryptographic hash of the serialisation of the FSO at p, stored when p was made</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">valid. Due to the stored hash invariant (page 96), this hash must match the actual contents at</span></div>
<div style="position:absolute;left:60.46px;top:583.02px" class="cls_004"><span class="cls_004">p. Also note that while we compare the entirety of p to</span><span class="cls_007"> makePath</span><span class="cls_004">(</span><span class="cls_007">valid</span><span class="cls_004">[p],</span><span class="cls_007"> namePart</span><span class="cls_004">(p)),</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">142</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:102120px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background151.jpg" width=481 height=680></div>
<div style="position:absolute;left:291.58px;top:17.14px" class="cls_004"><span class="cls_004">6.3. A content-addressable store</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">it is only the hash part of p that actually matters. The equality of the name part is tautolog-</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">ical, since we feed</span><span class="cls_007"> namePart</span><span class="cls_004">(p) into the call to</span><span class="cls_007"> makePath</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:68.95px" class="cls_004"><span class="cls_004">So how does content-addressability help us to achieve secure sharing in multi-user Nix</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">stores? The answer is that users can now independently install software, i.e., build deriva-</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">tions. If the results of those independent builds are the same, they get sharing; if results</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">differ due to impurity, they do not. This applies not just to local builds but more signifi-</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">cantly to substitutes.</span></div>
<div style="position:absolute;left:73.84px;top:128.73px" class="cls_004"><span class="cls_004">In the example on page 138, when Alice installs a derivation for Hello using a Trojaned</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">substitute from a malicious machine, the result will end up in some path, say</span><span class="cls_007"> /nix/store/-</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_007"><span class="cls_007">5n5drxv693s3...-hello-2.1.1</span><span class="cls_004">. If Bob installs the same derivation but using a legitimate sub-</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">stitute, the contents will differ and thus the result will necessarily be in a different store</span></div>
<div style="position:absolute;left:63.87px;top:176.55px" class="cls_004"><span class="cls_004">path, e.g.</span><span class="cls_007"> /nix/store/4d6hb6vxh388...-hello-2.1.1</span><span class="cls_004">. This path will be added to his user envi-</span></div>
<div style="position:absolute;left:63.87px;top:188.50px" class="cls_004"><span class="cls_004">ronment. Thus, he is insulated from Alice’s bad remote trust relation.</span></div>
<div style="position:absolute;left:63.87px;top:215.75px" class="cls_008"><span class="cls_008">6.3.2. Hash rewriting</span></div>
<div style="position:absolute;left:63.87px;top:235.23px" class="cls_004"><span class="cls_004">The property of content-addressability is easily stated but not so easily achieved. This is</span></div>
<div style="position:absolute;left:63.87px;top:247.18px" class="cls_004"><span class="cls_004">because we do not know the content hash of a component until after we have built it, but</span></div>
<div style="position:absolute;left:63.87px;top:259.14px" class="cls_004"><span class="cls_004">we need to supply an output path to the builder beforehand so that it knows where to store</span></div>
<div style="position:absolute;left:63.87px;top:271.09px" class="cls_004"><span class="cls_004">the component. In order to achieve content-addressability for derivation output, we must</span></div>
<div style="position:absolute;left:63.87px;top:283.05px" class="cls_004"><span class="cls_004">rename them after they have been built to the appropriate content-addressed name in the</span></div>
<div style="position:absolute;left:63.87px;top:295.00px" class="cls_004"><span class="cls_004">store. Roughly speaking, we first build the derivation in a temporary location, compute the</span></div>
<div style="position:absolute;left:63.87px;top:306.96px" class="cls_004"><span class="cls_004">hash over the result, and rename the temporary path to the content-addressed final location.</span></div>
<div style="position:absolute;left:73.84px;top:318.91px" class="cls_004"><span class="cls_004">So the first step is to perform a build in a store path p with a randomly generated hash</span></div>
<div style="position:absolute;left:63.87px;top:330.87px" class="cls_004"><span class="cls_004">part, i.e.,</span></div>
<div style="position:absolute;left:89.53px;top:350.15px" class="cls_004"><span class="cls_004">p = </span><span class="cls_007">makePath</span><span class="cls_004">(</span><span class="cls_007">randomHash</span><span class="cls_004">(), name)</span></div>
<div style="position:absolute;left:63.87px;top:369.44px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> randomHash</span><span class="cls_004">() produces a sufficiently long pseudo-random base-32 number</span></div>
<div style="position:absolute;left:63.87px;top:381.39px" class="cls_004"><span class="cls_004">of the same length as a normal hash part, i.e., 32 characters. For instance, if we are building</span></div>
<div style="position:absolute;left:63.87px;top:393.35px" class="cls_004"><span class="cls_004">Hello, we might produce the temporary path</span></div>
<div style="position:absolute;left:89.53px;top:412.63px" class="cls_004"><span class="cls_004">p = </span><span class="cls_007">makePath</span><span class="cls_004">(</span><span class="cls_007">"2c8d367ae0c4..."</span><span class="cls_004">, </span><span class="cls_007">"hello-2.1.1"</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:96.72px;top:427.58px" class="cls_004"><span class="cls_004">=</span><span class="cls_007"> /nix/store/2jxsizriq3al...-hello-2.1.1</span></div>
<div style="position:absolute;left:63.87px;top:446.86px" class="cls_004"><span class="cls_004">Thus, the builder is executed with the environment variable</span><span class="cls_007"> out</span><span class="cls_004"> set to the store path</span></div>
<div style="position:absolute;left:63.87px;top:458.82px" class="cls_007"><span class="cls_007">/nix/store/2jxsizriq3al...-hello-2.1.1</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:470.77px" class="cls_004"><span class="cls_004">If the build finishes successfully, we compute the SHA-256 hash h over the serialisation</span></div>
<div style="position:absolute;left:63.87px;top:481.70px" class="cls_004"><span class="cls_004">of the FSO at p. We then rename path p to p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, computed as follows:</span></div>
<div style="position:absolute;left:89.53px;top:500.49px" class="cls_004"><span class="cls_004">p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> =</span><span class="cls_007"> makePath</span><span class="cls_004">(h, name)</span></div>
<div style="position:absolute;left:63.87px;top:521.30px" class="cls_004"><span class="cls_004">Thus, the temporary path p, which did not obey the hash invariant, is changed to one that</span></div>
<div style="position:absolute;left:63.87px;top:533.25px" class="cls_004"><span class="cls_004">does obey the hash invariant. Suppose that after the build of Hello we compute content</span></div>
<div style="position:absolute;left:63.87px;top:545.21px" class="cls_004"><span class="cls_004">hash</span><span class="cls_007"> 5c769ad74cac</span></div>
<div style="position:absolute;left:156.00px;top:544.18px" class="cls_004"><span class="cls_004">Then the final path p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> becomes:</span></div>
<div style="position:absolute;left:89.53px;top:564.49px" class="cls_004"><span class="cls_004">p = </span><span class="cls_007">makePath</span><span class="cls_004">(</span><span class="cls_007">"5c769ad74cac..."</span><span class="cls_004">, </span><span class="cls_007">"hello-2.1.1"</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:96.72px;top:579.44px" class="cls_004"><span class="cls_004">=</span><span class="cls_007"> /nix/store/jj8d7j9j6scc...-hello-2.1.1</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">143</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:102810px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background152.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">So the temporary build result</span><span class="cls_007"> /nix/store/2jxsizriq3al...-hello-2.1.1</span><span class="cls_004"> is renamed to</span><span class="cls_007"> /nix/store/-</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_007"><span class="cls_007">jj8d7j9j6scc...-hello-2.1.1</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:68.95px" class="cls_004"><span class="cls_004">There is a snag, however: simply renaming the temporary path doesn’t work in case of</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">self-references, that is, if the binary image of a file refers to its own store path.  This is</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">quite common. For instance, the RPATH of a Unix executable (page 23) frequently points</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">to its own directory so that related library components can be found.  If we rename the</span></div>
<div style="position:absolute;left:59.72px;top:115.74px" class="cls_004"><span class="cls_004">temporary path p to p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> in such a case, the references to p will become dangling references,</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">and the component probably will not work anymore.</span></div>
<div style="position:absolute;left:69.68px;top:140.68px" class="cls_004"><span class="cls_004">We solve this problem through the technique of hash rewriting. The basic idea is that</span></div>
<div style="position:absolute;left:59.72px;top:151.61px" class="cls_004"><span class="cls_004">we copy p to p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, but at the same time replace all occurrences of the string</span><span class="cls_007"> hashPart</span><span class="cls_004">(p) in</span></div>
<div style="position:absolute;left:59.72px;top:163.57px" class="cls_004"><span class="cls_004">the FSO with</span><span class="cls_007"> hashPart</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">). (Recall that</span><span class="cls_007"> hashPart</span><span class="cls_004">(p) yields the hash part of path p.)</span></div>
<div style="position:absolute;left:69.68px;top:176.55px" class="cls_004"><span class="cls_004">However, this changes the contents of the component, thereby invalidating the hash!</span></div>
<div style="position:absolute;left:59.72px;top:188.50px" class="cls_004"><span class="cls_004">So we have a circular problem: we want to change the contents of an FSO to match its</span></div>
<div style="position:absolute;left:59.72px;top:200.46px" class="cls_004"><span class="cls_004">hash, but that changes its hash, so the contents must be changed again, and so on. With</span></div>
<div style="position:absolute;left:59.72px;top:212.41px" class="cls_004"><span class="cls_004">cryptographic hashes it is not feasible to compute a “fixed point”: a string that contains a</span></div>
<div style="position:absolute;left:59.72px;top:224.37px" class="cls_004"><span class="cls_004">representation of the hash to which the string hashes. I.e., it is not computationally feasible</span></div>
<div style="position:absolute;left:59.72px;top:236.32px" class="cls_004"><span class="cls_004">to compute a string s such that</span></div>
<div style="position:absolute;left:84.62px;top:257.46px" class="cls_004"><span class="cls_004">s = s</span><span class="cls_012">1 </span><span class="cls_004">+</span><span class="cls_007">printHash</span><span class="cls_004">(</span><span class="cls_007">hash</span><span class="cls_012"><sub>t</sub></span><span class="cls_004">(</span><span class="cls_007">s</span><span class="cls_004">))+s</span><span class="cls_012"><sub>2</sub></span></div>
<div style="position:absolute;left:59.72px;top:278.60px" class="cls_004"><span class="cls_004">where s</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> and s</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> are an arbitrary prefix and suffix to the occurrence of the hash representa-</span></div>
<div style="position:absolute;left:59.72px;top:290.56px" class="cls_004"><span class="cls_004">tion.</span></div>
<div style="position:absolute;left:69.68px;top:302.51px" class="cls_004"><span class="cls_004">We solve this problem by computing hashes modulo self-references.  Essentially, this</span></div>
<div style="position:absolute;left:59.72px;top:314.47px" class="cls_004"><span class="cls_004">means that we ignore self-references when computing the hash. So the hash h is not com-</span></div>
<div style="position:absolute;left:59.72px;top:326.42px" class="cls_004"><span class="cls_004">puted as the SHA-256 hash of the serialisation of the FSO:</span></div>
<div style="position:absolute;left:84.62px;top:347.56px" class="cls_004"><span class="cls_004">h = </span><span class="cls_007">hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p)))</span></div>
<div style="position:absolute;left:59.72px;top:368.70px" class="cls_004"><span class="cls_004">Instead, the hash is computed over the serialisation of the FSO, with all occurrences of</span></div>
<div style="position:absolute;left:59.72px;top:380.65px" class="cls_007"><span class="cls_007">hashPart</span><span class="cls_004">(p) zeroed out. That is,</span></div>
<div style="position:absolute;left:84.62px;top:401.79px" class="cls_004"><span class="cls_004">h = </span><span class="cls_007">hashModulo</span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p)), </span><span class="cls_007">hashPart</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:59.72px;top:422.93px" class="cls_004"><span class="cls_004">where</span></div>
<div style="position:absolute;left:84.62px;top:444.07px" class="cls_007"><span class="cls_007">hashModulo</span><span class="cls_004">(c, hp) =</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span></div>
<div style="position:absolute;left:232.31px;top:441.81px" class="cls_038"><span class="cls_038">∑</span></div>
<div style="position:absolute;left:255.46px;top:444.07px" class="cls_004"><span class="cls_004">(i +</span><span class="cls_007"> ":"</span><span class="cls_004">) +</span><span class="cls_007"> ":"</span><span class="cls_004"> +</span><span class="cls_007"> replace</span><span class="cls_004">(c, {hp ⇝ 0}))</span></div>
<div style="position:absolute;left:219.39px;top:457.52px" class="cls_012"><span class="cls_012">i∈</span><span class="cls_039">find</span><span class="cls_012">(c,hp)</span></div>
<div style="position:absolute;left:59.72px;top:475.43px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> find</span><span class="cls_004">(c, h) (first seen in Section 5.5) yields the offsets of the occurrences of the</span></div>
<div style="position:absolute;left:59.72px;top:487.38px" class="cls_004"><span class="cls_004">substring h in the string s. The constant 0 denotes a string consisting of binary 0s of the</span></div>
<div style="position:absolute;left:59.72px;top:499.34px" class="cls_004"><span class="cls_004">same length as the hash part hp, 32 characters. The function</span><span class="cls_007"> replace</span><span class="cls_004">(c, r) applies a set of</span></div>
<div style="position:absolute;left:59.72px;top:511.29px" class="cls_004"><span class="cls_004">textual substitutions r to the string s. Textual substitutions in r are denoted as x ⇝ y, i.e.,</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">occurrences of the string x are replaced with the string y.</span></div>
<div style="position:absolute;left:69.68px;top:535.20px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> hashModulo</span><span class="cls_004"> computes a hash not just over c with the hash part hp cleared</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">out, but also takes the offsets of hp into account. It is necessary to encode the offsets of</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">the occurrences of hp into the hash to prevent hash collisions for strings that are equal</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">except for having either hp or 0-strings at the same location.  The colons simply act as</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">disambiguators, separating the offsets and the contents.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">144</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:103500px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background153.jpg" width=481 height=680></div>
<div style="position:absolute;left:361.29px;top:17.14px" class="cls_004"><span class="cls_004">6.4. Semantics</span></div>
<div style="position:absolute;left:73.84px;top:45.04px" class="cls_004"><span class="cls_004">For example, suppose we have two FSOs A and B that are equal except that at one point,</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">A has a self-reference while B has zeroes, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:78.32px" class="cls_004"><span class="cls_004">A = </span><span class="cls_007">"xxxxHxxxHxxHxxx"</span></div>
<div style="position:absolute;left:88.78px;top:93.26px" class="cls_004"><span class="cls_004">B = </span><span class="cls_007">"xxxxHxxx0xxHxxx"</span></div>
<div style="position:absolute;left:63.87px;top:114.58px" class="cls_004"><span class="cls_004">where H is a self-reference and 0 is a string of 32 zeroes. If we do not take self-reference</span></div>
<div style="position:absolute;left:63.87px;top:126.54px" class="cls_004"><span class="cls_004">locations into account, A and B will hash to the same value.</span></div>
<div style="position:absolute;left:73.84px;top:137.46px" class="cls_004"><span class="cls_004">The hash h computed using</span><span class="cls_007"> hashModulo</span><span class="cls_004"> is used to produce the new store path p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> as</span></div>
<div style="position:absolute;left:63.87px;top:149.42px" class="cls_004"><span class="cls_004">described above, i.e., using</span><span class="cls_007"> makePath</span><span class="cls_004">. Then, we copy p to p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, rewriting all occurrences of</span></div>
<div style="position:absolute;left:63.87px;top:161.37px" class="cls_007"><span class="cls_007">hashPart</span><span class="cls_004">(p) in the contents of p with</span><span class="cls_007"> hashPart</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">):</span></div>
<div style="position:absolute;left:88.78px;top:182.20px" class="cls_007"><span class="cls_007">writePath</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">,</span><span class="cls_007"> deserialise</span><span class="cls_004">(c</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">))</span></div>
<div style="position:absolute;left:63.87px;top:205.04px" class="cls_004"><span class="cls_004">where</span></div>
<div style="position:absolute;left:88.78px;top:224.84px" class="cls_004"><span class="cls_004">c</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> =</span><span class="cls_007"> replace</span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p)),</span><span class="cls_007"> hashPart</span><span class="cls_004">(p) ⇝</span><span class="cls_007"> hashPart</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">)).</span></div>
<div style="position:absolute;left:63.87px;top:247.68px" class="cls_004"><span class="cls_004">Note that even though in case of self-references in general</span></div>
<div style="position:absolute;left:88.78px;top:267.48px" class="cls_007"><span class="cls_007">hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p))) =</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">))),</span></div>
<div style="position:absolute;left:63.87px;top:290.33px" class="cls_004"><span class="cls_004">we do have</span></div>
<div style="position:absolute;left:98.74px;top:311.65px" class="cls_007"><span class="cls_007">hashModulo</span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p)),</span><span class="cls_007"> hashPart</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:88.78px;top:325.07px" class="cls_004"><span class="cls_004">=</span><span class="cls_007"> hashModulo</span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">)),</span><span class="cls_007"> hashPart</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">)).</span></div>
<div style="position:absolute;left:63.87px;top:347.91px" class="cls_004"><span class="cls_004">That is, the hash modulo the randomly generated hash part does not change after hash</span></div>
<div style="position:absolute;left:63.87px;top:359.87px" class="cls_004"><span class="cls_004">rewriting.</span></div>
<div style="position:absolute;left:63.87px;top:390.43px" class="cls_011"><span class="cls_011">6.4. Semantics</span></div>
<div style="position:absolute;left:63.87px;top:415.65px" class="cls_004"><span class="cls_004">We can now formalise the intensional model.  The main difference with the extensional</span></div>
<div style="position:absolute;left:63.87px;top:427.60px" class="cls_004"><span class="cls_004">model is that output paths are no longer known a priori. But because of this, we cannot</span></div>
<div style="position:absolute;left:63.87px;top:439.56px" class="cls_004"><span class="cls_004">prevent re-building a derivation by checking (as was done in</span><span class="cls_007"> substitute</span><span class="cls_004"> in Figure 5.15)</span></div>
<div style="position:absolute;left:63.87px;top:451.52px" class="cls_004"><span class="cls_004">whether its output path is already valid.  The same applies to checking for substitutes,</span></div>
<div style="position:absolute;left:63.87px;top:463.47px" class="cls_004"><span class="cls_004">which are also keyed on output paths.</span></div>
<div style="position:absolute;left:73.84px;top:475.43px" class="cls_004"><span class="cls_004">Also, due to impurity, a single derivation can now result in several distinct components</span></div>
<div style="position:absolute;left:63.87px;top:487.38px" class="cls_004"><span class="cls_004">residing at different store paths, if the derivation is built multiple times (e.g., by different</span></div>
<div style="position:absolute;left:63.87px;top:499.34px" class="cls_004"><span class="cls_004">users). That is, a derivation actually defines an equivalence class of store paths within the</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">Nix store, the members of such classes all having been produced by the same derivation.</span></div>
<div style="position:absolute;left:73.84px;top:523.25px" class="cls_004"><span class="cls_004">Therefore, we make the following change to the abstract syntax of store derivations</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">defined in Figure 5.5 (page 101). The field</span><span class="cls_007"> output</span><span class="cls_004"> is removed; we don’t know the output</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">path in advance. But we add a field</span><span class="cls_007"> eqClass</span><span class="cls_004"> :</span><span class="cls_007"> EqClass</span><span class="cls_004"> that identifies the equivalence class</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">of the output.</span></div>
<div style="position:absolute;left:73.84px;top:571.07px" class="cls_004"><span class="cls_004">So what is an equivalence class (i.e., what is the type</span><span class="cls_007"> EqClass</span><span class="cls_004">)?  In fact, the equiva-</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">lence class</span><span class="cls_007"> eqClass</span><span class="cls_004"> is exactly the same as the original</span><span class="cls_007"> output</span><span class="cls_004"> field! It is computed in the</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">145</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:104190px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background154.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">same way, namely, by hashing the derivation with its</span><span class="cls_007"> eqClass</span><span class="cls_004"> field set to the empty string</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">(callout</span></div>
<div style="position:absolute;left:95.09px;top:56.99px" class="cls_056"><span class="cls_056">64</span><span class="cls_059"> </span><span class="cls_004"> on page 102).  Note that the hash parts produced there cannot conflict with</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">those computed by</span><span class="cls_007"> makePath</span><span class="cls_004"> in the previous section, assuming that there are no hash col-</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">lisions (since the former hash preimages start with</span><span class="cls_007"> sha256:output:out:</span><span class="cls_004">, while the latter hash</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">preimages start with</span><span class="cls_007"> sha256:</span><span class="cls_004"> followed by a hash). So for instance, when instantiating our</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">running example, the Hello derivation, we obtain</span><span class="cls_007"> d.eqClass = "/nix/store/bwacc7a5c5n3...-</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_007"><span class="cls_007">hello-2.1.1"</span><span class="cls_004">. In the extensional model, we had</span><span class="cls_007"> d.output = "/nix/store/bwacc7a5c5n3...-hello-</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_007"><span class="cls_007">2.1.1"</span><span class="cls_004">. Since</span><span class="cls_007"> eqClass</span><span class="cls_004"> is just a (fake) store path, the type</span><span class="cls_007"> EqClass</span><span class="cls_004"> is just an alias for the</span></div>
<div style="position:absolute;left:59.72px;top:140.68px" class="cls_004"><span class="cls_004">type</span><span class="cls_007"> Path</span><span class="cls_004"> introduced for legibility.</span></div>
<div style="position:absolute;left:69.68px;top:152.64px" class="cls_004"><span class="cls_004">So we have really just renamed the field</span><span class="cls_007"> output</span><span class="cls_004"> to</span><span class="cls_007"> eqClass</span><span class="cls_004">. However, there is an im-</span></div>
<div style="position:absolute;left:59.72px;top:164.59px" class="cls_004"><span class="cls_004">portant difference in the meaning of</span><span class="cls_007"> eqClass</span><span class="cls_004">. The equivalence class path is “virtual”: it is</span></div>
<div style="position:absolute;left:59.72px;top:176.55px" class="cls_004"><span class="cls_004">never built. For example, in the intensional Nix store, we will never actually build a path</span></div>
<div style="position:absolute;left:59.72px;top:188.50px" class="cls_007"><span class="cls_007">/nix/store/bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:200.46px" class="cls_004"><span class="cls_004">The reason for using store paths for equivalence classes is that it gives us an easy way</span></div>
<div style="position:absolute;left:59.72px;top:212.41px" class="cls_004"><span class="cls_004">to refer to the output of a derivation from other derivations. For instance, the</span><span class="cls_007"> envVars</span><span class="cls_004"> field</span></div>
<div style="position:absolute;left:59.72px;top:224.37px" class="cls_004"><span class="cls_004">of a derivation that depends on Firefox must in some way refer to the path of the Firefox</span></div>
<div style="position:absolute;left:59.72px;top:236.32px" class="cls_004"><span class="cls_004">component, even though this path is not known in advance anymore.  When we build a</span></div>
<div style="position:absolute;left:59.72px;top:247.25px" class="cls_004"><span class="cls_004">derivation d depending on derivation d</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, we simply rewrite in d.</span><span class="cls_007">envVars</span><span class="cls_004"> all occurrences of</span></div>
<div style="position:absolute;left:59.72px;top:259.21px" class="cls_007"><span class="cls_007">hashPart</span><span class="cls_004">(d</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">.</span><span class="cls_007">eqClass</span><span class="cls_004">) to a trusted member of the equivalence class denoted by d</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">.</span><span class="cls_007">eqClass</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:272.19px" class="cls_004"><span class="cls_004">Since we must remember for each derivation what output paths were produced by</span></div>
<div style="position:absolute;left:59.72px;top:284.14px" class="cls_004"><span class="cls_004">it and who built or substituted them, we define a database mapping</span><span class="cls_007"> eqClassMembers</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:59.72px;top:296.10px" class="cls_007"><span class="cls_007">EqClass</span><span class="cls_004"> → {(</span><span class="cls_007">UserId</span><span class="cls_004">,</span><span class="cls_007"> Path</span><span class="cls_004">)}. The type</span><span class="cls_007"> UserId</span><span class="cls_004"> denotes a user identity. Here we will simply</span></div>
<div style="position:absolute;left:59.72px;top:308.05px" class="cls_004"><span class="cls_004">take them to denote Unix user names, e.g.,</span><span class="cls_007"> alice</span><span class="cls_004">. More elaborate notions of identity are</span></div>
<div style="position:absolute;left:59.72px;top:320.01px" class="cls_004"><span class="cls_004">also possible, e.g., using groups or classes of users.</span></div>
<div style="position:absolute;left:69.68px;top:331.96px" class="cls_004"><span class="cls_004">Through the table</span><span class="cls_007"> eqClassMembers</span><span class="cls_004">, an equivalence class maps to a set of concrete store</span></div>
<div style="position:absolute;left:59.72px;top:343.92px" class="cls_004"><span class="cls_004">paths along with the names of the users that built or substituted them.  For instance, if</span></div>
<div style="position:absolute;left:59.72px;top:355.87px" class="cls_004"><span class="cls_004">both Alice and Bob have obtained Hello from their respective substitutes, the entry for</span></div>
<div style="position:absolute;left:59.72px;top:367.83px" class="cls_007"><span class="cls_007">/nix/store/bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004"> might be as follows:</span></div>
<div style="position:absolute;left:89.60px;top:388.82px" class="cls_007"><span class="cls_007">eqClassMembers</span><span class="cls_004">[</span><span class="cls_007">/nix/store/bwacc7a5c5n3...-hello-2.1.1</span><span class="cls_004">] =</span></div>
<div style="position:absolute;left:100.67px;top:400.78px" class="cls_004"><span class="cls_004">{ (</span><span class="cls_007">"alice"</span><span class="cls_004">,</span><span class="cls_007"> /nix/store/bpv6czrwrmhr</span></div>
<div style="position:absolute;left:252.51px;top:400.78px" class="cls_007"><span class="cls_007">-hello-2.1.1</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:100.67px;top:415.72px" class="cls_004"><span class="cls_004">, (</span><span class="cls_007">"bob"</span><span class="cls_004">,</span><span class="cls_007"> /nix/store/mqgi8xail9vp</span></div>
<div style="position:absolute;left:243.85px;top:415.72px" class="cls_007"><span class="cls_007">-hello-2.1.1</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:100.67px;top:430.66px" class="cls_004"><span class="cls_004">}</span></div>
<div style="position:absolute;left:59.72px;top:451.47px" class="cls_004"><span class="cls_004">Of course, a store path can occur multiple times for different users. This happens if multi-</span></div>
<div style="position:absolute;left:59.72px;top:463.43px" class="cls_004"><span class="cls_004">ple builds have yielded exactly the same result (the ideal!), or if users have installed from</span></div>
<div style="position:absolute;left:59.72px;top:475.38px" class="cls_004"><span class="cls_004">the same substitute.</span></div>
<div style="position:absolute;left:69.68px;top:487.34px" class="cls_004"><span class="cls_004">The members of an equivalence class (i.e., the right-hand side of an</span><span class="cls_007"> eqClassMembers</span></div>
<div style="position:absolute;left:59.72px;top:499.29px" class="cls_004"><span class="cls_004">entry) must be usable paths; that is, they must either be valid or have at least one substitute.</span></div>
<div style="position:absolute;left:69.68px;top:511.25px" class="cls_004"><span class="cls_004">We can now define the set of trusted paths in the equivalence class of a derivation output</span></div>
<div style="position:absolute;left:59.72px;top:523.20px" class="cls_004"><span class="cls_004">as the set of valid or substitutable paths for some user:</span></div>
<div style="position:absolute;left:84.62px;top:544.63px" class="cls_007"><span class="cls_007">trustedPaths</span><span class="cls_004">(eqClass, user) = {p | (user, p) ∈</span><span class="cls_007"> eqClassMembers</span><span class="cls_004">[eqClass]}</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_009"><span class="cls_009">Equivalence classes and closures</span><span class="cls_004">   A path can be a member of multiple equivalence</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">classes. This is easy to see: we can conceive of any number of different derivations that</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">146</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:104880px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background155.jpg" width=481 height=680></div>
<div style="position:absolute;left:361.29px;top:17.14px" class="cls_004"><span class="cls_004">6.4. Semantics</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">produce the output</span><span class="cls_007"> "Hello World"</span><span class="cls_004"> in various ways.  So we cannot unambiguously say to</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">what equivalence class a path belongs. However, as we shall see below, there are times</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">when we need to know this. In particular, when we compute the closure of a path p, we</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">want to know to what equivalence class each reference belongs.  Such a query is only</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">meaningful given a certain context, i.e., when we compute the closure of a path p in an</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">equivalence class e.</span></div>
<div style="position:absolute;left:73.84px;top:116.77px" class="cls_004"><span class="cls_004">To this end, a new database mapping</span><span class="cls_007"> refClasses</span><span class="cls_004"> : (</span><span class="cls_007">Path</span><span class="cls_004">,</span><span class="cls_007"> Path</span><span class="cls_004">) → {(</span><span class="cls_007">EqClass</span><span class="cls_004">,</span><span class="cls_007"> EqClass</span><span class="cls_004">)}</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">is needed. This table allows us to determine equivalence classes when we are following the</span></div>
<div style="position:absolute;left:63.87px;top:139.65px" class="cls_004"><span class="cls_004">references graph. It has the following meaning: if (e, e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">) ∈</span><span class="cls_007"> refClasses</span><span class="cls_004">[(p, p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">)], then there is</span></div>
<div style="position:absolute;left:63.87px;top:151.61px" class="cls_004"><span class="cls_004">an edge in the references graph from path p in equivalence class e to path p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> in equivalence</span></div>
<div style="position:absolute;left:63.87px;top:163.57px" class="cls_004"><span class="cls_004">class e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:175.52px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> closure</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(p, e) computes the closure of a path p in equivalence class e. It</span></div>
<div style="position:absolute;left:63.87px;top:188.50px" class="cls_004"><span class="cls_004">returns a set of pairs (p, e) : (</span><span class="cls_007">Path</span><span class="cls_004">,</span><span class="cls_007"> EqClass</span><span class="cls_004">). Its definition is as follows:</span></div>
<div style="position:absolute;left:217.85px;top:203.04px" class="cls_035"><span class="cls_035">⋃</span></div>
<div style="position:absolute;left:88.78px;top:209.29px" class="cls_007"><span class="cls_007">closure</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(p, e) = {(p, e)} ∪</span></div>
<div style="position:absolute;left:249.32px;top:209.29px" class="cls_007"><span class="cls_007">followRef</span><span class="cls_004">(p, e, p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:198.00px;top:224.55px" class="cls_012"><span class="cls_012">p</span><span class="cls_013"><sup>′</sup></span><span class="cls_012">∈</span><span class="cls_039">references</span><span class="cls_012">[p]</span></div>
<div style="position:absolute;left:63.87px;top:242.31px" class="cls_004"><span class="cls_004">The auxiliary function</span><span class="cls_007"> followRef</span><span class="cls_004">(p, e, p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">) yields the closure of p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> coming from path p in</span></div>
<div style="position:absolute;left:63.87px;top:255.29px" class="cls_004"><span class="cls_004">equivalence class e:</span></div>
<div style="position:absolute;left:171.18px;top:268.00px" class="cls_004"><span class="cls_004">{</span></div>
<div style="position:absolute;left:208.10px;top:277.22px" class="cls_012"><span class="cls_012"><sup>′</sup></span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, ε)</span></div>
<div style="position:absolute;left:277.28px;top:277.22px" class="cls_004"><span class="cls_004">if es</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> = 0</span></div>
<div style="position:absolute;left:88.78px;top:279.24px" class="cls_007"><span class="cls_007">followRef</span><span class="cls_004">(p, e, p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">) =</span><span class="cls_035">⋃</span><span class="cls_007">losure</span></div>
<div style="position:absolute;left:186.67px;top:291.57px" class="cls_012"><span class="cls_012">e</span><span class="cls_013"><sup>′</sup></span><span class="cls_012">∈es</span><span class="cls_013"><sup>′</sup></span><span class="cls_007"> closure</span><span class="cls_012">′</span><span class="cls_004">(p</span><span class="cls_012">′</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:256.50px;top:291.57px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">)  otherwise</span></div>
<div style="position:absolute;left:63.87px;top:314.40px" class="cls_004"><span class="cls_004">where</span></div>
<div style="position:absolute;left:88.78px;top:334.00px" class="cls_004"><span class="cls_004">es</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> = {e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> | (e, e</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">) ∈</span><span class="cls_007"> refClasses</span><span class="cls_004">[(p, p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">)]}</span></div>
<div style="position:absolute;left:63.87px;top:355.61px" class="cls_004"><span class="cls_004">The case where es</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> = 0 is to handle paths that are not in any equivalence class. This is</span></div>
<div style="position:absolute;left:63.87px;top:368.60px" class="cls_004"><span class="cls_004">quite normal: paths that are not outputs of derivations (such as sources) need not be in</span></div>
<div style="position:absolute;left:63.87px;top:380.55px" class="cls_004"><span class="cls_004">equivalence classes. For such paths, the special value ε is used to denote the absence of</span></div>
<div style="position:absolute;left:63.87px;top:392.51px" class="cls_004"><span class="cls_004">an actual equivalence class.  It should be noted that the left-hand sides of the pairs (the</span></div>
<div style="position:absolute;left:63.87px;top:403.43px" class="cls_004"><span class="cls_004">paths) in the set returned by</span><span class="cls_007"> closure</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(p, e) are the same for all e given a certain p. Only</span></div>
<div style="position:absolute;left:63.87px;top:416.42px" class="cls_004"><span class="cls_004">the right-hand sides (the equivalence classes) can differ.</span></div>
<div style="position:absolute;left:63.87px;top:443.99px" class="cls_008"><span class="cls_008">6.4.1. Equivalence class collisions</span></div>
<div style="position:absolute;left:63.87px;top:463.47px" class="cls_004"><span class="cls_004">The fact that a derivation can resolve to any number of output paths due to impurity, leads</span></div>
<div style="position:absolute;left:63.87px;top:475.43px" class="cls_004"><span class="cls_004">to the problem that we might end up with a closure that contains more than one element</span></div>
<div style="position:absolute;left:63.87px;top:487.38px" class="cls_004"><span class="cls_004">from the output equivalence class of a derivation.</span></div>
<div style="position:absolute;left:73.84px;top:499.34px" class="cls_004"><span class="cls_004">Figure 6.1 shows an example of this phenomenon. (As in Figure 2.3, an edge from node</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">A to B denotes that A is a build-time input of B, i.e., the output of B can have a reference to</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">the output of A.) Suppose that Alice has built</span><span class="cls_007"> gtk</span><span class="cls_004"> and</span><span class="cls_007"> pkgconfig</span><span class="cls_004"> locally. These both depend</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">on</span><span class="cls_007"> glibc</span><span class="cls_004">. She has also registered Bob’s remotely built</span><span class="cls_007"> libIDL</span><span class="cls_004"> as a substitute. It also depends</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">on</span><span class="cls_007"> glibc</span><span class="cls_004">. However, though Bob’s</span><span class="cls_007"> glibc</span><span class="cls_004"> was built from the same derivation, due to impurities</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">the build result is different. Thus, the equivalence class for the Glibc derivation has at least</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">two members. This is not a problem in itself. However, suppose that Alice next tries to</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">build</span><span class="cls_007"> firefox</span><span class="cls_004">, which depends on</span><span class="cls_007"> gtk</span><span class="cls_004">,</span><span class="cls_007"> pkgconfig</span><span class="cls_004">, and</span><span class="cls_007"> libIDL</span><span class="cls_004">. We then end up with a Firefox</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">147</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:105570px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background156.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:278.09px;top:42.72px" class="cls_042"><span class="cls_042">Equivalence class</span><span class="cls_043"> glibc</span></div>
<div style="position:absolute;left:101.66px;top:48.10px" class="cls_042"><span class="cls_042">Equivalence class</span><span class="cls_043"> glibc</span></div>
<div style="position:absolute;left:117.91px;top:67.05px" class="cls_043"><span class="cls_043">glibc</span></div>
<div style="position:absolute;left:134.27px;top:73.56px" class="cls_044"><span class="cls_044">A</span></div>
<div style="position:absolute;left:165.59px;top:67.05px" class="cls_043"><span class="cls_043">glibc</span></div>
<div style="position:absolute;left:182.00px;top:73.56px" class="cls_044"><span class="cls_044">B</span></div>
<div style="position:absolute;left:280.31px;top:72.51px" class="cls_043"><span class="cls_043">glibc</span></div>
<div style="position:absolute;left:296.72px;top:79.02px" class="cls_044"><span class="cls_044">A</span></div>
<div style="position:absolute;left:348.84px;top:72.51px" class="cls_043"><span class="cls_043">glibc</span></div>
<div style="position:absolute;left:365.24px;top:79.02px" class="cls_044"><span class="cls_044">B</span></div>
<div style="position:absolute;left:72.82px;top:99.56px" class="cls_043"><span class="cls_043">pkgconfig</span></div>
<div style="position:absolute;left:106.20px;top:106.07px" class="cls_044"><span class="cls_044">A</span></div>
<div style="position:absolute;left:129.47px;top:99.56px" class="cls_043"><span class="cls_043">gtk</span></div>
<div style="position:absolute;left:140.72px;top:106.07px" class="cls_044"><span class="cls_044">A</span></div>
<div style="position:absolute;left:163.27px;top:99.56px" class="cls_043"><span class="cls_043">libIDL</span><span class="cls_044">B</span></div>
<div style="position:absolute;left:217.00px;top:105.02px" class="cls_043"><span class="cls_043">gtk</span></div>
<div style="position:absolute;left:228.25px;top:111.53px" class="cls_044"><span class="cls_044">A</span></div>
<div style="position:absolute;left:251.52px;top:105.02px" class="cls_043"><span class="cls_043">pkgconfig</span></div>
<div style="position:absolute;left:284.90px;top:111.53px" class="cls_044"><span class="cls_044">A</span></div>
<div style="position:absolute;left:307.04px;top:105.02px" class="cls_043"><span class="cls_043">libIDL</span><span class="cls_044">B</span><span class="cls_045"><sup>′</sup></span></div>
<div style="position:absolute;left:367.26px;top:105.02px" class="cls_043"><span class="cls_043">libIDL</span></div>
<div style="position:absolute;left:388.31px;top:110.55px" class="cls_044"><span class="cls_044">B</span></div>
<div style="position:absolute;left:126.12px;top:132.07px" class="cls_043"><span class="cls_043">firefox</span></div>
<div style="position:absolute;left:259.26px;top:137.53px" class="cls_043"><span class="cls_043">firefox</span></div>
<div style="position:absolute;left:66.33px;top:166.30px" class="cls_004"><span class="cls_004">Figure 6.1.: Equivalence class</span></div>
<div style="position:absolute;left:198.80px;top:171.68px" class="cls_004"><span class="cls_004">Figure 6.2.: Resolution of the equivalence class</span></div>
<div style="position:absolute;left:115.04px;top:178.26px" class="cls_004"><span class="cls_004">collision</span></div>
<div style="position:absolute;left:247.51px;top:183.63px" class="cls_004"><span class="cls_004">collision</span></div>
<div style="position:absolute;left:59.72px;top:212.85px" class="cls_004"><span class="cls_004">binary that links against two</span><span class="cls_007"> glibc</span><span class="cls_004">s. This might work, or it might not—depending on the</span></div>
<div style="position:absolute;left:59.72px;top:224.80px" class="cls_004"><span class="cls_004">exact semantics of dynamic linking. In any case, it is an observable effect—it influences</span></div>
<div style="position:absolute;left:59.72px;top:236.76px" class="cls_004"><span class="cls_004">whether a build succeeds and whether the build result works properly.</span></div>
<div style="position:absolute;left:69.68px;top:248.71px" class="cls_004"><span class="cls_004">Thus, we need to prevent that any closure ever contains more than one path from an</span></div>
<div style="position:absolute;left:59.72px;top:260.67px" class="cls_004"><span class="cls_004">equivalence class. This is expressed by the following invariant.</span></div>
<div style="position:absolute;left:59.72px;top:279.82px" class="cls_004"><span class="cls_004">Invariant 8 (Equivalence class unicity invariant). No two paths in a closure can be in the</span></div>
<div style="position:absolute;left:59.72px;top:291.77px" class="cls_004"><span class="cls_004">same equivalence class.</span></div>
<div style="position:absolute;left:84.62px;top:312.72px" class="cls_004"><span class="cls_004">∀p ∈ </span><span class="cls_007">Path </span><span class="cls_004">: </span><span class="cls_007">valid</span><span class="cls_004">[p] = ε →</span></div>
<div style="position:absolute;left:94.59px;top:327.67px" class="cls_004"><span class="cls_004">∀e ∈</span><span class="cls_007"> EqClass</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:104.55px;top:341.09px" class="cls_004"><span class="cls_004">∀(p</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">, e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">) ∈</span><span class="cls_007"> closure</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(p, e) : ∀(p</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">, e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">) ∈</span><span class="cls_007"> closure</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(p, e) :</span></div>
<div style="position:absolute;left:114.51px;top:357.56px" class="cls_004"><span class="cls_004">(e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> = ε ∧ e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> = e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">) → p</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> = p</span><span class="cls_012"><sub>2</sub></span></div>
<div style="position:absolute;left:59.72px;top:378.51px" class="cls_004"><span class="cls_004">That is, for any two elements (p</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">, e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">) and (p</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">, e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">) in any closure of a valid path p, if the</span></div>
<div style="position:absolute;left:59.72px;top:390.46px" class="cls_004"><span class="cls_004">equivalence classes are the same (e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> = e</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">), then the paths must also be the same (p</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> = p</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">).</span></div>
<div style="position:absolute;left:59.72px;top:402.42px" class="cls_004"><span class="cls_004">The condition e</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> = ε is to handle paths that are not in any equivalence class (such as</span></div>
<div style="position:absolute;left:59.72px;top:414.37px" class="cls_004"><span class="cls_004">sources).</span></div>
<div style="position:absolute;left:69.68px;top:433.52px" class="cls_004"><span class="cls_004">So when we build a derivation, we have to select from the paths in the union of input</span></div>
<div style="position:absolute;left:59.72px;top:445.48px" class="cls_004"><span class="cls_004">closures a single element from each equivalence class. However, we must still maintain</span></div>
<div style="position:absolute;left:59.72px;top:457.43px" class="cls_004"><span class="cls_004">the closure invariant (page 96). For instance, in Figure 6.1, we cannot simply select the</span></div>
<div style="position:absolute;left:59.72px;top:469.39px" class="cls_004"><span class="cls_004">set {</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> gtk</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> pkgconfig</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">}, since</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004"> depends on</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004"> which is not in this</span></div>
<div style="position:absolute;left:59.72px;top:481.34px" class="cls_004"><span class="cls_004">set.</span></div>
<div style="position:absolute;left:77.81px;top:481.34px" class="cls_004"><span class="cls_004">(In this running example, for clarity I do not use store paths but symbolic constants,</span></div>
<div style="position:absolute;left:59.72px;top:493.30px" class="cls_004"><span class="cls_004">e.g.,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">  for an output and</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">  for its equivalence class.  The subscripts have no</span></div>
<div style="position:absolute;left:59.72px;top:505.26px" class="cls_004"><span class="cls_004">significance; they just denote different store paths.)</span></div>
<div style="position:absolute;left:69.68px;top:517.21px" class="cls_004"><span class="cls_004">Once again, hash rewriting comes to the rescue. We can rewrite</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004"> so that it refers</span></div>
<div style="position:absolute;left:59.72px;top:528.14px" class="cls_004"><span class="cls_004">to</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004"> instead of</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">. That is, we compute a new path</span><span class="cls_007"> libIDL</span><span class="cls_012"><sup>′B</sup></span><span class="cls_004"> with contents</span></div>
<div style="position:absolute;left:84.62px;top:550.12px" class="cls_007"><span class="cls_007">replace</span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(</span><span class="cls_007">libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">)), {</span><span class="cls_007">hashPart</span><span class="cls_004">(</span><span class="cls_007">glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">) ⇝</span><span class="cls_007"> hashPart</span><span class="cls_004">(</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">)})</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">(Of course, self-references in</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004"> must also be rewritten as described in Section 6.3.2.)</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">This is shown in Figure 6.2. The dotted edge denotes a copy-with-rewriting action.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">148</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:106260px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background157.jpg" width=481 height=680></div>
<div style="position:absolute;left:361.29px;top:17.14px" class="cls_004"><span class="cls_004">6.4. Semantics</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_009"><span class="cls_009">Path selection</span><span class="cls_004">   An interesting problem is which paths to select from each equivalence</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">class such that the number of rewrites is minimised. For instance, if we select</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">, then</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">we have to rewrite one path (namely</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">), while if we select</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">, we have to rewrite</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">two paths (</span><span class="cls_007">gtk</span><span class="cls_012"><sub>A</sub></span><span class="cls_004"> and</span><span class="cls_007"> pkgconfig</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">). I do not currently know whether there exists an efficient</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">algorithm to find an optimal solution.  A heuristic that works fine in practice is to do a</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">bottom-up traversal of the equivalence class dependency graph, picking from each class</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">the path that induces the least number of rewrites.</span></div>
<div style="position:absolute;left:73.84px;top:128.73px" class="cls_004"><span class="cls_004">However, picking an optimal solution with respect to the current derivation is not par-</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">ticularly useful in any case, since it ignores both the state of the Nix store as a whole, and</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">future derivations. In our example Alice might in the future install many additional com-</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">ponents from Bob’s remote repository (e.g., because Bob is a primary distribution site).</span></div>
<div style="position:absolute;left:63.87px;top:176.55px" class="cls_004"><span class="cls_004">Thus, globally there are many more paths referring to</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004"> than to</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">. In this case it</span></div>
<div style="position:absolute;left:63.87px;top:188.50px" class="cls_004"><span class="cls_004">is better to select</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004"> and rewrite Alice’s locally built components. Possible heuristics</span></div>
<div style="position:absolute;left:63.87px;top:200.46px" class="cls_004"><span class="cls_004">include:</span></div>
<div style="position:absolute;left:78.82px;top:219.55px" class="cls_004"><span class="cls_004">• Select the path that has the largest referrer closure in the Nix store. Recall from Sec-</span></div>
<div style="position:absolute;left:88.78px;top:231.50px" class="cls_004"><span class="cls_004">tion 5.2.3 that the referrer relation is the transpose of the references relation. Thus,</span></div>
<div style="position:absolute;left:88.78px;top:243.46px" class="cls_004"><span class="cls_004">the referrer closure of p is the set of all paths that directly or indirectly reference p.</span></div>
<div style="position:absolute;left:78.82px;top:262.96px" class="cls_004"><span class="cls_004">• Select the path that is also trusted by the system administrator (e.g., a special user</span></div>
<div style="position:absolute;left:88.78px;top:274.92px" class="cls_004"><span class="cls_004">named</span><span class="cls_007"> root</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:78.82px;top:294.43px" class="cls_004"><span class="cls_004">• Select the path that was obtained from a substitute referring to a distribution site with</span></div>
<div style="position:absolute;left:88.78px;top:306.38px" class="cls_004"><span class="cls_004">some special status.</span></div>
<div style="position:absolute;left:63.87px;top:332.72px" class="cls_009"><span class="cls_009">Example</span><span class="cls_004">   In the description of the resolution algorithm below, we will use the example</span></div>
<div style="position:absolute;left:63.87px;top:344.67px" class="cls_004"><span class="cls_004">from Figure 6.1.  Thus, we have the following paths in the combined input closures of</span></div>
<div style="position:absolute;left:63.87px;top:356.63px" class="cls_004"><span class="cls_004">Firefox, paired with the equivalence classes to which they belong:</span></div>
<div style="position:absolute;left:88.78px;top:377.50px" class="cls_004"><span class="cls_004">{ (</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">), (</span><span class="cls_007">glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">), (</span><span class="cls_007">gtk</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> gtk</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:88.78px;top:393.76px" class="cls_004"><span class="cls_004">, (</span><span class="cls_007">pkgconfig</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> pkgconfig</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">), (</span><span class="cls_007">libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">,</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">) }</span></div>
<div style="position:absolute;left:63.87px;top:414.63px" class="cls_004"><span class="cls_004">Note that</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004"> and</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004"> share the same equivalence class</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">, thus</span></div>
<div style="position:absolute;left:88.78px;top:436.82px" class="cls_007"><span class="cls_007">eqClassMembers</span><span class="cls_004">[</span><span class="cls_007">glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] = {(</span><span class="cls_007">"alice"</span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">), (</span><span class="cls_007">"alice"</span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">)}.</span></div>
<div style="position:absolute;left:63.87px;top:457.69px" class="cls_004"><span class="cls_004">We have the following references:</span></div>
<div style="position:absolute;left:115.20px;top:478.56px" class="cls_007"><span class="cls_007">references</span><span class="cls_004">[</span><span class="cls_007">gtk</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">] = {</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">}</span></div>
<div style="position:absolute;left:88.78px;top:493.51px" class="cls_007"><span class="cls_007">references</span><span class="cls_004">[</span><span class="cls_007">pkgconfig</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">] = {</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">}</span></div>
<div style="position:absolute;left:104.24px;top:508.45px" class="cls_007"><span class="cls_007">references</span><span class="cls_004">[</span><span class="cls_007">libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">] = {</span><span class="cls_007">glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">}</span></div>
<div style="position:absolute;left:63.87px;top:529.32px" class="cls_004"><span class="cls_004">Also, the</span><span class="cls_007"> refClasses</span><span class="cls_004"> table tells us what equivalence classes correspond to those references,</span></div>
<div style="position:absolute;left:63.87px;top:541.28px" class="cls_004"><span class="cls_004">e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:562.15px" class="cls_007"><span class="cls_007">refClasses</span><span class="cls_004">[(</span><span class="cls_007">gtk</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">)] = {(</span><span class="cls_007">gtk</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">)}</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">and so on.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">149</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:106950px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background158.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:68.09px;top:46.83px" class="cls_007"><span class="cls_007">resolve</span><span class="cls_004">(paths) :</span></div>
<div style="position:absolute;left:83.03px;top:58.79px" class="cls_004"><span class="cls_004">// Find the conflicts.</span></div>
<div style="position:absolute;left:83.03px;top:70.74px" class="cls_004"><span class="cls_004">sources ← 0</span></div>
<div style="position:absolute;left:83.03px;top:82.70px" class="cls_004"><span class="cls_004">for each (p, e) ∈ paths :</span></div>
<div style="position:absolute;left:167.82px;top:96.95px" class="cls_004"><span class="cls_004">← {p}</span><span class="cls_014"> </span><span class="cls_056">108</span></div>
<div style="position:absolute;left:168.55px;top:108.16px" class="cls_012"><span class="cls_012">∪</span></div>
<div style="position:absolute;left:97.97px;top:111.21px" class="cls_004"><span class="cls_004">else : conflicts[e]</span></div>
<div style="position:absolute;left:166.02px;top:111.21px" class="cls_004"><span class="cls_004">← {p}</span><span class="cls_014"> </span><span class="cls_056">109</span></div>
<div style="position:absolute;left:83.03px;top:135.12px" class="cls_004"><span class="cls_004">// Select one path for each equivalence class.</span></div>
<div style="position:absolute;left:83.03px;top:147.07px" class="cls_004"><span class="cls_004">selected ←</span><span class="cls_007"> selectPaths</span><span class="cls_004">(conflicts)</span><span class="cls_014"> </span><span class="cls_056">110</span></div>
<div style="position:absolute;left:83.03px;top:169.66px" class="cls_004"><span class="cls_004">paths</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ← 0</span></div>
<div style="position:absolute;left:83.03px;top:182.94px" class="cls_004"><span class="cls_004">for each (p, e) ∈ selected :</span></div>
<div style="position:absolute;left:195.56px;top:184.93px" class="cls_056"><span class="cls_056">111</span></div>
<div style="position:absolute;left:126.83px;top:194.14px" class="cls_012"><span class="cls_012">∪</span></div>
<div style="position:absolute;left:97.97px;top:195.87px" class="cls_004"><span class="cls_004">paths</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:124.30px;top:197.19px" class="cls_004"><span class="cls_004">← {</span><span class="cls_007">maybeRewrite</span><span class="cls_004">(p, e, selected)}</span></div>
<div style="position:absolute;left:83.03px;top:207.83px" class="cls_004"><span class="cls_004">return paths</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ∪ {(p, ε) | p ∈ sources}</span><span class="cls_014"> </span><span class="cls_056">112</span></div>
<div style="position:absolute;left:137.19px;top:233.83px" class="cls_004"><span class="cls_004">Figure 6.3.:</span><span class="cls_007"> resolve</span><span class="cls_004">: Collision resolution algorithm</span></div>
<div style="position:absolute;left:59.72px;top:265.35px" class="cls_009"><span class="cls_009">The resolution algorithm</span><span class="cls_004">   Figure 6.3 shows the resolution algorithm. The function</span><span class="cls_007"> re-</span></div>
<div style="position:absolute;left:59.72px;top:277.31px" class="cls_007"><span class="cls_007">solve</span><span class="cls_004"> accepts a set paths : {(</span><span class="cls_007">Path</span><span class="cls_004">,</span><span class="cls_007"> EqClass</span><span class="cls_004">)} of pairs (p, e) denoting a path p in equivalence</span></div>
<div style="position:absolute;left:59.72px;top:288.23px" class="cls_004"><span class="cls_004">class e</span><span class="cls_012"><sup>3</sup></span><span class="cls_004">. The elements in paths must be closed under the references relation but may vio-</span></div>
<div style="position:absolute;left:59.72px;top:301.22px" class="cls_004"><span class="cls_004">late the equivalence class unicity invariant; the idea is that paths is the union of a number</span></div>
<div style="position:absolute;left:59.72px;top:312.14px" class="cls_004"><span class="cls_004">of calls to</span><span class="cls_007"> closure</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, defined above. The function</span><span class="cls_007"> resolve</span><span class="cls_004"> yields a closed set of paths that</span></div>
<div style="position:absolute;left:59.72px;top:325.13px" class="cls_004"><span class="cls_004">does obey the invariant.</span></div>
<div style="position:absolute;left:69.68px;top:337.08px" class="cls_004"><span class="cls_004">The resolution algorithm works as follows. First, the set of conflicts is determined</span><span class="cls_014"> </span><span class="cls_056">109</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:59.72px;top:349.04px" class="cls_004"><span class="cls_004">The mapping conflicts :</span><span class="cls_007"> EqClass</span><span class="cls_004"> → {</span><span class="cls_007">Path</span><span class="cls_004">} maps the equivalence classes in paths to the</span></div>
<div style="position:absolute;left:59.72px;top:360.99px" class="cls_004"><span class="cls_004">corresponding paths in paths. Note that if any equivalence class in conflicts has more than</span></div>
<div style="position:absolute;left:59.72px;top:372.95px" class="cls_004"><span class="cls_004">one member in paths, there is a conflict. For our example, the conflicts set is as follows:</span></div>
<div style="position:absolute;left:104.56px;top:394.20px" class="cls_004"><span class="cls_004">conflicts[</span><span class="cls_007">glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] = {</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">}</span></div>
<div style="position:absolute;left:281.42px;top:394.20px" class="cls_004"><span class="cls_004">conflicts[</span><span class="cls_007">gtk</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] = {</span><span class="cls_007">gtk</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">}</span></div>
<div style="position:absolute;left:84.62px;top:410.46px" class="cls_004"><span class="cls_004">conflicts[</span><span class="cls_007">pkgconfig</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] = {</span><span class="cls_007">pkgconfig</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">}</span></div>
<div style="position:absolute;left:270.46px;top:410.46px" class="cls_004"><span class="cls_004">conflicts[</span><span class="cls_007">libIDL</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] = {</span><span class="cls_007">libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">}</span></div>
<div style="position:absolute;left:59.72px;top:431.72px" class="cls_004"><span class="cls_004">Thus, there is a conflict in the</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004"> equivalence class.</span></div>
<div style="position:absolute;left:295.60px;top:431.72px" class="cls_004"><span class="cls_004">(Some paths are in the “fake”</span></div>
<div style="position:absolute;left:59.72px;top:442.65px" class="cls_004"><span class="cls_004">equivalence class ε</span><span class="cls_014"> </span><span class="cls_056">108</span><span class="cls_059"> </span><span class="cls_004">, returned by</span><span class="cls_007"> closure</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> to indicate paths that are not in an equivalence</span></div>
<div style="position:absolute;left:59.72px;top:455.63px" class="cls_004"><span class="cls_004">class, such as sources. These are not subject to rewriting, but they are added to the result</span></div>
<div style="position:absolute;left:59.72px;top:467.58px" class="cls_004"><span class="cls_004">returned by</span><span class="cls_007"> resolve</span><span class="cls_004"> to ensure the closure property.)</span></div>
<div style="position:absolute;left:69.68px;top:479.54px" class="cls_004"><span class="cls_004">Second, the function</span><span class="cls_007"> selectPaths</span><span class="cls_004"> returns a mapping selected from equivalence classes</span></div>
<div style="position:absolute;left:59.72px;top:491.49px" class="cls_004"><span class="cls_004">to paths, i.e.,</span><span class="cls_007"> EqClass</span><span class="cls_004"> →</span><span class="cls_007"> Path</span><span class="cls_004">. That is, it chooses an element from the members of each</span></div>
<div style="position:absolute;left:59.72px;top:503.45px" class="cls_004"><span class="cls_004">equivalence class in conflicts</span><span class="cls_014"> </span><span class="cls_056">110</span><span class="cls_059"> </span><span class="cls_004">. By definition, this defines a set that is free of equivalence</span></div>
<div style="position:absolute;left:59.72px;top:515.40px" class="cls_004"><span class="cls_004">class collisions. We do not specify here how</span><span class="cls_007"> selectPaths</span><span class="cls_004"> chooses an element from each</span></div>
<div style="position:absolute;left:59.72px;top:527.36px" class="cls_004"><span class="cls_004">class. As discussed above, it must implement some policy of selecting a path from each</span></div>
<div style="position:absolute;left:64.20px;top:546.26px" class="cls_013"><span class="cls_013"><sup>3</sup></span><span class="cls_014">Again, it is necessary to specify the intended equivalence class because a path may be in multiple equivalence</span></div>
<div style="position:absolute;left:71.67px;top:556.62px" class="cls_014"><span class="cls_014">classes. In a previous implementation, a table</span><span class="cls_016"> eqClasses</span><span class="cls_014"> :</span><span class="cls_016"> Path</span><span class="cls_014"> → {EqClass} was used to map paths to the</span></div>
<div style="position:absolute;left:71.67px;top:566.09px" class="cls_014"><span class="cls_014">equivalence classes to which they belong. This led to a subtly flawed semantics: since we didn’t know which</span></div>
<div style="position:absolute;left:71.67px;top:575.55px" class="cls_014"><span class="cls_014">particular equivalence class for a path p was intended, we had to use all of them. The result was that a path</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">could be replaced with a path in an entirely different equivalence class.</span></div>
<div style="position:absolute;left:59.72px;top:624.86px" class="cls_004"><span class="cls_004">150</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:107640px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background159.jpg" width=481 height=680></div>
<div style="position:absolute;left:361.29px;top:17.14px" class="cls_004"><span class="cls_004">6.4.</span></div>
<div style="position:absolute;left:381.22px;top:17.14px" class="cls_004"><span class="cls_004">Semantics</span></div>
<div style="position:absolute;left:72.24px;top:46.83px" class="cls_007"><span class="cls_007">maybeRewrite</span><span class="cls_004">(p, e, selected) :</span></div>
<div style="position:absolute;left:87.19px;top:58.79px" class="cls_004"><span class="cls_004">newRefs ← /0</span></div>
<div style="position:absolute;left:87.19px;top:70.74px" class="cls_004"><span class="cls_004">eqRefs ← /0</span></div>
<div style="position:absolute;left:87.19px;top:82.70px" class="cls_004"><span class="cls_004">rewrites ← 0</span></div>
<div style="position:absolute;left:87.19px;top:106.61px" class="cls_004"><span class="cls_004">for each p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004"> ∈</span><span class="cls_007"> references</span><span class="cls_004">[p] :</span></div>
<div style="position:absolute;left:213.36px;top:108.60px" class="cls_056"><span class="cls_056">113</span></div>
<div style="position:absolute;left:102.13px;top:118.56px" class="cls_004"><span class="cls_004">if p = p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004"> ∨ ¬(∃e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004"> : (e, e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">) ∈</span><span class="cls_007"> refClasses</span><span class="cls_004">[(p, p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">)]) :</span></div>
<div style="position:absolute;left:326.48px;top:120.56px" class="cls_056"><span class="cls_056">114</span></div>
<div style="position:absolute;left:152.34px;top:132.82px" class="cls_004"><span class="cls_004">← {p}</span></div>
<div style="position:absolute;left:102.13px;top:144.77px" class="cls_004"><span class="cls_004">else :</span></div>
<div style="position:absolute;left:117.07px;top:156.73px" class="cls_004"><span class="cls_004">Set e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004"> such that (e, e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">) ∈</span><span class="cls_007"> refClasses</span><span class="cls_004">[(p, p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">)]</span></div>
<div style="position:absolute;left:117.82px;top:168.68px" class="cls_004"><span class="cls_004">p</span><span class="cls_012"><sub>repl</sub></span><span class="cls_004"> ← selected[e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">]</span><span class="cls_014"> </span><span class="cls_056">115</span></div>
<div style="position:absolute;left:117.07px;top:179.61px" class="cls_004"><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:262.17px;top:180.64px" class="cls_004"><span class="cls_004">e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">, selected)</span><span class="cls_014"> </span><span class="cls_056">116</span></div>
<div style="position:absolute;left:126.67px;top:179.61px" class="cls_012"><span class="cls_012">repl</span><span class="cls_004">,e</span><span class="cls_012">repl</span><span class="cls_004">)←</span><span class="cls_007">maybeRewrite</span><span class="cls_004">(p</span><span class="cls_012">repl</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:117.07px;top:192.46px" class="cls_004"><span class="cls_004">// Note that e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004"> = e</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:193.84px;top:199.06px" class="cls_012"><span class="cls_012">repl</span></div>
<div style="position:absolute;left:152.34px;top:207.62px" class="cls_004"><span class="cls_004">←{p</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:175.23px;top:208.64px" class="cls_012"><span class="cls_012">repl</span><span class="cls_004">}</span></div>
<div style="position:absolute;left:145.85px;top:223.79px" class="cls_004"><span class="cls_004">← {(p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">, e, e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">)}</span></div>
<div style="position:absolute;left:151.43px;top:237.02px" class="cls_004"><span class="cls_004">← {</span><span class="cls_007">hashPart</span><span class="cls_004">(p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">) ⇝</span><span class="cls_007"> hashPart</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:286.21px;top:238.05px" class="cls_012"><span class="cls_012">repl</span><span class="cls_004">)}</span><span class="cls_057">117</span></div>
<div style="position:absolute;left:87.19px;top:262.85px" class="cls_004"><span class="cls_004">if newRefs =</span><span class="cls_007"> references</span><span class="cls_004">[p] : return (p, e)</span><span class="cls_014"> </span><span class="cls_056">118</span></div>
<div style="position:absolute;left:87.19px;top:286.76px" class="cls_004"><span class="cls_004">in a database transaction :</span></div>
<div style="position:absolute;left:102.88px;top:297.56px" class="cls_004"><span class="cls_004">p</span><span class="cls_012"><sub>new</sub></span><span class="cls_004"> ←</span><span class="cls_007"> addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p),</span></div>
<div style="position:absolute;left:112.09px;top:310.67px" class="cls_007"><span class="cls_007">references</span><span class="cls_004">[p], eqRefs,</span><span class="cls_007"> namePart</span><span class="cls_004">(p), rewrites,</span><span class="cls_007"> hashPart</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:357.59px;top:312.67px" class="cls_056"><span class="cls_056">119</span></div>
<div style="position:absolute;left:184.04px;top:324.93px" class="cls_004"><span class="cls_004">← {(</span><span class="cls_007">curUser</span><span class="cls_004">, p</span><span class="cls_012"><sub>new</sub></span><span class="cls_004">)}</span></div>
<div style="position:absolute;left:87.19px;top:336.88px" class="cls_004"><span class="cls_004">return (p</span><span class="cls_012"><sub>new</sub></span><span class="cls_004">, e)</span></div>
<div style="position:absolute;left:110.15px;top:361.57px" class="cls_004"><span class="cls_004">Figure 6.4.:</span><span class="cls_007"> maybeRewrite</span><span class="cls_004">: Collision resolution algorithm (cont’d)</span></div>
<div style="position:absolute;left:63.87px;top:393.20px" class="cls_004"><span class="cls_004">equivalence class. For our example, there are only two possibilities, namely</span></div>
<div style="position:absolute;left:108.72px;top:414.59px" class="cls_004"><span class="cls_004">selected[</span><span class="cls_007">glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] =</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>A</sub></span></div>
<div style="position:absolute;left:281.89px;top:414.59px" class="cls_004"><span class="cls_004">selected[</span><span class="cls_007">gtk</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] =</span><span class="cls_007"> gtk</span><span class="cls_012"><sub>A</sub></span></div>
<div style="position:absolute;left:88.78px;top:430.85px" class="cls_004"><span class="cls_004">selected[</span><span class="cls_007">pkgconfig</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] =</span><span class="cls_007"> pkgconfig</span><span class="cls_012"><sub>A</sub></span></div>
<div style="position:absolute;left:270.93px;top:430.85px" class="cls_004"><span class="cls_004">selected[</span><span class="cls_007">libIDL</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] =</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>B</sub></span></div>
<div style="position:absolute;left:63.87px;top:452.24px" class="cls_004"><span class="cls_004">and</span></div>
<div style="position:absolute;left:108.72px;top:473.64px" class="cls_004"><span class="cls_004">selected[</span><span class="cls_007">glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] =</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span></div>
<div style="position:absolute;left:281.89px;top:473.64px" class="cls_004"><span class="cls_004">selected[</span><span class="cls_007">gtk</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] =</span><span class="cls_007"> gtk</span><span class="cls_012"><sub>A</sub></span></div>
<div style="position:absolute;left:88.78px;top:489.90px" class="cls_004"><span class="cls_004">selected[</span><span class="cls_007">pkgconfig</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] =</span><span class="cls_007"> pkgconfig</span><span class="cls_012"><sub>A</sub></span></div>
<div style="position:absolute;left:270.93px;top:489.90px" class="cls_004"><span class="cls_004">selected[</span><span class="cls_007">libIDL</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">] =</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>B</sub></span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">Note that the paths of neither set are closed under the</span><span class="cls_007"> references</span><span class="cls_004"> relation. Thus, they are</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">not a valid set of paths that can be used as an input to a build. Indeed, the builder might</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">traverse each path to arrive at its references; if we pick the first set,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004"> might still be</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">reached by following</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:559.11px" class="cls_004"><span class="cls_004">Therefore, the paths in selected must be rewritten to a new set of paths that is closed</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">under the</span><span class="cls_007"> references</span><span class="cls_004"> relation, and still obeys the equivalence class unicity invariant. This</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">is done by the helper function</span><span class="cls_007"> maybeRewrite</span><span class="cls_004"> shown in Figure 6.4, which</span><span class="cls_007"> resolve</span><span class="cls_004"> calls for</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">151</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:108330px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background160.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">each selected path</span><span class="cls_014"> </span><span class="cls_056">111</span><span class="cls_059"> </span><span class="cls_004">.</span><span class="cls_007"> maybeRewrite</span><span class="cls_004"> takes a path p in equivalence class e, and returns a</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">new store path p</span><span class="cls_012"><sub>new</sub></span><span class="cls_004"> in the same equivalence class e.</span></div>
<div style="position:absolute;left:69.68px;top:69.23px" class="cls_004"><span class="cls_004">The basic idea is that the path p</span><span class="cls_012"><sub>new</sub></span><span class="cls_004"> is a copy of p produced by rewriting all references</span></div>
<div style="position:absolute;left:59.72px;top:81.18px" class="cls_004"><span class="cls_004">of p that are not in selected, to equivalent paths that are in selected. Thus, we walk over</span></div>
<div style="position:absolute;left:59.72px;top:93.14px" class="cls_004"><span class="cls_004">all references</span><span class="cls_014"> </span><span class="cls_056">113</span><span class="cls_059"> </span><span class="cls_004">, and for each reference p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004"> in equivalence class e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004"> that is not trivial</span></div>
<div style="position:absolute;left:59.72px;top:105.09px" class="cls_004"><span class="cls_004">(i.e., a self-reference to p) or a source (there is no e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">)</span><span class="cls_014"> </span><span class="cls_056">114</span><span class="cls_059"> </span><span class="cls_004">, the equivalent path p</span><span class="cls_012"><sub>repl</sub></span><span class="cls_004"> =</span></div>
<div style="position:absolute;left:59.72px;top:117.05px" class="cls_004"><span class="cls_004">selected[e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">] is chosen</span><span class="cls_014"> </span><span class="cls_056">115</span><span class="cls_059"> </span><span class="cls_004">. That is, the reference is replaced with the path that was selected</span></div>
<div style="position:absolute;left:59.72px;top:129.00px" class="cls_004"><span class="cls_004">for its equivalence class. All these p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">s together form the set of new references newRefs.</span></div>
<div style="position:absolute;left:59.72px;top:140.96px" class="cls_004"><span class="cls_004">If the new set of references is not equal to the old</span><span class="cls_014"> </span><span class="cls_056">118</span><span class="cls_059"> </span><span class="cls_004">, a set of rewrites is applied to the</span></div>
<div style="position:absolute;left:59.72px;top:152.91px" class="cls_004"><span class="cls_004">contents of p that replaces the hash part of each p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004"> with the hash part of the corresponding</span></div>
<div style="position:absolute;left:60.46px;top:163.71px" class="cls_004"><span class="cls_004">p</span><span class="cls_012"><sub>repl</sub></span><span class="cls_014"> </span><span class="cls_056">117</span><span class="cls_059"> </span><span class="cls_004">. This rewriting is done by the function</span><span class="cls_007"> addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> (explained below), and yields</span></div>
<div style="position:absolute;left:59.72px;top:176.82px" class="cls_004"><span class="cls_004">a new store path p</span><span class="cls_012"><sub>new</sub></span><span class="cls_014"> </span><span class="cls_056"> 119</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:189.05px" class="cls_004"><span class="cls_004">There is a final complication, though; the selected replacement reference p</span><span class="cls_012"><sub>repl</sub></span><span class="cls_004"> may itself</span></div>
<div style="position:absolute;left:59.72px;top:201.01px" class="cls_004"><span class="cls_004">not be closed with respect to selected, and therefore in need of rewriting. Thus, p</span><span class="cls_012"><sub>repl</sub></span><span class="cls_004"> itself</span></div>
<div style="position:absolute;left:59.72px;top:211.94px" class="cls_004"><span class="cls_004">is rewritten using</span><span class="cls_007"> maybeRewrite</span><span class="cls_014"> </span><span class="cls_056">116</span><span class="cls_059"> </span><span class="cls_004">, and it is the resulting path p</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:323.83px;top:212.96px" class="cls_012"><span class="cls_012">repl</span><span class="cls_004"> thatisactuallyused</span></div>
<div style="position:absolute;left:59.72px;top:224.92px" class="cls_004"><span class="cls_004">in the new set of references and for the hash rewrites.</span></div>
<div style="position:absolute;left:69.68px;top:237.15px" class="cls_004"><span class="cls_004">The pseudo-code of</span><span class="cls_007"> maybeRewrite</span><span class="cls_004"> shown in Figure 6.4 will typically perform many</span></div>
<div style="position:absolute;left:59.72px;top:247.95px" class="cls_004"><span class="cls_004">redundant recursive calls. This is safe, since the implementation of</span><span class="cls_007"> addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> is idem-</span></div>
<div style="position:absolute;left:59.72px;top:261.06px" class="cls_004"><span class="cls_004">potent. In the actual implementation, simple memoisation is used to remember for each</span></div>
<div style="position:absolute;left:59.72px;top:273.01px" class="cls_004"><span class="cls_004">path p in equivalence class e the corresponding rewritten path p</span><span class="cls_012"><sub>new</sub></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:285.25px" class="cls_004"><span class="cls_004">In essence,</span><span class="cls_007"> maybeRewrite</span><span class="cls_004"> performs a bottom-up rewrite on the graph of selected paths.</span></div>
<div style="position:absolute;left:59.72px;top:297.20px" class="cls_004"><span class="cls_004">Let us illustrate this using our example. Suppose that we have selected the set {(</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span></div>
<div style="position:absolute;left:59.72px;top:309.16px" class="cls_007"><span class="cls_007">glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">), (</span><span class="cls_007">gtk</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> gtk</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">), (</span><span class="cls_007">pkgconfig</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> pkgconfig</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">), (</span><span class="cls_007">libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">,</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">)}.  We first call</span><span class="cls_007"> may-</span></div>
<div style="position:absolute;left:59.72px;top:321.11px" class="cls_007"><span class="cls_007">beRewrite</span><span class="cls_004"> on (</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">). This path has no references, so (</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">) is returned.</span></div>
<div style="position:absolute;left:69.68px;top:333.34px" class="cls_004"><span class="cls_004">Next, we call</span><span class="cls_007"> maybeRewrite</span><span class="cls_004"> on (</span><span class="cls_007">gtk</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> gtk</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">). This path does have a reference, namely,</span></div>
<div style="position:absolute;left:59.72px;top:345.30px" class="cls_007"><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004"> in the equivalence class</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">. We replace this reference with the path in selected</span></div>
<div style="position:absolute;left:59.72px;top:357.25px" class="cls_004"><span class="cls_004">in equivalence class</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">, which happens to be</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004"> itself. Recursively applying</span><span class="cls_007"> may-</span></div>
<div style="position:absolute;left:59.72px;top:369.21px" class="cls_007"><span class="cls_007">beRewrite</span><span class="cls_004"> to (</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">) yields (</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">). Thus, nothing changes in the refer-</span></div>
<div style="position:absolute;left:59.72px;top:381.16px" class="cls_004"><span class="cls_004">ences, and (</span><span class="cls_007">gtk</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> gtk</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">) is returned. The same happens with (</span><span class="cls_007">pkgconfig</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> pkgconfig</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">).</span></div>
<div style="position:absolute;left:69.68px;top:393.39px" class="cls_004"><span class="cls_004">However, when we call</span><span class="cls_007"> maybeRewrite</span><span class="cls_004"> on (</span><span class="cls_007">libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">,</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">), things get more interesting</span></div>
<div style="position:absolute;left:59.72px;top:405.35px" class="cls_004"><span class="cls_004">since we do need a rewrite.  This is because its sole reference,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">  is replaced with</span></div>
<div style="position:absolute;left:59.72px;top:417.30px" class="cls_007"><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">. Therefore, a copy is made of</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">, in which the occurrences of</span><span class="cls_007"> hashPart</span><span class="cls_004">(</span><span class="cls_007">glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:59.72px;top:428.23px" class="cls_004"><span class="cls_004">are replaced with</span><span class="cls_007"> hashPart</span><span class="cls_004">(</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">). This yields a new path,</span><span class="cls_007"> libIDL</span><span class="cls_012"><sup>′B</sup></span><span class="cls_004">, which has a reference</span></div>
<div style="position:absolute;left:59.72px;top:441.21px" class="cls_004"><span class="cls_004">to</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004"> instead of</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">. In summary,</span></div>
<div style="position:absolute;left:124.51px;top:463.68px" class="cls_007"><span class="cls_007">maybeRewrite</span><span class="cls_004">(</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">, selected) = (</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:137.45px;top:479.94px" class="cls_007"><span class="cls_007">maybeRewrite</span><span class="cls_004">(</span><span class="cls_007">gtk</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> gtk</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">, selected) = (</span><span class="cls_007">gtk</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> gtk</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:84.62px;top:496.20px" class="cls_007"><span class="cls_007">maybeRewrite</span><span class="cls_004">(</span><span class="cls_007">pkgconfig</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> pkgconfig</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">, selected) = (</span><span class="cls_007">pkgconfig</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> pkgconfig</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:115.54px;top:510.93px" class="cls_007"><span class="cls_007">maybeRewrite</span><span class="cls_004">(</span><span class="cls_007">libIDL</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">,</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">, selected) = (</span><span class="cls_007">libIDL</span><span class="cls_012"><sup>′B</sup></span><span class="cls_004">,</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:59.72px;top:534.93px" class="cls_004"><span class="cls_004">Thus the set returned by</span><span class="cls_007"> resolve</span><span class="cls_004"> for our running example is {(</span><span class="cls_007">glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">), (</span><span class="cls_007">gtk</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> gtk</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">),</span></div>
<div style="position:absolute;left:59.72px;top:545.85px" class="cls_004"><span class="cls_004">(</span><span class="cls_007">pkgconfig</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">,</span><span class="cls_007"> pkgconfig</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">), (</span><span class="cls_007">libIDL</span><span class="cls_012"><sup>′B</sup></span><span class="cls_004">,</span><span class="cls_007"> libIDL</span><span class="cls_012"><sub>eq</sub></span><span class="cls_004">)}. Note that this set is closed under the</span><span class="cls_007"> refer-</span></div>
<div style="position:absolute;left:59.72px;top:557.81px" class="cls_007"><span class="cls_007">ences</span><span class="cls_004"> relation since</span><span class="cls_007"> libIDL</span><span class="cls_012"><sup>′B</sup></span><span class="cls_004"> references</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>A</sub></span><span class="cls_004">, not</span><span class="cls_007"> glibc</span><span class="cls_012"><sub>B</sub></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:571.07px" class="cls_004"><span class="cls_004">It may not be obvious at first glance that</span><span class="cls_007"> resolve</span><span class="cls_004"> is correct, i.e., that it produces a set of</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">paths that obeys the equivalence class unicity invariant, and is closed. The first property is</span></div>
<div style="position:absolute;left:59.72px;top:624.86px" class="cls_004"><span class="cls_004">152</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:109020px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background161.jpg" width=481 height=680></div>
<div style="position:absolute;left:361.29px;top:17.14px" class="cls_004"><span class="cls_004">6.4. Semantics</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">trivial, since</span><span class="cls_007"> selectPaths</span><span class="cls_004"> by definition yields a set selected that obeys the invariant, and we</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">call</span><span class="cls_007"> maybeRewrite</span><span class="cls_004"> once for each (p, e) ∈ selected, yielding a path in the same equivalence</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">class. The second property is more subtle, and is proved as follows.</span></div>
<div style="position:absolute;left:63.87px;top:88.01px" class="cls_004"><span class="cls_004">Theorem 5 (Closure of resolved set). The paths in the set paths</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> returned by the function</span></div>
<div style="position:absolute;left:63.87px;top:101.28px" class="cls_007"><span class="cls_007">resolve</span><span class="cls_004"> in Figure 6.3 are closed under the</span><span class="cls_007"> references</span><span class="cls_004"> relation.</span></div>
<div style="position:absolute;left:63.87px;top:121.66px" class="cls_004"><span class="cls_004">Proof. The proof is by structural induction.  Note that</span><span class="cls_007"> maybeRewrite</span><span class="cls_004"> is called for each</span></div>
<div style="position:absolute;left:63.87px;top:133.62px" class="cls_004"><span class="cls_004">(p, e) in selected. The induction hypothesis is that the closure of every path returned by a</span></div>
<div style="position:absolute;left:63.87px;top:144.25px" class="cls_004"><span class="cls_004">call to</span><span class="cls_007"> maybeRewrite</span><span class="cls_004"> for a path p in equivalence class e is in paths</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:157.68px" class="cls_004"><span class="cls_004">There is one base case: if a path (p, e) ∈ selected has only trivial or source references,</span></div>
<div style="position:absolute;left:63.87px;top:168.32px" class="cls_007"><span class="cls_007">maybeRewrite</span><span class="cls_004"> returns (p, e) unmodified, so (p, e) ∈ paths</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">. Any non-trivial references are</span></div>
<div style="position:absolute;left:63.87px;top:180.27px" class="cls_004"><span class="cls_004">source references and explicitly included in paths</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> at</span><span class="cls_014"> </span><span class="cls_056">112</span><span class="cls_059"> </span><span class="cls_004">. Thus the hypothesis holds.</span></div>
<div style="position:absolute;left:73.84px;top:193.70px" class="cls_004"><span class="cls_004">The inductive step is as follows. If a path (p, e) ∈ selected has non-trivial references,</span></div>
<div style="position:absolute;left:63.87px;top:205.65px" class="cls_004"><span class="cls_004">then it is rewritten to a new path (p</span><span class="cls_012"><sub>new</sub></span><span class="cls_004">, e).  Each non-trivial, non-source reference p</span><span class="cls_012"><sub>ref</sub></span></div>
<div style="position:absolute;left:63.87px;top:217.61px" class="cls_004"><span class="cls_004">of p in equivalence class e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004"> is rewritten by a recursive call to</span><span class="cls_007"> maybeRewrite</span><span class="cls_004"> on p</span><span class="cls_012"><sub>repl</sub></span><span class="cls_004"> =</span></div>
<div style="position:absolute;left:63.87px;top:229.56px" class="cls_004"><span class="cls_004">selected[e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">], i.e., the selected replacement for (p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">, e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">). Note that (p</span><span class="cls_012"><sub>repl</sub></span><span class="cls_004">, e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">) ∈ selected,</span></div>
<div style="position:absolute;left:63.87px;top:240.49px" class="cls_004"><span class="cls_004">which by the induction hypothesis means that the closure of p</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:310.85px;top:240.20px" class="cls_012"><span class="cls_012">repl</span><span class="cls_004"> isinpaths</span><span class="cls_012">′</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:253.77px" class="cls_004"><span class="cls_004">Since this is the case for all p</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:205.79px;top:254.80px" class="cls_004"><span class="cls_004">the closures of all references of the path p</span><span class="cls_012"><sub>new</sub></span><span class="cls_004"> produced</span></div>
<div style="position:absolute;left:188.95px;top:254.80px" class="cls_012"><span class="cls_012">repl</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:63.87px;top:266.90px" class="cls_004"><span class="cls_004">by the call to</span><span class="cls_007"> addToStore</span><span class="cls_004"> are in paths</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, and since p</span><span class="cls_012"><sub>new</sub></span><span class="cls_004"> is returned and added to paths</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, the</span></div>
<div style="position:absolute;left:63.87px;top:278.85px" class="cls_004"><span class="cls_004">closure of p</span><span class="cls_012"><sub>new</sub></span><span class="cls_004"> is also in paths</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:308.72px" class="cls_008"><span class="cls_008">6.4.2. Adding store objects</span></div>
<div style="position:absolute;left:63.87px;top:328.49px" class="cls_004"><span class="cls_004">Figure 6.5 shows the intensional version of the function</span><span class="cls_007"> addToStore</span><span class="cls_004"> that adds an atom</span></div>
<div style="position:absolute;left:63.87px;top:340.44px" class="cls_004"><span class="cls_004">(an FSO) to the Nix store.  It is merely a wrapper around a more powerful function,</span></div>
<div style="position:absolute;left:63.87px;top:351.24px" class="cls_007"><span class="cls_007">addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, that writes an FSO to the Nix store at its proper content-addressed location.</span></div>
<div style="position:absolute;left:63.87px;top:363.19px" class="cls_007"><span class="cls_007">addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> is the only primitive operation that adds valid paths to the store in the inten-</span></div>
<div style="position:absolute;left:63.87px;top:376.31px" class="cls_004"><span class="cls_004">sional model. This is in contrast to the extensional model, where the functions</span><span class="cls_007"> build</span><span class="cls_004"> and</span></div>
<div style="position:absolute;left:63.87px;top:388.26px" class="cls_007"><span class="cls_007">substitute</span><span class="cls_004"> also produce valid paths. It takes six arguments:</span></div>
<div style="position:absolute;left:78.82px;top:408.64px" class="cls_004"><span class="cls_004">• fso is the FSO to be written to the store.</span></div>
<div style="position:absolute;left:78.82px;top:429.17px" class="cls_004"><span class="cls_004">• refs is the set of referenced store paths of the FSO.</span></div>
<div style="position:absolute;left:78.82px;top:449.70px" class="cls_004"><span class="cls_004">• eqRefs is a set of tuples (p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">, e, e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">) that describe elements to be added to the</span><span class="cls_007"> ref-</span></div>
<div style="position:absolute;left:88.78px;top:461.66px" class="cls_007"><span class="cls_007">Classes</span><span class="cls_004"> mapping. Each tuple signifies that, given a resulting path p, the entry (e, e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:88.78px;top:473.61px" class="cls_004"><span class="cls_004">should be added to</span><span class="cls_007"> refClasses</span><span class="cls_004">[(p, p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">)].</span></div>
<div style="position:absolute;left:78.82px;top:494.14px" class="cls_004"><span class="cls_004">• name is the symbolic name to be used in the construction of the store path.</span></div>
<div style="position:absolute;left:78.82px;top:514.67px" class="cls_004"><span class="cls_004">• rewrites is a set of hash rewrites (i.e., h</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> ⇝ h</span><span class="cls_012"><sub>2</sub></span><span class="cls_004">) to be applied to the FSO and to the</span></div>
<div style="position:absolute;left:88.78px;top:526.63px" class="cls_004"><span class="cls_004">references refs and eqRefs.</span></div>
<div style="position:absolute;left:78.82px;top:547.16px" class="cls_004"><span class="cls_004">• selfHash is the hash part of the path from which the FSO is being copied. As dis-</span></div>
<div style="position:absolute;left:88.78px;top:559.11px" class="cls_004"><span class="cls_004">cussed in Section 6.3.2, self-references must be zeroed out when computing the</span></div>
<div style="position:absolute;left:88.78px;top:571.07px" class="cls_004"><span class="cls_004">cryptographic hash of the FSO, and must be replaced with the hash part of the new</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_004"><span class="cls_004">store path of the FSO. For atoms (such as sources), which originate from outside of</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">153</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:109710px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background162.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:68.09px;top:46.83px" class="cls_007"><span class="cls_007">addToStore</span><span class="cls_004">(fso, refs, name) :</span></div>
<div style="position:absolute;left:83.03px;top:57.63px" class="cls_004"><span class="cls_004">return</span><span class="cls_007"> addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(fso, refs, 0, name, 0, ε)</span></div>
<div style="position:absolute;left:68.09px;top:81.64px" class="cls_007"><span class="cls_007">addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(fso, refs, eqRefs, name, rewrites, selfHash) :</span></div>
<div style="position:absolute;left:83.03px;top:94.75px" class="cls_004"><span class="cls_004">c ← </span><span class="cls_007">replace</span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(fso), rewrites)</span><span class="cls_014"> </span><span class="cls_056">120</span></div>
<div style="position:absolute;left:83.03px;top:106.71px" class="cls_004"><span class="cls_004">if selfHash = ε :</span></div>
<div style="position:absolute;left:97.97px;top:118.66px" class="cls_004"><span class="cls_004">h ← </span><span class="cls_007">hashModulo</span><span class="cls_004">(c, selfHash)</span><span class="cls_014"> </span><span class="cls_056">121</span></div>
<div style="position:absolute;left:83.03px;top:130.72px" class="cls_004"><span class="cls_004">else :</span></div>
<div style="position:absolute;left:97.97px;top:142.67px" class="cls_004"><span class="cls_004">h ← </span><span class="cls_007">hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">":"</span><span class="cls_004">+c)</span><span class="cls_014"> </span><span class="cls_056">122</span></div>
<div style="position:absolute;left:83.78px;top:154.73px" class="cls_004"><span class="cls_004">p ← </span><span class="cls_007">makePath</span><span class="cls_004">(h, name)</span><span class="cls_014"> </span><span class="cls_056">123</span></div>
<div style="position:absolute;left:83.03px;top:166.68px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> valid</span><span class="cls_004">[p] = ε :</span></div>
<div style="position:absolute;left:97.97px;top:178.64px" class="cls_004"><span class="cls_004">lock ←</span><span class="cls_007"> acquirePathLock</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:97.97px;top:190.59px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> valid</span><span class="cls_004">[p] = ε :</span></div>
<div style="position:absolute;left:112.92px;top:202.55px" class="cls_004"><span class="cls_004">if selfHash = ε :</span></div>
<div style="position:absolute;left:127.86px;top:214.50px" class="cls_004"><span class="cls_004">c ← </span><span class="cls_007">replace</span><span class="cls_004">(c, {selfHash ⇝ </span><span class="cls_007">hashPart</span><span class="cls_004">(p)})</span></div>
<div style="position:absolute;left:306.48px;top:216.50px" class="cls_056"><span class="cls_056">124</span></div>
<div style="position:absolute;left:162.21px;top:228.76px" class="cls_004"><span class="cls_004">← {selfHash ⇝</span><span class="cls_007"> hashPart</span><span class="cls_004">(p)}</span></div>
<div style="position:absolute;left:112.92px;top:240.71px" class="cls_007"><span class="cls_007">writePath</span><span class="cls_004">(p,</span><span class="cls_007"> deserialise</span><span class="cls_004">(c))</span></div>
<div style="position:absolute;left:112.92px;top:252.67px" class="cls_004"><span class="cls_004">in a database transaction :</span></div>
<div style="position:absolute;left:127.86px;top:264.62px" class="cls_007"><span class="cls_007">valid</span><span class="cls_004">[p] ← h</span></div>
<div style="position:absolute;left:127.86px;top:276.58px" class="cls_004"><span class="cls_004">refs ← {</span><span class="cls_007">replace</span><span class="cls_004">(p, rewrites) | p ∈ refs}</span><span class="cls_014"> </span><span class="cls_056">125</span></div>
<div style="position:absolute;left:127.86px;top:288.53px" class="cls_007"><span class="cls_007">setReferences</span><span class="cls_004">(p, refs)</span></div>
<div style="position:absolute;left:97.97px;top:300.49px" class="cls_007"><span class="cls_007">releasePathLock</span><span class="cls_004">(p, lock)</span></div>
<div style="position:absolute;left:83.03px;top:312.44px" class="cls_004"><span class="cls_004">for each (p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">, e, e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">) ∈ eqRefs :</span></div>
<div style="position:absolute;left:254.87px;top:326.70px" class="cls_004"><span class="cls_004">← {(e, e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">)}</span><span class="cls_014"> </span><span class="cls_056">126</span></div>
<div style="position:absolute;left:83.03px;top:338.65px" class="cls_004"><span class="cls_004">return p</span></div>
<div style="position:absolute;left:87.15px;top:363.34px" class="cls_004"><span class="cls_004">Figure 6.5.:</span><span class="cls_007"> addToStore</span><span class="cls_004">: Adding store objects to a content-addressable store</span></div>
<div style="position:absolute;left:84.62px;top:394.24px" class="cls_004"><span class="cls_004">the Nix store, no such self-reference is present in the FSO; the dummy value ε must</span></div>
<div style="position:absolute;left:84.62px;top:406.19px" class="cls_004"><span class="cls_004">then be provided for selfHash. But when copying store paths, such as in the collision</span></div>
<div style="position:absolute;left:84.62px;top:418.15px" class="cls_004"><span class="cls_004">resolution algorithm (Figure 6.3) or in the build algorithm (Figure 6.6), selfHash is</span></div>
<div style="position:absolute;left:84.62px;top:430.10px" class="cls_004"><span class="cls_004">set to the hash part of the source path.</span></div>
<div style="position:absolute;left:69.68px;top:447.72px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> works as follows. First, the hash rewrites are applied to the</span></div>
<div style="position:absolute;left:59.72px;top:460.84px" class="cls_004"><span class="cls_004">serialisation of the FSO</span><span class="cls_014"> </span><span class="cls_056">120</span><span class="cls_059"> </span><span class="cls_004">.  Next, the hash modulo self-references is computed using</span></div>
<div style="position:absolute;left:59.72px;top:472.79px" class="cls_004"><span class="cls_004">the function</span><span class="cls_007"> hashModulo</span><span class="cls_004"> (page 144)</span><span class="cls_014"> </span><span class="cls_056">121</span><span class="cls_059"> </span><span class="cls_004">. However, this is only applicable when copying</span></div>
<div style="position:absolute;left:59.72px;top:484.75px" class="cls_004"><span class="cls_004">inside the store, that is, when selfHash is not ε. If it is ε, the hash is computed normally</span></div>
<div style="position:absolute;left:59.72px;top:496.70px" class="cls_004"><span class="cls_004">over the serialisation, but with a colon prepended</span><span class="cls_014"> </span><span class="cls_056">122</span><span class="cls_059"> </span><span class="cls_004">. This exactly matches a</span><span class="cls_007"> hashModulo</span></div>
<div style="position:absolute;left:59.72px;top:508.66px" class="cls_004"><span class="cls_004">computation over contents that contain no self-references, since in that case we have</span></div>
<div style="position:absolute;left:84.62px;top:529.14px" class="cls_007"><span class="cls_007">hashModulo</span><span class="cls_004">(c, hp) =</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span></div>
<div style="position:absolute;left:232.31px;top:526.88px" class="cls_038"><span class="cls_038">∑</span></div>
<div style="position:absolute;left:255.46px;top:529.14px" class="cls_004"><span class="cls_004">(i +</span><span class="cls_007"> ":"</span><span class="cls_004">) +</span><span class="cls_007"> ":"</span><span class="cls_004"> +</span><span class="cls_007"> replace</span><span class="cls_004">(c, {hp ⇝ 0}))</span></div>
<div style="position:absolute;left:219.39px;top:542.59px" class="cls_012"><span class="cls_012">i∈</span><span class="cls_039">find</span><span class="cls_012">(c,hp)</span></div>
<div style="position:absolute;left:163.87px;top:553.22px" class="cls_004"><span class="cls_004">=</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_038">∑</span><span class="cls_004">(i +</span><span class="cls_007"> ":"</span><span class="cls_004">) +</span><span class="cls_007"> ":"</span><span class="cls_004">+</span><span class="cls_007"> replace</span><span class="cls_004">(c, {hp ⇝ 0}))</span></div>
<div style="position:absolute;left:219.39px;top:568.39px" class="cls_012"><span class="cls_012">i∈ 0</span></div>
<div style="position:absolute;left:163.87px;top:579.44px" class="cls_004"><span class="cls_004">=</span><span class="cls_007"> hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">":"</span><span class="cls_004"> + c)</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">154</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:110400px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background163.jpg" width=481 height=680></div>
<div style="position:absolute;left:361.29px;top:17.14px" class="cls_004"><span class="cls_004">6.4. Semantics</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">and so selfHash is not needed.</span></div>
<div style="position:absolute;left:73.84px;top:57.04px" class="cls_004"><span class="cls_004">The hash and symbolic name are used to construct a store path p</span><span class="cls_014"> </span><span class="cls_056">123</span><span class="cls_059"> </span><span class="cls_004">. Then, just as in</span></div>
<div style="position:absolute;left:63.87px;top:68.99px" class="cls_004"><span class="cls_004">the extensional version of</span><span class="cls_007"> addToStore</span><span class="cls_004">, we check if p is already valid, and if not, acquire</span></div>
<div style="position:absolute;left:63.87px;top:80.95px" class="cls_004"><span class="cls_004">an exclusive lock on p and recheck for validity.  If the path is still not valid, selfHash</span></div>
<div style="position:absolute;left:63.87px;top:92.90px" class="cls_004"><span class="cls_004">is rewritten to</span><span class="cls_007"> hashPart</span><span class="cls_004">(p) (if applicable)</span></div>
<div style="position:absolute;left:240.87px;top:92.90px" class="cls_056"><span class="cls_056">124</span><span class="cls_059"> </span><span class="cls_004">, and the FSO is written to p.  The path</span></div>
<div style="position:absolute;left:63.87px;top:104.86px" class="cls_004"><span class="cls_004">is then registered as valid. But note that the hash rewrites that have been applied to the</span></div>
<div style="position:absolute;left:63.87px;top:116.81px" class="cls_004"><span class="cls_004">contents c are also applied to the set of references</span><span class="cls_014"> </span><span class="cls_056">125</span><span class="cls_059"> </span><span class="cls_004">. This ensures, for instance, that the</span></div>
<div style="position:absolute;left:63.87px;top:128.77px" class="cls_004"><span class="cls_004">old references passed in</span><span class="cls_007"> maybeRewrite</span><span class="cls_014"> </span><span class="cls_056">119</span><span class="cls_004"> are changed to the new references. Likewise,</span></div>
<div style="position:absolute;left:63.87px;top:140.72px" class="cls_004"><span class="cls_004">appropriate</span><span class="cls_007"> refClasses</span><span class="cls_004"> entries are added as described above</span><span class="cls_014"> </span><span class="cls_056">126</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:168.68px" class="cls_008"><span class="cls_008">6.4.3. Building store derivations</span></div>
<div style="position:absolute;left:63.87px;top:188.24px" class="cls_004"><span class="cls_004">Figure 6.6 shows the build algorithm for the intensional model.  As in Section 6.2, we</span></div>
<div style="position:absolute;left:63.87px;top:200.20px" class="cls_004"><span class="cls_004">assume that all operations on the Nix store are done by a privileged user on behalf of the</span></div>
<div style="position:absolute;left:63.87px;top:212.15px" class="cls_004"><span class="cls_004">actual users, who do not have write access themselves.</span></div>
<div style="position:absolute;left:73.84px;top:224.15px" class="cls_004"><span class="cls_004">The most important differences with the build algorithm for the extensional model (Fig-</span></div>
<div style="position:absolute;left:63.87px;top:236.11px" class="cls_004"><span class="cls_004">ure 5.11) are as follows. Since there is no longer a single output that can be substituted or</span></div>
<div style="position:absolute;left:63.87px;top:248.06px" class="cls_004"><span class="cls_004">checked for validity, we have to consider all paths in the output equivalence class. Thus,</span></div>
<div style="position:absolute;left:63.87px;top:260.02px" class="cls_004"><span class="cls_004">we query the set of trusted paths in the equivalence class d.</span><span class="cls_007">eqClass</span><span class="cls_014"> </span><span class="cls_056">127</span><span class="cls_059"> </span><span class="cls_004">. We then check</span></div>
<div style="position:absolute;left:63.87px;top:271.97px" class="cls_004"><span class="cls_004">whether any of those paths are valid; if so, we’re done</span><span class="cls_014"> </span><span class="cls_056">128</span><span class="cls_059"> </span><span class="cls_004">. If not, we try to create one</span></div>
<div style="position:absolute;left:63.87px;top:283.93px" class="cls_004"><span class="cls_004">through substitutes</span><span class="cls_014"> </span><span class="cls_056">129</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:295.93px" class="cls_004"><span class="cls_004">If all of the substitutes fail, we have to perform the build.  We first recursively build</span></div>
<div style="position:absolute;left:63.87px;top:307.88px" class="cls_004"><span class="cls_004">all input derivations.  Just as in the extensional</span><span class="cls_007"> build</span><span class="cls_004"> algorithm, the set inputs of input</span></div>
<div style="position:absolute;left:63.87px;top:319.84px" class="cls_004"><span class="cls_004">paths is computed.  However, this set may contain equivalence class collisions.  Thus,</span></div>
<div style="position:absolute;left:63.87px;top:331.79px" class="cls_004"><span class="cls_004">those conflicts must be resolved</span><span class="cls_014"> </span><span class="cls_056">130</span><span class="cls_059"> </span><span class="cls_004">. The resulting set inputs is a closure that obeys the</span></div>
<div style="position:absolute;left:63.87px;top:343.75px" class="cls_004"><span class="cls_004">equivalence class unicity invariant.</span></div>
<div style="position:absolute;left:73.84px;top:355.74px" class="cls_004"><span class="cls_004">Recall that the</span><span class="cls_007"> envVars</span><span class="cls_004">,</span><span class="cls_007"> args</span><span class="cls_004"> and</span><span class="cls_007"> builder</span><span class="cls_004"> fields of the derivation cannot refer to the output</span></div>
<div style="position:absolute;left:63.87px;top:367.70px" class="cls_004"><span class="cls_004">paths of the actual input derivations, because those are not yet known at instantiation time.</span></div>
<div style="position:absolute;left:63.87px;top:379.65px" class="cls_004"><span class="cls_004">Rather, these fields refer to the output equivalence classes of the input derivations. Now</span></div>
<div style="position:absolute;left:63.87px;top:391.61px" class="cls_004"><span class="cls_004">that we have actual paths for the inputs, we can rewrite the hash parts of the equivalence</span></div>
<div style="position:absolute;left:63.87px;top:403.56px" class="cls_004"><span class="cls_004">classes to the hash parts of the actual paths</span><span class="cls_014"> </span><span class="cls_056">131</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:415.56px" class="cls_004"><span class="cls_004">The build is performed with the environment variable</span><span class="cls_007"> out</span><span class="cls_004"> set to a temporary path in</span></div>
<div style="position:absolute;left:63.87px;top:427.52px" class="cls_004"><span class="cls_004">the Nix store</span><span class="cls_014"> </span><span class="cls_056">132</span><span class="cls_059"> </span><span class="cls_004">. The temporary output path is computed by replacing the hash part of</span></div>
<div style="position:absolute;left:63.87px;top:439.47px" class="cls_004"><span class="cls_004">the output equivalence class with a random hash part of the same length, as described in</span></div>
<div style="position:absolute;left:63.87px;top:451.43px" class="cls_004"><span class="cls_004">Section 6.3.2.</span></div>
<div style="position:absolute;left:73.84px;top:463.43px" class="cls_004"><span class="cls_004">After the build, we copy and rewrite the temporary path to its final, content-addressable</span></div>
<div style="position:absolute;left:63.87px;top:475.38px" class="cls_004"><span class="cls_004">location in the Nix store</span><span class="cls_014"> </span><span class="cls_056">133</span><span class="cls_059"> </span><span class="cls_004">. The temporary path can now be deleted. The new store path</span></div>
<div style="position:absolute;left:63.87px;top:487.34px" class="cls_004"><span class="cls_004">is registered as being inside the equivalence class d.</span><span class="cls_007">eqClass</span><span class="cls_014"> </span><span class="cls_056">134</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:499.34px" class="cls_004"><span class="cls_004">It is worth noting that the intensional build algorithm does not perform locking. It does</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">not have to.  The random temporary path can be assumed to be unique if the random-</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">number generator is sufficiently cryptographically strong, or we can simply check whether</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">it already exists, and if so, pick another path. Since the temporary path is unique, there can</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">be no interference from other Nix processes building the same derivation. The absence of</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">locking has the advantage that it simplifies the implementation and prevents a malevolent</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">user from causing a livelock (e.g., by registering a substitute for a path that does not termi-</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">nate). On the other hand, it may also create work duplication if multiple processes perform</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">155</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:111090px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background164.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:68.09px;top:57.80px" class="cls_007"><span class="cls_007">build</span><span class="cls_004">(p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">) :</span></div>
<div style="position:absolute;left:83.03px;top:69.76px" class="cls_004"><span class="cls_004">if ¬</span><span class="cls_007"> substitute</span><span class="cls_004">(p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">) : abort</span></div>
<div style="position:absolute;left:83.03px;top:81.71px" class="cls_004"><span class="cls_004">d ← </span><span class="cls_007">parseDrv</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p</span><span class="cls_012"><sub>drv</sub></span><span class="cls_004">))</span></div>
<div style="position:absolute;left:83.03px;top:105.62px" class="cls_004"><span class="cls_004">// Note: curUser is the invoking user.</span></div>
<div style="position:absolute;left:83.03px;top:117.58px" class="cls_004"><span class="cls_004">trusted ←</span><span class="cls_007"> trustedPaths</span><span class="cls_004">(d.</span><span class="cls_007">eqClass</span><span class="cls_004">,</span><span class="cls_007"> curUser</span><span class="cls_004">)</span><span class="cls_014"> </span><span class="cls_056">127</span></div>
<div style="position:absolute;left:83.03px;top:129.53px" class="cls_004"><span class="cls_004">for each p ∈ trusted : if</span><span class="cls_007"> valid</span><span class="cls_004">[p] = ε : return p</span><span class="cls_014"> </span><span class="cls_056">128</span></div>
<div style="position:absolute;left:83.03px;top:141.49px" class="cls_004"><span class="cls_004">for each p ∈ trusted : if</span><span class="cls_007"> substitute</span><span class="cls_004">(p) : return p</span><span class="cls_014"> </span><span class="cls_056">129</span></div>
<div style="position:absolute;left:83.03px;top:165.40px" class="cls_004"><span class="cls_004">// Gather all trusted input closures, then resolve.</span></div>
<div style="position:absolute;left:83.03px;top:177.36px" class="cls_004"><span class="cls_004">inputs ← 0</span></div>
<div style="position:absolute;left:83.03px;top:189.31px" class="cls_004"><span class="cls_004">for each p ∈ d.</span><span class="cls_007">inputsDrvs</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:97.97px;top:200.24px" class="cls_004"><span class="cls_004">d</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ←</span><span class="cls_007"> parseDrv</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:97.97px;top:213.22px" class="cls_007"><span class="cls_007">build</span><span class="cls_004">(p)</span></div>
<div style="position:absolute;left:97.97px;top:224.15px" class="cls_004"><span class="cls_004">for each p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ∈</span><span class="cls_007"> trustedPaths</span><span class="cls_004">(d</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">.</span><span class="cls_007">eqClass</span><span class="cls_004">,</span><span class="cls_007"> curUser</span><span class="cls_004">) :</span></div>
<div style="position:absolute;left:139.49px;top:238.40px" class="cls_004"><span class="cls_004">←</span><span class="cls_007"> closure</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, d</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">.</span><span class="cls_007">eqClass</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:83.03px;top:251.39px" class="cls_004"><span class="cls_004">for each p ∈ d.</span><span class="cls_007">inputsSrcs</span><span class="cls_004"> :</span></div>
<div style="position:absolute;left:124.55px;top:264.61px" class="cls_004"><span class="cls_004">←</span><span class="cls_007"> closure</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(p, ε)</span></div>
<div style="position:absolute;left:83.03px;top:277.59px" class="cls_004"><span class="cls_004">inputs ←</span><span class="cls_007"> resolve</span><span class="cls_004">(inputs)</span><span class="cls_014"> </span><span class="cls_056">130</span></div>
<div style="position:absolute;left:83.03px;top:301.51px" class="cls_004"><span class="cls_004">// Rewrite equivalence classes to real paths.</span></div>
<div style="position:absolute;left:83.03px;top:313.46px" class="cls_004"><span class="cls_004">mapping ← /0</span></div>
<div style="position:absolute;left:83.03px;top:325.42px" class="cls_004"><span class="cls_004">for each (p, e) ∈ inputs :</span></div>
<div style="position:absolute;left:135.06px;top:339.67px" class="cls_004"><span class="cls_004">← {</span><span class="cls_007">hashPart</span><span class="cls_004">(e) ⇝</span><span class="cls_007"> hashPart</span><span class="cls_004">(p)}</span></div>
<div style="position:absolute;left:83.03px;top:351.62px" class="cls_004"><span class="cls_004">Apply the rewrites mapping to d.</span><span class="cls_007">envVars</span><span class="cls_004">, d.</span><span class="cls_007">args</span><span class="cls_004"> and d.</span><span class="cls_007">builder</span></div>
<div style="position:absolute;left:336.01px;top:353.62px" class="cls_056"><span class="cls_056">131</span></div>
<div style="position:absolute;left:83.03px;top:375.54px" class="cls_004"><span class="cls_004">// Build in a temporary path.</span></div>
<div style="position:absolute;left:83.03px;top:387.49px" class="cls_004"><span class="cls_004">output ←</span><span class="cls_007"> replace</span><span class="cls_004">(d.</span><span class="cls_007">eqClass</span><span class="cls_004">, {</span><span class="cls_007">hashPart</span><span class="cls_004">(d.</span><span class="cls_007">eqClass</span><span class="cls_004">) ⇝</span><span class="cls_007"> randomHash</span><span class="cls_004">()})</span></div>
<div style="position:absolute;left:83.03px;top:399.45px" class="cls_004"><span class="cls_004">d.</span><span class="cls_007">envVars</span><span class="cls_004">[</span><span class="cls_007">"out"</span><span class="cls_004">] ← output</span><span class="cls_014"> </span><span class="cls_056">132</span></div>
<div style="position:absolute;left:83.03px;top:411.40px" class="cls_004"><span class="cls_004">Run d.</span><span class="cls_007">builder</span><span class="cls_004"> in an environment d.</span><span class="cls_007">envVars</span></div>
<div style="position:absolute;left:92.99px;top:423.36px" class="cls_004"><span class="cls_004">and with arguments d.</span><span class="cls_007">args</span><span class="cls_004"> and in a temporary directory p</span><span class="cls_012"><sub>tmp</sub></span></div>
<div style="position:absolute;left:83.03px;top:435.31px" class="cls_004"><span class="cls_004">Canonicalise output & perform fixed-output derivation tests as in Figure 5.11</span></div>
<div style="position:absolute;left:83.03px;top:459.22px" class="cls_004"><span class="cls_004">// Copy to content-addressed location and register as valid.</span></div>
<div style="position:absolute;left:83.03px;top:471.18px" class="cls_004"><span class="cls_004">refs ←</span><span class="cls_007"> scanForReferences</span><span class="cls_004">(output, {p | (p, e) ∈ inputs})</span></div>
<div style="position:absolute;left:83.03px;top:483.13px" class="cls_004"><span class="cls_004">in a database transaction :</span></div>
<div style="position:absolute;left:97.97px;top:493.93px" class="cls_004"><span class="cls_004">output</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ←</span><span class="cls_007"> addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(output), refs,</span></div>
<div style="position:absolute;left:107.94px;top:507.04px" class="cls_004"><span class="cls_004">{(p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">, d.</span><span class="cls_007">eqClass</span><span class="cls_004">, e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">) | (p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">, e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">) ∈ inputs ∧ p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004"> ∈ refs},</span></div>
<div style="position:absolute;left:107.94px;top:519.00px" class="cls_007"><span class="cls_007">namePart</span><span class="cls_004">(d.</span><span class="cls_007">eqClass</span><span class="cls_004">), 0,</span><span class="cls_007"> hashPart</span><span class="cls_004">(output))</span><span class="cls_014"> </span><span class="cls_056">133</span></div>
<div style="position:absolute;left:216.10px;top:532.23px" class="cls_004"><span class="cls_004">← {(</span><span class="cls_007">curUser</span><span class="cls_004">, output</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">)}</span><span class="cls_014"> </span><span class="cls_056">134</span></div>
<div style="position:absolute;left:97.97px;top:544.18px" class="cls_004"><span class="cls_004">return output</span><span class="cls_012"><sup>′</sup></span></div>
<div style="position:absolute;left:101.44px;top:569.89px" class="cls_004"><span class="cls_004">Figure 6.6.:</span><span class="cls_007"> build</span><span class="cls_004">: Building store derivations in the intensional model</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">156</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:111780px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background165.jpg" width=481 height=680></div>
<div style="position:absolute;left:361.29px;top:17.14px" class="cls_004"><span class="cls_004">6.4. Semantics</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">exactly the same build. This is safe, however: even if multiple builds produce exactly the</span></div>
<div style="position:absolute;left:63.87px;top:55.84px" class="cls_004"><span class="cls_004">same outputs, the idempotency and transactional semantics of</span><span class="cls_007"> addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ensure that the</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">resulting path is not written to twice.</span></div>
<div style="position:absolute;left:63.87px;top:95.21px" class="cls_009"><span class="cls_009">Builder write permission</span><span class="cls_004">   A trivial but annoying problem is how we can allow builders</span></div>
<div style="position:absolute;left:63.87px;top:107.16px" class="cls_004"><span class="cls_004">to create their output path, i.e., the path specified in the environment variable</span><span class="cls_007"> out</span><span class="cls_004">. After</span></div>
<div style="position:absolute;left:63.87px;top:119.12px" class="cls_004"><span class="cls_004">all, the builder is not supposed to have write permission to the Nix store! Thus a builder</span></div>
<div style="position:absolute;left:63.87px;top:131.07px" class="cls_004"><span class="cls_004">should not be allowed to perform:</span></div>
<div style="position:absolute;left:88.78px;top:154.06px" class="cls_015"><span class="cls_015">mkdir  $out</span></div>
<div style="position:absolute;left:63.87px;top:167.53px" class="cls_004"><span class="cls_004">since that implies that it can also create other paths in the store. The prototype implemen-</span></div>
<div style="position:absolute;left:63.87px;top:179.49px" class="cls_004"><span class="cls_004">tation of the intensional model does not yet solve this problem (builders still have arbitrary</span></div>
<div style="position:absolute;left:63.87px;top:191.44px" class="cls_004"><span class="cls_004">write permission to the store). There are a number of possible solutions. On Unix, the Nix</span></div>
<div style="position:absolute;left:63.87px;top:203.40px" class="cls_004"><span class="cls_004">store directory could be given the sticky permission bit (</span><span class="cls_007">S_ISVTX</span><span class="cls_004">) [152], which prevents</span></div>
<div style="position:absolute;left:63.87px;top:215.35px" class="cls_004"><span class="cls_004">users from deleting or renaming directories not owned by them. Under the secure local</span></div>
<div style="position:absolute;left:63.87px;top:227.31px" class="cls_004"><span class="cls_004">build scheme from Section 6.2, the builder runs under a unique</span><span class="cls_007"> uid</span><span class="cls_004"> that differs from the</span></div>
<div style="position:absolute;left:63.87px;top:239.26px" class="cls_007"><span class="cls_007">uid</span><span class="cls_004"> that owns the valid FSOs, and from the</span><span class="cls_007"> uid</span><span class="cls_004">s of other concurrently running builders.</span></div>
<div style="position:absolute;left:63.87px;top:251.22px" class="cls_004"><span class="cls_004">Thus, the builder can create other paths than its expected output, but these can be deleted</span></div>
<div style="position:absolute;left:63.87px;top:263.17px" class="cls_004"><span class="cls_004">afterwards, and it cannot modify valid paths.</span></div>
<div style="position:absolute;left:73.84px;top:275.13px" class="cls_004"><span class="cls_004">Another solution is to have the calling Nix process create the output path on behalf of</span></div>
<div style="position:absolute;left:63.87px;top:287.08px" class="cls_004"><span class="cls_004">the builder. The builder then does not need write permission to the store directory itself.</span></div>
<div style="position:absolute;left:63.87px;top:299.04px" class="cls_004"><span class="cls_004">However, Nix must know the type of the output path (i.e., regular file, directory, or symlink)</span></div>
<div style="position:absolute;left:63.87px;top:310.99px" class="cls_004"><span class="cls_004">ahead of time. Finally, the builder could ask the calling Nix process to create the output</span></div>
<div style="position:absolute;left:63.87px;top:322.95px" class="cls_004"><span class="cls_004">path of the appropriate type, e.g., by talking to it through a socket.</span></div>
<div style="position:absolute;left:63.87px;top:350.40px" class="cls_008"><span class="cls_008">6.4.4. Substitutes</span></div>
<div style="position:absolute;left:63.87px;top:369.88px" class="cls_004"><span class="cls_004">Just as the table</span><span class="cls_007"> eqClassMembers</span><span class="cls_004"> ties equivalence class membership to users, we extend</span></div>
<div style="position:absolute;left:63.87px;top:381.83px" class="cls_004"><span class="cls_004">the</span><span class="cls_007"> substitutes</span><span class="cls_004"> mapping (first defined in Section 5.5.3) with a</span><span class="cls_007"> UserId</span><span class="cls_004"> for each substitute to</span></div>
<div style="position:absolute;left:63.87px;top:393.79px" class="cls_004"><span class="cls_004">indicate which user registered it, i.e.,</span><span class="cls_007"> substitutes</span><span class="cls_004"> :</span><span class="cls_007"> Path</span><span class="cls_004"> → {(</span><span class="cls_007">UserId</span><span class="cls_004">,</span><span class="cls_007"> Path</span><span class="cls_004">, [</span><span class="cls_007">String</span><span class="cls_004">],</span><span class="cls_007"> Path</span><span class="cls_004">)}.</span></div>
<div style="position:absolute;left:63.87px;top:405.74px" class="cls_004"><span class="cls_004">This means that a substitute is a 4-tuple consisting of the ID of the user who registered the</span></div>
<div style="position:absolute;left:63.87px;top:417.70px" class="cls_004"><span class="cls_004">substitute, the path of the substitute program, its command-line arguments, and the deriver</span></div>
<div style="position:absolute;left:63.87px;top:429.65px" class="cls_004"><span class="cls_004">(page 114). For example,</span></div>
<div style="position:absolute;left:93.76px;top:449.64px" class="cls_007"><span class="cls_007">substitutes</span><span class="cls_004">[</span><span class="cls_007">/nix/store/bpv6czrwrmhr</span></div>
<div style="position:absolute;left:249.27px;top:449.64px" class="cls_007"><span class="cls_007">-hello-2.1.1</span><span class="cls_004">] =</span></div>
<div style="position:absolute;left:104.83px;top:461.60px" class="cls_004"><span class="cls_004">{ ( </span><span class="cls_007">"alice"</span><span class="cls_004">, </span><span class="cls_007">"download-url.sh"</span></div>
<div style="position:absolute;left:113.13px;top:476.54px" class="cls_004"><span class="cls_004">, [</span><span class="cls_007">"<A HREF="http://example.org/0n4laxf6kq44/">http://example.org/0n4laxf6kq44</A> </span></div>
<div style="position:absolute;left:262.31px;top:476.54px" class="cls_007"><span class="cls_007">nar.bz2"</span><span class="cls_004">]</span></div>
<div style="position:absolute;left:113.13px;top:491.49px" class="cls_004"><span class="cls_004">,</span><span class="cls_007"> "/nix/store/1ja1w63wbk5q...-hello-2.1.1.drv"</span><span class="cls_004"> )</span></div>
<div style="position:absolute;left:104.83px;top:506.43px" class="cls_004"><span class="cls_004">,</span></div>
<div style="position:absolute;left:112.02px;top:506.43px" class="cls_004"><span class="cls_004">(</span><span class="cls_007"> "bob"</span><span class="cls_004">,</span><span class="cls_007"> "download-url.sh"</span></div>
<div style="position:absolute;left:112.02px;top:521.37px" class="cls_004"><span class="cls_004">, [</span><span class="cls_007">"<A HREF="http://example.org/r35w1y8xll12/">http://example.org/r35w1y8xll12</A> </span></div>
<div style="position:absolute;left:260.19px;top:521.37px" class="cls_007"><span class="cls_007">nar.bz2"</span><span class="cls_004">]</span></div>
<div style="position:absolute;left:112.02px;top:536.32px" class="cls_004"><span class="cls_004">,</span><span class="cls_007"> "/nix/store/1ja1w63wbk5q...-hello-2.1.1.drv"</span><span class="cls_004"> )</span></div>
<div style="position:absolute;left:104.83px;top:551.26px" class="cls_004"><span class="cls_004">}</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">Adding a</span><span class="cls_007"> UserId</span><span class="cls_004"> is not strictly necessary to ensure the trust property.  After all, due to</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">content-addressability, if a substitute for path p fails to produce a path with a content hash</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">157</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:112470px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background166.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:68.09px;top:46.83px" class="cls_007"><span class="cls_007">Bool substitute</span><span class="cls_004">(p) :</span></div>
<div style="position:absolute;left:83.03px;top:58.79px" class="cls_004"><span class="cls_004">if</span><span class="cls_007"> valid</span><span class="cls_004">[p] = ε : return true</span></div>
<div style="position:absolute;left:83.03px;top:70.74px" class="cls_004"><span class="cls_004">subs ←</span><span class="cls_007"> trustedSubs</span><span class="cls_004">(p,</span><span class="cls_007"> curUser</span><span class="cls_004">)</span><span class="cls_014"> </span><span class="cls_056">135</span></div>
<div style="position:absolute;left:83.03px;top:82.70px" class="cls_004"><span class="cls_004">if subs = 0 : return false</span></div>
<div style="position:absolute;left:83.03px;top:93.63px" class="cls_004"><span class="cls_004">for each p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ∈</span><span class="cls_007"> references</span><span class="cls_004">[p] :</span></div>
<div style="position:absolute;left:92.99px;top:105.58px" class="cls_004"><span class="cls_004">if ¬</span><span class="cls_007"> substitute</span><span class="cls_004">(p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">) : return false</span></div>
<div style="position:absolute;left:83.03px;top:130.52px" class="cls_004"><span class="cls_004">for each (user, program, args, deriver) ∈</span><span class="cls_007"> substitutes</span><span class="cls_004">[p] :</span></div>
<div style="position:absolute;left:98.72px;top:142.47px" class="cls_004"><span class="cls_004">p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004"> ←</span><span class="cls_007"> replace</span><span class="cls_004">(p, {</span><span class="cls_007">hashPart</span><span class="cls_004">(p) ⇝</span><span class="cls_007"> randomHash</span><span class="cls_004">()})</span><span class="cls_014"> </span><span class="cls_056">136</span></div>
<div style="position:absolute;left:97.97px;top:154.43px" class="cls_004"><span class="cls_004">if execution of program with arguments [p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004">] + args exits with exit code</span></div>
<div style="position:absolute;left:392.05px;top:154.43px" class="cls_004"><span class="cls_004">0:</span></div>
<div style="position:absolute;left:112.92px;top:166.38px" class="cls_004"><span class="cls_004">assert(</span><span class="cls_007">pathExists</span><span class="cls_004">(p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004">))</span></div>
<div style="position:absolute;left:113.66px;top:177.18px" class="cls_004"><span class="cls_004">p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> ←</span><span class="cls_007"> addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004">),</span><span class="cls_007"> references</span><span class="cls_004">[p], 0</span></div>
<div style="position:absolute;left:122.88px;top:190.29px" class="cls_007"><span class="cls_007">namePart</span><span class="cls_004">(p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004">), 0,</span><span class="cls_007"> hashPart</span><span class="cls_004">(p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_004">))</span><span class="cls_014"> </span><span class="cls_056">137</span></div>
<div style="position:absolute;left:112.92px;top:201.22px" class="cls_004"><span class="cls_004">if p = p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> : return true</span><span class="cls_014"> </span><span class="cls_056">138</span></div>
<div style="position:absolute;left:83.03px;top:226.16px" class="cls_004"><span class="cls_004">if fall-back is disabled : abort</span></div>
<div style="position:absolute;left:83.03px;top:238.12px" class="cls_004"><span class="cls_004">return false</span></div>
<div style="position:absolute;left:90.97px;top:262.80px" class="cls_004"><span class="cls_004">Figure 6.7.:</span><span class="cls_007"> substitute</span><span class="cls_004">: Substitution of store paths in the intensional model</span></div>
<div style="position:absolute;left:59.72px;top:296.86px" class="cls_004"><span class="cls_004">that corresponds with</span><span class="cls_007"> hashPart</span><span class="cls_004">(p), the substitute can simply be considered to have failed,</span></div>
<div style="position:absolute;left:59.72px;top:308.82px" class="cls_004"><span class="cls_004">and its output in p can be deleted. However, we do not want users to trigger other users’</span></div>
<div style="position:absolute;left:59.72px;top:320.78px" class="cls_004"><span class="cls_004">substitutes, as that can lead to privacy violations.  For instance, Alice could register a</span></div>
<div style="position:absolute;left:59.72px;top:332.73px" class="cls_004"><span class="cls_004">substitute that as a side effect informs her when other users try to install certain paths.</span></div>
<div style="position:absolute;left:69.68px;top:345.69px" class="cls_004"><span class="cls_004">Another necessary change is that when a substitute for path p is registered,</span><span class="cls_007"> refClasses</span></div>
<div style="position:absolute;left:59.72px;top:357.65px" class="cls_004"><span class="cls_004">entries for the references of p must also be registered. This means that the command</span><span class="cls_007"> nix-</span></div>
<div style="position:absolute;left:59.72px;top:369.60px" class="cls_007"><span class="cls_007">store --register-substitutes</span><span class="cls_004"> (Section 5.5.3) must be extended to accept a list of (p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">, e, e</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">)</span></div>
<div style="position:absolute;left:59.72px;top:381.56px" class="cls_004"><span class="cls_004">entries that can be added to</span><span class="cls_007"> refClasses</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:394.52px" class="cls_004"><span class="cls_004">Figure 6.7 shows the substitution function</span><span class="cls_007"> substitute</span><span class="cls_004">(p). The main difference with the</span></div>
<div style="position:absolute;left:59.72px;top:406.48px" class="cls_004"><span class="cls_004">extensional version (Figure 5.15) is that the substitute program must produce its output in a</span></div>
<div style="position:absolute;left:59.72px;top:417.27px" class="cls_004"><span class="cls_004">temporary path p</span><span class="cls_012"><sub>tmp</sub></span><span class="cls_014"> </span><span class="cls_056"> 136</span><span class="cls_004"> which is then copied (using</span><span class="cls_007"> addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">) to its content-addressed</span></div>
<div style="position:absolute;left:59.72px;top:429.23px" class="cls_004"><span class="cls_004">location</span><span class="cls_014"> </span><span class="cls_056">137</span><span class="cls_059"> </span><span class="cls_004">. Note that it can simply pass 0 for the eqRefs argument of</span><span class="cls_007"> addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, since</span></div>
<div style="position:absolute;left:59.72px;top:442.34px" class="cls_004"><span class="cls_004">the</span><span class="cls_007"> refClasses</span><span class="cls_004"> entries for p have already been set when the substitute was registered.</span></div>
<div style="position:absolute;left:69.68px;top:454.28px" class="cls_004"><span class="cls_004">If the resulting path p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004"> does not match with the path p that the substitute is supposed to</span></div>
<div style="position:absolute;left:59.72px;top:467.26px" class="cls_004"><span class="cls_004">produce, the substitute is ignored and the next substitute is tried</span><span class="cls_014"> </span><span class="cls_056">138</span><span class="cls_059"> </span><span class="cls_004">. Also, only substi-</span></div>
<div style="position:absolute;left:59.72px;top:479.22px" class="cls_004"><span class="cls_004">tutes registered by the current user are considered</span><span class="cls_014"> </span><span class="cls_056">135</span><span class="cls_059"> </span><span class="cls_004">. Analogously to</span><span class="cls_007"> trustedPaths</span><span class="cls_004">, the</span></div>
<div style="position:absolute;left:59.72px;top:491.17px" class="cls_004"><span class="cls_004">function</span><span class="cls_007"> trustedSubs</span><span class="cls_004">(p, user) yields from</span><span class="cls_007"> substitutes</span><span class="cls_004">[p] those substitutes register by user.</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_009"><span class="cls_009">Security of references</span><span class="cls_004">   When a substitute is registered, the caller must also provide a</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">list of references and</span><span class="cls_007"> refClasses</span><span class="cls_004"> entries for the path. However, that information may be</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">wrong—the user could supply garbage. For instance, the references supplied by the user</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">could be incomplete. This could cause incomplete deployment: a path p realised through</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">a substitute could have dangling pointers. However, this is only a problem if the path is</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">used by other users. Those users presumably first register their own substitutes before they</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">158</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:113160px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background167.jpg" width=481 height=680></div>
<div style="position:absolute;left:344.76px;top:17.14px" class="cls_004"><span class="cls_004">6.5. Trust relations</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">build a derivation that produces p. As part of the substitute registration, bona fide users</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">must supply a full set of references. A simple solution is therefore as follows: when users</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">register additional references for a path that is already valid, the additional references must</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">be realised through substitutes immediately, then added to the references of p.</span></div>
<div style="position:absolute;left:73.84px;top:92.86px" class="cls_004"><span class="cls_004">Likewise, the registered references can contain bogus paths, i.e., paths that are not ac-</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">tually references. This can lead to an unsubstitutable path, e.g., where a user cannot sub-</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">stitute path p because another user registered a bogus (unsubstitutable) reference p</span><span class="cls_012"><sub>ref</sub></span><span class="cls_004">. A</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">simple solution is to substitute p before we substitute its references (but not before mak-</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">ing it valid, of course), then scan p to check what declared references actually occur. The</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">bogus references can then be tossed out.</span></div>
<div style="position:absolute;left:63.87px;top:183.07px" class="cls_011"><span class="cls_011">6.5. Trust relations</span></div>
<div style="position:absolute;left:63.87px;top:208.28px" class="cls_004"><span class="cls_004">The intensional model described in the previous section gives us a Nix store that can be</span></div>
<div style="position:absolute;left:63.87px;top:220.24px" class="cls_004"><span class="cls_004">shared by mutually untrusted users, or users who have different remote trust relations. Due</span></div>
<div style="position:absolute;left:63.87px;top:232.19px" class="cls_004"><span class="cls_004">to content-addressability, we get sharing between multiple builds of a derivation if each</span></div>
<div style="position:absolute;left:63.87px;top:244.15px" class="cls_004"><span class="cls_004">build produces exactly the same binary result, that is, if there is no impurity in the build. If</span></div>
<div style="position:absolute;left:63.87px;top:256.10px" class="cls_004"><span class="cls_004">there is impurity, then each build result will end up under a different store path.</span></div>
<div style="position:absolute;left:73.84px;top:268.06px" class="cls_004"><span class="cls_004">Between untrusted users, this is exactly what we want. If Alice obtains substitutes from</span></div>
<div style="position:absolute;left:63.87px;top:280.01px" class="cls_004"><span class="cls_004">a malicious machine, it does not affect Bob. Note that Alice and Bob do automatically get</span></div>
<div style="position:absolute;left:63.87px;top:291.97px" class="cls_004"><span class="cls_004">sharing if they happen to get their substitutes from the same remote machine.</span></div>
<div style="position:absolute;left:73.84px;top:303.92px" class="cls_004"><span class="cls_004">However, we wish to re-enable sharing in common scenarios. For instance, users gen-</span></div>
<div style="position:absolute;left:63.87px;top:315.88px" class="cls_004"><span class="cls_004">erally trust components installed by the administrator. Thus, if Alice is an administrator,</span></div>
<div style="position:absolute;left:63.87px;top:327.83px" class="cls_004"><span class="cls_004">then Bob should be able to use the output paths already installed by Alice. In general, users</span></div>
<div style="position:absolute;left:63.87px;top:339.79px" class="cls_004"><span class="cls_004">should be able to specify trust relations between each other.</span></div>
<div style="position:absolute;left:73.84px;top:351.75px" class="cls_004"><span class="cls_004">We can achieve this through a simple extension of the intensional model called the mixed</span></div>
<div style="position:absolute;left:63.87px;top:363.70px" class="cls_004"><span class="cls_004">model. For each user, we maintain a mapping</span><span class="cls_007"> trustedUsers</span><span class="cls_004"> :</span><span class="cls_007"> UserId</span><span class="cls_004"> → {</span><span class="cls_007">UserId</span><span class="cls_004">} that spec-</span></div>
<div style="position:absolute;left:63.87px;top:375.66px" class="cls_004"><span class="cls_004">ifies for each user a set of trusted users. E.g.,</span><span class="cls_007"> trustedUsers</span><span class="cls_004">[</span><span class="cls_007">"bob"</span><span class="cls_004">] = {</span><span class="cls_007">"alice"</span><span class="cls_004">,</span><span class="cls_007"> "bob"</span><span class="cls_004">}. (The</span></div>
<div style="position:absolute;left:63.87px;top:387.61px" class="cls_004"><span class="cls_004">mapping should be reflexive, i.e., u ∈</span><span class="cls_007"> trustedUsers</span><span class="cls_004">[u].)  We then augment the function</span></div>
<div style="position:absolute;left:63.87px;top:399.57px" class="cls_007"><span class="cls_007">trustedPaths</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:88.78px;top:420.13px" class="cls_007"><span class="cls_007">trustedPaths</span><span class="cls_004">(eqClass, user) =</span></div>
<div style="position:absolute;left:98.74px;top:435.08px" class="cls_004"><span class="cls_004">{p | ∃u ∈ </span><span class="cls_007">trustedUsers</span><span class="cls_004">[user] : (u,p) ∈ </span><span class="cls_007">eqClassMembers</span><span class="cls_004">[eqClass]}</span></div>
<div style="position:absolute;left:73.84px;top:455.64px" class="cls_004"><span class="cls_004">Otherwise, this is exactly the intensional model. Of course, sharing between users in-</span></div>
<div style="position:absolute;left:63.87px;top:467.60px" class="cls_004"><span class="cls_004">creases the possibility of equivalence class collisions, but that is handled through the reso-</span></div>
<div style="position:absolute;left:63.87px;top:479.55px" class="cls_004"><span class="cls_004">lution algorithm in Section 6.4.1. The name “mixed model” does not imply that we back</span></div>
<div style="position:absolute;left:63.87px;top:491.51px" class="cls_004"><span class="cls_004">away from intensionality—the store is still fully content-addressed. We just gain back the</span></div>
<div style="position:absolute;left:63.87px;top:503.46px" class="cls_004"><span class="cls_004">ability to have sharing between users. The crucial difference with the extensional model is</span></div>
<div style="position:absolute;left:63.87px;top:515.42px" class="cls_004"><span class="cls_004">that sharing is now selective and fine-grained.</span></div>
<div style="position:absolute;left:63.87px;top:545.85px" class="cls_011"><span class="cls_011">6.6. Related work</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">Nix’s transparent source/binary model is a unique feature for a deployment system. Rela-</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">tive to binary-only or source-only deployment models, it adds the complication that we do</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">159</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:113850px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background168.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">not only need to authenticate binaries but also the fact that they are a bona fide result of</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">certain sources. However, caching and sharing between users of build results is a feature</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">of some SCM systems such as Vesta [92].</span></div>
<div style="position:absolute;left:69.68px;top:81.19px" class="cls_004"><span class="cls_004">As claimed in the introduction, deployment systems tend to have monolithic trust mod-</span></div>
<div style="position:absolute;left:59.72px;top:93.15px" class="cls_004"><span class="cls_004">els. Typical Unix package management systems such as RPM [62], Debian APT, or Gentoo</span></div>
<div style="position:absolute;left:59.72px;top:105.11px" class="cls_004"><span class="cls_004">Linux [77] allow installation of software by the administrator only; software installed by</span></div>
<div style="position:absolute;left:59.72px;top:117.06px" class="cls_004"><span class="cls_004">individual users is not managed by those tools. On the other hand, Mac OS X application</span></div>
<div style="position:absolute;left:59.72px;top:129.02px" class="cls_004"><span class="cls_004">bundles may be installed and moved around by any user, but the system does not track</span></div>
<div style="position:absolute;left:59.72px;top:140.97px" class="cls_004"><span class="cls_004">dependencies in any way.</span></div>
<div style="position:absolute;left:69.68px;top:153.22px" class="cls_004"><span class="cls_004">Security aspects of deployment have typically focused on ensuring integrity of compo-</span></div>
<div style="position:absolute;left:59.72px;top:165.17px" class="cls_004"><span class="cls_004">nents in transit (e.g., by using signatures), and on assessing or constraining the impact of</span></div>
<div style="position:absolute;left:59.72px;top:177.13px" class="cls_004"><span class="cls_004">a component on the system (e.g., [173]).  We have not addressed the issue of ensuring</span></div>
<div style="position:absolute;left:59.72px;top:189.08px" class="cls_004"><span class="cls_004">that remote substitutes have not been tampered with (e.g., by a man-in-the-middle). Obvi-</span></div>
<div style="position:absolute;left:59.72px;top:201.04px" class="cls_004"><span class="cls_004">ously, such problems can be solved by cryptographically signing substitutes—or rather the</span></div>
<div style="position:absolute;left:59.72px;top:212.99px" class="cls_004"><span class="cls_004">manifests, since the fact that substitutes themselves have not been tampered with is easily</span></div>
<div style="position:absolute;left:59.72px;top:224.95px" class="cls_004"><span class="cls_004">verified by comparing their cryptographic hashes to their names.</span></div>
<div style="position:absolute;left:69.68px;top:237.19px" class="cls_004"><span class="cls_004">Microsoft’s .NET has a Global Assembly Cache that permits the sharing of compo-</span></div>
<div style="position:absolute;left:59.72px;top:249.15px" class="cls_004"><span class="cls_004">nents [154]. It is however not intended for storage of components private to an applica-</span></div>
<div style="position:absolute;left:59.72px;top:261.10px" class="cls_004"><span class="cls_004">tion.  Thus, if multiple users install an application having such private components, du-</span></div>
<div style="position:absolute;left:59.72px;top:273.06px" class="cls_004"><span class="cls_004">plication can occur.  Also, .NET has a purely binary deployment model, thus bypassing</span></div>
<div style="position:absolute;left:59.72px;top:285.01px" class="cls_004"><span class="cls_004">source/binary correspondence trust issues.</span></div>
<div style="position:absolute;left:69.68px;top:297.26px" class="cls_004"><span class="cls_004">In [80] a scenario is described in which components impersonate other components.</span></div>
<div style="position:absolute;left:59.72px;top:309.21px" class="cls_004"><span class="cls_004">This is not possible in a content-addressable file system with static component composition</span></div>
<div style="position:absolute;left:59.72px;top:321.17px" class="cls_004"><span class="cls_004">(e.g., Unix dynamic libraries with</span><span class="cls_007"> RPATH</span><span class="cls_004">s pointing to the full paths of components to link</span></div>
<div style="position:absolute;left:59.72px;top:333.12px" class="cls_004"><span class="cls_004">against, as happens in the Nix Packages collection).</span></div>
<div style="position:absolute;left:69.68px;top:345.37px" class="cls_004"><span class="cls_004">Content-addressability is a common property of the distributed hash schemes used in</span></div>
<div style="position:absolute;left:59.72px;top:357.32px" class="cls_004"><span class="cls_004">peer-to-peer file-sharing and caching applications (e.g., Pastry [144]). It is also used in the</span></div>
<div style="position:absolute;left:59.72px;top:369.28px" class="cls_004"><span class="cls_004">storage layer of version management tools such as Monotone [95].</span></div>
<div style="position:absolute;left:59.72px;top:401.55px" class="cls_011"><span class="cls_011">6.7. Multiple outputs</span></div>
<div style="position:absolute;left:59.72px;top:427.31px" class="cls_004"><span class="cls_004">Apart from secure sharing, a major advantage of the intensional model is that it allows</span></div>
<div style="position:absolute;left:59.72px;top:439.27px" class="cls_004"><span class="cls_004">derivations to have multiple outputs.  Derivations as we have defined them up till now</span></div>
<div style="position:absolute;left:59.72px;top:451.23px" class="cls_004"><span class="cls_004">produce a single output, i.e., just one store path in the Nix store. However, in many cir-</span></div>
<div style="position:absolute;left:59.72px;top:463.18px" class="cls_004"><span class="cls_004">cumstances it is very useful to allow a derivation to produce multiple outputs, i.e., multiple</span></div>
<div style="position:absolute;left:59.72px;top:475.14px" class="cls_004"><span class="cls_004">store paths. This allows finer-grained deployment, reducing the size in bytes of the closures</span></div>
<div style="position:absolute;left:59.72px;top:487.09px" class="cls_004"><span class="cls_004">that need to be deployed to and stored on client machines.</span></div>
<div style="position:absolute;left:69.68px;top:499.34px" class="cls_004"><span class="cls_004">For instance, the GNU C Library component, Glibc, contains parts that are not actually</span></div>
<div style="position:absolute;left:59.72px;top:511.29px" class="cls_004"><span class="cls_004">needed at runtime by the components that depend on it. Among these parts is its subdirec-</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">tory</span><span class="cls_007"> /include</span><span class="cls_004"> that contains 2.8 MiB of C header files and is only needed at build time. If</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">we perform a binary deployment of a dependent component to clients, it is quite wasteful</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">that these header files are copied also. In fact, the Glibc header files contain a symlink to</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">a different component, the Linux Kernel headers, which take up 7.6 MiB. So the unneces-</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">sary Glibc header files drag along another entirely unnecessary component! Incidentally,</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">this is why the Hello example in Chapter 2 had a retained dependency on</span><span class="cls_007"> linux-headers</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">160</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:114540px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background169.jpg" width=481 height=680></div>
<div style="position:absolute;left:336.10px;top:17.14px" class="cls_004"><span class="cls_004">6.7. Multiple outputs</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">(page 41).</span></div>
<div style="position:absolute;left:73.84px;top:57.06px" class="cls_004"><span class="cls_004">Multiple outputs are not yet implemented in Nix, so there is no concrete syntax for</span></div>
<div style="position:absolute;left:63.87px;top:69.02px" class="cls_004"><span class="cls_004">specifying them in Nix expressions. A possible syntax is as follows. A derivation with</span></div>
<div style="position:absolute;left:63.87px;top:80.97px" class="cls_004"><span class="cls_004">multiple outputs specifies a list of symbolically named outputs in the attribute</span><span class="cls_007"> outputs</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:92.93px" class="cls_004"><span class="cls_004">The Glibc derivation would specify the following:</span></div>
<div style="position:absolute;left:88.78px;top:117.31px" class="cls_015"><span class="cls_015">derivation  {  ...</span></div>
<div style="position:absolute;left:98.19px;top:128.27px" class="cls_015"><span class="cls_015">outputs  =  ["out"  "dev"  "bin"]</span></div>
<div style="position:absolute;left:88.78px;top:139.23px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:63.87px;top:154.10px" class="cls_004"><span class="cls_004">This declares three outputs. The output</span><span class="cls_007"> out</span><span class="cls_004"> contains the bulk of the component, i.e., the</span></div>
<div style="position:absolute;left:63.87px;top:166.06px" class="cls_004"><span class="cls_004">C library. The output</span><span class="cls_007"> dev</span><span class="cls_004"> contains development-only parts, such as the header files men-</span></div>
<div style="position:absolute;left:63.87px;top:178.01px" class="cls_004"><span class="cls_004">tioned above. The output</span><span class="cls_007"> bin</span><span class="cls_004"> contains utility programs shipped with the C library, which</span></div>
<div style="position:absolute;left:63.87px;top:189.97px" class="cls_004"><span class="cls_004">like the header files are not necessary for most users.</span></div>
<div style="position:absolute;left:73.84px;top:201.99px" class="cls_004"><span class="cls_004">The effect of the</span><span class="cls_007"> outputs</span><span class="cls_004"> attribute is that the resulting store derivation specifies not one</span></div>
<div style="position:absolute;left:63.87px;top:213.95px" class="cls_004"><span class="cls_004">output equivalence class, but rather several, identified by their symbolic names, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:236.00px" class="cls_004"><span class="cls_004">d</span><span class="cls_012"><sub>glibc</sub></span><span class="cls_004">.</span><span class="cls_007">eqClasses</span><span class="cls_004"> = { (</span><span class="cls_007">"out"</span><span class="cls_004">,</span><span class="cls_007"> "/nix/store/jzhnqh7ffq72...-glibc-2.3.5"</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:167.27px;top:250.94px" class="cls_004"><span class="cls_004">, (</span><span class="cls_007">"dev"</span><span class="cls_004">,</span><span class="cls_007"> "/nix/store/34z5jyqqs1sf...-glibc-2.3.5-dev"</span><span class="cls_004">)</span></div>
<div style="position:absolute;left:167.27px;top:265.89px" class="cls_004"><span class="cls_004">, (</span><span class="cls_007">"bin"</span><span class="cls_004">,</span><span class="cls_007"> "/nix/store/76zsvfw4zizs...-glibc-2.3.5-bin"</span><span class="cls_004">)}</span></div>
<div style="position:absolute;left:73.84px;top:287.39px" class="cls_004"><span class="cls_004">Conversely, a way is needed for dependent components to refer to specific outputs. A</span></div>
<div style="position:absolute;left:63.87px;top:299.34px" class="cls_004"><span class="cls_004">component</span><span class="cls_007"> foo</span><span class="cls_004"> can specify that it needs the</span><span class="cls_007"> out</span><span class="cls_004"> and</span><span class="cls_007"> dev</span><span class="cls_004"> outputs of Glibc, but (by omission)</span></div>
<div style="position:absolute;left:63.87px;top:311.30px" class="cls_004"><span class="cls_004">not</span><span class="cls_007"> bin</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:88.78px;top:335.69px" class="cls_015"><span class="cls_015">{glibc}:  derivation  {  ...</span></div>
<div style="position:absolute;left:98.19px;top:346.64px" class="cls_015"><span class="cls_015">glibc  =  glibc.out;  #  can  be  shortened  to  just  "glibc"</span></div>
<div style="position:absolute;left:98.19px;top:357.60px" class="cls_015"><span class="cls_015">glibcHeaders  =  glibc.dev;</span></div>
<div style="position:absolute;left:88.78px;top:368.56px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:63.87px;top:383.43px" class="cls_004"><span class="cls_004">To represent this in store derivations, the elements of the</span><span class="cls_007"> inputDrvs</span><span class="cls_004"> field become tuples that</span></div>
<div style="position:absolute;left:63.87px;top:395.39px" class="cls_004"><span class="cls_004">specify which output of an input derivation is needed for a build, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:417.44px" class="cls_004"><span class="cls_004">d</span><span class="cls_012"><sub>foo</sub></span><span class="cls_004">.</span><span class="cls_007">inputDrvs</span><span class="cls_004"> = { (p</span><span class="cls_012"><sub>d,glibc</sub></span><span class="cls_004">,{</span><span class="cls_007">"out"</span><span class="cls_004">,</span><span class="cls_007"> "drv"</span><span class="cls_004">}), ...}</span></div>
<div style="position:absolute;left:63.87px;top:439.49px" class="cls_004"><span class="cls_004">where p</span><span class="cls_012"><sub>d,glibc</sub></span><span class="cls_004"> is the store path of the derivation containing d</span><span class="cls_012"><sub>glibc</sub></span><span class="cls_004">. In fact, the on-disk ATerm</span></div>
<div style="position:absolute;left:63.87px;top:451.45px" class="cls_004"><span class="cls_004">representation of store derivations already supports this extension (see Figure 5.8).</span></div>
<div style="position:absolute;left:73.84px;top:463.47px" class="cls_004"><span class="cls_004">So why are multiple outputs impossible in the extensional model?  Imagine that we</span></div>
<div style="position:absolute;left:63.87px;top:475.43px" class="cls_004"><span class="cls_004">install Hello from source, and add it to a user environment. Hello has a reference to the</span></div>
<div style="position:absolute;left:63.87px;top:487.38px" class="cls_007"><span class="cls_007">out</span><span class="cls_004"> output of Glibc, but not the</span><span class="cls_007"> bin</span><span class="cls_004"> and</span><span class="cls_007"> dev</span><span class="cls_004"> outputs.  Thus, when we run the garbage</span></div>
<div style="position:absolute;left:63.87px;top:499.34px" class="cls_004"><span class="cls_004">collector, those outputs will be deleted (if they were present to begin with). Suppose that</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">we subsequently build a derivation that has a dependency on (say) the</span><span class="cls_007"> bin</span><span class="cls_004"> output of Glibc.</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">Unless we have a substitute that builds that path, we now have an unsolvable problem. The</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">only way that we can obtain the path without a substitute is to build Glibc. But the Glibc</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">build would overwrite its own</span><span class="cls_007"> out</span><span class="cls_004"> output, which is already valid, and thus should never be</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">modified. (If the overwriting is atomic or otherwise unobservable, there is no problem, but</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">that is not the case in general.) So we need to delete the</span><span class="cls_007"> out</span><span class="cls_004"> output first. But to delete it</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">violates the closure invariant, as that path is reachable from a user environment. So the Nix</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">161</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:115230px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background170.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">store is “jammed”: we have reached a state where a build simply cannot be done because</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">it is blocked by the validity of some of its outputs.</span></div>
<div style="position:absolute;left:69.68px;top:69.13px" class="cls_004"><span class="cls_004">In the intensional model, this problem does not exist.  A build can always be done,</span></div>
<div style="position:absolute;left:59.72px;top:81.09px" class="cls_004"><span class="cls_004">because the outputs go to temporary paths that are constructed on the fly. We can simply</span></div>
<div style="position:absolute;left:59.72px;top:93.04px" class="cls_004"><span class="cls_004">perform a build to obtain all of its outputs in temporary paths, copy the missing outputs to</span></div>
<div style="position:absolute;left:59.72px;top:105.00px" class="cls_004"><span class="cls_004">content-addressed locations, and discard the outputs that we already have. In the example</span></div>
<div style="position:absolute;left:59.72px;top:116.95px" class="cls_004"><span class="cls_004">above, we perform a full build of Glibc. The outputs end up in temporary paths p</span><span class="cls_012"><sub>out</sub></span><span class="cls_004"> , p</span><span class="cls_012"><sub>dev</sub></span><span class="cls_004">,</span></div>
<div style="position:absolute;left:59.72px;top:127.75px" class="cls_004"><span class="cls_004">and p</span><span class="cls_012"><sub>bin</sub></span><span class="cls_004">. We finalise the previously missing outputs p</span><span class="cls_012"><sub>dev</sub></span><span class="cls_004"> and p</span><span class="cls_012"><sub>bin</sub></span><span class="cls_004"> using</span><span class="cls_007"> addToStore</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, and</span></div>
<div style="position:absolute;left:59.72px;top:140.86px" class="cls_004"><span class="cls_004">discard p</span><span class="cls_012"><sub>out</sub></span><span class="cls_004">  as we already have it. The FSOs in p</span><span class="cls_012"><sub>dev</sub></span><span class="cls_004"> and p</span><span class="cls_012"><sub>bin</sub></span><span class="cls_004"> might have references to</span></div>
<div style="position:absolute;left:60.46px;top:152.82px" class="cls_004"><span class="cls_004">p</span><span class="cls_012"><sub>out</sub></span><span class="cls_004">, but those can be rewritten to the path of the</span><span class="cls_007"> out</span><span class="cls_004"> output that we already had.</span></div>
<div style="position:absolute;left:69.68px;top:164.95px" class="cls_004"><span class="cls_004">The outputs of a derivation can have references to each other, and in fact this is quite</span></div>
<div style="position:absolute;left:59.72px;top:176.91px" class="cls_004"><span class="cls_004">common.  For instance, it can be expected that the programs in the</span><span class="cls_007"> bin</span><span class="cls_004"> output of Glibc</span></div>
<div style="position:absolute;left:59.72px;top:188.86px" class="cls_004"><span class="cls_004">depend on the libraries in the</span><span class="cls_007"> out</span><span class="cls_004"> output. This means that the</span><span class="cls_007"> out</span><span class="cls_004"> output is in the closure</span></div>
<div style="position:absolute;left:59.72px;top:200.82px" class="cls_004"><span class="cls_004">of the</span><span class="cls_007"> bin</span><span class="cls_004"> output, but not vice versa. But what happens when there are mutually recursive</span></div>
<div style="position:absolute;left:59.72px;top:212.77px" class="cls_004"><span class="cls_004">references, e.g., when</span><span class="cls_007"> out</span><span class="cls_004"> also refers to</span><span class="cls_007"> bin</span><span class="cls_004">?  These must be forbidden, since the hash</span></div>
<div style="position:absolute;left:59.72px;top:224.73px" class="cls_004"><span class="cls_004">rewriting scheme from Section 6.3.2 cannot handle them. For instance, when we copy</span><span class="cls_007"> out</span></div>
<div style="position:absolute;left:59.72px;top:236.69px" class="cls_004"><span class="cls_004">and</span><span class="cls_007"> bin</span><span class="cls_004"> to their content-addressable locations, we must rewrite in both FSOs the hashes</span></div>
<div style="position:absolute;left:59.72px;top:248.64px" class="cls_004"><span class="cls_004">of both paths. The function</span><span class="cls_007"> hashModulo</span><span class="cls_004"> only handles direct self-references, and it can do</span></div>
<div style="position:absolute;left:59.72px;top:260.60px" class="cls_004"><span class="cls_004">so because the hashes to be disregarded in the hash computation are encoded into the file</span></div>
<div style="position:absolute;left:59.72px;top:272.55px" class="cls_004"><span class="cls_004">name.</span></div>
<div style="position:absolute;left:69.68px;top:284.69px" class="cls_004"><span class="cls_004">Fortunately, banning mutually recursive outputs is not a very onerous restriction, since</span></div>
<div style="position:absolute;left:59.72px;top:296.64px" class="cls_004"><span class="cls_004">they are pointless. After all, mutual recursion between output paths requires them to be</span></div>
<div style="position:absolute;left:59.72px;top:308.60px" class="cls_004"><span class="cls_004">deployed and garbage collected as a unit, negating the granularity advantages that multiple</span></div>
<div style="position:absolute;left:59.72px;top:320.55px" class="cls_004"><span class="cls_004">outputs are intended to achieve.</span></div>
<div style="position:absolute;left:59.72px;top:352.23px" class="cls_011"><span class="cls_011">6.8. Assumptions about components</span></div>
<div style="position:absolute;left:59.72px;top:377.79px" class="cls_004"><span class="cls_004">It is useful to make explicit at this point what assumptions Nix makes about compo-</span></div>
<div style="position:absolute;left:59.72px;top:389.74px" class="cls_004"><span class="cls_004">nents, i.e., the requirements imposed on components in order to allow them to be deployed</span></div>
<div style="position:absolute;left:59.72px;top:401.70px" class="cls_004"><span class="cls_004">through Nix. These assumptions are:</span></div>
<div style="position:absolute;left:74.66px;top:422.17px" class="cls_004"><span class="cls_004">• The component can be built with and installed at an arbitrary prefix. Counterexample</span></div>
<div style="position:absolute;left:84.62px;top:434.12px" class="cls_004"><span class="cls_004">of a component that violates this assumption: some Linux system components have</span></div>
<div style="position:absolute;left:84.62px;top:446.08px" class="cls_004"><span class="cls_004">Makefiles that contain “hard-coded” paths such as</span><span class="cls_007"> /lib</span><span class="cls_004">. (Such Makefiles are easily</span></div>
<div style="position:absolute;left:84.62px;top:458.03px" class="cls_004"><span class="cls_004">patched, though.)</span></div>
<div style="position:absolute;left:74.66px;top:478.68px" class="cls_004"><span class="cls_004">• Likewise, the component does not expect that its dependencies are installed at certain</span></div>
<div style="position:absolute;left:84.62px;top:490.64px" class="cls_004"><span class="cls_004">fixed locations, and the locations of the dependencies can instead be specified at</span></div>
<div style="position:absolute;left:84.62px;top:502.59px" class="cls_004"><span class="cls_004">build or runtime.  Counterexample: the GNU C Library, Glibc, has a hard-coded</span></div>
<div style="position:absolute;left:84.62px;top:514.55px" class="cls_004"><span class="cls_004">dependency on the POSIX shell in</span><span class="cls_007"> /bin/sh</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:74.66px;top:535.20px" class="cls_004"><span class="cls_004">• The component can be built automatically, i.e., with no user interaction whatsoever.</span></div>
<div style="position:absolute;left:84.62px;top:547.16px" class="cls_004"><span class="cls_004">Counterexample:  the Unreal Tournament 2004 Demo has an interactive installer</span></div>
<div style="position:absolute;left:84.62px;top:559.11px" class="cls_004"><span class="cls_004">that among other things asks the user to approve a license agreement. (Nevertheless</span></div>
<div style="position:absolute;left:84.62px;top:571.07px" class="cls_004"><span class="cls_004">it is in Nixpkgs, since we can bypass the installer by unpacking the TAR archive</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">embedded in the installer’s executable.)</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">162</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:115920px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background171.jpg" width=481 height=680></div>
<div style="position:absolute;left:274.95px;top:17.14px" class="cls_004"><span class="cls_004">6.8. Assumptions about components</span></div>
<div style="position:absolute;left:78.82px;top:45.04px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:45.04px" class="cls_004"><span class="cls_004">The build process of the component is essentially pure (i.e., deterministic), mean-</span></div>
<div style="position:absolute;left:88.78px;top:56.99px" class="cls_004"><span class="cls_004">ing that the output of the build process is fully determined by the declared inputs.</span></div>
<div style="position:absolute;left:88.78px;top:68.95px" class="cls_004"><span class="cls_004">Counterexample: any builder that depends on a mutable network resource. This is</span></div>
<div style="position:absolute;left:88.78px;top:80.90px" class="cls_004"><span class="cls_004">why</span><span class="cls_007"> fetchurl</span><span class="cls_004"> checks the downloaded file against a pre-specified cryptographic hash.</span></div>
<div style="position:absolute;left:88.78px;top:92.86px" class="cls_004"><span class="cls_004">Another counterexample: the archiving tool for object files (</span><span class="cls_007">ar</span><span class="cls_004">) on Mac OS X stores</span></div>
<div style="position:absolute;left:88.78px;top:104.82px" class="cls_004"><span class="cls_004">timestamps in archives, and these must not be newer than the timestamp on the</span></div>
<div style="position:absolute;left:88.78px;top:116.77px" class="cls_004"><span class="cls_004">archive itself; otherwise, the linker will refuse to use the archive. (Since Nix canoni-</span></div>
<div style="position:absolute;left:88.78px;top:128.73px" class="cls_004"><span class="cls_004">calises timestamps to 1970 through</span><span class="cls_007"> canonicalisePathContents</span><span class="cls_004"> (page 112), i.e., back</span></div>
<div style="position:absolute;left:88.78px;top:140.68px" class="cls_004"><span class="cls_004">in time, this is not a problem.)</span></div>
<div style="position:absolute;left:78.82px;top:160.61px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:160.61px" class="cls_004"><span class="cls_004">The component does not need to be modified after it has been built, e.g., at runtime.</span></div>
<div style="position:absolute;left:88.78px;top:172.56px" class="cls_004"><span class="cls_004">Counterexample: Firefox 1.0 needs to be run interactively with write permission</span></div>
<div style="position:absolute;left:88.78px;top:184.52px" class="cls_004"><span class="cls_004">to its installation directories so that it can create some additional files.</span></div>
<div style="position:absolute;left:380.89px;top:184.52px" class="cls_004"><span class="cls_004">(However,</span></div>
<div style="position:absolute;left:88.78px;top:196.47px" class="cls_004"><span class="cls_004">there is an obscure, poorly documented solution for this that allows these files to be</span></div>
<div style="position:absolute;left:88.78px;top:208.43px" class="cls_004"><span class="cls_004">generated non-interactively.)</span></div>
<div style="position:absolute;left:78.82px;top:228.35px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:228.35px" class="cls_004"><span class="cls_004">The component has no environment dependencies.  For instance, the component</span></div>
<div style="position:absolute;left:88.78px;top:240.31px" class="cls_004"><span class="cls_004">should not require global registry settings. It is however fine to use automatically</span></div>
<div style="position:absolute;left:88.78px;top:252.26px" class="cls_004"><span class="cls_004">created per-user configuration files or state.  In other words, it should not be nec-</span></div>
<div style="position:absolute;left:88.78px;top:264.22px" class="cls_004"><span class="cls_004">essary to run a program to realise the required environment; the closure in the Nix</span></div>
<div style="position:absolute;left:88.78px;top:276.17px" class="cls_004"><span class="cls_004">store should be the only dependency. Counterexample: system daemons (server pro-</span></div>
<div style="position:absolute;left:88.78px;top:288.13px" class="cls_004"><span class="cls_004">cesses) that require the existence of certain user accounts.</span></div>
<div style="position:absolute;left:78.82px;top:308.05px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:308.05px" class="cls_004"><span class="cls_004">Retained dependencies can be found in the component through scanning by</span><span class="cls_007"> scan-</span></div>
<div style="position:absolute;left:88.78px;top:320.01px" class="cls_007"><span class="cls_007">ForReferences</span><span class="cls_004">. There is no pointer hiding.</span></div>
<div style="position:absolute;left:73.84px;top:339.93px" class="cls_004"><span class="cls_004">The intensional model makes one additional assumption:</span></div>
<div style="position:absolute;left:78.82px;top:361.85px" class="cls_004"><span class="cls_004">• Hash rewriting does not change the semantics of the component. For instance, the</span></div>
<div style="position:absolute;left:88.78px;top:373.81px" class="cls_004"><span class="cls_004">component has no internal checksums that are invalidated by hash rewriting.</span></div>
<div style="position:absolute;left:73.84px;top:395.72px" class="cls_004"><span class="cls_004">If these assumptions hold for a component, then it can be deployed through Nix.  Of</span></div>
<div style="position:absolute;left:63.87px;top:407.68px" class="cls_004"><span class="cls_004">course, this raises the obvious question of whether these assumptions are likely to hold for</span></div>
<div style="position:absolute;left:63.87px;top:419.63px" class="cls_004"><span class="cls_004">components in practice. In the next chapter, we will see that this is indeed the case.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">163</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:116610px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background172.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">6. The Intensional Model</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">164</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:117300px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background173.jpg" width=481 height=680></div>
<div style="position:absolute;left:212.11px;top:211.75px" class="cls_006"><span class="cls_006">Part III.</span></div>
<div style="position:absolute;left:176.09px;top:257.85px" class="cls_010"><span class="cls_010">Applications</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">165</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:117990px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background174.jpg" width=481 height=680></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:117990px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background175.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:88.81px" class="cls_006"><span class="cls_006">7. Software Deployment</span></div>
<div style="position:absolute;left:63.87px;top:128.46px" class="cls_004"><span class="cls_004">The purpose of the Nix system is to support software deployment.  In Part II we have</span></div>
<div style="position:absolute;left:63.87px;top:140.42px" class="cls_004"><span class="cls_004">seen the low-level mechanisms necessary to support deployment. This chapter deals with</span></div>
<div style="position:absolute;left:63.87px;top:152.37px" class="cls_004"><span class="cls_004">the higher-level mechanisms and actual policies that enable support for a wide range of</span></div>
<div style="position:absolute;left:63.87px;top:164.33px" class="cls_004"><span class="cls_004">deployment scenarios. It also serves as validation for the Nix approach, since as we have</span></div>
<div style="position:absolute;left:63.87px;top:176.28px" class="cls_004"><span class="cls_004">just seen in Section 6.8, Nix makes a number of assumptions about components that may</span></div>
<div style="position:absolute;left:63.87px;top:188.24px" class="cls_004"><span class="cls_004">not always hold in practice. To discover to what extent these assumptions are valid, we</span></div>
<div style="position:absolute;left:63.87px;top:200.19px" class="cls_004"><span class="cls_004">have applied Nix to the deployment of a large set of pre-existing software components, the</span></div>
<div style="position:absolute;left:63.87px;top:212.15px" class="cls_004"><span class="cls_004">Nix Packages collection.</span></div>
<div style="position:absolute;left:73.84px;top:224.10px" class="cls_004"><span class="cls_004">This chapter first discusses the Nix Packages collection and the design principles that</span></div>
<div style="position:absolute;left:63.87px;top:236.06px" class="cls_004"><span class="cls_004">went into it, as these are instructive for the use of Nix in general.</span></div>
<div style="position:absolute;left:73.84px;top:248.01px" class="cls_004"><span class="cls_004">Second, it shows concrete “high-level” deployment mechanisms. The</span><span class="cls_007"> nix-pull</span><span class="cls_004"> mecha-</span></div>
<div style="position:absolute;left:63.87px;top:259.97px" class="cls_004"><span class="cls_004">nism is built on top of the low-level substitute mechanism to enable a variety of deployment</span></div>
<div style="position:absolute;left:63.87px;top:271.92px" class="cls_004"><span class="cls_004">policies, such as channels and one-click installations.  User environments are “pseudo-</span></div>
<div style="position:absolute;left:63.87px;top:283.88px" class="cls_004"><span class="cls_004">components” that are constructed automatically by</span><span class="cls_007"> nix-env</span><span class="cls_004"> to activate components.</span></div>
<div style="position:absolute;left:73.84px;top:295.83px" class="cls_004"><span class="cls_004">Third, Nix’s purely functional model creates some unique challenges in supporting the</span></div>
<div style="position:absolute;left:63.87px;top:307.79px" class="cls_004"><span class="cls_004">evolution of software installations over time.  For instance, users will want to periodi-</span></div>
<div style="position:absolute;left:63.87px;top:319.74px" class="cls_004"><span class="cls_004">cally upgrade software components. In a binary deployment policy, it is undesirable if all</span></div>
<div style="position:absolute;left:63.87px;top:331.70px" class="cls_004"><span class="cls_004">changed components must be re-downloaded in their entirety, particularly because in the</span></div>
<div style="position:absolute;left:63.87px;top:343.65px" class="cls_004"><span class="cls_004">purely functional model all dependent components change as well. Section 7.5 shows that</span></div>
<div style="position:absolute;left:63.87px;top:355.61px" class="cls_004"><span class="cls_004">this problem can be ameliorated using binary patching.</span></div>
<div style="position:absolute;left:73.84px;top:367.56px" class="cls_004"><span class="cls_004">Finally, Section 7.6 compares Nix to other deployment systems, and to techniques that</span></div>
<div style="position:absolute;left:63.87px;top:379.52px" class="cls_004"><span class="cls_004">might be used to implement deployment.</span></div>
<div style="position:absolute;left:63.87px;top:409.58px" class="cls_011"><span class="cls_011">7.1. The Nix Packages collection</span></div>
<div style="position:absolute;left:63.87px;top:434.80px" class="cls_004"><span class="cls_004">As we have seen in Chapter 2, the Nix Packages collection (Nixpkgs) is a set of Nix ex-</span></div>
<div style="position:absolute;left:63.87px;top:446.76px" class="cls_004"><span class="cls_004">pressions that evaluate to derivations for a large set of pre-existing, third-party software</span></div>
<div style="position:absolute;left:63.87px;top:457.68px" class="cls_004"><span class="cls_004">components. Figure 7.1 shows 278 components for which Nixpkgs contains expressions</span><span class="cls_012"><sup>1</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:470.67px" class="cls_004"><span class="cls_004">For some of the components, Nixpkgs provides multiple versions. In general, we endeav-</span></div>
<div style="position:absolute;left:63.87px;top:482.62px" class="cls_004"><span class="cls_004">our to standardise on a single version of a component within a given release of Nixpkgs,</span></div>
<div style="position:absolute;left:63.87px;top:494.58px" class="cls_004"><span class="cls_004">but this is not always possible. For instance, several versions of the GNU C Compiler are</span></div>
<div style="position:absolute;left:63.87px;top:506.53px" class="cls_004"><span class="cls_004">necessary because there is no single version of the compiler that can build all components.</span></div>
<div style="position:absolute;left:63.87px;top:518.49px" class="cls_004"><span class="cls_004">Also, some library components have major revisions that are not backwards compatible</span></div>
<div style="position:absolute;left:63.87px;top:530.44px" class="cls_004"><span class="cls_004">(e.g., versions 1 and 2 of the GUI library GTK). Of course, the great thing about the Nix</span></div>
<div style="position:absolute;left:63.87px;top:542.40px" class="cls_004"><span class="cls_004">expression language is that it makes it so easy to deal with this kind of variability.</span></div>
<div style="position:absolute;left:73.84px;top:554.35px" class="cls_004"><span class="cls_004">The components in Nixpkgs are a reasonable cross section of the universe of Unix soft-</span></div>
<div style="position:absolute;left:63.87px;top:566.31px" class="cls_004"><span class="cls_004">ware components, though with a bias towards open source components. This is because</span></div>
<div style="position:absolute;left:68.36px;top:584.11px" class="cls_013"><span class="cls_013"><sup>1</sup></span><span class="cls_014">This set is based on</span><span class="cls_016"> nixpkgs-0.9pre3415</span><span class="cls_014">.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">167</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:118680px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background176.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:63.10px;top:46.11px" class="cls_036"><span class="cls_036">a52dec acrobat-reader alsa-lib ant-blackdown ant-j2sdk apache-httpd aterm aterm-dynamic aterm-</span></div>
<div style="position:absolute;left:63.10px;top:57.07px" class="cls_036"><span class="cls_036">java atk audiofile autoconf automake bash bibtex-tools binutils bison bittorrent blackdown boehm-</span></div>
<div style="position:absolute;left:63.10px;top:68.02px" class="cls_036"><span class="cls_036">gc bsdiff bzip2 cdparanoia chmlib cil cksfv clisp coreutils cua-mode curl db4 diffutils docbook-</span></div>
<div style="position:absolute;left:63.10px;top:78.98px" class="cls_036"><span class="cls_036">xml docbook-xml-ebnf docbook-xsl e2fsprogs eclipse-sdk ed emacs enscript esound exif expat</span></div>
<div style="position:absolute;left:63.10px;top:89.94px" class="cls_036"><span class="cls_036">file findutils firefox flac flashplayer flex fontconfig freetype f-spot gail gawk gcc gcc-static GConf</span></div>
<div style="position:absolute;left:63.10px;top:100.90px" class="cls_036"><span class="cls_036">gdk-pixbuf generator getopt gettext ghc ghostscript glib glibc gnet gnome-desktop gnome-icon-</span></div>
<div style="position:absolute;left:63.10px;top:111.86px" class="cls_036"><span class="cls_036">theme gnome-keyring gnome-mime-data gnome-panel gnome-vfs gnugrep gnum4 gnumake gnu-</span></div>
<div style="position:absolute;left:63.10px;top:122.82px" class="cls_036"><span class="cls_036">patch gnuplot gnused gnutar gperf gqview graphviz grub gtk+ gtkhtml gtkmozembed-sharp gtk-</span></div>
<div style="position:absolute;left:63.10px;top:133.78px" class="cls_036"><span class="cls_036">sharp gtksourceview gtksourceview-sharp guile gwydion-dylan gzip happy harp haskell-mode he-</span></div>
<div style="position:absolute;left:63.10px;top:144.74px" class="cls_036"><span class="cls_036">lium hello help2man hevea intltool iputils j2sdk jakarta-bcel jakarta-regexp jakarta-tomcat jclasslib</span></div>
<div style="position:absolute;left:63.10px;top:155.70px" class="cls_036"><span class="cls_036">jdk jetty jikes jing-tools jjtraveler jre kaffe lame lcms lcov less libart_lgpl libbonobo libbonoboui</span></div>
<div style="position:absolute;left:63.10px;top:166.65px" class="cls_036"><span class="cls_036">libcdaudio libdvdcss libdvdplay libdvdread libexif libglade libgnome libgnomecanvas libgnomeprint</span></div>
<div style="position:absolute;left:63.10px;top:177.61px" class="cls_036"><span class="cls_036">libgnomeprintui libgnomeui libgphoto2 libgtkhtml libICE libIDL libjpeg libmad libogg libpng lib-</span></div>
<div style="position:absolute;left:63.10px;top:188.57px" class="cls_036"><span class="cls_036">sigsegv libSM libtheora libtiff libtool libvorbis libwnck libX11 libXau libXaw libXext libXft libXi libX-</span></div>
<div style="position:absolute;left:63.10px;top:199.53px" class="cls_036"><span class="cls_036">inerama libxml2 libXmu libXp libXpm libXrender libxslt libXt libXtrans libXv libXxf86vm lynx mesa</span></div>
<div style="position:absolute;left:63.10px;top:210.49px" class="cls_036"><span class="cls_036">mingetty mjpegtools mktemp modutils mono monodevelop mono-dll-fixer monodoc mpeg2dec</span></div>
<div style="position:absolute;left:63.10px;top:221.45px" class="cls_036"><span class="cls_036">MPlayer mplayerplug-in mysql mythtv nano nasm ncurses net-tools nix nmap nxml-mode ocaml</span></div>
<div style="position:absolute;left:63.10px;top:232.41px" class="cls_036"><span class="cls_036">octave openssh openssl ORBit2 pan pango panoramixext par2cmdline patchelf pcre perl perl-</span></div>
<div style="position:absolute;left:63.10px;top:243.37px" class="cls_036"><span class="cls_036">BerkeleyDB  perl-DateManip  perl-HTML-Parser  perl-HTML-Tagset  perl-HTML-Tree  perl-libwww-</span></div>
<div style="position:absolute;left:63.10px;top:254.33px" class="cls_036"><span class="cls_036">perl perl-LocaleGettext perl-TermReadKey perl-URI perl-XML-LibXML perl-XML-LibXML-Common</span></div>
<div style="position:absolute;left:63.10px;top:265.28px" class="cls_036"><span class="cls_036">perl-XML-NamespaceSupport perl-XML-Parser perl-XML-SAX perl-XML-Simple perl-xmltv perl-</span></div>
<div style="position:absolute;left:63.10px;top:276.24px" class="cls_036"><span class="cls_036">XML-Twig  perl-XML-Writer  pkgconfig  popt  postgresql  postgresql-jdbc  procps  pygtk  python  qt</span></div>
<div style="position:absolute;left:63.10px;top:287.20px" class="cls_036"><span class="cls_036">quake3demo rcs readline RealPlayer renderext rte ruby saxon saxonb screen scrollkeeper sdf2-</span></div>
<div style="position:absolute;left:63.10px;top:298.16px" class="cls_036"><span class="cls_036">bundle SDL shadow shared-objects sqlite stdenv-linux strace strategoxt strategoxt-utils subversion</span></div>
<div style="position:absolute;left:63.10px;top:309.12px" class="cls_036"><span class="cls_036">swig sylpheed sysvinit tetex texinfo thunderbird uml uml-utilities unzip ut2004demo util-linux valgrind</span></div>
<div style="position:absolute;left:63.10px;top:320.08px" class="cls_036"><span class="cls_036">vim vlc wget which wxGTK wxPython xchm xextensions xf86vmext xfree86 xine-lib xine-ui xlib xpf</span></div>
<div style="position:absolute;left:63.10px;top:331.04px" class="cls_036"><span class="cls_036">xproto xsel zapping zdelta zip zlib zoom zvbi</span></div>
<div style="position:absolute;left:127.56px;top:352.04px" class="cls_004"><span class="cls_004">Figure 7.1.: Components in the Nix Packages collection</span></div>
<div style="position:absolute;left:59.72px;top:384.86px" class="cls_004"><span class="cls_004">these components are most readily available, and allow third-party use and confirmation</span></div>
<div style="position:absolute;left:59.72px;top:396.82px" class="cls_004"><span class="cls_004">of our results. However, some binary-only components are also included, such as Adobe</span></div>
<div style="position:absolute;left:59.72px;top:408.77px" class="cls_004"><span class="cls_004">Reader, Real Player, Sun’s Java 2 SDK, and the Unreal Tournament 2004 Demo. How we</span></div>
<div style="position:absolute;left:59.72px;top:420.73px" class="cls_004"><span class="cls_004">support such components is discussed in Section 7.1.4.</span></div>
<div style="position:absolute;left:69.68px;top:433.07px" class="cls_004"><span class="cls_004">In terms of application areas, the set of components spans a wide spectrum:</span></div>
<div style="position:absolute;left:74.66px;top:454.16px" class="cls_004"><span class="cls_004">• Fundamental tools and libraries (Glibc, GCC, Binutils, Bash, Coreutils, Make, ...).</span></div>
<div style="position:absolute;left:74.66px;top:475.64px" class="cls_004"><span class="cls_004">• Other compilers and interpreters (Perl, Python, Mono, Sun’s Java 2 JDK, ...).</span></div>
<div style="position:absolute;left:74.66px;top:497.11px" class="cls_004"><span class="cls_004">• GUI libraries (X11 client libraries, GTK, Qt, ...).</span></div>
<div style="position:absolute;left:74.66px;top:518.59px" class="cls_004"><span class="cls_004">• Other libraries (Berkeley DB,</span><span class="cls_007"> libxml</span><span class="cls_004">, SDL, and many more).</span></div>
<div style="position:absolute;left:74.66px;top:540.07px" class="cls_004"><span class="cls_004">• Developer tools (Eclipse, Emacs, Valgrind, Subversion, Autoconf, Bison, ...).</span></div>
<div style="position:absolute;left:74.66px;top:561.55px" class="cls_004"><span class="cls_004">• Non-developer tools (teTeX, NMap, ...)</span></div>
<div style="position:absolute;left:74.66px;top:583.02px" class="cls_004"><span class="cls_004">• Servers (Apache</span><span class="cls_007"> httpd</span><span class="cls_004">, PostgreSQL, MySQL, Jetty, ...).</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">168</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:119370px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background177.jpg" width=481 height=680></div>
<div style="position:absolute;left:288.13px;top:17.14px" class="cls_004"><span class="cls_004">7.1. The Nix Packages collection</span></div>
<div style="position:absolute;left:78.82px;top:45.04px" class="cls_004"><span class="cls_004">• End-user applications (Firefox, Xine, Gaim, UT2004, ...).</span></div>
<div style="position:absolute;left:73.84px;top:63.31px" class="cls_004"><span class="cls_004">Likewise, several programming languages are represented, including C, C++, Java, C#,</span></div>
<div style="position:absolute;left:63.87px;top:75.27px" class="cls_004"><span class="cls_004">Haskell, Perl, Python, and OCaml.</span></div>
<div style="position:absolute;left:73.84px;top:87.22px" class="cls_004"><span class="cls_004">Nixpkgs does not contain any of these components itself; it only contains Nix expres-</span></div>
<div style="position:absolute;left:63.87px;top:99.18px" class="cls_004"><span class="cls_004">sions and builders. The source or binary distribution files for the components are obtained</span></div>
<div style="position:absolute;left:63.87px;top:111.13px" class="cls_004"><span class="cls_004">using</span><span class="cls_007"> fetchurl</span><span class="cls_004"> calls. This is a policy decision; it is perfectly possible to include these files</span></div>
<div style="position:absolute;left:63.87px;top:123.09px" class="cls_004"><span class="cls_004">in the Nixpkgs distribution itself—but that would make a Nixpkgs download several hun-</span></div>
<div style="position:absolute;left:63.87px;top:135.04px" class="cls_004"><span class="cls_004">dreds of MiBs large (not to mention that it might violate several licenses).</span></div>
<div style="position:absolute;left:73.84px;top:147.00px" class="cls_004"><span class="cls_004">Nixpkgs is severely biased towards Linux-based systems. Many of the components in</span></div>
<div style="position:absolute;left:63.87px;top:158.95px" class="cls_004"><span class="cls_004">Nixpkgs also build on other Unix-based operating systems, such as FreeBSD and Mac</span></div>
<div style="position:absolute;left:63.87px;top:170.91px" class="cls_004"><span class="cls_004">OS X, but as we shall see in Section 7.1.2, the standard environment on Linux is far supe-</span></div>
<div style="position:absolute;left:63.87px;top:182.86px" class="cls_004"><span class="cls_004">rior to those on other platforms as it produces components that do not require any external</span></div>
<div style="position:absolute;left:63.87px;top:194.82px" class="cls_004"><span class="cls_004">(non-Nix) components to build or run. For instance, it uses its own copy of the GNU C</span></div>
<div style="position:absolute;left:63.87px;top:206.77px" class="cls_004"><span class="cls_004">Library (Glibc). In addition, to build the standard environment on Linux, no external com-</span></div>
<div style="position:absolute;left:63.87px;top:218.73px" class="cls_004"><span class="cls_004">ponents are needed, i.e., it is fully self-contained. Significantly, this means that Nixpkgs</span></div>
<div style="position:absolute;left:63.87px;top:230.68px" class="cls_004"><span class="cls_004">on Linux is almost perfectly insulated from the “host” operating system. A component that</span></div>
<div style="position:absolute;left:63.87px;top:242.64px" class="cls_004"><span class="cls_004">builds and runs on, say, Red Hat Enterprise Linux, will also build and run on SuSE Linux.</span></div>
<div style="position:absolute;left:73.84px;top:254.59px" class="cls_004"><span class="cls_004">This bias towards Linux is not the result of any fundamental aspect of Nix, but rather is</span></div>
<div style="position:absolute;left:63.87px;top:266.55px" class="cls_004"><span class="cls_004">triggered by two important considerations:</span></div>
<div style="position:absolute;left:78.82px;top:283.80px" class="cls_004"><span class="cls_004">• The fundamental components of Linux systems</span><span class="cls_012"><sup>2</sup></span><span class="cls_004"> are all open source.  This makes</span></div>
<div style="position:absolute;left:88.78px;top:296.78px" class="cls_004"><span class="cls_004">them much more useful for experimentation and adaptation than closed-source com-</span></div>
<div style="position:absolute;left:88.78px;top:308.73px" class="cls_004"><span class="cls_004">ponents. In contrast, in Mac OS X, many fundamental components (such as the GUI</span></div>
<div style="position:absolute;left:88.78px;top:320.69px" class="cls_004"><span class="cls_004">libraries) are closed source, which means that we cannot build them in the Nix store.</span></div>
<div style="position:absolute;left:78.82px;top:339.79px" class="cls_004"><span class="cls_004">• Linux is highly component-based, much more than any other system, in the sense</span></div>
<div style="position:absolute;left:88.78px;top:351.74px" class="cls_004"><span class="cls_004">that the components that make up a Linux system are all separately maintained,</span></div>
<div style="position:absolute;left:88.78px;top:363.70px" class="cls_004"><span class="cls_004">built, and distributed. This is probably bad for users, as it creates a lack of vision</span></div>
<div style="position:absolute;left:88.78px;top:375.65px" class="cls_004"><span class="cls_004">and coordination between the various parts of the system, but it is very good for</span></div>
<div style="position:absolute;left:88.78px;top:387.61px" class="cls_004"><span class="cls_004">us.  Consider by contrast FreeBSD, which is also open source, but only available</span></div>
<div style="position:absolute;left:88.78px;top:399.56px" class="cls_004"><span class="cls_004">as a unified whole.  That is, components such as the kernel, C library, compiler,</span></div>
<div style="position:absolute;left:88.78px;top:411.52px" class="cls_004"><span class="cls_004">basic Unix tools, system administration tools, documentation, etc., are all part of a</span></div>
<div style="position:absolute;left:88.78px;top:423.47px" class="cls_004"><span class="cls_004">single distribution. This means that we cannot easily take out, say, the C library, and</span></div>
<div style="position:absolute;left:88.78px;top:435.43px" class="cls_004"><span class="cls_004">use it in our standard environment. Also, since Linux components must support a</span></div>
<div style="position:absolute;left:88.78px;top:447.38px" class="cls_004"><span class="cls_004">wide variability in the environments in which they are used, they are typically quite</span></div>
<div style="position:absolute;left:88.78px;top:459.34px" class="cls_004"><span class="cls_004">configurable. For instance, Glibc can be installed at a non-standard prefix. So Linux</span></div>
<div style="position:absolute;left:88.78px;top:471.29px" class="cls_004"><span class="cls_004">is a truly component-based system in the sense of components in Section 3.1.</span></div>
<div style="position:absolute;left:73.84px;top:489.57px" class="cls_004"><span class="cls_004">But again, other Unix systems are also supported, if in a somewhat less perfect state.</span></div>
<div style="position:absolute;left:63.87px;top:501.52px" class="cls_004"><span class="cls_004">The open source nature of Linux enables us to explore an “ideal”, uncompromising envi-</span></div>
<div style="position:absolute;left:63.87px;top:513.48px" class="cls_004"><span class="cls_004">ronment on Linux, where everything is deployed through Nix. On other systems, we have</span></div>
<div style="position:absolute;left:63.87px;top:525.43px" class="cls_004"><span class="cls_004">to allow a certain measure of impurity. For instance, components must use system libraries</span></div>
<div style="position:absolute;left:63.87px;top:537.39px" class="cls_004"><span class="cls_004">that are not built or deployed through Nix.</span></div>
<div style="position:absolute;left:68.36px;top:555.72px" class="cls_013"><span class="cls_013"><sup>2</sup></span><span class="cls_014">Of course, we cannot really speak of Linux systems in general, as Linux is just a kernel. There is no single</span></div>
<div style="position:absolute;left:75.83px;top:566.09px" class="cls_014"><span class="cls_014">component other than the kernel that is common to all Linux-based systems (not even Glibc!).  However,</span></div>
<div style="position:absolute;left:75.83px;top:575.55px" class="cls_014"><span class="cls_014">there is a fuzzy set of components that make up typical Linux environments, e.g., Glibc, GCC, Bash, GTK,</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">Qt, Gnome, KDE, and so on.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">169</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:120060px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background178.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:69.68px;top:45.04px" class="cls_004"><span class="cls_004">So what about non-Unix systems, in particular Microsoft Windows? I claimed in the</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">introduction that Nix does not require any operating system specific extensions, such as</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">virtual file systems (as used by, e.g., Zero Install [112]). But Nix does make one Unix-</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">centric assumption: that paths abstract over storage devices.  For binary deployment to</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">work, it is important that the store is in the same path between systems. That’s why we</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">more-or-less insist on using</span><span class="cls_007"> /nix/store</span><span class="cls_004">. On Unix, this fixed path is not a problem, because</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">the directory</span><span class="cls_007"> /nix</span><span class="cls_004"> can be mounted on any physical device. But on Windows, if we use a</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">path such as</span><span class="cls_007"> C:\nix\store</span><span class="cls_004">, we encode the device on which the store resides (e.g.,</span><span class="cls_007"> C:</span><span class="cls_004">) into</span></div>
<div style="position:absolute;left:59.72px;top:140.68px" class="cls_004"><span class="cls_004">the store location.  If another user uses</span><span class="cls_007"> D:\nix\store</span><span class="cls_004">, e.g., because her</span><span class="cls_007"> D:</span><span class="cls_004"> has sufficient</span></div>
<div style="position:absolute;left:59.72px;top:152.64px" class="cls_004"><span class="cls_004">free space, she cannot pull substitutes from a cache that assumes</span><span class="cls_007"> C:\nix\store</span><span class="cls_004">.  Thus we</span></div>
<div style="position:absolute;left:59.72px;top:164.59px" class="cls_004"><span class="cls_004">run afoul of Windows’s CP/M heritage. (This does not apply to Cygwin [88] or similar</span></div>
<div style="position:absolute;left:59.72px;top:176.55px" class="cls_004"><span class="cls_004">environments, which provide a Unix-like file system view on Windows.) However, it is a</span></div>
<div style="position:absolute;left:59.72px;top:187.48px" class="cls_004"><span class="cls_004">little-known feature that Windows also provides mount points</span><span class="cls_012"><sup>3</sup></span><span class="cls_004">, so this is in fact not a fatal</span></div>
<div style="position:absolute;left:59.72px;top:200.46px" class="cls_004"><span class="cls_004">problem.</span></div>
<div style="position:absolute;left:59.72px;top:228.40px" class="cls_008"><span class="cls_008">7.1.1. Principles</span></div>
<div style="position:absolute;left:59.72px;top:247.95px" class="cls_004"><span class="cls_004">There are a number of design principles guiding the construction of the components in</span></div>
<div style="position:absolute;left:59.72px;top:259.90px" class="cls_004"><span class="cls_004">Nixpkgs. The most important of these is the following:</span></div>
<div style="position:absolute;left:84.62px;top:279.95px" class="cls_004"><span class="cls_004">⇒ “Static compositions are good.”</span></div>
<div style="position:absolute;left:59.72px;top:299.99px" class="cls_004"><span class="cls_004">A static composition is one that is established at component build time. A dynamic com-</span></div>
<div style="position:absolute;left:59.72px;top:311.95px" class="cls_004"><span class="cls_004">position is one that is established at runtime, i.e., after the components have been built and</span></div>
<div style="position:absolute;left:59.72px;top:323.90px" class="cls_004"><span class="cls_004">deployed.</span></div>
<div style="position:absolute;left:69.68px;top:334.90px" class="cls_004"><span class="cls_004">Suppose that we have a component that needs to call a program</span><span class="cls_007"> foo</span><span class="cls_004">, provided by another</span></div>
<div style="position:absolute;left:59.72px;top:345.86px" class="cls_004"><span class="cls_004">component. Dynamic composition, or late binding, means that we expect that at runtime,</span></div>
<div style="position:absolute;left:59.72px;top:356.82px" class="cls_004"><span class="cls_004">we can find</span><span class="cls_007"> foo</span><span class="cls_004"> somewhere in the</span><span class="cls_007"> PATH</span><span class="cls_004"> environment variable, and so the composition</span></div>
<div style="position:absolute;left:59.72px;top:367.78px" class="cls_004"><span class="cls_004">mechanism in C might be:</span></div>
<div style="position:absolute;left:84.62px;top:388.10px" class="cls_015"><span class="cls_015">execlp("foo",args );</span></div>
<div style="position:absolute;left:69.68px;top:397.90px" class="cls_004"><span class="cls_004">In a static composition, on the other hand, the path of</span><span class="cls_007"> foo</span><span class="cls_004"> is already known at build time:</span></div>
<div style="position:absolute;left:84.62px;top:418.22px" class="cls_015"><span class="cls_015">execl("/nix/store/4sqiwbf0kj22...-foo-1.3.1/bin/foo",args );</span></div>
<div style="position:absolute;left:69.68px;top:428.03px" class="cls_004"><span class="cls_004">Of course, the path</span><span class="cls_007"> /nix/store/4sqiwbf0kj22...-foo-1.3.1</span><span class="cls_004"> would not be hard-coded into the</span></div>
<div style="position:absolute;left:59.72px;top:438.99px" class="cls_004"><span class="cls_004">source. Rather, the</span><span class="cls_007"> foo</span><span class="cls_004"> component should be given as an input to the derivation, and the</span></div>
<div style="position:absolute;left:59.72px;top:449.95px" class="cls_004"><span class="cls_004">path should be filled in by the preprocessor:</span></div>
<div style="position:absolute;left:84.62px;top:470.27px" class="cls_015"><span class="cls_015">execl(FOO_PATH  "/bin/foo",args );</span></div>
<div style="position:absolute;left:69.68px;top:481.07px" class="cls_004"><span class="cls_004">So why is the latter better? The answer is that it gives a more exact closure and more</span></div>
<div style="position:absolute;left:59.72px;top:493.02px" class="cls_004"><span class="cls_004">predictable runtime behaviour.  The component will always be able to call</span><span class="cls_007"> foo</span><span class="cls_004">, as it is</span></div>
<div style="position:absolute;left:59.72px;top:504.98px" class="cls_004"><span class="cls_004">contained in the component’s closure and so is always present. With dynamic composition,</span></div>
<div style="position:absolute;left:59.72px;top:516.93px" class="cls_007"><span class="cls_007">foo</span><span class="cls_004"> might be missing, or it might be a wrong version.</span></div>
<div style="position:absolute;left:69.68px;top:528.93px" class="cls_004"><span class="cls_004">An important example of the preference of static composition over dynamic composition</span></div>
<div style="position:absolute;left:59.72px;top:540.88px" class="cls_004"><span class="cls_004">is the style of linking used in Nixpkgs. Of course, the ultimate form of static composition is</span></div>
<div style="position:absolute;left:59.72px;top:552.84px" class="cls_004"><span class="cls_004">static libraries (which are linked into the images of the executables that use them), but those</span></div>
<div style="position:absolute;left:59.72px;top:564.79px" class="cls_004"><span class="cls_004">are inefficient. They waste disk space, memory, disk cache space, and memory cache lines.</span></div>
<div style="position:absolute;left:64.20px;top:584.11px" class="cls_013"><span class="cls_013"><sup>3</sup></span><span class="cls_014">In fact, MS-DOS 3.1 already provided a</span><span class="cls_016"> mount</span><span class="cls_014">-like command called</span><span class="cls_016"> JOIN</span><span class="cls_014">.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">170</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:120750px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background179.jpg" width=481 height=680></div>
<div style="position:absolute;left:288.13px;top:17.14px" class="cls_004"><span class="cls_004">7.1. The Nix Packages collection</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">So are we doomed to the dynamic composition risks of the alternative: dynamic linking?</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">In fact, as we have seen previously, this is not the case with Unix (ELF) style dynamic</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">libraries, as these also support static compositions through the</span><span class="cls_007"> RPATH</span><span class="cls_004">, which specifies a</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">search path for the dynamic linker.</span></div>
<div style="position:absolute;left:73.84px;top:92.86px" class="cls_004"><span class="cls_004">For instance, the Hello component in Chapter 2 contains in its executable image a direct</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">reference to the path of Glibc. Likewise, the Subversion component contains the paths of</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">its OpenSSL, Expat, Berkeley DB, Zlib, and Glibc dependencies. Thus, the Subversion</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">program can never fail to find its dependencies, and it can never accidentally link to the</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">wrong libraries at runtime. The latter is actually a substantial risk; it happens quite often</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">that users (when they manually compile software) have different versions of libraries in</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">different places (e.g.,</span><span class="cls_007"> /usr/lib</span><span class="cls_004"> and</span><span class="cls_007"> /usr/local/lib</span><span class="cls_004">) and that the library used at runtime does not</span></div>
<div style="position:absolute;left:63.87px;top:176.55px" class="cls_004"><span class="cls_004">match with what was detected at build time.</span></div>
<div style="position:absolute;left:73.84px;top:188.50px" class="cls_004"><span class="cls_004">Of course, static composition is at odds with the desire to change compositions later</span></div>
<div style="position:absolute;left:63.87px;top:200.46px" class="cls_004"><span class="cls_004">on. An advantage of dynamic linking over static linking is that dynamic libraries can be</span></div>
<div style="position:absolute;left:63.87px;top:212.41px" class="cls_004"><span class="cls_004">replaced with “better” versions, e.g., to fix bugs; and all dependent applications will then</span></div>
<div style="position:absolute;left:63.87px;top:224.37px" class="cls_004"><span class="cls_004">automatically use the new version. However, this provides two conflicting features:</span></div>
<div style="position:absolute;left:78.82px;top:242.67px" class="cls_004"><span class="cls_004">• The ability to fix dependent applications all at once.</span></div>
<div style="position:absolute;left:78.82px;top:261.79px" class="cls_004"><span class="cls_004">• The ability to break dependent applications all at once.</span></div>
<div style="position:absolute;left:63.87px;top:280.10px" class="cls_004"><span class="cls_004">Clearly there is some tension between these two.</span></div>
<div style="position:absolute;left:73.84px;top:292.05px" class="cls_004"><span class="cls_004">In the purely functional model, destructive upgrading is impossible by definition, and</span></div>
<div style="position:absolute;left:63.87px;top:304.01px" class="cls_004"><span class="cls_004">so this “all at once” semantics is simply not available. To deploy a new version of some</span></div>
<div style="position:absolute;left:63.87px;top:315.96px" class="cls_004"><span class="cls_004">shared component, it is necessary to redeploy Nix expressions of all installed components</span></div>
<div style="position:absolute;left:63.87px;top:327.92px" class="cls_004"><span class="cls_004">that depend on it.  This is expensive, but I feel that it is a worthwhile tradeoff against</span></div>
<div style="position:absolute;left:63.87px;top:339.87px" class="cls_004"><span class="cls_004">correctness. Section 7.5 will show how this kind of upgrading can be done with reasonable</span></div>
<div style="position:absolute;left:63.87px;top:351.83px" class="cls_004"><span class="cls_004">efficiency.</span></div>
<div style="position:absolute;left:88.78px;top:371.72px" class="cls_004"><span class="cls_004">⇒ “Static compositions are good. Late static compositions are better.”</span></div>
<div style="position:absolute;left:73.84px;top:391.61px" class="cls_004"><span class="cls_004">A late static composition is when composition is delayed to allow components to be</span></div>
<div style="position:absolute;left:63.87px;top:403.57px" class="cls_004"><span class="cls_004">reused between compositions.  Consider for instance the Mozilla Firefox component, a</span></div>
<div style="position:absolute;left:63.87px;top:415.53px" class="cls_004"><span class="cls_004">web browser. Firefox can be extended through several means. For instance, plugins are</span></div>
<div style="position:absolute;left:63.87px;top:427.48px" class="cls_004"><span class="cls_004">dynamically linked libraries that allow Firefox to handle additional MIME types, e.g.,</span></div>
<div style="position:absolute;left:63.87px;top:439.44px" class="cls_004"><span class="cls_004">Macromedia Flash files through the Flash Player plugin. We can establish the composition</span></div>
<div style="position:absolute;left:63.87px;top:451.39px" class="cls_004"><span class="cls_004">between Firefox and its plugins when we build Firefox. So its Nix expression will look</span></div>
<div style="position:absolute;left:63.87px;top:463.35px" class="cls_004"><span class="cls_004">like this:</span></div>
<div style="position:absolute;left:88.78px;top:485.91px" class="cls_015"><span class="cls_015">{stdenv,  fetchurl,  ...,  plugins  ?  []}:</span></div>
<div style="position:absolute;left:88.78px;top:496.87px" class="cls_015"><span class="cls_015">stdenv.mkDerivation  {  ...;</span></div>
<div style="position:absolute;left:98.19px;top:507.83px" class="cls_015"><span class="cls_015">inherit  plugins;</span></div>
<div style="position:absolute;left:88.78px;top:518.79px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:63.87px;top:531.84px" class="cls_004"><span class="cls_004">and its builder must somehow embed the paths of the plugins into the Firefox executable.</span></div>
<div style="position:absolute;left:63.87px;top:543.79px" class="cls_004"><span class="cls_004">Thus the call</span></div>
<div style="position:absolute;left:88.78px;top:566.36px" class="cls_015"><span class="cls_015">import  .../firefox.nix  {  ...</span></div>
<div style="position:absolute;left:98.19px;top:577.32px" class="cls_015"><span class="cls_015">plugins  =  [flashplayer  realplayer  MPlayer  java];</span></div>
<div style="position:absolute;left:88.78px;top:588.28px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">171</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:121440px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background180.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:248.80px;top:48.74px" class="cls_046"><span class="cls_046">firefox</span></div>
<div style="position:absolute;left:279.12px;top:48.74px" class="cls_046"><span class="cls_046">flashplayer</span></div>
<div style="position:absolute;left:318.68px;top:48.74px" class="cls_046"><span class="cls_046">realplayer</span></div>
<div style="position:absolute;left:356.03px;top:48.74px" class="cls_046"><span class="cls_046">MPlayer</span></div>
<div style="position:absolute;left:390.78px;top:48.74px" class="cls_046"><span class="cls_046">java</span></div>
<div style="position:absolute;left:77.26px;top:53.26px" class="cls_047"><span class="cls_047">flashplayer</span></div>
<div style="position:absolute;left:125.96px;top:53.26px" class="cls_047"><span class="cls_047">realplayer</span></div>
<div style="position:absolute;left:171.93px;top:53.26px" class="cls_047"><span class="cls_047">MPlayer</span></div>
<div style="position:absolute;left:214.71px;top:53.26px" class="cls_047"><span class="cls_047">java</span></div>
<div style="position:absolute;left:313.14px;top:75.36px" class="cls_046"><span class="cls_046">firefoxWrapper</span></div>
<div style="position:absolute;left:151.90px;top:86.03px" class="cls_047"><span class="cls_047">firefox</span></div>
<div style="position:absolute;left:240.11px;top:104.05px" class="cls_004"><span class="cls_004">Figure 7.3.: Late static Firefox composi-</span></div>
<div style="position:absolute;left:75.09px;top:110.28px" class="cls_004"><span class="cls_004">Figure 7.2.: Static Firefox composition</span></div>
<div style="position:absolute;left:288.82px;top:116.01px" class="cls_004"><span class="cls_004">tion</span></div>
<div style="position:absolute;left:59.72px;top:146.37px" class="cls_004"><span class="cls_004">yields the composition shown in Figure 7.2 (an arrow A → B denotes that A is an input of</span></div>
<div style="position:absolute;left:59.72px;top:158.32px" class="cls_004"><span class="cls_004">B). Now if we want to change the composition, e.g., add a new plugin, the entire Firefox</span></div>
<div style="position:absolute;left:59.72px;top:170.28px" class="cls_004"><span class="cls_004">component must be rebuilt, which takes an hour or so on current hardware.</span></div>
<div style="position:absolute;left:69.68px;top:181.43px" class="cls_004"><span class="cls_004">Figure 7.3 shows a better way through late static binding: the plugins are not composed</span></div>
<div style="position:absolute;left:59.72px;top:192.39px" class="cls_004"><span class="cls_004">with the Firefox component directly, but rather the composition is delayed and established</span></div>
<div style="position:absolute;left:59.72px;top:203.34px" class="cls_004"><span class="cls_004">in a Firefox wrapper component. A wrapper component is typically just a shell script that</span></div>
<div style="position:absolute;left:59.72px;top:214.30px" class="cls_004"><span class="cls_004">sets some environment variables, then calls the original (wrapped) program.  Thus, the</span></div>
<div style="position:absolute;left:59.72px;top:224.24px" class="cls_007"><span class="cls_007">firefoxWrapper</span><span class="cls_004"> component consists entirely of a shell script generated by its builder</span><span class="cls_012"><sup>4</sup></span><span class="cls_004">:</span></div>
<div style="position:absolute;left:84.62px;top:246.03px" class="cls_015"><span class="cls_015">#!  .../sh</span></div>
<div style="position:absolute;left:84.62px;top:256.99px" class="cls_015"><span class="cls_015">export  MOZ_PLUGIN_PATH=realplayer-path /lib/plugins:...</span></div>
<div style="position:absolute;left:84.62px;top:267.94px" class="cls_015"><span class="cls_015">exec  original-firefox-path /bin/firefox  "$@"</span></div>
<div style="position:absolute;left:69.68px;top:279.19px" class="cls_004"><span class="cls_004">Since the wrapper component can be generated very quickly, changing the composition</span></div>
<div style="position:absolute;left:59.72px;top:291.15px" class="cls_004"><span class="cls_004">is very cheap.</span></div>
<div style="position:absolute;left:69.68px;top:303.29px" class="cls_004"><span class="cls_004">Note that dynamic binding of the Firefox plugins requires the user to set the environment</span></div>
<div style="position:absolute;left:59.72px;top:315.25px" class="cls_004"><span class="cls_004">variable</span><span class="cls_007"> MOZ_PLUGIN_PATH</span><span class="cls_004"> manually prior to invoking the Firefox program. In the late</span></div>
<div style="position:absolute;left:59.72px;top:327.20px" class="cls_004"><span class="cls_004">static binding example, the variable is set by the wrapper script, which resides in the Nix</span></div>
<div style="position:absolute;left:59.72px;top:339.16px" class="cls_004"><span class="cls_004">store and is therefore part of the closure installed in the user environment.</span></div>
<div style="position:absolute;left:69.68px;top:351.30px" class="cls_004"><span class="cls_004">The terms (late) static binding and dynamic binding are orthogonal to the usual notions</span></div>
<div style="position:absolute;left:59.72px;top:363.25px" class="cls_004"><span class="cls_004">of early binding and dynamic or late binding in component-based development [154]. They</span></div>
<div style="position:absolute;left:59.72px;top:375.21px" class="cls_004"><span class="cls_004">are not about binding time relative to the deployment process, for either can be done at the</span></div>
<div style="position:absolute;left:59.72px;top:387.17px" class="cls_004"><span class="cls_004">deployer side and on the client side. They are about whether the composition is controlled</span></div>
<div style="position:absolute;left:59.72px;top:399.12px" class="cls_004"><span class="cls_004">(i.e., described by a self-contained store derivation that results in a self-contained closure)</span></div>
<div style="position:absolute;left:59.72px;top:411.08px" class="cls_004"><span class="cls_004">or uncontrolled (i.e., performed by means outside of the scope of Nix).</span></div>
<div style="position:absolute;left:84.62px;top:433.75px" class="cls_004"><span class="cls_004">⇒ “User environments are not a composition mechanism.”</span></div>
<div style="position:absolute;left:69.68px;top:456.42px" class="cls_004"><span class="cls_004">User environments can be used as a composition mechanism, since they bring applica-</span></div>
<div style="position:absolute;left:59.72px;top:468.37px" class="cls_004"><span class="cls_004">tions together in the</span><span class="cls_007"> PATH</span><span class="cls_004"> of the user, where they can find each other through dynamic</span></div>
<div style="position:absolute;left:59.72px;top:480.33px" class="cls_004"><span class="cls_004">composition. But that is not how they should be used in general. Before we know it, users</span></div>
<div style="position:absolute;left:59.72px;top:492.28px" class="cls_004"><span class="cls_004">will be given installation instructions like this: “Application</span><span class="cls_007"> foo</span><span class="cls_004"> needs application</span><span class="cls_007"> bar</span><span class="cls_004">, so</span></div>
<div style="position:absolute;left:59.72px;top:504.24px" class="cls_004"><span class="cls_004">you should run</span><span class="cls_007"> nix-env -i foo bar</span><span class="cls_004">.”  This is an abuse of user environments.  If there is a</span></div>
<div style="position:absolute;left:59.72px;top:516.19px" class="cls_004"><span class="cls_004">dependency, it should be expressed in a Nix expression that for instance builds a wrapper</span></div>
<div style="position:absolute;left:59.72px;top:528.15px" class="cls_004"><span class="cls_004">around</span><span class="cls_007"> foo</span><span class="cls_004"> that allows it to find</span><span class="cls_007"> bar</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:540.29px" class="cls_004"><span class="cls_004">There are pragmatic exceptions. We do not currently have a good handle on crosscutting,</span></div>
<div style="position:absolute;left:59.72px;top:552.25px" class="cls_004"><span class="cls_004">configurable dependencies. An example is the</span><span class="cls_007"> EDITOR</span><span class="cls_004"> environment variable, honoured</span></div>
<div style="position:absolute;left:59.72px;top:564.20px" class="cls_004"><span class="cls_004">by many Unix programs, that specifies the editor preferred by the user.</span></div>
<div style="position:absolute;left:362.11px;top:564.20px" class="cls_004"><span class="cls_004">(For instance,</span></div>
<div style="position:absolute;left:64.20px;top:584.11px" class="cls_013"><span class="cls_013"><sup>4</sup></span><span class="cls_014">Nixpkgs contains code to generate wrappers automatically.</span></div>
<div style="position:absolute;left:59.72px;top:624.86px" class="cls_004"><span class="cls_004">172</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:122130px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background181.jpg" width=481 height=680></div>
<div style="position:absolute;left:288.13px;top:17.14px" class="cls_004"><span class="cls_004">7.1. The Nix Packages collection</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">Subversion calls the program specified by this variable to allow the user to write commit</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">messages.) Wrapper scripts are not currently a feasible solution, since if the user wishes</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">to change his editor, he must rebuild all wrappers.  Another example is fonts for X11</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">applications, which we want to configure globally; we don’t want to have a set of fonts as</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">a dependency of each X11 application.</span></div>
<div style="position:absolute;left:73.84px;top:104.82px" class="cls_004"><span class="cls_004">The following is not so much a current principle as a hope for a better future:</span></div>
<div style="position:absolute;left:88.78px;top:123.91px" class="cls_004"><span class="cls_004">⇒ “Scoped composition mechanisms are good.”</span></div>
<div style="position:absolute;left:63.87px;top:143.01px" class="cls_004"><span class="cls_004">A mechanism is scoped if it limits visibility of symbols. For instance, if A imports B, and</span></div>
<div style="position:absolute;left:63.87px;top:154.96px" class="cls_004"><span class="cls_004">B imports C, then the interface of C should not be visible to A (unless A explicitly imports</span></div>
<div style="position:absolute;left:63.38px;top:166.92px" class="cls_004"><span class="cls_004">C). For very many composition mechanisms this is not the case. For instance, consider the</span></div>
<div style="position:absolute;left:63.87px;top:178.87px" class="cls_004"><span class="cls_004">Subversion example again (Figure 2.9). Its Nix expression is a function that takes many</span></div>
<div style="position:absolute;left:63.87px;top:190.83px" class="cls_004"><span class="cls_004">optional dependencies:</span></div>
<div style="position:absolute;left:88.78px;top:214.18px" class="cls_015"><span class="cls_015">{ ...,  bdbSupport  ?  false,  httpServer  ?  false,  ...</span></div>
<div style="position:absolute;left:88.78px;top:225.14px" class="cls_015"><span class="cls_015">, openssl  ?  null,  httpd  ?  null,  db4  ?  null,  expat,  zlib  ?  null</span></div>
<div style="position:absolute;left:88.78px;top:236.10px" class="cls_015"><span class="cls_015">}:</span></div>
<div style="position:absolute;left:63.87px;top:249.94px" class="cls_004"><span class="cls_004">Suppose that we call this function with</span><span class="cls_007"> httpServer = true</span><span class="cls_004"> and</span><span class="cls_007"> bdbSupport = false</span><span class="cls_004">. Then</span></div>
<div style="position:absolute;left:63.87px;top:261.89px" class="cls_004"><span class="cls_004">Subversion should not be built with Berkeley DB support. Unfortunately, there is a good</span></div>
<div style="position:absolute;left:63.87px;top:273.85px" class="cls_004"><span class="cls_004">chance that it will be, even though the</span><span class="cls_007"> db4</span><span class="cls_004"> derivation attribute is empty.  The reason is</span></div>
<div style="position:absolute;left:63.87px;top:285.80px" class="cls_004"><span class="cls_004">that Apache may be built with Berkeley DB support, and Subversion’s build process will</span></div>
<div style="position:absolute;left:63.87px;top:297.76px" class="cls_004"><span class="cls_004">sneakily find Berkeley DB through Apache.  For instance, Subversion’s</span><span class="cls_007"> configure</span><span class="cls_004"> script</span></div>
<div style="position:absolute;left:63.87px;top:309.71px" class="cls_004"><span class="cls_004">asks the Apache subcomponent</span><span class="cls_007"> apr-util</span><span class="cls_004"> what compiler and linker flag it needs to properly</span></div>
<div style="position:absolute;left:63.87px;top:321.67px" class="cls_004"><span class="cls_004">use</span><span class="cls_007"> apr-util</span><span class="cls_004">, and gets the following (approximate) results:</span></div>
<div style="position:absolute;left:88.78px;top:345.02px" class="cls_015"><span class="cls_015">$ apu-config  --includes</span></div>
<div style="position:absolute;left:88.78px;top:355.98px" class="cls_015"><span class="cls_015">-I/nix/store/h7yw7a257m1i...-db4-4.3.28/include</span></div>
<div style="position:absolute;left:88.78px;top:366.94px" class="cls_015"><span class="cls_015">$ apu-config  --ldflags</span></div>
<div style="position:absolute;left:88.78px;top:377.90px" class="cls_015"><span class="cls_015">-L/nix/store/h7yw7a257m1i...-db4-4.3.28/lib</span></div>
<div style="position:absolute;left:63.87px;top:391.74px" class="cls_004"><span class="cls_004">If Subversion’s</span><span class="cls_007"> configure</span><span class="cls_004"> script then dutifully adds these flags to its own list of compiler</span></div>
<div style="position:absolute;left:63.87px;top:403.69px" class="cls_004"><span class="cls_004">and linker flags, it will find Berkeley DB despite it not having been passed in as an explicit</span></div>
<div style="position:absolute;left:63.87px;top:415.65px" class="cls_004"><span class="cls_004">dependency.</span></div>
<div style="position:absolute;left:73.84px;top:427.60px" class="cls_004"><span class="cls_004">This does not violate Nix’s property of preventing undeclared dependencies in a techni-</span></div>
<div style="position:absolute;left:63.87px;top:439.56px" class="cls_004"><span class="cls_004">cal sense. After all, Berkeley DB is in the input closure of the Subversion build process,</span></div>
<div style="position:absolute;left:63.87px;top:451.52px" class="cls_004"><span class="cls_004">since it is in the closure of the Apache output. But in a logical (or “moral”) sense, it is an</span></div>
<div style="position:absolute;left:63.87px;top:463.47px" class="cls_004"><span class="cls_004">undeclared dependency.</span></div>
<div style="position:absolute;left:73.84px;top:475.43px" class="cls_004"><span class="cls_004">Unscoped compositions mechanisms are not a Nix-specific problem; far from it.  For</span></div>
<div style="position:absolute;left:63.87px;top:487.38px" class="cls_004"><span class="cls_004">instance, every conscientious C programmer who cares about header file hygiene has ex-</span></div>
<div style="position:absolute;left:63.87px;top:499.34px" class="cls_004"><span class="cls_004">perienced that the C header file mechanism is unscoped: if we have a C file that includes</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">header file X , and X in turn includes header file Y , then our file gets all the definitions in</span></div>
<div style="position:absolute;left:63.38px;top:523.25px" class="cls_004"><span class="cls_004">Y. This makes it virtually impossible to validate whether the C file will compile under</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">all circumstances. Consider the case where X is included conditionally, but we uncondi-</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">tionally need the definitions from Y . (A result is that programmers tend to include more</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">dependencies than perhaps required, leading to increased build times [41].) Likewise, the</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">only way that we can validate whether the derivations involving Unix libraries produced</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">by a Nix function will build for all function parameters, is to build all possible derivations.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">173</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:122820px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background182.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">A build can prove the presence of a dependency problem, not its absence, to paraphrase</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">Dijkstra [44].</span></div>
<div style="position:absolute;left:84.62px;top:80.45px" class="cls_004"><span class="cls_004">⇒ “Fine-grained components are better than large-grained components.”</span></div>
<div style="position:absolute;left:69.68px;top:103.90px" class="cls_004"><span class="cls_004">For the purpose of software deployment, fine-grained components are preferable to</span></div>
<div style="position:absolute;left:59.72px;top:115.85px" class="cls_004"><span class="cls_004">large-grained components since the latter tend to lead to unnecessary dependencies and</span></div>
<div style="position:absolute;left:59.72px;top:127.81px" class="cls_004"><span class="cls_004">thus to unnecessarily large closures.  This was already observed in [43].  Large-grained</span></div>
<div style="position:absolute;left:59.72px;top:139.76px" class="cls_004"><span class="cls_004">components also reduce software reuse [42], although that is not a central concern here.</span></div>
<div style="position:absolute;left:69.68px;top:152.10px" class="cls_004"><span class="cls_004">Consider for example the Python interpreter package. This package contains not just an</span></div>
<div style="position:absolute;left:59.72px;top:164.06px" class="cls_004"><span class="cls_004">interpreter for the Python language, but also many Python modules. Some of these are op-</span></div>
<div style="position:absolute;left:59.72px;top:176.01px" class="cls_004"><span class="cls_004">tional, as they can only be built if certain dependencies are present, e.g., wrapper modules</span></div>
<div style="position:absolute;left:59.72px;top:187.97px" class="cls_004"><span class="cls_004">for database libraries, the NCurses and Readline libraries, and so on. Thus, if we want to</span></div>
<div style="position:absolute;left:59.72px;top:199.92px" class="cls_004"><span class="cls_004">build a Python instance that supports all possible uses, we have to make it dependent on</span></div>
<div style="position:absolute;left:59.72px;top:211.88px" class="cls_004"><span class="cls_004">all these external libraries, even if most components that use Python don’t actually need</span></div>
<div style="position:absolute;left:59.72px;top:223.83px" class="cls_004"><span class="cls_004">most or all of the optional functionality. Thus, the closure size of all components that use</span></div>
<div style="position:absolute;left:59.72px;top:235.79px" class="cls_004"><span class="cls_004">Python increases.</span></div>
<div style="position:absolute;left:69.68px;top:248.13px" class="cls_004"><span class="cls_004">In contrast, the Perl interpreter package has far fewer optional dependencies, and Perl</span></div>
<div style="position:absolute;left:59.72px;top:260.08px" class="cls_004"><span class="cls_004">wrapper modules for the aforementioned modules are distributed as separate components.</span></div>
<div style="position:absolute;left:59.72px;top:272.04px" class="cls_004"><span class="cls_004">For instance, support for the Berkeley DB 4 database is provided in a separate package.</span></div>
<div style="position:absolute;left:59.72px;top:283.99px" class="cls_004"><span class="cls_004">Thus, a Perl component that does not require DB 4 support will not end up with the Berke-</span></div>
<div style="position:absolute;left:59.72px;top:295.95px" class="cls_004"><span class="cls_004">ley DB 4 component and the Perl wrapper module in its closure.</span></div>
<div style="position:absolute;left:69.68px;top:308.29px" class="cls_004"><span class="cls_004">In Nixpkgs, a strong preference is therefore given to small-grained components.  For</span></div>
<div style="position:absolute;left:59.72px;top:320.24px" class="cls_004"><span class="cls_004">instance, Nixpkgs initially used the “XFree86” package to provide X11 client libraries</span></div>
<div style="position:absolute;left:59.72px;top:332.20px" class="cls_004"><span class="cls_004">for GUI applications. However, XFree86 is a large, monolithic distribution that contains</span></div>
<div style="position:absolute;left:59.72px;top:344.15px" class="cls_004"><span class="cls_004">not only the X11 client libraries, but also the X11 server, drivers, and utilities. Further-</span></div>
<div style="position:absolute;left:59.72px;top:356.11px" class="cls_004"><span class="cls_004">more, many client libraries are not actually needed by most X clients.  So it was a dis-</span></div>
<div style="position:absolute;left:59.72px;top:368.06px" class="cls_004"><span class="cls_004">tinct improvement when we were able to replace XFree86 with the X.org modular X li-</span></div>
<div style="position:absolute;left:59.72px;top:380.02px" class="cls_004"><span class="cls_004">braries [182], which provide each individual library as a separately deployed entity. Thus,</span></div>
<div style="position:absolute;left:59.72px;top:391.97px" class="cls_004"><span class="cls_004">each X application in Nixpkgs has in its closure only the libraries that it actually needs.</span></div>
<div style="position:absolute;left:69.68px;top:404.31px" class="cls_004"><span class="cls_004">Of course, small-grained components also have a downside: they increase composition</span></div>
<div style="position:absolute;left:59.72px;top:416.27px" class="cls_004"><span class="cls_004">effort. So one certainly should not feel compelled to make components as small as possible,</span></div>
<div style="position:absolute;left:59.72px;top:428.22px" class="cls_004"><span class="cls_004">just to improve reuse. Rather, from the deployment perspective, the presence of external</span></div>
<div style="position:absolute;left:59.72px;top:440.18px" class="cls_004"><span class="cls_004">dependencies should guide decomposition of large-grained components. Also, the quality</span></div>
<div style="position:absolute;left:59.72px;top:452.13px" class="cls_004"><span class="cls_004">of small components is not necessarily better than that of large components [89].</span></div>
<div style="position:absolute;left:59.72px;top:481.96px" class="cls_008"><span class="cls_008">7.1.2. The standard environment</span></div>
<div style="position:absolute;left:59.72px;top:502.17px" class="cls_004"><span class="cls_004">Of all the components in Nixpkgs, the standard environment (</span><span class="cls_007">stdenv</span><span class="cls_004">) has a special signifi-</span></div>
<div style="position:absolute;left:59.72px;top:514.13px" class="cls_004"><span class="cls_004">cance as it is used as an input by almost all other components. It is in essence an aggregate</span></div>
<div style="position:absolute;left:59.72px;top:526.08px" class="cls_004"><span class="cls_004">of a number of components that are required by the build processes of almost all other</span></div>
<div style="position:absolute;left:59.72px;top:538.04px" class="cls_004"><span class="cls_004">components.  It is very inconvenient to specify them separately for each derivation that</span></div>
<div style="position:absolute;left:59.72px;top:549.99px" class="cls_004"><span class="cls_004">uses them, and so they are combined into</span><span class="cls_007"> stdenv</span><span class="cls_004">. The included components are:</span></div>
<div style="position:absolute;left:74.66px;top:571.07px" class="cls_004"><span class="cls_004">• GCC, the GNU C Compiler, configured with C and C++ support. It has been patched</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">to help ensure purity, as described below in Section 7.1.3</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">174</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:123510px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background183.jpg" width=481 height=680></div>
<div style="position:absolute;left:288.13px;top:17.14px" class="cls_004"><span class="cls_004">7.1. The Nix Packages collection</span></div>
<div style="position:absolute;left:78.82px;top:45.04px" class="cls_004"><span class="cls_004">• GNU</span><span class="cls_007"> coreutils</span><span class="cls_004">, which contains a few dozen standard Unix commands.</span></div>
<div style="position:absolute;left:78.82px;top:65.71px" class="cls_004"><span class="cls_004">• GNU</span><span class="cls_007"> findutils</span><span class="cls_004">, which provides</span><span class="cls_007"> find</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:78.82px;top:86.39px" class="cls_004"><span class="cls_004">• GNU</span><span class="cls_007"> diffutils</span><span class="cls_004">, which provides</span><span class="cls_007"> diff</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:78.82px;top:107.06px" class="cls_004"><span class="cls_004">• The text manupulation tools GNU</span><span class="cls_007"> sed</span><span class="cls_004">, GNU</span><span class="cls_007"> grep</span><span class="cls_004">, and GNU</span><span class="cls_007"> awk</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:78.82px;top:127.74px" class="cls_004"><span class="cls_004">• GNU</span><span class="cls_007"> tar</span><span class="cls_004">, necessary for unpacking sources in TAR format.</span></div>
<div style="position:absolute;left:78.82px;top:148.41px" class="cls_004"><span class="cls_004">• The compression utilities</span><span class="cls_007"> gzip</span><span class="cls_004"> and</span><span class="cls_007"> bzip2</span><span class="cls_004">, necessary for uncompressing sources.</span></div>
<div style="position:absolute;left:78.82px;top:169.09px" class="cls_004"><span class="cls_004">• GNU Make, an implementation of the</span><span class="cls_007"> make</span><span class="cls_004"> command.</span></div>
<div style="position:absolute;left:78.82px;top:189.76px" class="cls_004"><span class="cls_004">• Bash, an implementation of the POSIX shell. It provides many extensions that the</span></div>
<div style="position:absolute;left:88.78px;top:201.72px" class="cls_004"><span class="cls_004">standard environment does depend on.</span></div>
<div style="position:absolute;left:78.82px;top:222.39px" class="cls_004"><span class="cls_004">• Patch, a tool for applying deltas produced by</span><span class="cls_007"> diff</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:242.88px" class="cls_004"><span class="cls_004">In addition, the standard environment provides a shell script called</span><span class="cls_007"> setup</span><span class="cls_004"> that initialises</span></div>
<div style="position:absolute;left:63.87px;top:254.83px" class="cls_004"><span class="cls_004">the environment so that all these tools are in the builder’s path. Thus, the line</span></div>
<div style="position:absolute;left:88.78px;top:279.58px" class="cls_015"><span class="cls_015">source  $stdenv/setup</span></div>
<div style="position:absolute;left:63.87px;top:294.81px" class="cls_004"><span class="cls_004">at the top of a builder suffices to bring them into scope.</span></div>
<div style="position:absolute;left:73.84px;top:306.95px" class="cls_004"><span class="cls_004">Furthermore, the inputs specified in the attribute</span><span class="cls_007"> buildInputs</span><span class="cls_004"> are brought into scope,</span></div>
<div style="position:absolute;left:63.87px;top:318.91px" class="cls_004"><span class="cls_004">where “scope” depends on the build tools being used. By default, the</span><span class="cls_007"> bin</span><span class="cls_004"> subdirectory of</span></div>
<div style="position:absolute;left:63.87px;top:330.86px" class="cls_004"><span class="cls_004">components is added to</span><span class="cls_007"> PATH</span><span class="cls_004">, the</span><span class="cls_007"> include</span><span class="cls_004"> subdirectory is added to the C compiler’s search</span></div>
<div style="position:absolute;left:63.87px;top:342.82px" class="cls_004"><span class="cls_004">path, and the</span><span class="cls_007"> lib</span><span class="cls_004"> subdirectory is added to the linker’s search path. But this can be extended</span></div>
<div style="position:absolute;left:63.87px;top:354.77px" class="cls_004"><span class="cls_004">through</span><span class="cls_007"> setup</span><span class="cls_004"> hooks that components can optionally provide.  For instance, if Perl is in</span></div>
<div style="position:absolute;left:63.87px;top:366.73px" class="cls_004"><span class="cls_004">scope, then all</span><span class="cls_007"> lib/site_perl</span><span class="cls_004"> subdirectories of components will be added to Perl’s module</span></div>
<div style="position:absolute;left:63.87px;top:378.69px" class="cls_004"><span class="cls_004">search path. For instance, the attribute</span></div>
<div style="position:absolute;left:88.78px;top:403.43px" class="cls_015"><span class="cls_015">buildInputs  =  [perl  perlXMLWriter];</span></div>
<div style="position:absolute;left:63.87px;top:418.66px" class="cls_004"><span class="cls_004">will cause the</span><span class="cls_007"> bin</span><span class="cls_004"> directory of the</span><span class="cls_007"> perl</span><span class="cls_004"> derivation’s output to be added to</span><span class="cls_007"> PATH</span><span class="cls_004">, and the</span></div>
<div style="position:absolute;left:63.87px;top:430.62px" class="cls_007"><span class="cls_007">lib/site_perl</span><span class="cls_004"> directory of</span><span class="cls_007"> perlXMLWriter</span><span class="cls_004"> (the Perl module</span><span class="cls_007"> XML::Writer</span><span class="cls_004">) to be added to Perl’s</span></div>
<div style="position:absolute;left:63.87px;top:442.57px" class="cls_004"><span class="cls_004">search path.</span></div>
<div style="position:absolute;left:63.87px;top:470.13px" class="cls_009"><span class="cls_009">The generic builder</span><span class="cls_004">   The</span><span class="cls_007"> setup</span><span class="cls_004"> script also provides the generic builder, which is a shell</span></div>
<div style="position:absolute;left:63.87px;top:482.08px" class="cls_004"><span class="cls_004">function</span><span class="cls_007"> genericBuild</span><span class="cls_004"> that can automatically build many software components. An exam-</span></div>
<div style="position:absolute;left:63.87px;top:494.04px" class="cls_004"><span class="cls_004">ple of its use was shown in Figure 2.10. A full description of the generic builder and the</span></div>
<div style="position:absolute;left:63.87px;top:505.99px" class="cls_004"><span class="cls_004">ways in which it can be customised is given in the Nix manual [161], and its details are not</span></div>
<div style="position:absolute;left:63.87px;top:517.95px" class="cls_004"><span class="cls_004">relevant here. Briefly, the generic builder has a number of phases:</span></div>
<div style="position:absolute;left:78.82px;top:538.44px" class="cls_004"><span class="cls_004">• The unpack phase unpacks the sources denoted by the attribute</span><span class="cls_007"> src</span><span class="cls_004"> (which may be a</span></div>
<div style="position:absolute;left:88.78px;top:550.39px" class="cls_004"><span class="cls_004">list). The current directory is switched to the top-level directory of the source tree.</span></div>
<div style="position:absolute;left:78.82px;top:571.07px" class="cls_004"><span class="cls_004">• The patch phase applies the patches denoted by the attribute</span><span class="cls_007"> patches</span><span class="cls_004">. This is useful</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_004"><span class="cls_004">to maintain Nixpkgs-specific modifications to a component’s source.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">175</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:124200px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background184.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:74.66px;top:45.04px" class="cls_004"><span class="cls_004">• The configure phase brings the source into a buildable state by running the compo-</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">nent’s</span><span class="cls_007"> configure</span><span class="cls_004"> script with the argument</span><span class="cls_007"> --prefix=$out</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:74.66px;top:78.32px" class="cls_004"><span class="cls_004">• The build phase builds the component by running</span><span class="cls_007"> make</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:74.66px;top:99.65px" class="cls_004"><span class="cls_004">• The check phase runs</span><span class="cls_007"> make check</span><span class="cls_004"> to perform any tests (such as unit tests) included</span></div>
<div style="position:absolute;left:84.62px;top:111.60px" class="cls_004"><span class="cls_004">in the component.</span></div>
<div style="position:absolute;left:74.66px;top:132.93px" class="cls_004"><span class="cls_004">• The install phase installs the component into the store path denoted by the environ-</span></div>
<div style="position:absolute;left:84.62px;top:144.89px" class="cls_004"><span class="cls_004">ment variable</span><span class="cls_007"> out</span><span class="cls_004"> by running</span><span class="cls_007"> make install</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:59.72px;top:165.86px" class="cls_004"><span class="cls_004">Each of these phases can be overridden by the caller to support components whose build</span></div>
<div style="position:absolute;left:59.72px;top:177.82px" class="cls_004"><span class="cls_004">system does not follow the general pattern.  In addition, the default implementations of</span></div>
<div style="position:absolute;left:59.72px;top:189.77px" class="cls_004"><span class="cls_004">the phases can be customised in many ways (e.g., additional flags can be specified for the</span></div>
<div style="position:absolute;left:59.72px;top:201.73px" class="cls_007"><span class="cls_007">configure</span><span class="cls_004"> and</span><span class="cls_007"> make</span><span class="cls_004"> invocations).</span></div>
<div style="position:absolute;left:59.72px;top:230.18px" class="cls_009"><span class="cls_009">Logging</span><span class="cls_004">   A builder can write arbitrary text to its standard output and standard error file</span></div>
<div style="position:absolute;left:59.72px;top:242.14px" class="cls_004"><span class="cls_004">descriptors [152]. Nix combines these streams and writes the text to its own standard error,</span></div>
<div style="position:absolute;left:59.72px;top:254.09px" class="cls_004"><span class="cls_004">as well as to a per-derivation log file in the directory</span><span class="cls_007"> /nix/var/nix/log/drvs</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:266.40px" class="cls_004"><span class="cls_004">A practical problem in Unix software development that seems to become more painful</span></div>
<div style="position:absolute;left:59.72px;top:278.35px" class="cls_004"><span class="cls_004">with each passing year is the log output generated by build processes. Gone are the days</span></div>
<div style="position:absolute;left:59.72px;top:290.31px" class="cls_004"><span class="cls_004">that an invocation of</span><span class="cls_007"> make</span><span class="cls_004"> only printed easily-understood lines such as</span></div>
<div style="position:absolute;left:84.62px;top:315.54px" class="cls_015"><span class="cls_015">cc  -c  foo.c</span></div>
<div style="position:absolute;left:59.72px;top:331.26px" class="cls_004"><span class="cls_004">and if anything else appeared, it was a relevant error message. The use of tools such as</span></div>
<div style="position:absolute;left:59.72px;top:343.22px" class="cls_004"><span class="cls_004">Automake and Libtool [172] and Pkgconfig [75] routinely leads to single Make actions that</span></div>
<div style="position:absolute;left:59.72px;top:355.17px" class="cls_004"><span class="cls_004">are thousands of characters and dozens of lines long, and in which it is almost impossible to</span></div>
<div style="position:absolute;left:59.72px;top:367.13px" class="cls_004"><span class="cls_004">see what is being compiled and how. Also, the size of the log output can be overwhelming:</span></div>
<div style="position:absolute;left:59.72px;top:379.08px" class="cls_004"><span class="cls_004">the Firefox builder produces a log of 6.4 MiB. This makes it often difficult to pinpoint the</span></div>
<div style="position:absolute;left:59.72px;top:391.04px" class="cls_004"><span class="cls_004">cause of a build failure.</span></div>
<div style="position:absolute;left:69.68px;top:403.34px" class="cls_004"><span class="cls_004">For this reason, the generic builder produces structured or nested log output. This means</span></div>
<div style="position:absolute;left:59.72px;top:415.30px" class="cls_004"><span class="cls_004">that the log output becomes an ordered tree of log lines (i.e., the children of each node are</span></div>
<div style="position:absolute;left:59.72px;top:427.25px" class="cls_004"><span class="cls_004">ordered) rather than a list. For instance, the output of each phase of the generic builder is a</span></div>
<div style="position:absolute;left:59.72px;top:439.21px" class="cls_004"><span class="cls_004">subtree of the root. Furthermore, I patched GNU Make to produce nested output. The log</span></div>
<div style="position:absolute;left:59.72px;top:451.16px" class="cls_004"><span class="cls_004">messages of recursive invocations of Make form a subtree, and the output of each Make</span></div>
<div style="position:absolute;left:59.72px;top:463.12px" class="cls_004"><span class="cls_004">action is placed in a clearly labelled subtree.</span></div>
<div style="position:absolute;left:69.68px;top:475.43px" class="cls_004"><span class="cls_004">Subtrees are delimited by ECMA-48 control sequences [53]. This allows nesting to be</span></div>
<div style="position:absolute;left:59.72px;top:487.38px" class="cls_004"><span class="cls_004">easily retro-fitted onto “legacy” tools.  For instance, the byte sequence</span><span class="cls_007"> 1b 5b 33 70</span><span class="cls_004"> (in</span></div>
<div style="position:absolute;left:59.72px;top:499.34px" class="cls_004"><span class="cls_004">hexadecimal) or</span><span class="cls_007"> "\e[3p"</span><span class="cls_004"> (as a C string) begins a subtree with priority 3 (higher priority</span></div>
<div style="position:absolute;left:59.72px;top:511.29px" class="cls_004"><span class="cls_004">numbers mean that the subtree contains less important information), while the byte se-</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">quence</span><span class="cls_007"> 1b 5b 71</span><span class="cls_004"> or</span><span class="cls_007"> "\e[q"</span><span class="cls_004"> ends a subtree. The sequence</span><span class="cls_007"> 1b 5b</span><span class="cls_004"> is the ECMA-48 Control</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">Sequence Introducer (CSI), which according to the standard must be followed by any num-</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">ber of Parameter Bytes in the hexadecimal range</span><span class="cls_007"> 30</span><span class="cls_004">-</span><span class="cls_007">3f</span><span class="cls_004">, and a single</span><span class="cls_007"> Final Byte</span><span class="cls_004"> in the range</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_007"><span class="cls_007">40</span><span class="cls_004">-</span><span class="cls_007">7e</span><span class="cls_004">. An ECMA-48 conformant terminal will not display the control sequences used for</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">log nesting since it does not know how to interpret them.  Thus, when the log output is</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">echoed to a terminal, it appears as if no control sequences are present.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">176</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:124890px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background185.jpg" width=481 height=680></div>
<div style="position:absolute;left:288.13px;top:17.14px" class="cls_004"><span class="cls_004">7.1. The Nix Packages collection</span></div>
<div style="position:absolute;left:67.26px;top:49.20px" class="cls_015"><span class="cls_015">&lt;logfile></span></div>
<div style="position:absolute;left:76.67px;top:60.16px" class="cls_015"><span class="cls_015">&lt;nest>&lt;head>unpacking...&lt;/head></span></div>
<div style="position:absolute;left:86.09px;top:71.12px" class="cls_015"><span class="cls_015">&lt;line>...&lt;/line>  ...</span></div>
<div style="position:absolute;left:76.67px;top:82.08px" class="cls_015"><span class="cls_015">&lt;/nest></span></div>
<div style="position:absolute;left:76.67px;top:93.03px" class="cls_015"><span class="cls_015">&lt;nest>&lt;head>building...&lt;/head></span></div>
<div style="position:absolute;left:86.09px;top:114.95px" class="cls_015"><span class="cls_015">&lt;nest>&lt;head>Entering  directory  `src'&lt;/head></span></div>
<div style="position:absolute;left:95.50px;top:125.91px" class="cls_015"><span class="cls_015">&lt;nest>&lt;head>building  foo.o&lt;/head></span></div>
<div style="position:absolute;left:104.91px;top:136.87px" class="cls_015"><span class="cls_015">&lt;line>gcc  -o  foo.o  -c  foo.c&lt;/line></span></div>
<div style="position:absolute;left:95.50px;top:147.83px" class="cls_015"><span class="cls_015">&lt;/nest></span></div>
<div style="position:absolute;left:86.09px;top:158.79px" class="cls_015"><span class="cls_015">&lt;/nest></span></div>
<div style="position:absolute;left:76.67px;top:169.75px" class="cls_015"><span class="cls_015">&lt;/nest></span></div>
<div style="position:absolute;left:67.26px;top:180.71px" class="cls_015"><span class="cls_015">&lt;/logfile></span></div>
<div style="position:absolute;left:138.28px;top:198.54px" class="cls_004"><span class="cls_004">Figure 7.4.: Structured log output converted to XML</span></div>
<div style="position:absolute;left:73.84px;top:231.19px" class="cls_004"><span class="cls_004">The structured log output (containing escape sequences) can be processed in a variety</span></div>
<div style="position:absolute;left:63.87px;top:243.15px" class="cls_004"><span class="cls_004">of ways.  One such way is the tool</span><span class="cls_007"> log2xml</span><span class="cls_004"> (included in Nix), which converts a log file</span></div>
<div style="position:absolute;left:63.87px;top:255.10px" class="cls_004"><span class="cls_004">into an XML file [20], an example of which is shown in Figure 7.4. This XML file can</span></div>
<div style="position:absolute;left:63.87px;top:267.06px" class="cls_004"><span class="cls_004">then be transformed into something useful using, e.g., XSLT [27]. For instance, there is</span></div>
<div style="position:absolute;left:63.87px;top:279.01px" class="cls_004"><span class="cls_004">an XSL stylesheet</span><span class="cls_007"> log2html</span><span class="cls_004"> that produces a nicely formatted HTML page of the log, using</span></div>
<div style="position:absolute;left:63.87px;top:290.97px" class="cls_004"><span class="cls_004">JavaScript and Dynamic HTML to allow parts of the tree to be collapsed or expanded. Only</span></div>
<div style="position:absolute;left:63.87px;top:302.92px" class="cls_004"><span class="cls_004">subtrees that contain error messages are expanded by default, allowing the developer to find</span></div>
<div style="position:absolute;left:63.87px;top:314.88px" class="cls_004"><span class="cls_004">relevant parts of the log easily. An example produced by the Nix build farm (Chapter 8) is</span></div>
<div style="position:absolute;left:63.87px;top:326.83px" class="cls_004"><span class="cls_004">shown in Figure 7.5.</span></div>
<div style="position:absolute;left:63.87px;top:355.02px" class="cls_009"><span class="cls_009">Bootstrapping the standard environment</span><span class="cls_004">   The standard environment is used by the</span></div>
<div style="position:absolute;left:63.87px;top:366.98px" class="cls_004"><span class="cls_004">build processes of almost all other components in Nixpkgs, which raises the question:</span></div>
<div style="position:absolute;left:63.87px;top:378.93px" class="cls_004"><span class="cls_004">how do we build the standard environment itself? To build the components in</span><span class="cls_007"> stdenv</span><span class="cls_004">, we</span></div>
<div style="position:absolute;left:63.87px;top:390.89px" class="cls_004"><span class="cls_004">need a C compiler, standard Unix tools, a shell, and so on.  In other words, we need a</span></div>
<div style="position:absolute;left:63.87px;top:402.84px" class="cls_007"><span class="cls_007">stdenv</span><span class="cls_004"> to build</span><span class="cls_007"> stdenv</span><span class="cls_004">. Thus, we have a classic bootstrapping problem.</span></div>
<div style="position:absolute;left:73.84px;top:415.10px" class="cls_004"><span class="cls_004">The approach initially used, and still used to build</span><span class="cls_007"> stdenv</span><span class="cls_004"> on all platforms except</span><span class="cls_007"> stdenv-</span></div>
<div style="position:absolute;left:63.87px;top:427.05px" class="cls_007"><span class="cls_007">linux</span><span class="cls_004">, is to build</span><span class="cls_007"> stdenv</span><span class="cls_004"> using the “native” tools of the system, e.g., the C compiler in</span></div>
<div style="position:absolute;left:63.87px;top:439.01px" class="cls_007"><span class="cls_007">/usr/bin/gcc</span><span class="cls_004">. This is of course impure: it depends on inputs outside of Nix’s control. Thus,</span></div>
<div style="position:absolute;left:63.87px;top:450.96px" class="cls_004"><span class="cls_004">a build of</span><span class="cls_007"> stdenv</span><span class="cls_004"> may not always succeed (e.g., if the C compiler is missing). However,</span></div>
<div style="position:absolute;left:63.87px;top:462.92px" class="cls_004"><span class="cls_004">once</span><span class="cls_007"> stdenv</span><span class="cls_004"> has been built, we can build components with no outside interference. The</span></div>
<div style="position:absolute;left:63.87px;top:474.88px" class="cls_004"><span class="cls_004">build process of</span><span class="cls_007"> stdenv</span><span class="cls_004"> has several stages:</span></div>
<div style="position:absolute;left:78.82px;top:495.71px" class="cls_004"><span class="cls_004">• First a trivial initial standard environment is built (using</span><span class="cls_007"> /bin/sh</span><span class="cls_004"> for the builder) that</span></div>
<div style="position:absolute;left:88.78px;top:507.66px" class="cls_004"><span class="cls_004">constructs a</span><span class="cls_007"> setup</span><span class="cls_004"> script that sets the</span><span class="cls_007"> PATH</span><span class="cls_004"> to</span><span class="cls_007"> /usr/bin</span><span class="cls_004">, etc.</span></div>
<div style="position:absolute;left:78.82px;top:528.80px" class="cls_004"><span class="cls_004">• The initial</span><span class="cls_007"> stdenv</span><span class="cls_004"> is used to build GCC.</span></div>
<div style="position:absolute;left:78.82px;top:549.93px" class="cls_004"><span class="cls_004">• A second </span><span class="cls_007">stdenv </span><span class="cls_004">is then built, identical to the first one, except that GCC is added to</span></div>
<div style="position:absolute;left:88.78px;top:561.89px" class="cls_004"><span class="cls_004">the</span><span class="cls_007"> PATH</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:78.82px;top:583.02px" class="cls_004"><span class="cls_004">• This</span><span class="cls_007"> stdenv</span><span class="cls_004"> is used to build all other</span><span class="cls_007"> stdenv</span><span class="cls_004"> components.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">177</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:125580px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background186.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:172.17px;top:268.70px" class="cls_004"><span class="cls_004">Figure 7.5.: Structured log output</span></div>
<div style="position:absolute;left:74.66px;top:300.82px" class="cls_004"><span class="cls_004">• From these components the final</span><span class="cls_007"> stdenv</span><span class="cls_004"> is constructed. It has a “pure”</span><span class="cls_007"> PATH</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:320.86px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> stdenv</span><span class="cls_004"> thus produced has a compiler and linker that produces binaries that link</span></div>
<div style="position:absolute;left:59.72px;top:332.81px" class="cls_004"><span class="cls_004">against the system’s C library. This is still impure, but on many systems we do not have</span></div>
<div style="position:absolute;left:59.72px;top:344.77px" class="cls_004"><span class="cls_004">the ability to build our own copy of the C library. If we do, as on Linux, the build process</span></div>
<div style="position:absolute;left:59.72px;top:356.72px" class="cls_004"><span class="cls_004">has a few extra steps. We first use the trivial</span><span class="cls_007"> stdenv</span><span class="cls_004"> to build the C library. Then we build</span></div>
<div style="position:absolute;left:59.72px;top:368.68px" class="cls_004"><span class="cls_004">GCC such that it links dynamically against the C library, since we want all programs in</span></div>
<div style="position:absolute;left:59.72px;top:380.63px" class="cls_004"><span class="cls_004">the final</span><span class="cls_007"> stdenv</span><span class="cls_004"> to use our own C library instead of the system C library. A</span><span class="cls_007"> stdenv</span><span class="cls_004"> is then</span></div>
<div style="position:absolute;left:59.72px;top:392.59px" class="cls_004"><span class="cls_004">constructed that has environment variables set up so that the compiler and linker use our</span></div>
<div style="position:absolute;left:59.72px;top:404.54px" class="cls_004"><span class="cls_004">own C library.</span></div>
<div style="position:absolute;left:69.68px;top:416.53px" class="cls_004"><span class="cls_004">The ideal however is a completely pure</span><span class="cls_007"> stdenv</span><span class="cls_004">: one that requires no external components</span></div>
<div style="position:absolute;left:59.72px;top:428.49px" class="cls_004"><span class="cls_004">to build and run, and produces components that need no external components to run. Such</span></div>
<div style="position:absolute;left:59.72px;top:440.44px" class="cls_004"><span class="cls_004">a</span><span class="cls_007"> stdenv</span><span class="cls_004"> has been implemented on</span><span class="cls_007"> i686-linux</span><span class="cls_004">. Bootstrap tools such as a shell, compiler,</span></div>
<div style="position:absolute;left:59.72px;top:452.40px" class="cls_004"><span class="cls_004">and so on, are provided as “sources”, or more properly, atoms (see Section 5.3). These</span></div>
<div style="position:absolute;left:59.72px;top:464.35px" class="cls_004"><span class="cls_004">programs are all statically linked executables so that they do not need external components.</span></div>
<div style="position:absolute;left:59.72px;top:476.31px" class="cls_004"><span class="cls_004">Roughly, the builder for</span><span class="cls_007"> stdenv</span><span class="cls_004"> looks like this:</span></div>
<div style="position:absolute;left:84.62px;top:500.61px" class="cls_015"><span class="cls_015">derivation  {</span></div>
<div style="position:absolute;left:94.04px;top:511.57px" class="cls_015"><span class="cls_015">name  =  "stdenv-linux";</span></div>
<div style="position:absolute;left:94.04px;top:522.52px" class="cls_015"><span class="cls_015">system  =  "i686-linux";</span></div>
<div style="position:absolute;left:94.04px;top:533.48px" class="cls_015"><span class="cls_015">builder  =  ./bash;  #  statically  linked  Bash</span></div>
<div style="position:absolute;left:94.04px;top:544.44px" class="cls_015"><span class="cls_015">args  =  [./builder.sh];  #  build  script</span></div>
<div style="position:absolute;left:94.04px;top:555.40px" class="cls_015"><span class="cls_015">tar  =  ./tar;  #  statically  linked  GNU  Tar</span></div>
<div style="position:absolute;left:94.04px;top:566.36px" class="cls_015"><span class="cls_015">bzip2  =  ./bzip2;  #  statically  linked  BZip2</span></div>
<div style="position:absolute;left:94.04px;top:577.32px" class="cls_015"><span class="cls_015">tools  =  ./tools.tar.bz2;  #  everything  else,  statically  linked</span></div>
<div style="position:absolute;left:84.62px;top:588.28px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">178</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:126270px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background187.jpg" width=481 height=680></div>
<div style="position:absolute;left:288.13px;top:17.14px" class="cls_004"><span class="cls_004">7.1. The Nix Packages collection</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">Thus, the statically linked executables for Bash et al. are part of the Nixpkgs source tree.</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">(In reality,</span><span class="cls_007"> tools.tar.bz2</span><span class="cls_004"> is downloaded from the Internet, like sources obtained through</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_007"><span class="cls_007">fetchurl</span><span class="cls_004">, since it is rather large.  Therefore, a statically linked</span><span class="cls_007"> curl</span><span class="cls_004"> download program is</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">also included.) These executables have of course been built themselves in some way, but</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">they have been “re-injected” into the build process as sources—things that, as far as Nix</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">can see, have not been derived.</span></div>
<div style="position:absolute;left:63.87px;top:132.99px" class="cls_009"><span class="cls_009">Removing unnecessary dependencies</span><span class="cls_004">   Since we prefer static compositions over dy-</span></div>
<div style="position:absolute;left:63.87px;top:144.95px" class="cls_004"><span class="cls_004">namic compositions, the standard environment tries to ensure that any executables pro-</span></div>
<div style="position:absolute;left:63.87px;top:156.90px" class="cls_004"><span class="cls_004">duced by it are statically composed.  That means that if an ELF (Unix) executable or</span></div>
<div style="position:absolute;left:63.87px;top:168.86px" class="cls_004"><span class="cls_004">library [160] refers to another library, the directory of the latter must appear in the</span><span class="cls_007"> RPATH</span></div>
<div style="position:absolute;left:63.87px;top:180.81px" class="cls_004"><span class="cls_004">of the former.  To ensure that this is the case,</span><span class="cls_007"> stdenv</span><span class="cls_004">’s linker adds the flag</span><span class="cls_007"> -rpath</span><span class="cls_004"> path</span></div>
<div style="position:absolute;left:63.87px;top:192.77px" class="cls_004"><span class="cls_004">to the linker flags for every library directory mentioned through</span><span class="cls_007"> -L</span><span class="cls_004"> flags. Thus, a linker</span></div>
<div style="position:absolute;left:63.87px;top:204.72px" class="cls_004"><span class="cls_004">invocation</span></div>
<div style="position:absolute;left:88.78px;top:229.81px" class="cls_015"><span class="cls_015">$ ld  ...  -L/nix/store/abcd...-foo/lib  -lfoo</span></div>
<div style="position:absolute;left:63.87px;top:245.37px" class="cls_004"><span class="cls_004">is transformed into</span></div>
<div style="position:absolute;left:88.78px;top:270.46px" class="cls_015"><span class="cls_015">$ ld  ...  -L/nix/store/abcd...-foo/lib  -lfoo  \</span></div>
<div style="position:absolute;left:107.61px;top:281.42px" class="cls_015"><span class="cls_015">-rpath  /nix/store/abcd...-foo/lib</span></div>
<div style="position:absolute;left:63.87px;top:296.99px" class="cls_004"><span class="cls_004">However, we do not know in advance whether library</span><span class="cls_007"> foo</span><span class="cls_004"> is actually used by the linker.</span></div>
<div style="position:absolute;left:63.87px;top:308.94px" class="cls_004"><span class="cls_004">Regardless, the path</span><span class="cls_007"> /nix/store/abcd...-foo/lib</span><span class="cls_004"> is added to the</span><span class="cls_007"> RPATH</span><span class="cls_004"> of the output. Thus,</span></div>
<div style="position:absolute;left:63.87px;top:320.90px" class="cls_004"><span class="cls_004">the component gets a retained but unnecessary dependency on</span><span class="cls_007"> /nix/store/abcd...-foo</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:333.15px" class="cls_004"><span class="cls_004">For this reason, the standard environment after the install phase applies a tool called</span></div>
<div style="position:absolute;left:63.87px;top:345.11px" class="cls_007"><span class="cls_007">patchelf</span><span class="cls_004"> to all ELF executables and libraries in the output. This utility has the ability to</span></div>
<div style="position:absolute;left:63.87px;top:357.06px" class="cls_004"><span class="cls_004">“shrink” the</span><span class="cls_007"> RPATH</span><span class="cls_004"> of arbitrary ELF executables, i.e., remove any directories from the</span></div>
<div style="position:absolute;left:63.87px;top:369.02px" class="cls_007"><span class="cls_007">RPATH</span><span class="cls_004"> that do not contain any referenced library. It is effective in preventing many unnec-</span></div>
<div style="position:absolute;left:63.87px;top:380.97px" class="cls_004"><span class="cls_004">essary retained dependencies. For instance, it prevents Hello’s unnecessary dependency on</span></div>
<div style="position:absolute;left:63.87px;top:392.93px" class="cls_004"><span class="cls_004">GCC that we saw back on page 41.</span></div>
<div style="position:absolute;left:63.87px;top:422.30px" class="cls_008"><span class="cls_008">7.1.3. Ensuring purity</span></div>
<div style="position:absolute;left:63.87px;top:442.35px" class="cls_004"><span class="cls_004">If we build derivations in an environment that contains software components that are not</span></div>
<div style="position:absolute;left:63.87px;top:454.30px" class="cls_004"><span class="cls_004">under Nix control, there is a danger of impurity since the builder might make use of inputs</span></div>
<div style="position:absolute;left:63.87px;top:466.26px" class="cls_004"><span class="cls_004">outside of the Nix store. This is the main threat to the validity of the Nix approach. For</span></div>
<div style="position:absolute;left:63.87px;top:478.21px" class="cls_004"><span class="cls_004">instance, there is no way that we can prevent a builder from calling</span><span class="cls_007"> /usr/bin/gcc</span><span class="cls_004">.  Thus,</span></div>
<div style="position:absolute;left:63.87px;top:490.17px" class="cls_004"><span class="cls_004">while Nix’s hashing scheme ensures isolation between components in the store, it does not</span></div>
<div style="position:absolute;left:63.87px;top:502.12px" class="cls_004"><span class="cls_004">ensure isolation between components in the store on the one hand and component outside</span></div>
<div style="position:absolute;left:63.87px;top:514.08px" class="cls_004"><span class="cls_004">the store on the other hand.</span></div>
<div style="position:absolute;left:73.84px;top:526.33px" class="cls_004"><span class="cls_004">However, we can use some “countermeasures” to reduce the risk of “infection” by non-</span></div>
<div style="position:absolute;left:63.87px;top:538.29px" class="cls_004"><span class="cls_004">Nix components.  One such countermeasure—the clearing of the environment—is built</span></div>
<div style="position:absolute;left:63.87px;top:550.24px" class="cls_004"><span class="cls_004">into Nix. Nixpkgs implements a range of additional measures. These include:</span></div>
<div style="position:absolute;left:78.82px;top:571.07px" class="cls_004"><span class="cls_004">• The GNU C Library on</span><span class="cls_007"> i686-linux</span><span class="cls_004"> does not have any default search path for libraries</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_004"><span class="cls_004">(such as</span><span class="cls_007"> /usr/lib</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">179</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:126960px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background188.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:74.66px;top:45.04px" class="cls_004"><span class="cls_004">• GCC has been patched not to search for header files in standard locations such as</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_007"><span class="cls_007">/usr/include</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:74.66px;top:77.04px" class="cls_004"><span class="cls_004">• The linker,</span><span class="cls_007"> ld</span><span class="cls_004">, has been patched not to search for libraries in standard locations such</span></div>
<div style="position:absolute;left:84.62px;top:88.99px" class="cls_004"><span class="cls_004">as</span><span class="cls_007"> /usr/lib</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:74.66px;top:109.03px" class="cls_004"><span class="cls_004">• In addition, GCC and</span><span class="cls_007"> ld</span><span class="cls_004"> ignore or reject any command-line arguments that refer to a</span></div>
<div style="position:absolute;left:84.62px;top:120.99px" class="cls_004"><span class="cls_004">non-store location (the only exception being the builder’s temporary directory). For</span></div>
<div style="position:absolute;left:84.62px;top:132.94px" class="cls_004"><span class="cls_004">instance, a GCC flag like</span><span class="cls_007"> -I/opt/include</span><span class="cls_004"> is ignored; a</span><span class="cls_007"> ld</span><span class="cls_004"> argument like</span><span class="cls_007"> /usr/lib/crt1.o</span></div>
<div style="position:absolute;left:84.62px;top:144.90px" class="cls_004"><span class="cls_004">causes a fatal error.  In practice, these measures prevent</span><span class="cls_007"> configure</span><span class="cls_004"> scripts, which</span></div>
<div style="position:absolute;left:84.62px;top:156.85px" class="cls_004"><span class="cls_004">frequently scan for optional dependencies in a variety of “well-known” system di-</span></div>
<div style="position:absolute;left:84.62px;top:168.81px" class="cls_004"><span class="cls_004">rectories, from finding dependencies outside of the store.</span></div>
<div style="position:absolute;left:69.68px;top:188.82px" class="cls_004"><span class="cls_004">It should be noted that the threat of impurity described here can only occur if Nix is used</span></div>
<div style="position:absolute;left:59.72px;top:200.78px" class="cls_004"><span class="cls_004">in a “hosted” environment, i.e., under an existing operating system that does not use Nix</span></div>
<div style="position:absolute;left:59.72px;top:212.73px" class="cls_004"><span class="cls_004">for its component storage. If all components are deployed through Nix, that is, if we have</span></div>
<div style="position:absolute;left:59.72px;top:224.69px" class="cls_004"><span class="cls_004">a pure environment, then this danger disappears. This leads to the as-yet unrealised ideal</span></div>
<div style="position:absolute;left:59.72px;top:236.64px" class="cls_004"><span class="cls_004">of a “NixOS,” a fully Nix-based Unix distribution (discussed in Section 11.1).</span></div>
<div style="position:absolute;left:59.72px;top:264.52px" class="cls_008"><span class="cls_008">7.1.4. Supporting third-party binary components</span></div>
<div style="position:absolute;left:59.72px;top:284.06px" class="cls_004"><span class="cls_004">Most of the components in Nixpkgs are open source or free software components, i.e.,</span></div>
<div style="position:absolute;left:59.72px;top:296.01px" class="cls_004"><span class="cls_004">their builders compile them from source.  However, it is possible to deploy third-party</span></div>
<div style="position:absolute;left:59.72px;top:307.97px" class="cls_004"><span class="cls_004">closed-source components as well, provided that the Nix expression for the component</span></div>
<div style="position:absolute;left:59.72px;top:319.92px" class="cls_004"><span class="cls_004">can automatically obtain a binary distribution from somewhere (e.g., through</span><span class="cls_007"> fetchurl</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:59.72px;top:331.88px" class="cls_004"><span class="cls_004">The builder for such a component is in a way “trivial”: it does not compile anything; it</span></div>
<div style="position:absolute;left:59.72px;top:343.83px" class="cls_004"><span class="cls_004">essentially just unpacks the input binary distribution and copies it to</span><span class="cls_007"> out</span><span class="cls_004">. Note that this</span></div>
<div style="position:absolute;left:59.72px;top:355.79px" class="cls_004"><span class="cls_004">is perfectly fine: Nix requires no semantics from builders other than that they produce an</span></div>
<div style="position:absolute;left:59.72px;top:367.74px" class="cls_004"><span class="cls_004">FSO in the path denoted by</span><span class="cls_007"> out</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:379.73px" class="cls_004"><span class="cls_004">Of course, many closed-source components do not come in a form that allows us to write</span></div>
<div style="position:absolute;left:59.72px;top:391.68px" class="cls_004"><span class="cls_004">a builder that installs them, since they have their own (frequently interactive) installers.</span></div>
<div style="position:absolute;left:59.72px;top:403.64px" class="cls_004"><span class="cls_004">Sometimes we can trick our way past this.  Sun’s Java SDK has an interactive installer</span></div>
<div style="position:absolute;left:59.72px;top:415.59px" class="cls_004"><span class="cls_004">that requires the user to approve a license by pressing “</span><span class="cls_007">Y</span><span class="cls_004">”. By simply piping that character</span></div>
<div style="position:absolute;left:59.72px;top:427.55px" class="cls_004"><span class="cls_004">into the installer process, the installer becomes non-interactive. Unfortunately we cannot</span></div>
<div style="position:absolute;left:59.72px;top:439.50px" class="cls_004"><span class="cls_004">expect such tricks to be possible in general.</span></div>
<div style="position:absolute;left:69.68px;top:451.49px" class="cls_004"><span class="cls_004">Even if we can unpack the component, there is the issue of the component’s dependen-</span></div>
<div style="position:absolute;left:59.72px;top:463.44px" class="cls_004"><span class="cls_004">cies. It may have runtime dependencies on external programs or libraries. However, con-</span></div>
<div style="position:absolute;left:59.72px;top:475.40px" class="cls_004"><span class="cls_004">trary to open source components, distributors of closed-source components cannot hard-</span></div>
<div style="position:absolute;left:59.72px;top:487.35px" class="cls_004"><span class="cls_004">code paths to dependencies into programs since they cannot make assumptions about the</span></div>
<div style="position:absolute;left:59.72px;top:499.31px" class="cls_004"><span class="cls_004">target environment where the component will run. Thus, paths to dependencies are usu-</span></div>
<div style="position:absolute;left:59.72px;top:511.26px" class="cls_004"><span class="cls_004">ally configurable through environment variables. These dependencies can therefore be met</span></div>
<div style="position:absolute;left:59.72px;top:523.22px" class="cls_004"><span class="cls_004">through late static composition using wrapper scripts, as described above.</span></div>
<div style="position:absolute;left:69.68px;top:535.20px" class="cls_004"><span class="cls_004">An exception on Linux is the dependency on the GNU C library, and possibly some other</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">well-known libraries in</span><span class="cls_007"> /lib</span><span class="cls_004"> and</span><span class="cls_007"> /usr/lib</span><span class="cls_004">. Worst of all is the path of the ELF dynamic linker,</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">which is hard-coded into every ELF executable. When a dynamically linked executable is</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">invoked on Linux, the kernel will load the dynamic linker specified by the executable. The</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">dynamic linker is almost always</span><span class="cls_007"> /lib/ld-linux.so.2</span><span class="cls_004">. This is an impure external dependency,</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">180</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:127650px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background189.jpg" width=481 height=680></div>
<div style="position:absolute;left:288.13px;top:17.14px" class="cls_004"><span class="cls_004">7.1. The Nix Packages collection</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">and should not be used. Rather, the</span><span class="cls_007"> ld-linux.so</span><span class="cls_004"> of Nixpkgs’s Glibc should be used. But</span></div>
<div style="position:absolute;left:63.87px;top:55.97px" class="cls_004"><span class="cls_004">there is no way to accomplish this through environment variables</span><span class="cls_012"><sup>5</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:69.23px" class="cls_004"><span class="cls_004">The utility</span><span class="cls_007"> patchelf</span><span class="cls_004">, which we already saw above for shrinking</span><span class="cls_007"> RPATH</span><span class="cls_004">s, can also deal</span></div>
<div style="position:absolute;left:63.87px;top:81.19px" class="cls_004"><span class="cls_004">with this situation. It can change the dynamic linker path embedded in an ELF executable.</span></div>
<div style="position:absolute;left:63.87px;top:93.14px" class="cls_004"><span class="cls_004">Technically speaking, this is done by changing the contents of the</span><span class="cls_007"> INTERP</span><span class="cls_004"> segment of the</span></div>
<div style="position:absolute;left:63.87px;top:105.10px" class="cls_004"><span class="cls_004">executable, which specifies the dynamic linker (or “ELF interpreter”) [160]. We have suc-</span></div>
<div style="position:absolute;left:63.87px;top:117.05px" class="cls_004"><span class="cls_004">cessfully deployed applications such as Sun’s JDK 5.0, Eclipse and Adobe Reader in this</span></div>
<div style="position:absolute;left:63.87px;top:129.01px" class="cls_004"><span class="cls_004">way. The purity of the resulting components has been validated in the pure environment</span></div>
<div style="position:absolute;left:63.87px;top:140.96px" class="cls_004"><span class="cls_004">provided by NixOS (discussed in Section 11.1).</span></div>
<div style="position:absolute;left:63.87px;top:170.24px" class="cls_008"><span class="cls_008">7.1.5. Experience</span></div>
<div style="position:absolute;left:63.87px;top:190.25px" class="cls_004"><span class="cls_004">The main reason for the development of Nixpkgs was to have a substantial body of real</span></div>
<div style="position:absolute;left:63.87px;top:202.21px" class="cls_004"><span class="cls_004">world software components that could serve as a validation for the Nix approach. A par-</span></div>
<div style="position:absolute;left:63.87px;top:214.16px" class="cls_004"><span class="cls_004">ticularly important goal was to see to what extent the assumptions from Section 6.8 hold.</span></div>
<div style="position:absolute;left:63.87px;top:226.12px" class="cls_004"><span class="cls_004">Did these assumptions hold in practice?</span></div>
<div style="position:absolute;left:73.84px;top:238.36px" class="cls_004"><span class="cls_004">Let’s evaluate the assumptions one by one:</span></div>
<div style="position:absolute;left:78.82px;top:259.13px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:259.13px" class="cls_004"><span class="cls_004">“The component can be built with and installed at an arbitrary prefix”: this assump-</span></div>
<div style="position:absolute;left:88.78px;top:271.08px" class="cls_004"><span class="cls_004">tion holds for virtually all components, since in general they cannot assume that a</span></div>
<div style="position:absolute;left:88.78px;top:283.04px" class="cls_004"><span class="cls_004">single fixed path is acceptable to all users.  A handful of components did require</span></div>
<div style="position:absolute;left:88.78px;top:294.99px" class="cls_004"><span class="cls_004">a fixed location, but these were easily patched. Also, some groups of components</span></div>
<div style="position:absolute;left:88.78px;top:306.95px" class="cls_004"><span class="cls_004">require a shared prefix, i.e., they want to be installed in the same location.  This</span></div>
<div style="position:absolute;left:88.78px;top:318.90px" class="cls_004"><span class="cls_004">was true for some components in the modular X.org tree [182]. No closed-source</span></div>
<div style="position:absolute;left:88.78px;top:330.86px" class="cls_004"><span class="cls_004">components were encountered that have a fixed prefix.</span></div>
<div style="position:absolute;left:78.82px;top:351.92px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:351.92px" class="cls_004"><span class="cls_004">“The component does not expect that its dependencies are installed at certain fixed</span></div>
<div style="position:absolute;left:88.78px;top:363.87px" class="cls_004"><span class="cls_004">locations, and the locations of the dependencies can instead be specified at build</span></div>
<div style="position:absolute;left:88.78px;top:375.83px" class="cls_004"><span class="cls_004">or runtime”: again, since most components cannot assume that users have installed</span></div>
<div style="position:absolute;left:88.78px;top:387.78px" class="cls_004"><span class="cls_004">dependencies at a fixed prefix, this assumption holds almost always. An exception is</span></div>
<div style="position:absolute;left:88.78px;top:399.74px" class="cls_004"><span class="cls_004">fixed dependencies on</span><span class="cls_007"> /bin/sh</span><span class="cls_004">. This path is very widely hard-coded into shell scripts</span></div>
<div style="position:absolute;left:88.78px;top:411.69px" class="cls_004"><span class="cls_004">due to the “hash-bang” convention [152] (i.e., specifying the script’s interpreter on</span></div>
<div style="position:absolute;left:88.78px;top:423.65px" class="cls_004"><span class="cls_004">the first line of the script). This is a source of impurity.</span></div>
<div style="position:absolute;left:88.78px;top:440.15px" class="cls_004"><span class="cls_004">As a result, it is not clear whether a pure Nix environment can dispense with provid-</span></div>
<div style="position:absolute;left:88.78px;top:452.11px" class="cls_004"><span class="cls_004">ing</span><span class="cls_007"> /bin/sh</span><span class="cls_004"> unless a substantial effort is undertaken to patch components. (Probably</span></div>
<div style="position:absolute;left:88.78px;top:464.06px" class="cls_004"><span class="cls_004">most of this patching can be performed automatically, e.g., after the unpack phase in</span></div>
<div style="position:absolute;left:88.78px;top:476.02px" class="cls_004"><span class="cls_004">the generic builder.)</span></div>
<div style="position:absolute;left:78.82px;top:497.07px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:497.07px" class="cls_004"><span class="cls_004">“The component can be built automatically, i.e., with no user interaction whatso-</span></div>
<div style="position:absolute;left:88.78px;top:509.03px" class="cls_004"><span class="cls_004">ever”: no decent software component requires an interactive build process, as that</span></div>
<div style="position:absolute;left:88.78px;top:520.98px" class="cls_004"><span class="cls_004">flies in the face of good software engineering practice (e.g., preventing the use of a</span></div>
<div style="position:absolute;left:88.78px;top:532.94px" class="cls_004"><span class="cls_004">build farm as in Chapter 8). But as mentioned above, some closed-source compo-</span></div>
<div style="position:absolute;left:88.78px;top:544.89px" class="cls_004"><span class="cls_004">nents provide only interactive installers.</span></div>
<div style="position:absolute;left:68.36px;top:565.18px" class="cls_013"><span class="cls_013"><sup>5</sup></span><span class="cls_014">It is</span></div>
<div style="position:absolute;left:88.02px;top:566.09px" class="cls_014"><span class="cls_014">however possible to invoke the dynamic linker directly, specifying the program as an argument, e.g.,</span></div>
<div style="position:absolute;left:75.83px;top:575.55px" class="cls_016"><span class="cls_016">/nix/store/72by2iw5wd8i...-glibc-2.3.5/lib/ld-linux.so.2 acroread</span><span class="cls_014">. But this changes the calling convention of the</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">program.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">181</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:128340px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background190.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7.</span></div>
<div style="position:absolute;left:72.17px;top:17.14px" class="cls_004"><span class="cls_004">Software Deployment</span></div>
<div style="position:absolute;left:74.66px;top:45.04px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:45.04px" class="cls_004"><span class="cls_004">“The build process of the component is essentially pure”.  There are two major</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">sources of impurity. First, the component uses file system inputs that are not explic-</span></div>
<div style="position:absolute;left:84.62px;top:68.95px" class="cls_004"><span class="cls_004">itly specified as inputs, i.e., are not in the set inputs in Figure 5.11. These impurities</span></div>
<div style="position:absolute;left:84.62px;top:80.90px" class="cls_004"><span class="cls_004">can in turn be decomposed into undeclared dependencies on FSOs inside the Nix</span></div>
<div style="position:absolute;left:84.62px;top:92.86px" class="cls_004"><span class="cls_004">store and outside the Nix store. The former has not been observed at all. Thus, iso-</span></div>
<div style="position:absolute;left:84.62px;top:104.82px" class="cls_004"><span class="cls_004">lation works very well. This is good news for a pure Nix-based environment. The</span></div>
<div style="position:absolute;left:84.62px;top:116.77px" class="cls_004"><span class="cls_004">latter does occur, as shown above, and cannot be prevented in general; though, as we</span></div>
<div style="position:absolute;left:84.62px;top:128.73px" class="cls_004"><span class="cls_004">have seen in Section 7.1.3, the threat can be mitigated.</span></div>
<div style="position:absolute;left:84.62px;top:144.67px" class="cls_004"><span class="cls_004">The second source of impurity is a reliance on non-file system information sources,</span></div>
<div style="position:absolute;left:84.62px;top:156.62px" class="cls_004"><span class="cls_004">such as the system time or the network. In fact, only the system time is a real pos-</span></div>
<div style="position:absolute;left:84.62px;top:168.58px" class="cls_004"><span class="cls_004">sibility; the network is seldom used by builders. However, virtually all components</span></div>
<div style="position:absolute;left:84.62px;top:180.53px" class="cls_004"><span class="cls_004">in practice are pure in the sense of the equivalence relations in Chapter 6. That is, if</span></div>
<div style="position:absolute;left:84.62px;top:192.49px" class="cls_004"><span class="cls_004">there are impurities, they do not affect the operation of the component in an observ-</span></div>
<div style="position:absolute;left:84.62px;top:204.44px" class="cls_004"><span class="cls_004">able way. One exception was observed: static libraries on Mac OS X (page 163).</span></div>
<div style="position:absolute;left:74.66px;top:224.37px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:224.37px" class="cls_004"><span class="cls_004">“The component does not need to be modified after it has been built, e.g., at run-</span></div>
<div style="position:absolute;left:84.62px;top:236.32px" class="cls_004"><span class="cls_004">time”: this assumption holds for almost all Unix components, since in a multi-user</span></div>
<div style="position:absolute;left:84.62px;top:248.28px" class="cls_004"><span class="cls_004">environment a component cannot assume to have write permission to itself. Most</span></div>
<div style="position:absolute;left:84.62px;top:260.23px" class="cls_004"><span class="cls_004">development components do not maintain state, and Unix application components</span></div>
<div style="position:absolute;left:84.62px;top:272.19px" class="cls_004"><span class="cls_004">maintain state in the user’s home directory. A notable exception is IBM’s Eclipse</span></div>
<div style="position:absolute;left:84.62px;top:284.14px" class="cls_004"><span class="cls_004">development environment, which in some pre-releases required write permission to</span></div>
<div style="position:absolute;left:84.62px;top:296.10px" class="cls_004"><span class="cls_004">its own prefix. Unless such components are patched to write state to another loca-</span></div>
<div style="position:absolute;left:84.62px;top:308.05px" class="cls_004"><span class="cls_004">tion, they will not work in Nix.  But such problems generally will be fixed, since</span></div>
<div style="position:absolute;left:84.62px;top:320.01px" class="cls_004"><span class="cls_004">requiring write permission is just as unacceptable to other deployment systems such</span></div>
<div style="position:absolute;left:84.62px;top:331.96px" class="cls_004"><span class="cls_004">as RPM.</span></div>
<div style="position:absolute;left:84.62px;top:347.90px" class="cls_004"><span class="cls_004">It is possible that we will encounter problems with system components (which are</span></div>
<div style="position:absolute;left:84.62px;top:359.86px" class="cls_004"><span class="cls_004">underrepresented currently) that maintain global, as opposed to user-specific, state.</span></div>
<div style="position:absolute;left:84.62px;top:371.81px" class="cls_004"><span class="cls_004">For instance, the password maintenance utility</span><span class="cls_007"> passwd</span><span class="cls_004"> might (hypothetically) re-</span></div>
<div style="position:absolute;left:84.62px;top:383.77px" class="cls_004"><span class="cls_004">quire that the password file is stored under</span><span class="cls_007"> $out/etc/passwd</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:74.66px;top:403.69px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:403.69px" class="cls_004"><span class="cls_004">“The component has no environment dependencies”: we have encountered no prob-</span></div>
<div style="position:absolute;left:84.62px;top:415.65px" class="cls_004"><span class="cls_004">lems in practice with this assumption. Again, development components tend to have</span></div>
<div style="position:absolute;left:84.62px;top:427.60px" class="cls_004"><span class="cls_004">no external state, and applications keep state in the user’s home directory, which they</span></div>
<div style="position:absolute;left:84.62px;top:439.56px" class="cls_004"><span class="cls_004">automatically initialise on first use. Thus, no special actions are necessary to make</span></div>
<div style="position:absolute;left:84.62px;top:451.52px" class="cls_004"><span class="cls_004">these components work, other than assuring the presence of their closures in the file</span></div>
<div style="position:absolute;left:84.62px;top:463.47px" class="cls_004"><span class="cls_004">system.</span></div>
<div style="position:absolute;left:84.62px;top:479.41px" class="cls_004"><span class="cls_004">But there certainly are counter-examples. A web server component might require</span></div>
<div style="position:absolute;left:84.62px;top:491.37px" class="cls_004"><span class="cls_004">the existence of a special user account under which the component is to execute.</span></div>
<div style="position:absolute;left:84.62px;top:503.32px" class="cls_004"><span class="cls_004">However, such environment dependencies are usually distinct from the component</span></div>
<div style="position:absolute;left:84.62px;top:515.28px" class="cls_004"><span class="cls_004">as a code-level entity. For instance, the same web server component might be used</span></div>
<div style="position:absolute;left:84.62px;top:527.23px" class="cls_004"><span class="cls_004">for several actual servers on the same machine, running under different user accounts</span></div>
<div style="position:absolute;left:84.62px;top:539.19px" class="cls_004"><span class="cls_004">as specified by the servers’ respective configuration files. We will deal with this type</span></div>
<div style="position:absolute;left:84.62px;top:551.14px" class="cls_004"><span class="cls_004">of state in Chapter 9.</span></div>
<div style="position:absolute;left:74.66px;top:571.07px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:571.07px" class="cls_004"><span class="cls_004">“Retained dependencies can be found in the component through scanning”: we have</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">not encountered a single instance of “pointer hiding”. Of course, that does not mean</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">182</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:129030px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background191.jpg" width=481 height=680></div>
<div style="position:absolute;left:288.13px;top:17.14px" class="cls_004"><span class="cls_004">7.1. The Nix Packages collection</span></div>
<div style="position:absolute;left:88.78px;top:45.04px" class="cls_004"><span class="cls_004">that it cannot happen; it is trivial to construct a component that hides references to</span></div>
<div style="position:absolute;left:88.78px;top:56.99px" class="cls_004"><span class="cls_004">retained dependencies. But Nixpkgs provides strong evidence that it does not occur</span></div>
<div style="position:absolute;left:88.78px;top:68.95px" class="cls_004"><span class="cls_004">in practice.</span></div>
<div style="position:absolute;left:78.82px;top:94.71px" class="cls_004"><span class="cls_004">• “Hash rewriting does not change the semantics of the component” (intensional</span></div>
<div style="position:absolute;left:88.78px;top:106.66px" class="cls_004"><span class="cls_004">model only): the prototype implementation of the intensional model was applied to</span></div>
<div style="position:absolute;left:88.78px;top:118.62px" class="cls_004"><span class="cls_004">a number of large closures, including Firefox and MonoDevelop, a C#-based graph-</span></div>
<div style="position:absolute;left:88.78px;top:130.57px" class="cls_004"><span class="cls_004">ical development environment. The experiment included equivalence class collision</span></div>
<div style="position:absolute;left:88.78px;top:142.53px" class="cls_004"><span class="cls_004">resolution as a result of combining builds from several users. No failures were en-</span></div>
<div style="position:absolute;left:88.78px;top:153.46px" class="cls_004"><span class="cls_004">countered in any component</span><span class="cls_012"><sup>6</sup></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:178.78px" class="cls_004"><span class="cls_004">In summary, we can conclude the following:</span></div>
<div style="position:absolute;left:78.82px;top:203.08px" class="cls_004"><span class="cls_004">• The hashing scheme presents no problems and works very well.</span></div>
<div style="position:absolute;left:78.82px;top:228.84px" class="cls_004"><span class="cls_004">• Fixed dependencies on</span><span class="cls_007"> /bin/sh</span><span class="cls_004"> and a handful of other paths are a source of impurity.</span></div>
<div style="position:absolute;left:88.78px;top:240.79px" class="cls_004"><span class="cls_004">This impurity does not occur in a pure Nix environment, but in that case components</span></div>
<div style="position:absolute;left:88.78px;top:252.75px" class="cls_004"><span class="cls_004">need to be adapted to build and work at all. In impure environments, the counter-</span></div>
<div style="position:absolute;left:88.78px;top:264.70px" class="cls_004"><span class="cls_004">measures of Section 7.1.3 prevent most “large” dependencies, but cannot prevent</span></div>
<div style="position:absolute;left:88.78px;top:276.66px" class="cls_004"><span class="cls_004">direct calls to external paths. Thus vigilance is necessary; build logs for third-party</span></div>
<div style="position:absolute;left:88.78px;top:288.61px" class="cls_004"><span class="cls_004">components should be inspected to verify that no external tools are being used.</span></div>
<div style="position:absolute;left:73.84px;top:312.91px" class="cls_004"><span class="cls_004">There is a caveat to these results: since the components were not selected randomly,</span></div>
<div style="position:absolute;left:63.87px;top:324.86px" class="cls_004"><span class="cls_004">but rather “on-demand” to suit user needs, there may be a selection bias.  For instance,</span></div>
<div style="position:absolute;left:63.87px;top:336.82px" class="cls_004"><span class="cls_004">development components may be over-represented. Also, since users are generally more</span></div>
<div style="position:absolute;left:63.87px;top:348.78px" class="cls_004"><span class="cls_004">inclined to add small components than large components or entire systems consisting of</span></div>
<div style="position:absolute;left:63.87px;top:360.73px" class="cls_004"><span class="cls_004">many components (e.g., KDE), there is a bias towards smaller components. Nevertheless,</span></div>
<div style="position:absolute;left:63.87px;top:372.69px" class="cls_004"><span class="cls_004">large components (such as Firefox) and systems (such as a substantial part of Gnome) have</span></div>
<div style="position:absolute;left:63.87px;top:384.64px" class="cls_004"><span class="cls_004">been added.</span></div>
<div style="position:absolute;left:63.87px;top:419.18px" class="cls_009"><span class="cls_009">Enforcing purity</span><span class="cls_004">   Is it possible to enforce purity?  We cannot do this in general, but</span></div>
<div style="position:absolute;left:63.87px;top:431.14px" class="cls_004"><span class="cls_004">operating system-specific tricks, or even extensions, might be employed for this purpose</span></div>
<div style="position:absolute;left:63.87px;top:443.09px" class="cls_004"><span class="cls_004">in the future. For instance, impurity due to non-Nix components can be prevented using</span></div>
<div style="position:absolute;left:63.87px;top:455.05px" class="cls_004"><span class="cls_004">appropriate access control rights that prevent the builder from accessing them in the first</span></div>
<div style="position:absolute;left:63.87px;top:467.00px" class="cls_004"><span class="cls_004">place.</span></div>
<div style="position:absolute;left:73.84px;top:480.42px" class="cls_004"><span class="cls_004">Impurity due to the system time can be prevented by disallowing builders from querying</span></div>
<div style="position:absolute;left:63.87px;top:492.37px" class="cls_004"><span class="cls_004">the current time or timestamps on files. This can be accomplished by modifying operating</span></div>
<div style="position:absolute;left:63.87px;top:504.33px" class="cls_004"><span class="cls_004">system calls to not return this information (e.g., always return a timestamp of 0). However,</span></div>
<div style="position:absolute;left:63.87px;top:516.28px" class="cls_004"><span class="cls_004">impurity may even be present in the instruction set of the processor. For example, the Intel</span></div>
<div style="position:absolute;left:63.87px;top:528.24px" class="cls_004"><span class="cls_004">Pentium has an instruction</span><span class="cls_007"> RDTSC</span><span class="cls_004"> to read the number of clock ticks elapsed since the last</span></div>
<div style="position:absolute;left:63.87px;top:540.19px" class="cls_004"><span class="cls_004">restart [37]. However, this instruction can be disabled by the kernel.</span></div>
<div style="position:absolute;left:68.36px;top:565.18px" class="cls_013"><span class="cls_013"><sup>6</sup></span><span class="cls_014">And this is literally a historical footnote: in [52], we wrote that “patching files [by rewriting hashes] is unlikely</span></div>
<div style="position:absolute;left:75.83px;top:575.55px" class="cls_014"><span class="cls_014">to work in general, e.g., due to internal checksums on files being invalidated in the process.” It turns out that</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">this assessment was too pessimistic.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">183</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:129720px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background192.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:59.72px;top:42.09px" class="cls_011"><span class="cls_011">7.2. User environments</span></div>
<div style="position:absolute;left:59.72px;top:68.12px" class="cls_004"><span class="cls_004">Section 2.3 introduced user environments as the mechanism through which end-user com-</span></div>
<div style="position:absolute;left:59.72px;top:80.08px" class="cls_004"><span class="cls_004">ponents (i.e., applications) are activated. They are components that are automatically gen-</span></div>
<div style="position:absolute;left:59.72px;top:92.03px" class="cls_004"><span class="cls_004">erated by</span><span class="cls_007"> nix-env</span><span class="cls_004"> to activate other components.  There are many ways through which a</span></div>
<div style="position:absolute;left:59.72px;top:103.99px" class="cls_004"><span class="cls_004">component can be activated, i.e., made available to the user. The sets of symlinks to pro-</span></div>
<div style="position:absolute;left:59.72px;top:115.94px" class="cls_004"><span class="cls_004">grams in</span><span class="cls_007"> bin</span><span class="cls_004"> directories of components shown in Figure 2.11 are just one example of how</span></div>
<div style="position:absolute;left:59.72px;top:127.90px" class="cls_004"><span class="cls_004">user environments can be implemented. One can imagine several other policies as to how</span></div>
<div style="position:absolute;left:59.72px;top:139.85px" class="cls_004"><span class="cls_004">components can be activated:</span></div>
<div style="position:absolute;left:74.66px;top:161.07px" class="cls_004"><span class="cls_004">• On Windows and similar GUI environments, components can be activated by adding</span></div>
<div style="position:absolute;left:84.62px;top:173.03px" class="cls_004"><span class="cls_004">them to the Start menu. Thus, a user environment would consist of a hierarchy of</span></div>
<div style="position:absolute;left:84.62px;top:184.98px" class="cls_007"><span class="cls_007">*.lnk</span><span class="cls_004"> files (on Windows) or</span><span class="cls_007"> *.desktop</span><span class="cls_004"> files (on KDE) that specify the location of a</span></div>
<div style="position:absolute;left:84.62px;top:196.94px" class="cls_004"><span class="cls_004">program, its icon, associated media types, and so on.</span></div>
<div style="position:absolute;left:74.66px;top:218.58px" class="cls_004"><span class="cls_004">• Similarly, the objects on the desktop in many GUI environments can be synthesised.</span></div>
<div style="position:absolute;left:69.68px;top:239.80px" class="cls_004"><span class="cls_004">However, even in the Unix user environments described in Section 2.3, there are a num-</span></div>
<div style="position:absolute;left:59.72px;top:251.76px" class="cls_004"><span class="cls_004">ber of policy decisions. One is the question of what constituent parts of installed compo-</span></div>
<div style="position:absolute;left:59.72px;top:263.71px" class="cls_004"><span class="cls_004">nents are placed in the user environment, i.e., to which files in the installed components we</span></div>
<div style="position:absolute;left:59.72px;top:275.67px" class="cls_004"><span class="cls_004">create symlinks. There are several options.</span></div>
<div style="position:absolute;left:74.66px;top:296.88px" class="cls_004"><span class="cls_004">• Everything. The user environment is a hierarchy of symlinks that mirrors the union</span></div>
<div style="position:absolute;left:84.62px;top:308.84px" class="cls_004"><span class="cls_004">of the directory hierarchies of the installed components.  This is what the current</span></div>
<div style="position:absolute;left:84.62px;top:320.79px" class="cls_004"><span class="cls_004">implementation does. However, this approach creates very large user environments,</span></div>
<div style="position:absolute;left:84.62px;top:332.75px" class="cls_004"><span class="cls_004">often consisting of hundreds or even thousands of symlinks. The creation of such</span></div>
<div style="position:absolute;left:84.62px;top:344.70px" class="cls_004"><span class="cls_004">user environments can take several seconds, which is too long. The disk space con-</span></div>
<div style="position:absolute;left:84.62px;top:356.66px" class="cls_004"><span class="cls_004">sumption may also be considerable, depending on the implementation details of the</span></div>
<div style="position:absolute;left:84.62px;top:368.62px" class="cls_004"><span class="cls_004">underlying file system.</span></div>
<div style="position:absolute;left:74.66px;top:390.26px" class="cls_004"><span class="cls_004">• Programs only, i.e., the executables in the</span><span class="cls_007"> bin</span><span class="cls_004"> subdirectory of each installed com-</span></div>
<div style="position:absolute;left:84.62px;top:402.22px" class="cls_004"><span class="cls_004">ponent.  This is much more efficient.  However, components typically also have</span></div>
<div style="position:absolute;left:84.62px;top:414.17px" class="cls_004"><span class="cls_004">non-code artifacts that we wish to activate, such as documentation.  For instance,</span></div>
<div style="position:absolute;left:84.62px;top:426.13px" class="cls_004"><span class="cls_004">the</span><span class="cls_007"> man</span><span class="cls_004"> subdirectory of each component may contain Unix manual pages in Troff</span></div>
<div style="position:absolute;left:84.62px;top:438.08px" class="cls_004"><span class="cls_004">format. Users will expect those manual pages to be found by the</span><span class="cls_007"> man</span><span class="cls_004"> command.</span></div>
<div style="position:absolute;left:74.66px;top:459.73px" class="cls_004"><span class="cls_004">• Allow the user to specify which parts of installed components should be symlinked.</span></div>
<div style="position:absolute;left:84.62px;top:471.69px" class="cls_004"><span class="cls_004">This requires an extension to the</span><span class="cls_007"> nix-env</span><span class="cls_004"> installation syntax, e.g.,</span></div>
<div style="position:absolute;left:106.54px;top:497.59px" class="cls_015"><span class="cls_015">$ nix-env  -i  firefox  --activate  bin,man</span></div>
<div style="position:absolute;left:69.68px;top:513.98px" class="cls_004"><span class="cls_004">Another issue is how to deal with collisions, which occur when two installed compo-</span></div>
<div style="position:absolute;left:59.72px;top:525.94px" class="cls_004"><span class="cls_004">nents have one or more files with identical relative paths. Such collisions are detected by</span></div>
<div style="position:absolute;left:59.72px;top:537.89px" class="cls_004"><span class="cls_004">the builder of the user environment component. There are several possibilities:</span></div>
<div style="position:absolute;left:74.66px;top:559.11px" class="cls_004"><span class="cls_004">• The builder can print an error message and abort, thus causing the</span><span class="cls_007"> nix-env</span><span class="cls_004"> operation</span></div>
<div style="position:absolute;left:84.62px;top:571.07px" class="cls_004"><span class="cls_004">to fail. In this case no new generation is produced and the current generation symlink</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">does not change.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">184</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:130410px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background193.jpg" width=481 height=680></div>
<div style="position:absolute;left:325.70px;top:17.14px" class="cls_004"><span class="cls_004">7.3. Binary deployment</span></div>
<div style="position:absolute;left:78.82px;top:45.04px" class="cls_004"><span class="cls_004">• If the collision is caused by multiple versions of a component, the builder can give</span></div>
<div style="position:absolute;left:88.78px;top:56.99px" class="cls_004"><span class="cls_004">precedence to the newest version (under some ordering of versions). Also, the older</span></div>
<div style="position:absolute;left:88.78px;top:68.95px" class="cls_004"><span class="cls_004">version could be made available under a different name. If we have Firefox 1.0.5</span></div>
<div style="position:absolute;left:88.78px;top:80.90px" class="cls_004"><span class="cls_004">and 1.0.6 installed concurrently in a user environment, the symlink to the former</span></div>
<div style="position:absolute;left:88.78px;top:92.86px" class="cls_004"><span class="cls_004">might be called</span><span class="cls_007"> bin/firefox-1.0.5</span><span class="cls_004">, and the latter</span><span class="cls_007"> bin/firefox</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:78.82px;top:112.14px" class="cls_004"><span class="cls_004">• The builder can give precedence to the component that was added most recently.</span></div>
<div style="position:absolute;left:88.78px;top:124.09px" class="cls_004"><span class="cls_004">(Currently, however, the builder does not have this information.)</span></div>
<div style="position:absolute;left:78.82px;top:143.37px" class="cls_004"><span class="cls_004">• All conflicting files can be renamed, e.g., to</span><span class="cls_007"> bin/firefox-1.0.5</span><span class="cls_004"> and</span><span class="cls_007"> bin/firefox-1.0.6</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:162.00px" class="cls_004"><span class="cls_004">These are all policy decisions regarding the computation of the user environment. The</span></div>
<div style="position:absolute;left:63.87px;top:173.95px" class="cls_004"><span class="cls_004">current Nix implementation does not have an easy mechanism to change the built-in policy</span></div>
<div style="position:absolute;left:63.87px;top:185.91px" class="cls_004"><span class="cls_004">(other than editing the user environment builder, a simple Perl script). However, it would</span></div>
<div style="position:absolute;left:63.87px;top:197.86px" class="cls_004"><span class="cls_004">be fairly trivial to add an option for users to override the user environment builder, thus</span></div>
<div style="position:absolute;left:63.87px;top:209.82px" class="cls_004"><span class="cls_004">allowing different policies.</span></div>
<div style="position:absolute;left:63.87px;top:240.20px" class="cls_011"><span class="cls_011">7.3. Binary deployment</span></div>
<div style="position:absolute;left:63.87px;top:265.42px" class="cls_004"><span class="cls_004">As we have seen previously, Nix (through Nix expressions) is at its core a source deploy-</span></div>
<div style="position:absolute;left:63.87px;top:277.37px" class="cls_004"><span class="cls_004">ment system, but the substitute mechanism (Section 5.5.3) allows binary deployment as</span></div>
<div style="position:absolute;left:63.87px;top:289.33px" class="cls_004"><span class="cls_004">an optimisation of source deployment, yielding a transparent source/binary deployment</span></div>
<div style="position:absolute;left:63.87px;top:301.28px" class="cls_004"><span class="cls_004">model (Section 2.6). But the substitute mechanism is just that—a mechanism. It does not</span></div>
<div style="position:absolute;left:63.87px;top:313.24px" class="cls_004"><span class="cls_004">implement any particular binary deployment method. It just consists of database registra-</span></div>
<div style="position:absolute;left:63.87px;top:325.19px" class="cls_004"><span class="cls_004">tions of the fact that an FSO for a certain store path can be produced by executing some</span></div>
<div style="position:absolute;left:63.87px;top:337.15px" class="cls_004"><span class="cls_004">program.</span></div>
<div style="position:absolute;left:73.84px;top:349.10px" class="cls_004"><span class="cls_004">This section shows a specific implementation of binary deployment using the substitute</span></div>
<div style="position:absolute;left:63.87px;top:361.06px" class="cls_004"><span class="cls_004">mechanism. It consists of three fairly simple tools:</span></div>
<div style="position:absolute;left:78.82px;top:379.69px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> nix-push</span><span class="cls_004">, executed on the deployer’s side, which computes the closure of a given</span></div>
<div style="position:absolute;left:88.78px;top:391.64px" class="cls_004"><span class="cls_004">store path, packs the store paths in the closure into archives, and places them on a</span></div>
<div style="position:absolute;left:88.78px;top:403.60px" class="cls_004"><span class="cls_004">web server.</span></div>
<div style="position:absolute;left:78.82px;top:422.88px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> nix-pull</span><span class="cls_004">, executed on the clients, which obtains information about the archives avail-</span></div>
<div style="position:absolute;left:88.78px;top:434.83px" class="cls_004"><span class="cls_004">able on a web server, and registers the program</span><span class="cls_007"> download-using-manifests</span><span class="cls_004"> as a sub-</span></div>
<div style="position:absolute;left:88.78px;top:446.79px" class="cls_004"><span class="cls_004">stitute for each corresponding store path.</span></div>
<div style="position:absolute;left:78.82px;top:466.06px" class="cls_004"><span class="cls_004">•</span><span class="cls_007"> download-using-manifests</span><span class="cls_004">, called by the</span><span class="cls_007"> substitute</span><span class="cls_004"> function (Figure 5.15), which</span></div>
<div style="position:absolute;left:88.78px;top:478.02px" class="cls_004"><span class="cls_004">downloads and unpacks the requested FSO.</span></div>
<div style="position:absolute;left:73.84px;top:496.65px" class="cls_004"><span class="cls_004">We shall now look at the various parts in detail. Suppose that we have a Nix expression</span></div>
<div style="position:absolute;left:63.87px;top:508.60px" class="cls_007"><span class="cls_007">foo.nix</span><span class="cls_004"> that evaluates to a set of store derivations that we want to build and put on a web</span></div>
<div style="position:absolute;left:63.87px;top:520.56px" class="cls_004"><span class="cls_004">server</span><span class="cls_007"> <A HREF="http://server/nix-cache/">http://server/nix-cache</A> </span><span class="cls_004"> from where the binaries can be fetched by clients. We can do</span></div>
<div style="position:absolute;left:63.87px;top:532.51px" class="cls_004"><span class="cls_004">this as follows:</span></div>
<div style="position:absolute;left:88.78px;top:555.40px" class="cls_015"><span class="cls_015">$ nix-push  \</span></div>
<div style="position:absolute;left:107.61px;top:566.36px" class="cls_015"><span class="cls_015"> </span><A HREF="http://server/nix-cache/">http://server/nix-cache</A>  \</div>
<div style="position:absolute;left:107.61px;top:577.32px" class="cls_015"><span class="cls_015"> </span><A HREF="http://server/nix-cache/manifest/">http://server/nix-cache/MANIFEST</A>  \</div>
<div style="position:absolute;left:107.61px;top:588.28px" class="cls_015"><span class="cls_015">$(nix-instantiate  ./foo.nix)</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">185</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:131100px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background194.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">Recall that</span><span class="cls_007"> nix-instantiate</span><span class="cls_004"> translates a Nix expression to store derivations, and prints out</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">their store paths; and that the shell syntax</span><span class="cls_007"> $(...)</span><span class="cls_004"> causes those paths to be passed as argu-</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">ments to</span><span class="cls_007"> nix-push</span><span class="cls_004">. The first URL is the location to which the archives should be uploaded.</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">The second URL is the location to which the manifest of the binary deployment is up-</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">loaded. The manifest (as we briefly saw in Section 2.6) contains information about every</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">uploaded archive.</span></div>
<div style="position:absolute;left:69.68px;top:117.06px" class="cls_004"><span class="cls_004">Given a call</span><span class="cls_007"> nix-push</span><span class="cls_004"> archiveURL manifestURL paths, the steps that</span><span class="cls_007"> nix-push</span><span class="cls_004"> performs</span></div>
<div style="position:absolute;left:59.72px;top:129.02px" class="cls_004"><span class="cls_004">are as follows:</span></div>
<div style="position:absolute;left:74.66px;top:149.82px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:149.82px" class="cls_004"><span class="cls_004">The closure of the set paths is computed using the command</span><span class="cls_007"> nix-store -qR --include-</span></div>
<div style="position:absolute;left:84.62px;top:161.77px" class="cls_007"><span class="cls_007">outputs</span><span class="cls_004"> paths.  As we saw on page 42, this performs a combined source/binary</span></div>
<div style="position:absolute;left:84.62px;top:173.73px" class="cls_004"><span class="cls_004">deployment, i.e., it includes the store derivations and their</span><span class="cls_007"> inputSrcs</span><span class="cls_004">, but also the</span></div>
<div style="position:absolute;left:84.62px;top:185.68px" class="cls_004"><span class="cls_004">outputs of the store derivations. Each derivation is also built.</span></div>
<div style="position:absolute;left:74.66px;top:206.77px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:206.77px" class="cls_004"><span class="cls_004">For each path p in the closure, the canonical serialisation</span><span class="cls_007"> serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p))</span></div>
<div style="position:absolute;left:84.62px;top:218.73px" class="cls_004"><span class="cls_004">(Section 5.2.1) is compressed using the</span><span class="cls_007"> bzip2</span><span class="cls_004"> compression program. This archive</span></div>
<div style="position:absolute;left:84.62px;top:230.68px" class="cls_004"><span class="cls_004">is uploaded to the URL archiveURL +</span><span class="cls_007"> "/"</span><span class="cls_004"> +</span><span class="cls_007"> printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004">(</span><span class="cls_007">hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(c)) +</span><span class="cls_007"> ".nar.bz2"</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:84.62px;top:242.64px" class="cls_004"><span class="cls_004">where c is the compressed serialisation (this means that archives are stored un-</span></div>
<div style="position:absolute;left:84.62px;top:254.60px" class="cls_004"><span class="cls_004">der content-addressable names). The archive is uploaded using an HTTP PUT re-</span></div>
<div style="position:absolute;left:84.62px;top:266.55px" class="cls_004"><span class="cls_004">quest [57], but only if a HEAD request reveals that the archive does not already exist</span></div>
<div style="position:absolute;left:84.62px;top:277.48px" class="cls_004"><span class="cls_004">on the server</span><span class="cls_012"><sup>7</sup></span><span class="cls_004">. This makes it useful to use the same archiveURL between</span><span class="cls_007"> nix-push</span></div>
<div style="position:absolute;left:84.62px;top:290.46px" class="cls_004"><span class="cls_004">operations for multiple software releases, since common subpaths will be uploaded</span></div>
<div style="position:absolute;left:84.62px;top:302.42px" class="cls_004"><span class="cls_004">and stored only once.</span></div>
<div style="position:absolute;left:74.66px;top:323.51px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:323.51px" class="cls_004"><span class="cls_004">A manifest is then created. For each path p that we have packed into a compressed</span></div>
<div style="position:absolute;left:84.62px;top:335.46px" class="cls_004"><span class="cls_004">archive c and uploaded to url, it contains an entry of the following form:</span></div>
<div style="position:absolute;left:106.54px;top:361.29px" class="cls_015"><span class="cls_015">{</span></div>
<div style="position:absolute;left:117.00px;top:368.51px" class="cls_015"><span class="cls_015">StorePath:</span><span class="cls_004">  p</span></div>
<div style="position:absolute;left:117.00px;top:380.47px" class="cls_015"><span class="cls_015">NarURL:</span><span class="cls_004">  url</span></div>
<div style="position:absolute;left:117.00px;top:392.42px" class="cls_015"><span class="cls_015">Hash:  sha256:</span><span class="cls_007">printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004">(</span><span class="cls_007">hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(c))</span></div>
<div style="position:absolute;left:117.00px;top:404.38px" class="cls_015"><span class="cls_015">NarHash:  sha256:</span><span class="cls_007">printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004">(</span><span class="cls_007">hash</span><span class="cls_039"><sub>sha256</sub></span><span class="cls_004">(</span><span class="cls_007">serialise</span><span class="cls_004">(</span><span class="cls_007">readPath</span><span class="cls_004">(p))))</span></div>
<div style="position:absolute;left:117.00px;top:416.33px" class="cls_015"><span class="cls_015">Size:</span><span class="cls_004">  |c|</span></div>
<div style="position:absolute;left:117.00px;top:428.29px" class="cls_015"><span class="cls_015">References:</span><span class="cls_007">  references</span><span class="cls_004">[p]</span></div>
<div style="position:absolute;left:117.00px;top:440.24px" class="cls_015"><span class="cls_015">Deriver:</span><span class="cls_007">  deriver</span><span class="cls_004">[p]</span></div>
<div style="position:absolute;left:106.54px;top:456.93px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:84.62px;top:473.29px" class="cls_004"><span class="cls_004">The meaning of such an entry is that if we want to produce a store path p, we can</span></div>
<div style="position:absolute;left:84.62px;top:485.24px" class="cls_004"><span class="cls_004">do so by downloading a compressed serialisation from url and unpacking it into p.</span></div>
<div style="position:absolute;left:84.62px;top:497.20px" class="cls_004"><span class="cls_004">The field</span><span class="cls_007"> Hash</span><span class="cls_004"> is the hash of the compressed serialisation of p, while</span><span class="cls_007"> NarHash</span><span class="cls_004"> is</span></div>
<div style="position:absolute;left:84.62px;top:509.15px" class="cls_004"><span class="cls_004">the hash of the uncompressed serialisation of p. The former allows clients to verify</span></div>
<div style="position:absolute;left:84.62px;top:521.11px" class="cls_004"><span class="cls_004">that the downloaded archive has not been modified, while the latter will be of use in</span></div>
<div style="position:absolute;left:84.62px;top:533.06px" class="cls_004"><span class="cls_004">the binary patch deployment scheme described in Section 7.5. The</span><span class="cls_007"> References</span><span class="cls_004"> and</span></div>
<div style="position:absolute;left:84.62px;top:545.02px" class="cls_007"><span class="cls_007">Deriver</span><span class="cls_004"> fields are omitted if their corresponding database entries are equal to ε.</span></div>
<div style="position:absolute;left:64.20px;top:565.18px" class="cls_013"><span class="cls_013"><sup>7</sup></span><span class="cls_014">The actual</span><span class="cls_016"> nix-push</span><span class="cls_014"> program takes an additional URL to be used for the HEAD requests. This allows the PUT</span></div>
<div style="position:absolute;left:71.67px;top:575.55px" class="cls_014"><span class="cls_014">and HEAD requests to use different URLs. E.g., the first can refer to a CGI script [124] that handles uploads,</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">and the second is the actual location from which archives can be downloaded.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">186</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:131790px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background195.jpg" width=481 height=680></div>
<div style="position:absolute;left:319.61px;top:17.14px" class="cls_004"><span class="cls_004">7.4. Deployment policies</span></div>
<div style="position:absolute;left:78.82px;top:45.04px" class="cls_004"><span class="cls_004">• The manifest is uploaded using a PUT request to manifestURL.</span></div>
<div style="position:absolute;left:73.84px;top:65.79px" class="cls_004"><span class="cls_004">On the client side, the availability of the pre-built binaries created by</span><span class="cls_007"> nix-push</span><span class="cls_004"> can be</span></div>
<div style="position:absolute;left:63.87px;top:77.75px" class="cls_004"><span class="cls_004">registered using</span><span class="cls_007"> nix-pull</span><span class="cls_004"> manifestURL, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:102.76px" class="cls_015"><span class="cls_015">$ nix-pull  </span><A HREF="http://server/nix-cache/manifest/">http://server/nix-cache/MANIFEST</A> </div>
<div style="position:absolute;left:63.87px;top:118.25px" class="cls_004"><span class="cls_004">The command</span><span class="cls_007"> nix-pull</span><span class="cls_004"> downloads the manifest and stores it in the directory</span><span class="cls_007"> /nix/var/nix/-</span></div>
<div style="position:absolute;left:63.87px;top:130.21px" class="cls_007"><span class="cls_007">manifests</span><span class="cls_004">. For each store path entry p in the manifest, a substitute is registered using the</span></div>
<div style="position:absolute;left:63.87px;top:142.17px" class="cls_004"><span class="cls_004">command</span><span class="cls_007"> nix-store --register-substitutes</span><span class="cls_004"> (page 119). Note that this also sets the</span><span class="cls_007"> references</span></div>
<div style="position:absolute;left:63.87px;top:154.12px" class="cls_004"><span class="cls_004">database entry for p so that the closure invariant can be maintained. The substitute program</span></div>
<div style="position:absolute;left:63.87px;top:166.08px" class="cls_004"><span class="cls_004">is</span><span class="cls_007"> download-using-manifests</span><span class="cls_004">, and there are no declared command-line arguments.  But</span></div>
<div style="position:absolute;left:63.87px;top:178.03px" class="cls_004"><span class="cls_004">recall from Figure 5.15 that the substitute program is always called with p as command-</span></div>
<div style="position:absolute;left:63.87px;top:189.99px" class="cls_004"><span class="cls_004">line argument. Since all other necessary information for the download (such as the URL)</span></div>
<div style="position:absolute;left:63.87px;top:201.94px" class="cls_004"><span class="cls_004">is stored in the manifests in</span><span class="cls_007"> /nix/var/nix/manifests</span><span class="cls_004">, no further command-line arguments are</span></div>
<div style="position:absolute;left:63.87px;top:213.90px" class="cls_004"><span class="cls_004">necessary.</span></div>
<div style="position:absolute;left:73.84px;top:226.13px" class="cls_004"><span class="cls_004">The script</span><span class="cls_007"> download-using-manifests</span><span class="cls_004">, when it is called by the function</span><span class="cls_007"> substitute</span><span class="cls_004"> in Fig-</span></div>
<div style="position:absolute;left:63.87px;top:238.08px" class="cls_004"><span class="cls_004">ure 5.15 to produce a path p, reads all manifests in</span><span class="cls_007"> /nix/var/nix/manifests</span><span class="cls_004">. Note that there</span></div>
<div style="position:absolute;left:63.87px;top:250.04px" class="cls_004"><span class="cls_004">may be multiple manifest entries for p. The script picks one arbitrarily.</span></div>
<div style="position:absolute;left:361.81px;top:250.04px" class="cls_004"><span class="cls_004">(An alternative</span></div>
<div style="position:absolute;left:63.87px;top:261.99px" class="cls_004"><span class="cls_004">implementation is to try each until one succeeds.) It downloads the archive from the URL</span></div>
<div style="position:absolute;left:63.87px;top:273.95px" class="cls_004"><span class="cls_004">specified by the</span><span class="cls_007"> NarURL</span><span class="cls_004"> field of the selected manifest entry, uncompresses it, deserialises</span></div>
<div style="position:absolute;left:63.87px;top:285.90px" class="cls_004"><span class="cls_004">it to path p, and checks that the cryptographic hash specified in the</span><span class="cls_007"> NarHash</span><span class="cls_004"> field of the</span></div>
<div style="position:absolute;left:63.87px;top:297.86px" class="cls_004"><span class="cls_004">entry matches the actual hash. In Section 7.5, we will see an extension to this script that</span></div>
<div style="position:absolute;left:63.87px;top:309.81px" class="cls_004"><span class="cls_004">supports binary patching.</span></div>
<div style="position:absolute;left:63.87px;top:342.00px" class="cls_011"><span class="cls_011">7.4. Deployment policies</span></div>
<div style="position:absolute;left:63.87px;top:367.74px" class="cls_004"><span class="cls_004">Since Nix provides basic mechanisms to support deployment, it is fairly easy to define</span></div>
<div style="position:absolute;left:63.87px;top:379.70px" class="cls_004"><span class="cls_004">all sorts of specific deployment policies. In general, a deployment policy consists of two</span></div>
<div style="position:absolute;left:63.87px;top:391.65px" class="cls_004"><span class="cls_004">elements:</span></div>
<div style="position:absolute;left:78.82px;top:412.41px" class="cls_004"><span class="cls_004">• A way to get Nix expressions to the clients; this defines source deployment.</span></div>
<div style="position:absolute;left:78.82px;top:433.43px" class="cls_004"><span class="cls_004">• A way to get binaries to the clients as an optimisation of source deployment through</span></div>
<div style="position:absolute;left:88.78px;top:445.39px" class="cls_004"><span class="cls_004">substitutes; this defines binary deployment.</span></div>
<div style="position:absolute;left:63.87px;top:466.14px" class="cls_004"><span class="cls_004">However, either can be omitted. Clearly, if the latter is omitted, we have pure source de-</span></div>
<div style="position:absolute;left:63.87px;top:478.10px" class="cls_004"><span class="cls_004">ployment. If the former is omitted, clients cannot install through Nix expressions (since</span></div>
<div style="position:absolute;left:63.87px;top:490.05px" class="cls_004"><span class="cls_004">they don’t have them), but they can install store paths directly, as we have seen in Sec-</span></div>
<div style="position:absolute;left:63.87px;top:502.01px" class="cls_004"><span class="cls_004">tion 5.5, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:527.02px" class="cls_015"><span class="cls_015">$ nix-env  -i  /nix/store/1ja1w63wbk5q...-hello-2.1.1.drv</span></div>
<div style="position:absolute;left:63.87px;top:542.51px" class="cls_004"><span class="cls_004">or</span></div>
<div style="position:absolute;left:88.78px;top:567.53px" class="cls_015"><span class="cls_015">$ nix-env  -i  /nix/store/bwacc7a5c5n3...-hello-2.1.1</span></div>
<div style="position:absolute;left:73.84px;top:583.02px" class="cls_004"><span class="cls_004">This section describes a number of concrete policies that have been implemented.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">187</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:132480px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background196.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_009"><span class="cls_009">Direct download</span><span class="cls_004">   The most primitive deployment mechanism is to have users download</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">Nix expressions, e.g.,</span></div>
<div style="position:absolute;left:84.62px;top:80.34px" class="cls_015"><span class="cls_015">$ wget  </span><A HREF="http://example.org/nixpkgs.tar.bz2/">http://example.org/nixpkgs.tar.bz2</A> </div>
<div style="position:absolute;left:84.62px;top:91.30px" class="cls_015"><span class="cls_015">$ tar  xvfj  nixpkgs.tar.bz2</span></div>
<div style="position:absolute;left:84.62px;top:102.26px" class="cls_015"><span class="cls_015">$ nix-env  -f  ./nixpkgs/pkgs/system/all-packages.nix  -i  ...</span></div>
<div style="position:absolute;left:59.72px;top:116.10px" class="cls_004"><span class="cls_004">Of course, this source deployment policy can be made into a binary deployment policy by</span></div>
<div style="position:absolute;left:59.72px;top:128.05px" class="cls_004"><span class="cls_004">having clients perform a</span><span class="cls_007"> nix-pull</span><span class="cls_004"> of a manifest corresponding to the set of Nix expressions.</span></div>
<div style="position:absolute;left:69.68px;top:140.01px" class="cls_004"><span class="cls_004">While this policy is primitive, it is quite useful in many environments. For instance, it</span></div>
<div style="position:absolute;left:59.72px;top:151.96px" class="cls_004"><span class="cls_004">can be used in many typical networked environments to automatically distribute compo-</span></div>
<div style="position:absolute;left:59.72px;top:163.92px" class="cls_004"><span class="cls_004">nents to (say) all desktop machines. The clients could periodically execute the displayed</span></div>
<div style="position:absolute;left:59.72px;top:175.87px" class="cls_004"><span class="cls_004">command sequences (a pull model), or the commands could be executed automatically by</span></div>
<div style="position:absolute;left:59.72px;top:187.83px" class="cls_004"><span class="cls_004">remote login from a script executed centrally by the system administrator (a push model).</span></div>
<div style="position:absolute;left:59.72px;top:214.16px" class="cls_009"><span class="cls_009">Distribution through a version management system</span><span class="cls_004">   A slight modification of the pre-</span></div>
<div style="position:absolute;left:59.72px;top:226.12px" class="cls_004"><span class="cls_004">vious scheme is to obtain the Nix expressions from a version management repository in-</span></div>
<div style="position:absolute;left:59.72px;top:238.07px" class="cls_004"><span class="cls_004">stead of a direct download. The following obtains a working copy of a set of Nix expres-</span></div>
<div style="position:absolute;left:59.72px;top:250.03px" class="cls_004"><span class="cls_004">sions from a Subversion repository:</span></div>
<div style="position:absolute;left:84.62px;top:273.38px" class="cls_015"><span class="cls_015">$ svn  co  </span><A HREF="http://example.org/nixpkgs/">http://example.org/nixpkgs</A> </div>
<div style="position:absolute;left:84.62px;top:284.34px" class="cls_015"><span class="cls_015">$ nix-env  -f  ./nixpkgs/pkgs/system/all-packages.nix  -i  ...</span></div>
<div style="position:absolute;left:59.72px;top:298.17px" class="cls_004"><span class="cls_004">The command</span><span class="cls_007"> svn up</span><span class="cls_004"> can then be used to keep the Nix expressions up to date.</span></div>
<div style="position:absolute;left:69.68px;top:310.13px" class="cls_004"><span class="cls_004">An advantage of this policy is that it makes it easy to maintain local modifications to</span></div>
<div style="position:absolute;left:59.72px;top:322.08px" class="cls_004"><span class="cls_004">the set of Nix expressions. The version management tool ensures that updates from the</span></div>
<div style="position:absolute;left:59.72px;top:334.04px" class="cls_004"><span class="cls_004">repository are merged with local modifications.</span></div>
<div style="position:absolute;left:69.68px;top:345.99px" class="cls_004"><span class="cls_004">Again,</span><span class="cls_007"> nix-pull</span><span class="cls_004"> can be used to turn this into a binary deployment scheme. However, with</span></div>
<div style="position:absolute;left:59.72px;top:357.95px" class="cls_004"><span class="cls_004">local modifications, the deployer can no longer ensure that the expressions that the client</span></div>
<div style="position:absolute;left:59.72px;top:369.90px" class="cls_004"><span class="cls_004">installs have been pre-built. Of course, that is the whole point of transparent source/binary</span></div>
<div style="position:absolute;left:59.72px;top:381.86px" class="cls_004"><span class="cls_004">deployment: it enables binary deployment to “degrade” automatically to source deploy-</span></div>
<div style="position:absolute;left:59.72px;top:393.81px" class="cls_004"><span class="cls_004">ment.</span></div>
<div style="position:absolute;left:59.72px;top:420.15px" class="cls_009"><span class="cls_009">Channels</span><span class="cls_004">   Channels are a convenient way to keep a set of software components up to</span></div>
<div style="position:absolute;left:59.72px;top:432.10px" class="cls_004"><span class="cls_004">date.  A channel is a URL u such that there is an archive containing Nix expressions at</span></div>
<div style="position:absolute;left:59.72px;top:444.06px" class="cls_004"><span class="cls_004">u+</span><span class="cls_007">"/nixexprs.tar.bz2" </span><span class="cls_004">and a manifest at u+</span><span class="cls_007">"/MANIFEST"</span><span class="cls_004">. The archive file </span><span class="cls_007">nixexprs.tar.bz2</span></div>
<div style="position:absolute;left:59.72px;top:456.02px" class="cls_004"><span class="cls_004">must unpack to a single directory that must contain (at the very least) a Nix expression</span><span class="cls_007"> de-</span></div>
<div style="position:absolute;left:59.72px;top:467.97px" class="cls_007"><span class="cls_007">fault.nix</span><span class="cls_004">. The derivations produced by the evaluation of that expression are the derivations</span></div>
<div style="position:absolute;left:59.72px;top:479.93px" class="cls_004"><span class="cls_004">provided by the channel. The manifest provides optional binary deployment.</span></div>
<div style="position:absolute;left:69.68px;top:491.88px" class="cls_004"><span class="cls_004">Channels are managed on the client side through a simple tool called</span><span class="cls_007"> nix-channel</span><span class="cls_004">. Users</span></div>
<div style="position:absolute;left:59.72px;top:503.84px" class="cls_004"><span class="cls_004">can “subscribe” to a channel:</span></div>
<div style="position:absolute;left:84.62px;top:527.19px" class="cls_015"><span class="cls_015">$ nix-channel  --add  </span><A HREF="http://example.org/foo-channel/">http://example.org/foo-channel</A> </div>
<div style="position:absolute;left:59.72px;top:541.02px" class="cls_004"><span class="cls_004">This causes the specified URL to be added to a list of channel URLs maintained per user.</span></div>
<div style="position:absolute;left:59.72px;top:552.97px" class="cls_004"><span class="cls_004">Next, the client can obtain the latest Nix expressions and manifests from all subscribed</span></div>
<div style="position:absolute;left:59.72px;top:564.93px" class="cls_004"><span class="cls_004">channels:</span></div>
<div style="position:absolute;left:84.62px;top:588.28px" class="cls_015"><span class="cls_015">$ nix-channel  --update</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">188</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:133170px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background197.jpg" width=481 height=680></div>
<div style="position:absolute;left:319.61px;top:17.14px" class="cls_004"><span class="cls_004">7.4. Deployment policies</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">The  update  operation,  for  each  subscribed  channel  u,  performs  a</span><span class="cls_007">  nix-pull</span><span class="cls_004">  on  u +</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_007"><span class="cls_007">"/MANIFEST"</span><span class="cls_004">, and downloads and unpacks u +</span><span class="cls_007"> "/nixexprs.tar.bz2"</span><span class="cls_004">. It then makes the union</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">of the derivations in all Nix expressions the default for</span><span class="cls_007"> nix-env</span><span class="cls_004"> operations (through the</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">command</span><span class="cls_007"> nix-env -I</span><span class="cls_004">). So after the update, components can be installed from the channels</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">using</span><span class="cls_007"> nix-env</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:88.78px;top:116.23px" class="cls_015"><span class="cls_015">$ nix-env  -i  foo</span></div>
<div style="position:absolute;left:63.87px;top:130.08px" class="cls_004"><span class="cls_004">Thus, a typical usage scenario is the following command sequence:</span></div>
<div style="position:absolute;left:88.78px;top:153.45px" class="cls_015"><span class="cls_015">$ nix-channel  --update</span></div>
<div style="position:absolute;left:88.78px;top:164.40px" class="cls_015"><span class="cls_015">$ nix-env  -u  '*'</span></div>
<div style="position:absolute;left:63.87px;top:178.26px" class="cls_004"><span class="cls_004">which updates all components in the user’s profile to the latest versions available from the</span></div>
<div style="position:absolute;left:63.87px;top:190.21px" class="cls_004"><span class="cls_004">subscribed channels. A typical higher-level policy is to perform this sequence automati-</span></div>
<div style="position:absolute;left:63.87px;top:202.17px" class="cls_004"><span class="cls_004">cally at certain times (e.g., from a Unix</span><span class="cls_007"> cron</span><span class="cls_004"> job).</span></div>
<div style="position:absolute;left:63.87px;top:228.51px" class="cls_009"><span class="cls_009">One-click installations</span><span class="cls_004">   A one-click installation is a convenient mechanism to install a</span></div>
<div style="position:absolute;left:63.87px;top:240.46px" class="cls_004"><span class="cls_004">specific component.  For many users it is the easiest way to install a component.  One-</span></div>
<div style="position:absolute;left:63.87px;top:252.42px" class="cls_004"><span class="cls_004">click installations are based on Nix packages, which are plain-text files that contain just</span></div>
<div style="position:absolute;left:63.87px;top:264.37px" class="cls_004"><span class="cls_004">the following bits of information about a component:</span></div>
<div style="position:absolute;left:78.82px;top:283.48px" class="cls_004"><span class="cls_004">• Its symbolic name.</span></div>
<div style="position:absolute;left:78.82px;top:303.00px" class="cls_004"><span class="cls_004">• The store path of the store derivation.</span></div>
<div style="position:absolute;left:78.82px;top:322.51px" class="cls_004"><span class="cls_004">• The store path of the output, i.e., the</span><span class="cls_007"> output</span><span class="cls_004"> field of the store derivation.</span></div>
<div style="position:absolute;left:78.82px;top:342.03px" class="cls_004"><span class="cls_004">• Its platform identifier (e.g.,</span><span class="cls_007"> i686-linux</span><span class="cls_004">) to prevent the component from being installed</span></div>
<div style="position:absolute;left:88.78px;top:353.99px" class="cls_004"><span class="cls_004">on inappropriate systems.</span></div>
<div style="position:absolute;left:78.82px;top:373.50px" class="cls_004"><span class="cls_004">• The URL of a manifest.</span></div>
<div style="position:absolute;left:73.84px;top:392.61px" class="cls_004"><span class="cls_004">An example of the full contents of a package file is the following:</span></div>
<div style="position:absolute;left:88.78px;top:415.98px" class="cls_015"><span class="cls_015">NIXPKG1</span></div>
<div style="position:absolute;left:88.78px;top:426.94px" class="cls_015"><span class="cls_015"> </span><A HREF="http://nix.cs.uu.nl/dist/nix/nixpkgs-0.9pre3530/manifest/">http://nix.cs.uu.nl/dist/nix/nixpkgs-0.9pre3530/MANIFEST</A> </div>
<div style="position:absolute;left:88.78px;top:437.89px" class="cls_015"><span class="cls_015">firefox-1.0.6</span></div>
<div style="position:absolute;left:88.78px;top:448.85px" class="cls_015"><span class="cls_015">i686-linux</span></div>
<div style="position:absolute;left:88.78px;top:459.81px" class="cls_015"><span class="cls_015">/nix/store/cbqkqc039srl48yswgzx1gs5ywnkbidp-firefox-1.0.6.drv</span></div>
<div style="position:absolute;left:88.78px;top:470.77px" class="cls_015"><span class="cls_015">/nix/store/66zq88a8g36kmjl6w0nm5lfi2rvjj566-firefox-1.0.6</span></div>
<div style="position:absolute;left:73.84px;top:484.62px" class="cls_004"><span class="cls_004">Nix packages are intended to be associated in web browsers (through the MIME media</span></div>
<div style="position:absolute;left:63.87px;top:496.58px" class="cls_004"><span class="cls_004">type [74]</span><span class="cls_007"> application/nix-package</span><span class="cls_004">) with the package installer program</span><span class="cls_007"> nix-install-package</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:508.53px" class="cls_004"><span class="cls_004">Thus, by clicking on links in web pages to packages, the package is installed (hence the</span></div>
<div style="position:absolute;left:63.87px;top:520.49px" class="cls_004"><span class="cls_004">term “one-click installation”).  An example was shown in Figure 2.14 (page 44).  The</span></div>
<div style="position:absolute;left:63.87px;top:532.44px" class="cls_004"><span class="cls_004">installer</span><span class="cls_007"> nix-install-package</span><span class="cls_004"> may one day be a fancy graphical user interface showing in-</span></div>
<div style="position:absolute;left:63.87px;top:544.40px" class="cls_004"><span class="cls_004">stallation progress, but is currently just a simple script that performs the following actions:</span></div>
<div style="position:absolute;left:78.82px;top:563.51px" class="cls_004"><span class="cls_004">• It asks the user to confirm the installation.</span></div>
<div style="position:absolute;left:78.82px;top:583.02px" class="cls_004"><span class="cls_004">• It performs a</span><span class="cls_007"> nix-pull</span><span class="cls_004"> on the manifest.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">189</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:133860px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background198.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:74.66px;top:45.04px" class="cls_004"><span class="cls_004">• It installs the store path of the derivation output p directly by executing</span><span class="cls_007"> nix-env -i</span><span class="cls_004"> p.</span></div>
<div style="position:absolute;left:59.72px;top:63.04px" class="cls_004"><span class="cls_004">This suffices to perform a binary installation of the component and all its runtime depen-</span></div>
<div style="position:absolute;left:59.72px;top:74.99px" class="cls_004"><span class="cls_004">dencies.  A slight variation install the store path of the store derivation, rather than the</span></div>
<div style="position:absolute;left:59.72px;top:86.95px" class="cls_004"><span class="cls_004">output. In that case, source deployment is also possible.</span></div>
<div style="position:absolute;left:69.68px;top:98.90px" class="cls_004"><span class="cls_004">Note that this deployment method completely bypasses Nix expressions on the client</span></div>
<div style="position:absolute;left:59.72px;top:110.86px" class="cls_004"><span class="cls_004">side. The store path p is installed directly. The closure of p follows from the</span><span class="cls_007"> References</span></div>
<div style="position:absolute;left:59.72px;top:122.81px" class="cls_004"><span class="cls_004">fields in the manifest. If the Nix expression language changes in incompatible ways, the</span></div>
<div style="position:absolute;left:59.72px;top:134.77px" class="cls_004"><span class="cls_004">users of Nix packages are not affected. This demonstrates one of the advantages of sepa-</span></div>
<div style="position:absolute;left:59.72px;top:146.73px" class="cls_004"><span class="cls_004">rating the Nix build model into high-level Nix expressions and low-level store operations.</span></div>
<div style="position:absolute;left:59.72px;top:176.97px" class="cls_011"><span class="cls_011">7.5. Patch deployment</span></div>
<div style="position:absolute;left:59.72px;top:202.18px" class="cls_004"><span class="cls_004">As we have seen, Nix has a purely functional deployment model. This provides impor-</span></div>
<div style="position:absolute;left:59.72px;top:214.14px" class="cls_004"><span class="cls_004">tant advantages, such as side-by-side deployment of versions and variants, safe upgrades,</span></div>
<div style="position:absolute;left:59.72px;top:226.09px" class="cls_004"><span class="cls_004">the ability to roll back, and so on. However, there is a cost in that the purely functional</span></div>
<div style="position:absolute;left:59.72px;top:238.05px" class="cls_004"><span class="cls_004">model makes it hard to efficiently deploy upgrades to clients. In particular, upgrades to</span></div>
<div style="position:absolute;left:59.72px;top:250.00px" class="cls_004"><span class="cls_004">“fundamental” dependencies are expensive.</span></div>
<div style="position:absolute;left:69.68px;top:261.96px" class="cls_004"><span class="cls_004">Consider the dependency graph of Firefox shown in Figure 1.5 (page 10). The compo-</span></div>
<div style="position:absolute;left:59.72px;top:273.91px" class="cls_004"><span class="cls_004">nent at the top of the graph, used by almost all other components, is the GNU C Library</span></div>
<div style="position:absolute;left:59.72px;top:285.87px" class="cls_004"><span class="cls_004">(Glibc). Suppose that we discover a bug in Glibc, and wish to deploy a new version. The</span></div>
<div style="position:absolute;left:59.72px;top:297.82px" class="cls_004"><span class="cls_004">most straightforward way to do this is to update the Nix expression in Nixpkgs that builds</span></div>
<div style="position:absolute;left:59.72px;top:309.78px" class="cls_004"><span class="cls_004">Glibc to use the new version, and rebuild and reinstall the top-level components (e.g., Fire-</span></div>
<div style="position:absolute;left:59.72px;top:321.73px" class="cls_004"><span class="cls_004">fox) that depend on it. That is, we deploy to the clients a new set of Nix expressions for all</span></div>
<div style="position:absolute;left:59.72px;top:333.69px" class="cls_004"><span class="cls_004">installed components, and the client can then simply perform</span></div>
<div style="position:absolute;left:84.62px;top:355.95px" class="cls_015"><span class="cls_015">$ nix-env  -i  firefox</span></div>
<div style="position:absolute;left:59.72px;top:368.69px" class="cls_004"><span class="cls_004">or</span></div>
<div style="position:absolute;left:84.62px;top:390.95px" class="cls_015"><span class="cls_015">$ nix-env  -u  '*'  --leq</span></div>
<div style="position:absolute;left:59.72px;top:403.69px" class="cls_004"><span class="cls_004">to upgrade all installed components with versions that are higher or equal (e.g., simply</span></div>
<div style="position:absolute;left:59.72px;top:415.65px" class="cls_004"><span class="cls_004">built with newer dependencies).</span></div>
<div style="position:absolute;left:69.68px;top:427.60px" class="cls_004"><span class="cls_004">But this is expensive! Recall from Figure 2.3 (page 22) that a change to an input (such</span></div>
<div style="position:absolute;left:59.72px;top:439.56px" class="cls_004"><span class="cls_004">as Glibc) propagates through the dependency graph.  This has two effects.  First, all af-</span></div>
<div style="position:absolute;left:59.72px;top:451.52px" class="cls_004"><span class="cls_004">fected components must be rebuilt. This is exactly what we want, since the change to the</span></div>
<div style="position:absolute;left:59.72px;top:463.47px" class="cls_004"><span class="cls_004">dependencies may of course affect the result of the builds. This is the case even if inter-</span></div>
<div style="position:absolute;left:59.72px;top:475.43px" class="cls_004"><span class="cls_004">faces haven’t changed. Consider statically linked libraries, smart cross-module inlining,</span></div>
<div style="position:absolute;left:59.72px;top:487.38px" class="cls_004"><span class="cls_004">changes to the compiler affecting the binary interface, and so on. By far the easiest way to</span></div>
<div style="position:absolute;left:59.72px;top:499.34px" class="cls_004"><span class="cls_004">produce outputs that are consistent with the Nix expressions is to build them from scratch.</span></div>
<div style="position:absolute;left:59.72px;top:511.29px" class="cls_004"><span class="cls_004">Thanks to transparent source/binary deployment, this rebuild needs to be done only on the</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">distributor side; the clients just do an appropriate</span><span class="cls_007"> nix-pull</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:535.20px" class="cls_004"><span class="cls_004">Unfortunately, the second effect is that all affected components must be re-deployed</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">to the clients, i.e., the clients must download and install each affected component. This</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">creates a huge scalability problem, which this section attempts to address. If we want to</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">deploy a 100-byte bug fix to Glibc, almost all components in the system must be down-</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">loaded again, since at the very least the</span><span class="cls_007"> RPATH</span><span class="cls_004">s of dependent binaries will have changed</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">190</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:134550px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background199.jpg" width=481 height=680></div>
<div style="position:absolute;left:330.83px;top:17.14px" class="cls_004"><span class="cls_004">7.5. Patch deployment</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">to point at the new Glibc. Depending on network characteristics, this can take many hours</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">even on fast connections. Note that this is much worse than the first effect (having to re-</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">build the components), since that can be done centralised and only needs to be done once.</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">The re-deployment, on the other hand, must be done for each client.</span></div>
<div style="position:absolute;left:73.84px;top:93.75px" class="cls_004"><span class="cls_004">This shows the price to be paid for a purely functional deployment model. By contrast,</span></div>
<div style="position:absolute;left:63.87px;top:105.70px" class="cls_004"><span class="cls_004">consider deployment models that use destructive upgrading, i.e., that overwrite the files of</span></div>
<div style="position:absolute;left:63.87px;top:117.66px" class="cls_004"><span class="cls_004">components with newer versions. For instance, in RPM [62], we just install a new Glibc</span></div>
<div style="position:absolute;left:63.87px;top:129.62px" class="cls_004"><span class="cls_004">RPM package that overwrites the old one.</span></div>
<div style="position:absolute;left:73.84px;top:142.46px" class="cls_004"><span class="cls_004">This however prevents side-by-side deployment of variants (what if some component</span></div>
<div style="position:absolute;left:63.87px;top:154.41px" class="cls_004"><span class="cls_004">needs the old Glibc because it is incompatible with the new one?), makes rollbacks much</span></div>
<div style="position:absolute;left:63.87px;top:166.37px" class="cls_004"><span class="cls_004">harder (essential in server environments), and is generally bad from an SCM perspective</span></div>
<div style="position:absolute;left:63.87px;top:178.33px" class="cls_004"><span class="cls_004">(since it becomes much harder to identify the current configuration). Also, such destructive</span></div>
<div style="position:absolute;left:63.87px;top:190.28px" class="cls_004"><span class="cls_004">upgrades only work with dynamic linking and other late-binding techniques; if the com-</span></div>
<div style="position:absolute;left:63.87px;top:202.24px" class="cls_004"><span class="cls_004">ponent has been statically linked into other components at build time, we must identify all</span></div>
<div style="position:absolute;left:63.87px;top:214.19px" class="cls_004"><span class="cls_004">affected components and upgrade them as well. This was a major problem when a security</span></div>
<div style="position:absolute;left:63.87px;top:226.15px" class="cls_004"><span class="cls_004">bug was discovered in the ubiquitous Zlib compression library [1].</span></div>
<div style="position:absolute;left:73.84px;top:238.99px" class="cls_004"><span class="cls_004">If we were to use destructive upgrading in Nix, it would violate the crucial deployment</span></div>
<div style="position:absolute;left:63.87px;top:250.95px" class="cls_004"><span class="cls_004">invariant that the hash of a path uniquely describes the component.</span></div>
<div style="position:absolute;left:348.07px;top:250.95px" class="cls_004"><span class="cls_004">(This is similar to</span></div>
<div style="position:absolute;left:63.87px;top:262.90px" class="cls_004"><span class="cls_004">allowing assignments in purely functional programming languages such as Haskell [135].)</span></div>
<div style="position:absolute;left:63.87px;top:274.86px" class="cls_004"><span class="cls_004">From a configuration management perspective, the hashes identify the configuration of the</span></div>
<div style="position:absolute;left:63.87px;top:286.81px" class="cls_004"><span class="cls_004">components, and destructive updates remove the ability to identify what we have on our</span></div>
<div style="position:absolute;left:63.87px;top:298.77px" class="cls_004"><span class="cls_004">system.  Also, it destroys the component isolation property, i.e., that an upgrade to one</span></div>
<div style="position:absolute;left:63.87px;top:310.72px" class="cls_004"><span class="cls_004">component cannot cause the failure to another component. If an upgrade is not entirely</span></div>
<div style="position:absolute;left:63.87px;top:322.68px" class="cls_004"><span class="cls_004">backwards compatible, this no longer holds.</span></div>
<div style="position:absolute;left:73.84px;top:335.52px" class="cls_004"><span class="cls_004">One might ask whether the relative difficulty (in terms of hardware resources, not de-</span></div>
<div style="position:absolute;left:63.87px;top:347.48px" class="cls_004"><span class="cls_004">veloper or user effort) of deploying upgrades doesn’t show that Nix is unsuitable for large-</span></div>
<div style="position:absolute;left:63.87px;top:359.43px" class="cls_004"><span class="cls_004">scale software deployment.  However, Nix’s advantages in supporting side-by-side vari-</span></div>
<div style="position:absolute;left:63.87px;top:371.39px" class="cls_004"><span class="cls_004">ability, correct dependency, atomic rollbacks, and so on, in the face of a quasi-component</span></div>
<div style="position:absolute;left:63.87px;top:383.34px" class="cls_004"><span class="cls_004">model (i.e., the huge base of existing Unix packages) not designed to support those fea-</span></div>
<div style="position:absolute;left:63.87px;top:395.30px" class="cls_004"><span class="cls_004">tures, make it compelling to seek a solution to the upgrade deployment problem within the</span></div>
<div style="position:absolute;left:63.87px;top:407.25px" class="cls_004"><span class="cls_004">Nix framework.</span></div>
<div style="position:absolute;left:63.87px;top:438.67px" class="cls_009"><span class="cls_009">Upgrading through wrappers</span><span class="cls_004">   One way to efficiently deploy upgrades that works in</span></div>
<div style="position:absolute;left:63.87px;top:450.63px" class="cls_004"><span class="cls_004">many instances of late static composition is to use wrapper components. These were al-</span></div>
<div style="position:absolute;left:63.87px;top:462.58px" class="cls_004"><span class="cls_004">ready discussed in Section 7.1.1. The idea is to deploy a new set of Nix expressions that</span></div>
<div style="position:absolute;left:63.87px;top:474.54px" class="cls_004"><span class="cls_004">describe a new derivation graph that is exactly the same as the original one (thus previously</span></div>
<div style="position:absolute;left:63.87px;top:486.49px" class="cls_004"><span class="cls_004">installed components do not need to be rebuilt or redownloaded), except that at top-level</span></div>
<div style="position:absolute;left:63.87px;top:498.45px" class="cls_004"><span class="cls_004">a wrapper component is added. This wrapper must ensure that at runtime the upgraded</span></div>
<div style="position:absolute;left:63.87px;top:510.40px" class="cls_004"><span class="cls_004">component is used, rather than the old one.</span></div>
<div style="position:absolute;left:73.84px;top:523.25px" class="cls_004"><span class="cls_004">Figure 7.6 shows an example for Mozilla Firefox, which has a dependency on Glibc,</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">both directly and indirectly through GTK; this situation is shown on the left. Suppose that</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">we want to deploy an upgraded version of Glibc. We deploy a Nix expression that evaluates</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">to the derivations shown on the right. The wrapper component depends on Firefox (which</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">it wraps and forwards to), and the new Glibc (</span><span class="cls_007">glibc’</span><span class="cls_004">). The wrapper script for Firefox calls</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">the original Firefox like this:</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">191</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:135240px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background200.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:281.33px;top:50.04px" class="cls_048"><span class="cls_048">glibc</span></div>
<div style="position:absolute;left:119.51px;top:86.04px" class="cls_048"><span class="cls_048">glibc</span></div>
<div style="position:absolute;left:283.33px;top:86.04px" class="cls_048"><span class="cls_048">gtk</span></div>
<div style="position:absolute;left:318.83px;top:86.04px" class="cls_048"><span class="cls_048">glib</span></div>
<div style="position:absolute;left:121.51px;top:122.04px" class="cls_048"><span class="cls_048">gtk</span></div>
<div style="position:absolute;left:157.01px;top:122.04px" class="cls_048"><span class="cls_048">glib</span></div>
<div style="position:absolute;left:296.33px;top:122.04px" class="cls_048"><span class="cls_048">firefox</span></div>
<div style="position:absolute;left:337.33px;top:122.04px" class="cls_048"><span class="cls_048">glibc’</span></div>
<div style="position:absolute;left:134.51px;top:158.04px" class="cls_048"><span class="cls_048">firefox</span></div>
<div style="position:absolute;left:303.83px;top:158.04px" class="cls_048"><span class="cls_048">firefoxWrapper</span></div>
<div style="position:absolute;left:94.37px;top:173.53px" class="cls_004"><span class="cls_004">Original derivation graph</span></div>
<div style="position:absolute;left:274.26px;top:173.53px" class="cls_004"><span class="cls_004">New derivation graph</span></div>
<div style="position:absolute;left:156.96px;top:193.40px" class="cls_004"><span class="cls_004">Figure 7.6.: Upgrading through wrappers</span></div>
<div style="position:absolute;left:84.62px;top:228.96px" class="cls_015"><span class="cls_015">LD_LIBRARY_PATH=new-glibc-path :$LD_LIBRARY_PATH</span></div>
<div style="position:absolute;left:84.62px;top:240.91px" class="cls_015"><span class="cls_015">exec  original-firefox-path /bin/firefox  "$@"</span></div>
<div style="position:absolute;left:59.72px;top:253.85px" class="cls_004"><span class="cls_004">This causes the dynamic linker to use the new Glibc instead of the old one</span><span class="cls_012"><sup>8</sup></span><span class="cls_004">. The old Glibc</span></div>
<div style="position:absolute;left:59.72px;top:266.84px" class="cls_004"><span class="cls_004">is still part of the closure, but it won’t be used.</span></div>
<div style="position:absolute;left:69.68px;top:278.79px" class="cls_004"><span class="cls_004">Clearly, the</span><span class="cls_007"> LD_LIBRARY_PATH</span><span class="cls_004"> is highly specific to dynamic linking on certain Unix</span></div>
<div style="position:absolute;left:59.72px;top:290.75px" class="cls_004"><span class="cls_004">platforms, although similar tricks are available for many other types of composition (e.g.,</span></div>
<div style="position:absolute;left:59.72px;top:302.70px" class="cls_004"><span class="cls_004">juggling the</span><span class="cls_007"> PATH</span><span class="cls_004"> variable for composition through program calls). We also often cannot</span></div>
<div style="position:absolute;left:59.72px;top:314.66px" class="cls_004"><span class="cls_004">be certain that the override is used in all places. Finally, unscoped composition mecha-</span></div>
<div style="position:absolute;left:59.72px;top:326.61px" class="cls_004"><span class="cls_004">nisms make it quite hard to see what the effect of an override will be, leading to buggy</span></div>
<div style="position:absolute;left:59.72px;top:338.57px" class="cls_004"><span class="cls_004">wrappers.</span></div>
<div style="position:absolute;left:59.72px;top:364.82px" class="cls_009"><span class="cls_009">A general solution: binary patching</span><span class="cls_004">  Thus, upgrading through wrappers is not a gen-</span></div>
<div style="position:absolute;left:59.72px;top:376.77px" class="cls_004"><span class="cls_004">eral solution.  A general solution to the huge binary redeployment caused by a change</span></div>
<div style="position:absolute;left:59.72px;top:388.73px" class="cls_004"><span class="cls_004">to a fundamental component such as Glibc is by transparently deploying binary patches</span></div>
<div style="position:absolute;left:59.72px;top:400.68px" class="cls_004"><span class="cls_004">between component releases.  For instance, if a bug fix to Glibc induces a switch from</span></div>
<div style="position:absolute;left:59.72px;top:412.64px" class="cls_007"><span class="cls_007">/nix/store/72by2iw5wd8i...-glibc-2.3.5</span><span class="cls_004"> to</span><span class="cls_007"> /nix/store/shfb6q9yvk0l...-glibc-2.3.5-patch-1</span><span class="cls_004">, then</span></div>
<div style="position:absolute;left:59.72px;top:424.59px" class="cls_004"><span class="cls_004">we compute the delta (the binary patch) between the contents of those paths and make the</span></div>
<div style="position:absolute;left:59.72px;top:436.55px" class="cls_004"><span class="cls_004">patch available to clients. We also do this for all components depending on it. Subsequently</span></div>
<div style="position:absolute;left:59.72px;top:448.50px" class="cls_004"><span class="cls_004">the clients can apply those patches to the old version to produce the new version. As we</span></div>
<div style="position:absolute;left:59.72px;top:460.46px" class="cls_004"><span class="cls_004">shall see in Section 7.5.4, patches for components affected by a change to a dependency</span></div>
<div style="position:absolute;left:59.72px;top:472.41px" class="cls_004"><span class="cls_004">are generally very small.</span></div>
<div style="position:absolute;left:69.68px;top:484.37px" class="cls_004"><span class="cls_004">A binary patch describes a set of edit operations that transforms a base FSO stored at</span></div>
<div style="position:absolute;left:59.72px;top:496.32px" class="cls_004"><span class="cls_004">path p</span><span class="cls_012"><sub>src</sub></span><span class="cls_004"> in the Nix store into a target FSO stored at path p</span><span class="cls_012"><sub>dst</sub></span><span class="cls_004"> . Thus, if a client needs path</span></div>
<div style="position:absolute;left:60.46px;top:508.28px" class="cls_004"><span class="cls_004">p</span><span class="cls_012"><sub>dst</sub></span><span class="cls_004"> and it has path p</span><span class="cls_012"><sub>src</sub></span><span class="cls_004"> already installed, then it can speed up the installation of p</span><span class="cls_012"><sub>dst</sub></span><span class="cls_004"> by</span></div>
<div style="position:absolute;left:59.72px;top:520.23px" class="cls_004"><span class="cls_004">downloading the patch from p</span><span class="cls_012"><sub>src</sub></span><span class="cls_004"> to p</span><span class="cls_012"><sub>dst</sub></span><span class="cls_004"> , copying p</span><span class="cls_012"><sub>src</sub></span><span class="cls_004"> to p</span><span class="cls_012"><sub>dst</sub></span><span class="cls_004"> in the Nix store, and finally</span></div>
<div style="position:absolute;left:59.72px;top:532.19px" class="cls_004"><span class="cls_004">applying the patch to p</span><span class="cls_012"><sub>dst</sub></span><span class="cls_004"> .</span></div>
<div style="position:absolute;left:69.68px;top:544.15px" class="cls_004"><span class="cls_004">This fits nicely into Nix’s substitute mechanism (Section 7.3) used to implement trans-</span></div>
<div style="position:absolute;left:59.72px;top:556.10px" class="cls_004"><span class="cls_004">parent binary deployment. We just extend its download capabilities: if a patch is available,</span></div>
<div style="position:absolute;left:64.20px;top:574.65px" class="cls_013"><span class="cls_013"><sup>8</sup></span><span class="cls_014">It’s a bit more tricky in reality, since the path of the old Glibc is hard-coded into the</span><span class="cls_016"> RPATH</span><span class="cls_014">s of the Firefox and</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">GTK binaries. The dynamic linker has an option to override the</span><span class="cls_016"> RPATH</span><span class="cls_014">, however.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">192</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:135930px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background201.jpg" width=481 height=680></div>
<div style="position:absolute;left:330.83px;top:17.14px" class="cls_004"><span class="cls_004">7.5. Patch deployment</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">rather than doing a full download, we download the patch instead. Manifests are extended</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">to specify the availability of patches. For instance, the manifest entry</span></div>
<div style="position:absolute;left:88.78px;top:78.33px" class="cls_015"><span class="cls_015">patch  {</span></div>
<div style="position:absolute;left:98.19px;top:89.28px" class="cls_015"><span class="cls_015">StorePath:  /nix/store/lhix54krdqkp...-firefox-1.0</span></div>
<div style="position:absolute;left:98.19px;top:100.24px" class="cls_015"><span class="cls_015">NarURL:  </span><A HREF="http://server/0iihh1l7vvpa...-firefox-1.0.nar-bsdiff/">http://server/0iihh1l7vvpa...-firefox-1.0.nar-bsdiff</A> </div>
<div style="position:absolute;left:98.19px;top:111.20px" class="cls_015"><span class="cls_015">Hash:  sha256:...</span></div>
<div style="position:absolute;left:98.19px;top:122.16px" class="cls_015"><span class="cls_015">NarHash:  sha256:...</span></div>
<div style="position:absolute;left:98.19px;top:133.12px" class="cls_015"><span class="cls_015">Size:  357</span></div>
<div style="position:absolute;left:98.19px;top:144.08px" class="cls_015"><span class="cls_015">BasePath:  /nix/store/mkmpxqr8d7f7...-firefox-1.0</span></div>
<div style="position:absolute;left:98.19px;top:155.04px" class="cls_015"><span class="cls_015">BaseHash:  sha256:...</span></div>
<div style="position:absolute;left:88.78px;top:166.00px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:63.87px;top:177.81px" class="cls_004"><span class="cls_004">describes a 357-byte patch from the Firefox component shown in the previous section</span></div>
<div style="position:absolute;left:63.87px;top:189.77px" class="cls_004"><span class="cls_004">(stored at</span><span class="cls_007"> BasePath</span><span class="cls_004">) to a new one (stored at</span><span class="cls_007"> StorePath</span><span class="cls_004">) induced by a Glibc upgrade. If</span></div>
<div style="position:absolute;left:63.87px;top:201.72px" class="cls_004"><span class="cls_004">a patch is not available, or if the base component is not installed, we fall back to a full</span></div>
<div style="position:absolute;left:63.87px;top:213.68px" class="cls_004"><span class="cls_004">download of the new component; or even a local build if no download is available.</span></div>
<div style="position:absolute;left:73.84px;top:225.63px" class="cls_007"><span class="cls_007">NarURL</span><span class="cls_004"> is the URL of the patch,</span><span class="cls_007"> Hash</span><span class="cls_004"> is the cryptographic hash of the contents of the</span></div>
<div style="position:absolute;left:63.87px;top:237.59px" class="cls_004"><span class="cls_004">patch, and</span><span class="cls_007"> NarHash</span><span class="cls_004"> is the cryptographic hash of the serialisation of the resulting FSO (just</span></div>
<div style="position:absolute;left:63.87px;top:249.54px" class="cls_004"><span class="cls_004">as in normal downloads).</span><span class="cls_007"> BaseHash</span><span class="cls_004"> is the cryptographic hash of the serialisation of the</span></div>
<div style="position:absolute;left:63.87px;top:261.50px" class="cls_004"><span class="cls_004">FSO at the base path to which the patch applies. In the extensional model, due to impure</span></div>
<div style="position:absolute;left:63.87px;top:273.45px" class="cls_004"><span class="cls_004">builders, the contents of an FSO at a given path need not always be the same. If the local</span></div>
<div style="position:absolute;left:63.87px;top:285.41px" class="cls_004"><span class="cls_004">contents differ from the contents on which the patch is based at the deployer’s machine,</span></div>
<div style="position:absolute;left:63.87px;top:297.36px" class="cls_004"><span class="cls_004">then the patch cannot be applied. In the intensional model with its content-addressable Nix</span></div>
<div style="position:absolute;left:63.87px;top:309.32px" class="cls_004"><span class="cls_004">store, this is not an issue: if due to builder impurity a derivation has produced different</span></div>
<div style="position:absolute;left:63.87px;top:321.27px" class="cls_004"><span class="cls_004">output on the local machine than on the deployer’s, the patch’s base path simply will not</span></div>
<div style="position:absolute;left:63.87px;top:333.23px" class="cls_004"><span class="cls_004">exist.</span></div>
<div style="position:absolute;left:63.87px;top:360.31px" class="cls_008"><span class="cls_008">7.5.1. Binary patch creation</span></div>
<div style="position:absolute;left:63.87px;top:379.78px" class="cls_004"><span class="cls_004">There are many off-the-shelf algorithms and implementations to compute binary deltas</span></div>
<div style="position:absolute;left:63.87px;top:391.74px" class="cls_004"><span class="cls_004">between two arbitrary files.  Such algorithms produce a list of edit operations such as</span></div>
<div style="position:absolute;left:63.87px;top:403.69px" class="cls_004"><span class="cls_004">copying a sequence of bytes from a position in the original file to a possibly different</span></div>
<div style="position:absolute;left:63.87px;top:415.65px" class="cls_004"><span class="cls_004">position in the new file, inserting a new sequence of bytes at a some position in the new</span></div>
<div style="position:absolute;left:63.87px;top:427.60px" class="cls_004"><span class="cls_004">file, and so on. I used the</span><span class="cls_007"> bsdiff</span><span class="cls_004"> utility [132] because it produces relatively small patches</span></div>
<div style="position:absolute;left:63.87px;top:439.56px" class="cls_004"><span class="cls_004">(see Section 7.6).</span></div>
<div style="position:absolute;left:73.84px;top:451.52px" class="cls_004"><span class="cls_004">However, the components in the Nix store are arbitrary directory trees. How do we pro-</span></div>
<div style="position:absolute;left:63.87px;top:463.47px" class="cls_004"><span class="cls_004">duce deltas between directories trees? A “simple” solution is to compute deltas between</span></div>
<div style="position:absolute;left:63.87px;top:475.43px" class="cls_004"><span class="cls_004">corresponding regular files (i.e., with the same relative path in the components) and dis-</span></div>
<div style="position:absolute;left:63.87px;top:487.38px" class="cls_004"><span class="cls_004">tribute all deltas together.  The full contents of all new files in the target should also be</span></div>
<div style="position:absolute;left:63.87px;top:499.34px" class="cls_004"><span class="cls_004">added, as well as a list describing file deletions, changes to symlink contents, etc. Files not</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">listed can be assumed to be unchanged.</span></div>
<div style="position:absolute;left:73.84px;top:523.25px" class="cls_004"><span class="cls_004">This method is both complicated and has the severe problem of not following renames.</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">For instance, the Firefox component stores most of its files in a subdirectory</span><span class="cls_007"> lib/firefox-</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_007"><span class="cls_007">version</span><span class="cls_004">.  The method described above fails to patch, e.g.,</span><span class="cls_007"> lib/firefox-0.9/libmozjs.so</span><span class="cls_004"> into</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_007"><span class="cls_007">lib/firefox-1.0/libmozjs.so</span><span class="cls_004"> since the path names do not correspond; rather, the latter file is</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">stored in full in the patch. Hence, with this method patching is not very effective in the</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">presence of renames.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">193</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:136620px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background202.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:216.40px;top:55.66px" class="cls_051"><span class="cls_051">c0 0f 85 2b fc</span></div>
<div style="position:absolute;left:99.59px;top:53.84px" class="cls_049"><span class="cls_049">Base</span></div>
<div style="position:absolute;left:196.81px;top:56.99px" class="cls_050"><span class="cls_050">A/B</span></div>
<div style="position:absolute;left:216.40px;top:60.81px" class="cls_051"><span class="cls_051">ff ff 8b 45 d8</span></div>
<div style="position:absolute;left:216.40px;top:65.90px" class="cls_051"><span class="cls_051">85 c0 0f f3 ..</span></div>
<div style="position:absolute;left:274.83px;top:88.09px" class="cls_050"><span class="cls_050">copy</span></div>
<div style="position:absolute;left:316.00px;top:123.23px" class="cls_051"><span class="cls_051">c0 0f 85 2b fc</span></div>
<div style="position:absolute;left:296.42px;top:124.56px" class="cls_050"><span class="cls_050">C/D</span></div>
<div style="position:absolute;left:316.00px;top:128.32px" class="cls_051"><span class="cls_051">ff ff 8b 45 d8</span></div>
<div style="position:absolute;left:99.59px;top:123.56px" class="cls_049"><span class="cls_049">Target</span></div>
<div style="position:absolute;left:316.00px;top:133.47px" class="cls_051"><span class="cls_051">85 c0 0f f3 ..</span></div>
<div style="position:absolute;left:84.26px;top:168.77px" class="cls_004"><span class="cls_004">Figure 7.7.: Deltas between archives handle renames, deletions, and additions</span></div>
<div style="position:absolute;left:69.68px;top:200.86px" class="cls_004"><span class="cls_004">There is however a much simpler and more effective solution: we take the patch between</span></div>
<div style="position:absolute;left:59.72px;top:212.82px" class="cls_004"><span class="cls_004">the serialisations of the components. That is, we use the function</span><span class="cls_007"> serialise</span><span class="cls_004"> (Section 5.2.1)</span></div>
<div style="position:absolute;left:59.72px;top:224.77px" class="cls_004"><span class="cls_004">to produce NAR archives for both the old and the new FSO, and compute the binary delta</span></div>
<div style="position:absolute;left:59.72px;top:236.73px" class="cls_004"><span class="cls_004">between those two files. Here we see why it is important that</span><span class="cls_007"> serialise</span><span class="cls_004"> produces a canonical</span></div>
<div style="position:absolute;left:59.72px;top:248.68px" class="cls_004"><span class="cls_004">representation of the FSO: it prevents a patch from failing to apply due to implementation</span></div>
<div style="position:absolute;left:59.72px;top:260.64px" class="cls_004"><span class="cls_004">differences in the archiving tool, or system dependencies (e.g., different orderings of files</span></div>
<div style="position:absolute;left:59.72px;top:272.59px" class="cls_004"><span class="cls_004">in directories). Formats such as TAR and ZIP do not have a canonical form.</span></div>
<div style="position:absolute;left:69.68px;top:284.57px" class="cls_004"><span class="cls_004">Computing deltas between archives automatically takes renames, deletions, file type</span></div>
<div style="position:absolute;left:59.72px;top:296.52px" class="cls_004"><span class="cls_004">changes, etc.  into account, since these are just simple changes within the archive files.</span></div>
<div style="position:absolute;left:59.72px;top:308.48px" class="cls_004"><span class="cls_004">Figure 7.7 shows an example of why this is the case: the original file</span><span class="cls_007"> A/B</span><span class="cls_004"> has been moved</span></div>
<div style="position:absolute;left:59.72px;top:320.43px" class="cls_004"><span class="cls_004">and renamed to</span><span class="cls_007"> C/D</span><span class="cls_004">, which furthermore is stored in a different part of the NAR archive.</span></div>
<div style="position:absolute;left:59.72px;top:332.39px" class="cls_004"><span class="cls_004">However, the file contents are the same (or mildly changed). The binary delta algorithm</span></div>
<div style="position:absolute;left:59.72px;top:344.34px" class="cls_004"><span class="cls_004">will just emit an edit operation that changes the first file name into the second, followed by</span></div>
<div style="position:absolute;left:59.72px;top:356.30px" class="cls_004"><span class="cls_004">the appropriate edit operations for the file contents. It does not matter whether the position</span></div>
<div style="position:absolute;left:59.72px;top:368.25px" class="cls_004"><span class="cls_004">of the file in the archive has changed: contrary to delta algorithms like the standard</span><span class="cls_007"> diff</span></div>
<div style="position:absolute;left:59.72px;top:380.21px" class="cls_004"><span class="cls_004">tool,</span><span class="cls_007"> bsdiff</span><span class="cls_004"> can handle re-orderings of the data.</span></div>
<div style="position:absolute;left:69.68px;top:392.18px" class="cls_004"><span class="cls_004">To apply a patch, a client creates an archive of the base component, applies the binary</span></div>
<div style="position:absolute;left:59.72px;top:404.14px" class="cls_004"><span class="cls_004">patch to it, and unpacks the resulting archive into the target path.</span></div>
<div style="position:absolute;left:59.72px;top:431.98px" class="cls_008"><span class="cls_008">7.5.2. Patch chaining</span></div>
<div style="position:absolute;left:59.72px;top:451.49px" class="cls_004"><span class="cls_004">It is generally infeasible to produce patches between every pair of releases of a set of com-</span></div>
<div style="position:absolute;left:59.72px;top:462.42px" class="cls_004"><span class="cls_004">ponents. The number of patches would be O(n</span><span class="cls_012"><sup>2</sup></span><span class="cls_004">m), where n is the number of releases and</span></div>
<div style="position:absolute;left:59.72px;top:475.40px" class="cls_004"><span class="cls_004">m is the number of components. As an example, consider the Nix Packages collection. Pre-</span></div>
<div style="position:absolute;left:59.72px;top:487.36px" class="cls_004"><span class="cls_004">releases of Nixpkgs are made automatically by a build farm (Chapter 8) on every commit to</span></div>
<div style="position:absolute;left:59.72px;top:499.31px" class="cls_004"><span class="cls_004">its version management repository, which typically is several times a day. The pre-releases</span></div>
<div style="position:absolute;left:59.72px;top:511.27px" class="cls_004"><span class="cls_004">are made available in a channel.  Since we do not want to impose full redownloads on</span></div>
<div style="position:absolute;left:59.72px;top:523.23px" class="cls_004"><span class="cls_004">developers whenever something changes, we want to make patches available.</span></div>
<div style="position:absolute;left:69.68px;top:535.20px" class="cls_004"><span class="cls_004">Unfortunately, since pre-releases appear so often, we cannot feasibly produce patches</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">between each pair of pre-releases.  So as a general policy we only produce patches be-</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">tween immediately succeeding pre-releases. Given releases</span><span class="cls_007"> 0.7pre1899</span><span class="cls_004">,</span><span class="cls_007"> 0.7pre1928</span><span class="cls_004"> and</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_007"><span class="cls_007">0.7pre1931</span><span class="cls_004">, we produce patches between</span><span class="cls_007"> 0.7pre1899</span><span class="cls_004"> and</span><span class="cls_007"> 0.7pre1928</span><span class="cls_004">, and between</span><span class="cls_007"> 0.7pre-</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_007"><span class="cls_007">1928</span><span class="cls_004"> and</span><span class="cls_007"> 0.7pre1931</span><span class="cls_004">. This creates a problem, however: suppose that a user has Firefox</span></div>
<div style="position:absolute;left:59.72px;top:624.86px" class="cls_004"><span class="cls_004">194</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:137310px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background203.jpg" width=481 height=680></div>
<div style="position:absolute;left:330.83px;top:17.14px" class="cls_004"><span class="cls_004">7.5. Patch deployment</span></div>
<div style="position:absolute;left:70.27px;top:62.08px" class="cls_052"><span class="cls_052">0.5</span></div>
<div style="position:absolute;left:132.41px;top:62.08px" class="cls_052"><span class="cls_052">0.6pre1741</span></div>
<div style="position:absolute;left:178.93px;top:62.08px" class="cls_052"><span class="cls_052">0.6</span></div>
<div style="position:absolute;left:209.11px;top:62.08px" class="cls_052"><span class="cls_052">0.7pre1777</span></div>
<div style="position:absolute;left:253.85px;top:62.08px" class="cls_052"><span class="cls_052">0.7pre1785</span></div>
<div style="position:absolute;left:330.55px;top:62.08px" class="cls_052"><span class="cls_052">0.7pre1928</span></div>
<div style="position:absolute;left:409.03px;top:62.08px" class="cls_052"><span class="cls_052">0.7</span></div>
<div style="position:absolute;left:130.35px;top:110.61px" class="cls_004"><span class="cls_004">Figure 7.8.: Patch sets created between Nixpkgs releases</span></div>
<div style="position:absolute;left:63.87px;top:143.16px" class="cls_004"><span class="cls_004">from</span><span class="cls_007"> 0.7pre1899</span><span class="cls_004"> installed, and Firefox changed in both succeeding releases, then there is</span></div>
<div style="position:absolute;left:63.87px;top:155.11px" class="cls_004"><span class="cls_004">no patch that brings the user up-to-date.</span></div>
<div style="position:absolute;left:73.84px;top:167.32px" class="cls_004"><span class="cls_004">The solution is to automatically chain patches, i.e., using a series of available patches</span></div>
<div style="position:absolute;left:64.62px;top:179.27px" class="cls_004"><span class="cls_004">p</span><span class="cls_012"><sub>src</sub></span><span class="cls_004"> → ... → p</span><span class="cls_012"><sub>n</sub></span><span class="cls_004"> → p</span><span class="cls_012"><sub>dst</sub></span><span class="cls_004"> to produce path p</span><span class="cls_012"><sub>dst</sub></span><span class="cls_004">. In the example above, we have a Firefox</span></div>
<div style="position:absolute;left:63.87px;top:191.23px" class="cls_004"><span class="cls_004">component installed that can be used as the base path to a patch in the</span><span class="cls_007"> 0.7pre1928</span><span class="cls_004"> release,</span></div>
<div style="position:absolute;left:63.87px;top:203.18px" class="cls_004"><span class="cls_004">to produce a component that can in turn serve as a base path to a patch in the</span><span class="cls_007"> 0.7pre1931</span></div>
<div style="position:absolute;left:63.87px;top:215.14px" class="cls_004"><span class="cls_004">release.</span></div>
<div style="position:absolute;left:73.84px;top:227.34px" class="cls_004"><span class="cls_004">However, such patch sequences can eventually become so large that their combined size</span></div>
<div style="position:absolute;left:63.87px;top:239.30px" class="cls_004"><span class="cls_004">approaches or exceeds the size of full downloads. In that case we can “short-circuit” the</span></div>
<div style="position:absolute;left:63.87px;top:251.25px" class="cls_004"><span class="cls_004">sequence by adding patches between additional releases. Figure 7.8 shows an example of</span></div>
<div style="position:absolute;left:63.87px;top:263.21px" class="cls_004"><span class="cls_004">patches between Nixpkgs releases thus formed. Arrows indicate the existence of a patch</span></div>
<div style="position:absolute;left:63.87px;top:275.17px" class="cls_004"><span class="cls_004">set between pairs of releases. Here, patch sets are produced by directly succeeding pre-</span></div>
<div style="position:absolute;left:63.87px;top:287.12px" class="cls_004"><span class="cls_004">releases, and between any successive stable releases. An additional “short-circuit” patch</span></div>
<div style="position:absolute;left:63.87px;top:299.08px" class="cls_004"><span class="cls_004">set between</span><span class="cls_007"> 0.7pre1785</span><span class="cls_004"> and</span><span class="cls_007"> 0.7pre1928</span><span class="cls_004"> was also made.</span></div>
<div style="position:absolute;left:73.84px;top:311.28px" class="cls_004"><span class="cls_004">In the presence of patch sets between arbitrary releases, it is not directly obvious which</span></div>
<div style="position:absolute;left:63.87px;top:323.24px" class="cls_004"><span class="cls_004">sequence of patches or full downloads is optimal. To be fully general, the Nix substitute</span></div>
<div style="position:absolute;left:63.87px;top:335.19px" class="cls_004"><span class="cls_004">downloader runs a shortest path algorithm on a directed acyclic graph that, intuitively, rep-</span></div>
<div style="position:absolute;left:63.87px;top:347.15px" class="cls_004"><span class="cls_004">resents components already installed, available patches between components, and available</span></div>
<div style="position:absolute;left:63.87px;top:359.10px" class="cls_004"><span class="cls_004">full downloads of components. Formally, the graph is defined as follows:</span></div>
<div style="position:absolute;left:78.82px;top:379.78px" class="cls_004"><span class="cls_004">• The nodes are the store paths for which pre-built binaries are available on the server,</span></div>
<div style="position:absolute;left:88.78px;top:391.73px" class="cls_004"><span class="cls_004">either as full downloads or as patches, plus any store paths that serve as bases to</span></div>
<div style="position:absolute;left:88.78px;top:403.69px" class="cls_004"><span class="cls_004">patches. There is also a special</span><span class="cls_007"> start</span><span class="cls_004"> node.</span></div>
<div style="position:absolute;left:78.82px;top:424.61px" class="cls_004"><span class="cls_004">• There are three types of edges:</span></div>
<div style="position:absolute;left:100.74px;top:445.53px" class="cls_004"><span class="cls_004">- Patch edges between store paths that represent available patches.  The edge</span></div>
<div style="position:absolute;left:110.70px;top:457.49px" class="cls_004"><span class="cls_004">weight is the size of the patch (in bytes). In the extensional hash, edges from</span></div>
<div style="position:absolute;left:110.70px;top:469.44px" class="cls_004"><span class="cls_004">nodes representing valid store paths are only added if the cryptographic hash</span></div>
<div style="position:absolute;left:110.70px;top:481.40px" class="cls_004"><span class="cls_004">of the serialisation of the store path matches the patch’s</span><span class="cls_007"> BaseHash</span><span class="cls_004"> field, since</span></div>
<div style="position:absolute;left:110.70px;top:493.35px" class="cls_004"><span class="cls_004">the patch is inapplicable otherwise.</span></div>
<div style="position:absolute;left:100.74px;top:509.79px" class="cls_004"><span class="cls_004">- Full download edges from</span><span class="cls_007"> start</span><span class="cls_004"> to a store path for which we have a full down-</span></div>
<div style="position:absolute;left:110.70px;top:521.75px" class="cls_004"><span class="cls_004">load available. The edge weight is the size of the full download.</span></div>
<div style="position:absolute;left:100.74px;top:538.19px" class="cls_004"><span class="cls_004">- Free edges from</span><span class="cls_007"> start</span><span class="cls_004"> to a valid store path, representing an FSO that is already</span></div>
<div style="position:absolute;left:110.70px;top:550.14px" class="cls_004"><span class="cls_004">available on the system. The edge weight is 0.</span></div>
<div style="position:absolute;left:73.84px;top:571.07px" class="cls_004"><span class="cls_004">We then find the shortest path between</span><span class="cls_007"> start</span><span class="cls_004"> and the path of the requested component</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">using Dijkstra’s shortest path algorithm. This method can find any of the following:</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">195</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:138000px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background204.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7.</span></div>
<div style="position:absolute;left:72.17px;top:17.14px" class="cls_004"><span class="cls_004">Software Deployment</span></div>
<div style="position:absolute;left:214.02px;top:48.89px" class="cls_053"><span class="cls_053">start</span></div>
<div style="position:absolute;left:227.69px;top:65.84px" class="cls_053"><span class="cls_053">0</span></div>
<div style="position:absolute;left:276.24px;top:65.84px" class="cls_053"><span class="cls_053">0</span></div>
<div style="position:absolute;left:219.03px;top:72.01px" class="cls_053"><span class="cls_053">(present)</span></div>
<div style="position:absolute;left:267.57px;top:72.01px" class="cls_053"><span class="cls_053">(present)</span></div>
<div style="position:absolute;left:188.20px;top:88.96px" class="cls_053"><span class="cls_053">zncs96rbsf9q...-firefox-1.0.1</span></div>
<div style="position:absolute;left:266.80px;top:88.96px" class="cls_053"><span class="cls_053">3ll5pr8hasqr...-firefox-0.9</span></div>
<div style="position:absolute;left:180.88px;top:105.91px" class="cls_053"><span class="cls_053">11158372</span></div>
<div style="position:absolute;left:219.03px;top:105.91px" class="cls_053"><span class="cls_053">154179</span></div>
<div style="position:absolute;left:267.95px;top:105.91px" class="cls_053"><span class="cls_053">789234</span></div>
<div style="position:absolute;left:175.10px;top:112.08px" class="cls_053"><span class="cls_053">(full download)</span></div>
<div style="position:absolute;left:219.80px;top:112.08px" class="cls_053"><span class="cls_053">(patch)</span></div>
<div style="position:absolute;left:268.34px;top:112.08px" class="cls_053"><span class="cls_053">(patch)</span></div>
<div style="position:absolute;left:188.97px;top:129.03px" class="cls_053"><span class="cls_053">k7psi6ill5qb...-firefox-1.0.2</span></div>
<div style="position:absolute;left:207.85px;top:145.98px" class="cls_053"><span class="cls_053">244869</span></div>
<div style="position:absolute;left:208.24px;top:152.14px" class="cls_053"><span class="cls_053">(patch)</span></div>
<div style="position:absolute;left:154.30px;top:169.10px" class="cls_053"><span class="cls_053">l9z62mg66xq3...-firefox-1.0.3</span></div>
<div style="position:absolute;left:140.33px;top:191.45px" class="cls_004"><span class="cls_004">Figure 7.9.: Finding the optimal set of downloads</span></div>
<div style="position:absolute;left:74.66px;top:223.64px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:223.64px" class="cls_004"><span class="cls_004">A sequence of patches transforming an already installed component into the re-</span></div>
<div style="position:absolute;left:84.62px;top:235.59px" class="cls_004"><span class="cls_004">quested component.</span></div>
<div style="position:absolute;left:74.66px;top:255.80px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:255.80px" class="cls_004"><span class="cls_004">A full download of the requested component.</span></div>
<div style="position:absolute;left:74.66px;top:276.00px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:276.00px" class="cls_004"><span class="cls_004">A full download of some component X which is then transformed using a sequence</span></div>
<div style="position:absolute;left:84.62px;top:287.96px" class="cls_004"><span class="cls_004">of patches into the requested component. Generally, this will be longer than imme-</span></div>
<div style="position:absolute;left:84.62px;top:299.91px" class="cls_004"><span class="cls_004">diately doing a full download of the requested component, but this allows one to</span></div>
<div style="position:absolute;left:84.62px;top:311.87px" class="cls_004"><span class="cls_004">make only patches available for upgrades.</span></div>
<div style="position:absolute;left:69.68px;top:332.00px" class="cls_004"><span class="cls_004">Figure 7.9 shows the graph for an instance of Firefox 1.0.2. It is available as a large full</span></div>
<div style="position:absolute;left:59.72px;top:343.96px" class="cls_004"><span class="cls_004">download, and through a chain of patches. There are two Firefox instances that are valid</span></div>
<div style="position:absolute;left:59.72px;top:355.91px" class="cls_004"><span class="cls_004">base paths for patches. (There might be other valid Firefox instances in the local store, but</span></div>
<div style="position:absolute;left:59.72px;top:367.87px" class="cls_004"><span class="cls_004">these do not serve as base paths for patches.) There are 3 patches: one from Firefox 0.9 to</span></div>
<div style="position:absolute;left:59.72px;top:379.82px" class="cls_004"><span class="cls_004">1.0.2, one from 1.0.1 to 1.0.2, and one from 1.0.2 to 1.0.3. The patch sequence that applies</span></div>
<div style="position:absolute;left:59.72px;top:391.78px" class="cls_004"><span class="cls_004">the 1.0.1 to 1.0.2 and 1.0.2 to 1.0.3 patches to the valid 1.0.1 instance is the shortest path</span></div>
<div style="position:absolute;left:59.72px;top:403.73px" class="cls_004"><span class="cls_004">from the start node to the desired store path of 1.0.3, and is therefore selected.</span></div>
<div style="position:absolute;left:69.68px;top:415.76px" class="cls_004"><span class="cls_004">Above, edge weight was defined as the size of downloads in bytes. We could take other</span></div>
<div style="position:absolute;left:59.72px;top:427.71px" class="cls_004"><span class="cls_004">factors into account, such as protocol/network overhead per download, the CPU resources</span></div>
<div style="position:absolute;left:59.72px;top:439.67px" class="cls_004"><span class="cls_004">necessary to apply patches, and so on. For instance, on a reasonably fast connection, a full</span></div>
<div style="position:absolute;left:59.72px;top:451.62px" class="cls_004"><span class="cls_004">download might be preferable over a long sequence of patches even if the combined byte</span></div>
<div style="position:absolute;left:59.72px;top:463.58px" class="cls_004"><span class="cls_004">count of those patches is less than the full download.</span></div>
<div style="position:absolute;left:59.72px;top:491.68px" class="cls_008"><span class="cls_008">7.5.3. Base selection</span></div>
<div style="position:absolute;left:59.72px;top:511.29px" class="cls_004"><span class="cls_004">To deploy an upgrade, we have to produce patches between “corresponding” components.</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">This is intuitively simple: for instance, to deploy a Glibc upgrade, we have to produce</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">patches between the old Glibc and the new one, but also between the components depend-</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">ing on it, e.g., between the old Firefox and the new one. However, a complication is that</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">the dependency graphs might not be isomorphic.  Components may have been removed</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">or added, dependencies moved, component names changed (e.g., Phoenix to Firebird to</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">Firefox to mention a real-world example), and so on. Also, even disregarding component</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">196</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:138690px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background205.jpg" width=481 height=680></div>
<div style="position:absolute;left:330.83px;top:17.14px" class="cls_004"><span class="cls_004">7.5. Patch deployment</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">renames, simply matching by name is insufficient because there may be multiple compo-</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">nent instances with the same name (e.g., builds for different platforms).</span></div>
<div style="position:absolute;left:73.84px;top:68.95px" class="cls_004"><span class="cls_004">When deploying a set of target store paths Y, the base selection problem is to select</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">from a set of base store paths X a set of patches (X ,Y ) ∈ (X × Y) such that the probability</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">of the X s being present on the clients is maximised within certain resource constraints.</span></div>
<div style="position:absolute;left:73.84px;top:104.82px" class="cls_004"><span class="cls_004">Clearly, we could produce patches between all X s and Y s.  This policy is “optimal”</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">in the sense that the client is always able to select the absolutely shortest sequence of</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">patches.  However, it is infeasible in terms of time and space since producing a patch</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">takes a non-negligible amount of time, and most such patches will be large since they</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">will be between unrelated components (patching Adobe Reader into Firefox is obviously</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">inefficient—though possible!).</span></div>
<div style="position:absolute;left:73.84px;top:176.55px" class="cls_004"><span class="cls_004">Therefore, we need to select some subset of (X × Y).  The solution currently imple-</span></div>
<div style="position:absolute;left:63.87px;top:188.50px" class="cls_004"><span class="cls_004">mented is pragmatic: we use a number of properties of the components to guess whether</span></div>
<div style="position:absolute;left:63.87px;top:200.46px" class="cls_004"><span class="cls_004">they “match” (i.e., are conceptually the “same” component). Indeed, the selection prob-</span></div>
<div style="position:absolute;left:63.87px;top:212.41px" class="cls_004"><span class="cls_004">lem appears to force us to resort to heuristics for two reasons. First, there can be arbitrary</span></div>
<div style="position:absolute;left:63.87px;top:224.37px" class="cls_004"><span class="cls_004">changes between releases.  Second, we cannot feasibly produce all patches to select the</span></div>
<div style="position:absolute;left:63.87px;top:236.32px" class="cls_004"><span class="cls_004">“best” according to some objective criterion.</span></div>
<div style="position:absolute;left:73.84px;top:248.28px" class="cls_004"><span class="cls_004">Possible heuristics include the following:</span></div>
<div style="position:absolute;left:78.82px;top:267.07px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:267.07px" class="cls_004"><span class="cls_004">Same component name. This is clearly one of the simplest and most effective criteria.</span></div>
<div style="position:absolute;left:88.78px;top:279.03px" class="cls_004"><span class="cls_004">However, there is a complication: there can be multiple components with the same</span></div>
<div style="position:absolute;left:88.78px;top:290.98px" class="cls_004"><span class="cls_004">name.  For instance, Nixpkgs contains the GNU C Compiler</span><span class="cls_007"> gcc</span><span class="cls_004"> at several levels</span></div>
<div style="position:absolute;left:88.78px;top:302.94px" class="cls_004"><span class="cls_004">in the dependency graph (due to bootstrapping). Also, it contains two components</span></div>
<div style="position:absolute;left:88.78px;top:314.89px" class="cls_004"><span class="cls_004">called</span><span class="cls_007"> firefox</span><span class="cls_004">—one is the “real thing”, the other is a shell script wrapper around the</span></div>
<div style="position:absolute;left:88.78px;top:326.85px" class="cls_004"><span class="cls_004">first to enable some plugins.  Finally, Nixpkgs contains the same components for</span></div>
<div style="position:absolute;left:88.78px;top:338.80px" class="cls_004"><span class="cls_004">multiple platforms.</span></div>
<div style="position:absolute;left:78.82px;top:358.17px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:358.17px" class="cls_004"><span class="cls_004">The weighted number of uses can be used to disambiguate between components</span></div>
<div style="position:absolute;left:88.78px;top:370.12px" class="cls_004"><span class="cls_004">at different bootstrapping levels such as GCC mentioned above, or disambiguate</span></div>
<div style="position:absolute;left:88.78px;top:382.08px" class="cls_004"><span class="cls_004">between certain variants of a component. It is defined for a component at path p as</span></div>
<div style="position:absolute;left:88.78px;top:394.03px" class="cls_004"><span class="cls_004">follows:</span></div>
<div style="position:absolute;left:191.66px;top:410.34px" class="cls_004"><span class="cls_004">1</span></div>
<div style="position:absolute;left:113.69px;top:417.09px" class="cls_004"><span class="cls_004">w(p) =</span></div>
<div style="position:absolute;left:157.70px;top:414.83px" class="cls_038"><span class="cls_038">∑</span></div>
<div style="position:absolute;left:186.07px;top:424.11px" class="cls_012"><span class="cls_012">d(q,p)</span></div>
<div style="position:absolute;left:145.96px;top:424.44px" class="cls_012"><span class="cls_012">q∈users(p)</span><span class="cls_004"> r</span></div>
<div style="position:absolute;left:88.78px;top:447.81px" class="cls_004"><span class="cls_004">where users(p) is the set of components from which p is reachable in the build-time</span></div>
<div style="position:absolute;left:88.78px;top:459.77px" class="cls_004"><span class="cls_004">dependency graph, i.e., the components that are directly or indirectly dependent on</span></div>
<div style="position:absolute;left:89.53px;top:471.72px" class="cls_004"><span class="cls_004">p; where d(q, p) is the unweighted distance from component q to p in the build-time</span></div>
<div style="position:absolute;left:88.78px;top:483.68px" class="cls_004"><span class="cls_004">dependency graph; and where r ≥ 1 is an empirically determined value that causes</span></div>
<div style="position:absolute;left:88.78px;top:495.63px" class="cls_004"><span class="cls_004">less weight to be given to “distant” dependencies than to “nearby” dependencies.</span></div>
<div style="position:absolute;left:88.78px;top:511.29px" class="cls_004"><span class="cls_004">For instance, in the Nixpkgs dependency graph, there is a “bootstrap” GCC and a</span></div>
<div style="position:absolute;left:88.78px;top:523.25px" class="cls_004"><span class="cls_004">“final” GCC, the former being used to compile the latter, and the latter being used</span></div>
<div style="position:absolute;left:88.78px;top:535.20px" class="cls_004"><span class="cls_004">to compile almost all other packages. If we were to take the unweighted number of</span></div>
<div style="position:absolute;left:88.78px;top:547.16px" class="cls_004"><span class="cls_004">uses (r = 1), then the bootstrap GCC would have a slightly higher number of uses</span></div>
<div style="position:absolute;left:88.78px;top:559.11px" class="cls_004"><span class="cls_004">than the final GCC (since any component using the latter is indirectly dependent</span></div>
<div style="position:absolute;left:88.78px;top:571.07px" class="cls_004"><span class="cls_004">on the former), but the difference is too small for disambiguation—such a difference</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_004"><span class="cls_004">could also be caused by the addition or removal of dependent components. However,</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">197</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:139380px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background206.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:84.62px;top:45.04px" class="cls_004"><span class="cls_004">if we take, e.g., r = 2, then the weighted number of uses for the final GCC will be</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">almost twice as large. This is because the bootstrap GCC is at least one step further</span></div>
<div style="position:absolute;left:84.62px;top:68.95px" class="cls_004"><span class="cls_004">away in the dependency graph from the majority of components, thus halving their</span></div>
<div style="position:absolute;left:84.62px;top:80.90px" class="cls_004"><span class="cls_004">contribution to its w(p).</span></div>
<div style="position:absolute;left:84.62px;top:97.32px" class="cls_004"><span class="cls_004">Thus, if the ratio between w(p) and w(q) is greater than some empirically deter-</span></div>
<div style="position:absolute;left:84.62px;top:109.28px" class="cls_004"><span class="cls_004">mined value k, then components p and q are considered unrelated, and no patch</span></div>
<div style="position:absolute;left:84.62px;top:121.23px" class="cls_004"><span class="cls_004">between them is produced. A good value for k is around 2, e.g., k = 1.9.</span></div>
<div style="position:absolute;left:74.66px;top:142.11px" class="cls_004"><span class="cls_004">• Size of the component. If the ratio between the sizes of two components differs more</span></div>
<div style="position:absolute;left:84.62px;top:154.06px" class="cls_004"><span class="cls_004">than some value l, then the components are considered unrelated. A typical value is</span></div>
<div style="position:absolute;left:84.62px;top:166.02px" class="cls_004"><span class="cls_004">l = 3; even if components differing in size by a factor of 3 are related, then patching</span></div>
<div style="position:absolute;left:84.62px;top:177.97px" class="cls_004"><span class="cls_004">is unlikely to be effective. This trivial heuristic can disambiguate between the two</span></div>
<div style="position:absolute;left:84.62px;top:189.93px" class="cls_004"><span class="cls_004">Firefox components mentioned above, since the wrapper script component is much</span></div>
<div style="position:absolute;left:84.62px;top:201.88px" class="cls_004"><span class="cls_004">smaller than the real Firefox component.</span></div>
<div style="position:absolute;left:74.66px;top:222.76px" class="cls_004"><span class="cls_004">• Platform. In general, it is pointless to create a patch between components for dif-</span></div>
<div style="position:absolute;left:84.62px;top:234.71px" class="cls_004"><span class="cls_004">ferent platforms (e.g., Linux and Mac OS X), since it is unlikely that a client has</span></div>
<div style="position:absolute;left:84.62px;top:246.67px" class="cls_004"><span class="cls_004">components for a different platform installed.</span></div>
<div style="position:absolute;left:59.72px;top:275.69px" class="cls_008"><span class="cls_008">7.5.4. Experience</span></div>
<div style="position:absolute;left:59.72px;top:295.62px" class="cls_004"><span class="cls_004">The binary patch deployment scheme described above has been implemented in the Nix</span></div>
<div style="position:absolute;left:59.72px;top:307.58px" class="cls_004"><span class="cls_004">system.  To get some experimental results regarding the efficiency of binary patching, I</span></div>
<div style="position:absolute;left:59.72px;top:319.53px" class="cls_004"><span class="cls_004">used it to produce patches between 50 subsequent releases and pre-releases of the Nix</span></div>
<div style="position:absolute;left:59.72px;top:331.49px" class="cls_004"><span class="cls_004">Packages collection.  Base components were selected on the basis of matching names,</span></div>
<div style="position:absolute;left:59.72px;top:343.44px" class="cls_004"><span class="cls_004">using the size and weighted number of uses to disambiguate between a number of com-</span></div>
<div style="position:absolute;left:59.72px;top:355.40px" class="cls_004"><span class="cls_004">ponents with equal names. The use of patches is automatic and completely transparent to</span></div>
<div style="position:absolute;left:59.72px;top:367.35px" class="cls_004"><span class="cls_004">users; an upgrade action in Nix uses (a sequence of) patches if available and applicable, and</span></div>
<div style="position:absolute;left:59.72px;top:379.31px" class="cls_004"><span class="cls_004">falls back to full downloads otherwise. The results below show that the patching scheme</span></div>
<div style="position:absolute;left:59.72px;top:391.26px" class="cls_004"><span class="cls_004">succeeds in its main goal, i.e., reducing network bandwidth consumption in the face of</span></div>
<div style="position:absolute;left:59.72px;top:403.22px" class="cls_004"><span class="cls_004">updates to fundamental components such as Glibc or GCC to an “acceptable” level.</span></div>
<div style="position:absolute;left:69.68px;top:415.41px" class="cls_004"><span class="cls_004">I computed for each pair of subsequent releases the size of an upgrade using full down-</span></div>
<div style="position:absolute;left:59.72px;top:427.37px" class="cls_004"><span class="cls_004">loads of changed components, versus the size of the required patches to changed com-</span></div>
<div style="position:absolute;left:59.72px;top:439.32px" class="cls_004"><span class="cls_004">ponents. Also, the average and median sizes of each patch for the changed components</span></div>
<div style="position:absolute;left:59.72px;top:451.28px" class="cls_004"><span class="cls_004">(or full download, if no patch was possible) were computed. New top-level components</span></div>
<div style="position:absolute;left:59.72px;top:463.23px" class="cls_004"><span class="cls_004">(e.g., applications introduced in the new release) were disregarded. Table 7.1 summarises</span></div>
<div style="position:absolute;left:59.72px;top:475.19px" class="cls_004"><span class="cls_004">the results for a number of selected releases, representing various types of upgrades. File</span></div>
<div style="position:absolute;left:59.72px;top:487.14px" class="cls_004"><span class="cls_004">sizes are in bytes unless specified otherwise. Omitted releases were typically upgrades of</span></div>
<div style="position:absolute;left:59.72px;top:499.10px" class="cls_004"><span class="cls_004">single leaf components such as applications. An example is the Firefox upgrade in revision</span></div>
<div style="position:absolute;left:59.72px;top:511.05px" class="cls_007"><span class="cls_007">0.6pre1702</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:523.25px" class="cls_004"><span class="cls_004">Efficient upgrades or patches to fundamental components are the main goal of this sec-</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">tion.  For instance, release</span><span class="cls_007"> 0.7pre1980</span><span class="cls_004"> upgraded the GNU C Compiler used to build all</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">other components, while releases</span><span class="cls_007"> 0.7pre1820</span><span class="cls_004"> and</span><span class="cls_007"> 0.7pre1977</span><span class="cls_004"> provided bug fixes to the</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">GNU C Library, also used at build time and at runtime by all other components.  The</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">patches resulting from the Glibc changes in particular are tiny: the median patch size is</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">around 440 bytes. This is because such patches generally only need to modify the RPATH</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">198</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:140070px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background207.jpg" width=481 height=680></div>
<div style="position:absolute;left:330.83px;top:17.14px" class="cls_004"><span class="cls_004">7.5. Patch deployment</span></div>
<div style="position:absolute;left:202.02px;top:42.15px" class="cls_035"><span class="cls_035">Total</span></div>
<div style="position:absolute;left:273.73px;top:43.57px" class="cls_035"><span class="cls_035">Avg.</span></div>
<div style="position:absolute;left:305.52px;top:43.57px" class="cls_035"><span class="cls_035">Median</span></div>
<div style="position:absolute;left:119.89px;top:48.12px" class="cls_035"><span class="cls_035">Comps.   Full</span></div>
<div style="position:absolute;left:69.85px;top:53.78px" class="cls_035"><span class="cls_035">Release</span></div>
<div style="position:absolute;left:202.02px;top:53.11px" class="cls_035"><span class="cls_035">patch   Savings</span></div>
<div style="position:absolute;left:273.73px;top:54.53px" class="cls_035"><span class="cls_035">patch</span></div>
<div style="position:absolute;left:305.52px;top:54.53px" class="cls_035"><span class="cls_035">patch</span></div>
<div style="position:absolute;left:335.69px;top:53.78px" class="cls_035"><span class="cls_035">Remarks</span></div>
<div style="position:absolute;left:119.89px;top:59.08px" class="cls_035"><span class="cls_035">changed   size</span></div>
<div style="position:absolute;left:202.02px;top:64.07px" class="cls_035"><span class="cls_035">size</span></div>
<div style="position:absolute;left:273.73px;top:65.49px" class="cls_035"><span class="cls_035">size</span></div>
<div style="position:absolute;left:305.52px;top:65.49px" class="cls_035"><span class="cls_035">size</span></div>
<div style="position:absolute;left:69.85px;top:75.96px" class="cls_036"><span class="cls_036">0.6pre1069</span></div>
<div style="position:absolute;left:133.60px;top:75.06px" class="cls_035"><span class="cls_035">27</span></div>
<div style="position:absolute;left:159.00px;top:75.06px" class="cls_035"><span class="cls_035">31.6M</span></div>
<div style="position:absolute;left:199.11px;top:75.06px" class="cls_035"><span class="cls_035">162K</span></div>
<div style="position:absolute;left:236.04px;top:75.06px" class="cls_035"><span class="cls_035">99.5%</span></div>
<div style="position:absolute;left:275.63px;top:75.06px" class="cls_035"><span class="cls_035">6172</span></div>
<div style="position:absolute;left:316.17px;top:75.06px" class="cls_035"><span class="cls_035">898</span></div>
<div style="position:absolute;left:335.69px;top:76.06px" class="cls_014"><span class="cls_014">X11 libraries update</span></div>
<div style="position:absolute;left:69.85px;top:86.92px" class="cls_036"><span class="cls_036">0.6pre1489</span></div>
<div style="position:absolute;left:129.11px;top:86.02px" class="cls_035"><span class="cls_035">147</span></div>
<div style="position:absolute;left:161.24px;top:86.02px" class="cls_035"><span class="cls_035">180M</span></div>
<div style="position:absolute;left:202.09px;top:86.02px" class="cls_035"><span class="cls_035">71M</span></div>
<div style="position:absolute;left:234.54px;top:86.02px" class="cls_035"><span class="cls_035">60.5%</span></div>
<div style="position:absolute;left:273.65px;top:86.02px" class="cls_035"><span class="cls_035">495K</span></div>
<div style="position:absolute;left:314.18px;top:86.02px" class="cls_035"><span class="cls_035">81K</span></div>
<div style="position:absolute;left:335.69px;top:87.02px" class="cls_014"><span class="cls_014">Glibc</span></div>
<div style="position:absolute;left:360.59px;top:87.02px" class="cls_014"><span class="cls_014">2.3.2</span></div>
<div style="position:absolute;left:383.73px;top:87.02px" class="cls_014"><span class="cls_014">to</span></div>
<div style="position:absolute;left:397.12px;top:87.02px" class="cls_014"><span class="cls_014">2.3.3,</span></div>
<div style="position:absolute;left:335.69px;top:97.98px" class="cls_014"><span class="cls_014">GCC</span></div>
<div style="position:absolute;left:359.71px;top:97.98px" class="cls_014"><span class="cls_014">3.3.3</span></div>
<div style="position:absolute;left:383.28px;top:97.98px" class="cls_014"><span class="cls_014">to</span></div>
<div style="position:absolute;left:397.12px;top:97.98px" class="cls_014"><span class="cls_014">3.4.2,</span></div>
<div style="position:absolute;left:335.69px;top:108.04px" class="cls_014"><span class="cls_014">many other changes</span><span class="cls_013"><sup>9</sup></span></div>
<div style="position:absolute;left:69.85px;top:119.80px" class="cls_036"><span class="cls_036">0.6pre1538</span></div>
<div style="position:absolute;left:129.11px;top:118.90px" class="cls_035"><span class="cls_035">147</span></div>
<div style="position:absolute;left:154.52px;top:118.90px" class="cls_035"><span class="cls_035">176.7M</span></div>
<div style="position:absolute;left:199.11px;top:118.90px" class="cls_035"><span class="cls_035">364K</span></div>
<div style="position:absolute;left:236.04px;top:118.90px" class="cls_035"><span class="cls_035">99.8%</span></div>
<div style="position:absolute;left:275.63px;top:118.90px" class="cls_035"><span class="cls_035">2536</span></div>
<div style="position:absolute;left:316.17px;top:118.90px" class="cls_035"><span class="cls_035">509</span></div>
<div style="position:absolute;left:335.69px;top:119.90px" class="cls_014"><span class="cls_014">Standard build environ-</span></div>
<div style="position:absolute;left:335.69px;top:130.85px" class="cls_014"><span class="cls_014">ment changes</span></div>
<div style="position:absolute;left:69.85px;top:141.71px" class="cls_036"><span class="cls_036">0.6pre1542</span></div>
<div style="position:absolute;left:138.08px;top:140.82px" class="cls_035"><span class="cls_035">1</span></div>
<div style="position:absolute;left:163.48px;top:140.82px" class="cls_035"><span class="cls_035">9.3M</span></div>
<div style="position:absolute;left:203.59px;top:140.82px" class="cls_035"><span class="cls_035">67K</span></div>
<div style="position:absolute;left:236.04px;top:140.82px" class="cls_035"><span class="cls_035">99.3%</span></div>
<div style="position:absolute;left:278.13px;top:140.82px" class="cls_035"><span class="cls_035">67K</span></div>
<div style="position:absolute;left:314.18px;top:140.82px" class="cls_035"><span class="cls_035">67K</span></div>
<div style="position:absolute;left:335.69px;top:141.81px" class="cls_014"><span class="cls_014">Firefox bug fix</span></div>
<div style="position:absolute;left:69.85px;top:152.67px" class="cls_036"><span class="cls_036">0.6pre1672</span></div>
<div style="position:absolute;left:133.60px;top:151.78px" class="cls_035"><span class="cls_035">26</span></div>
<div style="position:absolute;left:159.00px;top:151.78px" class="cls_035"><span class="cls_035">38.0M</span></div>
<div style="position:absolute;left:199.11px;top:151.78px" class="cls_035"><span class="cls_035">562K</span></div>
<div style="position:absolute;left:236.04px;top:151.78px" class="cls_035"><span class="cls_035">98.6%</span></div>
<div style="position:absolute;left:271.15px;top:151.78px" class="cls_035"><span class="cls_035">22155</span></div>
<div style="position:absolute;left:311.69px;top:151.78px" class="cls_035"><span class="cls_035">6475</span></div>
<div style="position:absolute;left:335.69px;top:152.77px" class="cls_014"><span class="cls_014">GTK updates</span></div>
<div style="position:absolute;left:69.85px;top:163.63px" class="cls_036"><span class="cls_036">0.6pre1702</span></div>
<div style="position:absolute;left:138.08px;top:162.74px" class="cls_035"><span class="cls_035">3</span></div>
<div style="position:absolute;left:159.00px;top:162.74px" class="cls_035"><span class="cls_035">11.0M</span></div>
<div style="position:absolute;left:199.11px;top:162.74px" class="cls_035"><span class="cls_035">190K</span></div>
<div style="position:absolute;left:236.04px;top:162.74px" class="cls_035"><span class="cls_035">98.3%</span></div>
<div style="position:absolute;left:278.13px;top:162.74px" class="cls_035"><span class="cls_035">63K</span></div>
<div style="position:absolute;left:309.70px;top:162.74px" class="cls_035"><span class="cls_035">234K</span></div>
<div style="position:absolute;left:335.69px;top:163.73px" class="cls_014"><span class="cls_014">Firefox 1.0rc1 to 1.0rc2</span></div>
<div style="position:absolute;left:69.85px;top:174.59px" class="cls_036"><span class="cls_036">0.7pre1820</span></div>
<div style="position:absolute;left:129.11px;top:173.69px" class="cls_035"><span class="cls_035">154</span></div>
<div style="position:absolute;left:154.52px;top:173.69px" class="cls_035"><span class="cls_035">188.6M</span></div>
<div style="position:absolute;left:199.11px;top:173.69px" class="cls_035"><span class="cls_035">598K</span></div>
<div style="position:absolute;left:236.04px;top:173.69px" class="cls_035"><span class="cls_035">99.7%</span></div>
<div style="position:absolute;left:275.63px;top:173.69px" class="cls_035"><span class="cls_035">3981</span></div>
<div style="position:absolute;left:316.17px;top:173.69px" class="cls_035"><span class="cls_035">446</span></div>
<div style="position:absolute;left:335.69px;top:174.69px" class="cls_014"><span class="cls_014">Glibc loadlocale bug fix</span></div>
<div style="position:absolute;left:69.85px;top:185.55px" class="cls_036"><span class="cls_036">0.7pre1931</span></div>
<div style="position:absolute;left:138.08px;top:184.65px" class="cls_035"><span class="cls_035">1</span></div>
<div style="position:absolute;left:158.25px;top:184.65px" class="cls_035"><span class="cls_035">1164K</span></div>
<div style="position:absolute;left:203.59px;top:184.65px" class="cls_035"><span class="cls_035">45K</span></div>
<div style="position:absolute;left:236.04px;top:184.65px" class="cls_035"><span class="cls_035">96.1%</span></div>
<div style="position:absolute;left:278.13px;top:184.65px" class="cls_035"><span class="cls_035">45K</span></div>
<div style="position:absolute;left:314.18px;top:184.65px" class="cls_035"><span class="cls_035">45K</span></div>
<div style="position:absolute;left:335.69px;top:185.65px" class="cls_014"><span class="cls_014">Subversion 1.1.1 to 1.1.2</span></div>
<div style="position:absolute;left:69.85px;top:196.51px" class="cls_036"><span class="cls_036">0.7pre1977</span></div>
<div style="position:absolute;left:129.11px;top:195.61px" class="cls_035"><span class="cls_035">153</span></div>
<div style="position:absolute;left:154.52px;top:195.61px" class="cls_035"><span class="cls_035">196.3M</span></div>
<div style="position:absolute;left:199.11px;top:195.61px" class="cls_035"><span class="cls_035">743K</span></div>
<div style="position:absolute;left:236.04px;top:195.61px" class="cls_035"><span class="cls_035">99.6%</span></div>
<div style="position:absolute;left:275.63px;top:195.61px" class="cls_035"><span class="cls_035">4977</span></div>
<div style="position:absolute;left:316.17px;top:195.61px" class="cls_035"><span class="cls_035">440</span></div>
<div style="position:absolute;left:335.69px;top:196.61px" class="cls_014"><span class="cls_014">Glibc   UTF-8</span></div>
<div style="position:absolute;left:392.93px;top:196.61px" class="cls_014"><span class="cls_014">locales</span></div>
<div style="position:absolute;left:335.69px;top:207.57px" class="cls_014"><span class="cls_014">patch</span></div>
<div style="position:absolute;left:69.85px;top:218.43px" class="cls_036"><span class="cls_036">0.7pre1980</span></div>
<div style="position:absolute;left:129.11px;top:217.53px" class="cls_035"><span class="cls_035">154</span></div>
<div style="position:absolute;left:154.52px;top:217.53px" class="cls_035"><span class="cls_035">197.2M</span></div>
<div style="position:absolute;left:194.62px;top:217.53px" class="cls_035"><span class="cls_035">3748K</span></div>
<div style="position:absolute;left:236.04px;top:217.53px" class="cls_035"><span class="cls_035">98.1%</span></div>
<div style="position:absolute;left:271.15px;top:217.53px" class="cls_035"><span class="cls_035">24924</span></div>
<div style="position:absolute;left:316.17px;top:217.53px" class="cls_035"><span class="cls_035">974</span></div>
<div style="position:absolute;left:335.69px;top:218.53px" class="cls_014"><span class="cls_014">GCC 3.4.2 to 3.4.3</span></div>
<div style="position:absolute;left:63.87px;top:254.81px" class="cls_004"><span class="cls_004">Table 7.1.: Statistics for patch sets between selected Nixpkgs releases and their immediate</span></div>
<div style="position:absolute;left:108.46px;top:266.76px" class="cls_004"><span class="cls_004">predecessors</span></div>
<div style="position:absolute;left:63.87px;top:299.50px" class="cls_004"><span class="cls_004">in executable and shared libraries. The average is higher (around 4K) because a handful of</span></div>
<div style="position:absolute;left:63.87px;top:311.46px" class="cls_004"><span class="cls_004">applications and libraries statically link against Glibc components. Still, the total size of</span></div>
<div style="position:absolute;left:63.87px;top:323.41px" class="cls_004"><span class="cls_004">the patches for all components is only 598K and 743K, respectively—a fairly trivial size</span></div>
<div style="position:absolute;left:63.87px;top:335.37px" class="cls_004"><span class="cls_004">even on slow modem connections.</span></div>
<div style="position:absolute;left:73.84px;top:347.67px" class="cls_004"><span class="cls_004">On the other hand, release</span><span class="cls_007"> 0.6pre1489</span><span class="cls_004"> is not small at all—the patch savings are only</span></div>
<div style="position:absolute;left:63.87px;top:359.63px" class="cls_004"><span class="cls_004">60.5%. However, this release contained many significant changes. In particular, there was</span></div>
<div style="position:absolute;left:63.87px;top:371.58px" class="cls_004"><span class="cls_004">a major upgrade to GCC, with important changes to the generated code in all components.</span></div>
<div style="position:absolute;left:63.87px;top:383.54px" class="cls_004"><span class="cls_004">In general, compilers should not be switched lightly. (If individual components need an</span></div>
<div style="position:absolute;left:63.87px;top:395.49px" class="cls_004"><span class="cls_004">upgraded version, e.g., to fix a code generation bug, that is no problem: Nix expressions,</span></div>
<div style="position:absolute;left:63.87px;top:407.45px" class="cls_004"><span class="cls_004">being written in a functional language, can easily express that different components must</span></div>
<div style="position:absolute;left:63.87px;top:419.40px" class="cls_004"><span class="cls_004">be built with different compilers.) Minor compiler upgrades need not be a problem; release</span></div>
<div style="position:absolute;left:63.87px;top:431.36px" class="cls_007"><span class="cls_007">0.7pre1980</span><span class="cls_004">, which featured a minor upgrade to GCC, has a 98.1% patch effectiveness.</span></div>
<div style="position:absolute;left:73.84px;top:443.66px" class="cls_004"><span class="cls_004">Patch generation is a relatively slow process. For example, the generation of the patch</span></div>
<div style="position:absolute;left:63.87px;top:455.62px" class="cls_004"><span class="cls_004">set for release</span><span class="cls_007"> 0.7pre1820</span><span class="cls_004"> took 49 minutes on a 3.2 GHz Pentium 4 machine with 1 GiB</span></div>
<div style="position:absolute;left:63.87px;top:467.57px" class="cls_004"><span class="cls_004">of RAM running Linux 2.4.26. The</span><span class="cls_007"> bsdiff</span><span class="cls_004"> program also needs a large amount of memory;</span></div>
<div style="position:absolute;left:63.87px;top:479.53px" class="cls_004"><span class="cls_004">its documentation recommends a working set of at least 8 times the base file. For a large</span></div>
<div style="position:absolute;left:63.87px;top:491.48px" class="cls_004"><span class="cls_004">component such as Glibc, which takes 46M of disk space, this works out to 368M of RAM.</span></div>
<div style="position:absolute;left:63.87px;top:503.44px" class="cls_004"><span class="cls_004">In fact, we cannot currently compute patches for teTeX (a TEX distribution), regardless of</span></div>
<div style="position:absolute;left:63.87px;top:515.39px" class="cls_004"><span class="cls_004">how much physical memory or swap space is available, because the address space of 32-bit</span></div>
<div style="position:absolute;left:63.87px;top:527.35px" class="cls_004"><span class="cls_004">machines is not large enough to compute patches between teTeX’s NAR archives, which</span></div>
<div style="position:absolute;left:63.87px;top:539.30px" class="cls_004"><span class="cls_004">are around 230 MiB large. The solution is a more efficient</span><span class="cls_007"> bsdiff</span><span class="cls_004"> implementation, or simply</span></div>
<div style="position:absolute;left:63.87px;top:551.26px" class="cls_004"><span class="cls_004">to migrate to a 64-bit system for patch computation.</span></div>
<div style="position:absolute;left:73.84px;top:563.56px" class="cls_004"><span class="cls_004">A final point not addressed previously is the disk space consumption of upgrades.  A</span></div>
<div style="position:absolute;left:68.36px;top:584.11px" class="cls_013"><span class="cls_013"><sup>9</sup></span><span class="cls_014">First release since</span><span class="cls_016"> 0.6pre1398</span><span class="cls_014">.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">199</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:140760px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background208.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">change to a component such as Glibc will still cause every component to be duplicated on</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">disk, even if they do no longer have to be downloaded in full. However, after an upgrade, a</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">user can run the Nix garbage collector that safely and automatically removes unused com-</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">ponents. Nonetheless, as an optimisation, we observe that many files in those components</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">will be exactly the same (e.g., header files, scripts, documentation, JAR files). Therefore,</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">I implemented a tool that “optimises” the Nix store by finding all identical regular files</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">in the store, and replacing them with hard links [152] to a single copy.  On typical Nix</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">stores (i.e., subject to normal evolution over a period of time) this saved between 15-30%</span></div>
<div style="position:absolute;left:59.72px;top:140.68px" class="cls_004"><span class="cls_004">of disk space. While this is useful, it is not an order of magnitude change as is the case</span></div>
<div style="position:absolute;left:59.72px;top:152.64px" class="cls_004"><span class="cls_004">with the amount of bandwidth saved using patches. Section 11.1 discusses as future work</span></div>
<div style="position:absolute;left:59.72px;top:164.59px" class="cls_004"><span class="cls_004">the possibility of using file systems that support delta storage to solve this problem.</span></div>
<div style="position:absolute;left:59.72px;top:200.15px" class="cls_011"><span class="cls_011">7.6. Related work</span></div>
<div style="position:absolute;left:59.72px;top:227.05px" class="cls_004"><span class="cls_004">This section compares Nix’s suitability for deployment to other tools. Section 1.2 already</span></div>
<div style="position:absolute;left:59.72px;top:239.01px" class="cls_004"><span class="cls_004">touched on some of these.  Most deployment tools are based on a destructive upgrade</span></div>
<div style="position:absolute;left:59.72px;top:250.96px" class="cls_004"><span class="cls_004">paradigm.  Thus non-interference is not guaranteed at all, rollbacks are not easily sup-</span></div>
<div style="position:absolute;left:59.72px;top:262.92px" class="cls_004"><span class="cls_004">ported, and upgrading is certainly not atomic. Every system depends on the deployer to</span></div>
<div style="position:absolute;left:59.72px;top:274.87px" class="cls_004"><span class="cls_004">specify correct runtime dependencies, although some systems have (optional) provisions</span></div>
<div style="position:absolute;left:59.72px;top:286.83px" class="cls_004"><span class="cls_004">to determine build time dependencies. All systems have a fairly strict separation between</span></div>
<div style="position:absolute;left:59.72px;top:298.78px" class="cls_004"><span class="cls_004">source and binary deployment, if both are supported at all. Interestingly, in terms of sup-</span></div>
<div style="position:absolute;left:59.72px;top:310.74px" class="cls_004"><span class="cls_004">porting correct deployment, the tools that come nearest to the ideal are not classical de-</span></div>
<div style="position:absolute;left:59.72px;top:322.69px" class="cls_004"><span class="cls_004">ployment systems (e.g., package managers) but “developer side” SCM systems such as</span></div>
<div style="position:absolute;left:59.72px;top:334.65px" class="cls_004"><span class="cls_004">Vesta, as discussed below.</span></div>
<div style="position:absolute;left:59.72px;top:366.05px" class="cls_009"><span class="cls_009">Traditional Unix deployment systems</span><span class="cls_004">   What follows is a list of previous, “conven-</span></div>
<div style="position:absolute;left:59.72px;top:378.01px" class="cls_004"><span class="cls_004">tional” approaches to deployment in the Unix community, in more or less chronological</span></div>
<div style="position:absolute;left:59.72px;top:389.96px" class="cls_004"><span class="cls_004">order. I then contrast these approaches to Nix.</span></div>
<div style="position:absolute;left:69.68px;top:402.81px" class="cls_004"><span class="cls_004">The Depot [116] is a deployment scheme for heterogeneous environments based on</span></div>
<div style="position:absolute;left:59.72px;top:414.76px" class="cls_004"><span class="cls_004">sharing components through Sun’s Network File System (NFS) [23] or a similar technol-</span></div>
<div style="position:absolute;left:59.72px;top:426.72px" class="cls_004"><span class="cls_004">ogy.  Such sharing is trivial in homogeneous environments, as each client machine can</span></div>
<div style="position:absolute;left:59.72px;top:438.67px" class="cls_004"><span class="cls_004">mount and use exactly the same server file system. In a heterogeneous environment, how-</span></div>
<div style="position:absolute;left:59.72px;top:450.63px" class="cls_004"><span class="cls_004">ever, it may be necessary to build components for many different platforms. The Depot</span></div>
<div style="position:absolute;left:59.72px;top:462.58px" class="cls_004"><span class="cls_004">stores each component in its own isolated directory hierarchy (e.g.,</span><span class="cls_007"> /depot/.primary/anApp</span><span class="cls_004">),</span></div>
<div style="position:absolute;left:59.72px;top:474.54px" class="cls_004"><span class="cls_004">with subdirectories for sources, platform-independent files (e.g.,</span><span class="cls_007"> .../include</span><span class="cls_004">), and platform-</span></div>
<div style="position:absolute;left:59.72px;top:486.49px" class="cls_004"><span class="cls_004">dependent files (e.g.,</span><span class="cls_007"> .../arch.sun4-os4</span><span class="cls_004">). On the client machines, a platform-specific view</span></div>
<div style="position:absolute;left:59.72px;top:498.45px" class="cls_004"><span class="cls_004">on these components is synthesised. For instance, the component may be made available</span></div>
<div style="position:absolute;left:59.72px;top:510.40px" class="cls_004"><span class="cls_004">under</span><span class="cls_007"> /depot/anApp</span><span class="cls_004">, with the platform-specific directory (e.g.,</span><span class="cls_007"> /depot/.primary/anApp/-</span></div>
<div style="position:absolute;left:59.72px;top:522.36px" class="cls_007"><span class="cls_007">arch.sun4-os4</span><span class="cls_004">) mounted on</span><span class="cls_007"> /depot/anApp/arch</span><span class="cls_004">.  Thus, each client has the same logical</span></div>
<div style="position:absolute;left:59.72px;top:534.31px" class="cls_004"><span class="cls_004">view of the component; e.g.,</span><span class="cls_007"> /depot/anApp/arch/bin/foo</span><span class="cls_004"> always denotes the</span><span class="cls_007"> foo</span><span class="cls_004"> program for</span></div>
<div style="position:absolute;left:59.72px;top:546.27px" class="cls_004"><span class="cls_004">the current platform. Of course, the client view can also be implemented through symlinks</span></div>
<div style="position:absolute;left:59.72px;top:558.22px" class="cls_004"><span class="cls_004">or copying.</span></div>
<div style="position:absolute;left:69.68px;top:571.07px" class="cls_004"><span class="cls_004">The Depot paper does not describe how components are built from sources. That is, it</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">does not appear to have an analogue to Nix expressions. Indeed, an interesting aspect of</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">200</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:141450px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background209.jpg" width=481 height=680></div>
<div style="position:absolute;left:348.95px;top:17.14px" class="cls_004"><span class="cls_004">7.6. Related work</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">Depot-like approaches is that they support deployment, but are lacking in certain config-</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">uration management aspects. For instance, most Depot papers leave unspecified how the</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">components in the Depot are created. Presumably, these are “manually” built by the system</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">administrator by unpacking sources in the appropriate directory, building the component,</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">and installing it to the appropriate target location. This means that the build is not under</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">CM control, so there is neither reproducibility nor traceability.</span></div>
<div style="position:absolute;left:73.84px;top:116.77px" class="cls_004"><span class="cls_004">Another system called Depot is described in [32].  It uses symbolic links to activated</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">components, like Nix’s user environments. This is a very common technique; e.g., GNU</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">Stow [78] uses it as well.</span></div>
<div style="position:absolute;left:73.84px;top:152.64px" class="cls_004"><span class="cls_004">Depot-Lite [143] improves on Depot. It has a primitive scanning approach for finding</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">retained dependencies: component directories are scanned for the names of other com-</span></div>
<div style="position:absolute;left:63.87px;top:176.55px" class="cls_004"><span class="cls_004">ponent directories (e.g.,</span><span class="cls_007"> tk-3.3</span><span class="cls_004">).  However, such names are not very unique (contrary to</span></div>
<div style="position:absolute;left:63.87px;top:188.50px" class="cls_004"><span class="cls_004">cryptographic hashes) and may lead to many false positives. Many aspects of the tool are</span></div>
<div style="position:absolute;left:63.87px;top:200.46px" class="cls_004"><span class="cls_004">rather ad hoc. For instance, “safe” uninstallation is performed by making the component</span></div>
<div style="position:absolute;left:63.87px;top:212.41px" class="cls_004"><span class="cls_004">unreadable, then making it readable again if users complain during a certain time window.</span></div>
<div style="position:absolute;left:63.87px;top:224.37px" class="cls_004"><span class="cls_004">Similarly, Depot-Lite allows normal users to install software, but the security model is that</span></div>
<div style="position:absolute;left:63.87px;top:236.32px" class="cls_004"><span class="cls_004">components are made read-only after a “stabilisation period” of 21 days.</span></div>
<div style="position:absolute;left:73.84px;top:248.28px" class="cls_004"><span class="cls_004">Depot and its descendents (including Store [26], Local Disk Depot [181], SEPP [125]</span></div>
<div style="position:absolute;left:63.87px;top:260.23px" class="cls_004"><span class="cls_004">and GNU Stow [78]) are based on a notion of isolation between components, i.e., storing</span></div>
<div style="position:absolute;left:63.87px;top:272.19px" class="cls_004"><span class="cls_004">components in their own private directory trees in the file system. Many other deployment</span></div>
<div style="position:absolute;left:63.87px;top:284.14px" class="cls_004"><span class="cls_004">tools work within the traditional Unix file system organisation, i.e., installing components</span></div>
<div style="position:absolute;left:63.87px;top:296.10px" class="cls_004"><span class="cls_004">into directories such as</span><span class="cls_007"> /usr/bin</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:308.05px" class="cls_004"><span class="cls_004">The FreeBSD Ports Collection [73] is an example of such a deployment system.  As</span></div>
<div style="position:absolute;left:63.87px;top:320.01px" class="cls_004"><span class="cls_004">described in Section 1.2, it automatically fetches and builds components from sources,</span></div>
<div style="position:absolute;left:63.87px;top:331.96px" class="cls_004"><span class="cls_004">recursively installing dependencies as well. Thus the build process is at least mostly repro-</span></div>
<div style="position:absolute;left:63.87px;top:343.92px" class="cls_004"><span class="cls_004">ducible. As [84] points out, a problem with the FreeBSD Ports Collection is that it embeds</span></div>
<div style="position:absolute;left:63.87px;top:355.87px" class="cls_004"><span class="cls_004">dependency information into Makefiles, which makes it hard to query dependencies.  A</span></div>
<div style="position:absolute;left:63.87px;top:367.83px" class="cls_004"><span class="cls_004">more recent source deployment system is Gentoo Linux’s Portage [77], which places par-</span></div>
<div style="position:absolute;left:63.87px;top:379.78px" class="cls_004"><span class="cls_004">ticular emphasis on customisability of components through its USE flags mechanism.</span></div>
<div style="position:absolute;left:73.84px;top:391.74px" class="cls_004"><span class="cls_004">The Red Hat Package Manager (RPM) [62] is also designed to support the conventional</span></div>
<div style="position:absolute;left:63.87px;top:403.69px" class="cls_004"><span class="cls_004">Unix file system layout, but it makes the chaos of that layout manageable by tracking com-</span></div>
<div style="position:absolute;left:63.87px;top:415.65px" class="cls_004"><span class="cls_004">ponent metadata in a database. This metadata allows an administrator to query what files</span></div>
<div style="position:absolute;left:63.87px;top:427.60px" class="cls_004"><span class="cls_004">belong to what packages, and so on—an invaluable capability sorely lacking in many other</span></div>
<div style="position:absolute;left:63.87px;top:439.56px" class="cls_004"><span class="cls_004">systems. The knowledge provided in the database also allows RPM to prevent operations</span></div>
<div style="position:absolute;left:63.87px;top:451.52px" class="cls_004"><span class="cls_004">that would violate correctness constraints (e.g., two components occupying the same paths</span></div>
<div style="position:absolute;left:63.87px;top:463.47px" class="cls_004"><span class="cls_004">in the file system, or removal of a component that is required by another component).</span></div>
<div style="position:absolute;left:73.84px;top:475.43px" class="cls_004"><span class="cls_004">RPM operates at the package storage level, rather than the deployment level. That is, it</span></div>
<div style="position:absolute;left:63.87px;top:487.38px" class="cls_004"><span class="cls_004">has no way to fetch missing dependencies automatically. Deployment systems such as the</span></div>
<div style="position:absolute;left:63.87px;top:499.34px" class="cls_004"><span class="cls_004">FreeBSD Ports Collection,</span><span class="cls_007"> yum</span><span class="cls_004"> [174], and Debian’s venerable</span><span class="cls_007"> apt</span><span class="cls_004"> (Advanced Packaging</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">Tool) [149] maintain knowledge of repositories of remotely available packages and can</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">fetch these on demand. Thus they are complete deployment systems.</span></div>
<div style="position:absolute;left:73.84px;top:535.20px" class="cls_004"><span class="cls_004">So how do all these systems compare to Nix? All deployment tools that use the tradi-</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">tional Unix file system layout must necessarily be based on destructive upgrading. Thus</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">they cannot support atomic upgrades or rollbacks, unless the underlying file system sup-</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">ports transactions, that is, when an arbitrarily long sequence of file system operations can</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">be wrapped into a single atomic transaction.</span></div>
<div style="position:absolute;left:251.50px;top:583.02px" class="cls_004"><span class="cls_004">(No widely used file system provides this</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">201</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:142140px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background210.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">capability.)  Note that it is not enough for the file system to use transactions in its own</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">implementation, e.g., to ensure recoverability; transactions should be made available to</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">user space processes. Thus the operating system should have APIs to make transactions</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">available to user space (conventional file system APIs do not). An example is the Inversion</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">file system [128]. Deployme [129] is a system that uses unspecified existing deployment</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">tools to implement automatic rollback on failure of the new components (i.e., when an au-</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">tomatic test set fails). However, automatic rollback on failure was found to be undesirable</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">by users.</span></div>
<div style="position:absolute;left:69.68px;top:141.05px" class="cls_004"><span class="cls_004">In a destructive model, side-by-side deployment of versions and variants is only possible</span></div>
<div style="position:absolute;left:59.72px;top:153.00px" class="cls_004"><span class="cls_004">if the package author specifically arranges it (by making sure that files in different versions</span></div>
<div style="position:absolute;left:59.72px;top:164.96px" class="cls_004"><span class="cls_004">or variants have non-overlapping paths).</span></div>
<div style="position:absolute;left:69.68px;top:177.28px" class="cls_004"><span class="cls_004">None of the systems described above have any fundamental means to prevent undeclared</span></div>
<div style="position:absolute;left:59.72px;top:189.24px" class="cls_004"><span class="cls_004">dependencies. Some use specific tricks such as looking at ELF executable headers to find</span></div>
<div style="position:absolute;left:59.72px;top:201.19px" class="cls_004"><span class="cls_004">library dependencies, or non-portable methods such as tracking all file system accesses</span></div>
<div style="position:absolute;left:59.72px;top:213.15px" class="cls_004"><span class="cls_004">performed by builds (but note that this fails to discover retained dependencies!).</span></div>
<div style="position:absolute;left:69.68px;top:225.47px" class="cls_004"><span class="cls_004">Automatic garbage collection of unused components is a rare feature, since it requires</span></div>
<div style="position:absolute;left:59.72px;top:237.43px" class="cls_004"><span class="cls_004">a notion of “root” components. In systems such as RPM, even though the system knows</span></div>
<div style="position:absolute;left:59.72px;top:249.38px" class="cls_004"><span class="cls_004">the dependency graph between components, it does not know what components constitute</span></div>
<div style="position:absolute;left:59.72px;top:261.34px" class="cls_004"><span class="cls_004">roots (e.g., applications) and so can never delete components automatically.</span></div>
<div style="position:absolute;left:69.68px;top:273.66px" class="cls_004"><span class="cls_004">Nix’s transparent source/binary deployment is a fairly unique feature. Gentoo does have</span></div>
<div style="position:absolute;left:59.72px;top:285.62px" class="cls_004"><span class="cls_004">a primitive form of transparent source/binary deployment, but correspondence between</span></div>
<div style="position:absolute;left:59.72px;top:297.57px" class="cls_004"><span class="cls_004">sources and binaries is only nominal. That is, dependencies, build flags, and so on are not</span></div>
<div style="position:absolute;left:59.72px;top:309.53px" class="cls_004"><span class="cls_004">taken into account. It is not widely used for general deployment, only for mass deployment</span></div>
<div style="position:absolute;left:59.72px;top:321.48px" class="cls_004"><span class="cls_004">in specific environments.</span></div>
<div style="position:absolute;left:69.68px;top:333.81px" class="cls_004"><span class="cls_004">A neat feature that Nix does not support is automatic, on-demand installation of appli-</span></div>
<div style="position:absolute;left:59.72px;top:345.76px" class="cls_004"><span class="cls_004">cations.  There are few deployment systems that do: Zero Install [112] is an exception.</span></div>
<div style="position:absolute;left:59.72px;top:357.72px" class="cls_004"><span class="cls_004">When a user starts a program, the file system access is trapped and Zero Install automat-</span></div>
<div style="position:absolute;left:59.72px;top:369.67px" class="cls_004"><span class="cls_004">ically downloads the program from a remote repository. Of course, the problem with on-</span></div>
<div style="position:absolute;left:59.72px;top:381.63px" class="cls_004"><span class="cls_004">demand installation is that the remote component repository might not be available when</span></div>
<div style="position:absolute;left:59.72px;top:393.58px" class="cls_004"><span class="cls_004">it is needed.</span></div>
<div style="position:absolute;left:69.68px;top:405.91px" class="cls_004"><span class="cls_004">Some environments such as Windows and Mac OS X dispense with having a system-</span></div>
<div style="position:absolute;left:59.72px;top:416.84px" class="cls_004"><span class="cls_004">wide, standard deployment system altogether</span><span class="cls_012"><sup>10</sup></span><span class="cls_004">. That is, they do not have a package man-</span></div>
<div style="position:absolute;left:59.72px;top:429.82px" class="cls_004"><span class="cls_004">agement system such as RPM or Nix that maintains a global view of all components in the</span></div>
<div style="position:absolute;left:59.72px;top:441.77px" class="cls_004"><span class="cls_004">system along with their interdependencies. Rather, actions such as upgrading and uninstal-</span></div>
<div style="position:absolute;left:59.72px;top:453.73px" class="cls_004"><span class="cls_004">lating are the responsibility of each application. This has important consequences. First,</span></div>
<div style="position:absolute;left:59.72px;top:465.68px" class="cls_004"><span class="cls_004">it is impossible for administrators to do queries about components in a generic way. For</span></div>
<div style="position:absolute;left:59.72px;top:477.64px" class="cls_004"><span class="cls_004">instance, they cannot ask to what component a given file belongs.  Second, since each</span></div>
<div style="position:absolute;left:59.72px;top:489.59px" class="cls_004"><span class="cls_004">application is essentially independent, there can be no dependencies. As a result, appli-</span></div>
<div style="position:absolute;left:59.72px;top:501.55px" class="cls_004"><span class="cls_004">cations in these environments are all but required to be monolithic: they must contain all</span></div>
<div style="position:absolute;left:59.72px;top:513.50px" class="cls_004"><span class="cls_004">their dependencies, i.e., each application must be its own closure.</span></div>
<div style="position:absolute;left:59.72px;top:542.06px" class="cls_009"><span class="cls_009">Integrated CM systems</span><span class="cls_004">   An interesting class of systems that might support deploy-</span></div>
<div style="position:absolute;left:59.72px;top:554.01px" class="cls_004"><span class="cls_004">ment  is  integrated  configuration  management  systems  such  as  Vesta</span></div>
<div style="position:absolute;left:362.33px;top:554.01px" class="cls_004"><span class="cls_004">[92,</span></div>
<div style="position:absolute;left:383.95px;top:554.01px" class="cls_004"><span class="cls_004">93,</span></div>
<div style="position:absolute;left:402.24px;top:554.01px" class="cls_004"><span class="cls_004">94],</span></div>
<div style="position:absolute;left:61.21px;top:574.65px" class="cls_013"><span class="cls_013"><sup>10</sup></span><span class="cls_014">Recent versions of Windows do contain the Windows Installer, which provides a standardised method to install</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">packages. However, its use is not yet universal.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">202</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:142830px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background211.jpg" width=481 height=680></div>
<div style="position:absolute;left:348.95px;top:17.14px" class="cls_004"><span class="cls_004">7.6. Related work</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">ClearCase [109], and Camera [114, 58, 59]. These provide more than mere source ver-</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">sion management: they also provide build management. All three use a virtual file system</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">(implemented through the NFS protocol) to track file system accesses, allowing detection</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">of build-time dependencies. However, they are classical CM systems in that they support</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">the development process, but are not intended to extend further along the software time-</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">line, i.e., to deployment on end-user machines (though ClearCase can be used to support</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">deployment in conjunction with IBM’s Tivoli Configuration Manager [83]). That is, they</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">are used to build software artifacts such as executables, which are then shipped to the</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">clients through some unrelated mechanism, outside the scope of the CM system. It is a</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">fairly recent insight that CM tools should extend to deployment [167, 168].</span></div>
<div style="position:absolute;left:73.84px;top:164.81px" class="cls_004"><span class="cls_004">However, perhaps we can use these tools to support deployment already, i.e., it is just a</span></div>
<div style="position:absolute;left:63.87px;top:176.76px" class="cls_004"><span class="cls_004">matter of focus rather than underlying technology? This is certainly possible, but Nix has</span></div>
<div style="position:absolute;left:63.87px;top:188.72px" class="cls_004"><span class="cls_004">some important differences:</span></div>
<div style="position:absolute;left:78.82px;top:209.30px" class="cls_004"><span class="cls_004">• Since hashes are explicit in paths, we can scan for retained dependencies. The sys-</span></div>
<div style="position:absolute;left:88.78px;top:221.26px" class="cls_004"><span class="cls_004">tems mentioned above can only detect dependencies when they are accessed, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:233.21px" class="cls_004"><span class="cls_004">at build time.  So we cannot compute a closure in advance, and it is possible that</span></div>
<div style="position:absolute;left:88.78px;top:245.17px" class="cls_004"><span class="cls_004">we discover too late that the deployment is incomplete. This makes them unsuitable</span></div>
<div style="position:absolute;left:88.78px;top:257.12px" class="cls_004"><span class="cls_004">for general deployment—that is, more restrictive constraints on components than the</span></div>
<div style="position:absolute;left:88.78px;top:269.08px" class="cls_004"><span class="cls_004">assumptions in Section 6.8 must be made.</span></div>
<div style="position:absolute;left:78.82px;top:289.88px" class="cls_004"><span class="cls_004">• Nix focuses on deployment. Quite a few aspects that have been carefully designed</span></div>
<div style="position:absolute;left:88.78px;top:301.83px" class="cls_004"><span class="cls_004">in Nix to support deployment are absent in integrated CM systems, such as a no-</span></div>
<div style="position:absolute;left:88.78px;top:313.79px" class="cls_004"><span class="cls_004">tion of user environments, various deployment models (source, binary, transparent</span></div>
<div style="position:absolute;left:88.78px;top:325.74px" class="cls_004"><span class="cls_004">source/binary), secure sharing of a store, and so on.</span></div>
<div style="position:absolute;left:78.82px;top:346.54px" class="cls_004"><span class="cls_004">• Nix does not rely on non-portable operating system extensions, i.e., a virtual file</span></div>
<div style="position:absolute;left:88.78px;top:358.50px" class="cls_004"><span class="cls_004">system. Such extensions may be fine for development systems (though this is ques-</span></div>
<div style="position:absolute;left:88.78px;top:370.45px" class="cls_004"><span class="cls_004">tionable), but they are a barrier to use as a deployment tool, as each user must install</span></div>
<div style="position:absolute;left:88.78px;top:382.41px" class="cls_004"><span class="cls_004">the extension.</span></div>
<div style="position:absolute;left:78.82px;top:403.21px" class="cls_004"><span class="cls_004">• Likewise, integration of version management and build management is a barrier to</span></div>
<div style="position:absolute;left:88.78px;top:415.16px" class="cls_004"><span class="cls_004">use, as it potentially forces developers to switch both their version and build man-</span></div>
<div style="position:absolute;left:88.78px;top:427.12px" class="cls_004"><span class="cls_004">agement tools to the integrated system, even when they are only interested in one of</span></div>
<div style="position:absolute;left:88.78px;top:439.07px" class="cls_004"><span class="cls_004">its aspects.</span></div>
<div style="position:absolute;left:73.84px;top:459.65px" class="cls_004"><span class="cls_004">A nice property of Camera is that builds are performed in a</span><span class="cls_007"> chroot</span><span class="cls_004"> environment [114,</span></div>
<div style="position:absolute;left:63.87px;top:471.61px" class="cls_004"><span class="cls_004">Section 8.3.2]. A</span><span class="cls_007"> chroot</span><span class="cls_004"> is a Unix feature that allows a process’s file system accesses to be</span></div>
<div style="position:absolute;left:63.87px;top:483.56px" class="cls_004"><span class="cls_004">confined to a part of the file system by setting its root directory to a specific directory [152].</span></div>
<div style="position:absolute;left:63.87px;top:495.52px" class="cls_004"><span class="cls_004">This allows Camera to prevent undeclared dependencies.</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_009"><span class="cls_009">.NET and Java Web Start</span><span class="cls_004">   Section 1.2 briefly discussed Microsoft’s .NET [17, 154],</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">which can store components in a Global Assembly Cache.  Assemblies are essentially</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">.NET’s units of deployment. Assemblies have unique strong names that allow versions or</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">variants to coexist. While this is a big step forward from previous deployment technologies</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">in the Windows environment, it differs in important ways from the work described in this</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">thesis:</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">203</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:143520px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background212.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:74.66px;top:45.04px" class="cls_004"><span class="cls_004">• It covers only executable resources, i.e., the assemblies in the GAC. It cannot see</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">dependencies caused by, e.g., paths specified in configuration files.</span></div>
<div style="position:absolute;left:74.66px;top:76.71px" class="cls_004"><span class="cls_004">• Most components are stored in unmanaged parts of the file system, i.e., outside of</span></div>
<div style="position:absolute;left:84.62px;top:88.66px" class="cls_004"><span class="cls_004">the GAC.</span></div>
<div style="position:absolute;left:74.66px;top:108.38px" class="cls_004"><span class="cls_004">• There is no connection between a strong name and the contents of a component.</span></div>
<div style="position:absolute;left:84.62px;top:120.33px" class="cls_004"><span class="cls_004">Thus it is possible for multiple components produced by a vendor to have the same</span></div>
<div style="position:absolute;left:84.62px;top:132.29px" class="cls_004"><span class="cls_004">strong name. In practice this is not a problem.</span></div>
<div style="position:absolute;left:74.66px;top:152.00px" class="cls_004"><span class="cls_004">• It is bound to a specific component technology.</span></div>
<div style="position:absolute;left:59.72px;top:171.51px" class="cls_004"><span class="cls_004">The latter criticism also applies to technologies such as Sun’s Java Web Start [117], which</span></div>
<div style="position:absolute;left:59.72px;top:183.46px" class="cls_004"><span class="cls_004">enables web-based deployment of Java applications.</span></div>
<div style="position:absolute;left:69.68px;top:195.42px" class="cls_004"><span class="cls_004">Nix on the other hand deals with components at the most fundamental level: their storage</span></div>
<div style="position:absolute;left:59.72px;top:207.37px" class="cls_004"><span class="cls_004">in the file system. Thus it is agnostic with respect to particular component technologies.</span></div>
<div style="position:absolute;left:59.72px;top:233.80px" class="cls_009"><span class="cls_009">Software updaters</span><span class="cls_004">   Many recent software products come with their own built-in package</span></div>
<div style="position:absolute;left:59.72px;top:245.76px" class="cls_004"><span class="cls_004">management system (Vendor Product Updaters in the terminology of [102]), primarily</span></div>
<div style="position:absolute;left:59.72px;top:257.71px" class="cls_004"><span class="cls_004">to support automatic updating and management of extensions. Such applications include</span></div>
<div style="position:absolute;left:59.72px;top:269.67px" class="cls_004"><span class="cls_004">Mozilla Firefox, Eclipse, Microsoft Windows XP, and many others. These built-in updaters</span></div>
<div style="position:absolute;left:59.72px;top:281.62px" class="cls_004"><span class="cls_004">have a terrible problem: they interact very badly with system-wide package management</span></div>
<div style="position:absolute;left:59.72px;top:293.58px" class="cls_004"><span class="cls_004">systems such as Nix or RPM. A package manager assumes that it alone modifies the set</span></div>
<div style="position:absolute;left:59.72px;top:305.53px" class="cls_004"><span class="cls_004">of installed components. If a component modifies itself or other components, the package</span></div>
<div style="position:absolute;left:59.72px;top:317.49px" class="cls_004"><span class="cls_004">manager’s view of the system is no longer consistent with reality.</span></div>
<div style="position:absolute;left:69.68px;top:329.44px" class="cls_004"><span class="cls_004">Furthermore, package managers provide useful functionality that product-specific up-</span></div>
<div style="position:absolute;left:59.72px;top:341.40px" class="cls_004"><span class="cls_004">daters must reimplement—poorly. Indeed, they are often implemented in an ad hoc fash-</span></div>
<div style="position:absolute;left:59.72px;top:353.35px" class="cls_004"><span class="cls_004">ion and ignore many important issues. Dependency management, side-by-side versioning,</span></div>
<div style="position:absolute;left:59.72px;top:365.31px" class="cls_004"><span class="cls_004">rollbacks, and traceability are almost never properly supported.  In particular, operation</span></div>
<div style="position:absolute;left:59.72px;top:377.26px" class="cls_004"><span class="cls_004">in a multi-user environment—where the running component typically does not have write</span></div>
<div style="position:absolute;left:59.72px;top:389.22px" class="cls_004"><span class="cls_004">permission to its own installation files—is almost always neglected. For instance, Firefox’s</span></div>
<div style="position:absolute;left:59.72px;top:401.17px" class="cls_004"><span class="cls_004">automatic updater simply will not work in such environments.</span></div>
<div style="position:absolute;left:59.72px;top:427.60px" class="cls_009"><span class="cls_009">The deployment lifecycle</span><span class="cls_004">   In [168, 24] the deployment process is structured into a life-</span></div>
<div style="position:absolute;left:59.72px;top:439.56px" class="cls_004"><span class="cls_004">cycle consisting of various activities such as release, install, activation, deactivation, adapt,</span></div>
<div style="position:absolute;left:59.72px;top:451.52px" class="cls_004"><span class="cls_004">update, adaptation, de-install and de-release. All of these activities are explicitly present</span></div>
<div style="position:absolute;left:59.72px;top:463.47px" class="cls_004"><span class="cls_004">in Nix and the policies described in Section 7.4, except for the following.  Adaptation</span></div>
<div style="position:absolute;left:59.72px;top:475.43px" class="cls_004"><span class="cls_004">(modifying the configuration of installed components) is not an explicit operation. Rather,</span></div>
<div style="position:absolute;left:59.72px;top:487.38px" class="cls_004"><span class="cls_004">adaptation is typically done by modifying a Nix expression and re-installing it (cf. the Fire-</span></div>
<div style="position:absolute;left:59.72px;top:499.34px" class="cls_004"><span class="cls_004">fox wrapper in Section 7.1.1). Also, components are not de-installed explicitly but rather</span></div>
<div style="position:absolute;left:59.72px;top:511.29px" class="cls_004"><span class="cls_004">are removed implicitly by the garbage collector. Finally, the various policies do not have</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">a well-defined way to de-release a component (i.e., make it unavailable). Of course, we</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">can simply remove the Nix expressions, manifests, and binaries from the distribution site.</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">However, this removal does not automatically propagate to clients; for instance, clients</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">might have manifests that refer to removed binaries.</span></div>
<div style="position:absolute;left:69.68px;top:571.07px" class="cls_004"><span class="cls_004">Surveys of the extent to which various deployment tools support the deployment lifecy-</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">cle can be found in [24, 102].</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">204</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:144210px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background213.jpg" width=481 height=680></div>
<div style="position:absolute;left:348.95px;top:17.14px" class="cls_004"><span class="cls_004">7.6. Related work</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_009"><span class="cls_009">The Software Dock</span><span class="cls_004">   The Software Dock [85, 84] is a distributed, agent-based deploy-</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">ment framework. It consists of two types of “docks”: release docks that represent com-</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">ponent producers and maintain information about available releases, and field docks that</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">represent clients and maintain information about the state of the local machines (e.g., al-</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">ready installed software). An important aspect of the Software Dock is that it supports the</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">full lifecycle mentioned above. For instance, release docks can inform field docks about</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">new releases. This is implemented through the Siena event service [25]. Software com-</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">ponents, when deployed to a client, are accompanied by agents, which are programs that</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">implement component-specific behaviour for lifecycle activities such as upgrades. An im-</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">portant part of the Software Dock is the Deployable Software Description (DSD), which</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">is a standard language for describing software system families; i.e., it allows variability in</span></div>
<div style="position:absolute;left:63.87px;top:176.55px" class="cls_004"><span class="cls_004">related sets of components to be described.</span></div>
<div style="position:absolute;left:73.84px;top:189.01px" class="cls_004"><span class="cls_004">The most important difference between the Software Dock and the present work is that</span></div>
<div style="position:absolute;left:63.87px;top:200.96px" class="cls_004"><span class="cls_004">Nix addresses low-level building and storage of components. That is, it enforces isolation,</span></div>
<div style="position:absolute;left:63.87px;top:212.92px" class="cls_004"><span class="cls_004">complete dependencies, and so on, by imposing a discipline on the storage of components.</span></div>
<div style="position:absolute;left:63.87px;top:224.87px" class="cls_004"><span class="cls_004">In the Software Dock, it is up to the various agents that perform deployment activities how</span></div>
<div style="position:absolute;left:63.87px;top:236.83px" class="cls_004"><span class="cls_004">to store components in the file system, whether to support multiple versions or variants</span></div>
<div style="position:absolute;left:63.87px;top:248.78px" class="cls_004"><span class="cls_004">side-by-side, whether to support rollbacks, and so on.</span></div>
<div style="position:absolute;left:73.84px;top:261.24px" class="cls_004"><span class="cls_004">The Software Dock’s main strengths lie in its high-level policies that support the entire</span></div>
<div style="position:absolute;left:63.87px;top:273.20px" class="cls_004"><span class="cls_004">lifecycle of large systems, while this thesis emphasises the low-level aspects of compo-</span></div>
<div style="position:absolute;left:63.87px;top:285.15px" class="cls_004"><span class="cls_004">nents. For instance, none of the deployment policies in Section 7.4 are truly “push” based.</span></div>
<div style="position:absolute;left:63.87px;top:297.11px" class="cls_004"><span class="cls_004">Channels crudely can serve as a push model by having clients poll at short intervals, but</span></div>
<div style="position:absolute;left:63.87px;top:309.06px" class="cls_004"><span class="cls_004">this is clearly a poor approach. Thus, closer cooperation between producers and clients,</span></div>
<div style="position:absolute;left:63.87px;top:321.02px" class="cls_004"><span class="cls_004">such as enabled by the Software Dock’s event model, would allow more deployment poli-</span></div>
<div style="position:absolute;left:63.87px;top:332.97px" class="cls_004"><span class="cls_004">cies to be supported. However, this is something that can be implemented in policies; it</span></div>
<div style="position:absolute;left:63.87px;top:344.93px" class="cls_004"><span class="cls_004">does not affect the basic Nix mechanisms.</span></div>
<div style="position:absolute;left:63.87px;top:374.23px" class="cls_009"><span class="cls_009">Release management</span><span class="cls_004">   Van der Hoek et al. [169] list a number of requirements on de-</span></div>
<div style="position:absolute;left:63.87px;top:386.19px" class="cls_004"><span class="cls_004">ployment systems. It is instructive to determine to what extent Nix meets these require-</span></div>
<div style="position:absolute;left:63.87px;top:398.14px" class="cls_004"><span class="cls_004">ments.</span></div>
<div style="position:absolute;left:78.82px;top:419.58px" class="cls_004"><span class="cls_004">• “Dependencies should be explicit and easily recorded.”  Enforcing correct depen-</span></div>
<div style="position:absolute;left:88.78px;top:431.54px" class="cls_004"><span class="cls_004">dencies was one of the main drivers behind the present research. As we have seen in</span></div>
<div style="position:absolute;left:88.78px;top:443.49px" class="cls_004"><span class="cls_004">Section 7.1.5, Nix is successful in preventing undeclared dependencies.</span></div>
<div style="position:absolute;left:78.82px;top:465.44px" class="cls_004"><span class="cls_004">• “A system should be available through multiple channels.” The policy-freeness of</span></div>
<div style="position:absolute;left:88.78px;top:477.39px" class="cls_004"><span class="cls_004">the substitute mechanism allows Nix to support a wide variety of distribution chan-</span></div>
<div style="position:absolute;left:88.78px;top:489.35px" class="cls_004"><span class="cls_004">nels, such as HTTP, installation CD-ROMs, etc.</span></div>
<div style="position:absolute;left:78.82px;top:511.29px" class="cls_004"><span class="cls_004">• “The release process should involve minimal effort on the part of the developer.”</span></div>
<div style="position:absolute;left:88.78px;top:523.25px" class="cls_004"><span class="cls_004">This is somewhat hard to quantify, but Nix has several features that reduce devel-</span></div>
<div style="position:absolute;left:88.78px;top:535.20px" class="cls_004"><span class="cls_004">oper effort.  Nix expressions allow a system to be rebuilt automatically when the</span></div>
<div style="position:absolute;left:88.78px;top:547.16px" class="cls_004"><span class="cls_004">developer changes some part of it. Transparent source/binary deployment removes</span></div>
<div style="position:absolute;left:88.78px;top:559.11px" class="cls_004"><span class="cls_004">the burden of having to create binary packages explicitly (other than executing a</span><span class="cls_007"> nix-</span></div>
<div style="position:absolute;left:88.78px;top:571.07px" class="cls_007"><span class="cls_007">push</span><span class="cls_004"> command on the source “package”). Isolation and correct dependencies reduce</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_004"><span class="cls_004">maintenance effort by making components more robust.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">205</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:144900px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background214.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7.</span></div>
<div style="position:absolute;left:72.17px;top:17.14px" class="cls_004"><span class="cls_004">Software Deployment</span></div>
<div style="position:absolute;left:74.66px;top:45.04px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:45.04px" class="cls_004"><span class="cls_004">“The scope of a release should be controllable,” i.e., developers should be able to</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">restrict releases to certain parties. Access control of releases is an orthogonal issue</span></div>
<div style="position:absolute;left:84.62px;top:68.95px" class="cls_004"><span class="cls_004">to the low-level Nix mechanisms. For instance, if components are deployed through</span></div>
<div style="position:absolute;left:84.62px;top:80.90px" class="cls_004"><span class="cls_004">a channel accessed through HTTP, then the web server can be configured with ap-</span></div>
<div style="position:absolute;left:84.62px;top:92.86px" class="cls_004"><span class="cls_004">propriate access controls.</span></div>
<div style="position:absolute;left:74.66px;top:113.37px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:113.37px" class="cls_004"><span class="cls_004">“A history of retrievals should be kept.” Again, this is a feature that can be provided</span></div>
<div style="position:absolute;left:84.62px;top:125.33px" class="cls_004"><span class="cls_004">by, e.g., a web server.</span></div>
<div style="position:absolute;left:74.66px;top:145.84px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:145.84px" class="cls_004"><span class="cls_004">“Sufficient descriptive information should be available” to the user. This is currently</span></div>
<div style="position:absolute;left:84.62px;top:157.79px" class="cls_004"><span class="cls_004">missing: there is nothing in Nix expressions to describe a component, other than its</span></div>
<div style="position:absolute;left:84.62px;top:169.75px" class="cls_007"><span class="cls_007">name</span><span class="cls_004"> attribute. However, additional attributes can be easily added (e.g., a</span><span class="cls_007"> description</span></div>
<div style="position:absolute;left:84.62px;top:181.71px" class="cls_004"><span class="cls_004">attribute) and presented to the user through commands such as</span><span class="cls_007"> nix-env</span><span class="cls_004"> or on web</span></div>
<div style="position:absolute;left:84.62px;top:193.66px" class="cls_004"><span class="cls_004">pages for one-click installations.</span></div>
<div style="position:absolute;left:74.66px;top:214.17px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:214.17px" class="cls_004"><span class="cls_004">“Physical distribution should be hidden,” i.e., the user should not have to be aware</span></div>
<div style="position:absolute;left:84.62px;top:226.13px" class="cls_004"><span class="cls_004">of the physical locations of components. Nix expressions frequently involve many</span></div>
<div style="position:absolute;left:84.62px;top:238.08px" class="cls_004"><span class="cls_004">physical locations (e.g., calls to</span><span class="cls_007"> fetchurl</span><span class="cls_004">), but these are all handled automatically and</span></div>
<div style="position:absolute;left:84.62px;top:250.04px" class="cls_004"><span class="cls_004">do not concern the user (unless, of course, one of the locations becomes unavailable).</span></div>
<div style="position:absolute;left:74.66px;top:270.55px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:270.55px" class="cls_004"><span class="cls_004">“Interdependent systems should be retrievable as a group.” Dependent components</span></div>
<div style="position:absolute;left:84.62px;top:282.51px" class="cls_004"><span class="cls_004">(e.g., servers that access each other) can always be composed into a wrapper compo-</span></div>
<div style="position:absolute;left:84.62px;top:294.46px" class="cls_004"><span class="cls_004">nent that starts and stops them as appropriate (examples of this are shown in Chap-</span></div>
<div style="position:absolute;left:84.62px;top:306.42px" class="cls_004"><span class="cls_004">ter 9). Assertions in Nix expressions can express consistency requirements between</span></div>
<div style="position:absolute;left:84.62px;top:318.37px" class="cls_004"><span class="cls_004">components.</span></div>
<div style="position:absolute;left:74.66px;top:338.88px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:84.62px;top:338.88px" class="cls_004"><span class="cls_004">“Unnecessary retrievals should be avoided.” This is certainly the case: once a store</span></div>
<div style="position:absolute;left:84.62px;top:350.84px" class="cls_004"><span class="cls_004">path is valid, it does not need to be built or downloaded again.</span></div>
<div style="position:absolute;left:59.72px;top:378.17px" class="cls_009"><span class="cls_009">Deployment languages</span><span class="cls_004">   Hall et al. [86] list a number of requirements for a software</span></div>
<div style="position:absolute;left:59.72px;top:390.13px" class="cls_004"><span class="cls_004">deployment language, i.e., a formalism that contains the necessary information to support</span></div>
<div style="position:absolute;left:59.72px;top:402.08px" class="cls_004"><span class="cls_004">the deployment process.  They identify the following bits of information that must be</span></div>
<div style="position:absolute;left:59.72px;top:414.04px" class="cls_004"><span class="cls_004">expressible in such a language:</span></div>
<div style="position:absolute;left:74.66px;top:434.40px" class="cls_004"><span class="cls_004">• Assertion constraints express consistency requirements between components. The</span></div>
<div style="position:absolute;left:84.62px;top:446.36px" class="cls_004"><span class="cls_004">Nix expression language provides assertions for this purpose. However, many con-</span></div>
<div style="position:absolute;left:84.62px;top:458.31px" class="cls_004"><span class="cls_004">straints of this type are actually unnecessary in the purely functional model, since</span></div>
<div style="position:absolute;left:84.62px;top:470.27px" class="cls_004"><span class="cls_004">constraints cannot be invalidated after a component has been built. For instance, the</span></div>
<div style="position:absolute;left:84.62px;top:482.22px" class="cls_004"><span class="cls_004">paper gives an example of a Java application that requires exactly version 1.0.2 of</span></div>
<div style="position:absolute;left:84.62px;top:494.18px" class="cls_004"><span class="cls_004">the Java Virtual Machine. This constraint can be true at installation time, but become</span></div>
<div style="position:absolute;left:84.62px;top:506.13px" class="cls_004"><span class="cls_004">invalid if the JVM is updated later on. In Nix, if the JVM is part of the closure of the</span></div>
<div style="position:absolute;left:84.62px;top:518.09px" class="cls_004"><span class="cls_004">application, this situation cannot happen.</span></div>
<div style="position:absolute;left:74.66px;top:538.60px" class="cls_004"><span class="cls_004">• Dependency constraints are a more flexible kind of constraint that assertion con-</span></div>
<div style="position:absolute;left:84.62px;top:550.55px" class="cls_004"><span class="cls_004">straints.</span></div>
<div style="position:absolute;left:74.66px;top:571.07px" class="cls_004"><span class="cls_004">• Artifacts are the things that make up the components in the system. Nix expressions</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">list all artifacts necessary to build components from source. However, they do not</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">206</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:145590px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background215.jpg" width=481 height=680></div>
<div style="position:absolute;left:348.95px;top:17.14px" class="cls_004"><span class="cls_004">7.6. Related work</span></div>
<div style="position:absolute;left:88.78px;top:45.04px" class="cls_004"><span class="cls_004">list the artifacts in the resulting derivation outputs.  This means, for instance, that</span></div>
<div style="position:absolute;left:88.78px;top:56.99px" class="cls_004"><span class="cls_004">there currently is no way to query what component provides a certain command</span></div>
<div style="position:absolute;left:88.78px;top:68.95px" class="cls_004"><span class="cls_004">(e.g.,</span><span class="cls_007"> bin/firefox</span><span class="cls_004">) since that information is only available after components have been</span></div>
<div style="position:absolute;left:88.78px;top:80.90px" class="cls_004"><span class="cls_004">built—it does not follow from the Nix expression.</span></div>
<div style="position:absolute;left:78.82px;top:105.03px" class="cls_004"><span class="cls_004">• Configuration information describes the variability provided by components. Func-</span></div>
<div style="position:absolute;left:88.78px;top:116.98px" class="cls_004"><span class="cls_004">tions in Nix expressions serve this role.</span></div>
<div style="position:absolute;left:78.82px;top:141.10px" class="cls_004"><span class="cls_004">• Activities are the types of deployment actions that a component or system supports,</span></div>
<div style="position:absolute;left:88.78px;top:153.06px" class="cls_004"><span class="cls_004">such as installation, upgrading, and uninstallation. But there might be many others,</span></div>
<div style="position:absolute;left:88.78px;top:165.01px" class="cls_004"><span class="cls_004">such as starting or stopping a server component, so the language must be flexible.</span></div>
<div style="position:absolute;left:88.78px;top:176.97px" class="cls_004"><span class="cls_004">The Nix expression language has no direct provisions for supporting such activities,</span></div>
<div style="position:absolute;left:88.78px;top:188.92px" class="cls_004"><span class="cls_004">but we can support them as a policy on components. For instance, Chapter 9 shows</span></div>
<div style="position:absolute;left:88.78px;top:200.88px" class="cls_004"><span class="cls_004">how server components can support start and stop actions simply by providing a</span></div>
<div style="position:absolute;left:88.78px;top:212.83px" class="cls_004"><span class="cls_004">script called</span><span class="cls_007"> control</span><span class="cls_004"> in their output paths.</span></div>
<div style="position:absolute;left:63.87px;top:245.13px" class="cls_009"><span class="cls_009">Binary patching</span><span class="cls_004">   Binary patching has a long history, going back to manual patching of</span></div>
<div style="position:absolute;left:63.87px;top:257.09px" class="cls_004"><span class="cls_004">binaries on mainframes in the 1960s, where it was often a more efficient method of fixing</span></div>
<div style="position:absolute;left:63.87px;top:269.04px" class="cls_004"><span class="cls_004">bugs than recompiling from source.  Binary patching has been available in commercial</span></div>
<div style="position:absolute;left:63.87px;top:281.00px" class="cls_004"><span class="cls_004">patch tools such as .RTPatch, and interactive installer tools such as InstallShield.  Most</span></div>
<div style="position:absolute;left:63.87px;top:292.95px" class="cls_004"><span class="cls_004">Unix binary package managers only support upgrades through full downloads. Microsoft</span></div>
<div style="position:absolute;left:63.87px;top:304.91px" class="cls_004"><span class="cls_004">recently introduced binary patching in Windows XP Service Pack 2 as a method to speed</span></div>
<div style="position:absolute;left:63.87px;top:316.86px" class="cls_004"><span class="cls_004">up bug fix deployment [39]. Recent releases of SuSE Linux provide Delta RPMs, which</span></div>
<div style="position:absolute;left:63.87px;top:328.82px" class="cls_004"><span class="cls_004">are binary patches between serialisations of the contents of RPM packages in</span><span class="cls_007"> cpio</span><span class="cls_004"> archive</span></div>
<div style="position:absolute;left:63.87px;top:340.77px" class="cls_004"><span class="cls_004">format. This is quite similar to the method of patch computation described in Section 7.5.1.</span></div>
<div style="position:absolute;left:63.87px;top:352.73px" class="cls_004"><span class="cls_004">An interesting point is that the</span><span class="cls_007"> cpio</span><span class="cls_004"> archive format does not have a well-defined canonical</span></div>
<div style="position:absolute;left:63.87px;top:364.68px" class="cls_004"><span class="cls_004">form. So it is possible that in the future patches may fail to apply due to</span><span class="cls_007"> cpio</span><span class="cls_004"> implementa-</span></div>
<div style="position:absolute;left:63.87px;top:376.64px" class="cls_004"><span class="cls_004">tion differences. Also, no automatic patch chaining is provided.</span></div>
<div style="position:absolute;left:73.84px;top:389.64px" class="cls_004"><span class="cls_004">A method  for  automatically  computing  and  distributing  binary  patches  between</span></div>
<div style="position:absolute;left:63.87px;top:401.60px" class="cls_004"><span class="cls_004">FreeBSD releases is described in [131].  It addresses the additional complication that</span></div>
<div style="position:absolute;left:63.87px;top:413.55px" class="cls_004"><span class="cls_004">FreeBSD systems are often built from source, and the resulting binaries can differ even</span></div>
<div style="position:absolute;left:63.87px;top:425.51px" class="cls_004"><span class="cls_004">if the sources are the same, for instance, due to timestamps being stored in files. In the</span></div>
<div style="position:absolute;left:63.87px;top:437.46px" class="cls_004"><span class="cls_004">Nix patching scheme we guard against this possibility by providing the MD5 hash of the</span></div>
<div style="position:absolute;left:63.87px;top:449.42px" class="cls_004"><span class="cls_004">archive to which the patch applies. If it does not apply, we fall back to a full download. In</span></div>
<div style="position:absolute;left:63.87px;top:461.37px" class="cls_004"><span class="cls_004">general, however, this situation does not occur because patches are obtained from the same</span></div>
<div style="position:absolute;left:63.87px;top:473.33px" class="cls_004"><span class="cls_004">source as the original binaries.</span></div>
<div style="position:absolute;left:73.84px;top:486.33px" class="cls_004"><span class="cls_004">In Nix, the use of patches is completely hidden from users, who only observe it as a</span></div>
<div style="position:absolute;left:63.87px;top:498.29px" class="cls_004"><span class="cls_004">speed increase. In general, deployment methods often require users to figure out what files</span></div>
<div style="position:absolute;left:63.87px;top:510.24px" class="cls_004"><span class="cls_004">to download in order to install an upgrade (e.g., hotfixes in Windows). Also, if sequences</span></div>
<div style="position:absolute;left:63.87px;top:522.20px" class="cls_004"><span class="cls_004">of patches are required, these must be applied manually by the user, unless the distributor</span></div>
<div style="position:absolute;left:63.87px;top:534.15px" class="cls_004"><span class="cls_004">has consolidated them into a single patch. The creation of patches is often a manual and</span></div>
<div style="position:absolute;left:63.87px;top:546.11px" class="cls_004"><span class="cls_004">error-prone process, e.g., figuring out what components to redeploy as a result of a security</span></div>
<div style="position:absolute;left:63.87px;top:558.06px" class="cls_004"><span class="cls_004">bug like [1]. In our approach, this determination is automatic.</span></div>
<div style="position:absolute;left:73.84px;top:571.07px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> bsdiff</span><span class="cls_004"> program [132] that Nix uses to generate patches is based on the qsufsort</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">algorithm [108]. In our experience</span><span class="cls_007"> bsdiff</span><span class="cls_004"> outperformed methods such as ZDelta [162] and</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">207</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:146280px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background216.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">7. Software Deployment</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">VDelta [97, 107], but a comparison of delta algorithms is beyond the scope of this thesis.</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">An overview of some delta algorithms is given in [97].</span></div>
<div style="position:absolute;left:69.68px;top:68.95px" class="cls_004"><span class="cls_004">The problem of keeping derivates consistent with sources and dependency graph speci-</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">fications occurs in all build systems, e.g., Make [56]. To ensure correctness, such systems</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">must rebuild all dependent objects if some source changes.  If a source is fundamental,</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">then a large number of build actions may be necessary. So this problem is not unique in</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">any way to Nix. However, the problems of build systems affect developers, not end-users,</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">while Nix is a deployment system first and foremost. This is why it is important to ensure</span></div>
<div style="position:absolute;left:59.72px;top:140.68px" class="cls_004"><span class="cls_004">that end-users are not affected by the use of a strict update propagation semantics.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">208</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:146970px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background217.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:89.02px" class="cls_006"><span class="cls_006">8. Continuous Integration and Release</span></div>
<div style="position:absolute;left:88.68px;top:113.92px" class="cls_006"><span class="cls_006">Management</span></div>
<div style="position:absolute;left:63.87px;top:155.63px" class="cls_004"><span class="cls_004">This chapter shows that the Nix system can be applied to the problem of running a build</span></div>
<div style="position:absolute;left:63.87px;top:167.59px" class="cls_004"><span class="cls_004">farm, which is a tool to support continuous integration and automated release manage-</span></div>
<div style="position:absolute;left:63.87px;top:179.54px" class="cls_004"><span class="cls_004">ment. The former is the practice of automatically building and testing revisions of software</span></div>
<div style="position:absolute;left:63.87px;top:191.50px" class="cls_004"><span class="cls_004">components during the development process. The latter is the process of automatically pro-</span></div>
<div style="position:absolute;left:63.87px;top:203.45px" class="cls_004"><span class="cls_004">ducing releases of components that can be downloaded and installed by users. The two are</span></div>
<div style="position:absolute;left:63.87px;top:215.41px" class="cls_004"><span class="cls_004">related: if a software revision builds correctly and passes the tests, the build can be made</span></div>
<div style="position:absolute;left:63.87px;top:227.36px" class="cls_004"><span class="cls_004">available as a release. In fact, such a release can be made available to Nix users through</span></div>
<div style="position:absolute;left:63.87px;top:239.32px" class="cls_004"><span class="cls_004">the mechanisms described in Section 7.4, such as channels or one-click installations.</span></div>
<div style="position:absolute;left:63.87px;top:271.14px" class="cls_011"><span class="cls_011">8.1. Motivation</span></div>
<div style="position:absolute;left:63.87px;top:296.75px" class="cls_004"><span class="cls_004">Continuous integration [72] is a good software engineering practice. The idea is that each</span></div>
<div style="position:absolute;left:63.87px;top:308.70px" class="cls_004"><span class="cls_004">software development project should have a fully automated build system. Then we can</span></div>
<div style="position:absolute;left:63.87px;top:320.66px" class="cls_004"><span class="cls_004">run the build system automatically to continuously produce the most recent version of the</span></div>
<div style="position:absolute;left:63.87px;top:332.62px" class="cls_004"><span class="cls_004">software. Every time a developer commits a change to the project’s version management</span></div>
<div style="position:absolute;left:63.87px;top:344.57px" class="cls_004"><span class="cls_004">system, the continuous integration system checks out the source of the project, runs its</span></div>
<div style="position:absolute;left:63.87px;top:356.53px" class="cls_004"><span class="cls_004">automated build process, and creates a report describing the result of the build. The latter</span></div>
<div style="position:absolute;left:63.87px;top:368.48px" class="cls_004"><span class="cls_004">might be presented on a web page and/or sent to the developers through e-mail.</span></div>
<div style="position:absolute;left:73.84px;top:380.64px" class="cls_004"><span class="cls_004">Of course, developers are supposed to test their changes before they commit. The added</span></div>
<div style="position:absolute;left:63.87px;top:392.60px" class="cls_004"><span class="cls_004">advantage of a continuous integration system (apart from catching developers who don’t</span></div>
<div style="position:absolute;left:63.87px;top:404.55px" class="cls_004"><span class="cls_004">test their changes) is that it allows much more in-depth testing of the component(s) being</span></div>
<div style="position:absolute;left:63.87px;top:416.51px" class="cls_004"><span class="cls_004">developed:</span></div>
<div style="position:absolute;left:78.82px;top:437.06px" class="cls_004"><span class="cls_004">• The software may need to be built and tested on many different platforms (i.e., porta-</span></div>
<div style="position:absolute;left:88.78px;top:449.02px" class="cls_004"><span class="cls_004">bility testing). It is infeasible for each developer to do this before every commit.</span></div>
<div style="position:absolute;left:78.82px;top:469.77px" class="cls_004"><span class="cls_004">• Likewise, many projects have very large test sets (e.g., regression tests in a compiler,</span></div>
<div style="position:absolute;left:88.78px;top:481.73px" class="cls_004"><span class="cls_004">or stress tests in a DBMS) that can take hours or days to run to completion.</span></div>
<div style="position:absolute;left:78.82px;top:502.49px" class="cls_004"><span class="cls_004">• It may also be necessary to build many different variants of the software. For in-</span></div>
<div style="position:absolute;left:88.78px;top:514.44px" class="cls_004"><span class="cls_004">stance, it may be necessary to verify that the component builds with various versions</span></div>
<div style="position:absolute;left:88.78px;top:526.40px" class="cls_004"><span class="cls_004">of a compiler.</span></div>
<div style="position:absolute;left:78.82px;top:547.16px" class="cls_004"><span class="cls_004">• Developers will typically use incremental building to test their changes (since a full</span></div>
<div style="position:absolute;left:88.78px;top:559.11px" class="cls_004"><span class="cls_004">build may take too long), but this is often unreliable with many build management</span></div>
<div style="position:absolute;left:88.78px;top:571.07px" class="cls_004"><span class="cls_004">tools (such as Make). That is, the result of the incremental build might differ from a</span></div>
<div style="position:absolute;left:88.78px;top:583.02px" class="cls_004"><span class="cls_004">full build.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">209</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:147660px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background218.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">8. Continuous Integration and Release Management</span></div>
<div style="position:absolute;left:74.66px;top:45.04px" class="cls_004"><span class="cls_004">• It ensures that the software can be built from the sources under revision control. In</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">systems such as CVS [60] and Subversion [137], developers commonly forget to</span></div>
<div style="position:absolute;left:84.62px;top:68.95px" class="cls_004"><span class="cls_004">place source files under revision control.</span></div>
<div style="position:absolute;left:74.66px;top:89.04px" class="cls_004"><span class="cls_004">• The machines on which the continuous integration system runs ideally provides a</span></div>
<div style="position:absolute;left:84.62px;top:101.00px" class="cls_004"><span class="cls_004">clean, well-defined build environment. If this environment is administered through</span></div>
<div style="position:absolute;left:84.62px;top:112.95px" class="cls_004"><span class="cls_004">proper SCM techniques, then builds produced by the system can be reproduced.</span></div>
<div style="position:absolute;left:84.62px;top:124.91px" class="cls_004"><span class="cls_004">In contrast, developer work environments are typically not under any kind of SCM</span></div>
<div style="position:absolute;left:84.62px;top:136.86px" class="cls_004"><span class="cls_004">control.</span></div>
<div style="position:absolute;left:74.66px;top:156.96px" class="cls_004"><span class="cls_004">• In large projects, developers often work on a particular component of the project,</span></div>
<div style="position:absolute;left:84.62px;top:168.91px" class="cls_004"><span class="cls_004">and do not build and test the composition of those components (again since this</span></div>
<div style="position:absolute;left:84.62px;top:180.87px" class="cls_004"><span class="cls_004">is likely to take too long). To prevent the phenomenon of “big bang integration”,</span></div>
<div style="position:absolute;left:84.62px;top:192.82px" class="cls_004"><span class="cls_004">where components are only tested together near the end of the development process,</span></div>
<div style="position:absolute;left:84.62px;top:204.78px" class="cls_004"><span class="cls_004">it is important to test components together as soon as possible (hence continuous</span></div>
<div style="position:absolute;left:84.62px;top:216.73px" class="cls_004"><span class="cls_004">integration).</span></div>
<div style="position:absolute;left:69.68px;top:236.79px" class="cls_004"><span class="cls_004">A continuous integration system typically sits in a loop building and releasing software</span></div>
<div style="position:absolute;left:59.72px;top:248.74px" class="cls_004"><span class="cls_004">components from a version management system.  These are its jobs.  For each job, it</span></div>
<div style="position:absolute;left:59.72px;top:260.70px" class="cls_004"><span class="cls_004">performs the following tasks:</span></div>
<div style="position:absolute;left:72.17px;top:280.75px" class="cls_004"><span class="cls_004">1. It obtains the latest version of the component’s source code from the version man-</span></div>
<div style="position:absolute;left:84.62px;top:292.70px" class="cls_004"><span class="cls_004">agement system.</span></div>
<div style="position:absolute;left:72.17px;top:312.80px" class="cls_004"><span class="cls_004">2. It runs the component’s build process (which presumably includes the execution of</span></div>
<div style="position:absolute;left:84.62px;top:324.75px" class="cls_004"><span class="cls_004">the component’s test set).</span></div>
<div style="position:absolute;left:72.17px;top:344.85px" class="cls_004"><span class="cls_004">3. It presents the results of the build (such as error logs) to the developers, e.g., by</span></div>
<div style="position:absolute;left:84.62px;top:356.80px" class="cls_004"><span class="cls_004">producing a web page.</span></div>
<div style="position:absolute;left:69.68px;top:376.85px" class="cls_004"><span class="cls_004">A continuous integration system can also produce releases automatically. That is, when</span></div>
<div style="position:absolute;left:59.72px;top:388.81px" class="cls_004"><span class="cls_004">an automatic build succeeds (and possibly when it fails!), the build result can be packaged</span></div>
<div style="position:absolute;left:59.72px;top:400.76px" class="cls_004"><span class="cls_004">and made available in some way to developers and users.  For instance, it can produce</span></div>
<div style="position:absolute;left:59.72px;top:412.72px" class="cls_004"><span class="cls_004">a web page containing links to the packaged source code for the release, as well as bi-</span></div>
<div style="position:absolute;left:59.72px;top:424.67px" class="cls_004"><span class="cls_004">nary distributions. The production of releases fits naturally in the actions described above:</span></div>
<div style="position:absolute;left:59.72px;top:436.63px" class="cls_004"><span class="cls_004">the build process of the component should produce the desired release artifacts, and the</span></div>
<div style="position:absolute;left:59.72px;top:448.58px" class="cls_004"><span class="cls_004">presentation of the build result will be the release web page.</span></div>
<div style="position:absolute;left:69.68px;top:460.58px" class="cls_004"><span class="cls_004">The machines on which the continuous integration system runs are sometimes referred</span></div>
<div style="position:absolute;left:59.72px;top:472.54px" class="cls_004"><span class="cls_004">to as a build farm [91], since to support multi-platform projects or large sets of projects, a</span></div>
<div style="position:absolute;left:59.72px;top:484.49px" class="cls_004"><span class="cls_004">possibly large number of machines is required. (As a “degenerate case”, a build farm can</span></div>
<div style="position:absolute;left:59.72px;top:496.45px" class="cls_004"><span class="cls_004">also be a single machine.)</span></div>
<div style="position:absolute;left:69.68px;top:508.44px" class="cls_004"><span class="cls_004">However, existing build farm tools (such as CruiseControl, Anthill, and Tinderbox) have</span></div>
<div style="position:absolute;left:59.72px;top:520.40px" class="cls_004"><span class="cls_004">various limitations, discussed below.</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_009"><span class="cls_009">Managing the environment</span><span class="cls_004">   One of the main problems in running a build farm is its</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">manageability. Build farms scale poorly in terms of administrative overhead. The jobs that</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">we want to run in the build farm require a certain environment (such as dependencies).</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">Thus we have to make sure that the proper environment exists on every machine in the</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">210</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:148350px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background219.jpg" width=481 height=680></div>
<div style="position:absolute;left:358.46px;top:17.14px" class="cls_004"><span class="cls_004">8.1. Motivation</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">build farm.  If this is done manually, the administration effort of the build farm scales</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">linearly in the number of machines (Θ(n)).</span></div>
<div style="position:absolute;left:73.84px;top:68.95px" class="cls_004"><span class="cls_004">Suppose that we want to build a component that requires a certain compiler X .  We</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">then have to go to each machine and install X .  If we later need a newer version of X ,</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">the process must be repeated all over again.  An ever worse problem occurs if there are</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">conflicting dependencies. A real-life example is that some components require different,</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">mutually exclusive versions of the Autoconf package [64]. That is, simply installing the</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">latest version is not an option.  Of course, we can install these components in different</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">directories and manually pass the appropriate paths to the build processes of the various</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">components. But this is a rather tiresome and error-prone process.</span></div>
<div style="position:absolute;left:73.84px;top:164.59px" class="cls_004"><span class="cls_004">Of course, Nix nails this problem: since Nix expressions describe not just how to build</span></div>
<div style="position:absolute;left:63.87px;top:176.55px" class="cls_004"><span class="cls_004">a single component but also how to build all its dependencies, Nix expressions are an</span></div>
<div style="position:absolute;left:63.87px;top:188.50px" class="cls_004"><span class="cls_004">excellent way to describe build jobs. Also, the problem of dealing with variability in the</span></div>
<div style="position:absolute;left:63.87px;top:200.46px" class="cls_004"><span class="cls_004">environment (such as conflicting dependencies), are automatically resolved due to Nix’s</span></div>
<div style="position:absolute;left:63.87px;top:212.41px" class="cls_004"><span class="cls_004">hashing scheme: different dependencies end up in different paths, and Nix takes care of</span></div>
<div style="position:absolute;left:63.87px;top:224.37px" class="cls_004"><span class="cls_004">calling builders with the appropriate paths to dependencies.  Finally, Nix’s support for</span></div>
<div style="position:absolute;left:63.87px;top:236.32px" class="cls_004"><span class="cls_004">distributed and multi-platform builds (through the build hook mechanism of Section 5.5.2)</span></div>
<div style="position:absolute;left:63.87px;top:248.28px" class="cls_004"><span class="cls_004">addresses the scalability problem: as we will see below, a configuration change needs to</span></div>
<div style="position:absolute;left:63.87px;top:260.23px" class="cls_004"><span class="cls_004">be made only once (to the Nix expression), and Nix through the build hook will take care</span></div>
<div style="position:absolute;left:63.87px;top:272.19px" class="cls_004"><span class="cls_004">of rebuilding the new configuration on all platforms.</span></div>
<div style="position:absolute;left:63.87px;top:298.52px" class="cls_009"><span class="cls_009">Distributed and multi-platform builds</span><span class="cls_004">   Another problem in supporting multi-platform</span></div>
<div style="position:absolute;left:63.87px;top:310.48px" class="cls_004"><span class="cls_004">projects is how to actually perform the build.  Should each machine in the build farm</span></div>
<div style="position:absolute;left:63.87px;top:322.43px" class="cls_004"><span class="cls_004">independently perform jobs? If yes, then it is hard to generate a combined multi-platform</span></div>
<div style="position:absolute;left:63.87px;top:334.39px" class="cls_004"><span class="cls_004">release page.  Therefore a centralised model is preferable, in which a single designated</span></div>
<div style="position:absolute;left:63.87px;top:346.34px" class="cls_004"><span class="cls_004">machine selects jobs to build and forwards build actions to particular machines in the build</span></div>
<div style="position:absolute;left:63.87px;top:358.30px" class="cls_004"><span class="cls_004">farm. This is far from trivial, since it entails copying build inputs and outputs to and from</span></div>
<div style="position:absolute;left:63.87px;top:370.25px" class="cls_004"><span class="cls_004">machines. In fact, a build action on one machine can depend on the result of a build action</span></div>
<div style="position:absolute;left:63.87px;top:382.21px" class="cls_004"><span class="cls_004">on another (an example of which will be shown below).</span></div>
<div style="position:absolute;left:73.84px;top:394.16px" class="cls_004"><span class="cls_004">Again, the build hook mechanism enables a solution to this problem, since a single Nix</span></div>
<div style="position:absolute;left:63.87px;top:406.12px" class="cls_004"><span class="cls_004">expression can describe derivations for different platforms (i.e., different values for the</span></div>
<div style="position:absolute;left:63.87px;top:418.07px" class="cls_007"><span class="cls_007">system</span><span class="cls_004"> attribute). Derivations with different</span><span class="cls_007"> system</span><span class="cls_004"> values can also depend on each other.</span></div>
<div style="position:absolute;left:63.87px;top:430.03px" class="cls_004"><span class="cls_004">The build hook described below takes care of copying the appropriate closures between</span></div>
<div style="position:absolute;left:63.87px;top:441.98px" class="cls_004"><span class="cls_004">machines.</span></div>
<div style="position:absolute;left:63.87px;top:468.31px" class="cls_009"><span class="cls_009">Building multiple configurations</span><span class="cls_004">   It should be easy to build components in many dif-</span></div>
<div style="position:absolute;left:63.87px;top:480.27px" class="cls_004"><span class="cls_004">ferent variants, as mentioned above. A special case is building many different composi-</span></div>
<div style="position:absolute;left:63.87px;top:492.22px" class="cls_004"><span class="cls_004">tions, as this can reveal information useful from the perspective of continuous integration.</span></div>
<div style="position:absolute;left:63.87px;top:504.18px" class="cls_004"><span class="cls_004">Consider the real-life example shown in Figure 8.1 of two compilers: Stratego [176], a</span></div>
<div style="position:absolute;left:63.87px;top:516.13px" class="cls_004"><span class="cls_004">language based on strategic term rewriting; and Tiger, an implementation of the Tiger lan-</span></div>
<div style="position:absolute;left:63.87px;top:528.09px" class="cls_004"><span class="cls_004">guage [4] in Stratego. Suppose that both compilers have stable releases (e.g., Stratego 0.16</span></div>
<div style="position:absolute;left:63.87px;top:540.05px" class="cls_004"><span class="cls_004">and Tiger 1.2) but are also under active development. Then there are various kinds of in-</span></div>
<div style="position:absolute;left:63.87px;top:552.00px" class="cls_004"><span class="cls_004">formation that the Stratego and Tiger developers might want to obtain from the continuous</span></div>
<div style="position:absolute;left:63.87px;top:563.96px" class="cls_004"><span class="cls_004">integration system:</span></div>
<div style="position:absolute;left:78.82px;top:583.02px" class="cls_004"><span class="cls_004">• The Tiger developers want to know whether the most recent development version of</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">211</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:149040px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background220.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">8. Continuous Integration and Release Management</span></div>
<div style="position:absolute;left:183.04px;top:50.33px" class="cls_054"><span class="cls_054">Stratego 0.16</span></div>
<div style="position:absolute;left:246.01px;top:50.33px" class="cls_054"><span class="cls_054">Stratego HEAD</span></div>
<div style="position:absolute;left:192.04px;top:88.43px" class="cls_054"><span class="cls_054">Tiger 1.2</span></div>
<div style="position:absolute;left:248.13px;top:88.43px" class="cls_054"><span class="cls_054">Tiger HEAD</span></div>
<div style="position:absolute;left:115.48px;top:114.67px" class="cls_004"><span class="cls_004">Figure 8.1.: Multiple ways of combining component revisions</span></div>
<div style="position:absolute;left:84.62px;top:147.25px" class="cls_004"><span class="cls_004">Tiger (its HEAD revision) still builds. Here it is appropriate to build Tiger against a</span></div>
<div style="position:absolute;left:84.62px;top:159.21px" class="cls_004"><span class="cls_004">stable release of Stratego (i.e., 0.16), since when a build failure occurs the developers</span></div>
<div style="position:absolute;left:84.62px;top:171.16px" class="cls_004"><span class="cls_004">can then be reasonably certain that the cause is in Tiger, not Stratego.</span></div>
<div style="position:absolute;left:74.66px;top:192.16px" class="cls_004"><span class="cls_004">• However, the Tiger developers may also want to know whether their current source</span></div>
<div style="position:absolute;left:84.62px;top:204.11px" class="cls_004"><span class="cls_004">base is synchronised with possible changes in the Stratego compiler; i.e., whether</span></div>
<div style="position:absolute;left:84.62px;top:216.07px" class="cls_004"><span class="cls_004">the HEAD revision of Tiger builds against the HEAD revision of Stratego.</span></div>
<div style="position:absolute;left:74.66px;top:237.06px" class="cls_004"><span class="cls_004">• Likewise, the Stratego developer may want to build the stable release of Tiger against</span></div>
<div style="position:absolute;left:84.62px;top:249.02px" class="cls_004"><span class="cls_004">the HEAD revision of Stratego, so that Tiger can act as a large regression test for</span></div>
<div style="position:absolute;left:84.62px;top:260.97px" class="cls_004"><span class="cls_004">Stratego.</span></div>
<div style="position:absolute;left:59.72px;top:281.70px" class="cls_004"><span class="cls_004">This pattern is quite common in large projects where development is split among several</span></div>
<div style="position:absolute;left:59.72px;top:293.65px" class="cls_004"><span class="cls_004">development groups who every so often make releases available to other groups. It is quite</span></div>
<div style="position:absolute;left:59.72px;top:305.61px" class="cls_004"><span class="cls_004">easy to implement building all these variants, since we can just turn the Nix expressions</span></div>
<div style="position:absolute;left:59.72px;top:317.56px" class="cls_004"><span class="cls_004">that build the various components into functions that accept their dependencies as param-</span></div>
<div style="position:absolute;left:59.72px;top:329.52px" class="cls_004"><span class="cls_004">eters (as in Section 2.2).</span></div>
<div style="position:absolute;left:59.72px;top:357.51px" class="cls_009"><span class="cls_009">Scheduling policies</span><span class="cls_004">   A build farm should support a variety of different scheduling poli-</span></div>
<div style="position:absolute;left:59.72px;top:369.47px" class="cls_004"><span class="cls_004">cies. For instance, rather than building after each commit, the build can be performed on</span></div>
<div style="position:absolute;left:59.72px;top:381.42px" class="cls_004"><span class="cls_004">a fixed schedule, e.g., at 02:00 at night every day.  This is often referred to as a “daily</span></div>
<div style="position:absolute;left:59.72px;top:393.38px" class="cls_004"><span class="cls_004">build” [118]. It is however generally preferable to build as quickly as possible to ensure</span></div>
<div style="position:absolute;left:59.72px;top:405.33px" class="cls_004"><span class="cls_004">speedy feedback to developers. This is sometimes infeasible. In a build farm used by sev-</span></div>
<div style="position:absolute;left:59.72px;top:417.29px" class="cls_004"><span class="cls_004">eral jobs, a particular job may take a very long time to build, starving the other jobs. In that</span></div>
<div style="position:absolute;left:59.72px;top:429.25px" class="cls_004"><span class="cls_004">situation it may be better to schedule the offending job to run (say) at most once a week,</span></div>
<div style="position:absolute;left:59.72px;top:441.20px" class="cls_004"><span class="cls_004">or to run at a fixed time of day.</span></div>
<div style="position:absolute;left:69.68px;top:453.42px" class="cls_004"><span class="cls_004">More elaborate policies are also possible in a build farm that cleanly supports building</span></div>
<div style="position:absolute;left:59.72px;top:465.38px" class="cls_004"><span class="cls_004">of different variants of a component. Consider for instance a compiler project that must</span></div>
<div style="position:absolute;left:59.72px;top:477.33px" class="cls_004"><span class="cls_004">be built on many machines and has a huge regression test set. We can schedule two jobs</span></div>
<div style="position:absolute;left:59.72px;top:489.29px" class="cls_004"><span class="cls_004">for this project: a continuously running quick one that builds the compiler on only one</span></div>
<div style="position:absolute;left:59.72px;top:501.24px" class="cls_004"><span class="cls_004">platform, and runs only a few tests; and a weekly scheduled slow one that builds on all</span></div>
<div style="position:absolute;left:59.72px;top:513.20px" class="cls_004"><span class="cls_004">platforms and runs all tests.</span></div>
<div style="position:absolute;left:59.72px;top:545.34px" class="cls_011"><span class="cls_011">8.2. The Nix build farm</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">This section gives a sketch of the build farm that we implemented using Nix. The build</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">farm at present is not much more than a set of fairly simple scripts to run jobs, to build</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">212</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:149730px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background221.jpg" width=481 height=680></div>
<div style="position:absolute;left:325.35px;top:17.14px" class="cls_004"><span class="cls_004">8.2. The Nix build farm</span></div>
<div style="position:absolute;left:67.26px;top:49.20px" class="cls_015"><span class="cls_015">&lt;job  id='patchelf-head'></span></div>
<div style="position:absolute;left:76.67px;top:60.16px" class="cls_015"><span class="cls_015">&lt;input  id='job'  type='svn'</span></div>
<div style="position:absolute;left:86.09px;top:71.12px" class="cls_015"><span class="cls_015">url='</span><A HREF="https://.../repos/trace/release/trunk'/">https://.../repos/trace/release/trunk'</A>  /></div>
<div style="position:absolute;left:308.67px;top:67.85px" class="cls_056"><span class="cls_056">139</span></div>
<div style="position:absolute;left:76.67px;top:82.08px" class="cls_015"><span class="cls_015">&lt;input  id='patchelfHead'  type='svn'</span></div>
<div style="position:absolute;left:86.09px;top:93.03px" class="cls_015"><span class="cls_015">url='</span><A HREF="https://.../repos/trace/patchelf/trunk/">https://.../repos/trace/patchelf/trunk</A>  /></div>
<div style="position:absolute;left:76.67px;top:103.99px" class="cls_015"><span class="cls_015">&lt;job-script>generic-dist/build+upload.sh&lt;/job-script></span></div>
<div style="position:absolute;left:332.20px;top:100.73px" class="cls_056"><span class="cls_056">140</span></div>
<div style="position:absolute;left:76.67px;top:114.95px" class="cls_015"><span class="cls_015">&lt;arg>./jobs/nix/patchelf.nix&lt;/arg></span></div>
<div style="position:absolute;left:242.79px;top:111.69px" class="cls_056"><span class="cls_056">141</span></div>
<div style="position:absolute;left:76.67px;top:125.91px" class="cls_015"><span class="cls_015">&lt;arg>patchelfHeadRelease&lt;/arg></span></div>
<div style="position:absolute;left:223.96px;top:122.65px" class="cls_056"><span class="cls_056">142</span></div>
<div style="position:absolute;left:76.67px;top:136.87px" class="cls_015"><span class="cls_015">&lt;arg></span><A HREF="http://nix.cs.uu.nl/dist/stratego&lt;/arg/">http://nix.cs.uu.nl/dist/stratego&lt;/arg</A>></div>
<div style="position:absolute;left:289.85px;top:133.61px" class="cls_056"><span class="cls_056">143</span></div>
<div style="position:absolute;left:76.67px;top:147.83px" class="cls_015"><span class="cls_015">&lt;notify-address>somebody@example.org&lt;/notify-address></span></div>
<div style="position:absolute;left:332.20px;top:144.56px" class="cls_056"><span class="cls_056">144</span></div>
<div style="position:absolute;left:67.26px;top:158.79px" class="cls_015"><span class="cls_015">&lt;/job></span></div>
<div style="position:absolute;left:171.58px;top:176.62px" class="cls_004"><span class="cls_004">Figure 8.2.: A build job (simplified)</span></div>
<div style="position:absolute;left:63.87px;top:209.74px" class="cls_004"><span class="cls_004">the desired release products such as various kinds of binary distributions, and to produce</span></div>
<div style="position:absolute;left:63.87px;top:221.69px" class="cls_004"><span class="cls_004">release pages. The “heavy lifting” of managing the environment is provided by the Nix</span></div>
<div style="position:absolute;left:63.87px;top:233.65px" class="cls_004"><span class="cls_004">technology described in previous chapters. Thus, the process of adding a job to the build</span></div>
<div style="position:absolute;left:63.87px;top:245.60px" class="cls_004"><span class="cls_004">farm consists essentially of writing Nix expressions that describe components and their</span></div>
<div style="position:absolute;left:63.87px;top:257.56px" class="cls_004"><span class="cls_004">dependencies.</span></div>
<div style="position:absolute;left:73.84px;top:270.05px" class="cls_004"><span class="cls_004">The current Nix build farm consists of a number of components. At the highest level,</span></div>
<div style="position:absolute;left:63.87px;top:282.00px" class="cls_004"><span class="cls_004">there is a supervisor script (</span><span class="cls_007">supervisor.pl)</span><span class="cls_004"> that reads build jobs from a file (</span><span class="cls_007">jobs.conf</span><span class="cls_004">) and</span></div>
<div style="position:absolute;left:63.87px;top:293.96px" class="cls_004"><span class="cls_004">executes them in circular order. The jobs file is in XML format. Figure 8.2 shows an ex-</span></div>
<div style="position:absolute;left:63.87px;top:305.91px" class="cls_004"><span class="cls_004">ample of the declaration of a build job for the HEAD revision of the PatchELF component</span></div>
<div style="position:absolute;left:63.87px;top:317.87px" class="cls_004"><span class="cls_004">(a small component that we saw on page 179). It specifies the locations of the inputs to the</span></div>
<div style="position:absolute;left:63.87px;top:329.82px" class="cls_004"><span class="cls_004">build (as URLs of Subversion repositories)</span><span class="cls_014"> </span><span class="cls_056">139</span><span class="cls_059"> </span><span class="cls_004">, the name of the script that performs the</span></div>
<div style="position:absolute;left:63.87px;top:341.78px" class="cls_004"><span class="cls_004">job</span><span class="cls_014"> </span><span class="cls_056">140</span><span class="cls_059"> </span><span class="cls_004">, and its command-line arguments</span><span class="cls_014"> </span><span class="cls_056">141</span><span class="cls_059"> </span><span class="cls_004">. Each input is fetched from its Subversion</span></div>
<div style="position:absolute;left:63.87px;top:353.74px" class="cls_004"><span class="cls_004">repository. The path of the job script is relative to the input that has ID</span><span class="cls_007"> job</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:366.22px" class="cls_004"><span class="cls_004">The supervisor sends e-mail notification if a job fails (or if it succeeds again after it has</span></div>
<div style="position:absolute;left:63.87px;top:378.18px" class="cls_004"><span class="cls_004">failed previously) to the address specified in the job</span><span class="cls_014"> </span><span class="cls_056">144</span><span class="cls_059"> </span><span class="cls_004">. To prevent a flood of repeated</span></div>
<div style="position:absolute;left:63.87px;top:390.14px" class="cls_004"><span class="cls_004">e-mail messages for a failing build, after a job fails, the supervisor will not schedule it</span></div>
<div style="position:absolute;left:63.87px;top:402.09px" class="cls_004"><span class="cls_004">again until a certain time interval has passed. This interval increases on every failure using</span></div>
<div style="position:absolute;left:63.87px;top:414.05px" class="cls_004"><span class="cls_004">a binary exponential back-off method.</span></div>
<div style="position:absolute;left:73.84px;top:426.54px" class="cls_004"><span class="cls_004">Note that the supervisor is completely Nix-agnostic: it does not care how jobs are per-</span></div>
<div style="position:absolute;left:63.87px;top:438.49px" class="cls_004"><span class="cls_004">formed. It is up to the job script to perform the build in some arbitrary way.</span></div>
<div style="position:absolute;left:73.84px;top:450.98px" class="cls_004"><span class="cls_004">The job script</span><span class="cls_007"> build+upload.sh</span><span class="cls_004"> actually uses Nix to perform a build. It instantiates and</span></div>
<div style="position:absolute;left:63.87px;top:462.94px" class="cls_004"><span class="cls_004">builds a Nix expression specified as a command-line argument (e.g.,</span><span class="cls_007"> ./jobs/nix/patchelf.nix</span></div>
<div style="position:absolute;left:63.87px;top:474.89px" class="cls_004"><span class="cls_004">at</span></div>
<div style="position:absolute;left:75.85px;top:474.89px" class="cls_056"><span class="cls_056">141</span><span class="cls_059"> </span><span class="cls_004">).  This Nix expression is actually a function that takes as arguments the paths of</span></div>
<div style="position:absolute;left:63.87px;top:486.85px" class="cls_004"><span class="cls_004">the inputs declared in the XML job declaration (i.e., at</span><span class="cls_014"> </span><span class="cls_056">139</span><span class="cls_059"> </span><span class="cls_004">), and the target URL of the</span></div>
<div style="position:absolute;left:63.87px;top:498.80px" class="cls_004"><span class="cls_004">release page (specified at</span><span class="cls_014"> </span><span class="cls_056">143</span><span class="cls_059"> </span><span class="cls_004">). The job script expects the top-level derivation in the Nix</span></div>
<div style="position:absolute;left:63.87px;top:510.76px" class="cls_004"><span class="cls_004">expression to produce a release page, which is an HTML page describing the release, plus</span></div>
<div style="position:absolute;left:63.87px;top:522.71px" class="cls_004"><span class="cls_004">an arbitrary set of files associated with the release (such as source or binary distributions,</span></div>
<div style="position:absolute;left:63.87px;top:534.67px" class="cls_004"><span class="cls_004">manuals to be placed online, and so on).</span></div>
<div style="position:absolute;left:73.84px;top:547.16px" class="cls_004"><span class="cls_004">Figure 8.3 shows the Nix expression</span><span class="cls_007"> ./jobs/nix/patchelf.nix</span><span class="cls_004"> that builds a release for</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">PatchELF. Release pages are produced by the function</span><span class="cls_007"> patchelfRelease</span><span class="cls_014"> </span><span class="cls_056">149</span><span class="cls_059"> </span><span class="cls_004"> that accepts</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">a single argument</span><span class="cls_007"> input</span><span class="cls_004"> that points to the component’s source code as obtained by the</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">script</span><span class="cls_007"> build+upload.sh</span><span class="cls_004"> by performing a checkout from PatchELF’s Subversion repository.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">213</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:150420px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background222.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">8. Continuous Integration and Release Management</span></div>
<div style="position:absolute;left:63.10px;top:50.61px" class="cls_015"><span class="cls_015">inputs:  distBaseURL:</span></div>
<div style="position:absolute;left:163.33px;top:47.34px" class="cls_056"><span class="cls_056">145</span></div>
<div style="position:absolute;left:63.10px;top:72.52px" class="cls_015"><span class="cls_015">with  (import  ../..)  inputs.nixpkgs.path;</span></div>
<div style="position:absolute;left:257.45px;top:69.26px" class="cls_056"><span class="cls_056">146</span></div>
<div style="position:absolute;left:63.10px;top:94.44px" class="cls_015"><span class="cls_015">rec  {</span></div>
<div style="position:absolute;left:72.52px;top:116.36px" class="cls_015"><span class="cls_015">patchelfTarball  =  input:  svnToSourceTarball  "patchelf"  input  {</span></div>
<div style="position:absolute;left:370.40px;top:113.10px" class="cls_056"><span class="cls_056">147</span></div>
<div style="position:absolute;left:81.93px;top:127.32px" class="cls_015"><span class="cls_015">inherit  (pkgs)  stdenv  fetchsvn;</span></div>
<div style="position:absolute;left:81.93px;top:138.28px" class="cls_015"><span class="cls_015">buildInputs  =  [  pkgs.autoconf  pkgs.automake  ];</span></div>
<div style="position:absolute;left:72.52px;top:149.24px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:72.52px;top:171.15px" class="cls_015"><span class="cls_015">patchelfNixBuild  =  input:  pkgs:  nixBuild  (patchelfTarball  input)  {</span></div>
<div style="position:absolute;left:389.23px;top:167.89px" class="cls_056"><span class="cls_056">148</span></div>
<div style="position:absolute;left:81.93px;top:182.11px" class="cls_015"><span class="cls_015">inherit  (pkgs)  stdenv;</span></div>
<div style="position:absolute;left:72.52px;top:193.07px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:72.52px;top:214.99px" class="cls_015"><span class="cls_015">patchelfRelease  =  input:  makeReleasePage  {</span></div>
<div style="position:absolute;left:276.28px;top:211.73px" class="cls_056"><span class="cls_056">149</span></div>
<div style="position:absolute;left:81.93px;top:225.95px" class="cls_015"><span class="cls_015">fullName  =  "PatchELF";</span></div>
<div style="position:absolute;left:81.93px;top:236.91px" class="cls_015"><span class="cls_015">contactEmail  =  "eelco@cs.uu.nl";</span></div>
<div style="position:absolute;left:81.93px;top:247.87px" class="cls_015"><span class="cls_015">sourceTarball  =  patchelfTarball  input;</span></div>
<div style="position:absolute;left:81.93px;top:258.83px" class="cls_015"><span class="cls_015">nixBuilds  =  [</span></div>
<div style="position:absolute;left:91.34px;top:269.78px" class="cls_015"><span class="cls_015">(patchelfNixBuild  input  pkgsLinux)</span></div>
<div style="position:absolute;left:81.93px;top:280.74px" class="cls_015"><span class="cls_015">];</span></div>
<div style="position:absolute;left:81.93px;top:291.70px" class="cls_015"><span class="cls_015">inherit  distBaseURL;</span></div>
<div style="position:absolute;left:72.52px;top:302.66px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:72.52px;top:324.58px" class="cls_015"><span class="cls_015">patchelfHeadRelease  =  patchelfRelease  (inputs.patchelfHead);</span></div>
<div style="position:absolute;left:360.99px;top:321.32px" class="cls_056"><span class="cls_056">150</span></div>
<div style="position:absolute;left:63.10px;top:335.54px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:133.50px;top:352.13px" class="cls_004"><span class="cls_004">Figure 8.3.: Build farm Nix expression for PatchELF</span></div>
<div style="position:absolute;left:59.72px;top:385.46px" class="cls_004"><span class="cls_004">A release page produced by</span><span class="cls_007"> patchelfRelease</span><span class="cls_004"> is shown in Figure 8.4.</span></div>
<div style="position:absolute;left:69.68px;top:398.05px" class="cls_004"><span class="cls_004">The actual production of the release page is done by the generic release page builder</span></div>
<div style="position:absolute;left:59.72px;top:410.01px" class="cls_004"><span class="cls_004">function</span><span class="cls_007"> makeReleasePage</span><span class="cls_004"> (brought into scope in the with-expression at</span><span class="cls_014"> </span><span class="cls_056">146</span><span class="cls_059"> </span><span class="cls_004">). It accepts</span></div>
<div style="position:absolute;left:59.72px;top:421.96px" class="cls_004"><span class="cls_004">many arguments, only some of which are shown in the PatchELF example:</span></div>
<div style="position:absolute;left:74.66px;top:443.82px" class="cls_004"><span class="cls_004">• The name of the component (e.g.,</span><span class="cls_007"> "PatchELF"</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:74.66px;top:466.31px" class="cls_004"><span class="cls_004">• A contact e-mail address placed on the generated release pages.</span></div>
<div style="position:absolute;left:74.66px;top:488.80px" class="cls_004"><span class="cls_004">• The target URL (e.g.,</span><span class="cls_007"> distBaseURL</span><span class="cls_004">) of the release page. The release page builder</span></div>
<div style="position:absolute;left:84.62px;top:500.75px" class="cls_004"><span class="cls_004">does not perform uploads itself (since that is impure) but it needs the target URL for</span></div>
<div style="position:absolute;left:84.62px;top:512.71px" class="cls_004"><span class="cls_004">self-references in the release page.</span></div>
<div style="position:absolute;left:74.66px;top:535.20px" class="cls_004"><span class="cls_004">• A derivation that builds a source distribution (</span><span class="cls_007">sourceTarball</span><span class="cls_004">), e.g., the file </span><span class="cls_007">patchelf-</span></div>
<div style="position:absolute;left:84.62px;top:547.16px" class="cls_007"><span class="cls_007">0.1pre3663.tar.gz</span><span class="cls_004"> that can be downloaded, compiled, and installed by users.  The</span></div>
<div style="position:absolute;left:84.62px;top:559.11px" class="cls_004"><span class="cls_004">source distribution is produced from the Subversion sources (i.e.,</span><span class="cls_007"> input</span><span class="cls_004">) by the func-</span></div>
<div style="position:absolute;left:84.62px;top:571.07px" class="cls_004"><span class="cls_004">tion</span><span class="cls_007"> patchelfTarball</span><span class="cls_014"> </span><span class="cls_056">147</span><span class="cls_059"> </span><span class="cls_004">. (A tarball is a Unix colloquialism for a source distribution.)</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">Here too the actual work is done by an external generic function</span><span class="cls_007"> svnToSourceTarball</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">214</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:151110px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background223.jpg" width=481 height=680></div>
<div style="position:absolute;left:325.35px;top:17.14px" class="cls_004"><span class="cls_004">8.2. The Nix build farm</span></div>
<div style="position:absolute;left:164.38px;top:344.48px" class="cls_004"><span class="cls_004">Figure 8.4.: Release page for PatchELF</span></div>
<div style="position:absolute;left:78.82px;top:376.24px" class="cls_004"><span class="cls_004">• A list of derivations that perform normal builds of the component from the source</span></div>
<div style="position:absolute;left:88.78px;top:388.19px" class="cls_004"><span class="cls_004">distribution (</span><span class="cls_007">nixBuilds</span><span class="cls_004">). These are used to automatically populate a channel to which</span></div>
<div style="position:absolute;left:88.78px;top:400.15px" class="cls_004"><span class="cls_004">users can subscribe, and to generate packages for one-click installation (see Sec-</span></div>
<div style="position:absolute;left:88.78px;top:412.10px" class="cls_004"><span class="cls_004">tion 7.4). In this case the builds are produced by the function</span><span class="cls_007"> patchelfNixBuild</span><span class="cls_014"> </span><span class="cls_056">148</span><span class="cls_059"> </span><span class="cls_004">,</span></div>
<div style="position:absolute;left:88.78px;top:424.06px" class="cls_004"><span class="cls_004">which in turn uses the (poorly named) generic function</span><span class="cls_007"> nixBuild</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:78.82px;top:443.84px" class="cls_004"><span class="cls_004">• Similarly,</span><span class="cls_007"> makeReleasePage</span><span class="cls_004"> accepts attributes for the component’s manual, cover-</span></div>
<div style="position:absolute;left:88.78px;top:455.79px" class="cls_004"><span class="cls_004">age analysis builds, and RPM packages.</span></div>
<div style="position:absolute;left:73.84px;top:475.43px" class="cls_004"><span class="cls_004">The top-level derivation is produced by evaluation of the value</span><span class="cls_007"> patchelfHeadRelease</span></div>
<div style="position:absolute;left:65.27px;top:487.38px" class="cls_056"><span class="cls_056">150</span><span class="cls_059"> </span><span class="cls_004">. The name of this attribute was specified in the XML job description at</span><span class="cls_014"> </span><span class="cls_056">142</span><span class="cls_059"> </span><span class="cls_004">. Building</span></div>
<div style="position:absolute;left:63.87px;top:499.34px" class="cls_004"><span class="cls_004">of this derivation will produce the release page and all the distributions included on the</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">release page (in the example, a source distribution and a Nix channel distribution).</span></div>
<div style="position:absolute;left:73.84px;top:523.25px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> build+upload.sh</span><span class="cls_004"> script, as its name implies, not only builds the derivation but also</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">uploads the release page to the server.  Each release is stored under its own URL, e.g.,</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_007"><span class="cls_007">http://nix.cs.uu.nl/dist/nix/patchelf-0.1pre3663/</span><span class="cls_004">.  It also performs a</span><span class="cls_007"> nix-push</span><span class="cls_004"> to build and</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">upload the Nix expressions in the channels provided by the release.  The uploading of</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">the release is assisted by a server-side CGI script that stores the uploaded files and, when</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">the upload is done, updates various index pages listing the release. Figure 8.5 shows the</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">215</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:151800px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background224.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">8. Continuous Integration and Release Management</span></div>
<div style="position:absolute;left:179.51px;top:291.33px" class="cls_004"><span class="cls_004">Figure 8.5.: Release overview</span></div>
<div style="position:absolute;left:59.72px;top:320.59px" class="cls_004"><span class="cls_004">automatically generated index of the most recent releases, concisely showing the extent to</span></div>
<div style="position:absolute;left:59.72px;top:332.55px" class="cls_004"><span class="cls_004">which each release succeeded.</span></div>
<div style="position:absolute;left:59.72px;top:358.45px" class="cls_009"><span class="cls_009">Reproducing releases</span><span class="cls_004">   An important configuration management property is the ability</span></div>
<div style="position:absolute;left:59.72px;top:370.40px" class="cls_004"><span class="cls_004">to reproduce releases in the future. E.g., when we need to fix a bug in some old release</span></div>
<div style="position:absolute;left:59.72px;top:382.36px" class="cls_004"><span class="cls_004">of a component, we need to be able to reproduce the entire build environment, including</span></div>
<div style="position:absolute;left:59.72px;top:394.31px" class="cls_004"><span class="cls_004">compilers, libraries, and so on.  So it is important that we have a record that describes</span></div>
<div style="position:absolute;left:59.72px;top:406.27px" class="cls_004"><span class="cls_004">exactly what inputs went into a release.</span></div>
<div style="position:absolute;left:69.68px;top:418.22px" class="cls_004"><span class="cls_004">Therefore the build farm stores a file</span><span class="cls_007"> job.xml</span><span class="cls_004"> as part of every release, e.g., under</span><span class="cls_007"> <A HREF="http:/">http:</A> </span></div>
<div style="position:absolute;left:59.72px;top:430.18px" class="cls_007"><span class="cls_007">//nix.cs.uu.nl/dist/nix/patchelf-0.1pre3663/job.xml</span><span class="cls_004">.  This file is the same as the XML job</span></div>
<div style="position:absolute;left:59.72px;top:442.13px" class="cls_004"><span class="cls_004">description that went into the supervisor (e.g., the one in Figure 8.2), except that each</span></div>
<div style="position:absolute;left:59.72px;top:454.09px" class="cls_007"><span class="cls_007">input</span><span class="cls_004"> element that referred to a non-constant input such as a HEAD revision has been</span></div>
<div style="position:absolute;left:59.72px;top:466.04px" class="cls_004"><span class="cls_004">“absolutised”. For instance, the</span><span class="cls_007"> patchelfHead</span><span class="cls_004"> input element has been changed into:</span></div>
<div style="position:absolute;left:84.62px;top:487.45px" class="cls_015"><span class="cls_015">&lt;input  id='patchelfHead'  type='svn'</span></div>
<div style="position:absolute;left:94.04px;top:498.41px" class="cls_015"><span class="cls_015">url='</span><A HREF="https://.../repos/trace/patchelf/trunk/">https://.../repos/trace/patchelf/trunk</A> </div>
<div style="position:absolute;left:94.04px;top:509.37px" class="cls_015"><span class="cls_015">rev='3663'  hash='b252b5740a0d...'  /></span></div>
<div style="position:absolute;left:59.72px;top:521.26px" class="cls_004"><span class="cls_004">That is, it no longer refers to the HEAD revision of the Subversion repository of PatchELF,</span></div>
<div style="position:absolute;left:59.72px;top:533.21px" class="cls_004"><span class="cls_004">but to a specific revision. Since this</span><span class="cls_007"> job.xml</span><span class="cls_004"> is a perfectly valid build job, we can feed it</span></div>
<div style="position:absolute;left:59.72px;top:545.17px" class="cls_004"><span class="cls_004">into the supervisor to reproduce the build.</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_009"><span class="cls_009">Release process</span><span class="cls_004">   As can be seen in Figure 8.5, each release has a symbolic name, such</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">as</span><span class="cls_007"> patchelf-0.1pre3663</span><span class="cls_004">. The current build farm implements the policy that names including</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">216</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:152490px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background225.jpg" width=481 height=680></div>
<div style="position:absolute;left:330.97px;top:17.14px" class="cls_004"><span class="cls_004">8.3. Distributed builds</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">the string</span><span class="cls_007"> pre</span><span class="cls_004"> in the version string are “unstable” releases (i.e., only intended for developers</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">or bleeding edge users), and are “stable” otherwise. Stable releases are intended to be kept</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">indefinitely, while unstable releases can be deleted eventually. More importantly, stable</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">and unstable releases appear in separate channels. For instance, the URL of the channel</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">for stable PatchELF releases is</span></div>
<div style="position:absolute;left:88.78px;top:114.99px" class="cls_007"><span class="cls_007"> </span><A HREF="http://nix.cs.uu.nl/dist/nix/channels/patchelf-stable/">http://nix.cs.uu.nl/dist/nix/channels/patchelf-stable</A> </div>
<div style="position:absolute;left:63.87px;top:135.12px" class="cls_004"><span class="cls_004">while the channel for unstable releases is</span></div>
<div style="position:absolute;left:88.78px;top:157.25px" class="cls_007"><span class="cls_007"> </span><A HREF="http://nix.cs.uu.nl/dist/nix/channels/patchelf-unstable/">http://nix.cs.uu.nl/dist/nix/channels/patchelf-unstable</A> </div>
<div style="position:absolute;left:73.84px;top:177.38px" class="cls_004"><span class="cls_004">The release name is computed by the build jobs themselves. The component name (e.g.,</span></div>
<div style="position:absolute;left:63.87px;top:189.34px" class="cls_007"><span class="cls_007">patchelf</span><span class="cls_004">) is generally hard-coded into the build job (e.g., at</span></div>
<div style="position:absolute;left:312.89px;top:189.34px" class="cls_056"><span class="cls_056">147</span><span class="cls_059"> </span><span class="cls_004">).  The version name is</span></div>
<div style="position:absolute;left:63.87px;top:201.29px" class="cls_004"><span class="cls_004">usually computed by taking the version number hard-coded into the source (e.g.,</span><span class="cls_007"> 0.1</span><span class="cls_004">) and</span></div>
<div style="position:absolute;left:63.87px;top:213.25px" class="cls_004"><span class="cls_004">appending</span><span class="cls_007"> pre</span><span class="cls_004">N, where N is the revision number of the Subversion repository (e.g., 3663),</span></div>
<div style="position:absolute;left:63.87px;top:225.20px" class="cls_004"><span class="cls_004">if the release is unstable. Whether the release is stable or unstable is also hard-coded in</span></div>
<div style="position:absolute;left:63.87px;top:237.16px" class="cls_004"><span class="cls_004">the sources.</span></div>
<div style="position:absolute;left:73.84px;top:249.11px" class="cls_004"><span class="cls_004">For instance, for Autoconf-based components, the release name is usually computed by</span></div>
<div style="position:absolute;left:63.87px;top:261.07px" class="cls_004"><span class="cls_004">the</span><span class="cls_007"> configure</span><span class="cls_004"> script, which contains a line</span></div>
<div style="position:absolute;left:88.78px;top:284.62px" class="cls_015"><span class="cls_015">STABLE=0</span></div>
<div style="position:absolute;left:63.87px;top:298.66px" class="cls_004"><span class="cls_004">in the sources in the main development branch of the project (</span><span class="cls_007">trunk</span><span class="cls_004"> in Subversion termi-</span></div>
<div style="position:absolute;left:63.87px;top:310.62px" class="cls_004"><span class="cls_004">nology [137]). Thus all releases built from the main branch will be unstable releases. To</span></div>
<div style="position:absolute;left:63.87px;top:322.57px" class="cls_004"><span class="cls_004">build a stable release, it suffices to change the line to</span></div>
<div style="position:absolute;left:88.78px;top:346.13px" class="cls_015"><span class="cls_015">STABLE=1</span></div>
<div style="position:absolute;left:63.87px;top:360.17px" class="cls_004"><span class="cls_004">and rebuild.</span></div>
<div style="position:absolute;left:73.84px;top:372.12px" class="cls_004"><span class="cls_004">In practice, a more controlled process is used to build stable releases. To build a stable</span></div>
<div style="position:absolute;left:63.87px;top:384.08px" class="cls_004"><span class="cls_004">release, e.g.,</span><span class="cls_007"> patchelf-0.1</span><span class="cls_004">, the development branch is copied to a special release branch,</span></div>
<div style="position:absolute;left:63.87px;top:396.03px" class="cls_004"><span class="cls_004">e.g.,</span><span class="cls_007"> branches/patchelf-0.1-release</span><span class="cls_004">.  In this branch, the stable flag is set.  A one-time</span></div>
<div style="position:absolute;left:63.87px;top:407.99px" class="cls_004"><span class="cls_004">job for this branch is then added to</span><span class="cls_007"> jobs.conf</span><span class="cls_004">.  After the release succeeds, the release</span></div>
<div style="position:absolute;left:63.87px;top:419.94px" class="cls_004"><span class="cls_004">branch is tagged and removed.  That is,</span><span class="cls_007"> branches/</span><span class="cls_004">X</span><span class="cls_007"> -release</span><span class="cls_004"> is moved to</span><span class="cls_007"> tags/</span><span class="cls_004">X ; e.g.,</span></div>
<div style="position:absolute;left:63.87px;top:431.90px" class="cls_007"><span class="cls_007">branches/patchelf-0.1-release</span><span class="cls_004"> is moved to</span><span class="cls_007"> tags/patchelf-0.1</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:462.43px" class="cls_011"><span class="cls_011">8.3. Distributed builds</span></div>
<div style="position:absolute;left:63.87px;top:487.64px" class="cls_004"><span class="cls_004">Nix expressions allow multi-platform builds to be described and built in a centralised man-</span></div>
<div style="position:absolute;left:63.87px;top:499.60px" class="cls_004"><span class="cls_004">ner. In the Nix expression for the PatchELF job, we have one channel build for Linux:</span></div>
<div style="position:absolute;left:88.78px;top:523.15px" class="cls_015"><span class="cls_015">nixBuilds  =  [</span></div>
<div style="position:absolute;left:98.19px;top:534.11px" class="cls_015"><span class="cls_015">(patchelfNixBuild  input  pkgsLinux)</span></div>
<div style="position:absolute;left:88.78px;top:545.07px" class="cls_015"><span class="cls_015">];</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">Here,</span><span class="cls_007"> pkgsLinux</span><span class="cls_004"> is an attribute set consisting of the derivations in the Nix Packages collec-</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">tion built for</span><span class="cls_007"> i686-linux</span><span class="cls_004">. That is, the function</span><span class="cls_007"> patchelfNixBuild</span><span class="cls_004"> accepts the dependencies to</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">use as an argument</span><span class="cls_014"> </span><span class="cls_056">148</span><span class="cls_059"> </span><span class="cls_004">. Note that this includes the standard environment</span><span class="cls_007"> stdenv</span><span class="cls_004">, which</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">217</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:153180px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background226.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">8. Continuous Integration and Release Management</span></div>
<div style="position:absolute;left:63.10px;top:49.20px" class="cls_015"><span class="cls_015">nix@mcflurry.labs.cs.uu.nl   powerpc-darwin</span></div>
<div style="position:absolute;left:270.17px;top:49.20px" class="cls_015"><span class="cls_015">1</span></div>
<div style="position:absolute;left:63.10px;top:60.16px" class="cls_015"><span class="cls_015">nix@losser.labs.cs.uu.nl</span></div>
<div style="position:absolute;left:194.88px;top:60.16px" class="cls_015"><span class="cls_015">i686-freebsd</span></div>
<div style="position:absolute;left:270.18px;top:60.16px" class="cls_015"><span class="cls_015">1</span></div>
<div style="position:absolute;left:63.10px;top:71.12px" class="cls_015"><span class="cls_015">nix@itchy.labs.cs.uu.nl</span></div>
<div style="position:absolute;left:194.88px;top:71.12px" class="cls_015"><span class="cls_015">i686-linux</span></div>
<div style="position:absolute;left:270.18px;top:71.12px" class="cls_015"><span class="cls_015">1</span></div>
<div style="position:absolute;left:63.10px;top:82.08px" class="cls_015"><span class="cls_015">nix@scratchy.labs.cs.uu.nl   i686-linux</span></div>
<div style="position:absolute;left:270.18px;top:82.08px" class="cls_015"><span class="cls_015">2</span></div>
<div style="position:absolute;left:103.51px;top:99.91px" class="cls_004"><span class="cls_004">Figure 8.6.:</span><span class="cls_007"> remote-systems.conf</span><span class="cls_004">: definition of build farm machines</span></div>
<div style="position:absolute;left:59.72px;top:132.12px" class="cls_004"><span class="cls_004">determines the platform on which to build (since the function</span><span class="cls_007"> mkDerivation</span><span class="cls_004"> in</span><span class="cls_007"> stdenv</span><span class="cls_004"> sets</span></div>
<div style="position:absolute;left:59.72px;top:144.07px" class="cls_004"><span class="cls_004">the</span><span class="cls_007"> system</span><span class="cls_004"> attribute for the derivation).</span></div>
<div style="position:absolute;left:69.68px;top:156.11px" class="cls_004"><span class="cls_004">So if we also have sets of dependencies built for other platforms, we can trivially perform</span></div>
<div style="position:absolute;left:59.72px;top:168.06px" class="cls_004"><span class="cls_004">channel builds for these platforms, e.g.,:</span></div>
<div style="position:absolute;left:84.62px;top:192.49px" class="cls_015"><span class="cls_015">nixBuilds  =  [</span></div>
<div style="position:absolute;left:94.04px;top:203.45px" class="cls_015"><span class="cls_015">(patchelfNixBuild  input  pkgsLinux)</span></div>
<div style="position:absolute;left:94.04px;top:214.41px" class="cls_015"><span class="cls_015">(patchelfNixBuild  input  pkgsFreeBSD)</span></div>
<div style="position:absolute;left:94.04px;top:225.37px" class="cls_015"><span class="cls_015">(patchelfNixBuild  input  pkgsDarwin)</span></div>
<div style="position:absolute;left:84.62px;top:236.33px" class="cls_015"><span class="cls_015">];</span></div>
<div style="position:absolute;left:59.72px;top:251.24px" class="cls_004"><span class="cls_004">where</span><span class="cls_007"> pkgsFreeBSD</span><span class="cls_004"> is Nixpkgs built for</span><span class="cls_007"> i686-freebsd</span><span class="cls_004">, and</span><span class="cls_007"> pkgsDarwin</span><span class="cls_004"> is for</span><span class="cls_007"> powerpc-</span></div>
<div style="position:absolute;left:59.72px;top:263.20px" class="cls_007"><span class="cls_007">darwin</span><span class="cls_004"> (i.e., Apple’s Mac OS X). Thus this Nix expression abstracts over platforms and</span></div>
<div style="position:absolute;left:59.72px;top:275.15px" class="cls_004"><span class="cls_004">machines; it is up to Nix to somehow build each derivation on a machine of the appropriate</span></div>
<div style="position:absolute;left:59.72px;top:287.11px" class="cls_004"><span class="cls_004">type.</span></div>
<div style="position:absolute;left:69.68px;top:299.14px" class="cls_004"><span class="cls_004">Of course, the supervisor and</span><span class="cls_007"> build+upload.sh</span><span class="cls_004"> run on some particular platform, e.g.,</span></div>
<div style="position:absolute;left:59.72px;top:311.10px" class="cls_007"><span class="cls_007">i686-linux</span><span class="cls_004">.  Nix cannot build derivations for other platforms, and will fail if it has to do</span></div>
<div style="position:absolute;left:59.72px;top:323.05px" class="cls_004"><span class="cls_004">so (</span><span class="cls_056"> 76</span><span class="cls_059"> </span><span class="cls_004"> in Figure 5.11).  This is where build hooks come in (Section 5.5.2).  The script</span></div>
<div style="position:absolute;left:59.72px;top:335.01px" class="cls_007"><span class="cls_007">build+upload.sh</span><span class="cls_004"> runs Nix with the environment variable</span><span class="cls_007"> NIX_BUILD_HOOK</span><span class="cls_004"> pointing at a</span></div>
<div style="position:absolute;left:59.72px;top:346.96px" class="cls_004"><span class="cls_004">concrete build hook script</span><span class="cls_007"> build-remote.pl</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:359.00px" class="cls_004"><span class="cls_004">This hook uses a table of machines to perform builds,</span><span class="cls_007"> remote-systems.conf</span><span class="cls_004">, shown in</span></div>
<div style="position:absolute;left:59.72px;top:370.95px" class="cls_004"><span class="cls_004">Figure 8.6.  Each entry in the table specifies a user account and remote host on which</span></div>
<div style="position:absolute;left:59.72px;top:382.91px" class="cls_004"><span class="cls_004">a build can be performed (e.g.,</span><span class="cls_007"> nix@mcflurry.labs.cs.uu.nl</span><span class="cls_004">), the machine’s platform type</span></div>
<div style="position:absolute;left:59.72px;top:394.86px" class="cls_004"><span class="cls_004">(e.g.,</span><span class="cls_007"> powerpc-darwin</span><span class="cls_004">), and its maximum load, which is the maximum number of jobs that</span></div>
<div style="position:absolute;left:59.72px;top:406.82px" class="cls_004"><span class="cls_004">the hook will concurrently execute on the machine (e.g., 1). Generally, the maximum load</span></div>
<div style="position:absolute;left:59.72px;top:418.77px" class="cls_004"><span class="cls_004">is equal to the number of CPUs in the machine. There can be multiple machines with the</span></div>
<div style="position:absolute;left:59.72px;top:430.73px" class="cls_004"><span class="cls_004">same platform type, allowing more derivations to be built in parallel. The hook maintains</span></div>
<div style="position:absolute;left:59.72px;top:442.68px" class="cls_004"><span class="cls_004">the load on each machine in a persistent state file.</span></div>
<div style="position:absolute;left:69.68px;top:454.72px" class="cls_004"><span class="cls_004">The hook uses the Rsync protocol [163] over Secure Shell (SSH) [61] to copy the input</span></div>
<div style="position:absolute;left:59.72px;top:466.68px" class="cls_004"><span class="cls_004">closures to the Nix store of the selected remote machine. The build is then performed by</span></div>
<div style="position:absolute;left:59.72px;top:478.63px" class="cls_004"><span class="cls_004">running Nix on the remote machine (also executed through SSH). Finally, the output is</span></div>
<div style="position:absolute;left:59.72px;top:490.59px" class="cls_004"><span class="cls_004">copied back to the local Nix store using Rsync.</span></div>
<div style="position:absolute;left:59.72px;top:521.71px" class="cls_011"><span class="cls_011">8.4. Discussion and related work</span></div>
<div style="position:absolute;left:59.72px;top:547.08px" class="cls_004"><span class="cls_004">This section describes some of the advantages and disadvantages of the Nix build farm</span></div>
<div style="position:absolute;left:59.72px;top:559.03px" class="cls_004"><span class="cls_004">relative to other continuous integration tools.</span></div>
<div style="position:absolute;left:69.68px;top:571.07px" class="cls_004"><span class="cls_004">The main advantage is the use of Nix expressions to describe and build jobs. It makes the</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">management of the build environment (i.e., dependencies) quite easy and scalable. This</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">218</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:153870px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background227.jpg" width=481 height=680></div>
<div style="position:absolute;left:289.18px;top:17.14px" class="cls_004"><span class="cls_004">8.4. Discussion and related work</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">aspect is completely ignored by tools such as CruiseControl [158] and Tinderbox [69],</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">which expect the environment to be managed by the machine’s administrator. Anthill [165]</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">has the notion of “dependency groups” that allows an ordering between build jobs.</span></div>
<div style="position:absolute;left:73.84px;top:80.90px" class="cls_004"><span class="cls_004">Most of these systems are targeted at testing, not producing releases. Sisyphus [171]</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">on the other hand is a continuous integration system that is explicitly intended to support</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">deployment of upgrades to clients. It uses a destructive update model, which makes it easy</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">to use with existing deployment tools, but bars side-by-side versioning and rollbacks.</span></div>
<div style="position:absolute;left:73.84px;top:128.73px" class="cls_004"><span class="cls_004">The centralised view of the build job for a release is also a big plus. Systems such as</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">Tinderbox have a more “anarchistic” approach: build farm machines perform jobs essen-</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">tially independently, and send the results to a central machine that presents them on a web</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">page. This is fine for continuous integration per se, but is not a good model if we want</span></div>
<div style="position:absolute;left:63.87px;top:176.55px" class="cls_004"><span class="cls_004">integration with release management. Since each build independently selects which revi-</span></div>
<div style="position:absolute;left:63.87px;top:188.50px" class="cls_004"><span class="cls_004">sion to build, there is no guarantee that any particular revision will always be built by all</span></div>
<div style="position:absolute;left:63.87px;top:200.46px" class="cls_004"><span class="cls_004">machines. Thus there is no guarantee that a complete release page will ever be made.</span></div>
<div style="position:absolute;left:73.84px;top:212.41px" class="cls_004"><span class="cls_004">A fundamental downside to the Nix build farm is that by building in Nix, by definition</span></div>
<div style="position:absolute;left:63.87px;top:224.37px" class="cls_004"><span class="cls_004">we are building in a way that differs from the “native” method for the platform. If a com-</span></div>
<div style="position:absolute;left:63.87px;top:236.32px" class="cls_004"><span class="cls_004">ponent builds and passes the tests on</span><span class="cls_007"> powerpc-darwin</span><span class="cls_004">, we can conclude that the component</span></div>
<div style="position:absolute;left:63.87px;top:248.28px" class="cls_004"><span class="cls_004">can work on that platform; but we cannot conclude that it will work if a user were to down-</span></div>
<div style="position:absolute;left:63.87px;top:260.23px" class="cls_004"><span class="cls_004">load the source and build using the platform’s native tools (e.g., the C compiler provided</span></div>
<div style="position:absolute;left:63.87px;top:272.19px" class="cls_004"><span class="cls_004">in</span><span class="cls_007"> /usr/bin</span><span class="cls_004">).  That is, while the build farm builds the component in a Nix environment,</span></div>
<div style="position:absolute;left:63.87px;top:284.14px" class="cls_004"><span class="cls_004">most users will use it in a non-Nix environment. This limits the level of portability testing</span></div>
<div style="position:absolute;left:63.87px;top:296.10px" class="cls_004"><span class="cls_004">attained by the Nix build farm.</span></div>
<div style="position:absolute;left:73.84px;top:308.05px" class="cls_004"><span class="cls_004">On the other hand, this situation can be improved by simulating the native environment</span></div>
<div style="position:absolute;left:63.87px;top:320.01px" class="cls_004"><span class="cls_004">as closely as possible, e.g., by providing the same tool versions. Nevertheless, there is no</span></div>
<div style="position:absolute;left:63.87px;top:331.96px" class="cls_004"><span class="cls_004">getting around the fact that the paths of those tools differ; they are in the store, not in their</span></div>
<div style="position:absolute;left:63.87px;top:343.92px" class="cls_004"><span class="cls_004">native locations in the file system.</span></div>
<div style="position:absolute;left:73.84px;top:355.87px" class="cls_004"><span class="cls_004">However, we can still build “native” binary distributions in some cases. For example,</span></div>
<div style="position:absolute;left:63.87px;top:367.83px" class="cls_004"><span class="cls_004">we use User-Mode Linux (UML) [45] to build RPM packages for various platforms. User-</span></div>
<div style="position:absolute;left:63.87px;top:379.78px" class="cls_004"><span class="cls_004">Mode Linux is a normal user space program that runs a complete Linux operating system</span></div>
<div style="position:absolute;left:63.87px;top:391.74px" class="cls_004"><span class="cls_004">inside a virtual machine. Thus, the builder of the derivation that builds RPMs is entirely</span></div>
<div style="position:absolute;left:63.87px;top:403.69px" class="cls_004"><span class="cls_004">pure: it simply runs UML to build the RPM.</span></div>
<div style="position:absolute;left:73.84px;top:415.65px" class="cls_004"><span class="cls_004">Of course, we can also do “native” builds directly in Nix builders if we are willing to</span></div>
<div style="position:absolute;left:63.87px;top:427.60px" class="cls_004"><span class="cls_004">accept a level of impurity (e.g., by adding</span><span class="cls_007"> /usr/bin</span><span class="cls_004"> to</span><span class="cls_007"> PATH</span><span class="cls_004">). We can even test whether the</span></div>
<div style="position:absolute;left:63.87px;top:439.56px" class="cls_004"><span class="cls_004">component installs properly to an impure location (such as</span><span class="cls_007"> /usr/local/my-package</span><span class="cls_004">) if the</span></div>
<div style="position:absolute;left:63.87px;top:451.52px" class="cls_004"><span class="cls_004">builder has sufficient permissions. In fact, the latter need not even be impure as long as the</span></div>
<div style="position:absolute;left:63.87px;top:463.47px" class="cls_004"><span class="cls_004">following conditions hold:</span></div>
<div style="position:absolute;left:78.82px;top:483.40px" class="cls_004"><span class="cls_004">• Subsequent derivations do not depend on output in impure locations.  Thus, the</span></div>
<div style="position:absolute;left:88.78px;top:495.35px" class="cls_004"><span class="cls_004">builder should remove the impure output at the end of the build script.</span></div>
<div style="position:absolute;left:78.82px;top:515.28px" class="cls_004"><span class="cls_004">• Locking should be used to prevent multiple derivations from installing into the same</span></div>
<div style="position:absolute;left:88.78px;top:527.23px" class="cls_004"><span class="cls_004">impure location. E.g., derivations that want to install into</span><span class="cls_007"> /usr/local/my-package</span><span class="cls_004"> can</span></div>
<div style="position:absolute;left:88.78px;top:539.19px" class="cls_004"><span class="cls_004">acquire an exclusive lock on a lock</span><span class="cls_007"> /usr/local/my-package.lock</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:559.11px" class="cls_004"><span class="cls_004">A more transient limitation of the prototype build farm is its poor scheduling. (A better</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">supervisor is currently being implemented.) It simply runs jobs after each other in a con-</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">tinuous loop. It supports none of the more advanced scheduling methods discussed earlier.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">219</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:154560px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background228.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">8. Continuous Integration and Release Management</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">It also does not run jobs in parallel, which leads to poor utilisation of the build farm. For</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">instance, builds on Macs generally take (much) longer than on other machines. A multi-</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">platform job can therefore cause many machines to be idle, as the job waits for the Mac</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">build to finish. It is then useful to start a new job to put the idle machines to good use.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">220</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:155250px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background229.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:88.81px" class="cls_006"><span class="cls_006">9. Service Deployment</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">This chapter shows that Nix extends naturally into the domain of service deployment. A</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">software service is a set of processes running on one or more machines that cooperate to</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">provide a useful facility to an end-user or to another software system. An example might</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">be a bug tracking service, implemented through a web server running certain web applica-</span></div>
<div style="position:absolute;left:63.87px;top:176.55px" class="cls_004"><span class="cls_004">tions and a back-end database storing persistent data. A service is generally implemented</span></div>
<div style="position:absolute;left:63.87px;top:188.50px" class="cls_004"><span class="cls_004">through a set of software components, static data files, dynamic state (such as databases</span></div>
<div style="position:absolute;left:63.87px;top:200.46px" class="cls_004"><span class="cls_004">and log files), and configuration files that tie all these together.</span></div>
<div style="position:absolute;left:73.84px;top:212.41px" class="cls_004"><span class="cls_004">The deployment of such software services is very often a time-consuming and error-</span></div>
<div style="position:absolute;left:63.87px;top:224.37px" class="cls_004"><span class="cls_004">prone activity for developers and system administrators.  In order to produce a working</span></div>
<div style="position:absolute;left:63.87px;top:236.32px" class="cls_004"><span class="cls_004">service, one must typically install a large set of components, put them in the right locations,</span></div>
<div style="position:absolute;left:63.87px;top:248.28px" class="cls_004"><span class="cls_004">write configuration files, create state directories or initialise databases, make sure that all</span></div>
<div style="position:absolute;left:63.87px;top:260.23px" class="cls_004"><span class="cls_004">sorts of processes are started in the right order on the right machines, and so on. These</span></div>
<div style="position:absolute;left:63.87px;top:272.19px" class="cls_004"><span class="cls_004">activities are quite often performed manually, or scripted in an ad hoc way.</span></div>
<div style="position:absolute;left:73.84px;top:284.14px" class="cls_004"><span class="cls_004">A particularly troubling aspect of common service deployment practice is the lack of</span></div>
<div style="position:absolute;left:63.87px;top:296.10px" class="cls_004"><span class="cls_004">good configuration management.  For instance, the software environment of a machine</span></div>
<div style="position:absolute;left:63.87px;top:308.05px" class="cls_004"><span class="cls_004">may be under the control of a package manager, and the configuration files and static data</span></div>
<div style="position:absolute;left:63.87px;top:320.01px" class="cls_004"><span class="cls_004">of the service under the control of a version management system. That is, these two parts</span></div>
<div style="position:absolute;left:63.87px;top:331.96px" class="cls_004"><span class="cls_004">of the service are both under CM control.  However, the combination of the two isn’t:</span></div>
<div style="position:absolute;left:63.87px;top:343.92px" class="cls_004"><span class="cls_004">we don’t have a way to express that (say) the configuration of a web server consists of a</span></div>
<div style="position:absolute;left:63.87px;top:355.87px" class="cls_004"><span class="cls_004">composition of a specific instance of Apache, specific versions of configuration files and</span></div>
<div style="position:absolute;left:63.87px;top:367.83px" class="cls_004"><span class="cls_004">data files, and so on.</span></div>
<div style="position:absolute;left:73.84px;top:379.78px" class="cls_004"><span class="cls_004">This means that we lack important features of good CM practice. There is no identi-</span></div>
<div style="position:absolute;left:63.87px;top:391.74px" class="cls_004"><span class="cls_004">fication: we do not have a way to name what the running configuration on a system is.</span></div>
<div style="position:absolute;left:63.87px;top:403.69px" class="cls_004"><span class="cls_004">We may have a way to identify the configurations of the code and data bits (e.g., through</span></div>
<div style="position:absolute;left:63.87px;top:415.65px" class="cls_004"><span class="cls_004">package management and version management tools), but we have no handle on the com-</span></div>
<div style="position:absolute;left:63.87px;top:427.60px" class="cls_004"><span class="cls_004">position. Likewise, there is no derivation management: a software service is ideally an</span></div>
<div style="position:absolute;left:63.87px;top:439.56px" class="cls_004"><span class="cls_004">automatically constructed derivate of code and data artifacts, meaning that we can always</span></div>
<div style="position:absolute;left:63.87px;top:451.52px" class="cls_004"><span class="cls_004">automatically rebuild it, e.g., to move it to another machine. However, if administrators</span></div>
<div style="position:absolute;left:63.87px;top:463.47px" class="cls_004"><span class="cls_004">ever manually edit a file of a running service, we lose this property.</span></div>
<div style="position:absolute;left:73.84px;top:475.43px" class="cls_004"><span class="cls_004">In practice, we see that important service deployment operations are quite hard. Moving</span></div>
<div style="position:absolute;left:63.87px;top:487.38px" class="cls_004"><span class="cls_004">a service to another machine can be time-consuming if we have to figure out exactly what</span></div>
<div style="position:absolute;left:63.87px;top:499.34px" class="cls_004"><span class="cls_004">software components to install in order to establish the proper environment for the service.</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">Having multiple instances of a service (e.g., a test and production instance) running side-</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">by-side on the same machine is difficult since we must arrange for the instances not to</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">overwrite each other, which often entails manually copying files and tweaking paths in</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">configuration files.  Performing a rollback of a configuration after an upgrade might be</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">very difficult, in particular if software components were replaced.</span></div>
<div style="position:absolute;left:73.84px;top:571.07px" class="cls_004"><span class="cls_004">Of course, these properties—automatic derivations, side-by-side existence, rollbacks,</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">identifiability and reproducibility—are all provided by Nix. Up till now, we have shown</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">221</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:155940px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background230.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">9. Service Deployment</span></div>
<div style="position:absolute;left:231.11px;top:54.07px" class="cls_055"><span class="cls_055">configuration</span></div>
<div style="position:absolute;left:242.39px;top:71.93px" class="cls_055"><span class="cls_055">control</span></div>
<div style="position:absolute;left:317.12px;top:89.79px" class="cls_055"><span class="cls_055">data</span></div>
<div style="position:absolute;left:236.75px;top:107.65px" class="cls_055"><span class="cls_055">http.conf</span></div>
<div style="position:absolute;left:299.73px;top:107.65px" class="cls_055"><span class="cls_055">/data/subversion/</span></div>
<div style="position:absolute;left:213.25px;top:129.27px" class="cls_055"><span class="cls_055">software</span></div>
<div style="position:absolute;left:221.71px;top:147.13px" class="cls_055"><span class="cls_055">subversion</span></div>
<div style="position:absolute;left:271.06px;top:147.13px" class="cls_055"><span class="cls_055">apache</span></div>
<div style="position:absolute;left:132.41px;top:180.97px" class="cls_055"><span class="cls_055">perl</span></div>
<div style="position:absolute;left:165.31px;top:180.97px" class="cls_055"><span class="cls_055">perlBerkeleyDB</span></div>
<div style="position:absolute;left:229.70px;top:180.97px" class="cls_055"><span class="cls_055">openssl</span></div>
<div style="position:absolute;left:272.00px;top:180.97px" class="cls_055"><span class="cls_055">db4</span></div>
<div style="position:absolute;left:303.96px;top:180.97px" class="cls_055"><span class="cls_055">expat</span></div>
<div style="position:absolute;left:59.72px;top:224.44px" class="cls_004"><span class="cls_004">Figure 9.1.: Dependencies between code, configuration, and data components in a Subver-</span></div>
<div style="position:absolute;left:108.42px;top:236.40px" class="cls_004"><span class="cls_004">sion service</span></div>
<div style="position:absolute;left:59.72px;top:266.54px" class="cls_004"><span class="cls_004">how software components can be built and deployed through Nix. This chapter shows that</span></div>
<div style="position:absolute;left:59.72px;top:278.50px" class="cls_004"><span class="cls_004">simply by treating services as components, we can build and deploy those as well.</span></div>
<div style="position:absolute;left:59.72px;top:309.61px" class="cls_011"><span class="cls_011">9.1. Overview</span></div>
<div style="position:absolute;left:59.72px;top:336.17px" class="cls_008"><span class="cls_008">9.1.1. Service components</span></div>
<div style="position:absolute;left:59.72px;top:355.80px" class="cls_004"><span class="cls_004">From the perspective of a user, a service is a collection of data in some format with a</span></div>
<div style="position:absolute;left:59.72px;top:367.75px" class="cls_004"><span class="cls_004">coherent set of operations (use cases) on those data. Typical examples are a Subversion</span></div>
<div style="position:absolute;left:59.72px;top:379.71px" class="cls_004"><span class="cls_004">version management service [137] in which the data are repositories and the operations</span></div>
<div style="position:absolute;left:59.72px;top:391.66px" class="cls_004"><span class="cls_004">are version management actions such as committing, adding, and renaming files; a TWiki</span></div>
<div style="position:absolute;left:59.72px;top:403.62px" class="cls_004"><span class="cls_004">service [157] in which the data are web pages and operations are viewing, editing, and</span></div>
<div style="position:absolute;left:59.72px;top:415.57px" class="cls_004"><span class="cls_004">adding pages; and a JIRA issue-tracking service in which the data consists of entries in an</span></div>
<div style="position:absolute;left:59.72px;top:427.53px" class="cls_004"><span class="cls_004">issue data-base and the operations are issue management actions such as opening, updating,</span></div>
<div style="position:absolute;left:59.72px;top:439.48px" class="cls_004"><span class="cls_004">and closing issues. In these examples, the service has persistent data that is stored on the</span></div>
<div style="position:absolute;left:59.72px;top:451.44px" class="cls_004"><span class="cls_004">server and that can be modified by the operations of the server. However, a service can</span></div>
<div style="position:absolute;left:59.72px;top:463.39px" class="cls_004"><span class="cls_004">also be stateless and just provide some computation on data provided by the client at each</span></div>
<div style="position:absolute;left:59.72px;top:475.35px" class="cls_004"><span class="cls_004">request, e.g., a translation service that translates a document uploaded by the client.</span></div>
<div style="position:absolute;left:69.68px;top:487.38px" class="cls_004"><span class="cls_004">From the perspective of a system administrator, a service consists of data directories</span></div>
<div style="position:absolute;left:59.72px;top:499.34px" class="cls_004"><span class="cls_004">containing the persistent state, software components that implement the operations on the</span></div>
<div style="position:absolute;left:59.72px;top:511.29px" class="cls_004"><span class="cls_004">data, and a configuration of those components binding the software to the data and to the</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">local environment.  Typically, the configuration includes definitions of paths to data di-</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">rectories and software components, and items such as the URLs and ports at which the</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">service is provided. Furthermore, the configuration provides meta-operations for initialis-</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">ing, starting, and stopping the service. Figure 9.1 illustrates this with a diagram sketching</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">the composition of a version management service based on Apache and Subversion com-</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">ponents. The control component is a script that implements the meta-operations, while the</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">222</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:156630px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background231.jpg" width=481 height=680></div>
<div style="position:absolute;left:363.36px;top:17.14px" class="cls_004"><span class="cls_004">9.1. Overview</span></div>
<div style="position:absolute;left:67.26px;top:49.95px" class="cls_015"><span class="cls_015">ServerRoot  "/var/httpd"</span></div>
<div style="position:absolute;left:67.26px;top:60.90px" class="cls_015"><span class="cls_015">ServerAdmin  eelco@cs.uu.nl</span></div>
<div style="position:absolute;left:67.26px;top:71.86px" class="cls_015"><span class="cls_015">ServerName  svn.cs.uu.nl:8080</span></div>
<div style="position:absolute;left:67.26px;top:82.82px" class="cls_015"><span class="cls_015">DocumentRoot  "/var/httpd/root"</span></div>
<div style="position:absolute;left:67.26px;top:93.78px" class="cls_015"><span class="cls_015">LoadModule  dav_svn_module  /usr/lib/modules/mod_dav_svn.so</span></div>
<div style="position:absolute;left:67.26px;top:104.74px" class="cls_015"><span class="cls_015">&lt;Location  /repos></span></div>
<div style="position:absolute;left:86.09px;top:115.70px" class="cls_015"><span class="cls_015">AuthType  Basic</span></div>
<div style="position:absolute;left:86.09px;top:126.66px" class="cls_015"><span class="cls_015">AuthDBMUserFile  /data/subversion/db/svn-users</span></div>
<div style="position:absolute;left:86.09px;top:148.58px" class="cls_015"><span class="cls_015">DAV  svn</span></div>
<div style="position:absolute;left:86.09px;top:159.53px" class="cls_015"><span class="cls_015">SVNParentPath  /data/subversion/repos</span></div>
<div style="position:absolute;left:67.26px;top:170.49px" class="cls_015"><span class="cls_015">&lt;/Location></span></div>
<div style="position:absolute;left:77.66px;top:187.08px" class="cls_004"><span class="cls_004">Figure 9.2.: Parts of</span><span class="cls_007"> httpd.conf</span><span class="cls_004"> showing hosting of Subversion by an Apache server</span></div>
<div style="position:absolute;left:63.87px;top:220.16px" class="cls_004"><span class="cls_004">file</span><span class="cls_007"> httpd.conf</span><span class="cls_004"> defines the configuration. The software components underlying a service are</span></div>
<div style="position:absolute;left:63.87px;top:232.11px" class="cls_004"><span class="cls_004">generally not self-contained, but rather composed from a (large) number of auxiliary com-</span></div>
<div style="position:absolute;left:63.87px;top:244.07px" class="cls_004"><span class="cls_004">ponents. For example, Figure 9.1 shows that Subversion and Apache depend on a number</span></div>
<div style="position:absolute;left:63.87px;top:256.02px" class="cls_004"><span class="cls_004">of other software components such as OpenSSL and Berkeley DB.</span></div>
<div style="position:absolute;left:63.87px;top:286.57px" class="cls_008"><span class="cls_008">9.1.2. Service configuration and deployment</span></div>
<div style="position:absolute;left:63.87px;top:307.03px" class="cls_004"><span class="cls_004">Setting up a service requires installing the software components and all of their dependen-</span></div>
<div style="position:absolute;left:63.87px;top:318.98px" class="cls_004"><span class="cls_004">cies, ensuring that the versions of the installed components are compatible with each other.</span></div>
<div style="position:absolute;left:63.87px;top:330.94px" class="cls_004"><span class="cls_004">The data directories should be initialised to the required format and possibly filled with</span></div>
<div style="position:absolute;left:63.87px;top:342.89px" class="cls_004"><span class="cls_004">an initial data set. Finally, a configuration file should be created to point to the software</span></div>
<div style="position:absolute;left:63.87px;top:354.85px" class="cls_004"><span class="cls_004">and data components. For example, Figure 9.2 shows an excerpt of an Apache</span><span class="cls_007"> httpd.conf</span></div>
<div style="position:absolute;left:63.87px;top:366.80px" class="cls_004"><span class="cls_004">configuration file for a Subversion service. The file uses absolute pathnames to software</span></div>
<div style="position:absolute;left:63.87px;top:378.76px" class="cls_004"><span class="cls_004">components such as a WebDAV module for Subversion, and data directories such as the</span></div>
<div style="position:absolute;left:63.87px;top:390.71px" class="cls_004"><span class="cls_004">place where repositories are stored.</span></div>
<div style="position:absolute;left:73.84px;top:403.18px" class="cls_004"><span class="cls_004">Installation of software components using traditional package management systems is</span></div>
<div style="position:absolute;left:63.87px;top:415.14px" class="cls_004"><span class="cls_004">fraught with problems. Package managers do not enforce the completeness of dependency</span></div>
<div style="position:absolute;left:63.87px;top:427.09px" class="cls_004"><span class="cls_004">declarations of a component. The fact that a component works in a test environment, does</span></div>
<div style="position:absolute;left:63.87px;top:439.05px" class="cls_004"><span class="cls_004">not guarantee that it will work on a client site, since the test environment may provide</span></div>
<div style="position:absolute;left:63.87px;top:451.00px" class="cls_004"><span class="cls_004">components that are not explicitly declared as dependencies.  As a consequence, com-</span></div>
<div style="position:absolute;left:63.87px;top:462.96px" class="cls_004"><span class="cls_004">ponent compositions are not reproducible. The installation of components in a common</span></div>
<div style="position:absolute;left:63.87px;top:474.91px" class="cls_004"><span class="cls_004">directory makes it hard to install multiple versions of a component or to roll back to a</span></div>
<div style="position:absolute;left:63.87px;top:486.87px" class="cls_004"><span class="cls_004">previous configuration if it turns out that upgrading produces a faulty configuration.</span></div>
<div style="position:absolute;left:73.84px;top:499.34px" class="cls_004"><span class="cls_004">These problems are compounded in the case of service management. Typically, man-</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">agement of configuration files is not coupled to management of software components.</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">Configuration files are maintained in some specific directory in the file system and chang-</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">ing a configuration is a destructive operation.  Even if the configuration files are under</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">version management, there is no coupling to the versions of the software components that</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">they configure. Thus, even if it is possible to do a rollback of the configuration files to a</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">previous time, the installation of the software components may have changed in the mean-</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">time and become out of synch with the old configuration files.  Finally, having a global</span></div>
<div style="position:absolute;left:407.23px;top:624.86px" class="cls_004"><span class="cls_004">223</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:157320px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background232.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">9. Service Deployment</span></div>
<div style="position:absolute;left:63.10px;top:49.95px" class="cls_015"><span class="cls_015">{ stdenv,  apacheHttpd,  subversion  }:</span></div>
<div style="position:absolute;left:63.10px;top:60.90px" class="cls_015"><span class="cls_015">stdenv.mkDerivation  {</span></div>
<div style="position:absolute;left:72.52px;top:71.86px" class="cls_015"><span class="cls_015">name</span></div>
<div style="position:absolute;left:110.16px;top:71.86px" class="cls_015"><span class="cls_015">= "svn-service";</span></div>
<div style="position:absolute;left:72.52px;top:82.82px" class="cls_015"><span class="cls_015">builder  =  ./builder.sh;  #  Build  script.</span></div>
<div style="position:absolute;left:72.52px;top:93.78px" class="cls_015"><span class="cls_015">control  =  ./control.in;  #  Control  script  template.</span></div>
<div style="position:absolute;left:72.52px;top:104.74px" class="cls_015"><span class="cls_015">conf</span></div>
<div style="position:absolute;left:110.16px;top:104.74px" class="cls_015"><span class="cls_015">= ./httpd.conf.in;  #  Apache  configuration  template.</span></div>
<div style="position:absolute;left:72.52px;top:115.70px" class="cls_015"><span class="cls_015">inherit  apacheHttpd  subversion;</span></div>
<div style="position:absolute;left:63.10px;top:126.66px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:63.48px;top:143.25px" class="cls_004"><span class="cls_004">Figure 9.3.:</span><span class="cls_007"> services/svn.nix</span><span class="cls_004">: Function for creating an Apache-based Subversion service</span></div>
<div style="position:absolute;left:63.10px;top:171.13px" class="cls_015"><span class="cls_015">pkgs  =  import  ../pkgs/system/all-packages.nix;</span></div>
<div style="position:absolute;left:63.10px;top:182.08px" class="cls_015"><span class="cls_015">subversion  =  import  ../subversion/  {</span></div>
<div style="position:absolute;left:72.52px;top:193.04px" class="cls_015"><span class="cls_015"># Get  dependencies  from  all-packages.nix.</span></div>
<div style="position:absolute;left:72.52px;top:204.00px" class="cls_015"><span class="cls_015">inherit  (pkgs)  stdenv  fetchurl  openssl  httpd  ...;</span></div>
<div style="position:absolute;left:63.10px;top:214.96px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:63.10px;top:225.92px" class="cls_015"><span class="cls_015">webServer  =  import  ../services/svn.nix  {</span></div>
<div style="position:absolute;left:72.52px;top:236.88px" class="cls_015"><span class="cls_015">inherit  (pkgs)  stdenv  apacheHttpd;</span></div>
<div style="position:absolute;left:63.10px;top:247.84px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:59.72px;top:273.30px" class="cls_004"><span class="cls_004">Figure 9.4.:</span><span class="cls_007"> configurations/svn.cs.uu.nl.nix</span><span class="cls_004">: Composition of a Subversion service for a spe-</span></div>
<div style="position:absolute;left:108.42px;top:285.25px" class="cls_004"><span class="cls_004">cific machine</span></div>
<div style="position:absolute;left:59.72px;top:313.03px" class="cls_004"><span class="cls_004">configuration makes it hard to have multiple versions of a service running side by side, for</span></div>
<div style="position:absolute;left:59.72px;top:324.98px" class="cls_004"><span class="cls_004">instance a production version and a version for testing an upgrade.</span></div>
<div style="position:absolute;left:59.72px;top:352.21px" class="cls_008"><span class="cls_008">9.1.3. Capturing component compositions with Nix expressions</span></div>
<div style="position:absolute;left:59.72px;top:371.68px" class="cls_004"><span class="cls_004">A service can be constructed just like a software component by composing the required</span></div>
<div style="position:absolute;left:59.72px;top:383.64px" class="cls_004"><span class="cls_004">software, configuration, and control components. For example, Figure 9.3 defines a func-</span></div>
<div style="position:absolute;left:59.72px;top:395.60px" class="cls_004"><span class="cls_004">tion for producing a Subversion service, given Apache (</span><span class="cls_007">httpd</span><span class="cls_004">) and Subversion components.</span></div>
<div style="position:absolute;left:59.72px;top:407.55px" class="cls_004"><span class="cls_004">The build script of the service creates the Apache configuration file</span><span class="cls_007"> httpd.conf</span><span class="cls_004"> and the con-</span></div>
<div style="position:absolute;left:59.72px;top:419.51px" class="cls_004"><span class="cls_004">trol script</span><span class="cls_007"> bin/control</span><span class="cls_004"> from templates by filling in the paths to the appropriate software</span></div>
<div style="position:absolute;left:59.72px;top:431.46px" class="cls_004"><span class="cls_004">components. That is, the template</span><span class="cls_007"> httpd.conf.in</span><span class="cls_004"> contains placeholders such as</span></div>
<div style="position:absolute;left:84.62px;top:453.44px" class="cls_015"><span class="cls_015">LoadModule  dav_svn_module  @subversion@/modules/mod_dav_svn.so</span></div>
<div style="position:absolute;left:59.72px;top:465.90px" class="cls_004"><span class="cls_004">rather than absolute paths. The funcion in Figure 9.3 can be instantiated to create a concrete</span></div>
<div style="position:absolute;left:59.72px;top:477.85px" class="cls_004"><span class="cls_004">instance of the service.  For example, Figure 9.4 defines the composition of a concrete</span></div>
<div style="position:absolute;left:59.72px;top:489.81px" class="cls_004"><span class="cls_004">Subversion service using an</span><span class="cls_007"> ./httpd.conf</span><span class="cls_004"> file defining the particulars of the service.  Just</span></div>
<div style="position:absolute;left:59.72px;top:501.76px" class="cls_004"><span class="cls_004">like installing a software component composition, service composition can be reproducibly</span></div>
<div style="position:absolute;left:59.72px;top:513.72px" class="cls_004"><span class="cls_004">installed using the</span><span class="cls_007"> nix-env</span><span class="cls_004"> command:</span></div>
<div style="position:absolute;left:84.62px;top:535.69px" class="cls_015"><span class="cls_015">$ nix-env  -p  /nix/var/nix/profiles/svn  \</span></div>
<div style="position:absolute;left:103.45px;top:546.65px" class="cls_015"><span class="cls_015">-f  configuration/svn.nix  -i</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">I.e., the service component is added to the specified profile. The execution of the service,</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">initialisation, activation, and deactivation, can be controlled using the control script with</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">commands such as</span></div>
<div style="position:absolute;left:59.72px;top:624.86px" class="cls_004"><span class="cls_004">224</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:158010px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background233.jpg" width=481 height=680></div>
<div style="position:absolute;left:305.39px;top:17.14px" class="cls_004"><span class="cls_004">9.2. Composition of services</span></div>
<div style="position:absolute;left:67.26px;top:49.20px" class="cls_015"><span class="cls_015"># Recall  the  old  server</span></div>
<div style="position:absolute;left:67.26px;top:60.16px" class="cls_015"><span class="cls_015">oldServer=$(readlink  -f  $profiles/$serverName  ||  true)</span></div>
<div style="position:absolute;left:67.26px;top:82.08px" class="cls_015"><span class="cls_015"># Build  and  install  the  new  server.</span></div>
<div style="position:absolute;left:67.26px;top:93.03px" class="cls_015"><span class="cls_015">nix-env  -p  $profiles/$serverName  -f  "$nixExpr"  -i</span></div>
<div style="position:absolute;left:67.26px;top:114.95px" class="cls_015"><span class="cls_015"># Stop  the  old  server.</span></div>
<div style="position:absolute;left:67.26px;top:125.91px" class="cls_015"><span class="cls_015">if  test  -n  "$oldServer";  then</span></div>
<div style="position:absolute;left:86.09px;top:136.87px" class="cls_015"><span class="cls_015">$oldServer/bin/control  stop  ||  true</span></div>
<div style="position:absolute;left:67.26px;top:147.83px" class="cls_015"><span class="cls_015">fi</span></div>
<div style="position:absolute;left:67.26px;top:169.75px" class="cls_015"><span class="cls_015"># Start  the  new  server.</span></div>
<div style="position:absolute;left:67.26px;top:180.71px" class="cls_015"><span class="cls_015">$profiles/$serverName/bin/control  start</span></div>
<div style="position:absolute;left:87.55px;top:198.54px" class="cls_004"><span class="cls_004">Figure 9.5.:</span><span class="cls_007"> upgrade-server</span><span class="cls_004">: Upgrading coupled to activation and deactivation</span></div>
<div style="position:absolute;left:88.78px;top:236.07px" class="cls_015"><span class="cls_015">$ /nix/var/nix/profiles/svn/bin/control  start</span></div>
<div style="position:absolute;left:63.87px;top:251.09px" class="cls_004"><span class="cls_004">Similarly, the</span><span class="cls_007"> stop</span><span class="cls_004"> action stops the server.</span></div>
<div style="position:absolute;left:63.87px;top:279.44px" class="cls_008"><span class="cls_008">9.1.4. Maintaining the service</span></div>
<div style="position:absolute;left:63.87px;top:299.13px" class="cls_004"><span class="cls_004">A service evolves over time.  New versions of components become available with new</span></div>
<div style="position:absolute;left:63.87px;top:311.09px" class="cls_004"><span class="cls_004">functionality or security fixes; the configuration needs to be adapted to reflect changing</span></div>
<div style="position:absolute;left:63.87px;top:323.04px" class="cls_004"><span class="cls_004">requirements or changes in the environment; the machine that hosts the service needs to</span></div>
<div style="position:absolute;left:63.87px;top:335.00px" class="cls_004"><span class="cls_004">be rebooted; or the machine is retired and the service needs to be migrated to another</span></div>
<div style="position:absolute;left:63.87px;top:346.95px" class="cls_004"><span class="cls_004">machine. Such changes can be expressed by adapting the Nix expressions appropriately</span></div>
<div style="position:absolute;left:63.87px;top:358.91px" class="cls_004"><span class="cls_004">and rebuilding the service. The</span><span class="cls_007"> upgrade-server</span><span class="cls_004"> script in Figure 9.5 implements a common</span></div>
<div style="position:absolute;left:63.87px;top:370.86px" class="cls_004"><span class="cls_004">sequence of actions to upgrade a service: build the new service, stop the old service, and</span></div>
<div style="position:absolute;left:63.87px;top:382.82px" class="cls_004"><span class="cls_004">start the new one. Since changes are non-destructive, it is possible (through a similar com-</span></div>
<div style="position:absolute;left:63.87px;top:394.78px" class="cls_004"><span class="cls_004">mand sequence) to roll back to a previous installation if the new one is not satisfactory.</span></div>
<div style="position:absolute;left:63.87px;top:406.73px" class="cls_004"><span class="cls_004">By keeping the Nix expressions defining a service under version management, the com-</span></div>
<div style="position:absolute;left:63.87px;top:418.69px" class="cls_004"><span class="cls_004">plete history of all aspects of the service is managed, and any version can be reproduced at</span></div>
<div style="position:absolute;left:63.87px;top:430.64px" class="cls_004"><span class="cls_004">any time. An even better approach is to have</span><span class="cls_007"> upgrade-server</span><span class="cls_004"> build directly from a version</span></div>
<div style="position:absolute;left:63.87px;top:442.60px" class="cls_004"><span class="cls_004">management repository, rather than from a working copy. In this way we can always trace</span></div>
<div style="position:absolute;left:63.87px;top:454.55px" class="cls_004"><span class="cls_004">a running service configuration back to its sources in the version management system.</span></div>
<div style="position:absolute;left:63.87px;top:485.86px" class="cls_011"><span class="cls_011">9.2. Composition of services</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">The previous section showed a sketch of an Apache-based Subversion service deployed us-</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">ing Nix. The major advantage is that such a service is a closure: all code and configuration</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">elements of the service are described in the Nix expression, and can thus be reproduced at</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">any time. Clearly, we can deploy other services along similar lines. For instance, we might</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">want to deploy an Apache-based TWiki service by providing Nix expressions to build the</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">TWiki components and to compose them with Apache (which entails writing a parame-</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">terised</span><span class="cls_007"> httpd.conf</span><span class="cls_004"> that enables the TWiki CGI scripts in Apache). However, suppose we</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">225</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:158700px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background234.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">9. Service Deployment</span></div>
<div style="position:absolute;left:192.81px;top:64.41px" class="cls_055"><span class="cls_055">control</span></div>
<div style="position:absolute;left:138.29px;top:86.03px" class="cls_055"><span class="cls_055">data</span></div>
<div style="position:absolute;left:231.35px;top:86.03px" class="cls_055"><span class="cls_055">configuration</span></div>
<div style="position:absolute;left:120.90px;top:103.89px" class="cls_055"><span class="cls_055">/data/subversion/</span></div>
<div style="position:absolute;left:205.97px;top:103.89px" class="cls_055"><span class="cls_055">http.conf</span></div>
<div style="position:absolute;left:133.59px;top:137.73px" class="cls_055"><span class="cls_055">/data/twiki</span></div>
<div style="position:absolute;left:204.56px;top:137.73px" class="cls_055"><span class="cls_055">twiki.conf</span></div>
<div style="position:absolute;left:252.03px;top:137.73px" class="cls_055"><span class="cls_055">subversion.conf</span></div>
<div style="position:absolute;left:266.60px;top:159.35px" class="cls_055"><span class="cls_055">software</span></div>
<div style="position:absolute;left:211.14px;top:177.21px" class="cls_055"><span class="cls_055">twiki</span></div>
<div style="position:absolute;left:257.20px;top:177.21px" class="cls_055"><span class="cls_055">subversion</span></div>
<div style="position:absolute;left:306.55px;top:177.21px" class="cls_055"><span class="cls_055">apache</span></div>
<div style="position:absolute;left:200.33px;top:211.05px" class="cls_055"><span class="cls_055">mail</span></div>
<div style="position:absolute;left:235.11px;top:211.05px" class="cls_055"><span class="cls_055">perl</span></div>
<div style="position:absolute;left:267.54px;top:211.05px" class="cls_055"><span class="cls_055">expat</span></div>
<div style="position:absolute;left:302.32px;top:211.05px" class="cls_055"><span class="cls_055">openssl</span></div>
<div style="position:absolute;left:344.62px;top:211.05px" class="cls_055"><span class="cls_055">db4</span></div>
<div style="position:absolute;left:77.07px;top:246.15px" class="cls_004"><span class="cls_004">Figure 9.6.: An Apache-based composition of the Subversion and TWiki services</span></div>
<div style="position:absolute;left:59.72px;top:279.78px" class="cls_004"><span class="cls_004">now want a single Apache server that provides both the Subversion and TWiki services.</span></div>
<div style="position:absolute;left:59.72px;top:291.74px" class="cls_004"><span class="cls_004">How can we easily compose such services?</span></div>
<div style="position:absolute;left:69.68px;top:304.49px" class="cls_004"><span class="cls_004">We can solve this problem by factoring out the service-specific parts of</span><span class="cls_007"> httpd.conf</span><span class="cls_004"> into</span></div>
<div style="position:absolute;left:59.72px;top:316.44px" class="cls_004"><span class="cls_004">separate components called subservices.  That is, we create configuration components</span></div>
<div style="position:absolute;left:59.72px;top:328.40px" class="cls_004"><span class="cls_004">that contain</span><span class="cls_007"> httpd.conf</span><span class="cls_004"> fragments such as</span><span class="cls_007"> twiki.conf</span><span class="cls_004"> and</span><span class="cls_007"> subversion.conf</span><span class="cls_004">.  The top-level</span></div>
<div style="position:absolute;left:59.72px;top:340.35px" class="cls_007"><span class="cls_007">httpd.conf</span><span class="cls_004"> merely contains the global server configuration such as host names, and includes</span></div>
<div style="position:absolute;left:59.72px;top:352.31px" class="cls_004"><span class="cls_004">the service-specific fragments. A sketch of this composition is shown in Figure 9.6.</span></div>
<div style="position:absolute;left:69.68px;top:365.06px" class="cls_004"><span class="cls_004">Figure</span></div>
<div style="position:absolute;left:102.09px;top:365.06px" class="cls_004"><span class="cls_004">9.7</span></div>
<div style="position:absolute;left:120.93px;top:365.06px" class="cls_004"><span class="cls_004">shows  a  concrete  elaboration.   Here,  the  functions  imported  from</span></div>
<div style="position:absolute;left:59.72px;top:377.01px" class="cls_007"><span class="cls_007">../subversion-service</span><span class="cls_004"> and</span><span class="cls_007"> ../jira-service</span><span class="cls_004"> build the Subversion and JIRA configuration frag-</span></div>
<div style="position:absolute;left:59.72px;top:388.97px" class="cls_004"><span class="cls_004">ments and store them under a subdirectory</span><span class="cls_007"> types/apache-httpd/conf/</span><span class="cls_004"> in their prefixes. The</span></div>
<div style="position:absolute;left:59.72px;top:400.92px" class="cls_004"><span class="cls_004">function imported from</span><span class="cls_007"> ../apache-httpd</span><span class="cls_004"> then builds a top-level</span><span class="cls_007"> httpd.conf</span><span class="cls_004"> that includes</span></div>
<div style="position:absolute;left:59.72px;top:412.88px" class="cls_004"><span class="cls_004">those fragments. That is, there is a contract between the Apache service builder and the</span></div>
<div style="position:absolute;left:59.72px;top:424.83px" class="cls_004"><span class="cls_004">subservices that allows them to be composed.</span></div>
<div style="position:absolute;left:69.68px;top:437.58px" class="cls_004"><span class="cls_004">The</span><span class="cls_007"> subServices</span><span class="cls_004"> argument of the function in</span><span class="cls_007"> ../apache-httpd</span><span class="cls_004"> specifies the list of service</span></div>
<div style="position:absolute;left:59.72px;top:449.54px" class="cls_004"><span class="cls_004">components that are to be composed. By modifying this list and running</span><span class="cls_007"> upgrade-server</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:59.72px;top:461.49px" class="cls_004"><span class="cls_004">we can easily enable or disable subservices.</span></div>
<div style="position:absolute;left:59.72px;top:496.52px" class="cls_011"><span class="cls_011">9.3. Variability and crosscutting configuration choices</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">A major factor in the difficulty of deploying services is that many configuration choices are</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">crosscutting: the realisation of such choices affects multiple configuration files or multiple</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">points in the same file. For instance, the Apache server in Figure 9.7 requires a TCP port</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">number on which the server listens for requests, so we pass that information to the top-</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">level</span><span class="cls_007"> webServer</span><span class="cls_004"> component. However, the user management interface of the Subversion</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">service also needs the port number to produce URLs pointing to itself. Hence, we see that</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">226</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:159390px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background235.jpg" width=481 height=680></div>
<div style="position:absolute;left:204.68px;top:17.14px" class="cls_004"><span class="cls_004">9.3. Variability and crosscutting configuration choices</span></div>
<div style="position:absolute;left:67.26px;top:49.95px" class="cls_015"><span class="cls_015">subversionService  =  import  ../subversion-service  {</span></div>
<div style="position:absolute;left:76.67px;top:60.90px" class="cls_015"><span class="cls_015">httpPort  =  80;  #  see  Section  9.3.</span></div>
<div style="position:absolute;left:76.67px;top:71.86px" class="cls_015"><span class="cls_015">reposDir  =  "/data/subversion";  ...</span></div>
<div style="position:absolute;left:67.26px;top:82.82px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:67.26px;top:104.74px" class="cls_015"><span class="cls_015">jiraService  =  import  ../jira-service  {</span></div>
<div style="position:absolute;left:76.67px;top:115.70px" class="cls_015"><span class="cls_015">twikisDir  =  "/data/twiki";  ...</span></div>
<div style="position:absolute;left:67.26px;top:126.66px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:67.26px;top:148.58px" class="cls_015"><span class="cls_015">webServer  =  import  ../apache-httpd  {</span></div>
<div style="position:absolute;left:76.67px;top:159.53px" class="cls_015"><span class="cls_015">inherit  (pkgs)  stdenv  apacheHttpd;</span></div>
<div style="position:absolute;left:76.67px;top:170.49px" class="cls_015"><span class="cls_015">hostName  =  "svn.cs.uu.nl";</span></div>
<div style="position:absolute;left:76.67px;top:181.45px" class="cls_015"><span class="cls_015">httpPort  =  80;</span></div>
<div style="position:absolute;left:76.67px;top:192.41px" class="cls_015"><span class="cls_015">subServices  =  [subversionService  jiraService];</span></div>
<div style="position:absolute;left:67.26px;top:203.37px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:132.14px;top:220.46px" class="cls_004"><span class="cls_004">Figure 9.7.: Nix expression for the service in Figure 9.6</span></div>
<div style="position:absolute;left:63.87px;top:255.90px" class="cls_004"><span class="cls_004">the port number is specified in two different places. In fact, Apache’s configuration itself</span></div>
<div style="position:absolute;left:63.87px;top:267.86px" class="cls_004"><span class="cls_004">already needs the port in several places, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:297.14px" class="cls_015"><span class="cls_015">ServerName  example.org:8080</span></div>
<div style="position:absolute;left:88.78px;top:308.10px" class="cls_015"><span class="cls_015">Listen  8080</span></div>
<div style="position:absolute;left:88.78px;top:319.06px" class="cls_015"><span class="cls_015">&lt;VirtualHost  _default_:8080></span></div>
<div style="position:absolute;left:63.87px;top:338.82px" class="cls_004"><span class="cls_004">are some configuration statements that can occur concurrently in a typical</span><span class="cls_007"> httpd.conf</span><span class="cls_004">. This</span></div>
<div style="position:absolute;left:63.87px;top:350.78px" class="cls_004"><span class="cls_004">leads to obvious dangers: if we update one, we can easily forget to update the other.</span></div>
<div style="position:absolute;left:73.84px;top:364.43px" class="cls_004"><span class="cls_004">A related problem is that we often want to build configurations in several variants. For</span></div>
<div style="position:absolute;left:63.87px;top:376.39px" class="cls_004"><span class="cls_004">instance, we might want to build a server in test and production variants, with the former</span></div>
<div style="position:absolute;left:63.87px;top:388.34px" class="cls_004"><span class="cls_004">listening on a different port. We could make the appropriate edits to the Nix expression</span></div>
<div style="position:absolute;left:63.87px;top:400.30px" class="cls_004"><span class="cls_004">whenever we build either a test or production variant, or maintain two copies of the Nix</span></div>
<div style="position:absolute;left:63.87px;top:412.25px" class="cls_004"><span class="cls_004">expression, but both are inconvenient and unsafe.</span></div>
<div style="position:absolute;left:73.84px;top:425.91px" class="cls_004"><span class="cls_004">Using the Nix expression language we have the abstraction facilities to easily support</span></div>
<div style="position:absolute;left:63.87px;top:437.86px" class="cls_004"><span class="cls_004">possibly crosscutting variation points. Figure 9.8 shows a refinement of the Apache com-</span></div>
<div style="position:absolute;left:63.87px;top:449.82px" class="cls_004"><span class="cls_004">position in Figure 9.7. This Nix expression is now a function accepting a single boolean</span></div>
<div style="position:absolute;left:63.87px;top:461.77px" class="cls_004"><span class="cls_004">argument</span><span class="cls_007"> productionServer</span><span class="cls_004"> that determines whether the instance is a test or production</span></div>
<div style="position:absolute;left:63.87px;top:473.73px" class="cls_004"><span class="cls_004">configuration. This argument drives the value selected for the port number, which is prop-</span></div>
<div style="position:absolute;left:63.87px;top:485.68px" class="cls_004"><span class="cls_004">agated to the two components that require this information. Thus, this crosscutting param-</span></div>
<div style="position:absolute;left:63.87px;top:497.64px" class="cls_004"><span class="cls_004">eter is specified in only one place (though implemented in two). This is a major advantage</span></div>
<div style="position:absolute;left:63.87px;top:509.59px" class="cls_004"><span class="cls_004">over most configuration file formats, which typically lack variables or other means of ab-</span></div>
<div style="position:absolute;left:63.87px;top:521.55px" class="cls_004"><span class="cls_004">straction. For example, Enterprise JavaBeans deployment descriptors frequently become</span></div>
<div style="position:absolute;left:63.87px;top:533.50px" class="cls_004"><span class="cls_004">unwieldy due to crosscutting variation points impacting many descriptors.</span></div>
<div style="position:absolute;left:73.84px;top:547.16px" class="cls_004"><span class="cls_004">Of course, due to Nix’s cryptographic hashing scheme, building the server with different</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">values for</span><span class="cls_007"> productionServer</span><span class="cls_004"> (or manually editing in the Nix expression any aspect such as</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">the</span><span class="cls_007"> port</span><span class="cls_004"> attribute) yields different hashes and thus different paths.  Therefore, multiple</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">configurations automatically can exist side by side on the same machine.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">227</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:160080px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background236.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">9. Service Deployment</span></div>
<div style="position:absolute;left:63.10px;top:49.95px" class="cls_015"><span class="cls_015">{productionServer}:</span></div>
<div style="position:absolute;left:63.10px;top:71.86px" class="cls_015"><span class="cls_015">let  {</span></div>
<div style="position:absolute;left:72.52px;top:82.82px" class="cls_015"><span class="cls_015">port  =  if  productionServer  then  80  else  8080;</span></div>
<div style="position:absolute;left:72.52px;top:104.74px" class="cls_015"><span class="cls_015">webServer  =  import  ./apache-httpd  {</span></div>
<div style="position:absolute;left:81.93px;top:115.70px" class="cls_015"><span class="cls_015">inherit  (pkgs)  stdenv  apacheHttpd;</span></div>
<div style="position:absolute;left:81.93px;top:126.66px" class="cls_015"><span class="cls_015">hostName  =  "svn.cs.uu.nl";</span></div>
<div style="position:absolute;left:81.93px;top:137.62px" class="cls_015"><span class="cls_015">httpPort  =  port;</span></div>
<div style="position:absolute;left:81.93px;top:148.58px" class="cls_015"><span class="cls_015">subServices  =  [subversionService  jiraService];</span></div>
<div style="position:absolute;left:72.52px;top:159.53px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:72.52px;top:181.45px" class="cls_015"><span class="cls_015">subversionService  =  import  ./subversion  {</span></div>
<div style="position:absolute;left:81.93px;top:192.41px" class="cls_015"><span class="cls_015">httpPort  =  port;</span></div>
<div style="position:absolute;left:81.93px;top:203.37px" class="cls_015"><span class="cls_015">reposDir  =  "/data/subversion";  ...</span></div>
<div style="position:absolute;left:72.52px;top:214.33px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:72.52px;top:236.25px" class="cls_015"><span class="cls_015">jiraService  =  import  ./jira  {</span></div>
<div style="position:absolute;left:81.93px;top:247.21px" class="cls_015"><span class="cls_015">twikisDir  =  "/data/twiki";  ...</span></div>
<div style="position:absolute;left:72.52px;top:258.16px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:63.10px;top:269.12px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:119.33px;top:285.72px" class="cls_004"><span class="cls_004">Figure 9.8.: Dealing with crosscutting configuration choices</span></div>
<div style="position:absolute;left:59.72px;top:315.80px" class="cls_011"><span class="cls_011">9.4. Distributed deployment</span></div>
<div style="position:absolute;left:59.72px;top:341.95px" class="cls_004"><span class="cls_004">Complex services are often composed of several subservices running on different ma-</span></div>
<div style="position:absolute;left:59.72px;top:353.90px" class="cls_004"><span class="cls_004">chines.  For instance, consider a simple scenario of a JIRA bug tracking system.  This</span></div>
<div style="position:absolute;left:59.72px;top:365.86px" class="cls_004"><span class="cls_004">service consists of two separately running subservices, possibly on different machines: a</span></div>
<div style="position:absolute;left:59.72px;top:377.81px" class="cls_004"><span class="cls_004">Jetty servlet container, and a PostgreSQL database server. These communicate with each</span></div>
<div style="position:absolute;left:59.72px;top:389.77px" class="cls_004"><span class="cls_004">other through TCP connections.</span></div>
<div style="position:absolute;left:69.68px;top:402.22px" class="cls_004"><span class="cls_004">Such configurations are often labourious to deploy and maintain, since we now have</span></div>
<div style="position:absolute;left:59.72px;top:414.17px" class="cls_004"><span class="cls_004">two machines to administer and configure. This means that administrators have to log in</span></div>
<div style="position:absolute;left:59.72px;top:426.13px" class="cls_004"><span class="cls_004">to multiple machines, make sure that services are started and running, and so on. That is,</span></div>
<div style="position:absolute;left:59.72px;top:438.08px" class="cls_004"><span class="cls_004">without sufficient automation, the deployment effort rises linearly.</span></div>
<div style="position:absolute;left:69.68px;top:450.53px" class="cls_004"><span class="cls_004">This section shows how one can implement distributed services by writing a single Nix</span></div>
<div style="position:absolute;left:59.72px;top:462.48px" class="cls_004"><span class="cls_004">expression that describes each subservice and the machine on which it is to run. A special</span></div>
<div style="position:absolute;left:59.72px;top:474.44px" class="cls_004"><span class="cls_004">service runner component will then take care of distributing the closure of each subservice</span></div>
<div style="position:absolute;left:59.72px;top:486.40px" class="cls_004"><span class="cls_004">to the appropriate machines, and remotely running their</span><span class="cls_007"> control</span><span class="cls_004"> scripts.</span></div>
<div style="position:absolute;left:69.68px;top:498.84px" class="cls_004"><span class="cls_004">An interesting complication is that the various machines may be of different machine</span></div>
<div style="position:absolute;left:59.72px;top:510.80px" class="cls_004"><span class="cls_004">types, or may be running different operating systems.  For instance, the Jetty container</span></div>
<div style="position:absolute;left:59.72px;top:522.75px" class="cls_004"><span class="cls_004">might be running on a Linux machine, and the PostgreSQL database on a FreeBSD ma-</span></div>
<div style="position:absolute;left:59.72px;top:534.71px" class="cls_004"><span class="cls_004">chine. As we saw in Section 8.3, we can build multi-platform Nix expressions using the</span></div>
<div style="position:absolute;left:59.72px;top:546.66px" class="cls_004"><span class="cls_004">build hook mechanism.</span></div>
<div style="position:absolute;left:69.68px;top:559.11px" class="cls_004"><span class="cls_004">Figure 9.9 shows the Nix expression for the JIRA example. We have two generic ser-</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">vices, namely PostgreSQL and Jetty. There is one concrete subservice, namely the JIRA</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">web application.  This component is plugged into both generic services as a subservice,</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">228</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:160770px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background237.jpg" width=481 height=680></div>
<div style="position:absolute;left:308.18px;top:17.14px" class="cls_004"><span class="cls_004">9.4. Distributed deployment</span></div>
<div style="position:absolute;left:67.26px;top:49.20px" class="cls_015"><span class="cls_015"># Build  a  Postgres  server  on  FreeBSD.</span></div>
<div style="position:absolute;left:67.26px;top:60.16px" class="cls_015"><span class="cls_015">postgresService  =  import  ./postgresql  {</span></div>
<div style="position:absolute;left:76.67px;top:71.12px" class="cls_015"><span class="cls_015">inherit  (pkgsFreeBSD)  stdenv  postgresql;</span></div>
<div style="position:absolute;left:76.67px;top:82.08px" class="cls_015"><span class="cls_015">host  =  "losser.labs.cs.uu.nl";  #  Machine  to  run  on.</span></div>
<div style="position:absolute;left:76.67px;top:93.03px" class="cls_015"><span class="cls_015">dataDir  =  "/var/postgres/jira-data";</span></div>
<div style="position:absolute;left:76.67px;top:114.95px" class="cls_015"><span class="cls_015">subServices  =  [jiraService];</span></div>
<div style="position:absolute;left:76.67px;top:125.91px" class="cls_015"><span class="cls_015">allowedHosts  =  [jettyService.host];  #  Access  control.</span></div>
<div style="position:absolute;left:67.26px;top:136.87px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:67.26px;top:158.79px" class="cls_015"><span class="cls_015"># Build  a  Jetty  container  on  Linux.</span></div>
<div style="position:absolute;left:67.26px;top:169.75px" class="cls_015"><span class="cls_015">jettyService  =  import  ./jetty  {</span></div>
<div style="position:absolute;left:76.67px;top:180.71px" class="cls_015"><span class="cls_015">inherit  (pkgsLinux)  stdenv  jetty  j2re;</span></div>
<div style="position:absolute;left:76.67px;top:191.66px" class="cls_015"><span class="cls_015">host  =  "itchy.labs.cs.uu.nl";  #  Machine  to  run  on.</span></div>
<div style="position:absolute;left:76.67px;top:210.22px" class="cls_015"><span class="cls_015"># Include  the  JIRA  web  application  at  URI</span><span class="cls_036">  path</span><span class="cls_015">.</span></div>
<div style="position:absolute;left:76.67px;top:224.54px" class="cls_015"><span class="cls_015">subServices  =  [  {  path  =  "/jira";  war  =  jiraService;  }  ];</span></div>
<div style="position:absolute;left:67.26px;top:235.50px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:67.26px;top:257.42px" class="cls_015"><span class="cls_015"># Build  a  JIRA  service.</span></div>
<div style="position:absolute;left:67.26px;top:268.38px" class="cls_015"><span class="cls_015">jiraService  =  import  ./jira/server-pkgs/jira/jira-war.nix  {</span></div>
<div style="position:absolute;left:76.67px;top:279.34px" class="cls_015"><span class="cls_015">inherit  (pkgsLinux)  stdenv  fetchurl  ant  postgresql_jdbc;</span></div>
<div style="position:absolute;left:76.67px;top:290.29px" class="cls_015"><span class="cls_015">databaseHost  =  postgresService.host;</span></div>
<div style="position:absolute;left:255.51px;top:290.29px" class="cls_015"><span class="cls_015"># Database  to  use.</span></div>
<div style="position:absolute;left:67.26px;top:301.25px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:67.26px;top:323.17px" class="cls_015"><span class="cls_015"># Compose  the  two  services.</span></div>
<div style="position:absolute;left:67.26px;top:334.13px" class="cls_015"><span class="cls_015">serviceRunner  =  import  ./runner  {</span></div>
<div style="position:absolute;left:76.67px;top:345.09px" class="cls_015"><span class="cls_015">inherit  (pkgsLinux)  stdenv  substituter;</span></div>
<div style="position:absolute;left:76.67px;top:356.05px" class="cls_015"><span class="cls_015">services  =  [postgresService  jettyService];</span></div>
<div style="position:absolute;left:67.26px;top:367.01px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:159.84px;top:384.10px" class="cls_004"><span class="cls_004">Figure 9.9.: 2-machine distributed service</span></div>
<div style="position:absolute;left:63.87px;top:420.73px" class="cls_004"><span class="cls_004">though it provides a different interface to each (i.e., implementing different contracts). To</span></div>
<div style="position:absolute;left:63.87px;top:432.68px" class="cls_004"><span class="cls_004">PostgreSQL, it provides an initialisation script that creates the database and tables.  To</span></div>
<div style="position:absolute;left:63.87px;top:444.64px" class="cls_004"><span class="cls_004">Jetty, it provides a WAR that can be loaded at a certain URI path.</span></div>
<div style="position:absolute;left:73.84px;top:458.88px" class="cls_004"><span class="cls_004">The PostgreSQL service is built for FreeBSD; the other components are all built for</span></div>
<div style="position:absolute;left:63.87px;top:470.84px" class="cls_004"><span class="cls_004">Linux. This is accomplished by passing input packages to the builders either for FreeBSD</span></div>
<div style="position:absolute;left:63.87px;top:482.80px" class="cls_004"><span class="cls_004">or for Linux (e.g.,</span><span class="cls_007"> inherit (pkgsFreeBSD) stdenv ...</span><span class="cls_004">), which include the standard environ-</span></div>
<div style="position:absolute;left:63.87px;top:494.75px" class="cls_004"><span class="cls_004">ment and therefore specify the</span><span class="cls_007"> system</span><span class="cls_004"> on which to build.</span></div>
<div style="position:absolute;left:73.84px;top:509.00px" class="cls_004"><span class="cls_004">The two generic servers are combined into a single logical service by building a service</span></div>
<div style="position:absolute;left:63.87px;top:520.95px" class="cls_004"><span class="cls_004">runner component, which is a simple wrapper component that at build time takes a list of</span></div>
<div style="position:absolute;left:63.87px;top:532.91px" class="cls_004"><span class="cls_004">services, and generates a</span><span class="cls_007"> control</span><span class="cls_004"> script that starts or stops each in sequence. It also takes</span></div>
<div style="position:absolute;left:63.87px;top:544.86px" class="cls_004"><span class="cls_004">care of distribution by deploying the closure of each service to the machine identified by its</span></div>
<div style="position:absolute;left:63.87px;top:556.82px" class="cls_007"><span class="cls_007">host</span><span class="cls_004"> attribute, e.g.,</span><span class="cls_007"> itchy.labs.cs.uu.nl</span><span class="cls_004"> for the Jetty service. For instance, when we run the</span></div>
<div style="position:absolute;left:63.87px;top:568.77px" class="cls_004"><span class="cls_004">service runner’s</span><span class="cls_007"> start</span><span class="cls_004"> action, it copies each service and executes its</span><span class="cls_007"> start</span><span class="cls_004"> action remotely.</span></div>
<div style="position:absolute;left:73.84px;top:583.02px" class="cls_004"><span class="cls_004">An interesting point is that the Nix expression nicely deals with a crosscutting aspect of</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">229</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:161460px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background238.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">9. Service Deployment</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">the configuration: the host names of the machines on which the services are to run. These</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">are crosscutting because the services need to know each other’s host names. In order for</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">JIRA to access the database, the JIRA web application needs to know the host name of the</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">database server. Conversely, the database server must allow access to the machine running</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">the Jetty container. Here, host names are specified only once, and are propagated using</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">expressions such as</span><span class="cls_007"> allowedHosts = [jettyService.host]</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:59.72px;top:135.48px" class="cls_011"><span class="cls_011">9.5. Experience</span></div>
<div style="position:absolute;left:59.72px;top:160.69px" class="cls_004"><span class="cls_004">We have used the Nix-based approach described in this chapter to deploy a number of</span></div>
<div style="position:absolute;left:59.72px;top:172.65px" class="cls_004"><span class="cls_004">services, some in production use and some in education or development. The production</span></div>
<div style="position:absolute;left:59.72px;top:184.60px" class="cls_004"><span class="cls_004">services are:</span></div>
<div style="position:absolute;left:74.66px;top:204.47px" class="cls_004"><span class="cls_004">• An Apache-based Subversion server (</span><span class="cls_007">svn.cs.uu.nl</span><span class="cls_004">) with various extensions, such as</span></div>
<div style="position:absolute;left:84.62px;top:216.43px" class="cls_004"><span class="cls_004">a user and repository management system. This is essentially the service described</span></div>
<div style="position:absolute;left:84.62px;top:228.38px" class="cls_004"><span class="cls_004">in Section 9.2.</span></div>
<div style="position:absolute;left:74.66px;top:248.28px" class="cls_004"><span class="cls_004">• An Apache-based TWiki server (</span><A HREF="http://www.cs.uu.nl/wiki/center/">http://www.cs.uu.nl/wiki/Center</A> </span><span class="cls_004">), also using the</span></div>
<div style="position:absolute;left:84.62px;top:260.23px" class="cls_004"><span class="cls_004">composable infrastructure of Section 9.2. Thus, it is easy to create an Apache server</span></div>
<div style="position:absolute;left:84.62px;top:272.19px" class="cls_004"><span class="cls_004">providing both the Subversion and TWiki services.</span></div>
<div style="position:absolute;left:74.66px;top:292.08px" class="cls_004"><span class="cls_004">• A Jetty-based JIRA bug tracking system with a PostgreSQL database back-end, as</span></div>
<div style="position:absolute;left:84.62px;top:304.04px" class="cls_004"><span class="cls_004">described in Section 9.4.</span></div>
<div style="position:absolute;left:69.68px;top:323.91px" class="cls_004"><span class="cls_004">Also, Nix services were used in a Software Engineering course to allow teams of stu-</span></div>
<div style="position:absolute;left:59.72px;top:335.86px" class="cls_004"><span class="cls_004">dents working on the implementation of a Jetty-based web service (a Wiki) to easily build</span></div>
<div style="position:absolute;left:59.72px;top:347.82px" class="cls_004"><span class="cls_004">and run the service.</span></div>
<div style="position:absolute;left:69.68px;top:359.77px" class="cls_004"><span class="cls_004">In all these cases, we have found that the greatest advantage of Nix service deployment</span></div>
<div style="position:absolute;left:59.72px;top:371.73px" class="cls_004"><span class="cls_004">is the ease with which configurations can be reproduced: if a developer wants to create a</span></div>
<div style="position:absolute;left:59.72px;top:383.68px" class="cls_004"><span class="cls_004">running instance of a service on his own machine, it is just a matter of a checkout of the</span></div>
<div style="position:absolute;left:59.72px;top:395.64px" class="cls_004"><span class="cls_004">Nix expressions and associated files, and a call to</span><span class="cls_007"> upgrade-server</span><span class="cls_004">. Without Nix, setting up</span></div>
<div style="position:absolute;left:59.72px;top:407.59px" class="cls_004"><span class="cls_004">the required software environment for the service is much more work: installing software,</span></div>
<div style="position:absolute;left:59.72px;top:419.55px" class="cls_004"><span class="cls_004">tweaking configuration files to the local machine, creating state locations, and so on. The</span></div>
<div style="position:absolute;left:59.72px;top:431.50px" class="cls_004"><span class="cls_004">Nix services described above are essentially “plug-and-play”. Also, developer machines</span></div>
<div style="position:absolute;left:59.72px;top:443.46px" class="cls_004"><span class="cls_004">can be quite heterogeneous. For instance, since Nix closures are self-contained, there are</span></div>
<div style="position:absolute;left:59.72px;top:455.41px" class="cls_004"><span class="cls_004">no dependencies on the particulars of various Linux distributions that might be used by the</span></div>
<div style="position:absolute;left:59.72px;top:467.37px" class="cls_004"><span class="cls_004">developers.</span></div>
<div style="position:absolute;left:69.68px;top:479.32px" class="cls_004"><span class="cls_004">The ability to easily set up a test configuration is invaluable, as it makes it fairly trivial</span></div>
<div style="position:absolute;left:59.72px;top:491.28px" class="cls_004"><span class="cls_004">to experiment with new configurations.  The ability to reliably perform a rollback, even</span></div>
<div style="position:absolute;left:59.72px;top:503.23px" class="cls_004"><span class="cls_004">in the face of software upgrades, is an important safety net if testing has failed to show a</span></div>
<div style="position:absolute;left:59.72px;top:515.19px" class="cls_004"><span class="cls_004">problem with the new configuration.</span></div>
<div style="position:absolute;left:59.72px;top:545.85px" class="cls_011"><span class="cls_011">9.6. Related work</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">It is not a new insight that the deployment of software should be treated as part of software</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">configuration. In particular the SWERL group at the University of Colorado at Boulder</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">230</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:162150px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background239.jpg" width=481 height=680></div>
<div style="position:absolute;left:348.95px;top:17.14px" class="cls_004"><span class="cls_004">9.6. Related work</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">has argued for the application of software configuration management to software deploy-</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">ment [168], developed a framework for characterizing software deployment processes and</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">tools [24], and implemented the experimental system Software Dock integrating software</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">deployment processes [85, 84]. However, it appears that our work is unique in unifying the</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">deployment of software and configuration components.</span></div>
<div style="position:absolute;left:73.84px;top:104.82px" class="cls_004"><span class="cls_004">Make is sometimes used to build various configuration files.  However, Make doesn’t</span></div>
<div style="position:absolute;left:63.87px;top:116.77px" class="cls_004"><span class="cls_004">allow side-by-side deployment, as running</span><span class="cls_007"> make</span><span class="cls_004"> overwrites the previously built configu-</span></div>
<div style="position:absolute;left:63.87px;top:128.73px" class="cls_004"><span class="cls_004">rations. Thus, rollbacks are not possible. Also, the Make language is rather primitive. In</span></div>
<div style="position:absolute;left:63.87px;top:140.68px" class="cls_004"><span class="cls_004">particular, since the only abstraction mechanisms are global variables and patterns, it is</span></div>
<div style="position:absolute;left:63.87px;top:152.64px" class="cls_004"><span class="cls_004">hard to instantiate a subservice multiple times. As I discuss in Section 10.3, there are other</span></div>
<div style="position:absolute;left:63.87px;top:164.59px" class="cls_004"><span class="cls_004">build managers that have more functional specification languages.</span></div>
<div style="position:absolute;left:73.84px;top:176.55px" class="cls_004"><span class="cls_004">Cfengine is a popular system administration tool [22]. A declarative description of sets</span></div>
<div style="position:absolute;left:63.87px;top:188.50px" class="cls_004"><span class="cls_004">of machines and the functionality they should provide is given, along with imperative ac-</span></div>
<div style="position:absolute;left:63.87px;top:200.46px" class="cls_004"><span class="cls_004">tions that can realise a configuration, e.g., by rewriting configuration files in</span><span class="cls_007"> /etc</span><span class="cls_004">.  The</span></div>
<div style="position:absolute;left:63.87px;top:212.41px" class="cls_004"><span class="cls_004">principal downside of such a model is that it is destructive: it realises a configuration by</span></div>
<div style="position:absolute;left:63.87px;top:224.37px" class="cls_004"><span class="cls_004">overwriting the current one, which therefore disappears. Also, it is hard to predict what</span></div>
<div style="position:absolute;left:63.87px;top:236.32px" class="cls_004"><span class="cls_004">the result of a Cfengine run will be, since actions are typically specified as edit actions on</span></div>
<div style="position:absolute;left:63.87px;top:248.28px" class="cls_004"><span class="cls_004">system files, i.e., the initial state is not always specified. This is in contrast to the fully</span></div>
<div style="position:absolute;left:63.87px;top:260.23px" class="cls_004"><span class="cls_004">generational approach advocated here, i.e., Nix builders generate configurations fully in-</span></div>
<div style="position:absolute;left:63.87px;top:272.19px" class="cls_004"><span class="cls_004">depently from any previous configurations. Finally, since actions are specified with respect</span></div>
<div style="position:absolute;left:63.87px;top:284.14px" class="cls_004"><span class="cls_004">to fixed configuration file locations (e.g.,</span><span class="cls_007"> /etc/sendmail.mc</span><span class="cls_004">), it is not easy for multiple con-</span></div>
<div style="position:absolute;left:63.87px;top:296.10px" class="cls_004"><span class="cls_004">figurations to coexist. In the present work, fixed paths are only used for truly mutable state</span></div>
<div style="position:absolute;left:63.87px;top:308.05px" class="cls_004"><span class="cls_004">such as databases and log files.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">231</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:162840px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background240.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">9. Service Deployment</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">232</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:163530px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background241.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:89.39px" class="cls_006"><span class="cls_006">10. Build Management</span></div>
<div style="position:absolute;left:63.87px;top:132.00px" class="cls_004"><span class="cls_004">This chapter shows the final application of Nix: build management. It should be clear by</span></div>
<div style="position:absolute;left:63.87px;top:143.95px" class="cls_004"><span class="cls_004">now that the low-level Nix system is essentially a build manager: it manages the automatic</span></div>
<div style="position:absolute;left:63.87px;top:155.91px" class="cls_004"><span class="cls_004">construction of software artifacts based on a formal description of the build actions to be</span></div>
<div style="position:absolute;left:63.87px;top:167.86px" class="cls_004"><span class="cls_004">performed (a Nix expression). This is exactly what tools such as Make [56] do.</span></div>
<div style="position:absolute;left:73.84px;top:180.40px" class="cls_004"><span class="cls_004">However, the derivations that we have seen up till now have been large-grained: they</span></div>
<div style="position:absolute;left:63.87px;top:192.36px" class="cls_004"><span class="cls_004">build complete components such as Mozilla Firefox. Such component build actions typi-</span></div>
<div style="position:absolute;left:63.87px;top:204.31px" class="cls_004"><span class="cls_004">cally consist of many smaller build steps that are performed using conventional build tools</span></div>
<div style="position:absolute;left:63.87px;top:216.27px" class="cls_004"><span class="cls_004">like Make.  These are called by the builders of the derivations.  There is no reason why</span></div>
<div style="position:absolute;left:63.87px;top:228.22px" class="cls_004"><span class="cls_004">these smaller build steps (such as the compilation of a single source file, or linking object</span></div>
<div style="position:absolute;left:63.87px;top:240.18px" class="cls_004"><span class="cls_004">files together into an executable) cannot be expressed in a Nix expression directly, obviat-</span></div>
<div style="position:absolute;left:63.87px;top:252.13px" class="cls_004"><span class="cls_004">ing the need for separate build managers. Indeed, there are many advantages to using Nix</span></div>
<div style="position:absolute;left:63.87px;top:264.09px" class="cls_004"><span class="cls_004">as a build manager over conventional (Make-like) approaches. Nix expressions constitute</span></div>
<div style="position:absolute;left:63.87px;top:276.04px" class="cls_004"><span class="cls_004">a simple but powerful language to express the building of software systems, and Nix’s</span></div>
<div style="position:absolute;left:63.87px;top:288.00px" class="cls_004"><span class="cls_004">isolation properties prevent the dependency problems that plague Make-like tools.</span></div>
<div style="position:absolute;left:63.87px;top:321.89px" class="cls_011"><span class="cls_011">10.1. Low-level build management using Nix</span></div>
<div style="position:absolute;left:63.87px;top:348.21px" class="cls_004"><span class="cls_004">Figure 10.1 shows an example of a Nix expression that builds the ATerm library [166] from</span></div>
<div style="position:absolute;left:63.87px;top:360.17px" class="cls_004"><span class="cls_004">a set of C source files. The library (in this example) has a single variation point: whether it</span></div>
<div style="position:absolute;left:63.87px;top:372.12px" class="cls_004"><span class="cls_004">is build as a shared library, or as a static library. Hence it is a function that takes a boolean</span></div>
<div style="position:absolute;left:63.87px;top:384.08px" class="cls_004"><span class="cls_004">parameter</span><span class="cls_007"> sharedLib</span><span class="cls_014"> </span><span class="cls_056">151</span><span class="cls_059"> </span><span class="cls_004">. The constant</span><span class="cls_007"> sources</span><span class="cls_004"> defines the source files, which reside in</span></div>
<div style="position:absolute;left:63.87px;top:396.03px" class="cls_004"><span class="cls_004">the same directory as the Nix expression</span><span class="cls_014"> </span><span class="cls_056">153</span><span class="cls_059"> </span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:408.57px" class="cls_004"><span class="cls_004">The library is produced by the attribute</span><span class="cls_007"> libATerm</span><span class="cls_014"> </span><span class="cls_056">155</span><span class="cls_059"> </span><span class="cls_004">. The result of this attribute is a call</span></div>
<div style="position:absolute;left:63.87px;top:420.53px" class="cls_004"><span class="cls_004">to the function</span><span class="cls_007"> makeLibrary</span><span class="cls_004">, defined externally (and imported in</span><span class="cls_014"> </span><span class="cls_056">152</span><span class="cls_059"> </span><span class="cls_004">). This function takes</span></div>
<div style="position:absolute;left:63.87px;top:432.48px" class="cls_004"><span class="cls_004">a number of attributes: the name of the library, the set of object files to link, and a flag</span></div>
<div style="position:absolute;left:63.87px;top:444.44px" class="cls_004"><span class="cls_004">specifying whether to create a dynamic or static library. The object files are produced by</span></div>
<div style="position:absolute;left:63.87px;top:456.39px" class="cls_004"><span class="cls_004">compiling each source file in</span><span class="cls_007"> sources</span><span class="cls_004">:</span></div>
<div style="position:absolute;left:88.78px;top:482.33px" class="cls_015"><span class="cls_015">objects  =  map  compile  sources;</span></div>
<div style="position:absolute;left:63.87px;top:498.75px" class="cls_004"><span class="cls_004">That it, the function</span><span class="cls_007"> compile</span><span class="cls_004"> is applied to each source file. It is merely a wrapper around</span></div>
<div style="position:absolute;left:63.87px;top:510.71px" class="cls_004"><span class="cls_004">the external function</span><span class="cls_007"> compileC</span><span class="cls_004"> to specify whether the object file should support dynamic</span></div>
<div style="position:absolute;left:63.87px;top:522.66px" class="cls_004"><span class="cls_004">linking</span><span class="cls_014"> </span><span class="cls_056">154</span><span class="cls_059"> </span><span class="cls_004">. (On Unix, dynamic linking requires that source files are compiled as “position</span></div>
<div style="position:absolute;left:63.87px;top:534.62px" class="cls_004"><span class="cls_004">independent code” [160].)</span></div>
<div style="position:absolute;left:73.84px;top:547.16px" class="cls_004"><span class="cls_004">There are a few things worth noting here.  First, we did not specify any header file</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">dependencies for the source files in</span><span class="cls_007"> sources</span><span class="cls_004">, even though they include a number of system</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">and local header files (e.g.,</span><span class="cls_007"> #include "aterm1.h"</span><span class="cls_004">). However, these dependencies are found</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">automatically by</span><span class="cls_007"> compileC</span><span class="cls_004">. How it does this is discussed below.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">233</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:164220px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background242.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">10. Build Management</span></div>
<div style="position:absolute;left:63.10px;top:50.61px" class="cls_015"><span class="cls_015">{sharedLib  ?  true}:</span></div>
<div style="position:absolute;left:158.62px;top:47.34px" class="cls_056"><span class="cls_056">151</span></div>
<div style="position:absolute;left:63.10px;top:72.52px" class="cls_015"><span class="cls_015">with  (import  ../../../lib);</span></div>
<div style="position:absolute;left:196.27px;top:69.26px" class="cls_056"><span class="cls_056">152</span></div>
<div style="position:absolute;left:63.10px;top:94.44px" class="cls_015"><span class="cls_015">rec  {</span></div>
<div style="position:absolute;left:72.52px;top:116.36px" class="cls_015"><span class="cls_015">sources  =  [</span></div>
<div style="position:absolute;left:130.39px;top:113.10px" class="cls_056"><span class="cls_056">153</span></div>
<div style="position:absolute;left:81.93px;top:127.32px" class="cls_015"><span class="cls_015">./afun.c  ./aterm.c  ./bafio.c  ./byteio.c  ./gc.c  ./hash.c</span></div>
<div style="position:absolute;left:81.93px;top:138.28px" class="cls_015"><span class="cls_015">./list.c  ./make.c  ./md5c.c  ./memory.c  ./tafio.c  ./version.c</span></div>
<div style="position:absolute;left:72.52px;top:149.24px" class="cls_015"><span class="cls_015">];</span></div>
<div style="position:absolute;left:72.52px;top:171.15px" class="cls_015"><span class="cls_015">compile  =  main:  compileC  {inherit  main  sharedLib;};</span></div>
<div style="position:absolute;left:318.63px;top:167.89px" class="cls_056"><span class="cls_056">154</span></div>
<div style="position:absolute;left:72.52px;top:193.07px" class="cls_015"><span class="cls_015">libATerm  =  makeLibrary  {</span></div>
<div style="position:absolute;left:191.57px;top:189.81px" class="cls_056"><span class="cls_056">155</span></div>
<div style="position:absolute;left:81.93px;top:204.03px" class="cls_015"><span class="cls_015">libraryName  =  "ATerm";</span></div>
<div style="position:absolute;left:81.93px;top:214.99px" class="cls_015"><span class="cls_015">objects  =  map  compile  sources;</span></div>
<div style="position:absolute;left:81.93px;top:225.95px" class="cls_015"><span class="cls_015">inherit  sharedLib;</span></div>
<div style="position:absolute;left:72.52px;top:236.91px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:63.10px;top:258.83px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:120.68px;top:275.42px" class="cls_004"><span class="cls_004">Figure 10.1.: Nix expression for building the ATerm library</span></div>
<div style="position:absolute;left:69.68px;top:307.97px" class="cls_004"><span class="cls_004">Second, every build step only uses sources in the Nix store. For instance, each compile</span></div>
<div style="position:absolute;left:59.72px;top:319.93px" class="cls_004"><span class="cls_004">action (e.g.,</span><span class="cls_007"> compile ./afun.c</span><span class="cls_004">) compiles a source that resides in the Nix store; recall that the</span></div>
<div style="position:absolute;left:59.72px;top:331.88px" class="cls_004"><span class="cls_004">Nix expression translation process (Section 5.4) copies each local file referenced in a Nix</span></div>
<div style="position:absolute;left:59.72px;top:343.84px" class="cls_004"><span class="cls_004">expression to the Nix store. Header files found by</span><span class="cls_007"> compileC</span><span class="cls_004"> are also copied to the store.</span></div>
<div style="position:absolute;left:69.68px;top:356.05px" class="cls_004"><span class="cls_004">Third, since the builder for each derivation (i.e., the compile and link steps) is pure, a</span></div>
<div style="position:absolute;left:59.72px;top:368.00px" class="cls_004"><span class="cls_004">change to any input of a derivation will cause a rebuild. This includes changes to the main</span></div>
<div style="position:absolute;left:59.72px;top:379.96px" class="cls_004"><span class="cls_004">C sources, header files, C compiler flags, the C compiler and other tools, and so on.</span></div>
<div style="position:absolute;left:69.68px;top:392.17px" class="cls_004"><span class="cls_004">Figure 10.2 shows another Nix expression that imports the one in Figure 10.1 to build</span></div>
<div style="position:absolute;left:59.72px;top:404.13px" class="cls_004"><span class="cls_004">a few small programs that link against the ATerm library; these are actually from the</span><span class="cls_007"> tests</span></div>
<div style="position:absolute;left:59.72px;top:416.08px" class="cls_004"><span class="cls_004">directory of the ATerm package. The function</span><span class="cls_007"> compileTest</span><span class="cls_014"> </span><span class="cls_056">156</span><span class="cls_004"> compiles and links a single</span></div>
<div style="position:absolute;left:59.72px;top:428.04px" class="cls_004"><span class="cls_004">test program. This function is called for each test program</span><span class="cls_014"> </span><span class="cls_056">158</span><span class="cls_059"> </span><span class="cls_004">. Of course,</span><span class="cls_007"> body</span><span class="cls_004"> could also</span></div>
<div style="position:absolute;left:59.72px;top:439.99px" class="cls_004"><span class="cls_004">have been written as</span></div>
<div style="position:absolute;left:84.62px;top:464.94px" class="cls_015"><span class="cls_015">body  =  map  compileTest  [./fib.c  ./primes.c];</span></div>
<div style="position:absolute;left:59.72px;top:480.38px" class="cls_004"><span class="cls_004">Note that λ -abstraction (i.e., functions) and</span><span class="cls_007"> map</span><span class="cls_004"> take the role of pattern rules in Make.</span></div>
<div style="position:absolute;left:59.72px;top:492.34px" class="cls_004"><span class="cls_004">But contrary to Make’s pattern rules, they are not global: we can define any number of</span></div>
<div style="position:absolute;left:59.72px;top:504.29px" class="cls_004"><span class="cls_004">functions to build things in different ways in different parts of the Nix expression.</span></div>
<div style="position:absolute;left:69.68px;top:516.50px" class="cls_004"><span class="cls_004">The test programs are linked against the ATerm library built by the function in Fig-</span></div>
<div style="position:absolute;left:59.72px;top:528.46px" class="cls_004"><span class="cls_004">ure 10.1, which is called here to obtain a specific instance</span><span class="cls_014"> </span><span class="cls_056">157</span><span class="cls_059"> </span><span class="cls_004">. It is absolutely trivial to</span></div>
<div style="position:absolute;left:59.72px;top:540.41px" class="cls_004"><span class="cls_004">use multiple variants of the library in a single Nix expression. If we want two programs</span></div>
<div style="position:absolute;left:59.72px;top:552.37px" class="cls_004"><span class="cls_004">that link against the dynamic and static library, respectively, that’s easy:</span></div>
<div style="position:absolute;left:84.62px;top:577.32px" class="cls_015"><span class="cls_015">foo  =  link  {...;</span></div>
<div style="position:absolute;left:94.04px;top:588.28px" class="cls_015"><span class="cls_015">libraries  =  [(import  ../aterm  {sharedLib  =  true;}).libATerm];</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">234</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:164910px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background243.jpg" width=481 height=680></div>
<div style="position:absolute;left:239.28px;top:17.14px" class="cls_004"><span class="cls_004">10.1. Low-level build management using Nix</span></div>
<div style="position:absolute;left:67.26px;top:49.95px" class="cls_015"><span class="cls_015">with  (import  ../../../lib);</span></div>
<div style="position:absolute;left:67.26px;top:71.86px" class="cls_015"><span class="cls_015">let  {</span></div>
<div style="position:absolute;left:76.67px;top:82.82px" class="cls_015"><span class="cls_015">compileTest  =  main:  link  {</span></div>
<div style="position:absolute;left:205.14px;top:79.56px" class="cls_056"><span class="cls_056">156</span></div>
<div style="position:absolute;left:86.09px;top:93.78px" class="cls_015"><span class="cls_015">objects  =  [(compileC  {inherit  main;  localIncludePath  =  [../aterm];})];</span></div>
<div style="position:absolute;left:86.09px;top:104.74px" class="cls_015"><span class="cls_015">libraries  =  [(import  ../aterm  {sharedLib  =  true;}).libATerm];</span></div>
<div style="position:absolute;left:379.27px;top:101.48px" class="cls_056"><span class="cls_056">157</span></div>
<div style="position:absolute;left:76.67px;top:115.70px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:76.67px;top:137.62px" class="cls_015"><span class="cls_015">body  =  [</span></div>
<div style="position:absolute;left:86.09px;top:148.58px" class="cls_015"><span class="cls_015">(compileTest  ./primes.c)</span></div>
<div style="position:absolute;left:205.14px;top:145.31px" class="cls_056"><span class="cls_056">158</span></div>
<div style="position:absolute;left:86.09px;top:159.53px" class="cls_015"><span class="cls_015">(compileTest  ./fib.c)</span></div>
<div style="position:absolute;left:76.67px;top:170.49px" class="cls_015"><span class="cls_015">];</span></div>
<div style="position:absolute;left:67.26px;top:181.45px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:105.19px;top:198.04px" class="cls_004"><span class="cls_004">Figure 10.2.: Nix expression for building clients of the ATerm library</span></div>
<div style="position:absolute;left:88.78px;top:235.02px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:88.78px;top:245.98px" class="cls_015"><span class="cls_015">bar  =  link  {...;</span></div>
<div style="position:absolute;left:98.19px;top:256.94px" class="cls_015"><span class="cls_015">libraries  =  [(import  ../aterm  {sharedLib  =  false;}).libATerm];</span></div>
<div style="position:absolute;left:88.78px;top:267.90px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:63.87px;top:282.25px" class="cls_004"><span class="cls_004">Of course, the hashing scheme ensures that the two variants of the library end up in differ-</span></div>
<div style="position:absolute;left:63.87px;top:294.20px" class="cls_004"><span class="cls_004">ent paths in the store.</span></div>
<div style="position:absolute;left:63.87px;top:320.65px" class="cls_009"><span class="cls_009">Finding dependencies</span><span class="cls_004">   In general, build formalisms require that the parts that constitute</span></div>
<div style="position:absolute;left:63.87px;top:332.61px" class="cls_004"><span class="cls_004">a system are declared. That is, we have to specify the dependencies of every build action.</span></div>
<div style="position:absolute;left:63.87px;top:344.56px" class="cls_004"><span class="cls_004">In Figure 10.1 we could have specified the header files referenced by each C source file</span></div>
<div style="position:absolute;left:63.87px;top:356.52px" class="cls_004"><span class="cls_004">explicitly, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:380.38px" class="cls_015"><span class="cls_015">compileC  {</span></div>
<div style="position:absolute;left:98.19px;top:391.34px" class="cls_015"><span class="cls_015">main  =  ./afun.c</span></div>
<div style="position:absolute;left:98.19px;top:402.30px" class="cls_015"><span class="cls_015">localIncludes  =  [./aterm2.h  ./memory.h  ./util.h  ...];</span></div>
<div style="position:absolute;left:88.78px;top:413.26px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:63.87px;top:427.60px" class="cls_004"><span class="cls_004">An important advantage of Nix over build managers such as Make is that if we forget to</span></div>
<div style="position:absolute;left:63.87px;top:439.56px" class="cls_004"><span class="cls_004">specify a dependency, the build will fail since the compiler will not be able to locate the</span></div>
<div style="position:absolute;left:63.87px;top:451.52px" class="cls_004"><span class="cls_004">missing file (after all, the build takes place in a temporary directory, using only inputs in</span></div>
<div style="position:absolute;left:63.87px;top:463.47px" class="cls_004"><span class="cls_004">the store, and has no reference to the location from which the derivation was instantiated).</span></div>
<div style="position:absolute;left:63.87px;top:475.43px" class="cls_004"><span class="cls_004">Thus, if a build succeeds, we know that we have specified all the dependencies. In Make</span></div>
<div style="position:absolute;left:63.87px;top:487.38px" class="cls_004"><span class="cls_004">on the other hand, it is very common for dependency specifications to be incomplete. This</span></div>
<div style="position:absolute;left:63.87px;top:499.34px" class="cls_004"><span class="cls_004">leads to files not being rebuilt even though they should be, thus causing an inconsistency</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_004"><span class="cls_004">between sources and build results.</span></div>
<div style="position:absolute;left:73.84px;top:523.25px" class="cls_004"><span class="cls_004">But specifying all dependencies is a lot of work, so it scales badly in terms of developer</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">effort. So we wish to discover dependencies automatically. This has to be done in advance,</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">since if the dependency is not present at build time, it is too late. (Systems like Vesta [92]</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">on the other hand can discover dependencies during the build.) So we wish to “generate”</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">part of the Nix expression, e.g., the value of the</span><span class="cls_007"> localIncludes</span><span class="cls_004"> attribute in the example</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">above.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">235</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:165600px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background244.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">10. Build Management</span></div>
<div style="position:absolute;left:63.10px;top:49.95px" class="cls_015"><span class="cls_015">compileC  =  {main,  localIncludePath  ?  [],  cFlags  ?  "",</span></div>
<div style="position:absolute;left:317.24px;top:49.95px" class="cls_015"><span class="cls_015">sharedLib}:</span></div>
<div style="position:absolute;left:72.52px;top:60.90px" class="cls_015"><span class="cls_015">stdenv.mkDerivation  {</span></div>
<div style="position:absolute;left:81.93px;top:71.86px" class="cls_015"><span class="cls_015">name  =  "compile-c";</span></div>
<div style="position:absolute;left:81.93px;top:82.82px" class="cls_015"><span class="cls_015">builder  =  ./compile-c.sh;</span></div>
<div style="position:absolute;left:81.93px;top:104.74px" class="cls_015"><span class="cls_015">localIncludes  =</span></div>
<div style="position:absolute;left:158.62px;top:101.48px" class="cls_056"><span class="cls_056">159</span></div>
<div style="position:absolute;left:91.34px;top:115.70px" class="cls_015"><span class="cls_015">dependencyClosure  {</span></div>
<div style="position:absolute;left:100.75px;top:126.66px" class="cls_015"><span class="cls_015">scanner  =  file:  import  (findIncludes  file);</span></div>
<div style="position:absolute;left:100.75px;top:137.62px" class="cls_015"><span class="cls_015">searchPath  =  localIncludePath;</span></div>
<div style="position:absolute;left:100.75px;top:148.58px" class="cls_015"><span class="cls_015">startSet  =  [main];</span></div>
<div style="position:absolute;left:91.34px;top:159.53px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:81.93px;top:181.45px" class="cls_015"><span class="cls_015">cFlags  =  [  ...  ];</span></div>
<div style="position:absolute;left:81.93px;top:192.41px" class="cls_015"><span class="cls_015">inherit  main;</span></div>
<div style="position:absolute;left:72.52px;top:203.37px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:63.10px;top:225.29px" class="cls_015"><span class="cls_015">findIncludes  =  file:  stdenv.mkDerivation  {</span></div>
<div style="position:absolute;left:266.87px;top:222.02px" class="cls_056"><span class="cls_056">160</span></div>
<div style="position:absolute;left:72.52px;top:236.25px" class="cls_015"><span class="cls_015">name  =  "find-includes";</span></div>
<div style="position:absolute;left:72.52px;top:247.21px" class="cls_015"><span class="cls_015">builder  =  ./find-includes.pl;</span></div>
<div style="position:absolute;left:72.52px;top:258.16px" class="cls_015"><span class="cls_015">inherit  file;</span></div>
<div style="position:absolute;left:63.10px;top:269.12px" class="cls_015"><span class="cls_015">};</span></div>
<div style="position:absolute;left:59.72px;top:294.58px" class="cls_004"><span class="cls_004">Figure 10.3.: Nix expression for compiling C sources, with automatic header file determi-</span></div>
<div style="position:absolute;left:113.40px;top:306.54px" class="cls_004"><span class="cls_004">nation</span></div>
<div style="position:absolute;left:69.68px;top:336.44px" class="cls_004"><span class="cls_004">This is possible in the Nix expression language, since the</span><span class="cls_007"> import</span><span class="cls_004"> primitive can import</span></div>
<div style="position:absolute;left:59.72px;top:348.40px" class="cls_004"><span class="cls_004">Nix expressions from derivation outputs (page 81). That is, if we have a source file X and</span></div>
<div style="position:absolute;left:59.72px;top:360.35px" class="cls_004"><span class="cls_004">a derivation function that can compute a Nix list expression containing its dependencies,</span></div>
<div style="position:absolute;left:59.72px;top:372.31px" class="cls_004"><span class="cls_004">we can import it at translation time. The function</span><span class="cls_007"> compileC</span><span class="cls_004"> is implemented in this way,</span></div>
<div style="position:absolute;left:59.72px;top:384.26px" class="cls_004"><span class="cls_004">as shown in Figure 10.3. The set of include files</span><span class="cls_014"> </span><span class="cls_056">159</span><span class="cls_004"> is computed by the primop</span><span class="cls_007"> depen-</span></div>
<div style="position:absolute;left:59.72px;top:396.22px" class="cls_007"><span class="cls_007">dencyClosure</span><span class="cls_004">, which “grows” a set of files</span><span class="cls_007"> startSet</span><span class="cls_004"> using the dependencies discovered by</span></div>
<div style="position:absolute;left:59.72px;top:408.17px" class="cls_004"><span class="cls_004">calling the function</span><span class="cls_007"> scanner</span><span class="cls_004"> for each file. In this case,</span><span class="cls_007"> scanner</span><span class="cls_004"> is a function that returns</span></div>
<div style="position:absolute;left:59.72px;top:420.13px" class="cls_004"><span class="cls_004">the header files included by a file:</span></div>
<div style="position:absolute;left:84.62px;top:444.23px" class="cls_015"><span class="cls_015">import  (findIncludes  file)</span></div>
<div style="position:absolute;left:59.72px;top:458.82px" class="cls_004"><span class="cls_004">The function</span><span class="cls_007"> findIncludes</span><span class="cls_014"> </span><span class="cls_056">160</span><span class="cls_059"> </span><span class="cls_004"> yields a derivation that builds in its output path a Nix ex-</span></div>
<div style="position:absolute;left:59.72px;top:470.77px" class="cls_004"><span class="cls_004">pression containing the header files included by</span><span class="cls_007"> file</span><span class="cls_004">, using a builder</span><span class="cls_007"> find-includes.pl</span><span class="cls_004"> that</span></div>
<div style="position:absolute;left:59.72px;top:482.73px" class="cls_004"><span class="cls_004">scans for preprocessor include statements. E.g., if</span><span class="cls_007"> file</span><span class="cls_004"> contains</span></div>
<div style="position:absolute;left:84.62px;top:506.83px" class="cls_015"><span class="cls_015">#include  "foo/bar.h"</span></div>
<div style="position:absolute;left:84.62px;top:517.79px" class="cls_015"><span class="cls_015">#include  "../xyzzy.h"</span></div>
<div style="position:absolute;left:59.72px;top:532.38px" class="cls_004"><span class="cls_004">then the output of the derivation will be</span></div>
<div style="position:absolute;left:84.62px;top:556.48px" class="cls_015"><span class="cls_015">[ "foo/bar.h"  "../xyzzy.h"  ]</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_004"><span class="cls_004">Since these are relative paths,</span><span class="cls_007"> dependencyClosure</span><span class="cls_004"> will absolutise them relative to the path</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">of the including file. Of course, these might not be all the dependencies of</span><span class="cls_007"> file</span><span class="cls_004">, since they</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">236</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:166290px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background245.jpg" width=481 height=680></div>
<div style="position:absolute;left:239.28px;top:17.14px" class="cls_004"><span class="cls_004">10.1. Low-level build management using Nix</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">might in turn include other header files.  But</span><span class="cls_007"> dependencyClosure</span><span class="cls_004"> will apply</span><span class="cls_007"> scanner</span><span class="cls_004"> to</span></div>
<div style="position:absolute;left:63.87px;top:55.97px" class="cls_004"><span class="cls_004">those as well, thus eventually obtaining all dependencies</span><span class="cls_012"><sup>1</sup></span><span class="cls_004">. The result of</span><span class="cls_007"> dependencyClo-</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_007"><span class="cls_007">sure</span><span class="cls_004"> is a list of path references, e.g.,</span></div>
<div style="position:absolute;left:88.78px;top:92.60px" class="cls_015"><span class="cls_015">localIncludes  =  [./main.c  ./foo/bar.h  ../xyzzy.h];</span></div>
<div style="position:absolute;left:63.87px;top:106.74px" class="cls_004"><span class="cls_004">These files will be copied to the Nix store during the translation to store derivation. The</span></div>
<div style="position:absolute;left:63.87px;top:118.70px" class="cls_004"><span class="cls_004">resulting build will therefore only make use of sources in the store.</span></div>
<div style="position:absolute;left:73.84px;top:130.65px" class="cls_004"><span class="cls_004">Thus parts of Nix expressions can be generated dynamically, during the translation to</span></div>
<div style="position:absolute;left:63.87px;top:142.61px" class="cls_004"><span class="cls_004">store derivations, by leveraging the translation and build machinery. This also allows the</span></div>
<div style="position:absolute;left:63.87px;top:154.56px" class="cls_004"><span class="cls_004">Nix expression language to be “extended” in a way, since if the language does not provide</span></div>
<div style="position:absolute;left:63.87px;top:166.52px" class="cls_004"><span class="cls_004">a way to perform certain computations (e.g., string or list operations), then a derivation and</span></div>
<div style="position:absolute;left:63.87px;top:178.47px" class="cls_004"><span class="cls_004">builder can be written to implement them. Odin [28] has a similar approach to extensibility.</span></div>
<div style="position:absolute;left:73.84px;top:190.43px" class="cls_004"><span class="cls_004">A nice aspect of automatically finding dependencies in Nix is that the dependency scan-</span></div>
<div style="position:absolute;left:63.87px;top:202.38px" class="cls_004"><span class="cls_004">ner does not need to be entirely perfect. For instance, keeping the dependencies of TEX</span></div>
<div style="position:absolute;left:63.87px;top:214.34px" class="cls_004"><span class="cls_004">documents (such as those caused by</span><span class="cls_007"> \input{</span><span class="cls_004">file</span><span class="cls_007">}</span><span class="cls_004"> macros) up to date in Make is hard, since</span></div>
<div style="position:absolute;left:63.87px;top:226.29px" class="cls_004"><span class="cls_004">TEX does not provide a tool analogous to GCC’s</span><span class="cls_007"> -MM</span><span class="cls_004">operation to print out all depen-</span></div>
<div style="position:absolute;left:63.87px;top:238.25px" class="cls_004"><span class="cls_004">dencies of a file. Since TEX is a programming language, writing such a tool is quite dif-</span></div>
<div style="position:absolute;left:63.87px;top:250.20px" class="cls_004"><span class="cls_004">ficult.  However, we can also write a simple script that searches for commands such as</span></div>
<div style="position:absolute;left:63.87px;top:262.16px" class="cls_007"><span class="cls_007">\input{</span><span class="cls_004">file</span><span class="cls_007">}</span><span class="cls_004"> and a few others using regular expressions. Such a script is not guaranteed to</span></div>
<div style="position:absolute;left:63.87px;top:274.11px" class="cls_004"><span class="cls_004">find all dependencies, but that’s okay. If it does not find all dependencies, the build will</span></div>
<div style="position:absolute;left:63.87px;top:286.07px" class="cls_004"><span class="cls_004">fail deterministically, and the user can add the missing dependencies to the Nix expression</span></div>
<div style="position:absolute;left:63.87px;top:298.03px" class="cls_004"><span class="cls_004">manually.</span></div>
<div style="position:absolute;left:73.84px;top:309.98px" class="cls_004"><span class="cls_004">This thesis is in fact built using Nix. The top-level Nix expression is essentially just</span></div>
<div style="position:absolute;left:88.78px;top:333.63px" class="cls_015"><span class="cls_015">default  =  runLaTeX  {</span></div>
<div style="position:absolute;left:98.19px;top:344.59px" class="cls_015"><span class="cls_015">rootFile  =  ./doc.ltx;</span></div>
<div style="position:absolute;left:88.78px;top:355.55px" class="cls_015"><span class="cls_015">}</span></div>
<div style="position:absolute;left:63.87px;top:369.69px" class="cls_004"><span class="cls_004">where</span><span class="cls_007"> runLaTeX</span><span class="cls_004"> uses the techniques described above to guess all L</span><span class="cls_012">A</span><span class="cls_004">TEX source files and</span></div>
<div style="position:absolute;left:63.87px;top:381.65px" class="cls_004"><span class="cls_004">images included by</span><span class="cls_007"> doc.ltx</span><span class="cls_004">. (The Nix expression also builds derived artifacts such as pretty-</span></div>
<div style="position:absolute;left:63.87px;top:393.60px" class="cls_004"><span class="cls_004">printed code, Graphviz-generated [54] pictures, and so on.)</span></div>
<div style="position:absolute;left:63.87px;top:420.01px" class="cls_009"><span class="cls_009">Relative paths</span><span class="cls_004">   Often, source files expect that their dependencies are in certain relative</span></div>
<div style="position:absolute;left:63.87px;top:431.96px" class="cls_004"><span class="cls_004">paths. If we compile a C source that contains the following line:</span></div>
<div style="position:absolute;left:88.78px;top:455.62px" class="cls_015"><span class="cls_015">#include  "../foo.h"</span></div>
<div style="position:absolute;left:63.87px;top:469.75px" class="cls_004"><span class="cls_004">then we can only compile this file if the header file exists in location</span><span class="cls_007"> ../foo.h</span><span class="cls_004"> relative to</span></div>
<div style="position:absolute;left:63.87px;top:481.71px" class="cls_004"><span class="cls_004">the C source file. To compile modules in such languages, the builder must reproduce the</span></div>
<div style="position:absolute;left:63.87px;top:493.66px" class="cls_004"><span class="cls_004">relative source tree as it existed before translation to store derivations.</span></div>
<div style="position:absolute;left:73.84px;top:505.62px" class="cls_004"><span class="cls_004">For this reason,</span><span class="cls_007"> dependencyClosure</span><span class="cls_004"> actually produces a list of dependencies that also</span></div>
<div style="position:absolute;left:63.87px;top:516.55px" class="cls_004"><span class="cls_004">includes their paths relative to the start file. For the example above, it returns</span><span class="cls_012"><sup>2</sup></span></div>
<div style="position:absolute;left:68.36px;top:536.47px" class="cls_013"><span class="cls_013"><sup>1</sup></span><span class="cls_014">The closure thus obtained should not be confused with the closures in the Nix store used in the rest of this</span></div>
<div style="position:absolute;left:75.83px;top:546.84px" class="cls_014"><span class="cls_014">thesis. They are closures of source files relative to the Nix expression (e.g., in the user’s working copy), prior</span></div>
<div style="position:absolute;left:75.83px;top:556.30px" class="cls_014"><span class="cls_014">to translation to store derivations.</span></div>
<div style="position:absolute;left:68.36px;top:565.18px" class="cls_013"><span class="cls_013"><sup>2</sup></span><span class="cls_014">The encoding used here (alternating between paths and strings) is rather poorly typed—if we had a type system.</span></div>
<div style="position:absolute;left:75.83px;top:575.55px" class="cls_014"><span class="cls_014">Clearly, it would be better to use tuples (if the language had them) or attribute sets. However, there is currently</span></div>
<div style="position:absolute;left:75.83px;top:585.01px" class="cls_014"><span class="cls_014">no way to pass attribute sets to builders.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">237</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:166980px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background246.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">10. Build Management</span></div>
<div style="position:absolute;left:84.62px;top:50.30px" class="cls_015"><span class="cls_015">localIncludes  =  [</span></div>
<div style="position:absolute;left:94.04px;top:61.25px" class="cls_015"><span class="cls_015">./main.c</span></div>
<div style="position:absolute;left:150.51px;top:61.25px" class="cls_015"><span class="cls_015">"./main.c"</span></div>
<div style="position:absolute;left:94.04px;top:72.21px" class="cls_015"><span class="cls_015">./foo/bar.h  "./foo/bar.h"</span></div>
<div style="position:absolute;left:94.04px;top:83.17px" class="cls_015"><span class="cls_015">../xyzzy.h   "../xyzzy.h"</span></div>
<div style="position:absolute;left:84.62px;top:94.13px" class="cls_015"><span class="cls_015">];</span></div>
<div style="position:absolute;left:59.72px;top:108.83px" class="cls_004"><span class="cls_004">This extra information may seem redundant, but recall that path constants such as</span><span class="cls_007"> ../xyzzy.h</span></div>
<div style="position:absolute;left:59.72px;top:120.78px" class="cls_004"><span class="cls_004">are actually absolutised internally, e.g., to</span><span class="cls_007"> /home/eelco/project/xyzzy.h</span><span class="cls_004">.  And the path is</span></div>
<div style="position:absolute;left:59.72px;top:132.74px" class="cls_004"><span class="cls_004">certainly lost during translation to store derivations (see the</span><span class="cls_007"> processBinding</span><span class="cls_004"> case for path</span></div>
<div style="position:absolute;left:59.72px;top:144.69px" class="cls_004"><span class="cls_004">constants in Figure 5.7). Thus the relative paths, encoded as strings, are actually necessary</span></div>
<div style="position:absolute;left:59.72px;top:156.65px" class="cls_004"><span class="cls_004">to pass the required information to the builder.</span></div>
<div style="position:absolute;left:69.68px;top:168.61px" class="cls_004"><span class="cls_004">The builder of</span><span class="cls_007"> compilerC</span><span class="cls_004">,</span><span class="cls_007"> compile-c.sh</span><span class="cls_004">, will use this information to create in its tempo-</span></div>
<div style="position:absolute;left:59.72px;top:180.57px" class="cls_004"><span class="cls_004">rary build directory a hierarchy of symlinks such as</span></div>
<div style="position:absolute;left:84.62px;top:204.78px" class="cls_015"><span class="cls_015">./xyzzy.h</span></div>
<div style="position:absolute;left:84.62px;top:215.74px" class="cls_015"><span class="cls_015">./dotdot/main.c</span></div>
<div style="position:absolute;left:84.62px;top:226.69px" class="cls_015"><span class="cls_015">./dotdot/foo/bar.h</span></div>
<div style="position:absolute;left:59.72px;top:241.39px" class="cls_004"><span class="cls_004">to the actual sources in the Nix store. (A number of</span><span class="cls_007"> dotdot</span><span class="cls_004"> directories equal to the max-</span></div>
<div style="position:absolute;left:59.72px;top:253.34px" class="cls_004"><span class="cls_004">imum number of</span><span class="cls_007"> ..</span><span class="cls_004"> references in relative paths is inserted to make those relative paths</span></div>
<div style="position:absolute;left:59.72px;top:265.30px" class="cls_004"><span class="cls_004">resolve properly.) Compiling</span><span class="cls_007"> ./dotdot/main.c</span><span class="cls_004"> will then yield the desired result.</span></div>
<div style="position:absolute;left:59.72px;top:291.87px" class="cls_009"><span class="cls_009">Building</span><span class="cls_004">   So how do we actually build the derivations defined in, e.g., Figure 10.2? A</span></div>
<div style="position:absolute;left:59.72px;top:303.83px" class="cls_004"><span class="cls_004">tool such as</span><span class="cls_007"> nix-env</span><span class="cls_004"> is inappropriate, since we do not necessarily want to “install” the build</span></div>
<div style="position:absolute;left:59.72px;top:315.78px" class="cls_004"><span class="cls_004">result.  Hence there is a small tool</span><span class="cls_007"> nix-build</span><span class="cls_004"> (briefly mentioned in Section 5.6.1), which</span></div>
<div style="position:absolute;left:59.72px;top:327.74px" class="cls_004"><span class="cls_004">is just a wrapper around</span><span class="cls_007"> nix-instantiate</span><span class="cls_004"> and</span><span class="cls_007"> nix-store --realise</span><span class="cls_004"> that builds a Nix expression</span></div>
<div style="position:absolute;left:59.72px;top:339.69px" class="cls_004"><span class="cls_004">and places a symlink to the derivation output (named</span><span class="cls_007"> result</span><span class="cls_004">) in the current directory. If the</span></div>
<div style="position:absolute;left:59.72px;top:351.65px" class="cls_004"><span class="cls_004">top-level Nix expression yields multiple derivations, the links are numbered. By default,</span></div>
<div style="position:absolute;left:59.72px;top:363.60px" class="cls_007"><span class="cls_007">nix-build</span><span class="cls_004"> builds the expression</span><span class="cls_007"> default.nix</span><span class="cls_004"> in the current directory. E.g., when applied to the</span></div>
<div style="position:absolute;left:59.72px;top:375.56px" class="cls_004"><span class="cls_004">expression in Figure 10.2, we get</span></div>
<div style="position:absolute;left:84.62px;top:399.77px" class="cls_015"><span class="cls_015">$ nix-build</span></div>
<div style="position:absolute;left:84.62px;top:421.69px" class="cls_015"><span class="cls_015">$ ./result-2/program</span></div>
<div style="position:absolute;left:84.62px;top:432.65px" class="cls_015"><span class="cls_015">fib(32)  ==  3524578</span></div>
<div style="position:absolute;left:59.72px;top:447.34px" class="cls_004"><span class="cls_004">since the symlink</span><span class="cls_007"> result-2</span><span class="cls_004"> refers to the second derivation (the</span><span class="cls_007"> fib.c</span><span class="cls_004"> program, which com-</span></div>
<div style="position:absolute;left:59.72px;top:459.30px" class="cls_004"><span class="cls_004">putes the Fibonacci sequence).</span></div>
<div style="position:absolute;left:59.72px;top:490.02px" class="cls_011"><span class="cls_011">10.2. Discussion</span></div>
<div style="position:absolute;left:59.72px;top:515.25px" class="cls_004"><span class="cls_004">Low-level build management using Nix has numerous advantages over most build man-</span></div>
<div style="position:absolute;left:59.72px;top:527.21px" class="cls_004"><span class="cls_004">agers (discussed below). Of course, most of these are exactly the advantages that it also</span></div>
<div style="position:absolute;left:59.72px;top:539.16px" class="cls_004"><span class="cls_004">has for deployment, showing that build management and deployment are very much over-</span></div>
<div style="position:absolute;left:59.72px;top:551.12px" class="cls_004"><span class="cls_004">lapping problems.</span></div>
<div style="position:absolute;left:74.66px;top:571.07px" class="cls_004"><span class="cls_004">• It ensures that dependency specifications are complete (though most dependencies</span></div>
<div style="position:absolute;left:84.62px;top:583.02px" class="cls_004"><span class="cls_004">can be found automatically).</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">238</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:167670px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background247.jpg" width=481 height=680></div>
<div style="position:absolute;left:353.54px;top:17.14px" class="cls_004"><span class="cls_004">10.2. Discussion</span></div>
<div style="position:absolute;left:78.82px;top:45.04px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:45.04px" class="cls_004"><span class="cls_004">All inputs, not just source files but also flags, scripts, tools, etc., are dependencies.</span></div>
<div style="position:absolute;left:88.78px;top:56.99px" class="cls_004"><span class="cls_004">Running</span><span class="cls_007"> nix-build</span><span class="cls_004"> is guaranteed to produce a result consistent with the sources and</span></div>
<div style="position:absolute;left:88.78px;top:68.95px" class="cls_004"><span class="cls_004">the Nix expression. In Make, by contrast, changes to the build actions do not trigger</span></div>
<div style="position:absolute;left:88.78px;top:80.90px" class="cls_004"><span class="cls_004">recompilation. This is why Make users have a habit of running</span><span class="cls_007"> make clean</span><span class="cls_004"> often,</span></div>
<div style="position:absolute;left:88.78px;top:92.86px" class="cls_004"><span class="cls_004">just to be on the safe side.</span></div>
<div style="position:absolute;left:78.82px;top:113.81px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:113.81px" class="cls_004"><span class="cls_004">Since dependencies are complete and builds produce no output other than in</span><span class="cls_007"> out</span><span class="cls_004">,</span></div>
<div style="position:absolute;left:88.78px;top:125.77px" class="cls_004"><span class="cls_004">parallel and distributed builds are safe.</span></div>
<div style="position:absolute;left:78.82px;top:146.72px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:146.72px" class="cls_004"><span class="cls_004">There is no pollution of the working copy in which the source resides. Thus there is</span></div>
<div style="position:absolute;left:88.78px;top:158.68px" class="cls_004"><span class="cls_004">no need for an operation like</span><span class="cls_007"> make clean</span><span class="cls_004">. Garbage collection takes care of freeing</span></div>
<div style="position:absolute;left:88.78px;top:170.63px" class="cls_004"><span class="cls_004">disk space.</span></div>
<div style="position:absolute;left:78.82px;top:191.59px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:191.59px" class="cls_004"><span class="cls_004">Due to locking (page 98), it is safe to run multiple Nix builds in parallel, even on the</span></div>
<div style="position:absolute;left:88.78px;top:203.54px" class="cls_004"><span class="cls_004">same Nix expression.</span></div>
<div style="position:absolute;left:78.82px;top:224.50px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:224.50px" class="cls_004"><span class="cls_004">It is safe to edit sources while a build is in progress. In contrast, with Make we can</span></div>
<div style="position:absolute;left:88.78px;top:236.45px" class="cls_004"><span class="cls_004">run into race conditions, e.g., if we start a big L</span><span class="cls_012">A</span><span class="cls_004">TEX job or C++ compile, then edit</span></div>
<div style="position:absolute;left:88.78px;top:248.41px" class="cls_004"><span class="cls_004">the source in Emacs and save while the build is in progress. The build will use the</span></div>
<div style="position:absolute;left:88.78px;top:260.36px" class="cls_004"><span class="cls_004">old sources, but subsequent Make invocations will believe that the output is up to</span></div>
<div style="position:absolute;left:88.78px;top:272.32px" class="cls_004"><span class="cls_004">date.</span></div>
<div style="position:absolute;left:78.82px;top:293.27px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:293.27px" class="cls_004"><span class="cls_004">The Nix expression language makes it very easy to specify variants.  Since it is</span></div>
<div style="position:absolute;left:88.78px;top:305.23px" class="cls_004"><span class="cls_004">a functional language, almost any repetitiveness can be abstracted away.  So the</span></div>
<div style="position:absolute;left:88.78px;top:317.18px" class="cls_004"><span class="cls_004">functionality provided by tools such as Automake and Libtool can be implemented</span></div>
<div style="position:absolute;left:88.78px;top:329.14px" class="cls_004"><span class="cls_004">through Nix expression libraries.</span></div>
<div style="position:absolute;left:78.82px;top:350.09px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:350.09px" class="cls_004"><span class="cls_004">If a build succeeds, we know all the source dependencies in the working copy, so we</span></div>
<div style="position:absolute;left:88.78px;top:362.04px" class="cls_004"><span class="cls_004">know which files at the least must be placed under version management.</span></div>
<div style="position:absolute;left:78.82px;top:383.00px" class="cls_004"><span class="cls_004">•</span></div>
<div style="position:absolute;left:88.78px;top:383.00px" class="cls_004"><span class="cls_004">As mentioned, the automatic determination of header file dependencies is also safer</span></div>
<div style="position:absolute;left:88.78px;top:394.95px" class="cls_004"><span class="cls_004">than what we can get in Make derivates. It is common to use tricks like</span><span class="cls_007"> gcc -MM</span></div>
<div style="position:absolute;left:88.78px;top:406.91px" class="cls_004"><span class="cls_004">to find header file dependencies automatically in Makefile rules, but this has subtle</span></div>
<div style="position:absolute;left:88.78px;top:418.86px" class="cls_004"><span class="cls_004">failure conditions. For instance,</span><span class="cls_007"> gcc -MM</span><span class="cls_004"> causes the found header files to be declared</span></div>
<div style="position:absolute;left:88.78px;top:430.82px" class="cls_004"><span class="cls_004">as dependencies, but it neglects to add the files that were not found. If the C compiler</span></div>
<div style="position:absolute;left:88.78px;top:442.77px" class="cls_004"><span class="cls_004">search path contains directories A and B, and a header X is found in B/X , then the</span></div>
<div style="position:absolute;left:88.78px;top:454.73px" class="cls_004"><span class="cls_004">non-existent file A/X should also be a dependency.  After all, if A/X were to be</span></div>
<div style="position:absolute;left:88.78px;top:466.68px" class="cls_004"><span class="cls_004">added by the user, a rebuild would be necessary. Since we recompute the closure</span></div>
<div style="position:absolute;left:88.78px;top:478.64px" class="cls_004"><span class="cls_004">of the dependencies on every invocation, the new file A/X will be found and will</span></div>
<div style="position:absolute;left:88.78px;top:490.59px" class="cls_004"><span class="cls_004">trigger a rebuild.</span></div>
<div style="position:absolute;left:73.84px;top:511.29px" class="cls_004"><span class="cls_004">However, there is an unresolved problem with Nix as a build manager: how can we use it</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">recursively, that is, from within a Nix builder? It is quite common for a Nix builder to call</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">conventional build tools such as Make. That is what almost all components in Chapter 7</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">do. But can we call</span><span class="cls_007"> nix-build</span><span class="cls_004"> in a builder? The problem is that the Nix store is global, and</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_007"><span class="cls_007">nix-build</span><span class="cls_004"> would compute and create all sorts of paths that are not known inputs or outputs</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">of the current Nix build. A solution might be for the recursive Nix invocations to use a</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">private store (e.g., a subdirectory of the builder’s temporary directory).</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">239</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:168360px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background248.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">10. Build Management</span></div>
<div style="position:absolute;left:69.68px;top:45.04px" class="cls_004"><span class="cls_004">Instead of recursive Nix builds, the alternative is to have one gigantic build graph. For</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">instance, if we are building a component that needs a C compiler, the Nix expression for</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">that component simply imports the Nix expression that builds the compiler. The problem</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">with this approach is scalability: the resulting build graphs would become huge. The graph</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">for a simple component such as GNU Hello would include the build graphs for dozens of</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">large components, such as Glibc, GCC, etc. The resulting graph could easily have hundreds</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">of thousands of nodes, far exceeding the graphs typically occurring in deployment (e.g., the</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">one in Figure 1.5). However, apart from its efficiency, this is possibly the most desirable</span></div>
<div style="position:absolute;left:59.72px;top:140.68px" class="cls_004"><span class="cls_004">solution because of its conceptual simplicity.  Thus it is interesting to develop efficient</span></div>
<div style="position:absolute;left:59.72px;top:152.64px" class="cls_004"><span class="cls_004">ways of dealing with very large build graphs.</span></div>
<div style="position:absolute;left:59.72px;top:182.81px" class="cls_011"><span class="cls_011">10.3. Related work</span></div>
<div style="position:absolute;left:59.72px;top:208.03px" class="cls_004"><span class="cls_004">The archetypical build manager is Make [56], introduced in Seventh Edition Unix (1979).</span></div>
<div style="position:absolute;left:59.72px;top:219.98px" class="cls_004"><span class="cls_004">According to Stuart Feldman’s 2003 ACM Software System Award citation, “there is prob-</span></div>
<div style="position:absolute;left:59.72px;top:231.94px" class="cls_004"><span class="cls_004">ably no large software system in the world today that has not been processed by a version</span></div>
<div style="position:absolute;left:59.72px;top:243.89px" class="cls_004"><span class="cls_004">or offspring of MAKE.” It builds systems from a Makefile that describes a dependency</span></div>
<div style="position:absolute;left:59.72px;top:255.85px" class="cls_004"><span class="cls_004">graph using rules of the form</span></div>
<div style="position:absolute;left:85.73px;top:274.56px" class="cls_004"><span class="cls_004">targets : dependencies</span></div>
<div style="position:absolute;left:120.36px;top:289.50px" class="cls_004"><span class="cls_004">actions</span></div>
<div style="position:absolute;left:59.72px;top:308.03px" class="cls_004"><span class="cls_004">with the semantics that if the files targets do not exist or are older than the files</span></div>
<div style="position:absolute;left:59.72px;top:319.99px" class="cls_004"><span class="cls_004">dependencies, then the shell commands listed in actions should be run to (re-)build targets.</span></div>
<div style="position:absolute;left:59.72px;top:331.94px" class="cls_004"><span class="cls_004">Makefiles have some abstraction facilities to reduce repetitive rules, such as pattern rules</span></div>
<div style="position:absolute;left:59.72px;top:343.90px" class="cls_004"><span class="cls_004">(generic rules that are applied automatically on the basis of file extensions) and variables.</span></div>
<div style="position:absolute;left:69.68px;top:355.85px" class="cls_004"><span class="cls_004">Make has spawned dozens of derivates.  Some are backwards-compatible extensions,</span></div>
<div style="position:absolute;left:59.72px;top:367.81px" class="cls_004"><span class="cls_004">such as BSD Make and GNU Make [68]. Others are not, e.g., Plan 9’s</span><span class="cls_007"> mk</span><span class="cls_004"> [96], AT&T</span></div>
<div style="position:absolute;left:59.72px;top:379.76px" class="cls_004"><span class="cls_004">and Lucent’s NMake [70], Microsoft’s NMake, Jam [148], and so on. Some of these add</span></div>
<div style="position:absolute;left:59.72px;top:391.72px" class="cls_004"><span class="cls_004">support for parallel builds [7], have syntactic sugar to allow more concise Makefiles, or</span></div>
<div style="position:absolute;left:59.72px;top:403.67px" class="cls_004"><span class="cls_004">have built-in support for languages such as C and C++ (e.g., to find dependencies). There</span></div>
<div style="position:absolute;left:59.72px;top:415.63px" class="cls_004"><span class="cls_004">are also tools that generate Makefiles from higher-level specifications, e.g., Automake [65,</span></div>
<div style="position:absolute;left:59.72px;top:427.58px" class="cls_004"><span class="cls_004">172]. The generators unfortunately do not shield the user from the lower layers; it is the</span></div>
<div style="position:absolute;left:59.72px;top:439.54px" class="cls_004"><span class="cls_004">user’s job to map problems that occur in a Makefile back to the high-level specification</span></div>
<div style="position:absolute;left:59.72px;top:451.49px" class="cls_004"><span class="cls_004">from which it was generated.</span></div>
<div style="position:absolute;left:69.68px;top:463.45px" class="cls_004"><span class="cls_004">Ant [63] is a very popular build manager, but its popularity stems mainly from the fact</span></div>
<div style="position:absolute;left:59.72px;top:475.40px" class="cls_004"><span class="cls_004">that it comes with a large set of useful tasks for Java development, contrary to Make.</span></div>
<div style="position:absolute;left:59.72px;top:487.36px" class="cls_004"><span class="cls_004">(Make’s built-in rules essentially reflect the Unix programming language landscape of</span></div>
<div style="position:absolute;left:59.72px;top:498.29px" class="cls_004"><span class="cls_004">1979.) However, Ant in many ways is a step backwards compared to Make</span><span class="cls_012"><sup>3</sup></span><span class="cls_004">. The (XML-</span></div>
<div style="position:absolute;left:59.72px;top:511.27px" class="cls_004"><span class="cls_004">based) build formalism is actually quite crude, and describes a simple partial ordering of</span></div>
<div style="position:absolute;left:59.72px;top:523.22px" class="cls_004"><span class="cls_004">build tasks. Ant’s core provides no incremental build facilities; these must be implemented</span></div>
<div style="position:absolute;left:59.72px;top:535.18px" class="cls_004"><span class="cls_004">by tasks themselves. Ant however shows that it is important for a build tool to have good</span></div>
<div style="position:absolute;left:59.72px;top:547.13px" class="cls_004"><span class="cls_004">libraries for building common languages.</span></div>
<div style="position:absolute;left:64.20px;top:565.18px" class="cls_013"><span class="cls_013"><sup>3</sup></span><span class="cls_014">Ant’s homepage [63] lists two reasons for its development: Make uses non-portable shell commands, and</span></div>
<div style="position:absolute;left:71.67px;top:575.55px" class="cls_014"><span class="cls_014">Makefiles use TAB characters. This indicates that Ant’s development was not inspired by any fundamental</span></div>
<div style="position:absolute;left:71.67px;top:585.01px" class="cls_014"><span class="cls_014">reflection on Make’s limitations.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">240</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:169050px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background249.jpg" width=481 height=680></div>
<div style="position:absolute;left:343.97px;top:17.14px" class="cls_004"><span class="cls_004">10.3. Related work</span></div>
<div style="position:absolute;left:73.84px;top:45.04px" class="cls_004"><span class="cls_004">An interesting performance improvement is provided by optimistic Make [21], which</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">starts building targets before the user has issued the</span><span class="cls_007"> make</span><span class="cls_004"> command, putting unused CPU</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">cycles to good use.  A median reduction in response time as high as a factor of 5.1 is</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">reported.</span></div>
<div style="position:absolute;left:73.84px;top:93.08px" class="cls_004"><span class="cls_004">However, none of these tools solve Make’s fundamental problems, which are:</span></div>
<div style="position:absolute;left:78.82px;top:113.67px" class="cls_004"><span class="cls_004">• A lack of abstraction facilities. The abstraction mechanisms—variables and pattern</span></div>
<div style="position:absolute;left:88.78px;top:125.63px" class="cls_004"><span class="cls_004">rules—are all global. Hence, if we need to specify different ways of building tar-</span></div>
<div style="position:absolute;left:88.78px;top:137.58px" class="cls_004"><span class="cls_004">gets, we cannot use them, unless we split the system into multiple Makefiles. This,</span></div>
<div style="position:absolute;left:88.78px;top:149.54px" class="cls_004"><span class="cls_004">however, creates the much greater problem of incomplete dependency graphs [121].</span></div>
<div style="position:absolute;left:88.78px;top:161.49px" class="cls_004"><span class="cls_004">[71] shows some of the rather clumsy techniques used for stretching Make’s expres-</span></div>
<div style="position:absolute;left:88.78px;top:173.45px" class="cls_004"><span class="cls_004">siveness.</span></div>
<div style="position:absolute;left:78.82px;top:194.26px" class="cls_004"><span class="cls_004">• A lack of support for variant builds. Makefile variables allow variability to be ex-</span></div>
<div style="position:absolute;left:88.78px;top:206.21px" class="cls_004"><span class="cls_004">pressed, but variants will overwrite each other unless tortuous hacks are used to</span></div>
<div style="position:absolute;left:88.78px;top:218.17px" class="cls_004"><span class="cls_004">arrange otherwise.</span></div>
<div style="position:absolute;left:78.82px;top:238.98px" class="cls_004"><span class="cls_004">• The inability to ensure complete dependency specifications. If builds are not per-</span></div>
<div style="position:absolute;left:88.78px;top:250.93px" class="cls_004"><span class="cls_004">formed in isolation but rather in the workspace that holds all the sources, there is no</span></div>
<div style="position:absolute;left:88.78px;top:262.89px" class="cls_004"><span class="cls_004">way to prevent undeclared dependencies (unless file system calls are intercepted, as</span></div>
<div style="position:absolute;left:88.78px;top:274.84px" class="cls_004"><span class="cls_004">discussed below).</span></div>
<div style="position:absolute;left:73.84px;top:295.43px" class="cls_004"><span class="cls_004">However, there are a number of build managers that do fundamentally improve on Make.</span></div>
<div style="position:absolute;left:63.87px;top:307.39px" class="cls_004"><span class="cls_004">Odin [28, 29] has a functional language to describe build actions (queries). (Indeed, a reim-</span></div>
<div style="position:absolute;left:63.87px;top:319.34px" class="cls_004"><span class="cls_004">plementation of Odin’s semantics as an embedded domain-specific language in Haskell is</span></div>
<div style="position:absolute;left:63.87px;top:331.30px" class="cls_004"><span class="cls_004">presented in [150].)  For example, the expression</span><span class="cls_007"> hello.c</span><span class="cls_004"> denotes a source, while</span><span class="cls_007"> hello.c</span></div>
<div style="position:absolute;left:63.87px;top:343.25px" class="cls_007"><span class="cls_007">:exe</span><span class="cls_004"> denotes the executable obtained by compiling and linking</span><span class="cls_007"> hello.c</span><span class="cls_004">. Odin also supports</span></div>
<div style="position:absolute;left:63.87px;top:355.21px" class="cls_004"><span class="cls_004">variants automatically. Variant builds can be expressed easily, e.g.,</span><span class="cls_007"> hello.c +debug :exe</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:73.84px;top:367.39px" class="cls_004"><span class="cls_004">Vesta (already discussed in Section 7.6) has a build manager, the Vesta evaluator, that</span></div>
<div style="position:absolute;left:63.87px;top:379.34px" class="cls_004"><span class="cls_004">builds software from specifications written in the System Description Language (SDL),</span></div>
<div style="position:absolute;left:63.87px;top:391.30px" class="cls_004"><span class="cls_004">which is a functional language [94]. Since Vesta uses a virtual (NFS-based) file system, it</span></div>
<div style="position:absolute;left:63.87px;top:403.25px" class="cls_004"><span class="cls_004">can detect all dependencies used by a build action. The results of builds are cached and can</span></div>
<div style="position:absolute;left:63.87px;top:415.21px" class="cls_004"><span class="cls_004">be shared between users. Since the language is functional, it is easy to specify and build</span></div>
<div style="position:absolute;left:63.87px;top:427.16px" class="cls_004"><span class="cls_004">variants. Thus Vesta solves all three of the Make limitations listed above. The price is the</span></div>
<div style="position:absolute;left:63.87px;top:439.12px" class="cls_004"><span class="cls_004">use of a virtual file system and the integration with a specific version management system.</span></div>
<div style="position:absolute;left:73.84px;top:451.29px" class="cls_004"><span class="cls_004">Amake [9, 8, 164] is the build tool for the Amoeba distributed operating system. Like</span></div>
<div style="position:absolute;left:63.87px;top:463.25px" class="cls_004"><span class="cls_004">Odin, it separates the specification of build tools and system specifications. Given a set</span></div>
<div style="position:absolute;left:63.87px;top:475.20px" class="cls_004"><span class="cls_004">of sources Amake automatically completes the build graph, that is, it finds instances of</span></div>
<div style="position:absolute;left:63.87px;top:487.16px" class="cls_004"><span class="cls_004">tool definitions that build the desired targets from the given sources. This is contrary to</span></div>
<div style="position:absolute;left:63.87px;top:499.11px" class="cls_004"><span class="cls_004">the functional model of explicit tool application in Odin, Vesta, and Nix.  The obvious</span></div>
<div style="position:absolute;left:63.87px;top:511.07px" class="cls_004"><span class="cls_004">advantage is that specifications become shorter; the downside is that it becomes harder to</span></div>
<div style="position:absolute;left:63.87px;top:523.02px" class="cls_004"><span class="cls_004">specify alternative ways of building, and to see what’s going on.</span></div>
<div style="position:absolute;left:73.84px;top:535.20px" class="cls_004"><span class="cls_004">Maak [46], by the author of this thesis, was in many ways a precursor to Nix. It has a</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">functional language similar to the Nix expression language, and supported build variability</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">automatically; in fact, the language has some features that the Nix expression language</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_004"><span class="cls_004">does not, such as automatic propagation of attributes. The Nix language backs away from</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">this level of expressivity since a) the Nix language is intended foremost for deployment</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">241</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:169740px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background250.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">10. Build Management</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">instead of build management, and so involves less complicated build descriptions; and b)</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">concise syntax is not always a blessing; it may make the language harder to understand.</span></div>
<div style="position:absolute;left:69.68px;top:68.95px" class="cls_004"><span class="cls_004">Also, Maak allows circular dependencies, a classical “hard” problem for build man-</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">agers. A notable example is L</span><span class="cls_012">A</span><span class="cls_004">TEX, which requires any number of runs until certain out-</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">puts stop changing. Circular dependencies are fundamentally incompatible with Nix, since</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">store derivations describe a static set of build actions from which all variability has been</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">removed (and in the extensional model, the output paths must be known in advance). I now</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">feel that circular dependencies are an unnecessary complication for build managers: they</span></div>
<div style="position:absolute;left:59.72px;top:140.68px" class="cls_004"><span class="cls_004">occur quite seldom—in fact, L</span><span class="cls_012">A</span><span class="cls_004">TEX is the only common example—and so are better fixed</span></div>
<div style="position:absolute;left:59.72px;top:152.64px" class="cls_004"><span class="cls_004">by wrapping the offending tool in a script that executes it an appropriate number of times.</span></div>
<div style="position:absolute;left:69.68px;top:164.59px" class="cls_004"><span class="cls_004">The Maak paper [46] also introduced the notion of transparent source/binary deploy-</span></div>
<div style="position:absolute;left:59.72px;top:176.55px" class="cls_004"><span class="cls_004">ment, but in the absence of a cryptographic hashing scheme, it used nominal version</span></div>
<div style="position:absolute;left:59.72px;top:188.50px" class="cls_004"><span class="cls_004">equality, which is of course less safe. But Maak’s fundamental problem was that it could</span></div>
<div style="position:absolute;left:59.72px;top:200.46px" class="cls_004"><span class="cls_004">not ensure complete dependency specifications, since (like Make) it performed builds “lo-</span></div>
<div style="position:absolute;left:59.72px;top:212.41px" class="cls_004"><span class="cls_004">cally”, in the workspace holding the sources. (On Linux, it did have a feature to use the</span></div>
<div style="position:absolute;left:59.72px;top:224.37px" class="cls_007"><span class="cls_007">strace</span><span class="cls_004"> command to intercept file system accesses, allowing dependency detection.) This</span></div>
<div style="position:absolute;left:59.72px;top:236.32px" class="cls_004"><span class="cls_004">prompted the development of a component store based on cryptographic hashing.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">242</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:170430px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background251.jpg" width=481 height=680></div>
<div style="position:absolute;left:212.19px;top:211.75px" class="cls_006"><span class="cls_006">Part IV.</span></div>
<div style="position:absolute;left:182.51px;top:257.85px" class="cls_010"><span class="cls_010">Conclusion</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">243</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:171120px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background252.jpg" width=481 height=680></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:171120px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background253.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:88.81px" class="cls_006"><span class="cls_006">11. Conclusion</span></div>
<div style="position:absolute;left:63.87px;top:129.73px" class="cls_004"><span class="cls_004">The main objective of the research described in this thesis was to develop a system for</span></div>
<div style="position:absolute;left:63.87px;top:141.69px" class="cls_004"><span class="cls_004">correct software deployment that ensures that the deployment is complete and does not</span></div>
<div style="position:absolute;left:63.87px;top:153.64px" class="cls_004"><span class="cls_004">cause interference. This objective was successfully met in the Nix deployment system, as</span></div>
<div style="position:absolute;left:63.87px;top:165.60px" class="cls_004"><span class="cls_004">the experience with Nixpkgs described in Section 7.1.5 has shown.</span></div>
<div style="position:absolute;left:73.84px;top:177.55px" class="cls_004"><span class="cls_004">The objective of improving deployment correctness is reached through the two main</span></div>
<div style="position:absolute;left:63.87px;top:189.51px" class="cls_004"><span class="cls_004">ideas described in this thesis.  The first is the use of cryptographic hashes in Nix store</span></div>
<div style="position:absolute;left:63.87px;top:201.46px" class="cls_004"><span class="cls_004">paths. It gives us isolation, automatic support for variability, and the ability to determine</span></div>
<div style="position:absolute;left:63.87px;top:213.42px" class="cls_004"><span class="cls_004">runtime dependencies.  This however can be considered an (important) implementation</span></div>
<div style="position:absolute;left:63.87px;top:225.37px" class="cls_004"><span class="cls_004">detail—maybe even a “trick”. However, it addresses the deployment problem at the most</span></div>
<div style="position:absolute;left:63.87px;top:237.33px" class="cls_004"><span class="cls_004">fundamental level: the storage of components in the file system.</span></div>
<div style="position:absolute;left:73.84px;top:249.28px" class="cls_004"><span class="cls_004">The second and more fundamental idea is the purely functional deployment model,</span></div>
<div style="position:absolute;left:63.87px;top:261.24px" class="cls_004"><span class="cls_004">which means that components never change after they have been built and that their build</span></div>
<div style="position:absolute;left:63.87px;top:273.19px" class="cls_004"><span class="cls_004">processes only depend on their declared inputs. In conjunction with the hashing scheme,</span></div>
<div style="position:absolute;left:63.87px;top:285.15px" class="cls_004"><span class="cls_004">the purely functional model prevents interference between deployment actions, provides</span></div>
<div style="position:absolute;left:63.87px;top:297.10px" class="cls_004"><span class="cls_004">easy component and composition identification, and enables reproducibility of configura-</span></div>
<div style="position:absolute;left:63.87px;top:309.06px" class="cls_004"><span class="cls_004">tions both in source and binary form—in other words, it gives predictable, deterministic</span></div>
<div style="position:absolute;left:63.87px;top:321.01px" class="cls_004"><span class="cls_004">semantics to deployment actions.</span></div>
<div style="position:absolute;left:73.84px;top:332.97px" class="cls_004"><span class="cls_004">Nix is a work in progress. The implementation of the extensional model (Chapter 5) is</span></div>
<div style="position:absolute;left:63.87px;top:344.92px" class="cls_004"><span class="cls_004">in use. The experience of the Nix Packages collection shows that it works very well for its</span></div>
<div style="position:absolute;left:63.87px;top:356.88px" class="cls_004"><span class="cls_004">primary goal of software deployment (Chapter 7), though more experience is necessary to</span></div>
<div style="position:absolute;left:63.87px;top:368.83px" class="cls_004"><span class="cls_004">make conclusive statements about the scalability of the purely functional model. The inten-</span></div>
<div style="position:absolute;left:63.87px;top:380.79px" class="cls_004"><span class="cls_004">sional model (Chapter 6) exists in prototype form and must be fully implemented. Services</span></div>
<div style="position:absolute;left:63.87px;top:392.74px" class="cls_004"><span class="cls_004">deployed using Nix (Chapter 9) are in production use, as is a build farm (Chapter 8). Build</span></div>
<div style="position:absolute;left:63.87px;top:404.70px" class="cls_004"><span class="cls_004">management (Chapter 10) works, as its properties are really a direct application of Nix,</span></div>
<div style="position:absolute;left:63.87px;top:416.66px" class="cls_004"><span class="cls_004">but more work is necessary to improve its usability (e.g., by providing good libraries for</span></div>
<div style="position:absolute;left:63.87px;top:428.61px" class="cls_004"><span class="cls_004">common languages and tasks) and scalability.</span></div>
<div style="position:absolute;left:73.84px;top:440.57px" class="cls_004"><span class="cls_004">Our experience with Nix over the last two years allows the following conclusions to be</span></div>
<div style="position:absolute;left:63.87px;top:452.52px" class="cls_004"><span class="cls_004">drawn:</span></div>
<div style="position:absolute;left:78.82px;top:471.94px" class="cls_004"><span class="cls_004">• The purely functional deployment model implemented in Nix and the cryptographic</span></div>
<div style="position:absolute;left:88.78px;top:483.90px" class="cls_004"><span class="cls_004">hashing scheme of the Nix store in particular give us important features that are</span></div>
<div style="position:absolute;left:88.78px;top:495.85px" class="cls_004"><span class="cls_004">lacking in most deployment systems, such as complete dependencies, complete</span></div>
<div style="position:absolute;left:88.78px;top:507.81px" class="cls_004"><span class="cls_004">deployment, side-by-side deployment, atomic upgrades and rollbacks, transparent</span></div>
<div style="position:absolute;left:88.78px;top:519.76px" class="cls_004"><span class="cls_004">source/binary deployment and reproducibility (see Section 1.5).</span></div>
<div style="position:absolute;left:78.82px;top:539.44px" class="cls_004"><span class="cls_004">• The cryptographic hashing scheme is effective in preventing undeclared dependen-</span></div>
<div style="position:absolute;left:88.78px;top:551.39px" class="cls_004"><span class="cls_004">cies, assuming a fully Nixified environment. In other environments, the techniques</span></div>
<div style="position:absolute;left:88.78px;top:563.35px" class="cls_004"><span class="cls_004">of Section 7.1.3 are successful in preventing most impurities.</span></div>
<div style="position:absolute;left:78.82px;top:583.02px" class="cls_004"><span class="cls_004">• Nix places a number of assumptions on components (Section 6.8), but the large and</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">245</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:171810px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background254.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">11. Conclusion</span></div>
<div style="position:absolute;left:84.62px;top:45.04px" class="cls_004"><span class="cls_004">varied set of components deployed through Nix shows that these assumptions are</span></div>
<div style="position:absolute;left:84.62px;top:56.99px" class="cls_004"><span class="cls_004">quite reasonable (Section 7.1.5).</span></div>
<div style="position:absolute;left:74.66px;top:76.41px" class="cls_004"><span class="cls_004">• Hash rewriting is a technique that intuitively might appear unlikely to work, but in</span></div>
<div style="position:absolute;left:84.62px;top:88.36px" class="cls_004"><span class="cls_004">fact does work.  It enables the intensional model, which is a breakthrough in that</span></div>
<div style="position:absolute;left:84.62px;top:100.32px" class="cls_004"><span class="cls_004">it enables secure sharing, multiple output paths, and some future benefits discussed</span></div>
<div style="position:absolute;left:84.62px;top:112.27px" class="cls_004"><span class="cls_004">below.</span></div>
<div style="position:absolute;left:69.68px;top:131.18px" class="cls_004"><span class="cls_004">However, there are also a number of things that we cannot conclude on the basis of our</span></div>
<div style="position:absolute;left:59.72px;top:143.13px" class="cls_004"><span class="cls_004">current experience:</span></div>
<div style="position:absolute;left:74.66px;top:162.03px" class="cls_004"><span class="cls_004">• That a functional language is a good way to describe components and compositions.</span></div>
<div style="position:absolute;left:84.62px;top:173.99px" class="cls_004"><span class="cls_004">Certainly such a language makes it possible and easy to describe variability, and</span></div>
<div style="position:absolute;left:84.62px;top:185.94px" class="cls_004"><span class="cls_004">function arguments seem a natural way to describe dependencies. But the usabil-</span></div>
<div style="position:absolute;left:84.62px;top:197.90px" class="cls_004"><span class="cls_004">ity of functional languages (and the Nix expression language in particular) has not</span></div>
<div style="position:absolute;left:84.62px;top:209.85px" class="cls_004"><span class="cls_004">been demonstrated; all users of the Nix expression language had prior exposure to</span></div>
<div style="position:absolute;left:84.62px;top:221.81px" class="cls_004"><span class="cls_004">functional languages such as Haskell.</span></div>
<div style="position:absolute;left:74.66px;top:241.22px" class="cls_004"><span class="cls_004">• Nix opens up the perspective of unifying the various points on the software build</span></div>
<div style="position:absolute;left:84.62px;top:253.18px" class="cls_004"><span class="cls_004">and deployment timeline into a single formalism; e.g., Nix is not just a deployment</span></div>
<div style="position:absolute;left:84.62px;top:265.13px" class="cls_004"><span class="cls_004">tool, but as we have seen in Chapter 10, it can replace “low-level” build management</span></div>
<div style="position:absolute;left:84.62px;top:277.09px" class="cls_004"><span class="cls_004">tools such as Make. This is good because it prevents “impedance mismatch” between</span></div>
<div style="position:absolute;left:84.62px;top:289.04px" class="cls_004"><span class="cls_004">build management and deployment. For instance, it is not necessary to specify the</span></div>
<div style="position:absolute;left:84.62px;top:301.00px" class="cls_004"><span class="cls_004">same dependency both in the build formalism and the deployment formalism. But it</span></div>
<div style="position:absolute;left:84.62px;top:312.95px" class="cls_004"><span class="cls_004">remains to be seen whether low-level build management can be made scalable. Also,</span></div>
<div style="position:absolute;left:84.62px;top:324.91px" class="cls_004"><span class="cls_004">it is necessary to subsume the source configuration stage, currently implemented by</span></div>
<div style="position:absolute;left:84.62px;top:336.86px" class="cls_004"><span class="cls_004">tools such as Autoconf; this has not been done yet.</span></div>
<div style="position:absolute;left:69.68px;top:355.76px" class="cls_004"><span class="cls_004">Finally, there are also a number of reasonable criticisms that can be levelled at the purely</span></div>
<div style="position:absolute;left:59.72px;top:367.72px" class="cls_004"><span class="cls_004">functional model:</span></div>
<div style="position:absolute;left:74.66px;top:386.62px" class="cls_004"><span class="cls_004">• Efficient upgrading remains a problem. Using patch deployment, upgrades can be</span></div>
<div style="position:absolute;left:84.62px;top:398.58px" class="cls_004"><span class="cls_004">done efficiently in terms of network bandwidth. But a change to a fundamental de-</span></div>
<div style="position:absolute;left:84.62px;top:410.53px" class="cls_004"><span class="cls_004">pendency can still cause disk space requirements to double. This is a real problem</span></div>
<div style="position:absolute;left:84.62px;top:422.49px" class="cls_004"><span class="cls_004">compared to destructive updates. However, it can be argued that disk space is abun-</span></div>
<div style="position:absolute;left:84.62px;top:434.44px" class="cls_004"><span class="cls_004">dant, and that software components no longer dominate disk space consumption.</span></div>
<div style="position:absolute;left:74.66px;top:453.86px" class="cls_004"><span class="cls_004">• Preventing undeclared dependencies is good, but the lack of scoped composition</span></div>
<div style="position:absolute;left:84.62px;top:465.81px" class="cls_004"><span class="cls_004">mechanisms lessens its usefulness (as discussed on page 173).</span></div>
<div style="position:absolute;left:74.66px;top:485.22px" class="cls_004"><span class="cls_004">• Most of our experience with Nix has been on Linux, which allows a self-contained,</span></div>
<div style="position:absolute;left:84.62px;top:497.18px" class="cls_004"><span class="cls_004">pure Nixpkgs (page 169).  That is, every dependency of the components in Nixp-</span></div>
<div style="position:absolute;left:84.62px;top:509.13px" class="cls_004"><span class="cls_004">kgs can be built and deployed through Nix.  This is an ideal situation that cannot</span></div>
<div style="position:absolute;left:84.62px;top:521.09px" class="cls_004"><span class="cls_004">be achieved in most other operating systems.  A GUI application on Mac OS X</span></div>
<div style="position:absolute;left:84.62px;top:533.04px" class="cls_004"><span class="cls_004">will typically have a dependency on the Cocoa or Carbon GUI libraries.  Since</span></div>
<div style="position:absolute;left:84.62px;top:545.00px" class="cls_004"><span class="cls_004">these are closed source and cannot be copied legally, we can neither build them</span></div>
<div style="position:absolute;left:84.62px;top:556.95px" class="cls_004"><span class="cls_004">nor use the techniques of Section 7.1.4 to deploy them in binary form.  Thus we</span></div>
<div style="position:absolute;left:84.62px;top:568.91px" class="cls_004"><span class="cls_004">are forced to resort to impurity (e.g., by linking against the non-store path</span><span class="cls_007"> /Sys-</span></div>
<div style="position:absolute;left:84.62px;top:580.87px" class="cls_007"><span class="cls_007">tem/Library/Frameworks/Cocoa.framework/...</span><span class="cls_004">), reducing Nix’s effectiveness.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">246</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:172500px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background255.jpg" width=481 height=680></div>
<div style="position:absolute;left:348.39px;top:17.14px" class="cls_004"><span class="cls_004">11.1. Future work</span></div>
<div style="position:absolute;left:63.87px;top:42.09px" class="cls_011"><span class="cls_011">11.1. Future work</span></div>
<div style="position:absolute;left:63.87px;top:67.55px" class="cls_004"><span class="cls_004">There are a number of possibilities for further research, as well as a several remaining</span></div>
<div style="position:absolute;left:63.87px;top:79.50px" class="cls_004"><span class="cls_004">practical issues.</span></div>
<div style="position:absolute;left:63.87px;top:106.73px" class="cls_009"><span class="cls_009">A fully Nixified system</span><span class="cls_004">   Since Nix works best in a “pure” environment where all com-</span></div>
<div style="position:absolute;left:63.87px;top:118.69px" class="cls_004"><span class="cls_004">ponents are built and deployed by Nix, it is natural to consider an operating system dis-</span></div>
<div style="position:absolute;left:63.87px;top:130.64px" class="cls_004"><span class="cls_004">tribution on that basis; that is, a Unix system (probably based on Linux or FreeBSD) that</span></div>
<div style="position:absolute;left:63.87px;top:142.60px" class="cls_004"><span class="cls_004">has no</span><span class="cls_007"> /bin</span><span class="cls_004">,</span><span class="cls_007"> /lib</span><span class="cls_004">,</span><span class="cls_007"> /usr</span><span class="cls_004">, etc.—all components are in</span><span class="cls_007"> /nix/store</span><span class="cls_004">. In addition, the configuration</span></div>
<div style="position:absolute;left:63.87px;top:154.55px" class="cls_004"><span class="cls_004">of the system can be managed along the lines of the services in Chapter 9. For instance,</span></div>
<div style="position:absolute;left:63.87px;top:166.51px" class="cls_004"><span class="cls_004">the configuration of which services (such as daemons) should be enabled or disabled can</span></div>
<div style="position:absolute;left:63.87px;top:178.46px" class="cls_004"><span class="cls_004">be expressed in a Nix expression that builds a component that starts and stops other com-</span></div>
<div style="position:absolute;left:63.87px;top:190.42px" class="cls_004"><span class="cls_004">ponents passed as build-time inputs. To change the configuration, the Nix expression is</span></div>
<div style="position:absolute;left:63.87px;top:202.37px" class="cls_004"><span class="cls_004">changed and rebuilt.</span></div>
<div style="position:absolute;left:73.84px;top:213.43px" class="cls_004"><span class="cls_004">A pure</span><span class="cls_012"><sup>1</sup></span><span class="cls_004"> Nix-based Linux system (tentatively called NixOS) is currently in active devel-</span></div>
<div style="position:absolute;left:63.87px;top:226.41px" class="cls_004"><span class="cls_004">opment and in a bootable state. Building components in this pure environment has already</span></div>
<div style="position:absolute;left:63.87px;top:238.37px" class="cls_004"><span class="cls_004">revealed a few impurities in Nixpkgs. On the other hand, the number of such impurities</span></div>
<div style="position:absolute;left:63.87px;top:250.32px" class="cls_004"><span class="cls_004">has turned out to be surprisingly low: once NixOS was up and running, it took only two</span></div>
<div style="position:absolute;left:63.87px;top:262.28px" class="cls_004"><span class="cls_004">one-line modifications (to</span><span class="cls_007"> stdenv</span><span class="cls_004">, no less!) to get Firefox and all its dependencies to build.</span></div>
<div style="position:absolute;left:63.87px;top:289.50px" class="cls_009"><span class="cls_009">The intensional model</span><span class="cls_004">   There is a prototype implementation of the intensional model</span></div>
<div style="position:absolute;left:63.87px;top:301.46px" class="cls_004"><span class="cls_004">that shows that hash rewriting works in practice (i.e., does not break components), but the</span></div>
<div style="position:absolute;left:63.87px;top:313.41px" class="cls_004"><span class="cls_004">prototype is not usable yet. A full implementation is necessary to answer a number of open</span></div>
<div style="position:absolute;left:63.87px;top:325.37px" class="cls_004"><span class="cls_004">questions. In particular, what is a good policy for path selection (page 149)?</span></div>
<div style="position:absolute;left:73.84px;top:337.45px" class="cls_004"><span class="cls_004">The intensional model has the potential to enable better build management. A common</span></div>
<div style="position:absolute;left:63.87px;top:349.41px" class="cls_004"><span class="cls_004">efficiency problem in incremental building is that a small change to some file causes many</span></div>
<div style="position:absolute;left:63.87px;top:361.36px" class="cls_004"><span class="cls_004">rebuilds. For instance, a change to a C header file (say,</span><span class="cls_007"> config.h</span><span class="cls_004">) forces us to rebuild all</span></div>
<div style="position:absolute;left:63.87px;top:373.32px" class="cls_004"><span class="cls_004">source files that include it. This is the case even for source files that include the header but</span></div>
<div style="position:absolute;left:63.87px;top:385.27px" class="cls_004"><span class="cls_004">are unaffected by the change.</span></div>
<div style="position:absolute;left:73.84px;top:397.36px" class="cls_004"><span class="cls_004">Redundant rebuilds can be prevented in the intensional model by making the C prepro-</span></div>
<div style="position:absolute;left:63.87px;top:409.31px" class="cls_004"><span class="cls_004">cessor invocation an explicit build step. For source files that are unaffected by the header</span></div>
<div style="position:absolute;left:63.87px;top:421.27px" class="cls_004"><span class="cls_004">change, the preprocessed output will remain unchanged. We can optimise the build algo-</span></div>
<div style="position:absolute;left:63.87px;top:433.22px" class="cls_004"><span class="cls_004">rithm as follows. If a derivation d</span><span class="cls_012"><sub>1</sub></span><span class="cls_004"> differs only from a derivation d</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> in subderivations that</span></div>
<div style="position:absolute;left:63.87px;top:445.18px" class="cls_004"><span class="cls_004">yielded the same output, we can just copy the output of d</span><span class="cls_012"><sub>2</sub></span><span class="cls_004"> to d</span><span class="cls_012"><sub>1</sub></span><span class="cls_004">.</span></div>
<div style="position:absolute;left:63.87px;top:472.40px" class="cls_009"><span class="cls_009">A language for builders</span><span class="cls_004">   We need to find a better way to write builders. Shell scripts</span></div>
<div style="position:absolute;left:63.87px;top:484.36px" class="cls_004"><span class="cls_004">are simply not a good language. The Unix shell is quite good as component glue—which</span></div>
<div style="position:absolute;left:63.87px;top:496.31px" class="cls_004"><span class="cls_004">is what we use it for—but it is not safe enough. It is in fact virtually impossible to write</span></div>
<div style="position:absolute;left:63.87px;top:508.27px" class="cls_004"><span class="cls_004">“correct” shell scripts that do not fail, unexpectedly, for banal reasons on certain inputs or</span></div>
<div style="position:absolute;left:63.87px;top:520.22px" class="cls_004"><span class="cls_004">in certain situations. Here are some of the main problems in the language:</span></div>
<div style="position:absolute;left:78.82px;top:540.53px" class="cls_004"><span class="cls_004">• Variable uses (e.g.,</span><span class="cls_007"> $foo</span><span class="cls_004">) are “interpolated” by default. This is the reason why most</span></div>
<div style="position:absolute;left:88.78px;top:552.49px" class="cls_004"><span class="cls_004">shell scripts fail on file names that contain spaces or newlines. The same applies for</span></div>
<div style="position:absolute;left:88.78px;top:564.44px" class="cls_004"><span class="cls_004">automatic “globbing” (expansion of special characters such as</span><span class="cls_007"> "*"</span><span class="cls_004">).</span></div>
<div style="position:absolute;left:68.36px;top:584.11px" class="cls_013"><span class="cls_013"><sup>1</sup></span><span class="cls_014">With the exception of</span><span class="cls_016"> /bin/sh</span><span class="cls_014">, which is required by Glibc and several standards.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">247</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:173190px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background256.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">11. Conclusion</span></div>
<div style="position:absolute;left:74.66px;top:45.04px" class="cls_004"><span class="cls_004">• Undefined variables do not signal an error.</span></div>
<div style="position:absolute;left:74.66px;top:68.68px" class="cls_004"><span class="cls_004">• Non-zero exit codes from commands are ignored by default. Worse, it is extremely</span></div>
<div style="position:absolute;left:84.62px;top:80.63px" class="cls_004"><span class="cls_004">hard to catch errors from the left-hand sides of pipes.</span></div>
<div style="position:absolute;left:59.72px;top:103.34px" class="cls_004"><span class="cls_004">In fact, the whole Unix tool chain is not conducive to writing correct code:</span></div>
<div style="position:absolute;left:74.66px;top:126.05px" class="cls_004"><span class="cls_004">• Command-line arguments in Unix are usually overloaded, e.g., there is an ambiguity</span></div>
<div style="position:absolute;left:84.62px;top:138.01px" class="cls_004"><span class="cls_004">in most Unix tools between options and file names starting with a dash.</span></div>
<div style="position:absolute;left:74.66px;top:161.65px" class="cls_004"><span class="cls_004">• The pipe model is that all tools read and write flat text files without a well-defined</span></div>
<div style="position:absolute;left:84.62px;top:173.60px" class="cls_004"><span class="cls_004">structure. This makes it hard to extract relevant data in a structured way. Typically,</span></div>
<div style="position:absolute;left:84.62px;top:185.56px" class="cls_004"><span class="cls_004">regular expressions in conjunction with</span><span class="cls_007"> grep</span><span class="cls_004">,</span><span class="cls_007"> sed</span><span class="cls_004">,</span><span class="cls_007"> awk</span><span class="cls_004"> and</span><span class="cls_007"> perl</span><span class="cls_004"> are used to extract</span></div>
<div style="position:absolute;left:84.62px;top:197.51px" class="cls_004"><span class="cls_004">data, but this tends to be brittle—the regular expressions hardly ever cover all possi-</span></div>
<div style="position:absolute;left:84.62px;top:209.47px" class="cls_004"><span class="cls_004">bilities.</span></div>
<div style="position:absolute;left:74.66px;top:233.11px" class="cls_004"><span class="cls_004">• Similarly, the fact that options are flat strings makes it hard to pass structure, neces-</span></div>
<div style="position:absolute;left:84.62px;top:245.06px" class="cls_004"><span class="cls_004">sitating escaping. E.g., the command</span><span class="cls_007"> grep -q "$filename"</span><span class="cls_004"> to see whether a certain file</span></div>
<div style="position:absolute;left:84.62px;top:257.02px" class="cls_004"><span class="cls_004">name occurs in a list fails to take into account that</span><span class="cls_007"> grep</span><span class="cls_004"> interprets some characters</span></div>
<div style="position:absolute;left:84.62px;top:268.97px" class="cls_004"><span class="cls_004">in</span><span class="cls_007"> $filename</span><span class="cls_004"> as regular expression meta-characters.</span></div>
<div style="position:absolute;left:59.72px;top:291.68px" class="cls_004"><span class="cls_004">These problems are far from specific to Nix builders. They have been the cause of many</span></div>
<div style="position:absolute;left:59.72px;top:303.64px" class="cls_004"><span class="cls_004">serious bugs, including security problems. So what we need is a shell with a clean seman-</span></div>
<div style="position:absolute;left:59.72px;top:315.59px" class="cls_004"><span class="cls_004">tics founded on the principle of least surprise [140], and a tool set based on the exchange of</span></div>
<div style="position:absolute;left:59.72px;top:327.55px" class="cls_004"><span class="cls_004">structured data (e.g., XML or ATerms). MSH (the Microsoft Shell) may be a good model.</span></div>
<div style="position:absolute;left:69.68px;top:340.43px" class="cls_004"><span class="cls_004">It is also necessary to improve the interaction between Nix expressions and builders.</span></div>
<div style="position:absolute;left:59.72px;top:352.39px" class="cls_004"><span class="cls_004">The mechanism by which information is communicated to builders is rather crude, namely,</span></div>
<div style="position:absolute;left:59.72px;top:364.34px" class="cls_004"><span class="cls_004">through environment variables that only allow flat strings to be passed. It is much better to</span></div>
<div style="position:absolute;left:59.72px;top:376.30px" class="cls_004"><span class="cls_004">pass structured information, such as attribute sets and lists. An obvious way is to convert</span></div>
<div style="position:absolute;left:59.72px;top:388.25px" class="cls_004"><span class="cls_004">such expressions to XML (which is especially attractive in conjunction with an XML-based</span></div>
<div style="position:absolute;left:59.72px;top:400.21px" class="cls_004"><span class="cls_004">tool set).</span></div>
<div style="position:absolute;left:59.72px;top:431.84px" class="cls_009"><span class="cls_009">A type system</span><span class="cls_004">   A type system for the Nix expression language is desirable. Of course,</span></div>
<div style="position:absolute;left:59.72px;top:443.79px" class="cls_004"><span class="cls_004">to the greatest extent possible types should be inferred. We probably need a basic Hindley-</span></div>
<div style="position:absolute;left:59.72px;top:455.75px" class="cls_004"><span class="cls_004">Milner type system [122] extended with extensible records [111] to support attribute sets.</span></div>
<div style="position:absolute;left:59.72px;top:487.38px" class="cls_009"><span class="cls_009">Efficient storage</span><span class="cls_004">   Binary patch deployment greatly reduces the bandwidth needed to de-</span></div>
<div style="position:absolute;left:59.72px;top:499.34px" class="cls_004"><span class="cls_004">ploy binary upgrades, but the upgraded components still need to be stored in full, and an</span></div>
<div style="position:absolute;left:59.72px;top:511.29px" class="cls_004"><span class="cls_004">amount of CPU time linear in the size of the upgraded components is also required. These</span></div>
<div style="position:absolute;left:59.72px;top:523.25px" class="cls_004"><span class="cls_004">problems may be solved by using a file system that supports delta storage [115], i.e., that</span></div>
<div style="position:absolute;left:59.72px;top:535.20px" class="cls_004"><span class="cls_004">can store file revisions as deltas to previous revisions. Actually, for the Nix store, we need</span></div>
<div style="position:absolute;left:59.72px;top:547.16px" class="cls_004"><span class="cls_004">a file system where revisions can refer to revisions of other files. Concretely, we need a</span></div>
<div style="position:absolute;left:59.72px;top:559.11px" class="cls_004"><span class="cls_004">kernel API</span><span class="cls_007"> copy</span><span class="cls_004">(p</span><span class="cls_012"><sub>dst</sub></span><span class="cls_004"> , p</span><span class="cls_012"><sub>src</sub></span><span class="cls_004">, patch) that creates a path p</span><span class="cls_012"><sub>dst</sub></span><span class="cls_004"> with contents equal to those of</span></div>
<div style="position:absolute;left:60.46px;top:571.07px" class="cls_004"><span class="cls_004">p</span><span class="cls_012"><sub>src</sub></span><span class="cls_004"> with patch applied. Then FSO creation using patches takes disk space and CPU time</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">linear in the size of the patch, not the resulting FSO.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">248</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:173880px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background257.jpg" width=481 height=680></div>
<div style="position:absolute;left:348.39px;top:17.14px" class="cls_004"><span class="cls_004">11.1. Future work</span></div>
<div style="position:absolute;left:67.26px;top:49.20px" class="cls_015"><span class="cls_015">&lt;item  id='zlib-1.2.1-security'  type='security'></span></div>
<div style="position:absolute;left:76.67px;top:60.16px" class="cls_015"><span class="cls_015">&lt;condition></span></div>
<div style="position:absolute;left:86.09px;top:71.12px" class="cls_015"><span class="cls_015">&lt;within></span></div>
<div style="position:absolute;left:95.50px;top:82.08px" class="cls_015"><span class="cls_015">&lt;traverse>  &lt;true  />  &lt;/traverse></span></div>
<div style="position:absolute;left:95.50px;top:93.03px" class="cls_015"><span class="cls_015">&lt;hasAttr  name='outputHash'  value='ef1cb003448b...'  /></span></div>
<div style="position:absolute;left:86.09px;top:103.99px" class="cls_015"><span class="cls_015">&lt;/within></span></div>
<div style="position:absolute;left:76.67px;top:114.95px" class="cls_015"><span class="cls_015">&lt;/condition></span></div>
<div style="position:absolute;left:76.67px;top:125.91px" class="cls_015"><span class="cls_015">&lt;reason></span></div>
<div style="position:absolute;left:86.09px;top:136.87px" class="cls_015"><span class="cls_015">Zlib  1.2.1  is  vulnerable  to  a  denial-of-service  condition.   See</span></div>
<div style="position:absolute;left:86.09px;top:147.83px" class="cls_015"><span class="cls_015"> </span><A HREF="http://www.kb.cert.org/vuls/id/238678./">http://www.kb.cert.org/vuls/id/238678.</A>   Upgrade  to  1.2.2.</div>
<div style="position:absolute;left:76.67px;top:158.79px" class="cls_015"><span class="cls_015">&lt;/reason></span></div>
<div style="position:absolute;left:76.67px;top:169.75px" class="cls_015"><span class="cls_015">&lt;severity  class="server"  level="critical"  /></span></div>
<div style="position:absolute;left:76.67px;top:180.71px" class="cls_015"><span class="cls_015">&lt;severity  class="client"  level="medium"  /></span></div>
<div style="position:absolute;left:67.26px;top:191.66px" class="cls_015"><span class="cls_015">&lt;/item></span></div>
<div style="position:absolute;left:182.97px;top:208.26px" class="cls_004"><span class="cls_004">Figure 11.1.: A blacklist entry</span></div>
<div style="position:absolute;left:63.87px;top:241.43px" class="cls_009"><span class="cls_009">Blacklisting</span><span class="cls_004">   The purely functional model creates a serious problem in some situations:</span></div>
<div style="position:absolute;left:63.87px;top:253.38px" class="cls_004"><span class="cls_004">how can we be sure that all uses of a certain “bad” component have been eliminated? For</span></div>
<div style="position:absolute;left:63.87px;top:265.34px" class="cls_004"><span class="cls_004">example, suppose that we find that a certain fundamental component (say, Zlib) contains</span></div>
<div style="position:absolute;left:63.87px;top:277.29px" class="cls_004"><span class="cls_004">a security bug [1]. This component is used by many other components. Thus we want to</span></div>
<div style="position:absolute;left:63.87px;top:289.25px" class="cls_004"><span class="cls_004">ensure that we upgrade all installed applications in all user environments to new instances</span></div>
<div style="position:absolute;left:63.87px;top:301.21px" class="cls_004"><span class="cls_004">that do not use the bad component anymore.  Of course, we can just run</span><span class="cls_007"> nix-env -u "*"</span></div>
<div style="position:absolute;left:63.87px;top:313.16px" class="cls_004"><span class="cls_004">and hope that this gets rid of all bad components, but there is no guarantee of that, espe-</span></div>
<div style="position:absolute;left:63.87px;top:325.12px" class="cls_004"><span class="cls_004">cially if we have installed components from arbitrary third parties (i.e., components not</span></div>
<div style="position:absolute;left:63.87px;top:337.07px" class="cls_004"><span class="cls_004">in Nixpkgs). The purely functional model’s non-interference property now bites us. Thus</span></div>
<div style="position:absolute;left:63.87px;top:349.03px" class="cls_004"><span class="cls_004">there should be a generic mechanism that detects uses of bad components on the basis of a</span></div>
<div style="position:absolute;left:63.87px;top:360.98px" class="cls_004"><span class="cls_004">blacklist that describes these components.</span></div>
<div style="position:absolute;left:73.84px;top:373.50px" class="cls_004"><span class="cls_004">A simple prototype of this idea has been implemented. It evaluates an XML specification</span></div>
<div style="position:absolute;left:63.87px;top:385.46px" class="cls_004"><span class="cls_004">that contains declarations such as the one shown in Figure 11.1. This example specifies</span></div>
<div style="position:absolute;left:63.87px;top:397.41px" class="cls_004"><span class="cls_004">that any output path built from a derivation graph that at any point used the Zlib 1.2.1</span></div>
<div style="position:absolute;left:63.87px;top:409.37px" class="cls_004"><span class="cls_004">source distribution (as identified by its cryptographic hash,</span><span class="cls_007"> ef1cb003448b...</span><span class="cls_004">), is tainted.</span></div>
<div style="position:absolute;left:63.87px;top:421.32px" class="cls_004"><span class="cls_004">The condition is applied to every element of every user environment, and prints out a</span></div>
<div style="position:absolute;left:63.87px;top:433.28px" class="cls_004"><span class="cls_004">warning if a match is found. Note that since the condition inspects the derivation graph</span></div>
<div style="position:absolute;left:63.87px;top:445.23px" class="cls_004"><span class="cls_004">(found through the deriver link described in Section 5.5.1), it also matches statically linked</span></div>
<div style="position:absolute;left:63.87px;top:457.19px" class="cls_004"><span class="cls_004">uses of Zlib. Thus the blacklisting approach finds dangerous uses of libraries that cannot</span></div>
<div style="position:absolute;left:63.87px;top:469.14px" class="cls_004"><span class="cls_004">be fixed by destructive upgrading in conventional deployment models.</span></div>
<div style="position:absolute;left:73.84px;top:481.66px" class="cls_004"><span class="cls_004">A blacklisting approach should also specify what should be done if a match is found,</span></div>
<div style="position:absolute;left:63.87px;top:493.62px" class="cls_004"><span class="cls_004">which may depend on the type of the machine, user environment, or application: for a</span></div>
<div style="position:absolute;left:63.87px;top:505.57px" class="cls_004"><span class="cls_004">server the Zlib bug is critical, for a client less so.</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_009"><span class="cls_009">Upgrading in the intensional model</span><span class="cls_004">   The technique of hash rewriting in the intensional</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">model (Section 6.3.2) allows something very similar to destructive upgrading in conven-</span></div>
<div style="position:absolute;left:63.87px;top:559.11px" class="cls_004"><span class="cls_004">tional systems, but in safe way. We can generically upgrade all components that reference</span></div>
<div style="position:absolute;left:63.87px;top:570.04px" class="cls_004"><span class="cls_004">some “bad” path p to a “good” path p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">, by rewriting (using a variation of algorithm</span><span class="cls_007"> resolve</span></div>
<div style="position:absolute;left:63.87px;top:582.00px" class="cls_004"><span class="cls_004">in Section 6.4.1) every use of p to p</span><span class="cls_012"><sup>′</sup></span><span class="cls_004">. The difference with the normal mode of upgrading</span></div>
<div style="position:absolute;left:407.23px;top:624.86px" class="cls_004"><span class="cls_004">249</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:174570px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background258.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">11. Conclusion</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">in Nix (deploying replacement Nix expressions) is that no Nix expressions are necessary.</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">That’s also the problem of this technique: the resulting components do not have a deriver,</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">that is, they do not necessarily correspond to the output of any known derivation. But it</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">is not destructive: since</span><span class="cls_007"> resolve</span><span class="cls_004"> works by rewriting copies, the old components are still</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">available. Thus, atomicity and the ability to roll back still hold.</span></div>
<div style="position:absolute;left:59.72px;top:119.39px" class="cls_009"><span class="cls_009">Feature selection and automatic instantiation</span><span class="cls_004">   Nix supports component variability</span></div>
<div style="position:absolute;left:59.72px;top:131.34px" class="cls_004"><span class="cls_004">both in the expression language and at the store level, but current deployment policies</span></div>
<div style="position:absolute;left:59.72px;top:143.30px" class="cls_004"><span class="cls_004">are not very good at making it available to users. For instance,</span><span class="cls_007"> nix-env</span><span class="cls_004"> does not provide</span></div>
<div style="position:absolute;left:59.72px;top:155.25px" class="cls_004"><span class="cls_004">a way to pass arguments to functions; the top-level Nix expression should evaluate to a</span></div>
<div style="position:absolute;left:59.72px;top:167.21px" class="cls_004"><span class="cls_004">set of derivations. Similarly, deployment policies such as channels do not support local</span></div>
<div style="position:absolute;left:59.72px;top:179.16px" class="cls_004"><span class="cls_004">customisation.</span></div>
<div style="position:absolute;left:69.68px;top:191.12px" class="cls_004"><span class="cls_004">At the very least, tools such as</span><span class="cls_007"> nix-env</span><span class="cls_004"> should be extended to allow variation points</span></div>
<div style="position:absolute;left:59.72px;top:203.07px" class="cls_004"><span class="cls_004">to be bound (i.e., to allow the user to set parameters). One can imagine this being done</span></div>
<div style="position:absolute;left:59.72px;top:215.03px" class="cls_004"><span class="cls_004">through a nice graphical user interface, e.g., as in the Linux kernel configuration tool, Con-</span></div>
<div style="position:absolute;left:59.72px;top:226.98px" class="cls_004"><span class="cls_004">sul@GUI [13] or the Software Dock [85]. Such interfaces lead to an interesting problem: if</span></div>
<div style="position:absolute;left:59.72px;top:238.94px" class="cls_004"><span class="cls_004">the user binds some but not all of the variation points, how can we find component instances</span></div>
<div style="position:absolute;left:59.72px;top:250.89px" class="cls_004"><span class="cls_004">or compositions that satisfy all constraints (as expressed by assertions in Nix expressions)?</span></div>
<div style="position:absolute;left:59.72px;top:262.85px" class="cls_004"><span class="cls_004">This is of course an NP-complete problem (since it is essentially just the boolean satisfia-</span></div>
<div style="position:absolute;left:59.72px;top:274.80px" class="cls_004"><span class="cls_004">bility problem [35]), but that may not be a problem in practice. For example, CML2 [139]</span></div>
<div style="position:absolute;left:59.72px;top:286.76px" class="cls_004"><span class="cls_004">finds Linux kernel instances satisfying user-specified constraints automatically, and Binary</span></div>
<div style="position:absolute;left:59.72px;top:298.71px" class="cls_004"><span class="cls_004">Decision Diagrams (BDD) also appear to be a useful technique for this purpose [170].</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">250</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:175260px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background259.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:83.10px" class="cls_006"><span class="cls_006">Bibliography</span></div>
<div style="position:absolute;left:71.84px;top:120.62px" class="cls_014"><span class="cls_014">[1]</span></div>
<div style="position:absolute;left:86.12px;top:120.62px" class="cls_014"><span class="cls_014">Mark Adler and Jean-loup Gailly. Zlib advisory 2002-03-11.</span><span class="cls_016"> <A HREF="http://www.zlib.net/advisory-2002-03-11.txt/">http://www.zlib.net/advisory-2002-03-11.txt</A> </span><span class="cls_014">,</span></div>
<div style="position:absolute;left:86.12px;top:130.09px" class="cls_014"><span class="cls_014">2002.</span></div>
<div style="position:absolute;left:71.84px;top:143.57px" class="cls_014"><span class="cls_014">[2]</span></div>
<div style="position:absolute;left:86.12px;top:143.57px" class="cls_014"><span class="cls_014">Eric Anderson and Dave Patterson. A retrospective on twelve years of LISA proceedings. In Proceedings</span></div>
<div style="position:absolute;left:86.12px;top:153.03px" class="cls_014"><span class="cls_014">of the 13th Systems Administration Conference (LISA ’99), pages 95-107. USENIX Association, Novem-</span></div>
<div style="position:absolute;left:86.12px;top:162.50px" class="cls_014"><span class="cls_014">ber 1999.</span></div>
<div style="position:absolute;left:71.84px;top:175.98px" class="cls_014"><span class="cls_014">[3]</span></div>
<div style="position:absolute;left:86.12px;top:175.98px" class="cls_014"><span class="cls_014">Gregory R. Andrews. Concurrent Programming: Principles and Practice. Addison-Wesley, 1991.</span></div>
<div style="position:absolute;left:71.84px;top:189.46px" class="cls_014"><span class="cls_014">[4]</span></div>
<div style="position:absolute;left:86.12px;top:189.46px" class="cls_014"><span class="cls_014">Andrew W. Appel. Modern Compiler Implementation in ML. Cambridge University Press, 1998.</span></div>
<div style="position:absolute;left:71.84px;top:202.95px" class="cls_014"><span class="cls_014">[5]</span></div>
<div style="position:absolute;left:86.12px;top:202.95px" class="cls_014"><span class="cls_014">Franz Baader and Tobias Nipkow. Term rewriting and all that. Cambridge University Press, 1998.</span></div>
<div style="position:absolute;left:71.84px;top:216.43px" class="cls_014"><span class="cls_014">[6]</span></div>
<div style="position:absolute;left:86.12px;top:216.43px" class="cls_014"><span class="cls_014">Erik H. Baalbergen. Parallel and distributed compilations in loosely-coupled systems: A case study. In</span></div>
<div style="position:absolute;left:86.12px;top:225.89px" class="cls_014"><span class="cls_014">Workshop on Large Grain Parallelism, Providence, RI, October 1986. Also in [123].</span></div>
<div style="position:absolute;left:71.84px;top:239.38px" class="cls_014"><span class="cls_014">[7]</span></div>
<div style="position:absolute;left:86.12px;top:239.38px" class="cls_014"><span class="cls_014">Erik H. Baalbergen.  Design and implementation of parallel make.  Computing Systems, 1(2):135-158,</span></div>
<div style="position:absolute;left:86.12px;top:248.84px" class="cls_014"><span class="cls_014">1988.</span></div>
<div style="position:absolute;left:71.84px;top:262.32px" class="cls_014"><span class="cls_014">[8]</span></div>
<div style="position:absolute;left:86.12px;top:262.32px" class="cls_014"><span class="cls_014">Erik H. Baalbergen. The declarative operating system model. PhD thesis, Vrije Universiteit, Amsterdam,</span></div>
<div style="position:absolute;left:86.12px;top:271.79px" class="cls_014"><span class="cls_014">The Netherlands, 1992.</span></div>
<div style="position:absolute;left:71.84px;top:285.27px" class="cls_014"><span class="cls_014">[9]</span></div>
<div style="position:absolute;left:86.12px;top:285.27px" class="cls_014"><span class="cls_014">Erik H. Baalbergen, Kees Verstoep, and Andrew S. Tanenbaum. On the design of the Amoeba configura-</span></div>
<div style="position:absolute;left:86.12px;top:294.74px" class="cls_014"><span class="cls_014">tion manager. In 2nd International Workshop on Software Configuration Management (SCM-2), volume</span></div>
<div style="position:absolute;left:86.12px;top:304.20px" class="cls_014"><span class="cls_014">17/7 of ACM SIGSOFT Software Engineering Notes, pages 15-22, November 1989.</span></div>
<div style="position:absolute;left:67.86px;top:317.68px" class="cls_014"><span class="cls_014">[10]</span></div>
<div style="position:absolute;left:86.12px;top:317.68px" class="cls_014"><span class="cls_014">Henk Barendregt.  The Lambda Calculus: Its Syntax and Semantics, volume II of Studies in Logic and</span></div>
<div style="position:absolute;left:86.12px;top:327.15px" class="cls_014"><span class="cls_014">the Foundations of Mathematics. Elsevier Science Publishers B.V. (North-Holland), Amsterdam, second</span></div>
<div style="position:absolute;left:86.12px;top:336.61px" class="cls_014"><span class="cls_014">edition, 1984.</span></div>
<div style="position:absolute;left:67.86px;top:350.10px" class="cls_014"><span class="cls_014">[11]</span></div>
<div style="position:absolute;left:86.12px;top:350.10px" class="cls_014"><span class="cls_014">Bryan Kendall Beatty.  Compact text encoding of latitude/longitude coordinates.  United States Patent</span></div>
<div style="position:absolute;left:86.12px;top:359.56px" class="cls_014"><span class="cls_014">Application 20050023524, February 2005.</span></div>
<div style="position:absolute;left:67.86px;top:373.04px" class="cls_014"><span class="cls_014">[12]</span></div>
<div style="position:absolute;left:86.12px;top:373.04px" class="cls_014"><span class="cls_014">Tim Berners-Lee, Roy T. Fielding, and Larry Masinter.  Uniform resource identifiers (URI): Generic</span></div>
<div style="position:absolute;left:86.12px;top:382.51px" class="cls_014"><span class="cls_014">syntax. RFC 2396, August 1998.</span></div>
<div style="position:absolute;left:67.86px;top:395.99px" class="cls_014"><span class="cls_014">[13]</span></div>
<div style="position:absolute;left:86.12px;top:395.99px" class="cls_014"><span class="cls_014">Danilo Beuche, Holger Papajewski, and Wolfgang Schröder-Preikschat.  Variability management with</span></div>
<div style="position:absolute;left:86.12px;top:405.45px" class="cls_014"><span class="cls_014">feature models. In Jilles van Gurp and Jan Bosch, editors, Proceedings of the Software Variability Man-</span></div>
<div style="position:absolute;left:86.12px;top:414.92px" class="cls_014"><span class="cls_014">agement Workshop (SVM ’2003), February 2003.</span></div>
<div style="position:absolute;left:67.86px;top:428.40px" class="cls_014"><span class="cls_014">[14]</span></div>
<div style="position:absolute;left:86.12px;top:428.40px" class="cls_014"><span class="cls_014">Hans-Juergen Boehm. Space efficient conservative garbage collection. In Proceedings of the ACM SIG-</span></div>
<div style="position:absolute;left:86.12px;top:437.87px" class="cls_014"><span class="cls_014">PLAN ’93 Conference on Programming Language Design and Implementation, number 28/6 in SIGPLAN</span></div>
<div style="position:absolute;left:86.12px;top:447.33px" class="cls_014"><span class="cls_014">Notices, pages 197-206, June 1993.</span></div>
<div style="position:absolute;left:67.86px;top:460.81px" class="cls_014"><span class="cls_014">[15]</span></div>
<div style="position:absolute;left:86.12px;top:460.81px" class="cls_014"><span class="cls_014">Hans-Juergen Boehm and Mark Weiser. Garbage collection in an uncooperative environment. Software—</span></div>
<div style="position:absolute;left:86.12px;top:470.28px" class="cls_014"><span class="cls_014">Practice and Experience, 18(9):807-820, September 1988.</span></div>
<div style="position:absolute;left:67.86px;top:483.76px" class="cls_014"><span class="cls_014">[16]</span></div>
<div style="position:absolute;left:86.12px;top:483.76px" class="cls_014"><span class="cls_014">Don Box. Essential COM. Addison-Wesley, 1998.</span></div>
<div style="position:absolute;left:67.86px;top:497.24px" class="cls_014"><span class="cls_014">[17]</span></div>
<div style="position:absolute;left:86.12px;top:497.24px" class="cls_014"><span class="cls_014">Don Box. Essential .NET, Volume I: The Common Language Runtime. Addison-Wesley, November 2002.</span></div>
<div style="position:absolute;left:67.86px;top:510.73px" class="cls_014"><span class="cls_014">[18]</span></div>
<div style="position:absolute;left:86.12px;top:510.73px" class="cls_014"><span class="cls_014">Richard S. Boyer and J Strother Moore. A fast string searching algorithm. Communications of the ACM,</span></div>
<div style="position:absolute;left:86.12px;top:520.19px" class="cls_014"><span class="cls_014">20(10):762-772, 1977.</span></div>
<div style="position:absolute;left:67.86px;top:533.67px" class="cls_014"><span class="cls_014">[19]</span></div>
<div style="position:absolute;left:86.12px;top:533.67px" class="cls_014"><span class="cls_014">Martin Bravenboer and Eelco Visser. Concrete syntax for objects. Domain-specific language embedding</span></div>
<div style="position:absolute;left:86.12px;top:543.14px" class="cls_014"><span class="cls_014">and assimilation without restrictions. In Douglas C. Schmidt, editor, Proceedings of the 19th ACM SIG-</span></div>
<div style="position:absolute;left:86.12px;top:552.60px" class="cls_014"><span class="cls_014">PLAN Conference on Object-Oriented Programing, Systems, Languages, and Applications (OOPSLA’04),</span></div>
<div style="position:absolute;left:86.12px;top:562.07px" class="cls_014"><span class="cls_014">pages 365-383, Vancouver, Canada, October 2004. ACM Press.</span></div>
<div style="position:absolute;left:67.86px;top:575.55px" class="cls_014"><span class="cls_014">[20]</span></div>
<div style="position:absolute;left:86.12px;top:575.55px" class="cls_014"><span class="cls_014">Tim Bray, Jean Paoli, C. M. Sperberg-McQueen, Eve Maler, and François Yergeau, editors.  Extensible</span></div>
<div style="position:absolute;left:86.12px;top:585.01px" class="cls_014"><span class="cls_014">Markup Language (XML) 1.0. W3C, third edition, February 2004.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">251</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:175950px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background260.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">Bibliography</span></div>
<div style="position:absolute;left:63.70px;top:47.03px" class="cls_014"><span class="cls_014">[21]</span></div>
<div style="position:absolute;left:81.96px;top:47.03px" class="cls_014"><span class="cls_014">Rick Bubenik and Willy Zwaenepoel. Optimistic Make. IEEE Transactions on Software, 41(2), February</span></div>
<div style="position:absolute;left:81.96px;top:56.50px" class="cls_014"><span class="cls_014">1992.</span></div>
<div style="position:absolute;left:63.70px;top:69.60px" class="cls_014"><span class="cls_014">[22]</span></div>
<div style="position:absolute;left:81.96px;top:69.60px" class="cls_014"><span class="cls_014">Mark Burgess. Cfengine: a site configuration engine. Computing Systems, 8(3), 1995.</span></div>
<div style="position:absolute;left:63.70px;top:82.70px" class="cls_014"><span class="cls_014">[23]</span></div>
<div style="position:absolute;left:81.96px;top:82.70px" class="cls_014"><span class="cls_014">Brent Callaghan, Brian Pawlowski, and Peter Staubach. Nfs version 3 protocol specification. RFC 1813,</span></div>
<div style="position:absolute;left:81.96px;top:92.17px" class="cls_014"><span class="cls_014">June 1995.</span></div>
<div style="position:absolute;left:63.70px;top:105.27px" class="cls_014"><span class="cls_014">[24]</span></div>
<div style="position:absolute;left:81.96px;top:105.27px" class="cls_014"><span class="cls_014">Antonio Carzaniga, Alfonso Fuggetta, Richard S. Hall, André van der Hoek, Dennis Heimbigner, and</span></div>
<div style="position:absolute;left:81.96px;top:114.73px" class="cls_014"><span class="cls_014">Alexander L. Wolf. A characterization framework for software deployment technologies. Technical Report</span></div>
<div style="position:absolute;left:81.96px;top:124.20px" class="cls_014"><span class="cls_014">CU-CS-857-98, University of Colorado, April 1998.</span></div>
<div style="position:absolute;left:63.70px;top:137.30px" class="cls_014"><span class="cls_014">[25]</span></div>
<div style="position:absolute;left:81.96px;top:137.30px" class="cls_014"><span class="cls_014">Antonio Carzaniga, David S. Rosenblum, and Alexander L. Wolf. Design and evaluation of a wide-area</span></div>
<div style="position:absolute;left:81.96px;top:146.77px" class="cls_014"><span class="cls_014">event notification service. ACM Transactions on Computer Systems, 19(3):332-383, 2001.</span></div>
<div style="position:absolute;left:63.70px;top:159.87px" class="cls_014"><span class="cls_014">[26]</span></div>
<div style="position:absolute;left:81.96px;top:159.87px" class="cls_014"><span class="cls_014">Anders Christensen and Tor Egge. Store — a system for handling third-party applications in a heteroge-</span></div>
<div style="position:absolute;left:81.96px;top:169.33px" class="cls_014"><span class="cls_014">neous computer environment. In Selected papers from the ICSE SCM-4 and SCM-5 Workshops on Soft-</span></div>
<div style="position:absolute;left:81.96px;top:178.80px" class="cls_014"><span class="cls_014">ware Configuration Management, number 1005 in Lecture Notes in Computer Science. Springer-Verlag,</span></div>
<div style="position:absolute;left:81.96px;top:188.26px" class="cls_014"><span class="cls_014">1995.</span></div>
<div style="position:absolute;left:63.70px;top:201.37px" class="cls_014"><span class="cls_014">[27]</span></div>
<div style="position:absolute;left:81.96px;top:201.37px" class="cls_014"><span class="cls_014">James Clark, editor. XSL Transformations (XSLT) Version 1.0. W3C, November 1999.</span></div>
<div style="position:absolute;left:63.70px;top:214.47px" class="cls_014"><span class="cls_014">[28]</span></div>
<div style="position:absolute;left:81.96px;top:214.47px" class="cls_014"><span class="cls_014">Geoffrey Clemm. The Odin System — An Object Manager for Extensible Software Environments. PhD</span></div>
<div style="position:absolute;left:81.96px;top:223.93px" class="cls_014"><span class="cls_014">thesis, University of Colorado at Boulder, February 1986.</span></div>
<div style="position:absolute;left:63.70px;top:237.04px" class="cls_014"><span class="cls_014">[29]</span></div>
<div style="position:absolute;left:81.96px;top:237.04px" class="cls_014"><span class="cls_014">Geoffrey Clemm. The Odin system. In Selected papers from the ICSE SCM-4 and SCM-5 Workshops on</span></div>
<div style="position:absolute;left:81.96px;top:246.50px" class="cls_014"><span class="cls_014">Software Configuration Management, number 1005 in Lecture Notes in Computer Science, pages 241-</span></div>
<div style="position:absolute;left:81.96px;top:255.97px" class="cls_014"><span class="cls_014">262. Springer-Verlag, 1995.</span></div>
<div style="position:absolute;left:63.70px;top:269.07px" class="cls_014"><span class="cls_014">[30]</span></div>
<div style="position:absolute;left:81.96px;top:269.07px" class="cls_014"><span class="cls_014">Geoffrey Clemm, Jim Amsden, Tim Ellison, Christopher Kaler, and Jim Whitehead. Versioning extensions</span></div>
<div style="position:absolute;left:81.96px;top:278.53px" class="cls_014"><span class="cls_014">to WebDAV (web distributed authoring and versioning). RFC 3253, March 2002.</span></div>
<div style="position:absolute;left:63.70px;top:291.64px" class="cls_014"><span class="cls_014">[31]</span></div>
<div style="position:absolute;left:81.96px;top:291.64px" class="cls_014"><span class="cls_014">CollabNet. Subversion.</span><span class="cls_016"> <A HREF="http://subversion.tigris.org/">http://subversion.tigris.org/</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:63.70px;top:304.74px" class="cls_014"><span class="cls_014">[32]</span></div>
<div style="position:absolute;left:81.96px;top:304.74px" class="cls_014"><span class="cls_014">Wallace Colyer and Walter Wong. Depot: A tool for managing software environments. In Proceedings</span></div>
<div style="position:absolute;left:81.96px;top:314.20px" class="cls_014"><span class="cls_014">of the 6th Systems Administration Conference (LISA VI), pages 153-162. USENIX Association, October</span></div>
<div style="position:absolute;left:81.96px;top:323.67px" class="cls_014"><span class="cls_014">1992.</span></div>
<div style="position:absolute;left:63.70px;top:336.77px" class="cls_014"><span class="cls_014">[33]</span></div>
<div style="position:absolute;left:81.96px;top:336.77px" class="cls_014"><span class="cls_014">International Electrotechnical Commission. Letter symbols to be used in electrical technology — Part 2:</span></div>
<div style="position:absolute;left:81.96px;top:346.24px" class="cls_014"><span class="cls_014">Telecommunications and electronics. IEC, second edition, November 2000. IEC 60027-2.</span></div>
<div style="position:absolute;left:63.70px;top:359.34px" class="cls_014"><span class="cls_014">[34]</span></div>
<div style="position:absolute;left:81.96px;top:359.34px" class="cls_014"><span class="cls_014">The Unicode Consortium. The Unicode Standard, Version 4.0. Addison-Wesley, 2003.</span></div>
<div style="position:absolute;left:63.70px;top:372.44px" class="cls_014"><span class="cls_014">[35]</span></div>
<div style="position:absolute;left:81.96px;top:372.44px" class="cls_014"><span class="cls_014">Stephen A. Cook.  The complexity of theorem-proving procedures.  In STOC ’71: Proceedings of the</span></div>
<div style="position:absolute;left:81.96px;top:381.91px" class="cls_014"><span class="cls_014">third annual ACM symposium on Theory of computing, pages 151-158, New York, NY, USA, 1971. ACM</span></div>
<div style="position:absolute;left:81.96px;top:391.37px" class="cls_014"><span class="cls_014">Press.</span></div>
<div style="position:absolute;left:63.70px;top:404.47px" class="cls_014"><span class="cls_014">[36]</span></div>
<div style="position:absolute;left:81.96px;top:404.47px" class="cls_014"><span class="cls_014">Thomas H. Cormen, Charles E. Leiserson, and Ronald L. Rivest. Introduction to Algorithms. MIT Press,</span></div>
<div style="position:absolute;left:81.96px;top:413.94px" class="cls_014"><span class="cls_014">1990.</span></div>
<div style="position:absolute;left:63.70px;top:427.04px" class="cls_014"><span class="cls_014">[37]</span></div>
<div style="position:absolute;left:81.96px;top:427.04px" class="cls_014"><span class="cls_014">Intel Corporation.  IA-32 Intel Architecture Software Developer’s Manual, volume 2B—Instruction Set</span></div>
<div style="position:absolute;left:81.96px;top:436.51px" class="cls_014"><span class="cls_014">Reference, N-Z. Intel Corporation, June 2005. Order number 253667-016.</span></div>
<div style="position:absolute;left:63.70px;top:449.61px" class="cls_014"><span class="cls_014">[38]</span></div>
<div style="position:absolute;left:81.96px;top:449.61px" class="cls_014"><span class="cls_014">Microsoft Corporation. Joliet specification — version 1, May 1995.</span></div>
<div style="position:absolute;left:63.70px;top:462.71px" class="cls_014"><span class="cls_014">[39]</span></div>
<div style="position:absolute;left:81.96px;top:462.71px" class="cls_014"><span class="cls_014">Microsoft Corporation. Binary delta compression. Whitepaper, March 2002.</span></div>
<div style="position:absolute;left:63.70px;top:475.82px" class="cls_014"><span class="cls_014">[40]</span></div>
<div style="position:absolute;left:81.96px;top:475.82px" class="cls_014"><span class="cls_014">Krzysztof Czarnecki and Ulrich Eisenecker. Generative Programming: Methods, Tools, and Applications.</span></div>
<div style="position:absolute;left:81.96px;top:485.28px" class="cls_014"><span class="cls_014">Addison-Wesley, 2000.</span></div>
<div style="position:absolute;left:63.70px;top:498.38px" class="cls_014"><span class="cls_014">[41]</span></div>
<div style="position:absolute;left:81.96px;top:498.38px" class="cls_014"><span class="cls_014">Homayoun Dayani-Fard, Yijun Yu, John Mylopoulos, and Periklis Andritsos. Improving the build archi-</span></div>
<div style="position:absolute;left:81.96px;top:507.85px" class="cls_014"><span class="cls_014">tecture of legacy C/C++ software systems. In Maura Cerioli, editor, Fundamental Approaches to Software</span></div>
<div style="position:absolute;left:81.96px;top:517.31px" class="cls_014"><span class="cls_014">Engineering:</span></div>
<div style="position:absolute;left:128.51px;top:517.31px" class="cls_014"><span class="cls_014">8th International Conference (FASE 2005), volume 3443 of Lecture Notes in Computer</span></div>
<div style="position:absolute;left:81.96px;top:526.78px" class="cls_014"><span class="cls_014">Science, pages 96-110, Edinburgh, Scotland, April 2005. Springer-Verlag.</span></div>
<div style="position:absolute;left:63.70px;top:539.88px" class="cls_014"><span class="cls_014">[42]</span></div>
<div style="position:absolute;left:81.96px;top:539.88px" class="cls_014"><span class="cls_014">Merijn de Jonge. To Reuse or To Be Reused. PhD thesis, University of Amsterdam, March 2003.</span></div>
<div style="position:absolute;left:63.70px;top:552.98px" class="cls_014"><span class="cls_014">[43]</span></div>
<div style="position:absolute;left:81.96px;top:552.98px" class="cls_014"><span class="cls_014">Merijn de Jonge. Build-level components. IEEE Transactions on Software Engineering, 31(7):588-600,</span></div>
<div style="position:absolute;left:81.96px;top:562.45px" class="cls_014"><span class="cls_014">July 2005.</span></div>
<div style="position:absolute;left:63.70px;top:575.55px" class="cls_014"><span class="cls_014">[44]</span></div>
<div style="position:absolute;left:81.96px;top:575.55px" class="cls_014"><span class="cls_014">Edsger W. Dijkstra.  Notes on structured programming.  Technical Report 70-WSK-03, Technische</span></div>
<div style="position:absolute;left:81.96px;top:585.01px" class="cls_014"><span class="cls_014">Hogeschool Eindhoven, March 1970.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">252</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:176640px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background261.jpg" width=481 height=680></div>
<div style="position:absolute;left:369.64px;top:17.14px" class="cls_004"><span class="cls_004">Bibliography</span></div>
<div style="position:absolute;left:67.86px;top:47.03px" class="cls_014"><span class="cls_014">[45]</span></div>
<div style="position:absolute;left:86.12px;top:47.03px" class="cls_014"><span class="cls_014">Jeff Dike.  A user-mode port of the Linux kernel.  In 4th Annual Linux Showcase & Conference (ALS</span></div>
<div style="position:absolute;left:86.12px;top:56.50px" class="cls_014"><span class="cls_014">2000), October 2000.</span></div>
<div style="position:absolute;left:67.86px;top:69.87px" class="cls_014"><span class="cls_014">[46]</span></div>
<div style="position:absolute;left:86.12px;top:69.87px" class="cls_014"><span class="cls_014">Eelco Dolstra.  Integrating software construction and software deployment.  In Bernhard Westfechtel,</span></div>
<div style="position:absolute;left:86.12px;top:79.33px" class="cls_014"><span class="cls_014">editor, 11th International Workshop on Software Configuration Management (SCM-11), volume 2649 of</span></div>
<div style="position:absolute;left:86.12px;top:88.80px" class="cls_014"><span class="cls_014">Lecture Notes in Computer Science, pages 102-117, Portland, Oregon, USA, May 2003. Springer-Verlag.</span></div>
<div style="position:absolute;left:67.86px;top:102.17px" class="cls_014"><span class="cls_014">[47]</span></div>
<div style="position:absolute;left:86.12px;top:102.17px" class="cls_014"><span class="cls_014">Eelco Dolstra. Efficient upgrading in a purely functional component deployment model. In George Heine-</span></div>
<div style="position:absolute;left:86.12px;top:111.63px" class="cls_014"><span class="cls_014">man et al., editor, Eighth International SIGSOFT Symposium on Component-based Software Engineering</span></div>
<div style="position:absolute;left:86.12px;top:121.10px" class="cls_014"><span class="cls_014">(CBSE 2005), volume 3489 of Lecture Notes in Computer Science, pages 219-234, St. Louis, Missouri,</span></div>
<div style="position:absolute;left:86.12px;top:130.56px" class="cls_014"><span class="cls_014">USA, May 2005. Springer-Verlag.</span></div>
<div style="position:absolute;left:67.86px;top:143.93px" class="cls_014"><span class="cls_014">[48]</span></div>
<div style="position:absolute;left:86.12px;top:143.93px" class="cls_014"><span class="cls_014">Eelco Dolstra. Secure sharing between untrusted users in a transparent source/binary deployment model.</span></div>
<div style="position:absolute;left:86.12px;top:153.40px" class="cls_014"><span class="cls_014">In 20th IEEE/ACM International Conference on Automated Software Engineering (ASE 2005), pages 154-</span></div>
<div style="position:absolute;left:86.12px;top:162.86px" class="cls_014"><span class="cls_014">163, Long Beach, California, USA, November 2005.</span></div>
<div style="position:absolute;left:67.86px;top:176.23px" class="cls_014"><span class="cls_014">[49]</span></div>
<div style="position:absolute;left:86.12px;top:176.23px" class="cls_014"><span class="cls_014">Eelco Dolstra, Martin Bravenboer, and Eelco Visser. Service configuration management. In 12th Interna-</span></div>
<div style="position:absolute;left:86.12px;top:185.70px" class="cls_014"><span class="cls_014">tional Workshop on Software Configuration Management (SCM-12), September 2005.</span></div>
<div style="position:absolute;left:67.86px;top:199.07px" class="cls_014"><span class="cls_014">[50]</span></div>
<div style="position:absolute;left:86.12px;top:199.07px" class="cls_014"><span class="cls_014">Eelco Dolstra, Merijn de Jonge, and Eelco Visser.  Nix:  A safe and policy-free system for software</span></div>
<div style="position:absolute;left:86.12px;top:208.53px" class="cls_014"><span class="cls_014">deployment.  In Lee Damon, editor, 18th Large Installation System Administration Conference (LISA</span></div>
<div style="position:absolute;left:86.12px;top:218.00px" class="cls_014"><span class="cls_014">’04), pages 79-92, Atlanta, Georgia, USA, November 2004. USENIX.</span></div>
<div style="position:absolute;left:67.86px;top:231.37px" class="cls_014"><span class="cls_014">[51]</span></div>
<div style="position:absolute;left:86.12px;top:231.37px" class="cls_014"><span class="cls_014">Eelco Dolstra and Eelco Visser. Building interpreters with rewriting strategies. In Mark van den Brand and</span></div>
<div style="position:absolute;left:86.12px;top:240.83px" class="cls_014"><span class="cls_014">Ralf Lämmel, editors, Workshop on Language Descriptions, Tools and Applications (LDTA’02), volume</span></div>
<div style="position:absolute;left:86.12px;top:250.30px" class="cls_014"><span class="cls_014">65/3 of Electronic Notes in Theoretical Computer Science, Grenoble, France, April 2002. Elsevier Science</span></div>
<div style="position:absolute;left:86.12px;top:259.76px" class="cls_014"><span class="cls_014">Publishers.</span></div>
<div style="position:absolute;left:67.86px;top:273.13px" class="cls_014"><span class="cls_014">[52]</span></div>
<div style="position:absolute;left:86.12px;top:273.13px" class="cls_014"><span class="cls_014">Eelco Dolstra, Eelco Visser, and Merijn de Jonge. Imposing a memory management discipline on software</span></div>
<div style="position:absolute;left:86.12px;top:282.60px" class="cls_014"><span class="cls_014">deployment. In Proceedings of the 26th International Conference on Software Engineering (ICSE 2004),</span></div>
<div style="position:absolute;left:86.12px;top:292.06px" class="cls_014"><span class="cls_014">pages 583-592. IEEE Computer Society, May 2004.</span></div>
<div style="position:absolute;left:67.86px;top:305.43px" class="cls_014"><span class="cls_014">[53]</span></div>
<div style="position:absolute;left:86.12px;top:305.43px" class="cls_014"><span class="cls_014">ECMA. ECMA-48: Control Functions for Coded Character Sets. ECMA, fifth edition, June 1991. Also</span></div>
<div style="position:absolute;left:86.12px;top:314.90px" class="cls_014"><span class="cls_014">ISO/IEC 6429:1992.</span></div>
<div style="position:absolute;left:67.86px;top:328.27px" class="cls_014"><span class="cls_014">[54]</span></div>
<div style="position:absolute;left:86.12px;top:328.27px" class="cls_014"><span class="cls_014">John Ellson, Emden R. Gansner, Eleftherios Koutsofios, Stephen C. North, and Gordon Woodhull.</span></div>
<div style="position:absolute;left:86.12px;top:337.73px" class="cls_014"><span class="cls_014">Graphviz — open source graph drawing tools. In Graph Drawing 2001, number 2265 in Lecture Notes in</span></div>
<div style="position:absolute;left:86.12px;top:347.20px" class="cls_014"><span class="cls_014">Computer Science, pages 483-485. Springer-Verlag, 2001.</span></div>
<div style="position:absolute;left:67.86px;top:360.57px" class="cls_014"><span class="cls_014">[55]</span></div>
<div style="position:absolute;left:86.12px;top:360.57px" class="cls_014"><span class="cls_014">Robert Ennals and Simon Peyton Jones. HsDebug: debugging lazy programs by not being lazy. In Johan</span></div>
<div style="position:absolute;left:86.12px;top:370.03px" class="cls_014"><span class="cls_014">Jeuring, editor, Proceedings of the ACM SIGPLAN workshop on Haskell, pages 84-87, Uppsala, Sweden,</span></div>
<div style="position:absolute;left:86.12px;top:379.50px" class="cls_014"><span class="cls_014">August 2003. ACM Press.</span></div>
<div style="position:absolute;left:67.86px;top:392.87px" class="cls_014"><span class="cls_014">[56]</span></div>
<div style="position:absolute;left:86.12px;top:392.87px" class="cls_014"><span class="cls_014">Stuart I. Feldman. Make—a program for maintaining computer programs. Software—Practice and Expe-</span></div>
<div style="position:absolute;left:86.12px;top:402.33px" class="cls_014"><span class="cls_014">rience, 9(4):255-65, 1979.</span></div>
<div style="position:absolute;left:67.86px;top:415.70px" class="cls_014"><span class="cls_014">[57]</span></div>
<div style="position:absolute;left:86.12px;top:415.70px" class="cls_014"><span class="cls_014">Roy T. Fielding, James Gettys, Jeffrey C. Mogul, Henrik Frystyk Nielsen, Larry Masinter, Paul J. Leach,</span></div>
<div style="position:absolute;left:86.12px;top:425.17px" class="cls_014"><span class="cls_014">and Tim Berners-Lee. Hypertext transfer protocol — HTTP/1.1. RFC 2616, June 1999.</span></div>
<div style="position:absolute;left:67.86px;top:438.54px" class="cls_014"><span class="cls_014">[58]</span></div>
<div style="position:absolute;left:86.12px;top:438.54px" class="cls_014"><span class="cls_014">Gert Florijn, Ernst Lippe, Atze Dijkstra, Norbert van Oosterom, and Doaitse Swierstra.  Camera: Co-</span></div>
<div style="position:absolute;left:86.12px;top:448.00px" class="cls_014"><span class="cls_014">operation in open distributed environments.  In Proceedings of the EurOpen and USENIX Spring 1992</span></div>
<div style="position:absolute;left:86.12px;top:457.47px" class="cls_014"><span class="cls_014">Workshop/Conference, pages 123-136. EurOpen and USENIX, April 1992.</span></div>
<div style="position:absolute;left:67.86px;top:470.84px" class="cls_014"><span class="cls_014">[59]</span></div>
<div style="position:absolute;left:86.12px;top:470.84px" class="cls_014"><span class="cls_014">Gert Florijn, Leo Soepenberg, and Atze Dijkstra. Mapping objects to files: a UNIX file system interface</span></div>
<div style="position:absolute;left:86.12px;top:480.30px" class="cls_014"><span class="cls_014">to an object management system. In H. Wijshoff, editor, Proceedings Computing Science in the Nether-</span></div>
<div style="position:absolute;left:86.12px;top:489.77px" class="cls_014"><span class="cls_014">lands (CSN’93), 1993. Also published as Utrecht University, Department of Information and Computing</span></div>
<div style="position:absolute;left:86.12px;top:499.23px" class="cls_014"><span class="cls_014">Sciences technical report RUU-CS-93-08.</span></div>
<div style="position:absolute;left:67.86px;top:512.60px" class="cls_014"><span class="cls_014">[60]</span></div>
<div style="position:absolute;left:86.12px;top:512.60px" class="cls_014"><span class="cls_014">Karl Fogel and Moshe Bar. Open Source Development with CVS. Paraglyph Press, July 2003.</span></div>
<div style="position:absolute;left:67.86px;top:525.97px" class="cls_014"><span class="cls_014">[61]</span></div>
<div style="position:absolute;left:86.12px;top:525.97px" class="cls_014"><span class="cls_014">Internet Engineering Task Force.  Secure shell (secsh) working group.</span><span class="cls_016">  <A HREF="http://www.ietf.org/html.charters/secsh-charter.html">http://www.ietf.org/html.charters/</A> </span></div>
<div style="position:absolute;left:86.12px;top:535.44px" class="cls_016"><span class="cls_016">secsh-charter.html</span><span class="cls_014">, 2005. Accessed 21 August 2005.</span></div>
<div style="position:absolute;left:67.86px;top:548.81px" class="cls_014"><span class="cls_014">[62]</span></div>
<div style="position:absolute;left:86.12px;top:548.81px" class="cls_014"><span class="cls_014">Eric Foster-Johnson. Red Hat RPM Guide. John Wiley & Sons, 2003. Also at</span><span class="cls_016"> <A HREF="http://fedora.redhat.com/">http://fedora.redhat.com/</A> </span></div>
<div style="position:absolute;left:86.12px;top:558.27px" class="cls_016"><span class="cls_016">docs/drafts/rpm-guide-en/</span><span class="cls_014">.</span></div>
<div style="position:absolute;left:67.86px;top:571.64px" class="cls_014"><span class="cls_014">[63]</span></div>
<div style="position:absolute;left:86.12px;top:571.64px" class="cls_014"><span class="cls_014">Apache Software Foundation. Apache Ant.</span><span class="cls_016"> <A HREF="http://ant.apache.org/">http://ant.apache.org/</A> </span><span class="cls_014">, 2005. Accessed 15 August 2005.</span></div>
<div style="position:absolute;left:67.86px;top:585.01px" class="cls_014"><span class="cls_014">[64]</span></div>
<div style="position:absolute;left:86.12px;top:585.01px" class="cls_014"><span class="cls_014">Free Software Foundation. Autoconf.</span><span class="cls_016"> <A HREF="http://www.gnu.org/software/autoconf/">http://www.gnu.org/software/autoconf/</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">253</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:177330px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background262.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">Bibliography</span></div>
<div style="position:absolute;left:63.70px;top:47.03px" class="cls_014"><span class="cls_014">[65]</span></div>
<div style="position:absolute;left:81.96px;top:47.03px" class="cls_014"><span class="cls_014">Free Software Foundation. Automake.</span><span class="cls_016"> <A HREF="http://www.gnu.org/software/automake/">http://www.gnu.org/software/automake/</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:63.70px;top:60.30px" class="cls_014"><span class="cls_014">[66]</span></div>
<div style="position:absolute;left:81.96px;top:60.30px" class="cls_014"><span class="cls_014">Free Software Foundation. Bison.</span><span class="cls_016"> <A HREF="http://www.gnu.org/software/bison/">http://www.gnu.org/software/bison/</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:63.70px;top:73.56px" class="cls_014"><span class="cls_014">[67]</span></div>
<div style="position:absolute;left:81.96px;top:73.56px" class="cls_014"><span class="cls_014">Free Software Foundation. GNU Hello.</span><span class="cls_016"> <A HREF="http://www.gnu.org/software/hello/">http://www.gnu.org/software/hello/</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:63.70px;top:86.83px" class="cls_014"><span class="cls_014">[68]</span></div>
<div style="position:absolute;left:81.96px;top:86.83px" class="cls_014"><span class="cls_014">Free Software Foundation. GNU Make.</span><span class="cls_016"> <A HREF="http://www.gnu.org/software/make/">http://www.gnu.org/software/make/</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:63.70px;top:100.09px" class="cls_014"><span class="cls_014">[69]</span></div>
<div style="position:absolute;left:81.96px;top:100.09px" class="cls_014"><span class="cls_014">Mozilla Foundation. Tinderbox.</span><span class="cls_016"> <A HREF="http://www.mozilla.org/tinderbox.html">http://www.mozilla.org/tinderbox.html</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:63.70px;top:113.36px" class="cls_014"><span class="cls_014">[70]</span></div>
<div style="position:absolute;left:81.96px;top:113.36px" class="cls_014"><span class="cls_014">Glenn Fowler. The fourth generation Make. In USENIX 1985 Summer Conference, June 1985.</span></div>
<div style="position:absolute;left:63.70px;top:126.62px" class="cls_014"><span class="cls_014">[71]</span></div>
<div style="position:absolute;left:81.96px;top:126.62px" class="cls_014"><span class="cls_014">Glenn Fowler. A case for</span><span class="cls_016"> make</span><span class="cls_014">. Software—Practice and Experience, 20(S1):S1/35-S1/46, 1990.</span></div>
<div style="position:absolute;left:63.70px;top:139.89px" class="cls_014"><span class="cls_014">[72]</span></div>
<div style="position:absolute;left:81.96px;top:139.89px" class="cls_014"><span class="cls_014">Martin Fowler and Matthew Foemmel.  Continuous integration.</span><span class="cls_016">  <A HREF="http://www.martinfowler.com/articles/">http://www.martinfowler.com/articles/</A> </span></div>
<div style="position:absolute;left:81.96px;top:149.35px" class="cls_016"><span class="cls_016">continuousIntegration.html</span><span class="cls_014">. Accessed 11 August 2005.</span></div>
<div style="position:absolute;left:63.70px;top:162.62px" class="cls_014"><span class="cls_014">[73]</span></div>
<div style="position:absolute;left:81.96px;top:162.62px" class="cls_014"><span class="cls_014">FreeBSD Project. FreeBSD Ports Collection.</span><span class="cls_016"> http://www.freebsd.org/ports/</span><span class="cls_014">.</span></div>
<div style="position:absolute;left:63.70px;top:175.88px" class="cls_014"><span class="cls_014">[74]</span></div>
<div style="position:absolute;left:81.96px;top:175.88px" class="cls_014"><span class="cls_014">Ned Freed and Nathaniel S. Borenstein. Multipurpose internet mail extensions (MIME) part two: Media</span></div>
<div style="position:absolute;left:81.96px;top:185.35px" class="cls_014"><span class="cls_014">types. RFC 2046, November 1996.</span></div>
<div style="position:absolute;left:63.70px;top:198.61px" class="cls_014"><span class="cls_014">[75]</span></div>
<div style="position:absolute;left:81.96px;top:198.61px" class="cls_014"><span class="cls_014">freedesktop.org. pkg-config.</span><span class="cls_016"> <A HREF="http://pkgconfig.freedesktop.org/wiki/">http://pkgconfig.freedesktop.org/wiki/</A> </span><span class="cls_014">, 2005. Accessed 21 August 2005.</span></div>
<div style="position:absolute;left:63.70px;top:211.88px" class="cls_014"><span class="cls_014">[76]</span></div>
<div style="position:absolute;left:81.96px;top:211.88px" class="cls_014"><span class="cls_014">Alan O. Freier, Philip L. Karlton, and Paul C. Kocher. The SSL protocol — version 3.0. IETF Internet</span></div>
<div style="position:absolute;left:81.96px;top:221.34px" class="cls_014"><span class="cls_014">Draft</span><span class="cls_016"> draft-freier-ssl-version3-02.txt</span><span class="cls_014">, November 1996.</span></div>
<div style="position:absolute;left:63.70px;top:234.61px" class="cls_014"><span class="cls_014">[77]</span></div>
<div style="position:absolute;left:81.96px;top:234.61px" class="cls_014"><span class="cls_014">Gentoo Foundation. Gentoo Linux.</span><span class="cls_016"> http://www.gentoo.org/</span><span class="cls_014">.</span></div>
<div style="position:absolute;left:63.70px;top:247.87px" class="cls_014"><span class="cls_014">[78]</span></div>
<div style="position:absolute;left:81.96px;top:247.87px" class="cls_014"><span class="cls_014">Bob Glickstein. GNU Stow.</span><span class="cls_016"> <A HREF="http://www.gnu.org/software/stow/">http://www.gnu.org/software/stow/</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:63.70px;top:261.14px" class="cls_014"><span class="cls_014">[79]</span></div>
<div style="position:absolute;left:81.96px;top:261.14px" class="cls_014"><span class="cls_014">James Gosling, Bill Joy, Guy Steele, and Gilad Bracha.  The Java Language Specification.  Addison-</span></div>
<div style="position:absolute;left:81.96px;top:270.60px" class="cls_014"><span class="cls_014">Wesley, third edition, June 2005.</span></div>
<div style="position:absolute;left:63.70px;top:283.87px" class="cls_014"><span class="cls_014">[80]</span></div>
<div style="position:absolute;left:81.96px;top:283.87px" class="cls_014"><span class="cls_014">Mark Grechanik and Dewayne Perry.  Secure deployment of components.  In Wolfgang Emmerich and</span></div>
<div style="position:absolute;left:81.96px;top:293.33px" class="cls_014"><span class="cls_014">Alexander L. Wolf, editors, 2nd International Working Conference on Component Deployment (CD 2004),</span></div>
<div style="position:absolute;left:81.96px;top:302.80px" class="cls_014"><span class="cls_014">volume 3083 of Lecture Notes in Computer Science. Springer-Verlag, May 2004.</span></div>
<div style="position:absolute;left:63.70px;top:316.06px" class="cls_014"><span class="cls_014">[81]</span></div>
<div style="position:absolute;left:81.96px;top:316.06px" class="cls_014"><span class="cls_014">Filesystem Hierarchy Standard Group. Filesystem hierarchy standard, version 2.3.</span><span class="cls_016"> <A HREF="http://www.pathname.com/fhs/pub/fhs-2.3.html">http://www.pathname.</A> </span></div>
<div style="position:absolute;left:81.96px;top:325.52px" class="cls_016"><span class="cls_016">com/fhs/pub/fhs-2.3.html</span><span class="cls_014">, 2004.</span></div>
<div style="position:absolute;left:63.70px;top:338.79px" class="cls_014"><span class="cls_014">[82]</span></div>
<div style="position:absolute;left:81.96px;top:338.79px" class="cls_014"><span class="cls_014">Free Standards Group. Linux Standard Base Core Specification 3.0.</span><span class="cls_016"> <A HREF="http://www.linuxbase.org/">http://www.linuxbase.org/</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:63.70px;top:352.05px" class="cls_014"><span class="cls_014">[83]</span></div>
<div style="position:absolute;left:81.96px;top:352.05px" class="cls_014"><span class="cls_014">Nicholas Gulrajani and Karen Wade.  Bridging the chasm between development and operations.  Prod-</span></div>
<div style="position:absolute;left:81.96px;top:361.52px" class="cls_014"><span class="cls_014">uct white paper,</span><span class="cls_016"> ftp://ftp.software.ibm.com/software/rational/web/whitepapers/2003/Bridging_the_chasm_</span></div>
<div style="position:absolute;left:81.96px;top:370.98px" class="cls_016"><span class="cls_016">CC-TCM.pdf</span><span class="cls_014">, June 2004.</span></div>
<div style="position:absolute;left:63.70px;top:384.25px" class="cls_014"><span class="cls_014">[84]</span></div>
<div style="position:absolute;left:81.96px;top:384.25px" class="cls_014"><span class="cls_014">Richard S. Hall, Dennis Heimbigner, André van der Hoek, and Alexander L. Wolf. An architecture for</span></div>
<div style="position:absolute;left:81.96px;top:393.71px" class="cls_014"><span class="cls_014">post-development configuration management in a wide area network. In Proceedings of the 17th Interna-</span></div>
<div style="position:absolute;left:81.96px;top:403.18px" class="cls_014"><span class="cls_014">tional Conference on Distributed Computing Systems, Baltimore, Maryland, USA, May 1997.</span></div>
<div style="position:absolute;left:63.70px;top:416.44px" class="cls_014"><span class="cls_014">[85]</span></div>
<div style="position:absolute;left:81.96px;top:416.44px" class="cls_014"><span class="cls_014">Richard S. Hall, Dennis Heimbigner, and Alexander L. Wolf. A cooperative approach to support software</span></div>
<div style="position:absolute;left:81.96px;top:425.91px" class="cls_014"><span class="cls_014">deployment using the Software Dock. In ICSE ’99: Proceedings of the 21st International Conference on</span></div>
<div style="position:absolute;left:81.96px;top:435.37px" class="cls_014"><span class="cls_014">Software Engineering, pages 174-183, Los Alamitos, CA, USA, 1999. IEEE Computer Society Press.</span></div>
<div style="position:absolute;left:63.70px;top:448.64px" class="cls_014"><span class="cls_014">[86]</span></div>
<div style="position:absolute;left:81.96px;top:448.64px" class="cls_014"><span class="cls_014">Richard S. Hall, Dennis M. Heimbigner, and Alexander L. Wolf. Requirements for software deployment</span></div>
<div style="position:absolute;left:81.96px;top:458.10px" class="cls_014"><span class="cls_014">languages and schema. In 8th International Symposium on System Configuration Management (SCM-8),</span></div>
<div style="position:absolute;left:81.96px;top:467.57px" class="cls_014"><span class="cls_014">volume 1439 of Lecture Notes in Computer Science, pages 198-203. Springer-Verlag, 1998.</span></div>
<div style="position:absolute;left:63.70px;top:480.83px" class="cls_014"><span class="cls_014">[87]</span></div>
<div style="position:absolute;left:81.96px;top:480.83px" class="cls_014"><span class="cls_014">John Hart and Jeffrey D’Amelia. An analysis of RPM validation drift. In Proceedings of the 16th Systems</span></div>
<div style="position:absolute;left:81.96px;top:490.30px" class="cls_014"><span class="cls_014">Administration Conference (LISA ’02), pages 155-166. USENIX Association, November 2002.</span></div>
<div style="position:absolute;left:63.70px;top:503.56px" class="cls_014"><span class="cls_014">[88]</span></div>
<div style="position:absolute;left:81.96px;top:503.56px" class="cls_014"><span class="cls_014">Red Hat. Cygwin.</span><span class="cls_016"> <A HREF="http://www.cygwin.com/">http://www.cygwin.com/</A> </span><span class="cls_014">, 2005. Accessed 21 August 2005.</span></div>
<div style="position:absolute;left:63.70px;top:516.83px" class="cls_014"><span class="cls_014">[89]</span></div>
<div style="position:absolute;left:81.96px;top:516.83px" class="cls_014"><span class="cls_014">Les Hatton.  Reexamining the fault density-component size connection.  IEEE Software, 14(2):89-97,</span></div>
<div style="position:absolute;left:81.96px;top:526.29px" class="cls_014"><span class="cls_014">1997.</span></div>
<div style="position:absolute;left:63.70px;top:539.56px" class="cls_014"><span class="cls_014">[90]</span></div>
<div style="position:absolute;left:81.96px;top:539.56px" class="cls_014"><span class="cls_014">Jan Heering, Paul R. H. Hendriks, Paul Klint, and Jan Rekers. The syntax definition formalism SDF —</span></div>
<div style="position:absolute;left:81.96px;top:549.02px" class="cls_014"><span class="cls_014">reference manual. SIGPLAN Notices, 24(11):43-75, 1989.</span></div>
<div style="position:absolute;left:63.70px;top:562.28px" class="cls_014"><span class="cls_014">[91]</span></div>
<div style="position:absolute;left:81.96px;top:562.28px" class="cls_014"><span class="cls_014">Armijn Hemel. Using buildfarms to improve code. In UKUUG Linux 2003 Conference, August 2003.</span></div>
<div style="position:absolute;left:63.70px;top:575.55px" class="cls_014"><span class="cls_014">[92]</span></div>
<div style="position:absolute;left:81.96px;top:575.55px" class="cls_014"><span class="cls_014">Allan Heydon, Roy Levin, Timothy Mann, and Yuan Yu. The Vesta approach to software configuration</span></div>
<div style="position:absolute;left:81.96px;top:585.01px" class="cls_014"><span class="cls_014">management. Technical Report Research Report 168, Compaq Systems Research Center, March 2001.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">254</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:178020px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background263.jpg" width=481 height=680></div>
<div style="position:absolute;left:369.64px;top:17.14px" class="cls_004"><span class="cls_004">Bibliography</span></div>
<div style="position:absolute;left:67.86px;top:47.03px" class="cls_014"><span class="cls_014">[93]</span></div>
<div style="position:absolute;left:86.12px;top:47.03px" class="cls_014"><span class="cls_014">Allan Heydon, Roy Levin, Timothy Mann, and Yuan Yu. The Vesta software configuration management</span></div>
<div style="position:absolute;left:86.12px;top:56.50px" class="cls_014"><span class="cls_014">system. Technical Report Research Report 177, Compaq Systems Research Center, January 2002.</span></div>
<div style="position:absolute;left:67.86px;top:69.84px" class="cls_014"><span class="cls_014">[94]</span></div>
<div style="position:absolute;left:86.12px;top:69.84px" class="cls_014"><span class="cls_014">Allan Heydon, Roy Levin, and Yuan Yu.  Caching function calls using precise dependencies.  In ACM</span></div>
<div style="position:absolute;left:86.12px;top:79.31px" class="cls_014"><span class="cls_014">SIGPLAN ’00 Conference on Programming Language Design and Implementation, pages 311-320. ACM</span></div>
<div style="position:absolute;left:86.12px;top:88.77px" class="cls_014"><span class="cls_014">Press, 2000.</span></div>
<div style="position:absolute;left:67.86px;top:102.12px" class="cls_014"><span class="cls_014">[95]</span></div>
<div style="position:absolute;left:86.12px;top:102.12px" class="cls_014"><span class="cls_014">Graydon Hoare. Monotone.</span><span class="cls_016"> <A HREF="http://www.venge.net/monotone/">http://www.venge.net/monotone/</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:67.86px;top:115.46px" class="cls_014"><span class="cls_014">[96]</span></div>
<div style="position:absolute;left:86.12px;top:115.46px" class="cls_014"><span class="cls_014">Andrew Hume. Mk: a successor to make. In USENIX 1987 Summer Conference, 1987.</span></div>
<div style="position:absolute;left:67.86px;top:128.81px" class="cls_014"><span class="cls_014">[97]</span></div>
<div style="position:absolute;left:86.12px;top:128.81px" class="cls_014"><span class="cls_014">James J. Hunt, Kiem-Phong Vo, and Walter F. Tichy.  Delta algorithms: An empirical analysis.  ACM</span></div>
<div style="position:absolute;left:86.12px;top:138.27px" class="cls_014"><span class="cls_014">Transactions on Software Engineering and Methodology, 7(2):192-214, 1998.</span></div>
<div style="position:absolute;left:67.86px;top:151.62px" class="cls_014"><span class="cls_014">[98]</span></div>
<div style="position:absolute;left:86.12px;top:151.62px" class="cls_014"><span class="cls_014">IEEE. IEEE Std 1003.1-1988 Standard Portable Operating System Interface for Computer Environments</span></div>
<div style="position:absolute;left:86.12px;top:161.08px" class="cls_014"><span class="cls_014">(POSIX). IEEE, 1988.</span></div>
<div style="position:absolute;left:67.86px;top:174.43px" class="cls_014"><span class="cls_014">[99]</span></div>
<div style="position:absolute;left:86.12px;top:174.43px" class="cls_014"><span class="cls_014">IEEE and The Open Group.  The Open Group Base Specifications Issue 6 — IEEE Std 1003.1, 2004</span></div>
<div style="position:absolute;left:86.12px;top:183.89px" class="cls_014"><span class="cls_014">Edition. </span><A HREF="http://www.opengroup.org/onlinepubs/009695399/">http://www.opengroup.org/onlinepubs/009695399/</A>, 2004.</div>
<div style="position:absolute;left:63.87px;top:197.24px" class="cls_014"><span class="cls_014">[100]</span></div>
<div style="position:absolute;left:86.12px;top:197.24px" class="cls_014"><span class="cls_014">British Standards Institute. The C Standard: Incorporating Technical Corrigendum 1. Wiley, July 2003.</span></div>
<div style="position:absolute;left:63.87px;top:210.59px" class="cls_014"><span class="cls_014">[101]</span></div>
<div style="position:absolute;left:86.12px;top:210.59px" class="cls_014"><span class="cls_014">British Standards Institute.  The C++ Standard: Incorporating Technical Corrigendum No. 1.  Wiley,</span></div>
<div style="position:absolute;left:86.12px;top:220.05px" class="cls_014"><span class="cls_014">October 2003.</span></div>
<div style="position:absolute;left:63.87px;top:233.40px" class="cls_014"><span class="cls_014">[102]</span></div>
<div style="position:absolute;left:86.12px;top:233.40px" class="cls_014"><span class="cls_014">Slinger Jansen, Gerco Ballintijn, and Sjaak Brinkkemper. A process model and typology for software prod-</span></div>
<div style="position:absolute;left:86.12px;top:242.86px" class="cls_014"><span class="cls_014">uct updaters.  In 9th European Conference on Software Maintenance and Reengineering (CSMR 2005),</span></div>
<div style="position:absolute;left:86.12px;top:252.32px" class="cls_014"><span class="cls_014">March 2005.</span></div>
<div style="position:absolute;left:63.87px;top:265.67px" class="cls_014"><span class="cls_014">[103]</span></div>
<div style="position:absolute;left:86.12px;top:265.67px" class="cls_014"><span class="cls_014">Steven C. Johnson. Yacc: Yet Another Compiler Compiler. In UNIX Programmer’s Manual, volume 2,</span></div>
<div style="position:absolute;left:86.12px;top:275.13px" class="cls_014"><span class="cls_014">pages 353-387. Holt, Rinehart, and Winston, New York, NY, USA, 1979.</span></div>
<div style="position:absolute;left:63.87px;top:288.48px" class="cls_014"><span class="cls_014">[104]</span></div>
<div style="position:absolute;left:86.12px;top:288.48px" class="cls_014"><span class="cls_014">Richard Jones and Rafael Lins. Garbage Collection: Algorithms for Automatic Dynamic Memory Man-</span></div>
<div style="position:absolute;left:86.12px;top:297.95px" class="cls_014"><span class="cls_014">agement. John Wiley & Sons, August 1996.</span></div>
<div style="position:absolute;left:63.87px;top:311.29px" class="cls_014"><span class="cls_014">[105]</span></div>
<div style="position:absolute;left:86.12px;top:311.29px" class="cls_014"><span class="cls_014">Dan Kaminsky.  MD5 to be considered harmful someday.</span><span class="cls_016">  <A HREF="http://www.doxpara.com/md5_someday.pdf/">http://www.doxpara.com/md5_someday.pdf</A> </span><span class="cls_014">,</span></div>
<div style="position:absolute;left:86.12px;top:320.76px" class="cls_014"><span class="cls_014">December 2004.</span></div>
<div style="position:absolute;left:63.87px;top:334.10px" class="cls_014"><span class="cls_014">[106]</span></div>
<div style="position:absolute;left:86.12px;top:334.10px" class="cls_014"><span class="cls_014">Brian W. Kernighan and Dennis M. Ritchie. The C Programming Language. Prentice Hall, second edition,</span></div>
<div style="position:absolute;left:86.12px;top:343.57px" class="cls_014"><span class="cls_014">March 1988.</span></div>
<div style="position:absolute;left:63.87px;top:356.91px" class="cls_014"><span class="cls_014">[107]</span></div>
<div style="position:absolute;left:86.12px;top:356.91px" class="cls_014"><span class="cls_014">David G. Korn and Kiem-Phong Vo.  vdelta: Differencing and compression.  In Balachander Krishna-</span></div>
<div style="position:absolute;left:86.12px;top:366.38px" class="cls_014"><span class="cls_014">murthy, editor, Practical Reusable UNIX Software. John Wiley & Sons, 1995.</span></div>
<div style="position:absolute;left:63.87px;top:379.72px" class="cls_014"><span class="cls_014">[108]</span></div>
<div style="position:absolute;left:86.12px;top:379.72px" class="cls_014"><span class="cls_014">N. Jesper Larsson and Kunihiko Sadakane.  Faster suffix sorting.  Technical Report LU-CS-TR-99-214,</span></div>
<div style="position:absolute;left:86.12px;top:389.19px" class="cls_014"><span class="cls_014">Lund University, 1999.</span></div>
<div style="position:absolute;left:63.87px;top:402.53px" class="cls_014"><span class="cls_014">[109]</span></div>
<div style="position:absolute;left:86.12px;top:402.53px" class="cls_014"><span class="cls_014">David B. Leblang.  The CM challenge: configuration management that works.  In W. F. Tichy, editor,</span></div>
<div style="position:absolute;left:86.12px;top:412.00px" class="cls_014"><span class="cls_014">Configuration management, pages 1-37. John Wiley & Sons, New York, NY, USA, 1995.</span></div>
<div style="position:absolute;left:63.87px;top:425.34px" class="cls_014"><span class="cls_014">[110]</span></div>
<div style="position:absolute;left:86.12px;top:425.34px" class="cls_014"><span class="cls_014">Daan Leijen. The λ Abroad: A Functional Approach to Software Components. PhD thesis, Universiteit</span></div>
<div style="position:absolute;left:86.12px;top:434.81px" class="cls_014"><span class="cls_014">Utrecht, November 2003.</span></div>
<div style="position:absolute;left:63.87px;top:448.15px" class="cls_014"><span class="cls_014">[111]</span></div>
<div style="position:absolute;left:86.12px;top:448.15px" class="cls_014"><span class="cls_014">Daan Leijen. Extensible records with scoped labels. In Proceedings of the 2005 Symposium on Trends in</span></div>
<div style="position:absolute;left:86.12px;top:457.62px" class="cls_014"><span class="cls_014">Functional Programming (TFP’05), September 2005.</span></div>
<div style="position:absolute;left:63.87px;top:470.96px" class="cls_014"><span class="cls_014">[112]</span></div>
<div style="position:absolute;left:86.12px;top:470.96px" class="cls_014"><span class="cls_014">Thomas Leonard. The Zero Install system.</span><span class="cls_016"> http://zero-install.sourceforge.net/</span><span class="cls_014">. Accessed 22 July 2005.</span></div>
<div style="position:absolute;left:63.87px;top:484.31px" class="cls_014"><span class="cls_014">[113]</span></div>
<div style="position:absolute;left:86.12px;top:484.31px" class="cls_014"><span class="cls_014">Michael E. Lesk and Eric Schmidt. lex: A lexical analyzer generator. In UNIX Programmer’s Manual,</span></div>
<div style="position:absolute;left:86.12px;top:493.77px" class="cls_014"><span class="cls_014">volume 2, pages 388-400. Holt, Rinehart, and Winston, New York, NY, USA, 1979.</span></div>
<div style="position:absolute;left:63.87px;top:507.12px" class="cls_014"><span class="cls_014">[114]</span></div>
<div style="position:absolute;left:86.12px;top:507.12px" class="cls_014"><span class="cls_014">Ernst Lippe. Camera — Support for Distributed Cooperative Work. PhD thesis, Rijksuniversiteit Utrecht,</span></div>
<div style="position:absolute;left:86.12px;top:516.58px" class="cls_014"><span class="cls_014">October 1992.</span></div>
<div style="position:absolute;left:63.87px;top:529.93px" class="cls_014"><span class="cls_014">[115]</span></div>
<div style="position:absolute;left:86.12px;top:529.93px" class="cls_014"><span class="cls_014">Joshua P. MacDonald. File system support for delta compression. Master’s thesis, Department of Electrical</span></div>
<div style="position:absolute;left:86.12px;top:539.39px" class="cls_014"><span class="cls_014">Engineering and Computer Science, University of California at Berkeley, 2000.</span></div>
<div style="position:absolute;left:63.87px;top:552.74px" class="cls_014"><span class="cls_014">[116]</span></div>
<div style="position:absolute;left:86.12px;top:552.74px" class="cls_014"><span class="cls_014">Kenneth Manheimer, Barry A. Warsaw, Stephen N. Clark, and Walter Rowe. The Depot: A framework for</span></div>
<div style="position:absolute;left:86.12px;top:562.20px" class="cls_014"><span class="cls_014">sharing software installation across organizational and UNIX platform boundaries. In Proceedings of the</span></div>
<div style="position:absolute;left:86.12px;top:571.67px" class="cls_014"><span class="cls_014">4th Systems Administration Conference (LISA ’90), pages 37-46. USENIX Association, October 1990.</span></div>
<div style="position:absolute;left:63.87px;top:585.01px" class="cls_014"><span class="cls_014">[117]</span></div>
<div style="position:absolute;left:86.12px;top:585.01px" class="cls_014"><span class="cls_014">Mauro Marinilli. Java Deployment with JNLP and WebStart. Sams, September 2001.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">255</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:178710px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background264.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">Bibliography</span></div>
<div style="position:absolute;left:59.72px;top:47.03px" class="cls_014"><span class="cls_014">[118]</span></div>
<div style="position:absolute;left:81.96px;top:47.03px" class="cls_014"><span class="cls_014">Steve McConnell. Software Project Survival Guide. Microsoft Press, 1998.</span></div>
<div style="position:absolute;left:59.72px;top:60.08px" class="cls_014"><span class="cls_014">[119]</span></div>
<div style="position:absolute;left:81.96px;top:60.08px" class="cls_014"><span class="cls_014">Bertrand Meyer.  The grand challenge of trusted components.  In Proceedings of the 25th International</span></div>
<div style="position:absolute;left:81.96px;top:69.54px" class="cls_014"><span class="cls_014">Conference on Software Engineering (ICSE 2003), pages 660-667, May 2003.</span></div>
<div style="position:absolute;left:59.72px;top:82.59px" class="cls_014"><span class="cls_014">[120]</span></div>
<div style="position:absolute;left:81.96px;top:82.59px" class="cls_014"><span class="cls_014">Ondrej Mikle.  Practical attacks on digital signatures using MD5 message digest.  Cryptology ePrint</span></div>
<div style="position:absolute;left:81.96px;top:92.06px" class="cls_014"><span class="cls_014">Archive, Report 2004/356, 2004.</span><span class="cls_016"> http://eprint.iacr.org/</span><span class="cls_014">.</span></div>
<div style="position:absolute;left:59.72px;top:105.10px" class="cls_014"><span class="cls_014">[121]</span></div>
<div style="position:absolute;left:81.96px;top:105.10px" class="cls_014"><span class="cls_014">Peter Miller. Recursive make considered harmful.</span><span class="cls_016"> <A HREF="http://aegis.sourceforge.net/auug97.pdf/">http://aegis.sourceforge.net/auug97.pdf</A> </span><span class="cls_014">, 1997. Accessed</span></div>
<div style="position:absolute;left:81.96px;top:114.57px" class="cls_014"><span class="cls_014">12 August 2005.</span></div>
<div style="position:absolute;left:59.72px;top:127.61px" class="cls_014"><span class="cls_014">[122]</span></div>
<div style="position:absolute;left:81.96px;top:127.61px" class="cls_014"><span class="cls_014">Robin Milner. A theory of type polymorphism in programming. Journal of Computer and System Sciences,</span></div>
<div style="position:absolute;left:81.96px;top:137.08px" class="cls_014"><span class="cls_014">17:348-375, August 1978.</span></div>
<div style="position:absolute;left:59.72px;top:150.13px" class="cls_014"><span class="cls_014">[123]</span></div>
<div style="position:absolute;left:81.96px;top:150.13px" class="cls_014"><span class="cls_014">Sape J. Mullender, editor. The Amoeba distributed operating system: selected papers 1984-1987. Num-</span></div>
<div style="position:absolute;left:81.96px;top:159.59px" class="cls_014"><span class="cls_014">ber 41 in CWI tracts. Centrum voor Wiskunde en Informatica, Amsterdam, 1987.</span></div>
<div style="position:absolute;left:59.72px;top:172.64px" class="cls_014"><span class="cls_014">[124]</span></div>
<div style="position:absolute;left:81.96px;top:172.64px" class="cls_014"><span class="cls_014">NCSA.  Common gateway interface, version 1.1.</span><span class="cls_016">  http://hoohoo.ncsa.uiuc.edu/cgi/</span><span class="cls_014">.  Accessed 4 August</span></div>
<div style="position:absolute;left:81.96px;top:182.10px" class="cls_014"><span class="cls_014">2005.</span></div>
<div style="position:absolute;left:59.72px;top:195.15px" class="cls_014"><span class="cls_014">[125]</span></div>
<div style="position:absolute;left:81.96px;top:195.15px" class="cls_014"><span class="cls_014">Tobias Oetiker.  SEPP: Software installation and sharing system.  In Proceedings of the 12th Systems</span></div>
<div style="position:absolute;left:81.96px;top:204.61px" class="cls_014"><span class="cls_014">Administration Conference (LISA ’98), pages 253-259. USENIX Association, December 1998.</span></div>
<div style="position:absolute;left:59.72px;top:217.66px" class="cls_014"><span class="cls_014">[126]</span></div>
<div style="position:absolute;left:81.96px;top:217.66px" class="cls_014"><span class="cls_014">National Institute of Standards and Technology. Advanced encryption standard.</span><span class="cls_016"> <A HREF="http://www.nist.gov/aes/">http://www.nist.gov/aes/</A> </span><span class="cls_014">,</span></div>
<div style="position:absolute;left:81.96px;top:227.13px" class="cls_014"><span class="cls_014">2001. Accessed 21 August 2005.</span></div>
<div style="position:absolute;left:59.72px;top:240.17px" class="cls_014"><span class="cls_014">[127]</span></div>
<div style="position:absolute;left:81.96px;top:240.17px" class="cls_014"><span class="cls_014">National Institute of Standards and Technology. Secure hash standard, February 2004.</span></div>
<div style="position:absolute;left:59.72px;top:253.22px" class="cls_014"><span class="cls_014">[128]</span></div>
<div style="position:absolute;left:81.96px;top:253.22px" class="cls_014"><span class="cls_014">Michael A. Olson.  The design and implementation of the Inversion file system.  In Proceedings of the</span></div>
<div style="position:absolute;left:81.96px;top:262.68px" class="cls_014"><span class="cls_014">USENIX Winter 1993 Technical Conference, pages 205-218, January 1993.</span></div>
<div style="position:absolute;left:59.72px;top:275.73px" class="cls_014"><span class="cls_014">[129]</span></div>
<div style="position:absolute;left:81.96px;top:275.73px" class="cls_014"><span class="cls_014">Kyle Oppenheim and Patrick McCormick.  Deployme: Tellme’s package management and deployment</span></div>
<div style="position:absolute;left:81.96px;top:285.20px" class="cls_014"><span class="cls_014">system.  In Proceedings of the 14th Systems Administration Conference (LISA 2000), pages 187-196.</span></div>
<div style="position:absolute;left:81.96px;top:294.66px" class="cls_014"><span class="cls_014">USENIX Association, December 2000.</span></div>
<div style="position:absolute;left:59.72px;top:307.71px" class="cls_014"><span class="cls_014">[130]</span></div>
<div style="position:absolute;left:81.96px;top:307.71px" class="cls_014"><span class="cls_014">Vern Paxson. Flex — a fast scanner generator.</span><span class="cls_016"> <A HREF="http://www.gnu.org/software/flex/">http://www.gnu.org/software/flex/</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:59.72px;top:320.76px" class="cls_014"><span class="cls_014">[131]</span></div>
<div style="position:absolute;left:81.96px;top:320.76px" class="cls_014"><span class="cls_014">Colin Percival. An automated binary security update system for FreeBSD. In Proceedings of BSDCON</span></div>
<div style="position:absolute;left:81.96px;top:330.22px" class="cls_014"><span class="cls_014">’03. USENIX, September 2003.</span></div>
<div style="position:absolute;left:59.72px;top:343.27px" class="cls_014"><span class="cls_014">[132]</span></div>
<div style="position:absolute;left:81.96px;top:343.27px" class="cls_014"><span class="cls_014">Colin Percival. Binary diff/patch utility.</span><span class="cls_016"> <A HREF="http://www.daemonology.net/bsdiff/">http://www.daemonology.net/bsdiff/</A> </span><span class="cls_014">, 2003.</span></div>
<div style="position:absolute;left:59.72px;top:356.31px" class="cls_014"><span class="cls_014">[133]</span></div>
<div style="position:absolute;left:81.96px;top:356.31px" class="cls_014"><span class="cls_014">Simon Peyton Jones. The Implementation of Functional Programming Languages. Prentice Hall, 1987.</span></div>
<div style="position:absolute;left:59.72px;top:369.36px" class="cls_014"><span class="cls_014">[134]</span></div>
<div style="position:absolute;left:81.96px;top:369.36px" class="cls_014"><span class="cls_014">Simon Peyton Jones. Implementing lazy functional languages on stock hardware: the Spineless Tagless</span></div>
<div style="position:absolute;left:81.96px;top:378.83px" class="cls_014"><span class="cls_014">G-machine. Journal of Functional Programming, 2(2):127-202, April 1992.</span></div>
<div style="position:absolute;left:59.72px;top:391.87px" class="cls_014"><span class="cls_014">[135]</span></div>
<div style="position:absolute;left:81.96px;top:391.87px" class="cls_014"><span class="cls_014">Simon Peyton Jones, editor. Haskell 98 Language and Libraries: The Revised Report. Cambridge Uni-</span></div>
<div style="position:absolute;left:81.96px;top:401.34px" class="cls_014"><span class="cls_014">versity Press, April 2004.</span></div>
<div style="position:absolute;left:59.72px;top:414.39px" class="cls_014"><span class="cls_014">[136]</span></div>
<div style="position:absolute;left:81.96px;top:414.39px" class="cls_014"><span class="cls_014">Rob Pike.  Systems software research is irrelevant.  Research talk,</span><span class="cls_016"> <A HREF="http://www.cs.bell-labs.com/who/rob/">http://www.cs.bell-labs.com/who/rob/</A> </span></div>
<div style="position:absolute;left:81.96px;top:423.85px" class="cls_016"><span class="cls_016">utah2000.pdf</span><span class="cls_014">, February 2000.</span></div>
<div style="position:absolute;left:59.72px;top:436.90px" class="cls_014"><span class="cls_014">[137]</span></div>
<div style="position:absolute;left:81.96px;top:436.90px" class="cls_014"><span class="cls_014">C. Michael Pilato, Ben Collins-Sussman, and Brian W. Fitzpatrick.  Version Control with Subversion.</span></div>
<div style="position:absolute;left:81.96px;top:446.36px" class="cls_014"><span class="cls_014">O’Reilly, June 2004.</span></div>
<div style="position:absolute;left:59.72px;top:459.41px" class="cls_014"><span class="cls_014">[138]</span></div>
<div style="position:absolute;left:81.96px;top:459.41px" class="cls_014"><span class="cls_014">The Fink Project. Fink.</span><span class="cls_016"> http://fink.sourceforge.net/</span><span class="cls_014">.</span></div>
<div style="position:absolute;left:59.72px;top:472.46px" class="cls_014"><span class="cls_014">[139]</span></div>
<div style="position:absolute;left:81.96px;top:472.46px" class="cls_014"><span class="cls_014">Eric S. Raymond. The CML2 language: Python implementation of a constraint-based interactive config-</span></div>
<div style="position:absolute;left:81.96px;top:481.92px" class="cls_014"><span class="cls_014">urator. In 9th International Python Conference, March 2001.</span></div>
<div style="position:absolute;left:59.72px;top:494.97px" class="cls_014"><span class="cls_014">[140]</span></div>
<div style="position:absolute;left:81.96px;top:494.97px" class="cls_014"><span class="cls_014">Eric S. Raymond. The Art of Unix Programming. Addison-Wesley, September 2003.</span></div>
<div style="position:absolute;left:59.72px;top:508.01px" class="cls_014"><span class="cls_014">[141]</span></div>
<div style="position:absolute;left:81.96px;top:508.01px" class="cls_014"><span class="cls_014">Ron Rivest. The MD5 message-digest algorithm. RFC 1321, April 1992.</span></div>
<div style="position:absolute;left:59.72px;top:521.06px" class="cls_014"><span class="cls_014">[142]</span></div>
<div style="position:absolute;left:81.96px;top:521.06px" class="cls_014"><span class="cls_014">Mendel Rosenblum and John K. Ousterhout.  The design and implementation of a log-structured file</span></div>
<div style="position:absolute;left:81.96px;top:530.53px" class="cls_014"><span class="cls_014">system. ACM Transactions on Computer Systems, 10(1):26-52, 1992.</span></div>
<div style="position:absolute;left:59.72px;top:543.57px" class="cls_014"><span class="cls_014">[143]</span></div>
<div style="position:absolute;left:81.96px;top:543.57px" class="cls_014"><span class="cls_014">John P. Rouillard and Richard B. Martin. Depot-Lite: a mechanism for managing software. In Proceedings</span></div>
<div style="position:absolute;left:81.96px;top:553.04px" class="cls_014"><span class="cls_014">of the 8th Systems Administration Conference (LISA ’94), pages 83-91. USENIX Association, 1994.</span></div>
<div style="position:absolute;left:59.72px;top:566.09px" class="cls_014"><span class="cls_014">[144]</span></div>
<div style="position:absolute;left:81.96px;top:566.09px" class="cls_014"><span class="cls_014">Antony Rowstron and Peter Druschel. Pastry: Scalable, decentralized object location and routing for large-</span></div>
<div style="position:absolute;left:81.96px;top:575.55px" class="cls_014"><span class="cls_014">scale peer-to-peer systems. In 18th IFIP/ACM International Conference on Distributed Systems Platforms</span></div>
<div style="position:absolute;left:81.96px;top:585.01px" class="cls_014"><span class="cls_014">(Middleware 2001), November 2001.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">256</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:179400px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background265.jpg" width=481 height=680></div>
<div style="position:absolute;left:369.64px;top:17.14px" class="cls_004"><span class="cls_004">Bibliography</span></div>
<div style="position:absolute;left:63.87px;top:47.03px" class="cls_014"><span class="cls_014">[145]</span></div>
<div style="position:absolute;left:86.12px;top:47.03px" class="cls_014"><span class="cls_014">Bruce Schneier. Applied Cryptography. John Wiley & Sons, second edition, 1996.</span></div>
<div style="position:absolute;left:63.87px;top:60.38px" class="cls_014"><span class="cls_014">[146]</span></div>
<div style="position:absolute;left:86.12px;top:60.38px" class="cls_014"><span class="cls_014">Bruce Schneier. New cryptanalytic results against SHA-1. Crypto-Gram newsletter,</span><span class="cls_016"> <A HREF="http://www.schneier.com/blog/archives/2005/08/new_cryptanalyt.html">http://www.schneier.</A> </span></div>
<div style="position:absolute;left:86.12px;top:69.84px" class="cls_016"><span class="cls_016">com/blog/archives/2005/08/new_cryptanalyt.html</span><span class="cls_014">, August 2005.</span></div>
<div style="position:absolute;left:63.87px;top:83.19px" class="cls_014"><span class="cls_014">[147]</span></div>
<div style="position:absolute;left:86.12px;top:83.19px" class="cls_014"><span class="cls_014">Bruce Schneier.  SHA-1 broken.  Crypto-Gram newsletter,</span><span class="cls_016"> <A HREF="http://www.schneier.com/crypto-gram-0503.html">http://www.schneier.com/crypto-gram-0503.</A> </span></div>
<div style="position:absolute;left:86.12px;top:92.65px" class="cls_016"><span class="cls_016">html</span><span class="cls_014">, March 2005.</span></div>
<div style="position:absolute;left:63.87px;top:106.00px" class="cls_014"><span class="cls_014">[148]</span></div>
<div style="position:absolute;left:86.12px;top:106.00px" class="cls_014"><span class="cls_014">Christopher Seiwald. Jam — Make(1) redux. In USENIX Applications Development Symposium, April</span></div>
<div style="position:absolute;left:86.12px;top:115.46px" class="cls_014"><span class="cls_014">1994.</span></div>
<div style="position:absolute;left:63.87px;top:128.81px" class="cls_014"><span class="cls_014">[149]</span></div>
<div style="position:absolute;left:86.12px;top:128.81px" class="cls_014"><span class="cls_014">Gustavo Noronha Silva.  APT HOWTO.</span><span class="cls_016">  <A HREF="http://www.debian.org/doc/manuals/apt-howto/index.en.html">http://www.debian.org/doc/manuals/apt-howto/index.en.html</A> </span><span class="cls_014">,</span></div>
<div style="position:absolute;left:86.12px;top:138.27px" class="cls_014"><span class="cls_014">2004. Accessed 26 August 2005.</span></div>
<div style="position:absolute;left:63.87px;top:151.62px" class="cls_014"><span class="cls_014">[150]</span></div>
<div style="position:absolute;left:86.12px;top:151.62px" class="cls_014"><span class="cls_014">Anthony M. Sloane.  Post-design domain-specific language embedding:  A case study in the software</span></div>
<div style="position:absolute;left:86.12px;top:161.08px" class="cls_014"><span class="cls_014">engineering domain.  In Proceedings of the 35th Annual Hawaii International Conference on System</span></div>
<div style="position:absolute;left:86.12px;top:170.55px" class="cls_014"><span class="cls_014">Sciences (HICSS’02), Washington, DC, USA, 2002. IEEE Computer Society.</span></div>
<div style="position:absolute;left:63.87px;top:183.89px" class="cls_014"><span class="cls_014">[151]</span></div>
<div style="position:absolute;left:86.12px;top:183.89px" class="cls_014"><span class="cls_014">Guy L. Steele.  RABBIT: A compiler for SCHEME.  Technical Report AI-TR-474, MIT AI Lab, May</span></div>
<div style="position:absolute;left:86.12px;top:193.36px" class="cls_014"><span class="cls_014">1978.</span></div>
<div style="position:absolute;left:63.87px;top:206.70px" class="cls_014"><span class="cls_014">[152]</span></div>
<div style="position:absolute;left:86.12px;top:206.70px" class="cls_014"><span class="cls_014">W. Richard Stevens and Stephen A. Rago. Advanced Programming in the UNIX Environment. Addison-</span></div>
<div style="position:absolute;left:86.12px;top:216.17px" class="cls_014"><span class="cls_014">Wesley, second edition, June 2005.</span></div>
<div style="position:absolute;left:63.87px;top:229.51px" class="cls_014"><span class="cls_014">[153]</span></div>
<div style="position:absolute;left:86.12px;top:229.51px" class="cls_014"><span class="cls_014">Bjarne Stroustrup. The C++ Programming Language. Addison-Wesley, third edition, 1997.</span></div>
<div style="position:absolute;left:63.87px;top:242.86px" class="cls_014"><span class="cls_014">[154]</span></div>
<div style="position:absolute;left:86.12px;top:242.86px" class="cls_014"><span class="cls_014">Clemens Szyperski.  Component Software:  Beyond Object-Oriented Programming.  Addison-Wesley,</span></div>
<div style="position:absolute;left:86.12px;top:252.32px" class="cls_014"><span class="cls_014">second edition, 2002.</span></div>
<div style="position:absolute;left:63.87px;top:265.67px" class="cls_014"><span class="cls_014">[155]</span></div>
<div style="position:absolute;left:86.12px;top:265.67px" class="cls_014"><span class="cls_014">Clemens Szyperski. Component technology—what, where, and how?  In Proceedings of the 25th Inter-</span></div>
<div style="position:absolute;left:86.12px;top:275.13px" class="cls_014"><span class="cls_014">national Conference on Software Engineering (ICSE 2003), pages 684-693, May 2003.</span></div>
<div style="position:absolute;left:63.87px;top:288.48px" class="cls_014"><span class="cls_014">[156]</span></div>
<div style="position:absolute;left:86.12px;top:288.48px" class="cls_014"><span class="cls_014">Andrew S. Tanenbaum. Computer Networks. Prentice Hall, fourth edition, August 2002.</span></div>
<div style="position:absolute;left:63.87px;top:301.83px" class="cls_014"><span class="cls_014">[157]</span></div>
<div style="position:absolute;left:86.12px;top:301.83px" class="cls_014"><span class="cls_014">Peter Thoeny. Twiki—an enterprise collaboration platform.</span><span class="cls_016"> <A HREF="http://twiki.org/">http://twiki.org/</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:63.87px;top:315.17px" class="cls_014"><span class="cls_014">[158]</span></div>
<div style="position:absolute;left:86.12px;top:315.17px" class="cls_014"><span class="cls_014">ThoughtWorks. Cruise Control.</span><span class="cls_016"> <A HREF="http://cruisecontrol.sourceforge.net/">http://cruisecontrol.sourceforge.net/</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:63.87px;top:328.52px" class="cls_014"><span class="cls_014">[159]</span></div>
<div style="position:absolute;left:86.12px;top:328.52px" class="cls_014"><span class="cls_014">Walter F. Tichy. Tools for software configuration management. In Jürgen F. H. Winkler, editor, Proceed-</span></div>
<div style="position:absolute;left:86.12px;top:337.98px" class="cls_014"><span class="cls_014">ings of the International Workshop on Software Version and Configuration Control, volume 30 of Berichte</span></div>
<div style="position:absolute;left:86.12px;top:347.45px" class="cls_014"><span class="cls_014">des German Chapter of the ACM, Grassau, January 1988. Teubner.</span></div>
<div style="position:absolute;left:63.87px;top:360.79px" class="cls_014"><span class="cls_014">[160]</span></div>
<div style="position:absolute;left:86.12px;top:360.79px" class="cls_014"><span class="cls_014">TIS Committee. Tool Interface Specification (TIS) Executable and Linking Format (ELF) Specification,</span></div>
<div style="position:absolute;left:86.12px;top:370.26px" class="cls_014"><span class="cls_014">Version 1.2.</span><span class="cls_016"> <A HREF="http://www.x86.org/ftp/manuals/tools/elf.pdf/">http://www.x86.org/ftp/manuals/tools/elf.pdf</A> </span><span class="cls_014">, May 1995.</span></div>
<div style="position:absolute;left:63.87px;top:383.60px" class="cls_014"><span class="cls_014">[161]</span></div>
<div style="position:absolute;left:86.12px;top:383.60px" class="cls_014"><span class="cls_014">TraCE Project. Nix deployment system.</span><span class="cls_016"> <A HREF="http://www.cs.uu.nl/wiki/trace/nix/">http://www.cs.uu.nl/wiki/Trace/Nix</A> </span><span class="cls_014">, 2005.</span></div>
<div style="position:absolute;left:63.87px;top:396.95px" class="cls_014"><span class="cls_014">[162]</span></div>
<div style="position:absolute;left:86.12px;top:396.95px" class="cls_014"><span class="cls_014">Dimitre Trendafilov, Nasir Memon, and Torsten Suel. zdelta: An efficient delta compression tool. Tech-</span></div>
<div style="position:absolute;left:86.12px;top:406.41px" class="cls_014"><span class="cls_014">nical Report TR-CIS-2002-02, Polytechnic University, 2002.</span></div>
<div style="position:absolute;left:63.87px;top:419.76px" class="cls_014"><span class="cls_014">[163]</span></div>
<div style="position:absolute;left:86.12px;top:419.76px" class="cls_014"><span class="cls_014">Andrew Tridgell. Efficient Algorithms for Sorting and Synchronization. PhD thesis, Australian National</span></div>
<div style="position:absolute;left:86.12px;top:429.22px" class="cls_014"><span class="cls_014">University, February 1999.</span></div>
<div style="position:absolute;left:63.87px;top:442.57px" class="cls_014"><span class="cls_014">[164]</span></div>
<div style="position:absolute;left:86.12px;top:442.57px" class="cls_014"><span class="cls_014">Vrije Universiteit. The Amoeba Reference Manual — Programming Guide, chapter Chapter 6.3 (Amake</span></div>
<div style="position:absolute;left:86.12px;top:452.03px" class="cls_014"><span class="cls_014">User Reference Manual), pages 83-104. Vrije Universiteit, Amsterdam, 1996.</span></div>
<div style="position:absolute;left:63.87px;top:465.38px" class="cls_014"><span class="cls_014">[165]</span></div>
<div style="position:absolute;left:86.12px;top:465.38px" class="cls_014"><span class="cls_014">Urbancode.  Anthill.</span><span class="cls_016">  <A HREF="http://www.urbancode.com/projects/anthill/default.jsp/">http://www.urbancode.com/projects/anthill/default.jsp</A> </span><span class="cls_014">, 2005.  Accessed 21 August</span></div>
<div style="position:absolute;left:86.12px;top:474.84px" class="cls_014"><span class="cls_014">2005.</span></div>
<div style="position:absolute;left:63.87px;top:488.19px" class="cls_014"><span class="cls_014">[166]</span></div>
<div style="position:absolute;left:86.12px;top:488.19px" class="cls_014"><span class="cls_014">Mark van den Brand, Hayco de Jong, Paul Klint, and Pieter Olivier. Efficient annotated terms. Software—</span></div>
<div style="position:absolute;left:86.12px;top:497.65px" class="cls_014"><span class="cls_014">Practice and Experience, 30:259-291, 2000.</span></div>
<div style="position:absolute;left:63.87px;top:511.00px" class="cls_014"><span class="cls_014">[167]</span></div>
<div style="position:absolute;left:86.12px;top:511.00px" class="cls_014"><span class="cls_014">André van der Hoek. Integrating configuration management and software deployment. In Working Con-</span></div>
<div style="position:absolute;left:86.12px;top:520.46px" class="cls_014"><span class="cls_014">ference on Complex and Dynamic Systems Architecture (CDSA 2001), December 2001.</span></div>
<div style="position:absolute;left:63.87px;top:533.81px" class="cls_014"><span class="cls_014">[168]</span></div>
<div style="position:absolute;left:86.12px;top:533.81px" class="cls_014"><span class="cls_014">André van der Hoek, Richard S. Hall, Antonio Carzaniga, Dennis Heimbigner, and Alexander L. Wolf.</span></div>
<div style="position:absolute;left:86.12px;top:543.28px" class="cls_014"><span class="cls_014">Software deployment: Extending configuration management support into the field. Crosstalk, The Journal</span></div>
<div style="position:absolute;left:86.12px;top:552.74px" class="cls_014"><span class="cls_014">of Defense Software Engineering, 11(2), February 1998.</span></div>
<div style="position:absolute;left:63.87px;top:566.09px" class="cls_014"><span class="cls_014">[169]</span></div>
<div style="position:absolute;left:86.12px;top:566.09px" class="cls_014"><span class="cls_014">André van der Hoek, Richard S. Hall, Dennis Heimbigner, and Alexander L. Wolf. Software release man-</span></div>
<div style="position:absolute;left:86.12px;top:575.55px" class="cls_014"><span class="cls_014">agement. In M. Jazayeri and H. Schauer, editors, Proceedings of the Sixth European Software Engineering</span></div>
<div style="position:absolute;left:86.12px;top:585.01px" class="cls_014"><span class="cls_014">Conference (ESEC/FSE 97), pages 159-175. Springer-Verlag, 1997.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">257</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:180090px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background266.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">Bibliography</span></div>
<div style="position:absolute;left:59.72px;top:47.03px" class="cls_014"><span class="cls_014">[170]</span></div>
<div style="position:absolute;left:81.96px;top:47.03px" class="cls_014"><span class="cls_014">Tijs van der Storm. Variability and component composition. In Jan Bosch and Charles Krueger, editors,</span></div>
<div style="position:absolute;left:81.96px;top:56.50px" class="cls_014"><span class="cls_014">Software Reuse: Methods, Techniques and Tools: 8th International Conference (ICSR-8), volume 3107 of</span></div>
<div style="position:absolute;left:81.96px;top:65.96px" class="cls_014"><span class="cls_014">Lecture Notes in Computer Science, pages 86-100. Springer-Verlag, June 2004.</span></div>
<div style="position:absolute;left:59.72px;top:79.41px" class="cls_014"><span class="cls_014">[171]</span></div>
<div style="position:absolute;left:81.96px;top:79.41px" class="cls_014"><span class="cls_014">Tijs van der Storm. Continuous release and upgrade of component-based software. In 12th International</span></div>
<div style="position:absolute;left:81.96px;top:88.88px" class="cls_014"><span class="cls_014">Workshop on Software Configuration Management (SCM-12), September 2005.</span></div>
<div style="position:absolute;left:59.72px;top:102.32px" class="cls_014"><span class="cls_014">[172]</span></div>
<div style="position:absolute;left:81.96px;top:102.32px" class="cls_014"><span class="cls_014">Gary V. Vaughan, Ben Elliston, Tom Tromey, and Ian Lance Taylor.  GNU Autoconf, Automake, and</span></div>
<div style="position:absolute;left:81.96px;top:111.79px" class="cls_014"><span class="cls_014">Libtool.  New Riders, October 2000.  Also at</span><span class="cls_016"> <A HREF="http://sources.redhat.com/autobook/">http://sources.redhat.com/autobook/</A> </span><span class="cls_014">, accessed 21 august</span></div>
<div style="position:absolute;left:81.96px;top:121.25px" class="cls_014"><span class="cls_014">2005.</span></div>
<div style="position:absolute;left:59.72px;top:134.70px" class="cls_014"><span class="cls_014">[173]</span></div>
<div style="position:absolute;left:81.96px;top:134.70px" class="cls_014"><span class="cls_014">V. N. Venkatakrishnan, R. Sekar, Tapan Kamat, Sofia Tsipa, and Zhenkai Liang. An approach for secure</span></div>
<div style="position:absolute;left:81.96px;top:144.17px" class="cls_014"><span class="cls_014">software installation.  In Proceedings of the 16th Systems Administration Conference (LISA ’02), pages</span></div>
<div style="position:absolute;left:81.96px;top:153.63px" class="cls_014"><span class="cls_014">219-226. USENIX Association, November 2002.</span></div>
<div style="position:absolute;left:59.72px;top:167.08px" class="cls_014"><span class="cls_014">[174]</span></div>
<div style="position:absolute;left:81.96px;top:167.08px" class="cls_014"><span class="cls_014">Seth Vidal. Yellow dog Updater, Modified (</span><span class="cls_016">yum</span><span class="cls_014">).</span><span class="cls_016"> http://linux.duke.edu/projects/yum/</span><span class="cls_014">.</span></div>
<div style="position:absolute;left:59.72px;top:180.53px" class="cls_014"><span class="cls_014">[175]</span></div>
<div style="position:absolute;left:81.96px;top:180.53px" class="cls_014"><span class="cls_014">Eelco Visser. Syntax Definition for Language Prototyping. PhD thesis, University of Amsterdam, Septem-</span></div>
<div style="position:absolute;left:81.96px;top:190.00px" class="cls_014"><span class="cls_014">ber 1997.</span></div>
<div style="position:absolute;left:59.72px;top:203.45px" class="cls_014"><span class="cls_014">[176]</span></div>
<div style="position:absolute;left:81.96px;top:203.45px" class="cls_014"><span class="cls_014">Eelco Visser. Program transformation with Stratego/XT: Strategies, tools, and systems in StrategoXT-0.9.</span></div>
<div style="position:absolute;left:81.96px;top:212.91px" class="cls_014"><span class="cls_014">In C. Lengauer et al., editor, Domain-Specific Program Generation, volume 3016 of Lecture Notes in</span></div>
<div style="position:absolute;left:81.96px;top:222.37px" class="cls_014"><span class="cls_014">Computer Science, pages 216-238. Spinger-Verlag, June 2004.</span></div>
<div style="position:absolute;left:59.72px;top:235.82px" class="cls_014"><span class="cls_014">[177]</span></div>
<div style="position:absolute;left:81.96px;top:235.82px" class="cls_014"><span class="cls_014">Xiaoyun Wang, Yiqun Lisa Yin, and Hongbo Yu. Finding collisions in the full SHA-1. In Victor Shoup,</span></div>
<div style="position:absolute;left:81.96px;top:245.29px" class="cls_014"><span class="cls_014">editor, Advances in Cryptology — CRYPTO 2005: 25th Annual International Cryptology Conference,</span></div>
<div style="position:absolute;left:81.96px;top:254.75px" class="cls_014"><span class="cls_014">volume 3621 of Lecture Notes in Computer Science. Springer-Verlag, August 2005.</span></div>
<div style="position:absolute;left:59.72px;top:268.20px" class="cls_014"><span class="cls_014">[178]</span></div>
<div style="position:absolute;left:81.96px;top:268.20px" class="cls_014"><span class="cls_014">Xiaoyun Wang and Hongbo Yu. How to break MD5 and other hash functions. In Ronald Cramer, editor,</span></div>
<div style="position:absolute;left:81.96px;top:277.67px" class="cls_014"><span class="cls_014">Advances in Cryptology — EUROCRYPT 2005: 24th Annual International Conference on the Theory and</span></div>
<div style="position:absolute;left:81.96px;top:287.13px" class="cls_014"><span class="cls_014">Applications of Cryptographic Techniques, volume 3494 of Lecture Notes in Computer Science. Springer-</span></div>
<div style="position:absolute;left:81.96px;top:296.60px" class="cls_014"><span class="cls_014">Verlag, May 2005.</span></div>
<div style="position:absolute;left:59.72px;top:310.05px" class="cls_014"><span class="cls_014">[179]</span></div>
<div style="position:absolute;left:81.96px;top:310.05px" class="cls_014"><span class="cls_014">Paul R. Wilson.  Uniprocessor garbage collection techniques.  In International Workshop on Memory</span></div>
<div style="position:absolute;left:81.96px;top:319.51px" class="cls_014"><span class="cls_014">Management, volume 637 of Lecture Notes in Computer Science. Springer-Verlag, September 1992.</span></div>
<div style="position:absolute;left:59.72px;top:332.96px" class="cls_014"><span class="cls_014">[180]</span></div>
<div style="position:absolute;left:81.96px;top:332.96px" class="cls_014"><span class="cls_014">Stephen P. Berczuk with Brad Appleton.  Software configuration management patterns: effective team-</span></div>
<div style="position:absolute;left:81.96px;top:342.42px" class="cls_014"><span class="cls_014">work, practical integration. Addison-Wesley, 2003.</span></div>
<div style="position:absolute;left:59.72px;top:355.87px" class="cls_014"><span class="cls_014">[181]</span></div>
<div style="position:absolute;left:81.96px;top:355.87px" class="cls_014"><span class="cls_014">Walter Wong. Local disk depot: customizing the software environment. In Proceedings of the 7th Systems</span></div>
<div style="position:absolute;left:81.96px;top:365.34px" class="cls_014"><span class="cls_014">Administration Conference (LISA ’93), pages 49-53. USENIX Association, November 1993.</span></div>
<div style="position:absolute;left:59.72px;top:378.79px" class="cls_014"><span class="cls_014">[182]</span></div>
<div style="position:absolute;left:81.96px;top:378.79px" class="cls_014"><span class="cls_014">X.Org Foundation. X.Org homepage.</span><span class="cls_016"> <A HREF="http://wiki.x.org/wiki/">http://wiki.x.org/wiki/</A> </span><span class="cls_014">, 2005. Accessed 27 November 2005.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">258</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:180780px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background267.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:90.80px" class="cls_006"><span class="cls_006">Index</span></div>
<div style="position:absolute;left:63.87px;top:141.98px" class="cls_004"><span class="cls_004">β-R</span><span class="cls_014">EDUCE</span><span class="cls_004"> semantic rule, 77, 83, 85</span></div>
<div style="position:absolute;left:260.46px;top:141.98px" class="cls_004"><span class="cls_004">build farm, 16, 210</span></div>
<div style="position:absolute;left:63.87px;top:153.97px" class="cls_004"><span class="cls_004">β-R</span><span class="cls_014">EDUCE</span><span class="cls_004">’ semantic rule, 77, 85</span></div>
<div style="position:absolute;left:260.46px;top:153.97px" class="cls_004"><span class="cls_004">build hook, 115, 218, 228</span></div>
<div style="position:absolute;left:260.46px;top:165.97px" class="cls_004"><span class="cls_004">builder, 25</span></div>
<div style="position:absolute;left:63.87px;top:176.58px" class="cls_007"><span class="cls_007">acquirePathLock</span><span class="cls_004"> function, 99</span></div>
<div style="position:absolute;left:260.46px;top:177.96px" class="cls_007"><span class="cls_007">builder</span><span class="cls_004"> attribute, 27, 102</span></div>
<div style="position:absolute;left:63.87px;top:188.58px" class="cls_007"><span class="cls_007">addTempRoot</span><span class="cls_004"> function, 132</span></div>
<div style="position:absolute;left:63.87px;top:200.57px" class="cls_007"><span class="cls_007">addToStore</span><span class="cls_004"> function</span></div>
<div style="position:absolute;left:260.46px;top:200.58px" class="cls_004"><span class="cls_004">Camera, 202</span></div>
<div style="position:absolute;left:83.80px;top:212.57px" class="cls_004"><span class="cls_004">in the extensional model, 98</span></div>
<div style="position:absolute;left:260.46px;top:212.58px" class="cls_004"><span class="cls_004">canonical path, 73, 93</span></div>
<div style="position:absolute;left:83.80px;top:224.56px" class="cls_004"><span class="cls_004">in the intensional model, 154</span></div>
<div style="position:absolute;left:260.46px;top:224.58px" class="cls_004"><span class="cls_004">canonical serialisation, 91</span></div>
<div style="position:absolute;left:63.87px;top:236.56px" class="cls_004"><span class="cls_004">Amake, 62, 241</span></div>
<div style="position:absolute;left:260.46px;top:236.57px" class="cls_007"><span class="cls_007">canonicalise</span><span class="cls_004"> function, 73</span></div>
<div style="position:absolute;left:63.87px;top:248.55px" class="cls_004"><span class="cls_004">Ant, 240</span></div>
<div style="position:absolute;left:260.46px;top:248.57px" class="cls_007"><span class="cls_007">canonicalisePathContents</span><span class="cls_004"> function,</span></div>
<div style="position:absolute;left:404.44px;top:248.57px" class="cls_004"><span class="cls_004">112</span></div>
<div style="position:absolute;left:63.87px;top:260.55px" class="cls_004"><span class="cls_004">application bundle, 12</span></div>
<div style="position:absolute;left:260.46px;top:260.56px" class="cls_004"><span class="cls_004">channel, 43, 46, 188</span></div>
<div style="position:absolute;left:63.87px;top:272.54px" class="cls_004"><span class="cls_004">APT, 201</span></div>
<div style="position:absolute;left:260.46px;top:272.56px" class="cls_004"><span class="cls_004">circular dependency, 242</span></div>
<div style="position:absolute;left:64.12px;top:284.53px" class="cls_004"><span class="cls_004">A</span><span class="cls_014">SSERT</span><span class="cls_004"> semantic rule,</span></div>
<div style="position:absolute;left:158.33px;top:284.53px" class="cls_004"><span class="cls_004">78</span></div>
<div style="position:absolute;left:260.46px;top:284.55px" class="cls_004"><span class="cls_004">CLASSPATH, 4</span></div>
<div style="position:absolute;left:63.87px;top:296.53px" class="cls_007"><span class="cls_007">assert</span><span class="cls_004"> keyword, 33</span></div>
<div style="position:absolute;left:260.46px;top:296.55px" class="cls_004"><span class="cls_004">ClearCase, 202</span></div>
<div style="position:absolute;left:63.87px;top:308.52px" class="cls_004"><span class="cls_004">assertion, 33, 206</span></div>
<div style="position:absolute;left:260.71px;top:308.54px" class="cls_004"><span class="cls_004">C</span><span class="cls_014">LOSED</span><span class="cls_004"> semantic rule, 86</span></div>
<div style="position:absolute;left:63.87px;top:320.52px" class="cls_004"><span class="cls_004">ATerm, 40, 105</span></div>
<div style="position:absolute;left:260.46px;top:320.54px" class="cls_004"><span class="cls_004">closure, 55, 96, 147</span></div>
<div style="position:absolute;left:63.87px;top:332.51px" class="cls_004"><span class="cls_004">ATerm library, 81</span></div>
<div style="position:absolute;left:260.46px;top:332.53px" class="cls_007"><span class="cls_007">closure</span><span class="cls_004"> function, 96</span></div>
<div style="position:absolute;left:63.87px;top:344.51px" class="cls_004"><span class="cls_004">atom, 97</span></div>
<div style="position:absolute;left:260.46px;top:344.53px" class="cls_004"><span class="cls_004">closure invariant, 96, 109</span></div>
<div style="position:absolute;left:63.87px;top:356.50px" class="cls_004"><span class="cls_004">atomicity, 10, 37</span></div>
<div style="position:absolute;left:260.46px;top:356.52px" class="cls_007"><span class="cls_007">closure’</span><span class="cls_004"> function, 147</span></div>
<div style="position:absolute;left:63.87px;top:368.50px" class="cls_004"><span class="cls_004">attribute, 27</span></div>
<div style="position:absolute;left:260.46px;top:368.52px" class="cls_004"><span class="cls_004">comment, 66</span></div>
<div style="position:absolute;left:63.87px;top:380.49px" class="cls_004"><span class="cls_004">attribute set, 27, 73</span></div>
<div style="position:absolute;left:260.46px;top:380.51px" class="cls_004"><span class="cls_004">complete deployment, 8, 24</span></div>
<div style="position:absolute;left:83.80px;top:392.49px" class="cls_004"><span class="cls_004">recursive, 73, 77</span></div>
<div style="position:absolute;left:260.46px;top:392.51px" class="cls_004"><span class="cls_004">component, 19, 49</span></div>
<div style="position:absolute;left:83.80px;top:404.48px" class="cls_004"><span class="cls_004">selection, 77</span></div>
<div style="position:absolute;left:280.38px;top:404.50px" class="cls_004"><span class="cls_004">definition of, 50</span></div>
<div style="position:absolute;left:63.87px;top:416.47px" class="cls_004"><span class="cls_004">Autoconf, 29, 246</span></div>
<div style="position:absolute;left:260.46px;top:416.50px" class="cls_004"><span class="cls_004">component store, 19</span></div>
<div style="position:absolute;left:260.46px;top:428.49px" class="cls_004"><span class="cls_004">composition, 25</span></div>
<div style="position:absolute;left:63.87px;top:439.09px" class="cls_004"><span class="cls_004">Berkeley DB, 95</span></div>
<div style="position:absolute;left:260.46px;top:440.49px" class="cls_004"><span class="cls_004">concurrency, 98</span></div>
<div style="position:absolute;left:63.87px;top:451.08px" class="cls_004"><span class="cls_004">bias, 183</span></div>
<div style="position:absolute;left:260.46px;top:452.48px" class="cls_004"><span class="cls_004">configuration  management,</span></div>
<div style="position:absolute;left:383.43px;top:452.48px" class="cls_004"><span class="cls_004">51,</span></div>
<div style="position:absolute;left:404.74px;top:452.48px" class="cls_004"><span class="cls_004">114,</span></div>
<div style="position:absolute;left:63.87px;top:463.08px" class="cls_004"><span class="cls_004">binary deployment, 11,</span></div>
<div style="position:absolute;left:158.69px;top:463.08px" class="cls_004"><span class="cls_004">42,</span></div>
<div style="position:absolute;left:173.63px;top:463.08px" class="cls_004"><span class="cls_004">45,</span></div>
<div style="position:absolute;left:188.58px;top:463.08px" class="cls_004"><span class="cls_004">185,</span></div>
<div style="position:absolute;left:208.50px;top:463.08px" class="cls_004"><span class="cls_004">187</span></div>
<div style="position:absolute;left:300.31px;top:464.44px" class="cls_004"><span class="cls_004">200, 216, 221</span></div>
<div style="position:absolute;left:63.87px;top:475.07px" class="cls_004"><span class="cls_004">binary patching, 192</span></div>
<div style="position:absolute;left:260.46px;top:476.43px" class="cls_004"><span class="cls_004">confluence, 76</span></div>
<div style="position:absolute;left:63.87px;top:487.07px" class="cls_004"><span class="cls_004">binding time, 52</span></div>
<div style="position:absolute;left:260.46px;top:488.43px" class="cls_004"><span class="cls_004">content-addressability, 97, 135, 140</span></div>
<div style="position:absolute;left:63.87px;top:499.06px" class="cls_004"><span class="cls_004">blacklist, 249</span></div>
<div style="position:absolute;left:260.46px;top:500.42px" class="cls_004"><span class="cls_004">continuous integration, 16, 209</span></div>
<div style="position:absolute;left:63.87px;top:511.05px" class="cls_007"><span class="cls_007">body</span><span class="cls_004"> attribute, 73</span></div>
<div style="position:absolute;left:260.46px;top:512.42px" class="cls_004"><span class="cls_004">correct deployment, 3</span></div>
<div style="position:absolute;left:63.87px;top:523.05px" class="cls_004"><span class="cls_004">bootstrapping, 44, 177,</span></div>
<div style="position:absolute;left:158.52px;top:523.05px" class="cls_004"><span class="cls_004">197</span></div>
<div style="position:absolute;left:260.46px;top:524.41px" class="cls_004"><span class="cls_004">cryptographic hash, 8, 88</span></div>
<div style="position:absolute;left:63.87px;top:535.04px" class="cls_004"><span class="cls_004">Boyer-Moore algorithm, 114</span></div>
<div style="position:absolute;left:63.87px;top:547.04px" class="cls_007"><span class="cls_007">bsdiff</span><span class="cls_004">, 193</span></div>
<div style="position:absolute;left:260.46px;top:547.04px" class="cls_004"><span class="cls_004">default arguments, 32</span></div>
<div style="position:absolute;left:63.87px;top:559.03px" class="cls_007"><span class="cls_007">build</span><span class="cls_004"> function</span></div>
<div style="position:absolute;left:260.46px;top:559.03px" class="cls_007"><span class="cls_007">default.nix</span><span class="cls_004">, 81</span></div>
<div style="position:absolute;left:83.80px;top:571.03px" class="cls_004"><span class="cls_004">in the extensional model, 110, 117</span></div>
<div style="position:absolute;left:260.46px;top:571.03px" class="cls_007"><span class="cls_007">deleteAndSignal</span><span class="cls_004"> function, 99, 100</span></div>
<div style="position:absolute;left:83.80px;top:583.02px" class="cls_004"><span class="cls_004">in the intensional model, 156</span></div>
<div style="position:absolute;left:260.46px;top:583.02px" class="cls_004"><span class="cls_004">deletion token, 100</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">259</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:181470px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background268.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">Index</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">dependency, 4, 21</span></div>
<div style="position:absolute;left:256.30px;top:45.04px" class="cls_004"><span class="cls_004">Glibc, 21, 106, 169, 181, 190</span></div>
<div style="position:absolute;left:79.64px;top:57.06px" class="cls_004"><span class="cls_004">exact, 24</span></div>
<div style="position:absolute;left:256.30px;top:56.99px" class="cls_004"><span class="cls_004">Global Assembly Cache, 13, 203</span></div>
<div style="position:absolute;left:79.64px;top:69.08px" class="cls_004"><span class="cls_004">nominal, 8, 24</span></div>
<div style="position:absolute;left:256.30px;top:78.51px" class="cls_007"><span class="cls_007">hash</span><span class="cls_004"> function, 89</span></div>
<div style="position:absolute;left:59.72px;top:81.10px" class="cls_004"><span class="cls_004">dependency hell, 10</span></div>
<div style="position:absolute;left:256.30px;top:90.47px" class="cls_004"><span class="cls_004">hash invariant, 142</span></div>
<div style="position:absolute;left:59.72px;top:93.12px" class="cls_004"><span class="cls_004">deployment policy, 42</span></div>
<div style="position:absolute;left:256.30px;top:102.42px" class="cls_004"><span class="cls_004">hash rewriting, 135, 143, 246,</span></div>
<div style="position:absolute;left:378.08px;top:102.42px" class="cls_004"><span class="cls_004">249</span></div>
<div style="position:absolute;left:59.97px;top:105.14px" class="cls_004"><span class="cls_004">D</span><span class="cls_014">ERIVATION</span><span class="cls_004"> semantic rule, 80, 100</span></div>
<div style="position:absolute;left:256.30px;top:114.38px" class="cls_007"><span class="cls_007">hashDrv</span><span class="cls_004"> function, 108</span></div>
<div style="position:absolute;left:59.72px;top:117.16px" class="cls_004"><span class="cls_004">derivation, 27</span></div>
<div style="position:absolute;left:256.30px;top:126.33px" class="cls_007"><span class="cls_007">hashModulo</span><span class="cls_004"> function, 144</span></div>
<div style="position:absolute;left:79.64px;top:129.18px" class="cls_004"><span class="cls_004">abstract syntax, 100</span></div>
<div style="position:absolute;left:256.30px;top:138.29px" class="cls_007"><span class="cls_007">hashPart</span><span class="cls_004"> function, 94, 144</span></div>
<div style="position:absolute;left:79.64px;top:141.20px" class="cls_004"><span class="cls_004">fixed-output, 106</span></div>
<div style="position:absolute;left:256.30px;top:150.24px" class="cls_004"><span class="cls_004">head normal form, 76</span></div>
<div style="position:absolute;left:79.64px;top:153.22px" class="cls_004"><span class="cls_004">multiple outputs, 160</span></div>
<div style="position:absolute;left:79.64px;top:165.24px" class="cls_004"><span class="cls_004">translation to store derivations, 100</span></div>
<div style="position:absolute;left:256.55px;top:171.76px" class="cls_004"><span class="cls_004">I</span><span class="cls_014">F</span><span class="cls_004">E</span><span class="cls_014">LSE</span><span class="cls_004"> semantic rule, 78</span></div>
<div style="position:absolute;left:59.72px;top:177.26px" class="cls_004"><span class="cls_004">deriver, 114, 249</span></div>
<div style="position:absolute;left:256.55px;top:183.72px" class="cls_004"><span class="cls_004">I</span><span class="cls_014">F</span><span class="cls_004">T</span><span class="cls_014">HEN</span><span class="cls_004"> semantic rule, 78</span></div>
<div style="position:absolute;left:59.72px;top:189.28px" class="cls_007"><span class="cls_007">deriver</span><span class="cls_004"> table, 114</span></div>
<div style="position:absolute;left:256.55px;top:195.67px" class="cls_004"><span class="cls_004">I</span><span class="cls_014">MPORT</span><span class="cls_004"> semantic rule, 80</span></div>
<div style="position:absolute;left:59.72px;top:201.30px" class="cls_007"><span class="cls_007">deserialise</span><span class="cls_004"> function, 92</span></div>
<div style="position:absolute;left:256.30px;top:207.63px" class="cls_007"><span class="cls_007">import</span><span class="cls_004"> keyword, 29</span></div>
<div style="position:absolute;left:59.72px;top:213.32px" class="cls_004"><span class="cls_004">destructive upgrading, 9, 21, 36</span></div>
<div style="position:absolute;left:256.55px;top:219.58px" class="cls_004"><span class="cls_004">I</span><span class="cls_014">MPORT</span><span class="cls_004">’ semantic rule, 81</span></div>
<div style="position:absolute;left:59.72px;top:225.34px" class="cls_004"><span class="cls_004">determinism, 21</span></div>
<div style="position:absolute;left:256.30px;top:231.54px" class="cls_004"><span class="cls_004">impurity, 177, 179</span></div>
<div style="position:absolute;left:59.72px;top:237.36px" class="cls_004"><span class="cls_004">DLL hell, 5, 12</span></div>
<div style="position:absolute;left:256.30px;top:243.50px" class="cls_004"><span class="cls_004">incomplete  deployment,  see</span></div>
<div style="position:absolute;left:381.49px;top:243.50px" class="cls_004"><span class="cls_004">complete</span></div>
<div style="position:absolute;left:59.72px;top:249.38px" class="cls_007"><span class="cls_007">drvPath</span><span class="cls_004"> attribute, 101</span></div>
<div style="position:absolute;left:296.15px;top:255.45px" class="cls_004"><span class="cls_004">deployment, 21</span></div>
<div style="position:absolute;left:59.72px;top:261.40px" class="cls_004"><span class="cls_004">dynamic composition, 170</span></div>
<div style="position:absolute;left:256.30px;top:267.41px" class="cls_007"><span class="cls_007">inherit</span><span class="cls_004"> keyword, 28, 74</span></div>
<div style="position:absolute;left:256.30px;top:279.36px" class="cls_007"><span class="cls_007">instantiate</span><span class="cls_004"> function, 102</span></div>
<div style="position:absolute;left:59.72px;top:284.47px" class="cls_004"><span class="cls_004">ELF executable, 23, 171, 179, 180</span></div>
<div style="position:absolute;left:256.30px;top:291.32px" class="cls_004"><span class="cls_004">integrity invariant, 97</span></div>
<div style="position:absolute;left:59.72px;top:296.49px" class="cls_007"><span class="cls_007">eqClassMembers</span><span class="cls_004"> table, 146</span></div>
<div style="position:absolute;left:256.30px;top:303.27px" class="cls_004"><span class="cls_004">intensional model, 87, 135</span></div>
<div style="position:absolute;left:59.72px;top:308.51px" class="cls_004"><span class="cls_004">equivalence class, 145</span></div>
<div style="position:absolute;left:256.30px;top:315.23px" class="cls_004"><span class="cls_004">interference, 9, 21</span></div>
<div style="position:absolute;left:59.72px;top:320.53px" class="cls_004"><span class="cls_004">equivalence class unicity invariant, 148</span></div>
<div style="position:absolute;left:256.30px;top:327.18px" class="cls_004"><span class="cls_004">isolation, 14, 19, 182</span></div>
<div style="position:absolute;left:59.72px;top:332.55px" class="cls_004"><span class="cls_004">extensional model, 87, 134</span></div>
<div style="position:absolute;left:256.30px;top:348.70px" class="cls_004"><span class="cls_004">Java, 4, 204</span></div>
<div style="position:absolute;left:59.72px;top:355.61px" class="cls_007"><span class="cls_007">fetchsvn</span><span class="cls_004"> Nix expression, 107</span></div>
<div style="position:absolute;left:59.72px;top:367.63px" class="cls_007"><span class="cls_007">fetchurl</span><span class="cls_004"> Nix expression, 27, 67, 106</span></div>
<div style="position:absolute;left:256.30px;top:370.22px" class="cls_004"><span class="cls_004">λ -calculus, 77</span></div>
<div style="position:absolute;left:59.72px;top:379.65px" class="cls_004"><span class="cls_004">file system object, 90</span></div>
<div style="position:absolute;left:256.30px;top:382.18px" class="cls_004"><span class="cls_004">late binding, 53, 170</span></div>
<div style="position:absolute;left:79.64px;top:391.67px" class="cls_004"><span class="cls_004">serialisation, 91</span></div>
<div style="position:absolute;left:256.30px;top:394.13px" class="cls_004"><span class="cls_004">laziness, 62, 83</span></div>
<div style="position:absolute;left:59.72px;top:403.69px" class="cls_007"><span class="cls_007">find</span><span class="cls_004"> function, 113, 144</span></div>
<div style="position:absolute;left:256.55px;top:406.09px" class="cls_004"><span class="cls_004">L</span><span class="cls_014">ET</span><span class="cls_004"> semantic rule, 77</span></div>
<div style="position:absolute;left:59.72px;top:415.71px" class="cls_007"><span class="cls_007">findRoots</span><span class="cls_004"> function, 127</span></div>
<div style="position:absolute;left:256.30px;top:418.04px" class="cls_007"><span class="cls_007">let</span><span class="cls_004"> keyword, 73, 77</span></div>
<div style="position:absolute;left:59.72px;top:427.73px" class="cls_004"><span class="cls_004">fixed-output derivation, 106</span></div>
<div style="position:absolute;left:256.30px;top:430.00px" class="cls_004"><span class="cls_004">let-expression, 73, 77</span></div>
<div style="position:absolute;left:59.72px;top:439.75px" class="cls_007"><span class="cls_007">followRef</span><span class="cls_004"> function, 147</span></div>
<div style="position:absolute;left:256.30px;top:441.95px" class="cls_004"><span class="cls_004">Linux, 6, 169</span></div>
<div style="position:absolute;left:59.72px;top:451.78px" class="cls_004"><span class="cls_004">free variable, 75</span></div>
<div style="position:absolute;left:256.30px;top:453.91px" class="cls_007"><span class="cls_007">livePaths</span><span class="cls_004"> function, 129</span></div>
<div style="position:absolute;left:59.72px;top:463.80px" class="cls_004"><span class="cls_004">FreeBSD, 169</span></div>
<div style="position:absolute;left:256.30px;top:465.86px" class="cls_004"><span class="cls_004">locking, 99</span></div>
<div style="position:absolute;left:59.72px;top:475.82px" class="cls_004"><span class="cls_004">FreeBSD Ports Collection, 11, 201</span></div>
<div style="position:absolute;left:256.30px;top:477.82px" class="cls_004"><span class="cls_004">logging, 176</span></div>
<div style="position:absolute;left:59.72px;top:487.84px" class="cls_004"><span class="cls_004">FSO, see file system object</span></div>
<div style="position:absolute;left:256.30px;top:499.34px" class="cls_004"><span class="cls_004">Maak, 241</span></div>
<div style="position:absolute;left:59.72px;top:510.90px" class="cls_004"><span class="cls_004">garbage collection, 38, 124</span></div>
<div style="position:absolute;left:256.30px;top:511.29px" class="cls_004"><span class="cls_004">Mac OS X, 12, 169</span></div>
<div style="position:absolute;left:79.64px;top:522.92px" class="cls_004"><span class="cls_004">conservative, 24, 56</span></div>
<div style="position:absolute;left:256.30px;top:523.25px" class="cls_004"><span class="cls_004">Make, 233, 240</span></div>
<div style="position:absolute;left:79.64px;top:534.94px" class="cls_004"><span class="cls_004">liveness, 128</span></div>
<div style="position:absolute;left:256.30px;top:535.20px" class="cls_007"><span class="cls_007">makePath</span><span class="cls_004"> function, 94,</span></div>
<div style="position:absolute;left:351.75px;top:535.20px" class="cls_004"><span class="cls_004">142</span></div>
<div style="position:absolute;left:79.64px;top:546.96px" class="cls_004"><span class="cls_004">roots, 38, 125</span></div>
<div style="position:absolute;left:256.30px;top:547.16px" class="cls_004"><span class="cls_004">manifest, 45, 186</span></div>
<div style="position:absolute;left:79.64px;top:558.98px" class="cls_004"><span class="cls_004">stop-the-world approach, 129</span></div>
<div style="position:absolute;left:256.30px;top:559.11px" class="cls_004"><span class="cls_004">maximal laziness, 83</span></div>
<div style="position:absolute;left:59.72px;top:571.00px" class="cls_004"><span class="cls_004">generic builder, 33, 175</span></div>
<div style="position:absolute;left:256.30px;top:571.07px" class="cls_004"><span class="cls_004">maximal sharing, 59</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">Gentoo Linux, 6, 201</span></div>
<div style="position:absolute;left:256.30px;top:583.02px" class="cls_007"><span class="cls_007">maybeRewrite</span><span class="cls_004"> function, 151</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">260</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:182160px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background269.jpg" width=481 height=680></div>
<div style="position:absolute;left:399.64px;top:17.14px" class="cls_004"><span class="cls_004">Index</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">MD5, 88</span></div>
<div style="position:absolute;left:260.71px;top:45.04px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">N</span><span class="cls_014">EG</span><span class="cls_004"> semantic rule, 79</span></div>
<div style="position:absolute;left:63.87px;top:57.05px" class="cls_004"><span class="cls_004">Microsoft Windows, 12, 170</span></div>
<div style="position:absolute;left:260.71px;top:57.06px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">O</span><span class="cls_014">R</span><span class="cls_004"> semantic rule, 79</span></div>
<div style="position:absolute;left:63.87px;top:69.05px" class="cls_004"><span class="cls_004">multiple outputs, 105, 160</span></div>
<div style="position:absolute;left:260.71px;top:69.08px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">P</span><span class="cls_014">LUS</span><span class="cls_004">P</span><span class="cls_014">ATH</span><span class="cls_004"> semantic rule, 79</span></div>
<div style="position:absolute;left:260.71px;top:81.10px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">P</span><span class="cls_014">LUS</span><span class="cls_004">S</span><span class="cls_014">TR</span><span class="cls_004"> semantic rule, 79</span></div>
<div style="position:absolute;left:63.87px;top:91.89px" class="cls_007"><span class="cls_007">name</span><span class="cls_004"> attribute, 27, 108</span></div>
<div style="position:absolute;left:260.71px;top:93.12px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">U</span><span class="cls_014">PDATE</span><span class="cls_004"> semantic rule, 79</span></div>
<div style="position:absolute;left:63.87px;top:103.90px" class="cls_007"><span class="cls_007">namePart</span><span class="cls_004"> function, 94, 142</span></div>
<div style="position:absolute;left:260.46px;top:105.14px" class="cls_007"><span class="cls_007">outPath</span><span class="cls_004"> attribute, 101</span></div>
<div style="position:absolute;left:63.87px;top:115.91px" class="cls_004"><span class="cls_004">NAR, see Nix Archive</span></div>
<div style="position:absolute;left:260.46px;top:117.16px" class="cls_004"><span class="cls_004">output path, 28</span></div>
<div style="position:absolute;left:63.87px;top:127.92px" class="cls_004"><span class="cls_004">.NET, 12, 203</span></div>
<div style="position:absolute;left:260.46px;top:129.19px" class="cls_007"><span class="cls_007">outputHash</span><span class="cls_004"> attribute, 107</span></div>
<div style="position:absolute;left:63.87px;top:139.92px" class="cls_004"><span class="cls_004">Nix, 3, 14</span></div>
<div style="position:absolute;left:260.46px;top:141.21px" class="cls_007"><span class="cls_007">outputHashAlgo</span><span class="cls_004"> attribute, 107</span></div>
<div style="position:absolute;left:83.80px;top:151.93px" class="cls_004"><span class="cls_004">homepage, 14</span></div>
<div style="position:absolute;left:260.46px;top:153.23px" class="cls_007"><span class="cls_007">outputHashMode</span><span class="cls_004"> attribute, 107</span></div>
<div style="position:absolute;left:63.87px;top:163.94px" class="cls_004"><span class="cls_004">Nix Archive, 92</span></div>
<div style="position:absolute;left:63.87px;top:175.95px" class="cls_004"><span class="cls_004">Nix expression, 25</span></div>
<div style="position:absolute;left:260.46px;top:176.31px" class="cls_004"><span class="cls_004">package, 19, 49</span></div>
<div style="position:absolute;left:83.80px;top:187.95px" class="cls_004"><span class="cls_004">semantics, 71</span></div>
<div style="position:absolute;left:260.46px;top:188.33px" class="cls_007"><span class="cls_007">parseDrv</span><span class="cls_004"> function, 108</span></div>
<div style="position:absolute;left:83.80px;top:199.96px" class="cls_004"><span class="cls_004">syntax, 64</span></div>
<div style="position:absolute;left:260.46px;top:200.35px" class="cls_004"><span class="cls_004">partial parameterisation, 31</span></div>
<div style="position:absolute;left:63.87px;top:211.97px" class="cls_004"><span class="cls_004">Nix Packages collection, 25, 42, 44,</span></div>
<div style="position:absolute;left:209.83px;top:211.97px" class="cls_004"><span class="cls_004">167</span></div>
<div style="position:absolute;left:260.46px;top:212.37px" class="cls_004"><span class="cls_004">patch chaining, 195</span></div>
<div style="position:absolute;left:63.87px;top:223.98px" class="cls_007"><span class="cls_007">nix-build</span><span class="cls_004"> command, 108, 125, 238</span></div>
<div style="position:absolute;left:260.46px;top:224.39px" class="cls_004"><span class="cls_004">PatchELF, 213</span></div>
<div style="position:absolute;left:63.87px;top:235.98px" class="cls_007"><span class="cls_007">nix-env</span><span class="cls_004"> command, 35</span></div>
<div style="position:absolute;left:260.46px;top:236.41px" class="cls_007"><span class="cls_007">patchelf</span><span class="cls_004"> command, 179, 181</span></div>
<div style="position:absolute;left:83.80px;top:247.99px" class="cls_007"><span class="cls_007">--import</span><span class="cls_004"> (</span><span class="cls_007">-I</span><span class="cls_004">), 35</span></div>
<div style="position:absolute;left:260.46px;top:248.43px" class="cls_004"><span class="cls_004">path literal, 67</span></div>
<div style="position:absolute;left:83.80px;top:260.00px" class="cls_007"><span class="cls_007">--install</span><span class="cls_004"> (</span><span class="cls_007">-i</span><span class="cls_004">), 35, 187</span></div>
<div style="position:absolute;left:260.46px;top:260.45px" class="cls_004"><span class="cls_004">Perl, 174</span></div>
<div style="position:absolute;left:83.80px;top:272.01px" class="cls_007"><span class="cls_007">--query</span><span class="cls_004"> (</span><span class="cls_007">-q</span><span class="cls_004">), 35, 63</span></div>
<div style="position:absolute;left:260.46px;top:272.47px" class="cls_004"><span class="cls_004">pointer discipline, 87</span></div>
<div style="position:absolute;left:83.80px;top:284.01px" class="cls_007"><span class="cls_007">--remove-generations</span><span class="cls_004">, 38</span></div>
<div style="position:absolute;left:260.46px;top:284.49px" class="cls_004"><span class="cls_004">pointer graph, 56</span></div>
<div style="position:absolute;left:83.80px;top:296.02px" class="cls_007"><span class="cls_007">--rollback</span><span class="cls_004">, 36</span></div>
<div style="position:absolute;left:260.46px;top:296.51px" class="cls_004"><span class="cls_004">pointer hiding, 58, 182</span></div>
<div style="position:absolute;left:83.80px;top:308.03px" class="cls_007"><span class="cls_007">--switch-profile</span><span class="cls_004">, 37</span></div>
<div style="position:absolute;left:260.46px;top:308.53px" class="cls_004"><span class="cls_004">Portage, 201</span></div>
<div style="position:absolute;left:83.80px;top:320.03px" class="cls_007"><span class="cls_007">--uninstall</span><span class="cls_004"> (</span><span class="cls_007">-e</span><span class="cls_004">), 38</span></div>
<div style="position:absolute;left:260.46px;top:320.56px" class="cls_004"><span class="cls_004">primop, 80</span></div>
<div style="position:absolute;left:83.80px;top:332.04px" class="cls_007"><span class="cls_007">--upgrade</span><span class="cls_004"> (</span><span class="cls_007">-u</span><span class="cls_004">), 43, 189</span></div>
<div style="position:absolute;left:260.46px;top:332.58px" class="cls_007"><span class="cls_007">printDrv</span><span class="cls_004"> function, 105</span></div>
<div style="position:absolute;left:63.87px;top:344.05px" class="cls_007"><span class="cls_007">nix-instantiate</span><span class="cls_004"> command, 39, 100</span></div>
<div style="position:absolute;left:260.46px;top:344.60px" class="cls_004"><span class="cls_004">printHash</span><span class="cls_012"><sub>16</sub></span><span class="cls_004"> function, 89</span></div>
<div style="position:absolute;left:63.87px;top:356.06px" class="cls_007"><span class="cls_007">nix-store</span><span class="cls_004"> command, 38</span></div>
<div style="position:absolute;left:260.46px;top:356.62px" class="cls_004"><span class="cls_004">printHash</span><span class="cls_012"><sub>32</sub></span><span class="cls_004"> function, 89</span></div>
<div style="position:absolute;left:83.80px;top:368.06px" class="cls_007"><span class="cls_007">--gc</span><span class="cls_004">, 38</span></div>
<div style="position:absolute;left:260.46px;top:368.64px" class="cls_004"><span class="cls_004">privacy, 158</span></div>
<div style="position:absolute;left:83.80px;top:380.07px" class="cls_007"><span class="cls_007">--query</span><span class="cls_004">, 41, 97</span></div>
<div style="position:absolute;left:260.46px;top:380.66px" class="cls_007"><span class="cls_007">processBinding</span><span class="cls_004"> function, 103</span></div>
<div style="position:absolute;left:83.80px;top:392.08px" class="cls_007"><span class="cls_007">--realise</span><span class="cls_004">, 41, 100, 108</span></div>
<div style="position:absolute;left:260.46px;top:392.68px" class="cls_004"><span class="cls_004">profile, 37</span></div>
<div style="position:absolute;left:83.80px;top:404.09px" class="cls_007"><span class="cls_007">--register-substitutes</span><span class="cls_004">, 158, 187</span></div>
<div style="position:absolute;left:260.46px;top:404.70px" class="cls_004"><span class="cls_004">purely functional deployment model,</span></div>
<div style="position:absolute;left:409.72px;top:404.70px" class="cls_004"><span class="cls_004">14,</span></div>
<div style="position:absolute;left:83.80px;top:416.09px" class="cls_007"><span class="cls_007">--register-substitute</span><span class="cls_004">, 119</span></div>
<div style="position:absolute;left:300.31px;top:416.66px" class="cls_004"><span class="cls_004">21, 167, 245</span></div>
<div style="position:absolute;left:83.80px;top:428.10px" class="cls_007"><span class="cls_007">--register-validity</span><span class="cls_004">, 118</span></div>
<div style="position:absolute;left:260.46px;top:428.68px" class="cls_004"><span class="cls_004">purity, 178, 183</span></div>
<div style="position:absolute;left:83.80px;top:440.11px" class="cls_007"><span class="cls_007">--verify</span><span class="cls_004">, 96</span></div>
<div style="position:absolute;left:260.46px;top:440.70px" class="cls_004"><span class="cls_004">Python, 174</span></div>
<div style="position:absolute;left:63.87px;top:452.12px" class="cls_004"><span class="cls_004">NixOS, iii, 180, 247</span></div>
<div style="position:absolute;left:63.87px;top:464.12px" class="cls_004"><span class="cls_004">Nixpkgs, see Nix Packages collection</span></div>
<div style="position:absolute;left:260.46px;top:463.78px" class="cls_004"><span class="cls_004">queries, 35</span></div>
<div style="position:absolute;left:63.87px;top:476.13px" class="cls_004"><span class="cls_004">non-strictness, 83</span></div>
<div style="position:absolute;left:63.87px;top:488.14px" class="cls_004"><span class="cls_004">non-termination, 76</span></div>
<div style="position:absolute;left:260.46px;top:486.86px" class="cls_007"><span class="cls_007">readPath</span><span class="cls_004"> function, 91</span></div>
<div style="position:absolute;left:260.71px;top:498.88px" class="cls_004"><span class="cls_004">R</span><span class="cls_014">EC</span><span class="cls_004"> semantic rule, 77, 83, 85</span></div>
<div style="position:absolute;left:63.87px;top:510.98px" class="cls_004"><span class="cls_004">Odin, 62, 241</span></div>
<div style="position:absolute;left:260.46px;top:510.90px" class="cls_007"><span class="cls_007">rec</span><span class="cls_004"> keyword, 29, 73, 77</span></div>
<div style="position:absolute;left:63.87px;top:522.99px" class="cls_004"><span class="cls_004">one-click installation, 43, 189</span></div>
<div style="position:absolute;left:260.46px;top:522.92px" class="cls_004"><span class="cls_004">recursion, 73</span></div>
<div style="position:absolute;left:64.12px;top:534.99px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">A</span><span class="cls_014">ND</span><span class="cls_004"> semantic rule, 79</span></div>
<div style="position:absolute;left:260.46px;top:534.94px" class="cls_004"><span class="cls_004">Red Hat Package Manager, 6, 201</span></div>
<div style="position:absolute;left:64.12px;top:547.00px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">E</span><span class="cls_014">Q</span><span class="cls_004"> semantic rule, 78</span></div>
<div style="position:absolute;left:260.46px;top:546.96px" class="cls_007"><span class="cls_007">refClasses</span><span class="cls_004"> table, 147</span></div>
<div style="position:absolute;left:64.12px;top:559.01px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">H</span><span class="cls_014">AS</span><span class="cls_004">A</span><span class="cls_014">TTR</span><span class="cls_004">+ semantic rule, 79</span></div>
<div style="position:absolute;left:260.46px;top:558.98px" class="cls_004"><span class="cls_004">reference, 23, 53, 55, 96</span></div>
<div style="position:absolute;left:64.12px;top:571.01px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">H</span><span class="cls_014">AS</span><span class="cls_004">A</span><span class="cls_014">TTR</span><span class="cls_004">- semantic rule, 79</span></div>
<div style="position:absolute;left:260.46px;top:571.00px" class="cls_004"><span class="cls_004">reference invariant, 119</span></div>
<div style="position:absolute;left:64.12px;top:583.02px" class="cls_004"><span class="cls_004">O</span><span class="cls_014">P</span><span class="cls_004">I</span><span class="cls_014">MPL</span><span class="cls_004"> semantic rule, 79</span></div>
<div style="position:absolute;left:260.46px;top:583.02px" class="cls_007"><span class="cls_007">references</span><span class="cls_004"> table, 96</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">261</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:182850px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background270.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">Index</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_007"><span class="cls_007">referers</span><span class="cls_004"> table, 96</span></div>
<div style="position:absolute;left:256.30px;top:45.04px" class="cls_004"><span class="cls_004">Syntax Definition Formalism, 64</span></div>
<div style="position:absolute;left:59.72px;top:57.03px" class="cls_004"><span class="cls_004">referrer closure, 97</span></div>
<div style="position:absolute;left:256.30px;top:56.99px" class="cls_007"><span class="cls_007">system</span><span class="cls_004"> attribute, 102</span></div>
<div style="position:absolute;left:59.72px;top:69.02px" class="cls_004"><span class="cls_004">release, 17</span></div>
<div style="position:absolute;left:59.72px;top:81.00px" class="cls_007"><span class="cls_007">releasePathLock</span><span class="cls_004"> function, 99</span></div>
<div style="position:absolute;left:256.30px;top:78.91px" class="cls_004"><span class="cls_004">tarball, 214</span></div>
<div style="position:absolute;left:59.72px;top:92.99px" class="cls_007"><span class="cls_007">replace</span><span class="cls_004"> function, 144</span></div>
<div style="position:absolute;left:256.30px;top:90.87px" class="cls_004"><span class="cls_004">TraCE, iii, 14</span></div>
<div style="position:absolute;left:59.72px;top:104.98px" class="cls_007"><span class="cls_007">resolve</span><span class="cls_004"> function, 150</span></div>
<div style="position:absolute;left:256.30px;top:102.82px" class="cls_004"><span class="cls_004">traceability, 114</span></div>
<div style="position:absolute;left:59.72px;top:116.97px" class="cls_004"><span class="cls_004">retained dependency, 23, 54</span></div>
<div style="position:absolute;left:256.30px;top:114.78px" class="cls_004"><span class="cls_004">traceability invariant, 114</span></div>
<div style="position:absolute;left:59.72px;top:128.96px" class="cls_004"><span class="cls_004">rollback, 5, 36</span></div>
<div style="position:absolute;left:256.30px;top:126.73px" class="cls_004"><span class="cls_004">transparent  source/binary  deployment,</span></div>
<div style="position:absolute;left:59.72px;top:140.94px" class="cls_007"><span class="cls_007">RPATH</span><span class="cls_004">, 23, 171, 179</span></div>
<div style="position:absolute;left:296.15px;top:138.69px" class="cls_004"><span class="cls_004">15, 45, 118, 185, 188</span></div>
<div style="position:absolute;left:59.72px;top:152.93px" class="cls_004"><span class="cls_004">RPM, see Red Hat Package Manager</span></div>
<div style="position:absolute;left:256.30px;top:150.64px" class="cls_004"><span class="cls_004">Trojan horse, 88, 135</span></div>
<div style="position:absolute;left:256.30px;top:162.60px" class="cls_004"><span class="cls_004">trust, 137</span></div>
<div style="position:absolute;left:59.72px;top:175.43px" class="cls_007"><span class="cls_007">scanForReferences</span><span class="cls_004"> function, 113, 163</span></div>
<div style="position:absolute;left:256.30px;top:174.55px" class="cls_007"><span class="cls_007">type</span><span class="cls_004"> attribute, 101</span></div>
<div style="position:absolute;left:59.72px;top:187.42px" class="cls_004"><span class="cls_004">SDF, see Syntax Definition Formalism</span></div>
<div style="position:absolute;left:256.30px;top:196.47px" class="cls_004"><span class="cls_004">Unix, 6, 200</span></div>
<div style="position:absolute;left:59.72px;top:199.41px" class="cls_004"><span class="cls_004">security, 135</span></div>
<div style="position:absolute;left:256.30px;top:208.43px" class="cls_004"><span class="cls_004">update operator, 79</span></div>
<div style="position:absolute;left:59.97px;top:211.39px" class="cls_004"><span class="cls_004">S</span><span class="cls_014">ELECT</span><span class="cls_004"> semantic rule, 77, 83, 85</span></div>
<div style="position:absolute;left:256.30px;top:220.38px" class="cls_004"><span class="cls_004">usable path, 119, 146</span></div>
<div style="position:absolute;left:59.72px;top:223.38px" class="cls_007"><span class="cls_007">serialise</span><span class="cls_004"> function, 93</span></div>
<div style="position:absolute;left:256.30px;top:232.34px" class="cls_004"><span class="cls_004">user environment, 35, 36, 184</span></div>
<div style="position:absolute;left:59.72px;top:235.37px" class="cls_004"><span class="cls_004">service, 221</span></div>
<div style="position:absolute;left:59.72px;top:247.36px" class="cls_004"><span class="cls_004">service deployment, 17, 221</span></div>
<div style="position:absolute;left:256.30px;top:254.25px" class="cls_007"><span class="cls_007">valid</span><span class="cls_004"> table, 95</span></div>
<div style="position:absolute;left:59.72px;top:259.35px" class="cls_007"><span class="cls_007">setReferences</span><span class="cls_004"> function, 97</span></div>
<div style="position:absolute;left:256.30px;top:266.21px" class="cls_004"><span class="cls_004">valid path, 95</span></div>
<div style="position:absolute;left:59.72px;top:271.33px" class="cls_004"><span class="cls_004">SHA-1, 88</span></div>
<div style="position:absolute;left:256.30px;top:278.17px" class="cls_004"><span class="cls_004">validation, 181</span></div>
<div style="position:absolute;left:59.72px;top:283.32px" class="cls_004"><span class="cls_004">SHA-256, 88</span></div>
<div style="position:absolute;left:256.30px;top:290.12px" class="cls_004"><span class="cls_004">validity invariant, 95</span></div>
<div style="position:absolute;left:59.72px;top:295.31px" class="cls_004"><span class="cls_004">sharing, 59, 135</span></div>
<div style="position:absolute;left:256.30px;top:302.08px" class="cls_004"><span class="cls_004">variability, 4, 31, 245</span></div>
<div style="position:absolute;left:59.72px;top:307.30px" class="cls_004"><span class="cls_004">Software Dock, 204</span></div>
<div style="position:absolute;left:256.30px;top:314.03px" class="cls_004"><span class="cls_004">Vesta, 202, 241</span></div>
<div style="position:absolute;left:59.72px;top:319.29px" class="cls_004"><span class="cls_004">source deployment, 11, 42, 44,</span></div>
<div style="position:absolute;left:184.97px;top:319.29px" class="cls_004"><span class="cls_004">185,</span></div>
<div style="position:absolute;left:204.89px;top:319.29px" class="cls_004"><span class="cls_004">187</span></div>
<div style="position:absolute;left:59.72px;top:331.27px" class="cls_004"><span class="cls_004">spec file, 7</span></div>
<div style="position:absolute;left:256.30px;top:335.95px" class="cls_004"><span class="cls_004">weak head normal form, 76</span></div>
<div style="position:absolute;left:59.72px;top:343.26px" class="cls_004"><span class="cls_004">spyware, 137</span></div>
<div style="position:absolute;left:256.30px;top:347.90px" class="cls_004"><span class="cls_004">Web Start, 204</span></div>
<div style="position:absolute;left:59.72px;top:355.25px" class="cls_004"><span class="cls_004">standard environment, 26, 174</span></div>
<div style="position:absolute;left:256.55px;top:359.86px" class="cls_004"><span class="cls_004">W</span><span class="cls_014">ITH</span><span class="cls_004"> semantic rule, 78, 85</span></div>
<div style="position:absolute;left:59.72px;top:367.24px" class="cls_004"><span class="cls_004">static composition, 170</span></div>
<div style="position:absolute;left:256.30px;top:371.81px" class="cls_004"><span class="cls_004">working copy, 43</span></div>
<div style="position:absolute;left:59.72px;top:379.23px" class="cls_004"><span class="cls_004">store, 19, 90</span></div>
<div style="position:absolute;left:256.30px;top:383.77px" class="cls_007"><span class="cls_007">writePath</span><span class="cls_004"> function, 91</span></div>
<div style="position:absolute;left:59.72px;top:391.21px" class="cls_004"><span class="cls_004">store derivation, 39</span></div>
<div style="position:absolute;left:79.64px;top:403.20px" class="cls_004"><span class="cls_004">abstract syntax, 101</span></div>
<div style="position:absolute;left:256.30px;top:405.69px" class="cls_004"><span class="cls_004">XML, 177, 248, 249</span></div>
<div style="position:absolute;left:79.64px;top:415.19px" class="cls_004"><span class="cls_004">instantiation, 100</span></div>
<div style="position:absolute;left:256.30px;top:417.64px" class="cls_004"><span class="cls_004">XSLT, 177</span></div>
<div style="position:absolute;left:79.64px;top:427.18px" class="cls_004"><span class="cls_004">realisation, 41</span></div>
<div style="position:absolute;left:59.72px;top:439.17px" class="cls_004"><span class="cls_004">store object, 92</span></div>
<div style="position:absolute;left:256.30px;top:439.56px" class="cls_004"><span class="cls_004">Yum, 11, 201</span></div>
<div style="position:absolute;left:79.64px;top:451.15px" class="cls_004"><span class="cls_004">validity, 95</span></div>
<div style="position:absolute;left:59.72px;top:463.14px" class="cls_004"><span class="cls_004">store path, 20, 92</span></div>
<div style="position:absolute;left:256.30px;top:461.48px" class="cls_004"><span class="cls_004">Zero Install, 13, 136, 170</span></div>
<div style="position:absolute;left:59.72px;top:475.13px" class="cls_004"><span class="cls_004">stored hash invariant, 96</span></div>
<div style="position:absolute;left:59.72px;top:487.12px" class="cls_004"><span class="cls_004">string literal, 67</span></div>
<div style="position:absolute;left:59.72px;top:499.11px" class="cls_004"><span class="cls_004">subpath, 72</span></div>
<div style="position:absolute;left:59.72px;top:511.09px" class="cls_007"><span class="cls_007">subst</span><span class="cls_004"> function, 75</span></div>
<div style="position:absolute;left:59.72px;top:523.08px" class="cls_004"><span class="cls_004">substitute, 45, 108, 118, 185</span></div>
<div style="position:absolute;left:59.72px;top:535.07px" class="cls_007"><span class="cls_007">substitute</span><span class="cls_004"> function, 109</span></div>
<div style="position:absolute;left:79.64px;top:547.06px" class="cls_004"><span class="cls_004">in the extensional model, 120</span></div>
<div style="position:absolute;left:79.64px;top:559.05px" class="cls_004"><span class="cls_004">in the intensional model, 158</span></div>
<div style="position:absolute;left:59.72px;top:571.03px" class="cls_007"><span class="cls_007">substitutes</span><span class="cls_004"> table, 118, 157</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">Subversion, 31, 107</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">262</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:183540px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background271.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:88.81px" class="cls_006"><span class="cls_006">Samenvatting</span></div>
<div style="position:absolute;left:63.87px;top:129.54px" class="cls_004"><span class="cls_004">De installatie van software en de daarmee samenhangende activiteiten lijken altijd te mis-</span></div>
<div style="position:absolute;left:63.87px;top:141.49px" class="cls_004"><span class="cls_004">lukken.  Zo komt het regelmatig voor dat het installeren of upgraden van een software-</span></div>
<div style="position:absolute;left:63.87px;top:153.45px" class="cls_004"><span class="cls_004">toepassing leidt tot het falen van eerder geïnstalleerde toepassingen. Of het blijkt dat een</span></div>
<div style="position:absolute;left:63.87px;top:165.40px" class="cls_004"><span class="cls_004">applicatie afhankelijk is van componenten die niet aanwezig zijn op het systeem. Het is</span></div>
<div style="position:absolute;left:63.87px;top:177.36px" class="cls_004"><span class="cls_004">meestal ook niet mogelijk om dit soort acties terug te draaien als ze naderhand niet blij-</span></div>
<div style="position:absolute;left:63.87px;top:189.31px" class="cls_004"><span class="cls_004">ken te bevallen. Deze activiteiten worden aangeduid als software deployment, d.w.z. het</span></div>
<div style="position:absolute;left:63.87px;top:201.27px" class="cls_004"><span class="cls_004">in gebruik nemen of “uitrollen” van software.  Het onderwerp van dit proefschrift is de</span></div>
<div style="position:absolute;left:63.87px;top:213.22px" class="cls_004"><span class="cls_004">ontwikkeling van betere technieken om deployment te ondersteunen.</span></div>
<div style="position:absolute;left:73.84px;top:225.18px" class="cls_004"><span class="cls_004">De onderliggende problemen die de deploymentmalaise veroorzaken zijn een gebrek</span></div>
<div style="position:absolute;left:63.87px;top:237.13px" class="cls_004"><span class="cls_004">aan isolatie tussen componenten, en het feit dat het lastig is om afhankelijkheden (depen-</span></div>
<div style="position:absolute;left:63.87px;top:249.09px" class="cls_004"><span class="cls_004">dencies) tussen componenten correct te identificeren. Voorts schaalt deployment moeilijk</span></div>
<div style="position:absolute;left:63.87px;top:261.04px" class="cls_004"><span class="cls_004">op. Zo toont Figuur 1.5 op pagina 10 de afhankelijkheden van de browser Mozilla Firefox.</span></div>
<div style="position:absolute;left:63.87px;top:273.00px" class="cls_004"><span class="cls_004">Elke component kan in potentie de deployment van Firefox doen mislukken. Zo kan de</span></div>
<div style="position:absolute;left:63.87px;top:284.95px" class="cls_004"><span class="cls_004">component afwezig zijn, aanwezig zijn in een incompatibele versie, of aanwezig zijn in</span></div>
<div style="position:absolute;left:63.87px;top:296.91px" class="cls_004"><span class="cls_004">een compatibele versie maar met verkeerde compilerinstellingen gebouwd zijn.</span></div>
<div style="position:absolute;left:73.84px;top:308.86px" class="cls_004"><span class="cls_004">Er zijn talloze deploymenttechnologieën, in de Unix-wereld ook wel package managers</span></div>
<div style="position:absolute;left:63.87px;top:320.82px" class="cls_004"><span class="cls_004">genaamd.  Ik noem met name RPM, Debian APT, Gentoo Portage, .NET assemblies en</span></div>
<div style="position:absolute;left:63.87px;top:332.78px" class="cls_004"><span class="cls_004">Mac OS application bundles. Het belang van deployment—en het verlangen naar verbete-</span></div>
<div style="position:absolute;left:63.87px;top:344.73px" class="cls_004"><span class="cls_004">ringen op dit vlak—wordt onderstreept door het feit dat Linux-distributies zich in de eerste</span></div>
<div style="position:absolute;left:63.87px;top:356.69px" class="cls_004"><span class="cls_004">plaats onderscheiden in hun package-managementsystemen. Deze hebben echter allemaal</span></div>
<div style="position:absolute;left:63.87px;top:368.64px" class="cls_004"><span class="cls_004">ernstige tekortkomingen. Ze zijn niet in staat om volledige afhankelijkheidsspecificaties af</span></div>
<div style="position:absolute;left:63.87px;top:380.60px" class="cls_004"><span class="cls_004">te dwingen, ze ondersteunen niet de aanwezigheid van meerdere versies van een compo-</span></div>
<div style="position:absolute;left:63.87px;top:392.55px" class="cls_004"><span class="cls_004">nent, enzovoorts.</span></div>
<div style="position:absolute;left:73.84px;top:404.51px" class="cls_004"><span class="cls_004">Er is tot op heden betrekkelijk weinig onderzoek geweest naar deployment, en vrijwel</span></div>
<div style="position:absolute;left:63.87px;top:416.46px" class="cls_004"><span class="cls_004">helemaal niet naar de low-level aspecten zoals de opslag van componenten in het bestands-</span></div>
<div style="position:absolute;left:63.87px;top:428.42px" class="cls_004"><span class="cls_004">systeem (waar isolatie immers gerealiseerd moet worden). In plaats daarvan is vooruitgang</span></div>
<div style="position:absolute;left:63.87px;top:440.37px" class="cls_004"><span class="cls_004">op dit gebied voornamelijk geboekt door systeembeheerders en Unix-hackers. Dit is niet</span></div>
<div style="position:absolute;left:63.87px;top:452.33px" class="cls_004"><span class="cls_004">verbazingwekkend: deployment is een onderdeel van het vakgebied van systeembeheer,</span></div>
<div style="position:absolute;left:63.87px;top:464.28px" class="cls_004"><span class="cls_004">een onderwerp dat volgens Pike [136] vooralsnog “deeply difficult” is.</span></div>
<div style="position:absolute;left:63.87px;top:491.81px" class="cls_008"><span class="cls_008">Het Nix deploymentsysteem</span></div>
<div style="position:absolute;left:63.87px;top:511.29px" class="cls_009"><span class="cls_009">De Nix store</span><span class="cls_004">   Dit proefschrift beschrijft een betere aanpak, een zogenaamd puur functi-</span></div>
<div style="position:absolute;left:63.87px;top:523.25px" class="cls_004"><span class="cls_004">oneel deploymentmodel. Zo’n model is geïmplementeerd in een deploymentsysteem ge-</span></div>
<div style="position:absolute;left:63.87px;top:535.20px" class="cls_004"><span class="cls_004">naamd Nix. Nix slaat componenten in isolatie van elkaar op in een Nix store, een speciale</span></div>
<div style="position:absolute;left:63.87px;top:547.16px" class="cls_004"><span class="cls_004">directory in het bestandssysteem.</span></div>
<div style="position:absolute;left:73.84px;top:559.11px" class="cls_004"><span class="cls_004">In Nix wordt elke component opgeslagen onder een speciaal pad zoals</span><span class="cls_007"> /nix/store/-</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_007"><span class="cls_007">2zbay49r2ihrznny6vbrcjvils4nqm1w-firefox-1.0.7</span><span class="cls_004">.  Het deel</span><span class="cls_007"> 2zbay49r2ihr...</span><span class="cls_004">  is een crypto-</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">grafische hash van alle invoer die heeft bijgedragen aan de berekening van de component.</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">263</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:184230px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background272.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:17.14px" class="cls_004"><span class="cls_004">Samenvatting</span></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">Daarom heet het model puur functioneel: net als in puur functionele programmeertalen</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">wordt het resultaat van een bouwactie alleen bepaald door de opgegeven invoer. Crypto-</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">grafische hashes hebben de plezierige eigenschap dat het erg moeilijk is om twee verschil-</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">lende sets van invoeren te vinden die dezelfde hash opleveren. Hierdoor kunnen we er in</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">de praktijk vanuit gaan dat als twee componenten op enige wijze verschillen, ze een ver-</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">schillende hash opleveren en dus op verschillende locaties in het bestandssysteem worden</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">opgeslagen. Dit zorgt voor de gewenste isolatie tussen componenten. De installatie van een</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">applicatie kan niet langer leiden tot de beschadiging van reeds geïnstalleerde applicaties.</span></div>
<div style="position:absolute;left:69.68px;top:141.13px" class="cls_004"><span class="cls_004">Het gebruik van hashes lost ook het andere grote deploymentprobleem op—onvolledige</span></div>
<div style="position:absolute;left:59.72px;top:153.08px" class="cls_004"><span class="cls_004">afhankelijkheidsinformatie.  Ten eerste voorkomt het ongedeclareerde afhankelijkheden</span></div>
<div style="position:absolute;left:59.72px;top:165.04px" class="cls_004"><span class="cls_004">tijdens bouwtijd. Immers, bouwtools zoals compilers en linkers zoeken niet standaard in</span></div>
<div style="position:absolute;left:59.72px;top:176.99px" class="cls_004"><span class="cls_004">paden zoals</span><span class="cls_007"> /nix/store/2zbay49r2ihr...-firefox-1.0.7</span><span class="cls_004">.</span></div>
<div style="position:absolute;left:69.68px;top:189.40px" class="cls_004"><span class="cls_004">Ten tweede maakt het het ons mogelijk om te scannen naar de afhankelijkheden die</span></div>
<div style="position:absolute;left:59.72px;top:201.35px" class="cls_004"><span class="cls_004">kunnen optreden gedurende de executie van een component. Dit houdt in dat we de binaire</span></div>
<div style="position:absolute;left:59.72px;top:213.31px" class="cls_004"><span class="cls_004">inhoud van een component doorzoeken op de aanwezigheid van de hashonderdelen van</span></div>
<div style="position:absolute;left:59.72px;top:225.26px" class="cls_004"><span class="cls_004">de bestandsnamen van andere componenten.  Stel dat de Nix store een GUI-component</span></div>
<div style="position:absolute;left:59.72px;top:237.22px" class="cls_007"><span class="cls_007">/nix/store/4kd0ma2pxf6w...-gtk+-2.8.6</span><span class="cls_004"> bevat (een GUI-bibliotheek). Als we vervolgens de</span></div>
<div style="position:absolute;left:59.72px;top:249.17px" class="cls_004"><span class="cls_004">tekenreeks</span><span class="cls_007"> 4kd0ma2pxf6w...</span><span class="cls_004"> tegenkomen in de inhoud van</span><span class="cls_007"> /nix/store/2zbay49r2ihr...-firefox-</span></div>
<div style="position:absolute;left:59.72px;top:261.13px" class="cls_007"><span class="cls_007">1.0.7</span><span class="cls_004">, kunnen we concluderen dat de Firefox-component een afhankelijkheid heeft op</span></div>
<div style="position:absolute;left:59.72px;top:273.08px" class="cls_007"><span class="cls_007">/nix/store/4kd0ma2pxf6w...-gtk+-2.8.6</span><span class="cls_004">.  De geldigheid van deze aanpak motiveer ik door</span></div>
<div style="position:absolute;left:59.72px;top:285.04px" class="cls_004"><span class="cls_004">middel van een analogie met technieken die worden gebruikt in de implementatie van pro-</span></div>
<div style="position:absolute;left:59.72px;top:296.99px" class="cls_004"><span class="cls_004">grammeertalen, in het bijzonder conservatieve garbage collection (hoofdstuk 3).</span></div>
<div style="position:absolute;left:69.68px;top:309.40px" class="cls_004"><span class="cls_004">De scanaanpak zorgt voor volledige kennis van de afhankelijkheden tussen componen-</span></div>
<div style="position:absolute;left:59.72px;top:321.35px" class="cls_004"><span class="cls_004">ten.  Deployment van een component verloopt correct indien we de afsluiting (closure)</span></div>
<div style="position:absolute;left:59.72px;top:333.31px" class="cls_004"><span class="cls_004">van de component onder de afhankelijkheidsrelatie kopiëren. Voorts kunnen componenten</span></div>
<div style="position:absolute;left:59.72px;top:345.26px" class="cls_004"><span class="cls_004">veilig verwijderd worden: een component mag alleen verwijderd worden indien er geen</span></div>
<div style="position:absolute;left:59.72px;top:357.22px" class="cls_004"><span class="cls_004">componenten in de store meer naar verwijzen. Het is zelfs mogelijk om ongebruikte com-</span></div>
<div style="position:absolute;left:59.72px;top:369.17px" class="cls_004"><span class="cls_004">ponenten volledig automatisch weg te laten gooien (garbage collection).</span></div>
<div style="position:absolute;left:59.72px;top:398.17px" class="cls_009"><span class="cls_009">Abstractie over hashes</span><span class="cls_004">   Uiteraard dienen gebruikers en ontwikkelaars niet geconfron-</span></div>
<div style="position:absolute;left:59.72px;top:410.12px" class="cls_004"><span class="cls_004">teerd te worden met bestandsnamen met eerdergenoemde hashes.  Dat is gelukkig ook</span></div>
<div style="position:absolute;left:59.72px;top:422.08px" class="cls_004"><span class="cls_004">niet het geval. Ze worden verborgen voor gebruikers door zogeheten user environments</span></div>
<div style="position:absolute;left:59.72px;top:434.03px" class="cls_004"><span class="cls_004">die een verzameling “geactiveerde” componenten beschikbaar maken voor de gebruiker.</span></div>
<div style="position:absolute;left:59.72px;top:445.99px" class="cls_004"><span class="cls_004">User environments zijn zelf ook (automatisch gegenereerde) componenten. Ze kunnen dus</span></div>
<div style="position:absolute;left:59.72px;top:457.94px" class="cls_004"><span class="cls_004">gebroederlijk naast elkaar bestaan. Dit stelt de gebruikers van een systeem in staat om ver-</span></div>
<div style="position:absolute;left:59.72px;top:469.90px" class="cls_004"><span class="cls_004">schillende user environments te gebruiken. Ook maakt het een rollback mogelijk waarbij</span></div>
<div style="position:absolute;left:59.72px;top:481.85px" class="cls_004"><span class="cls_004">installatie- of upgradeacties teruggedraaid worden.  Dit is een belangrijke eigenschap in</span></div>
<div style="position:absolute;left:59.72px;top:493.81px" class="cls_004"><span class="cls_004">bijvoorbeeld serveromgevingen.</span></div>
<div style="position:absolute;left:69.68px;top:506.21px" class="cls_004"><span class="cls_004">Evenmin hoeven ontwikkelaars rechtstreeks met hashes te werken. Nix componenten</span></div>
<div style="position:absolute;left:59.72px;top:518.17px" class="cls_004"><span class="cls_004">worden namelijk gebouwd uit Nix-expressies (hoofdstukken 2 en 4). Dit is een eenvoudige</span></div>
<div style="position:absolute;left:59.72px;top:530.12px" class="cls_004"><span class="cls_004">functionele taal die beschrijft hoe componenten gebouwd en samengesteld moeten worden.</span></div>
<div style="position:absolute;left:59.72px;top:542.08px" class="cls_004"><span class="cls_004">Uit deze beschrijvingen berekent Nix de paden waar de componenten opgeslagen worden.</span></div>
<div style="position:absolute;left:59.72px;top:571.07px" class="cls_009"><span class="cls_009">Transparant source/binary deploymentmodel</span><span class="cls_004">   Het uitrollen van Nix-expressies naar</span></div>
<div style="position:absolute;left:59.72px;top:583.02px" class="cls_004"><span class="cls_004">doelmachines levert een source-deploymentmodel op, omdat ze beschrijven hoe compo-</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">264</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:184920px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background273.jpg" width=481 height=680></div>
<div style="position:absolute;left:368.03px;top:17.14px" class="cls_004"><span class="cls_004">Samenvatting</span></div>
<div style="position:absolute;left:63.87px;top:45.04px" class="cls_004"><span class="cls_004">nenten uit broncode gebouwd kunnen worden.  Zo’n model—ook toegepast in deploy-</span></div>
<div style="position:absolute;left:63.87px;top:56.99px" class="cls_004"><span class="cls_004">mentsystemen zoals Gentoo Linux—is flexibel en prettig voor ontwikkelaars, maar ook</span></div>
<div style="position:absolute;left:63.87px;top:68.95px" class="cls_004"><span class="cls_004">erg resource-intensief: het kost dikwijls veel tijd en schijfruimte om een component uit</span></div>
<div style="position:absolute;left:63.87px;top:80.90px" class="cls_004"><span class="cls_004">broncode te bouwen. Daarentegen is een binair deploymentmodel, waarin componenten</span></div>
<div style="position:absolute;left:63.87px;top:92.86px" class="cls_004"><span class="cls_004">in binaire vorm worden gedistribueerd naar doelmachines, efficiënter maar ook minder</span></div>
<div style="position:absolute;left:63.87px;top:104.82px" class="cls_004"><span class="cls_004">flexibel.</span></div>
<div style="position:absolute;left:73.84px;top:117.11px" class="cls_004"><span class="cls_004">Nix combineert het beste van beide werelden door middel van een transparant sour-</span></div>
<div style="position:absolute;left:63.87px;top:129.07px" class="cls_004"><span class="cls_004">ce/binary deploymentmodel. Softwaredistributeurs of systeembeheerders bouwen een Nix-</span></div>
<div style="position:absolute;left:63.87px;top:141.02px" class="cls_004"><span class="cls_004">expressie en plaatsen de resulterende binaire componenten op een centrale server, ge-</span></div>
<div style="position:absolute;left:63.87px;top:152.98px" class="cls_004"><span class="cls_004">indexeerd onder hun hashes. Doelmachines kunnen vervolgens het bestaan van deze voor-</span></div>
<div style="position:absolute;left:63.87px;top:164.93px" class="cls_004"><span class="cls_004">gebouwde componenten registreren.  Deze registraties heten substituten.  De bouw van</span></div>
<div style="position:absolute;left:63.87px;top:176.89px" class="cls_004"><span class="cls_004">een Nix-expressie kan dan worden “kortgesloten” indien voor het te bouwen pad (zoals</span></div>
<div style="position:absolute;left:63.87px;top:188.84px" class="cls_007"><span class="cls_007">/nix/store/2zbay49r2ihr...-firefox-1.0.7</span><span class="cls_004">) een substituut bekend is die opgehaald en uitgepakt</span></div>
<div style="position:absolute;left:63.87px;top:200.80px" class="cls_004"><span class="cls_004">kan worden. Op die manier verandert source-deployment op een voor de gebruiker trans-</span></div>
<div style="position:absolute;left:63.87px;top:212.76px" class="cls_004"><span class="cls_004">parante wijze automatisch in binaire deployment.</span></div>
<div style="position:absolute;left:63.87px;top:241.17px" class="cls_009"><span class="cls_009">Extensioneel en intensioneel model</span><span class="cls_004">   Het proefschrift beschrijft twee subtiel verschil-</span></div>
<div style="position:absolute;left:63.87px;top:253.12px" class="cls_004"><span class="cls_004">lende modellen voor de implementatie van Nix.  Het oorspronkelijke en momenteel ge-</span></div>
<div style="position:absolute;left:63.87px;top:265.08px" class="cls_004"><span class="cls_004">bruikte model is het extensionele model (hoofdstuk 5), waarin store-paden vooraf worden</span></div>
<div style="position:absolute;left:63.87px;top:277.03px" class="cls_004"><span class="cls_004">berekend uit Nix-expressies. Dit is nodig omdat het pad van een component bekend moet</span></div>
<div style="position:absolute;left:63.87px;top:288.99px" class="cls_004"><span class="cls_004">zijn vóórdat de component gebouwd wordt. Het maakt het echter lastig om een Nix store te</span></div>
<div style="position:absolute;left:63.87px;top:300.94px" class="cls_004"><span class="cls_004">delen tussen meerdere, elkaar wellicht wederzijds niet vertrouwende gebruikers. Immers,</span></div>
<div style="position:absolute;left:63.87px;top:312.90px" class="cls_004"><span class="cls_004">een kwaadwillende gebruiker kan zomaar een onzinnig substituut registreren voor een pad</span></div>
<div style="position:absolute;left:63.87px;top:324.86px" class="cls_004"><span class="cls_004">dat daarna geïnstalleerd wordt door een andere gebruiker.</span></div>
<div style="position:absolute;left:73.84px;top:337.15px" class="cls_004"><span class="cls_004">Het intensionele model (hoofdstuk 6) heft deze beperking op door alle componenten</span></div>
<div style="position:absolute;left:63.87px;top:349.11px" class="cls_004"><span class="cls_004">op een inhoudsgeadresseerde wijze op te slaan. Hierbij wordt de naam van een compo-</span></div>
<div style="position:absolute;left:63.87px;top:361.06px" class="cls_004"><span class="cls_004">nent bepaald door de cryptografische hash over de inhoud van de component in plaats van</span></div>
<div style="position:absolute;left:63.87px;top:373.02px" class="cls_004"><span class="cls_004">over de Nix-expressie. Twee componenten kunnen dus alleen op dezelfde plaats in het be-</span></div>
<div style="position:absolute;left:63.87px;top:384.97px" class="cls_004"><span class="cls_004">standssysteem worden opgeslagen als ze inhoudelijk (intensioneel) gelijk zijn. Gebruikers</span></div>
<div style="position:absolute;left:63.87px;top:396.93px" class="cls_004"><span class="cls_004">kunnen hierdoor verschillende substituten registreren voor dezelfde Nix-expressie.  Het</span></div>
<div style="position:absolute;left:63.87px;top:408.88px" class="cls_004"><span class="cls_004">resultaat is een Nix store die op veilige wijze door gebruikers gedeeld kan worden.</span></div>
<div style="position:absolute;left:63.87px;top:438.49px" class="cls_008"><span class="cls_008">Toepassingen</span></div>
<div style="position:absolute;left:63.87px;top:458.62px" class="cls_004"><span class="cls_004">De voornaamste toepassing van Nix is deployment (hoofdstuk 7).  We hebben Nix ge-</span></div>
<div style="position:absolute;left:63.87px;top:470.58px" class="cls_004"><span class="cls_004">bruikt om meer dan 278 bestaande Unix-componenten uit te rollen. Deze pakketten zijn</span></div>
<div style="position:absolute;left:63.87px;top:482.53px" class="cls_004"><span class="cls_004">onderdeel van de Nix Packages collection (Nixpkgs, sectie 7.1). Nixpkgs dient zowel ter</span></div>
<div style="position:absolute;left:63.87px;top:494.49px" class="cls_004"><span class="cls_004">validatie van onze aanpak, als om gebruikers van Nix een bruikbare basis van pakketten</span></div>
<div style="position:absolute;left:63.87px;top:506.44px" class="cls_004"><span class="cls_004">aan te bieden waarop verder ontwikkeld kan worden.</span></div>
<div style="position:absolute;left:73.84px;top:518.74px" class="cls_004"><span class="cls_004">Nix is echter ook toepasbaar op een aantal aan deployment grenzende probleemgebie-</span></div>
<div style="position:absolute;left:63.87px;top:530.70px" class="cls_004"><span class="cls_004">den. Het streven is om zoveel mogelijk aspecten van het bouw- en deploymentproces onder</span></div>
<div style="position:absolute;left:63.87px;top:542.65px" class="cls_004"><span class="cls_004">één enkel formalisme te brengen, namelijk Nix-expressies.</span></div>
<div style="position:absolute;left:63.87px;top:571.07px" class="cls_009"><span class="cls_009">Continue integratie en releasemanagement (hoofdstuk 8)</span><span class="cls_004">   Het is een goede gewoonte</span></div>
<div style="position:absolute;left:63.87px;top:583.02px" class="cls_004"><span class="cls_004">om tijdens het ontwikkelen van grote softwaresystemen het samenvoegen van de verschil-</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">265</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:185610px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background274.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:45.04px" class="cls_004"><span class="cls_004">lende onderdelen niet te lang uit te stellen, daar dit kan leiden tot zogenaamde ‘Big Bang</span></div>
<div style="position:absolute;left:59.72px;top:56.99px" class="cls_004"><span class="cls_004">integratie” waar in een laat stadium geconstateerd wordt dat de onderdelen niet samen-</span></div>
<div style="position:absolute;left:59.72px;top:68.95px" class="cls_004"><span class="cls_004">werken.  Bij continue integratie worden componenten voortdurend gebouwd vanuit het</span></div>
<div style="position:absolute;left:59.72px;top:80.90px" class="cls_004"><span class="cls_004">versiebeheersysteem, dus iedere keer dat een ontwikkelaar een verandering toepast. Een</span></div>
<div style="position:absolute;left:59.72px;top:92.86px" class="cls_004"><span class="cls_004">build farm kan deze praktijk ondersteunen. Dit is een verzameling machines die de softwa-</span></div>
<div style="position:absolute;left:59.72px;top:104.82px" class="cls_004"><span class="cls_004">re bouwt, typisch onder verschillende besturingssystemen en architecturen. Een build farm</span></div>
<div style="position:absolute;left:59.72px;top:116.77px" class="cls_004"><span class="cls_004">is niet alleen nuttig om software te testen, maar kan ook meteen releases van de software</span></div>
<div style="position:absolute;left:59.72px;top:128.73px" class="cls_004"><span class="cls_004">maken—kant en klare pakketten die door gebruikers geïnstalleerd kunnen worden.</span></div>
<div style="position:absolute;left:69.68px;top:140.68px" class="cls_004"><span class="cls_004">Het beheer van zo’n build farm is vaak nogal tijdrovend, omdat elke gewenste verande-</span></div>
<div style="position:absolute;left:59.72px;top:152.64px" class="cls_004"><span class="cls_004">ring in de softwareomgeving (zoals een nieuwe versie van een compiler) op elke machine</span></div>
<div style="position:absolute;left:59.72px;top:164.59px" class="cls_004"><span class="cls_004">doorgevoerd moet worden.  Dit kan echter geautomatiseerd worden met Nix, omdat het</span></div>
<div style="position:absolute;left:59.72px;top:176.55px" class="cls_004"><span class="cls_004">op een transparante wijze Nix-expressies voor meerdere platformtypes kan bouwen. Nix</span></div>
<div style="position:absolute;left:59.72px;top:188.50px" class="cls_004"><span class="cls_004">voorkomt ook dat componenten die niet gewijzigd zijn steeds opnieuw gebouwd worden.</span></div>
<div style="position:absolute;left:59.72px;top:200.46px" class="cls_004"><span class="cls_004">Tenslotte kunnen de in een op Nix gebaseerde build farm geproduceerde releases op be-</span></div>
<div style="position:absolute;left:59.72px;top:212.41px" class="cls_004"><span class="cls_004">trouwbare wijze via Nix uitgerold worden.</span></div>
<div style="position:absolute;left:59.72px;top:238.94px" class="cls_009"><span class="cls_009">Service deployment (hoofdstuk 9)</span><span class="cls_004">   Het uitrollen van draaiende netwerkdiensten (servi-</span></div>
<div style="position:absolute;left:59.72px;top:250.89px" class="cls_004"><span class="cls_004">ces) zoals webservers is een erg tijdrovend en meestal slecht beheerd proces. Veel acties—</span></div>
<div style="position:absolute;left:59.72px;top:262.85px" class="cls_004"><span class="cls_004">het installeren van software, aanpassen van configuratiebestanden, enz.—worden met de</span></div>
<div style="position:absolute;left:59.72px;top:274.80px" class="cls_004"><span class="cls_004">hand uitgevoerd en zijn daardoor niet automatisch reproduceerbaar. Hierdoor is het lastig</span></div>
<div style="position:absolute;left:59.72px;top:286.76px" class="cls_004"><span class="cls_004">om meerdere versies van een dienst (bijvoorbeeld test- en productieversies) naast elkaar te</span></div>
<div style="position:absolute;left:59.72px;top:298.71px" class="cls_004"><span class="cls_004">draaien, of om een rollback uit te voeren naar een eerdere toestand.</span></div>
<div style="position:absolute;left:69.68px;top:310.67px" class="cls_004"><span class="cls_004">We kunnen dit probleem met Nix voor een groot gedeelte aanpakken door de relatief</span></div>
<div style="position:absolute;left:59.72px;top:322.62px" class="cls_004"><span class="cls_004">statische delen van een dienst (nl. de software en de configuratiebestanden) als een Nix-</span></div>
<div style="position:absolute;left:59.72px;top:334.58px" class="cls_004"><span class="cls_004">component te behandelen. Dit wil zeggen dat ze vanuit een Nix-expressie gebouwd worden</span></div>
<div style="position:absolute;left:59.72px;top:346.53px" class="cls_004"><span class="cls_004">en in de Nix store terecht komen.  Alle voordelen van Nix voor deployment—zoals het</span></div>
<div style="position:absolute;left:59.72px;top:358.49px" class="cls_004"><span class="cls_004">gebruik van meerdere versies naast elkaar, reproduceerbaarheid, rollbacks, enz.—zijn op</span></div>
<div style="position:absolute;left:59.72px;top:370.44px" class="cls_004"><span class="cls_004">die manier onmiddelijk van toepassing op de uitrol van diensten. De dynamische toestand</span></div>
<div style="position:absolute;left:59.72px;top:382.40px" class="cls_004"><span class="cls_004">van een dienst (zoals databases) is echter niet onder Nix-beheer.</span></div>
<div style="position:absolute;left:59.72px;top:408.92px" class="cls_009"><span class="cls_009">Build management (hoofdstuk 10)</span><span class="cls_004">   Het bouwen van software is een klassiek probleem</span></div>
<div style="position:absolute;left:59.72px;top:420.88px" class="cls_004"><span class="cls_004">dat typisch door tools zoals Make (1979) wordt opgelost. Zulke bouwtools hebben ech-</span></div>
<div style="position:absolute;left:59.72px;top:432.84px" class="cls_004"><span class="cls_004">ter allerlei beperkingen die veel lijken op die van deploymentsystemen: ze kunnen niet</span></div>
<div style="position:absolute;left:59.72px;top:444.79px" class="cls_004"><span class="cls_004">garanderen dat afhankelijkheidsspecificaties volledig zijn, ze hebben slechte ondersteu-</span></div>
<div style="position:absolute;left:59.72px;top:456.75px" class="cls_004"><span class="cls_004">ning voor meerdere varianten van bouwacties, enz. Dit is niet verrassend, omdat bouwen</span></div>
<div style="position:absolute;left:59.72px;top:468.70px" class="cls_004"><span class="cls_004">en deployment goeddeels hetzelfde probleem zijn, met dien verstande dat bouwtools ty-</span></div>
<div style="position:absolute;left:59.72px;top:480.66px" class="cls_004"><span class="cls_004">pisch betrekking hebben op “kleine” componenten (zoals individuele broncodebestanden),</span></div>
<div style="position:absolute;left:59.72px;top:492.61px" class="cls_004"><span class="cls_004">terwijl deploymentsystemen te maken hebben met “grote” componenten (zoals complete</span></div>
<div style="position:absolute;left:59.72px;top:504.57px" class="cls_004"><span class="cls_004">programma’s).  Het is dus vrij eenvoudig om Nix te gebruiken als een Make-vervanger,</span></div>
<div style="position:absolute;left:59.72px;top:516.52px" class="cls_004"><span class="cls_004">simpelweg door Nix-expressies te schrijven die voornoemde “kleine” componenten bou-</span></div>
<div style="position:absolute;left:59.72px;top:528.48px" class="cls_004"><span class="cls_004">wen.</span></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">266</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:186300px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background275.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:88.81px" class="cls_006"><span class="cls_006">Curriculum Vitae</span></div>
<div style="position:absolute;left:63.87px;top:130.02px" class="cls_004"><span class="cls_004">Eelco Dolstra</span></div>
<div style="position:absolute;left:63.87px;top:156.15px" class="cls_004"><span class="cls_004">18 augustus 1978</span></div>
<div style="position:absolute;left:63.87px;top:168.10px" class="cls_004"><span class="cls_004">Geboren te Wageningen</span></div>
<div style="position:absolute;left:63.87px;top:188.56px" class="cls_004"><span class="cls_004">1990-1996</span></div>
<div style="position:absolute;left:63.87px;top:200.52px" class="cls_004"><span class="cls_004">Voorbereidend Wetenschappelijk Onderwijs aan de Christelijke Scholengemeenschap “Het</span></div>
<div style="position:absolute;left:63.87px;top:212.47px" class="cls_004"><span class="cls_004">Streek” te Ede</span></div>
<div style="position:absolute;left:63.87px;top:224.43px" class="cls_004"><span class="cls_004">Diploma (gymnasium) behaald op 12 juni 1996</span></div>
<div style="position:absolute;left:63.87px;top:244.89px" class="cls_004"><span class="cls_004">1996-2001</span></div>
<div style="position:absolute;left:63.87px;top:256.84px" class="cls_004"><span class="cls_004">Studie Informatica aan de Universiteit Utrecht</span></div>
<div style="position:absolute;left:63.87px;top:268.80px" class="cls_004"><span class="cls_004">Propedeutisch diploma behaald op 27 augustus 1997 (cum laude)</span></div>
<div style="position:absolute;left:63.87px;top:280.75px" class="cls_004"><span class="cls_004">Doctoraal diploma behaald op 10 augustus 2001 (cum laude)</span></div>
<div style="position:absolute;left:63.87px;top:301.21px" class="cls_004"><span class="cls_004">2001-2005</span></div>
<div style="position:absolute;left:63.87px;top:313.17px" class="cls_004"><span class="cls_004">Assistent in Opleiding, Department of Information and Computing Sciences, Universiteit</span></div>
<div style="position:absolute;left:63.87px;top:325.12px" class="cls_004"><span class="cls_004">Utrecht</span></div>
<div style="position:absolute;left:407.23px;top:624.87px" class="cls_004"><span class="cls_004">267</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:186990px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background276.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:624.87px" class="cls_004"><span class="cls_004">268</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:187680px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background277.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:44.24px" class="cls_008"><span class="cls_008">Titles in the IPA Dissertation Series</span></div>
<div style="position:absolute;left:63.87px;top:68.45px" class="cls_014"><span class="cls_014">J.O. Blanco.  The State Operator in Process Alge-</span></div>
<div style="position:absolute;left:250.99px;top:68.45px" class="cls_014"><span class="cls_014">W.T.M. Kars. Process-algebraic Transformations in</span></div>
<div style="position:absolute;left:63.87px;top:77.92px" class="cls_014"><span class="cls_014">bra. Faculty of Mathematics and Computing Science,</span></div>
<div style="position:absolute;left:250.99px;top:77.92px" class="cls_014"><span class="cls_014">Context. Faculty of Computer Science, UT. 1997-02</span></div>
<div style="position:absolute;left:63.87px;top:87.38px" class="cls_014"><span class="cls_014">TUE. 1996-01</span></div>
<div style="position:absolute;left:250.99px;top:93.42px" class="cls_014"><span class="cls_014">P.F. Hoogendijk.  A Generic Theory of Data Types.</span></div>
<div style="position:absolute;left:63.87px;top:103.32px" class="cls_014"><span class="cls_014">A.M. Geerling.  Transformational Development of</span></div>
<div style="position:absolute;left:250.99px;top:102.89px" class="cls_014"><span class="cls_014">Faculty  of  Mathematics  and  Computing  Science,</span></div>
<div style="position:absolute;left:63.87px;top:112.79px" class="cls_014"><span class="cls_014">Data-Parallel Algorithms.  Faculty of Mathematics</span></div>
<div style="position:absolute;left:250.99px;top:112.35px" class="cls_014"><span class="cls_014">TUE. 1997-03</span></div>
<div style="position:absolute;left:63.87px;top:122.25px" class="cls_014"><span class="cls_014">and Computer Science, KUN. 1996-02</span></div>
<div style="position:absolute;left:250.99px;top:127.86px" class="cls_014"><span class="cls_014">T.D.L. Laan. The Evolution of Type Theory in Logic</span></div>
<div style="position:absolute;left:63.87px;top:138.19px" class="cls_014"><span class="cls_014">P.M.  Achten.   Interactive  Functional  Programs:</span></div>
<div style="position:absolute;left:250.99px;top:137.33px" class="cls_014"><span class="cls_014">and Mathematics. Faculty of Mathematics and Com-</span></div>
<div style="position:absolute;left:63.87px;top:147.65px" class="cls_014"><span class="cls_014">Models, Methods, and Implementation.  Faculty of</span></div>
<div style="position:absolute;left:250.99px;top:146.79px" class="cls_014"><span class="cls_014">puting Science, TUE. 1997-04</span></div>
<div style="position:absolute;left:63.87px;top:157.12px" class="cls_014"><span class="cls_014">Mathematics and Computer Science, KUN. 1996-03</span></div>
<div style="position:absolute;left:250.99px;top:162.30px" class="cls_014"><span class="cls_014">C.J. Bloo.  Preservation of Termination for Explicit</span></div>
<div style="position:absolute;left:63.87px;top:173.06px" class="cls_014"><span class="cls_014">M.G.A. Verhoeven. Parallel Local Search. Faculty</span></div>
<div style="position:absolute;left:250.99px;top:171.76px" class="cls_014"><span class="cls_014">Substitution. Faculty of Mathematics and Computing</span></div>
<div style="position:absolute;left:63.87px;top:182.52px" class="cls_014"><span class="cls_014">of Mathematics and Computing Science, TUE. 1996-</span></div>
<div style="position:absolute;left:250.99px;top:181.23px" class="cls_014"><span class="cls_014">Science, TUE. 1997-05</span></div>
<div style="position:absolute;left:63.87px;top:191.99px" class="cls_014"><span class="cls_014">04</span></div>
<div style="position:absolute;left:250.99px;top:196.74px" class="cls_014"><span class="cls_014">J.J. Vereijken. Discrete-Time Process Algebra. Fac-</span></div>
<div style="position:absolute;left:63.87px;top:207.93px" class="cls_014"><span class="cls_014">M.H.G.K. Kesseler.  The Implementation of Func-</span></div>
<div style="position:absolute;left:250.99px;top:206.20px" class="cls_014"><span class="cls_014">ulty of Mathematics and Computing Science, TUE.</span></div>
<div style="position:absolute;left:63.87px;top:217.39px" class="cls_014"><span class="cls_014">tional Languages on Parallel Machines with Distrib.</span></div>
<div style="position:absolute;left:250.99px;top:215.67px" class="cls_014"><span class="cls_014">1997-06</span></div>
<div style="position:absolute;left:63.87px;top:226.86px" class="cls_014"><span class="cls_014">Memory. Faculty of Mathematics and Computer Sci-</span></div>
<div style="position:absolute;left:250.99px;top:231.17px" class="cls_014"><span class="cls_014">F.A.M. van den Beuken. A Functional Approach to</span></div>
<div style="position:absolute;left:63.87px;top:236.32px" class="cls_014"><span class="cls_014">ence, KUN. 1996-05</span></div>
<div style="position:absolute;left:250.99px;top:240.64px" class="cls_014"><span class="cls_014">Syntax and Typing. Faculty of Mathematics and Infor-</span></div>
<div style="position:absolute;left:63.87px;top:252.26px" class="cls_014"><span class="cls_014">D. Alstein.  Distributed Algorithms for Hard Real-</span></div>
<div style="position:absolute;left:250.99px;top:250.10px" class="cls_014"><span class="cls_014">matics, KUN. 1997-07</span></div>
<div style="position:absolute;left:63.87px;top:261.73px" class="cls_014"><span class="cls_014">Time Systems. Faculty of Mathematics and Comput-</span></div>
<div style="position:absolute;left:250.99px;top:265.61px" class="cls_014"><span class="cls_014">A.W. Heerink. Ins and Outs in Refusal Testing. Fac-</span></div>
<div style="position:absolute;left:63.87px;top:271.19px" class="cls_014"><span class="cls_014">ing Science, TUE. 1996-06</span></div>
<div style="position:absolute;left:250.99px;top:275.08px" class="cls_014"><span class="cls_014">ulty of Computer Science, UT. 1998-01</span></div>
<div style="position:absolute;left:63.87px;top:287.13px" class="cls_014"><span class="cls_014">J.H. Hoepman.  Communication, Synchronization,</span></div>
<div style="position:absolute;left:250.99px;top:290.59px" class="cls_014"><span class="cls_014">G. Naumoski and W. Alberts. A Discrete-Event Sim-</span></div>
<div style="position:absolute;left:63.87px;top:296.60px" class="cls_014"><span class="cls_014">and Fault-Tolerance.  Faculty of Mathematics and</span></div>
<div style="position:absolute;left:250.99px;top:300.05px" class="cls_014"><span class="cls_014">ulator for Systems Engineering. Faculty of Mechani-</span></div>
<div style="position:absolute;left:63.87px;top:306.06px" class="cls_014"><span class="cls_014">Computer Science, UvA. 1996-07</span></div>
<div style="position:absolute;left:250.99px;top:309.51px" class="cls_014"><span class="cls_014">cal Engineering, TUE. 1998-02</span></div>
<div style="position:absolute;left:63.87px;top:322.00px" class="cls_014"><span class="cls_014">H. Doornbos.  Reductivity Arguments and Program</span></div>
<div style="position:absolute;left:250.99px;top:325.02px" class="cls_014"><span class="cls_014">J. Verriet. Scheduling with Communication for Mul-</span></div>
<div style="position:absolute;left:63.87px;top:331.47px" class="cls_014"><span class="cls_014">Construction.  Faculty of Mathematics and Comput-</span></div>
<div style="position:absolute;left:250.99px;top:334.49px" class="cls_014"><span class="cls_014">tiprocessor Computation. Faculty of Mathematics and</span></div>
<div style="position:absolute;left:63.87px;top:340.93px" class="cls_014"><span class="cls_014">ing Science, TUE. 1996-08</span></div>
<div style="position:absolute;left:250.99px;top:343.95px" class="cls_014"><span class="cls_014">Computer Science, UU. 1998-03</span></div>
<div style="position:absolute;left:63.87px;top:356.87px" class="cls_014"><span class="cls_014">D. Turi.  Functorial Operational Semantics and its</span></div>
<div style="position:absolute;left:250.99px;top:359.46px" class="cls_014"><span class="cls_014">J.S.H. van Gageldonk. An Asynchronous Low-Power</span></div>
<div style="position:absolute;left:63.87px;top:366.33px" class="cls_014"><span class="cls_014">Denotational Dual. Faculty of Mathematics and Com-</span></div>
<div style="position:absolute;left:250.99px;top:368.92px" class="cls_014"><span class="cls_014">80C51 Microcontroller. Faculty of Mathematics and</span></div>
<div style="position:absolute;left:63.87px;top:375.80px" class="cls_014"><span class="cls_014">puter Science, VUA. 1996-09</span></div>
<div style="position:absolute;left:250.99px;top:378.39px" class="cls_014"><span class="cls_014">Computing Science, TUE. 1998-04</span></div>
<div style="position:absolute;left:63.87px;top:391.74px" class="cls_014"><span class="cls_014">A.M.G. Peeters.  Single-Rail Handshake Circuits.</span></div>
<div style="position:absolute;left:250.99px;top:393.90px" class="cls_014"><span class="cls_014">A.A. Basten. In Terms of Nets: System Design with</span></div>
<div style="position:absolute;left:63.87px;top:401.20px" class="cls_014"><span class="cls_014">Faculty  of  Mathematics  and  Computing  Science,</span></div>
<div style="position:absolute;left:250.99px;top:403.36px" class="cls_014"><span class="cls_014">Petri Nets and Process Algebra. Faculty of Mathemat-</span></div>
<div style="position:absolute;left:63.87px;top:410.67px" class="cls_014"><span class="cls_014">TUE. 1996-10</span></div>
<div style="position:absolute;left:250.99px;top:412.83px" class="cls_014"><span class="cls_014">ics and Computing Science, TUE. 1998-05</span></div>
<div style="position:absolute;left:63.87px;top:426.61px" class="cls_014"><span class="cls_014">N.W.A. Arends. A Systems Engineering Specification</span></div>
<div style="position:absolute;left:250.99px;top:428.34px" class="cls_014"><span class="cls_014">E. Voermans.  Inductive Datatypes with Laws and</span></div>
<div style="position:absolute;left:63.87px;top:436.07px" class="cls_014"><span class="cls_014">Formalism. Faculty of Mechanical Engineering, TUE.</span></div>
<div style="position:absolute;left:250.99px;top:437.80px" class="cls_014"><span class="cls_014">Subtyping — A Relational Model.  Faculty of Math-</span></div>
<div style="position:absolute;left:63.87px;top:445.54px" class="cls_014"><span class="cls_014">1996-11</span></div>
<div style="position:absolute;left:250.99px;top:447.26px" class="cls_014"><span class="cls_014">ematics and Computing Science, TUE. 1999-01</span></div>
<div style="position:absolute;left:63.87px;top:461.48px" class="cls_014"><span class="cls_014">P. Severi de Santiago. Normalisation in Lambda Cal-</span></div>
<div style="position:absolute;left:250.99px;top:462.77px" class="cls_014"><span class="cls_014">H. ter Doest.   Towards Probabilistic Unification-</span></div>
<div style="position:absolute;left:63.87px;top:470.94px" class="cls_014"><span class="cls_014">culus and its Relation to Type Inference.  Faculty of</span></div>
<div style="position:absolute;left:250.99px;top:472.24px" class="cls_014"><span class="cls_014">based Parsing.  Faculty of Computer Science, UT.</span></div>
<div style="position:absolute;left:63.87px;top:480.41px" class="cls_014"><span class="cls_014">Mathematics and Computing Science, TUE. 1996-12</span></div>
<div style="position:absolute;left:250.99px;top:481.70px" class="cls_014"><span class="cls_014">1999-02</span></div>
<div style="position:absolute;left:63.87px;top:496.35px" class="cls_014"><span class="cls_014">D.R. Dams. Abstract Interpretation and Partition Re-</span></div>
<div style="position:absolute;left:250.99px;top:497.21px" class="cls_014"><span class="cls_014">J.P.L. Segers. Algorithms for the Simulation of Sur-</span></div>
<div style="position:absolute;left:63.87px;top:505.81px" class="cls_014"><span class="cls_014">finement for Model Checking. Faculty of Mathematics</span></div>
<div style="position:absolute;left:250.99px;top:506.67px" class="cls_014"><span class="cls_014">face Processes. Faculty of Mathematics and Comput-</span></div>
<div style="position:absolute;left:63.87px;top:515.28px" class="cls_014"><span class="cls_014">and Computing Science, TUE. 1996-13</span></div>
<div style="position:absolute;left:250.99px;top:516.14px" class="cls_014"><span class="cls_014">ing Science, TUE. 1999-03</span></div>
<div style="position:absolute;left:63.87px;top:531.22px" class="cls_014"><span class="cls_014">M.M. Bonsangue.  Topological Dualities in Seman-</span></div>
<div style="position:absolute;left:250.99px;top:531.65px" class="cls_014"><span class="cls_014">C.H.M. van Kemenade.  Recombinative Evolution-</span></div>
<div style="position:absolute;left:63.87px;top:540.68px" class="cls_014"><span class="cls_014">tics. Faculty of Mathematics and Computer Science,</span></div>
<div style="position:absolute;left:250.99px;top:541.11px" class="cls_014"><span class="cls_014">ary Search. Faculty of Mathematics and Natural Sci-</span></div>
<div style="position:absolute;left:63.87px;top:550.15px" class="cls_014"><span class="cls_014">VUA. 1996-14</span></div>
<div style="position:absolute;left:250.99px;top:550.58px" class="cls_014"><span class="cls_014">ences, UL. 1999-04</span></div>
<div style="position:absolute;left:63.87px;top:566.09px" class="cls_014"><span class="cls_014">B.L.E. de Fluiter.  Algorithms for Graphs of Small</span></div>
<div style="position:absolute;left:250.99px;top:566.09px" class="cls_014"><span class="cls_014">E.I. Barakova. Learning Reliability: a Study on In-</span></div>
<div style="position:absolute;left:63.87px;top:575.55px" class="cls_014"><span class="cls_014">Treewidth.  Faculty of Mathematics and Computer</span></div>
<div style="position:absolute;left:250.99px;top:575.55px" class="cls_014"><span class="cls_014">decisiveness in Sample Selection. Faculty of Mathe-</span></div>
<div style="position:absolute;left:63.87px;top:585.01px" class="cls_014"><span class="cls_014">Science, UU. 1997-01</span></div>
<div style="position:absolute;left:250.99px;top:585.01px" class="cls_014"><span class="cls_014">matics and Natural Sciences, RUG. 1999-05</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:188370px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background278.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:47.03px" class="cls_014"><span class="cls_014">M.P. Bodlaender.  Scheduler Optimization in Real-</span></div>
<div style="position:absolute;left:246.84px;top:47.03px" class="cls_014"><span class="cls_014">M. Franssen. Cocktail: A Tool for Deriving Correct</span></div>
<div style="position:absolute;left:59.72px;top:56.50px" class="cls_014"><span class="cls_014">Time Distributed Databases. Faculty of Mathematics</span></div>
<div style="position:absolute;left:246.84px;top:56.50px" class="cls_014"><span class="cls_014">Programs.  Faculty of Mathematics and Computing</span></div>
<div style="position:absolute;left:59.72px;top:65.96px" class="cls_014"><span class="cls_014">and Computing Science, TUE. 1999-06</span></div>
<div style="position:absolute;left:246.84px;top:65.96px" class="cls_014"><span class="cls_014">Science, TUE. 2000-07</span></div>
<div style="position:absolute;left:59.72px;top:81.64px" class="cls_014"><span class="cls_014">M.A. Reniers. Message Sequence Chart: Syntax and</span></div>
<div style="position:absolute;left:246.84px;top:80.37px" class="cls_014"><span class="cls_014">P.A. Olivier.  A Framework for Debugging Hetero-</span></div>
<div style="position:absolute;left:59.72px;top:91.10px" class="cls_014"><span class="cls_014">Semantics.  Faculty of Mathematics and Computing</span></div>
<div style="position:absolute;left:246.84px;top:89.84px" class="cls_014"><span class="cls_014">geneous Applications.  Faculty of Natural Sciences,</span></div>
<div style="position:absolute;left:59.72px;top:100.56px" class="cls_014"><span class="cls_014">Science, TUE. 1999-07</span></div>
<div style="position:absolute;left:246.84px;top:99.30px" class="cls_014"><span class="cls_014">Mathematics and Computer Science, UvA. 2000-08</span></div>
<div style="position:absolute;left:246.84px;top:113.72px" class="cls_014"><span class="cls_014">E. Saaman. Another Formal Specification Language.</span></div>
<div style="position:absolute;left:59.72px;top:116.24px" class="cls_014"><span class="cls_014">J.P. Warners.  Nonlinear approaches to satisfiabil-</span></div>
<div style="position:absolute;left:59.72px;top:125.70px" class="cls_014"><span class="cls_014">ity problems. Faculty of Mathematics and Computing</span></div>
<div style="position:absolute;left:246.84px;top:123.18px" class="cls_014"><span class="cls_014">Faculty of Mathematics and Natural Sciences, RUG.</span></div>
<div style="position:absolute;left:246.84px;top:132.64px" class="cls_014"><span class="cls_014">2000-10</span></div>
<div style="position:absolute;left:59.72px;top:135.17px" class="cls_014"><span class="cls_014">Science, TUE. 1999-08</span></div>
<div style="position:absolute;left:246.84px;top:147.06px" class="cls_014"><span class="cls_014">M. Jelasity. The Shape of Evolutionary Search Dis-</span></div>
<div style="position:absolute;left:59.72px;top:150.84px" class="cls_014"><span class="cls_014">J.M.T. Romijn. Analysing Industrial Protocols with</span></div>
<div style="position:absolute;left:246.84px;top:156.52px" class="cls_014"><span class="cls_014">covering and Representing Search Space Structure.</span></div>
<div style="position:absolute;left:59.72px;top:160.31px" class="cls_014"><span class="cls_014">Formal Methods. Faculty of Computer Science, UT.</span></div>
<div style="position:absolute;left:246.84px;top:165.99px" class="cls_014"><span class="cls_014">Faculty of Mathematics and Natural Sciences, UL.</span></div>
<div style="position:absolute;left:59.72px;top:169.77px" class="cls_014"><span class="cls_014">1999-09</span></div>
<div style="position:absolute;left:246.84px;top:175.45px" class="cls_014"><span class="cls_014">2001-01</span></div>
<div style="position:absolute;left:59.72px;top:185.45px" class="cls_014"><span class="cls_014">P.R. D’Argenio.  Algebras and Automata for Timed</span></div>
<div style="position:absolute;left:246.84px;top:189.86px" class="cls_014"><span class="cls_014">R. Ahn. Agents, Objects and Events a computational</span></div>
<div style="position:absolute;left:59.72px;top:194.91px" class="cls_014"><span class="cls_014">and Stochastic Systems. Faculty of Computer Science,</span></div>
<div style="position:absolute;left:246.84px;top:199.33px" class="cls_014"><span class="cls_014">approach to knowledge, observation and communica-</span></div>
<div style="position:absolute;left:59.72px;top:204.38px" class="cls_014"><span class="cls_014">UT. 1999-10</span></div>
<div style="position:absolute;left:246.84px;top:208.79px" class="cls_014"><span class="cls_014">tion. Faculty of Mathematics and Computing Science,</span></div>
<div style="position:absolute;left:59.72px;top:220.05px" class="cls_014"><span class="cls_014">G. Fábián.  A Language and Simulator for Hybrid</span></div>
<div style="position:absolute;left:246.84px;top:218.26px" class="cls_014"><span class="cls_014">TU/e. 2001-02</span></div>
<div style="position:absolute;left:59.72px;top:229.51px" class="cls_014"><span class="cls_014">Systems.  Faculty of Mechanical Engineering, TUE.</span></div>
<div style="position:absolute;left:246.84px;top:232.67px" class="cls_014"><span class="cls_014">M. Huisman.  Reasoning about Java programs in</span></div>
<div style="position:absolute;left:59.72px;top:238.98px" class="cls_014"><span class="cls_014">1999-11</span></div>
<div style="position:absolute;left:246.84px;top:242.13px" class="cls_014"><span class="cls_014">higher order logic using PVS and Isabelle.  Faculty</span></div>
<div style="position:absolute;left:246.84px;top:251.60px" class="cls_014"><span class="cls_014">of Science, KUN. 2001-03</span></div>
<div style="position:absolute;left:59.72px;top:254.65px" class="cls_014"><span class="cls_014">J.  Zwanenburg.   Object-Oriented  Concepts  and</span></div>
<div style="position:absolute;left:59.72px;top:264.12px" class="cls_014"><span class="cls_014">Proof Rules. Faculty of Mathematics and Computing</span></div>
<div style="position:absolute;left:246.84px;top:266.01px" class="cls_014"><span class="cls_014">I.M.M.J.  Reymen.   Improving  Design  Processes</span></div>
<div style="position:absolute;left:59.72px;top:273.58px" class="cls_014"><span class="cls_014">Science, TUE. 1999-12</span></div>
<div style="position:absolute;left:246.84px;top:275.48px" class="cls_014"><span class="cls_014">through Structured Reflection. Faculty of Mathemat-</span></div>
<div style="position:absolute;left:246.84px;top:284.94px" class="cls_014"><span class="cls_014">ics and Computing Science, TU/e. 2001-04</span></div>
<div style="position:absolute;left:59.72px;top:289.26px" class="cls_014"><span class="cls_014">R.S. Venema.  Aspects of an Integrated Neural Pre-</span></div>
<div style="position:absolute;left:59.72px;top:298.72px" class="cls_014"><span class="cls_014">diction System.  Faculty of Mathematics and Natural</span></div>
<div style="position:absolute;left:246.84px;top:299.35px" class="cls_014"><span class="cls_014">S.C.C. Blom. Term Graph Rewriting: syntax and se-</span></div>
<div style="position:absolute;left:59.72px;top:308.19px" class="cls_014"><span class="cls_014">Sciences, RUG. 1999-13</span></div>
<div style="position:absolute;left:246.84px;top:308.82px" class="cls_014"><span class="cls_014">mantics. Faculty of Sciences, Division of Mathemat-</span></div>
<div style="position:absolute;left:246.84px;top:318.28px" class="cls_014"><span class="cls_014">ics and Computer Science, VUA. 2001-05</span></div>
<div style="position:absolute;left:59.72px;top:323.86px" class="cls_014"><span class="cls_014">J. Saraiva.  A Purely Functional Implementation of</span></div>
<div style="position:absolute;left:59.72px;top:333.33px" class="cls_014"><span class="cls_014">Attribute Grammars.  Faculty of Mathematics and</span></div>
<div style="position:absolute;left:246.84px;top:332.69px" class="cls_014"><span class="cls_014">R. van Liere.  Studies in Interactive Visualization.</span></div>
<div style="position:absolute;left:59.72px;top:342.79px" class="cls_014"><span class="cls_014">Computer Science, UU. 1999-14</span></div>
<div style="position:absolute;left:246.84px;top:342.16px" class="cls_014"><span class="cls_014">Faculty of Natural Sciences, Mathematics and Com-</span></div>
<div style="position:absolute;left:246.84px;top:351.62px" class="cls_014"><span class="cls_014">puter Science, UvA. 2001-06</span></div>
<div style="position:absolute;left:59.72px;top:358.46px" class="cls_014"><span class="cls_014">R. Schiefer. Viper, A Visualisation Tool for Parallel</span></div>
<div style="position:absolute;left:59.72px;top:367.93px" class="cls_014"><span class="cls_014">Program Construction.  Faculty of Mathematics and</span></div>
<div style="position:absolute;left:246.84px;top:366.04px" class="cls_014"><span class="cls_014">A.G. Engels. Languages for Analysis and Testing of</span></div>
<div style="position:absolute;left:59.72px;top:377.39px" class="cls_014"><span class="cls_014">Computing Science, TUE. 1999-15</span></div>
<div style="position:absolute;left:246.84px;top:375.50px" class="cls_014"><span class="cls_014">Event Sequences. Faculty of Mathematics and Com-</span></div>
<div style="position:absolute;left:246.84px;top:384.96px" class="cls_014"><span class="cls_014">puting Science, TU/e. 2001-07</span></div>
<div style="position:absolute;left:59.72px;top:393.07px" class="cls_014"><span class="cls_014">K.M.M. de Leeuw. Cryptology and Statecraft in the</span></div>
<div style="position:absolute;left:246.84px;top:399.38px" class="cls_014"><span class="cls_014">J. Hage.  Structural Aspects of Switching Classes.</span></div>
<div style="position:absolute;left:59.72px;top:402.53px" class="cls_014"><span class="cls_014">Dutch Republic.  Faculty of Mathematics and Com-</span></div>
<div style="position:absolute;left:246.84px;top:408.84px" class="cls_014"><span class="cls_014">Faculty of Mathematics and Natural Sciences, UL.</span></div>
<div style="position:absolute;left:59.72px;top:412.00px" class="cls_014"><span class="cls_014">puter Science, UvA. 2000-01</span></div>
<div style="position:absolute;left:246.84px;top:418.31px" class="cls_014"><span class="cls_014">2001-08</span></div>
<div style="position:absolute;left:59.72px;top:427.67px" class="cls_014"><span class="cls_014">T.E.J. Vos. UNITY in Diversity. A stratified approach</span></div>
<div style="position:absolute;left:246.84px;top:432.72px" class="cls_014"><span class="cls_014">M.H. Lamers. Neural Networks for Analysis of Data</span></div>
<div style="position:absolute;left:59.72px;top:437.14px" class="cls_014"><span class="cls_014">to the verification of distributed algorithms.  Faculty</span></div>
<div style="position:absolute;left:246.84px;top:442.18px" class="cls_014"><span class="cls_014">in Environmental Epidemiology:  A Case-study into</span></div>
<div style="position:absolute;left:59.72px;top:446.60px" class="cls_014"><span class="cls_014">of Mathematics and Computer Science, UU. 2000-02</span></div>
<div style="position:absolute;left:246.84px;top:451.65px" class="cls_014"><span class="cls_014">Acute Effects of Air Pollution Episodes.  Faculty of</span></div>
<div style="position:absolute;left:59.72px;top:462.27px" class="cls_014"><span class="cls_014">W. Mallon.  Theories and Tools for the Design of</span></div>
<div style="position:absolute;left:246.84px;top:461.11px" class="cls_014"><span class="cls_014">Mathematics and Natural Sciences, UL. 2001-09</span></div>
<div style="position:absolute;left:59.72px;top:471.74px" class="cls_014"><span class="cls_014">Delay-Insensitive Communicating Processes. Faculty</span></div>
<div style="position:absolute;left:246.84px;top:475.52px" class="cls_014"><span class="cls_014">T.C. Ruys. Towards Effective Model Checking. Fac-</span></div>
<div style="position:absolute;left:59.72px;top:481.20px" class="cls_014"><span class="cls_014">of Mathematics and Natural Sciences, RUG. 2000-03</span></div>
<div style="position:absolute;left:246.84px;top:484.99px" class="cls_014"><span class="cls_014">ulty of Computer Science, UT. 2001-10</span></div>
<div style="position:absolute;left:59.72px;top:496.88px" class="cls_014"><span class="cls_014">W.O.D. Griffioen. Studies in Computer Aided Verifi-</span></div>
<div style="position:absolute;left:246.84px;top:499.40px" class="cls_014"><span class="cls_014">D. Chkliaev. Mechanical verification of concurrency</span></div>
<div style="position:absolute;left:59.72px;top:506.34px" class="cls_014"><span class="cls_014">cation of Protocols. Faculty of Science, KUN. 2000-</span></div>
<div style="position:absolute;left:246.84px;top:508.87px" class="cls_014"><span class="cls_014">control and recovery protocols. Faculty of Mathemat-</span></div>
<div style="position:absolute;left:59.72px;top:515.81px" class="cls_014"><span class="cls_014">04</span></div>
<div style="position:absolute;left:246.84px;top:518.33px" class="cls_014"><span class="cls_014">ics and Computing Science, TU/e. 2001-11</span></div>
<div style="position:absolute;left:59.72px;top:531.48px" class="cls_014"><span class="cls_014">P.H.F.M. Verhoeven.  The Design of the MathSpad</span></div>
<div style="position:absolute;left:246.84px;top:532.74px" class="cls_014"><span class="cls_014">M.D. Oostdijk. Generation and presentation of for-</span></div>
<div style="position:absolute;left:59.72px;top:540.95px" class="cls_014"><span class="cls_014">Editor. Faculty of Mathematics and Computing Sci-</span></div>
<div style="position:absolute;left:246.84px;top:542.21px" class="cls_014"><span class="cls_014">mal mathematical documents. Faculty of Mathemat-</span></div>
<div style="position:absolute;left:59.72px;top:550.41px" class="cls_014"><span class="cls_014">ence, TUE. 2000-05</span></div>
<div style="position:absolute;left:246.84px;top:551.67px" class="cls_014"><span class="cls_014">ics and Computing Science, TU/e. 2001-12</span></div>
<div style="position:absolute;left:59.72px;top:566.09px" class="cls_014"><span class="cls_014">J. Fey. Design of a Fruit Juice Blending and Packag-</span></div>
<div style="position:absolute;left:246.84px;top:566.09px" class="cls_014"><span class="cls_014">A.T. Hofkamp. Reactive machine control: A simula-</span></div>
<div style="position:absolute;left:59.72px;top:575.55px" class="cls_014"><span class="cls_014">ing Plant. Faculty of Mechanical Engineering, TUE.</span></div>
<div style="position:absolute;left:246.84px;top:575.55px" class="cls_014"><span class="cls_014">tion approach using χ. Faculty of Mechanical Engi-</span></div>
<div style="position:absolute;left:59.72px;top:585.01px" class="cls_014"><span class="cls_014">2000-06</span></div>
<div style="position:absolute;left:246.84px;top:585.01px" class="cls_014"><span class="cls_014">neering, TU/e. 2001-13</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:189060px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background279.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:46.94px" class="cls_014"><span class="cls_014">D. Bošnački. Enhancing state space reduction tech-</span></div>
<div style="position:absolute;left:250.99px;top:47.03px" class="cls_014"><span class="cls_014">S. Andova. Probabilistic Process Algebra. Faculty of</span></div>
<div style="position:absolute;left:63.87px;top:56.50px" class="cls_014"><span class="cls_014">niques for model checking.  Faculty of Mathematics</span></div>
<div style="position:absolute;left:250.99px;top:56.50px" class="cls_014"><span class="cls_014">Mathematics and Computer Science, TU/e. 2002-15</span></div>
<div style="position:absolute;left:63.87px;top:65.96px" class="cls_014"><span class="cls_014">and Computing Science, TU/e. 2001-14</span></div>
<div style="position:absolute;left:250.99px;top:72.17px" class="cls_014"><span class="cls_014">Y.S. Usenko.   Linearization in µCRL. Faculty of</span></div>
<div style="position:absolute;left:63.87px;top:80.73px" class="cls_014"><span class="cls_014">M.C. van Wezel.  Neural Networks for Intelligent</span></div>
<div style="position:absolute;left:250.99px;top:81.64px" class="cls_014"><span class="cls_014">Mathematics and Computer Science, TU/e. 2002-16</span></div>
<div style="position:absolute;left:63.87px;top:90.19px" class="cls_014"><span class="cls_014">Data Analysis: theoretical and experimental aspects.</span></div>
<div style="position:absolute;left:63.87px;top:99.66px" class="cls_014"><span class="cls_014">Faculty of Mathematics and Natural Sciences, UL.</span></div>
<div style="position:absolute;left:250.99px;top:97.31px" class="cls_014"><span class="cls_014">J.J.D. Aerts.  Random Redundant Storage for Video</span></div>
<div style="position:absolute;left:250.99px;top:106.77px" class="cls_014"><span class="cls_014">on Demand.  Faculty of Mathematics and Computer</span></div>
<div style="position:absolute;left:63.87px;top:109.12px" class="cls_014"><span class="cls_014">2002-01</span></div>
<div style="position:absolute;left:250.99px;top:116.24px" class="cls_014"><span class="cls_014">Science, TU/e. 2003-01</span></div>
<div style="position:absolute;left:63.87px;top:123.89px" class="cls_014"><span class="cls_014">V. Bos and J.J.T. Kleijn.  Formal Specification and</span></div>
<div style="position:absolute;left:63.87px;top:133.35px" class="cls_014"><span class="cls_014">Analysis of Industrial Systems. Faculty of Mathemat-</span></div>
<div style="position:absolute;left:250.99px;top:131.91px" class="cls_014"><span class="cls_014">M. de Jonge. To Reuse or To Be Reused: Techniques</span></div>
<div style="position:absolute;left:63.87px;top:142.82px" class="cls_014"><span class="cls_014">ics and Computer Science and Faculty of Mechanical</span></div>
<div style="position:absolute;left:250.99px;top:141.38px" class="cls_014"><span class="cls_014">for component composition and construction. Faculty</span></div>
<div style="position:absolute;left:63.87px;top:152.28px" class="cls_014"><span class="cls_014">Engineering, TU/e. 2002-02</span></div>
<div style="position:absolute;left:250.99px;top:150.84px" class="cls_014"><span class="cls_014">of Natural Sciences, Mathematics, and Computer Sci-</span></div>
<div style="position:absolute;left:250.99px;top:160.31px" class="cls_014"><span class="cls_014">ence, UvA. 2003-02</span></div>
<div style="position:absolute;left:63.87px;top:167.05px" class="cls_014"><span class="cls_014">T. Kuipers.  Techniques for Understanding Legacy</span></div>
<div style="position:absolute;left:63.87px;top:176.51px" class="cls_014"><span class="cls_014">Software Systems. Faculty of Natural Sciences, Math-</span></div>
<div style="position:absolute;left:250.99px;top:175.98px" class="cls_014"><span class="cls_014">J.M.W. Visser. Generic Traversal over Typed Source</span></div>
<div style="position:absolute;left:63.87px;top:185.98px" class="cls_014"><span class="cls_014">ematics and Computer Science, UvA. 2002-03</span></div>
<div style="position:absolute;left:250.99px;top:185.45px" class="cls_014"><span class="cls_014">Code Representations.  Faculty of Natural Sciences,</span></div>
<div style="position:absolute;left:250.99px;top:194.91px" class="cls_014"><span class="cls_014">Mathematics, and Computer Science, UvA. 2003-03</span></div>
<div style="position:absolute;left:63.87px;top:200.74px" class="cls_014"><span class="cls_014">S.P. Luttik.  Choice Quantification in Process Alge-</span></div>
<div style="position:absolute;left:63.87px;top:210.21px" class="cls_014"><span class="cls_014">bra.  Faculty of Natural Sciences, Mathematics, and</span></div>
<div style="position:absolute;left:250.99px;top:210.59px" class="cls_014"><span class="cls_014">S.M. Bohte.  Spiking Neural Networks.  Faculty of</span></div>
<div style="position:absolute;left:63.87px;top:219.67px" class="cls_014"><span class="cls_014">Computer Science, UvA. 2002-04</span></div>
<div style="position:absolute;left:250.99px;top:220.05px" class="cls_014"><span class="cls_014">Mathematics and Natural Sciences, UL. 2003-04</span></div>
<div style="position:absolute;left:63.87px;top:234.44px" class="cls_014"><span class="cls_014">R.J. Willemen. School Timetable Construction: Al-</span></div>
<div style="position:absolute;left:250.99px;top:235.72px" class="cls_014"><span class="cls_014">T.A.C. Willemse. Semantics and Verification in Pro-</span></div>
<div style="position:absolute;left:63.87px;top:243.90px" class="cls_014"><span class="cls_014">gorithms and Complexity.  Faculty of Mathematics</span></div>
<div style="position:absolute;left:250.99px;top:245.19px" class="cls_014"><span class="cls_014">cess Algebras with Data and Timing. Faculty of Math-</span></div>
<div style="position:absolute;left:63.87px;top:253.37px" class="cls_014"><span class="cls_014">and Computer Science, TU/e. 2002-05</span></div>
<div style="position:absolute;left:250.99px;top:254.65px" class="cls_014"><span class="cls_014">ematics and Computer Science, TU/e. 2003-05</span></div>
<div style="position:absolute;left:63.87px;top:268.13px" class="cls_014"><span class="cls_014">M.I.A.  Stoelinga.   Alea  Jacta  Est:  Verification</span></div>
<div style="position:absolute;left:250.99px;top:270.33px" class="cls_014"><span class="cls_014">S.V. Nedea. Analysis and Simulations of Catalytic Re-</span></div>
<div style="position:absolute;left:63.87px;top:277.60px" class="cls_014"><span class="cls_014">of Probabilistic, Real-time and Parametric Systems.</span></div>
<div style="position:absolute;left:250.99px;top:279.79px" class="cls_014"><span class="cls_014">actions.  Faculty of Mathematics and Computer Sci-</span></div>
<div style="position:absolute;left:63.87px;top:287.06px" class="cls_014"><span class="cls_014">Faculty of Science, Mathematics and Computer Sci-</span></div>
<div style="position:absolute;left:250.99px;top:289.26px" class="cls_014"><span class="cls_014">ence, TU/e. 2003-06</span></div>
<div style="position:absolute;left:63.87px;top:296.52px" class="cls_014"><span class="cls_014">ence, KUN. 2002-06</span></div>
<div style="position:absolute;left:250.99px;top:304.93px" class="cls_014"><span class="cls_014">M.E.M. Lijding.  Real-time Scheduling of Tertiary</span></div>
<div style="position:absolute;left:63.87px;top:311.29px" class="cls_014"><span class="cls_014">N. van Vugt. Models of Molecular Computing. Fac-</span></div>
<div style="position:absolute;left:250.99px;top:314.40px" class="cls_014"><span class="cls_014">Storage.  Faculty of Electrical Engineering, Mathe-</span></div>
<div style="position:absolute;left:63.87px;top:320.76px" class="cls_014"><span class="cls_014">ulty of Mathematics and Natural Sciences, UL. 2002-</span></div>
<div style="position:absolute;left:250.99px;top:323.86px" class="cls_014"><span class="cls_014">matics & Computer Science, UT. 2003-07</span></div>
<div style="position:absolute;left:63.87px;top:330.22px" class="cls_014"><span class="cls_014">07</span></div>
<div style="position:absolute;left:250.99px;top:339.54px" class="cls_014"><span class="cls_014">H.P. Benz. Casual Multimedia Process Annotation —</span></div>
<div style="position:absolute;left:63.87px;top:344.99px" class="cls_014"><span class="cls_014">A. Fehnker.  Citius, Vilius, Melius:  Guiding and</span></div>
<div style="position:absolute;left:250.99px;top:349.00px" class="cls_014"><span class="cls_014">CoMPAs.  Faculty of Electrical Engineering, Mathe-</span></div>
<div style="position:absolute;left:63.87px;top:354.45px" class="cls_014"><span class="cls_014">Cost-Optimality in Model Checking of Timed and Hy-</span></div>
<div style="position:absolute;left:250.99px;top:358.46px" class="cls_014"><span class="cls_014">matics & Computer Science, UT. 2003-08</span></div>
<div style="position:absolute;left:63.87px;top:363.92px" class="cls_014"><span class="cls_014">brid Systems.  Faculty of Science, Mathematics and</span></div>
<div style="position:absolute;left:63.87px;top:373.38px" class="cls_014"><span class="cls_014">Computer Science, KUN. 2002-08</span></div>
<div style="position:absolute;left:250.99px;top:374.14px" class="cls_014"><span class="cls_014">D. Distefano.  On Modelchecking the Dynamics of</span></div>
<div style="position:absolute;left:250.99px;top:383.60px" class="cls_014"><span class="cls_014">Object-based Software:  a Foundational Approach.</span></div>
<div style="position:absolute;left:63.87px;top:388.15px" class="cls_014"><span class="cls_014">R. van Stee.  On-line Scheduling and Bin Packing.</span></div>
<div style="position:absolute;left:250.99px;top:393.07px" class="cls_014"><span class="cls_014">Faculty of Electrical Engineering,  Mathematics &</span></div>
<div style="position:absolute;left:63.87px;top:397.61px" class="cls_014"><span class="cls_014">Faculty of Mathematics and Natural Sciences, UL.</span></div>
<div style="position:absolute;left:250.99px;top:402.53px" class="cls_014"><span class="cls_014">Computer Science, UT. 2003-09</span></div>
<div style="position:absolute;left:63.87px;top:407.07px" class="cls_014"><span class="cls_014">2002-09</span></div>
<div style="position:absolute;left:250.99px;top:418.21px" class="cls_014"><span class="cls_014">M.H. ter Beek.  Team Automata — A Formal Ap-</span></div>
<div style="position:absolute;left:63.87px;top:421.84px" class="cls_014"><span class="cls_014">D. Tauritz. Adaptive Information Filtering: Concepts</span></div>
<div style="position:absolute;left:250.99px;top:427.67px" class="cls_014"><span class="cls_014">proach to the Modeling of Collaboration Between Sys-</span></div>
<div style="position:absolute;left:63.87px;top:431.31px" class="cls_014"><span class="cls_014">and Algorithms. Faculty of Mathematics and Natural</span></div>
<div style="position:absolute;left:250.99px;top:437.14px" class="cls_014"><span class="cls_014">tem Components. Faculty of Mathematics and Natural</span></div>
<div style="position:absolute;left:63.87px;top:440.77px" class="cls_014"><span class="cls_014">Sciences, UL. 2002-10</span></div>
<div style="position:absolute;left:250.99px;top:446.60px" class="cls_014"><span class="cls_014">Sciences, UL. 2003-10</span></div>
<div style="position:absolute;left:63.87px;top:455.54px" class="cls_014"><span class="cls_014">M.B. van der Zwaag. Models and Logics for Process</span></div>
<div style="position:absolute;left:63.87px;top:465.00px" class="cls_014"><span class="cls_014">Algebra.  Faculty of Natural Sciences, Mathematics,</span></div>
<div style="position:absolute;left:250.99px;top:462.27px" class="cls_014"><span class="cls_014">D.J.P. Leijen.  The λ Abroad — A Functional Ap-</span></div>
<div style="position:absolute;left:250.99px;top:471.74px" class="cls_014"><span class="cls_014">proach to Software Components.  Faculty of Mathe-</span></div>
<div style="position:absolute;left:63.87px;top:474.46px" class="cls_014"><span class="cls_014">and Computer Science, UvA. 2002-11</span></div>
<div style="position:absolute;left:250.99px;top:481.20px" class="cls_014"><span class="cls_014">matics and Computer Science, UU. 2003-11</span></div>
<div style="position:absolute;left:63.87px;top:489.23px" class="cls_014"><span class="cls_014">J.I. den Hartog. Probabilistic Extensions of Seman-</span></div>
<div style="position:absolute;left:63.87px;top:498.70px" class="cls_014"><span class="cls_014">tical Models. Faculty of Sciences, Division of Mathe-</span></div>
<div style="position:absolute;left:250.99px;top:496.88px" class="cls_014"><span class="cls_014">W.P.A.J. Michiels.  Performance Ratios for the Dif-</span></div>
<div style="position:absolute;left:63.87px;top:508.16px" class="cls_014"><span class="cls_014">matics and Computer Science, VUA. 2002-12</span></div>
<div style="position:absolute;left:250.99px;top:506.34px" class="cls_014"><span class="cls_014">ferencing Method. Faculty of Mathematics and Com-</span></div>
<div style="position:absolute;left:250.99px;top:515.81px" class="cls_014"><span class="cls_014">puter Science, TU/e. 2004-01</span></div>
<div style="position:absolute;left:63.87px;top:522.93px" class="cls_014"><span class="cls_014">L. Moonen.  Exploring Software Systems.  Faculty</span></div>
<div style="position:absolute;left:63.87px;top:532.39px" class="cls_014"><span class="cls_014">of Natural Sciences, Mathematics, and Computer Sci-</span></div>
<div style="position:absolute;left:250.99px;top:531.48px" class="cls_014"><span class="cls_014">G.I. Jojgov. Incomplete Proofs and Terms and Their</span></div>
<div style="position:absolute;left:63.87px;top:541.85px" class="cls_014"><span class="cls_014">ence, UvA. 2002-13</span></div>
<div style="position:absolute;left:250.99px;top:540.95px" class="cls_014"><span class="cls_014">Use in Interactive Theorem Proving. Faculty of Math-</span></div>
<div style="position:absolute;left:250.99px;top:550.41px" class="cls_014"><span class="cls_014">ematics and Computer Science, TU/e. 2004-02</span></div>
<div style="position:absolute;left:63.87px;top:556.62px" class="cls_014"><span class="cls_014">J.I. van Hemert.  Applying Evolutionary Computa-</span></div>
<div style="position:absolute;left:63.87px;top:566.09px" class="cls_014"><span class="cls_014">tion to Constraint Satisfaction and Data Mining. Fac-</span></div>
<div style="position:absolute;left:250.99px;top:566.09px" class="cls_014"><span class="cls_014">P. Frisco. Theory of Molecular Computing — Splic-</span></div>
<div style="position:absolute;left:63.87px;top:575.55px" class="cls_014"><span class="cls_014">ulty of Mathematics and Natural Sciences, UL. 2002-</span></div>
<div style="position:absolute;left:250.99px;top:575.55px" class="cls_014"><span class="cls_014">ing and Membrane systems. Faculty of Mathematics</span></div>
<div style="position:absolute;left:63.87px;top:585.01px" class="cls_014"><span class="cls_014">14</span></div>
<div style="position:absolute;left:250.99px;top:585.01px" class="cls_014"><span class="cls_014">and Natural Sciences, UL. 2004-03</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:189750px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background280.jpg" width=481 height=680></div>
<div style="position:absolute;left:59.72px;top:47.03px" class="cls_014"><span class="cls_014">S. Maneth.  Models of Tree Translation.  Faculty of</span></div>
<div style="position:absolute;left:246.84px;top:47.03px" class="cls_014"><span class="cls_014">Architectures. Faculty of Mathematics and Computer</span></div>
<div style="position:absolute;left:59.72px;top:56.50px" class="cls_014"><span class="cls_014">Mathematics and Natural Sciences, UL. 2004-04</span></div>
<div style="position:absolute;left:246.84px;top:56.50px" class="cls_014"><span class="cls_014">Science, TU/e. 2004-19</span></div>
<div style="position:absolute;left:59.72px;top:72.17px" class="cls_014"><span class="cls_014">Y. Qian.  Data Synchronization and Browsing for</span></div>
<div style="position:absolute;left:246.84px;top:71.54px" class="cls_014"><span class="cls_014">P.J.L. Cuijpers. Hybrid Process Algebra. Faculty of</span></div>
<div style="position:absolute;left:59.72px;top:81.64px" class="cls_014"><span class="cls_014">Home Environments.  Faculty of Mathematics and</span></div>
<div style="position:absolute;left:246.84px;top:81.00px" class="cls_014"><span class="cls_014">Mathematics and Computer Science, TU/e. 2004-20</span></div>
<div style="position:absolute;left:59.72px;top:91.10px" class="cls_014"><span class="cls_014">Computer Science and Faculty of Industrial Design,</span></div>
<div style="position:absolute;left:246.84px;top:96.05px" class="cls_014"><span class="cls_014">N.J.M. van den Nieuwelaar.  Supervisory Machine</span></div>
<div style="position:absolute;left:59.72px;top:100.56px" class="cls_014"><span class="cls_014">TU/e. 2004-05</span></div>
<div style="position:absolute;left:246.84px;top:105.51px" class="cls_014"><span class="cls_014">Control by Predictive-Reactive Scheduling.  Faculty</span></div>
<div style="position:absolute;left:59.72px;top:116.24px" class="cls_014"><span class="cls_014">F. Bartels.  On Generalised Coinduction and Prob-</span></div>
<div style="position:absolute;left:246.84px;top:114.98px" class="cls_014"><span class="cls_014">of Mechanical Engineering, TU/e. 2004-21</span></div>
<div style="position:absolute;left:59.72px;top:125.70px" class="cls_014"><span class="cls_014">abilistic Specification Formats.  Faculty of Sciences,</span></div>
<div style="position:absolute;left:246.84px;top:130.02px" class="cls_014"><span class="cls_014">E. Ábrahám. An Assertional Proof System for Multi-</span></div>
<div style="position:absolute;left:59.72px;top:135.17px" class="cls_014"><span class="cls_014">Division  of  Mathematics  and  Computer  Science,</span></div>
<div style="position:absolute;left:246.84px;top:139.49px" class="cls_014"><span class="cls_014">threaded Java — Theory and Tool Support. Faculty of</span></div>
<div style="position:absolute;left:59.72px;top:144.63px" class="cls_014"><span class="cls_014">VUA. 2004-06</span></div>
<div style="position:absolute;left:246.84px;top:148.95px" class="cls_014"><span class="cls_014">Mathematics and Natural Sciences, UL. 2005-01</span></div>
<div style="position:absolute;left:59.72px;top:160.31px" class="cls_014"><span class="cls_014">L. Cruz-Filipe. Constructive Real Analysis: a Type-</span></div>
<div style="position:absolute;left:246.84px;top:163.99px" class="cls_014"><span class="cls_014">R. Ruimerman. Modeling and Remodeling in Bone</span></div>
<div style="position:absolute;left:59.72px;top:169.77px" class="cls_014"><span class="cls_014">Theoretical Formalization and Applications.   Fac-</span></div>
<div style="position:absolute;left:246.84px;top:173.46px" class="cls_014"><span class="cls_014">Tissue.  Faculty of Biomedical Engineering, TU/e.</span></div>
<div style="position:absolute;left:59.72px;top:179.24px" class="cls_014"><span class="cls_014">ulty of Science, Mathematics and Computer Science,</span></div>
<div style="position:absolute;left:246.84px;top:182.92px" class="cls_014"><span class="cls_014">2005-02</span></div>
<div style="position:absolute;left:59.72px;top:188.70px" class="cls_014"><span class="cls_014">KUN. 2004-07</span></div>
<div style="position:absolute;left:246.84px;top:197.97px" class="cls_014"><span class="cls_014">C.N. Chong.  Experiments in Rights Control — Ex-</span></div>
<div style="position:absolute;left:59.72px;top:204.38px" class="cls_014"><span class="cls_014">E.H. Gerding.  Autonomous Agents in Bargaining</span></div>
<div style="position:absolute;left:246.84px;top:207.43px" class="cls_014"><span class="cls_014">pression and Enforcement. Faculty of Electrical En-</span></div>
<div style="position:absolute;left:59.72px;top:213.84px" class="cls_014"><span class="cls_014">Games: An Evolutionary Investigation of Fundamen-</span></div>
<div style="position:absolute;left:246.84px;top:216.89px" class="cls_014"><span class="cls_014">gineering,  Mathematics & Computer Science,  UT.</span></div>
<div style="position:absolute;left:59.72px;top:223.30px" class="cls_014"><span class="cls_014">tals, Strategies, and Business Applications. Faculty of</span></div>
<div style="position:absolute;left:246.84px;top:226.36px" class="cls_014"><span class="cls_014">2005-03</span></div>
<div style="position:absolute;left:59.72px;top:232.77px" class="cls_014"><span class="cls_014">Technology Management, TU/e. 2004-08</span></div>
<div style="position:absolute;left:246.84px;top:241.40px" class="cls_014"><span class="cls_014">H. Gao. Design and Verification of Lock-free Parallel</span></div>
<div style="position:absolute;left:59.72px;top:248.44px" class="cls_014"><span class="cls_014">N. Goga.  Control and Selection Techniques for the</span></div>
<div style="position:absolute;left:246.84px;top:250.87px" class="cls_014"><span class="cls_014">Algorithms. Faculty of Mathematics and Computing</span></div>
<div style="position:absolute;left:59.72px;top:257.91px" class="cls_014"><span class="cls_014">Automated Testing of Reactive Systems.  Faculty of</span></div>
<div style="position:absolute;left:246.84px;top:260.33px" class="cls_014"><span class="cls_014">Sciences, RUG. 2005-04</span></div>
<div style="position:absolute;left:59.72px;top:267.37px" class="cls_014"><span class="cls_014">Mathematics and Computer Science, TU/e. 2004-09</span></div>
<div style="position:absolute;left:246.84px;top:275.38px" class="cls_014"><span class="cls_014">H.M.A. van Beek.   Specification and Analysis of</span></div>
<div style="position:absolute;left:59.72px;top:283.05px" class="cls_014"><span class="cls_014">M. Niqui. Formalising Exact Arithmetic: Represen-</span></div>
<div style="position:absolute;left:246.84px;top:284.84px" class="cls_014"><span class="cls_014">Internet Applications.  Faculty of Mathematics and</span></div>
<div style="position:absolute;left:59.72px;top:292.51px" class="cls_014"><span class="cls_014">tations, Algorithms and Proofs.  Faculty of Science,</span></div>
<div style="position:absolute;left:246.84px;top:294.30px" class="cls_014"><span class="cls_014">Computer Science, TU/e. 2005-05</span></div>
<div style="position:absolute;left:59.72px;top:301.98px" class="cls_014"><span class="cls_014">Mathematics and Computer Science, RU. 2004-10</span></div>
<div style="position:absolute;left:246.84px;top:309.35px" class="cls_014"><span class="cls_014">M.T. Ionita. Scenario-Based System Architecting —</span></div>
<div style="position:absolute;left:59.72px;top:317.65px" class="cls_014"><span class="cls_014">A. Löh. Exploring Generic Haskell. Faculty of Math-</span></div>
<div style="position:absolute;left:246.84px;top:318.81px" class="cls_014"><span class="cls_014">A Systematic Approach to Developing Future-Proof</span></div>
<div style="position:absolute;left:59.72px;top:327.11px" class="cls_014"><span class="cls_014">ematics and Computer Science, UU. 2004-11</span></div>
<div style="position:absolute;left:246.84px;top:328.28px" class="cls_014"><span class="cls_014">System Architectures.  Faculty of Mathematics and</span></div>
<div style="position:absolute;left:246.84px;top:337.74px" class="cls_014"><span class="cls_014">Computing Sciences, TU/e. 2005-06</span></div>
<div style="position:absolute;left:59.72px;top:342.79px" class="cls_014"><span class="cls_014">I.C.M. Flinsenberg. Route Planning Algorithms for</span></div>
<div style="position:absolute;left:59.72px;top:352.25px" class="cls_014"><span class="cls_014">Car Navigation.  Faculty of Mathematics and Com-</span></div>
<div style="position:absolute;left:246.84px;top:352.79px" class="cls_014"><span class="cls_014">G. Lenzini.  Integration of Analysis Techniques in</span></div>
<div style="position:absolute;left:59.72px;top:361.72px" class="cls_014"><span class="cls_014">puter Science, TU/e. 2004-12</span></div>
<div style="position:absolute;left:246.84px;top:362.25px" class="cls_014"><span class="cls_014">Security and Fault-Tolerance.  Faculty of Electrical</span></div>
<div style="position:absolute;left:246.84px;top:371.71px" class="cls_014"><span class="cls_014">Engineering, Mathematics & Computer Science, UT.</span></div>
<div style="position:absolute;left:59.72px;top:377.39px" class="cls_014"><span class="cls_014">R.J. Bril. Real-time Scheduling for Media Processing</span></div>
<div style="position:absolute;left:246.84px;top:381.18px" class="cls_014"><span class="cls_014">2005-07</span></div>
<div style="position:absolute;left:59.72px;top:386.86px" class="cls_014"><span class="cls_014">Using Conditionally Guaranteed Budgets. Faculty of</span></div>
<div style="position:absolute;left:59.72px;top:396.32px" class="cls_014"><span class="cls_014">Mathematics and Computer Science, TU/e. 2004-13</span></div>
<div style="position:absolute;left:246.84px;top:396.22px" class="cls_014"><span class="cls_014">I. Kurtev.  Adaptability of Model Transformations.</span></div>
<div style="position:absolute;left:246.84px;top:405.69px" class="cls_014"><span class="cls_014">Faculty of Electrical Engineering,  Mathematics &</span></div>
<div style="position:absolute;left:59.72px;top:412.00px" class="cls_014"><span class="cls_014">J. Pang. Formal Verification of Distributed Systems.</span></div>
<div style="position:absolute;left:246.84px;top:415.15px" class="cls_014"><span class="cls_014">Computer Science, UT. 2005-08</span></div>
<div style="position:absolute;left:59.72px;top:421.46px" class="cls_014"><span class="cls_014">Faculty of Sciences, Division of Mathematics and</span></div>
<div style="position:absolute;left:59.72px;top:430.93px" class="cls_014"><span class="cls_014">Computer Science, VUA. 2004-14</span></div>
<div style="position:absolute;left:246.84px;top:430.20px" class="cls_014"><span class="cls_014">T. Wolle.  Computational Aspects of Treewidth —</span></div>
<div style="position:absolute;left:246.84px;top:439.66px" class="cls_014"><span class="cls_014">Lower Bounds and Network Reliability.  Faculty of</span></div>
<div style="position:absolute;left:59.72px;top:446.60px" class="cls_014"><span class="cls_014">F. Alkemade. Evolutionary Agent-Based Economics.</span></div>
<div style="position:absolute;left:246.84px;top:449.12px" class="cls_014"><span class="cls_014">Science, UU. 2005-09</span></div>
<div style="position:absolute;left:59.72px;top:456.06px" class="cls_014"><span class="cls_014">Faculty of Technology Management, TU/e. 2004-15</span></div>
<div style="position:absolute;left:246.84px;top:464.17px" class="cls_014"><span class="cls_014">O. Tveretina.   Decision Procedures for Equality</span></div>
<div style="position:absolute;left:59.72px;top:471.74px" class="cls_014"><span class="cls_014">E.O. Dijk. Indoor Ultrasonic Position Estimation Us-</span></div>
<div style="position:absolute;left:246.84px;top:473.63px" class="cls_014"><span class="cls_014">Logic with Uninterpreted Functions. Faculty of Math-</span></div>
<div style="position:absolute;left:59.72px;top:481.20px" class="cls_014"><span class="cls_014">ing a Single Base Station. Faculty of Mathematics and</span></div>
<div style="position:absolute;left:246.84px;top:483.10px" class="cls_014"><span class="cls_014">ematics and Computer Science, TU/e. 2005-10</span></div>
<div style="position:absolute;left:59.72px;top:490.67px" class="cls_014"><span class="cls_014">Computer Science, TU/e. 2004-16</span></div>
<div style="position:absolute;left:246.84px;top:498.14px" class="cls_014"><span class="cls_014">A.M.L. Liekens.  Evolution of Finite Populations in</span></div>
<div style="position:absolute;left:59.72px;top:506.34px" class="cls_014"><span class="cls_014">S.M. Orzan. On Distributed Verification and Verified</span></div>
<div style="position:absolute;left:246.84px;top:507.60px" class="cls_014"><span class="cls_014">Dynamic Environments. Faculty of Biomedical Engi-</span></div>
<div style="position:absolute;left:59.72px;top:515.81px" class="cls_014"><span class="cls_014">Distribution. Faculty of Sciences, Division of Mathe-</span></div>
<div style="position:absolute;left:246.84px;top:517.07px" class="cls_014"><span class="cls_014">neering, TU/e. 2005-11</span></div>
<div style="position:absolute;left:59.72px;top:525.27px" class="cls_014"><span class="cls_014">matics and Computer Science, VUA. 2004-17</span></div>
<div style="position:absolute;left:246.84px;top:532.11px" class="cls_014"><span class="cls_014">J. Eggermont. Data Mining using Genetic Program-</span></div>
<div style="position:absolute;left:59.72px;top:540.95px" class="cls_014"><span class="cls_014">M.M. Schrage. Proxima — A Presentation-oriented</span></div>
<div style="position:absolute;left:246.84px;top:541.58px" class="cls_014"><span class="cls_014">ming: Classification and Symbolic Regression.  Fac-</span></div>
<div style="position:absolute;left:59.72px;top:550.41px" class="cls_014"><span class="cls_014">Editor for Structured Documents. Faculty of Mathe-</span></div>
<div style="position:absolute;left:246.84px;top:551.04px" class="cls_014"><span class="cls_014">ulty of Mathematics and Natural Sciences, UL. 2005-</span></div>
<div style="position:absolute;left:59.72px;top:559.88px" class="cls_014"><span class="cls_014">matics and Computer Science, UU. 2004-18</span></div>
<div style="position:absolute;left:246.84px;top:560.51px" class="cls_014"><span class="cls_014">12</span></div>
<div style="position:absolute;left:59.72px;top:575.55px" class="cls_014"><span class="cls_014">E. Eskenazi and A. Fyukov. Quantitative Prediction</span></div>
<div style="position:absolute;left:246.84px;top:575.55px" class="cls_014"><span class="cls_014">B.J. Heeren. Top Quality Type Error Messages. Fac-</span></div>
<div style="position:absolute;left:59.72px;top:585.01px" class="cls_014"><span class="cls_014">of Quality Attributes for Component-Based Software</span></div>
<div style="position:absolute;left:246.84px;top:585.01px" class="cls_014"><span class="cls_014">ulty of Science, UU. 2005-13</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-240px;top:190440px;width:481px;height:680px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="41da8382-aa32-11eb-8b25-0cc47a792c0a_id_41da8382-aa32-11eb-8b25-0cc47a792c0a_files/background281.jpg" width=481 height=680></div>
<div style="position:absolute;left:63.87px;top:47.03px" class="cls_014"><span class="cls_014">G.F. Frehse.  Compositional Verification of Hybrid</span></div>
<div style="position:absolute;left:250.99px;top:47.03px" class="cls_014"><span class="cls_014">J.J. Vinju.  Analysis and Transformation of Source</span></div>
<div style="position:absolute;left:63.87px;top:56.50px" class="cls_014"><span class="cls_014">Systems using Simulation Relations.  Faculty of Sci-</span></div>
<div style="position:absolute;left:250.99px;top:56.50px" class="cls_014"><span class="cls_014">Code by Parsing and Rewriting.  Faculty of Natural</span></div>
<div style="position:absolute;left:63.87px;top:65.96px" class="cls_014"><span class="cls_014">ence, Mathematics and Computer Science, RU. 2005-</span></div>
<div style="position:absolute;left:250.99px;top:65.96px" class="cls_014"><span class="cls_014">Sciences, Mathematics, and Computer Science, UvA.</span></div>
<div style="position:absolute;left:63.87px;top:75.43px" class="cls_014"><span class="cls_014">14</span></div>
<div style="position:absolute;left:250.99px;top:75.43px" class="cls_014"><span class="cls_014">2005-19</span></div>
<div style="position:absolute;left:63.87px;top:90.87px" class="cls_014"><span class="cls_014">M.R. Mousavi.  Structuring Structural Operational</span></div>
<div style="position:absolute;left:250.99px;top:90.87px" class="cls_014"><span class="cls_014">M. Valero Espada. Modal Abstraction and Replica-</span></div>
<div style="position:absolute;left:63.87px;top:100.33px" class="cls_014"><span class="cls_014">Semantics.  Faculty of Mathematics and Computer</span></div>
<div style="position:absolute;left:250.99px;top:100.33px" class="cls_014"><span class="cls_014">tion of Processes with Data. Faculty of Sciences, Di-</span></div>
<div style="position:absolute;left:63.87px;top:109.80px" class="cls_014"><span class="cls_014">Science, TU/e. 2005-15</span></div>
<div style="position:absolute;left:250.99px;top:109.80px" class="cls_014"><span class="cls_014">vision of Mathematics and Computer Science, VUA.</span></div>
<div style="position:absolute;left:250.99px;top:119.26px" class="cls_014"><span class="cls_014">2005-20</span></div>
<div style="position:absolute;left:63.87px;top:125.24px" class="cls_014"><span class="cls_014">A. Sokolova.  Coalgebraic Analysis of Probabilistic</span></div>
<div style="position:absolute;left:63.87px;top:134.70px" class="cls_014"><span class="cls_014">Systems. Faculty of Mathematics and Computer Sci-</span></div>
<div style="position:absolute;left:250.99px;top:134.70px" class="cls_014"><span class="cls_014">A. Dijkstra.  Stepping through Haskell.  Faculty of</span></div>
<div style="position:absolute;left:63.87px;top:144.17px" class="cls_014"><span class="cls_014">ence, TU/e. 2005-16</span></div>
<div style="position:absolute;left:250.99px;top:144.17px" class="cls_014"><span class="cls_014">Science, UU. 2005-21</span></div>
<div style="position:absolute;left:63.87px;top:159.61px" class="cls_014"><span class="cls_014">T. Gelsema.  Effective Models for the Structure of</span></div>
<div style="position:absolute;left:250.99px;top:159.61px" class="cls_014"><span class="cls_014">Y.W. Law. Key management and link-layer security</span></div>
<div style="position:absolute;left:63.87px;top:169.07px" class="cls_014"><span class="cls_014">pi-Calculus Processes with Replication.  Faculty of</span></div>
<div style="position:absolute;left:250.99px;top:169.07px" class="cls_014"><span class="cls_014">of wireless sensor networks:  energy-efficient attack</span></div>
<div style="position:absolute;left:63.87px;top:178.54px" class="cls_014"><span class="cls_014">Mathematics and Natural Sciences, UL. 2005-17</span></div>
<div style="position:absolute;left:250.99px;top:178.54px" class="cls_014"><span class="cls_014">and defense. Faculty of Electrical Engineering, Math-</span></div>
<div style="position:absolute;left:250.99px;top:188.00px" class="cls_014"><span class="cls_014">ematics & Computer Science, UT. 2005-22</span></div>
<div style="position:absolute;left:63.87px;top:193.98px" class="cls_014"><span class="cls_014">P. Zoeteweij. Composing Constraint Solvers. Faculty</span></div>
<div style="position:absolute;left:63.87px;top:203.45px" class="cls_014"><span class="cls_014">of Natural Sciences, Mathematics, and Computer Sci-</span></div>
<div style="position:absolute;left:250.99px;top:203.45px" class="cls_014"><span class="cls_014">E. Dolstra. The Purely Functional Software Deploy-</span></div>
<div style="position:absolute;left:63.87px;top:212.91px" class="cls_014"><span class="cls_014">ence, UvA. 2005-18</span></div>
<div style="position:absolute;left:250.99px;top:212.91px" class="cls_014"><span class="cls_014">ment Model. Faculty of Science, UU. 2006-01</span></div>
</div>

</body>
</html>

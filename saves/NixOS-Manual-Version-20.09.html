<!DOCTYPE html>
<!-- saved from url=(0038)https://nixos.org/manual/nixos/stable/ -->
<html lang="en" class="with-js"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>NixOS - NixOS 20.09 manual</title>
  
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0">
  <style class="anchorjs"></style><link rel="stylesheet" href="./NixOS-Manual-Version-20.09_files/index.css" type="text/css">

  <link rel="shortcut icon" type="image/png" href="https://nixos.org/favicon.png">
  <meta name="google-site-verification" content="ir-07nYvo3u3x_VmkTO1wCfYJ8uC-SrVBGR7hZgqPSE">

    <script>
    var html = document.documentElement;
    html.className = html.className.replace("without-js", "with-js");
  </script><style>@media print {#ghostery-tracker-tally {display:none !important}}</style>

  <script type="text/javascript" src="./NixOS-Manual-Version-20.09_files/jquery.min.js"></script>

  <link rel="canonical" url="https://nixos.org/manual/nixos/stable">
</head>

<body data-nixos-channels="[{&quot;channel&quot;:&quot;unstable&quot;,&quot;version&quot;:&quot;21.05&quot;},{&quot;channel&quot;:&quot;stable&quot;,&quot;version&quot;:&quot;20.09&quot;}]">
  <header>
    <div>
      <h1><a href="https://nixos.org/">NixOS</a></h1>
            <nav style="display: none;">
        <ul>
<li class="">  <a href="https://nixos.org/explore.html">Explore</a></li>
<li class="">  <a href="https://nixos.org/download.html">Download</a></li>
<li class="">  <a href="https://nixos.org/learn.html">Learn</a></li>
<li class="">  <a href="https://nixos.org/community.html">Community</a></li>
<li class="">  <a href="https://nixos.org/governance.html">Governance</a></li>
<li class="">  <a href="https://nixos.org/donate.html">Donate</a></li>
<li class=" activesearch">          <a href="https://search.nixos.org/packages">Search</a></li>        </ul>
      </nav>
    </div>
  <button class="menu-toggle">Toggle the menu</button></header>

  <main>
<section class="generic-layout docbook-page"><script xmlns="http://www.w3.org/1999/xhtml" src="./NixOS-Manual-Version-20.09_files/highlight.pack.js" type="text/javascript" xml:space="preserve"></script><script xmlns="http://www.w3.org/1999/xhtml" src="./NixOS-Manual-Version-20.09_files/loader.js" type="text/javascript" xml:space="preserve"></script><link xmlns="http://www.w3.org/1999/xhtml" rel="stylesheet" type="text/css" href="./NixOS-Manual-Version-20.09_files/overrides.css"><link xmlns="http://www.w3.org/1999/xhtml" rel="stylesheet" type="text/css" href="./NixOS-Manual-Version-20.09_files/mono-blue.css"><div xmlns="http://www.w3.org/1999/xhtml" class="page-header"><h1 id="nixos-manual"><a id="book-nixos-manual" shape="rect"></a>NixOS Manual<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#nixos-manual" aria-label="Anchor link for: nixos manual" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h1><h2 id="version-20-09">Version 20.09
  <a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#version-20-09" aria-label="Anchor link for: version 20 09" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div><ul xmlns="http://www.w3.org/1999/xhtml" class="hidden"><li class="next"><a accesskey="n" href="https://nixos.org/manual/nixos/stable/options.html">Appendix&nbsp;A.&nbsp;Configuration Options →</a></li></ul><div xmlns="http://www.w3.org/1999/xhtml" class="docbook"><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="preface"><a href="https://nixos.org/manual/nixos/stable/index.html#preface" shape="rect">Preface</a></span></dt><dt><span class="part"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-installation" shape="rect">I. Installation</a></span></dt><dd><dl><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-obtaining" shape="rect">1. Obtaining NixOS</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-installation" shape="rect">2. Installing NixOS</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-changing-config" shape="rect">3. Changing the Configuration</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-upgrading" shape="rect">4. Upgrading NixOS</a></span></dt></dl></dd><dt><span class="part"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-configuration" shape="rect">II. Configuration</a></span></dt><dd><dl><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-configuration-syntax" shape="rect">5. Configuration Syntax</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-package-management" shape="rect">6. Package Management</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-user-management" shape="rect">7. User Management</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-file-systems" shape="rect">8. File Systems</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-x11" shape="rect">9. X Window System</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-gpu-accel" shape="rect">10. GPU acceleration</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-xfce" shape="rect">11. Xfce Desktop Environment</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-networking" shape="rect">12. Networking</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-kernel-config" shape="rect">13. Linux Kernel</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#chap-pantheon" shape="rect">14. Pantheon Desktop</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-matomo" shape="rect">15. Matomo</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-nextcloud" shape="rect">16. Nextcloud</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-jitsi-meet" shape="rect">17. Jitsi Meet</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-grocy" shape="rect">18. Grocy</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-networking-yggdrasil" shape="rect">19. Yggdrasil</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-prosody" shape="rect">20. Prosody</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-prometheus-exporters" shape="rect">21. Prometheus exporters</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-weechat" shape="rect">22. WeeChat</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-taskserver" shape="rect">23. Taskserver</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-matrix" shape="rect">24. Matrix</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-gitlab" shape="rect">25. Gitlab</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-mailman" shape="rect">26. Mailman</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#trezor" shape="rect">27. Trezor</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-emacs" shape="rect">28. Emacs</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-flatpak" shape="rect">29. Flatpak</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-postgresql" shape="rect">30. PostgreSQL</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-foundationdb" shape="rect">31. FoundationDB</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-borgbase" shape="rect">32. BorgBackup</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-hidepid" shape="rect">33. Hiding process information</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-security-acme" shape="rect">34. SSL/TLS Certificates with ACME</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-programs-zsh-ohmyzsh" shape="rect">35. Oh my ZSH</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-program-plotinus" shape="rect">36. Plotinus</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-programs-digitalbitbox" shape="rect">37. Digital Bitbox</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-input-methods" shape="rect">38. Input Methods</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-profiles" shape="rect">39. Profiles</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-kubernetes" shape="rect">40. Kubernetes</a></span></dt></dl></dd><dt><span class="part"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-running" shape="rect">III. Administration</a></span></dt><dd><dl><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-systemctl" shape="rect">41. Service Management</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-rebooting" shape="rect">42. Rebooting and Shutting Down</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-user-sessions" shape="rect">43. User Sessions</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-cgroups" shape="rect">44. Control Groups</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-logging" shape="rect">45. Logging</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-nix-gc" shape="rect">46. Cleaning the Nix Store</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-containers" shape="rect">47. Container Management</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-troubleshooting" shape="rect">48. Troubleshooting</a></span></dt></dl></dd><dt><span class="part"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-development" shape="rect">IV. Development</a></span></dt><dd><dl><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-getting-sources" shape="rect">49. Getting the Sources</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-writing-modules" shape="rect">50. Writing NixOS Modules</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-building-parts" shape="rect">51. Building Specific Parts of NixOS</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-writing-documentation" shape="rect">52. Writing NixOS Documentation</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-building-cd" shape="rect">53. Building Your Own NixOS CD</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-nixos-tests" shape="rect">54. NixOS Tests</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-testing-installer" shape="rect">55. Testing the Installer</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-releases" shape="rect">56. Releases</a></span></dt></dl></dd><dt><span class="appendix"><a href="https://nixos.org/manual/nixos/stable/options.html" shape="rect">A. Configuration Options</a></span></dt><dt><span class="appendix"><a href="https://nixos.org/manual/nixos/stable/release-notes.html" shape="rect">B. Release Notes</a></span></dt></dl></div><section class="preface"><div class="titlepage"><div><div><div class="page-header"><h1 id="preface" class="title">Preface<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#preface" aria-label="Anchor link for: preface" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h1></div></div></div></div><p>
  This manual describes how to install, use and extend NixOS, a Linux
  distribution based on the purely functional package management system
  <a class="link" href="https://nixos.org/nix" target="_top" shape="rect">Nix</a>, that is composed
  using modules and packages defined in the
  <a class="link" href="https://nixos.org/nixpkgs" target="_top" shape="rect">Nixpkgs</a> project.
 </p><p>
  Additional information regarding the Nix package manager and the Nixpkgs
  project can be found in respectively the
  <a class="link" href="https://nixos.org/nix/manual" target="_top" shape="rect">Nix manual</a> and the
  <a class="link" href="https://nixos.org/nixpkgs/manual" target="_top" shape="rect">Nixpkgs manual</a>.
 </p><p>
  If you encounter problems, please report them on the
  <code class="literal"><a class="literal" href="https://discourse.nixos.org/" target="_top" shape="rect">Discourse</a></code> or
  on the <a class="link" href="irc://irc.freenode.net/#nixos" target="_top" shape="rect">
  <code class="literal">#nixos</code> channel on Freenode</a>. Bugs should be
  reported in
  <a class="link" href="https://github.com/NixOS/nixpkgs/issues" target="_top" shape="rect">NixOS’
  GitHub issue tracker</a>.
 </p><div class="alert alert-info"><strong>Note:</strong> 
   Commands prefixed with <code class="literal">#</code> have to be run as root, either
   requiring to login as root user or temporarily switching to it using
   <code class="literal">sudo</code> for example.
  </div></section><div class="part"><div class="titlepage"><div><div><div class="page-header"><h1 id="ch-installation" class="title">Part&nbsp;I.&nbsp;Installation<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#ch-installation" aria-label="Anchor link for: ch installation" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h1></div></div></div></div><div class="partintro"><div></div><p>
   This section describes how to obtain, install, and configure NixOS for
   first-time use.
  </p><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-obtaining" shape="rect">1. Obtaining NixOS</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-installation" shape="rect">2. Installing NixOS</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-changing-config" shape="rect">3. Changing the Configuration</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-upgrading" shape="rect">4. Upgrading NixOS</a></span></dt></dl></div></div><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-obtaining" class="title">Chapter&nbsp;1.&nbsp;Obtaining NixOS<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-obtaining" aria-label="Anchor link for: sec obtaining" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  NixOS ISO images can be downloaded from the
  <a class="link" href="https://nixos.org/nixos/download.html" target="_top" shape="rect">NixOS download
  page</a>. There are a number of installation options. If you happen to
  have an optical drive and a spare CD, burning the image to CD and booting
  from that is probably the easiest option. Most people will need to prepare a
  USB stick to boot from. <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-booting-from-usb" title="2.5.1. Booting from a USB Drive" shape="rect">Section&nbsp;2.5.1, “Booting from a USB Drive”</a> describes the
  preferred method to prepare a USB stick. A number of alternative methods are
  presented in the
  <a class="link" href="https://nixos.wiki/wiki/NixOS_Installation_Guide#Making_the_installation_media" target="_top" shape="rect">NixOS
  Wiki</a>.
 </p><p>
  As an alternative to installing NixOS yourself, you can get a running NixOS
  system through several other means:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Using virtual appliances in Open Virtualization Format (OVF) that can be
     imported into VirtualBox. These are available from the
     <a class="link" href="https://nixos.org/nixos/download.html" target="_top" shape="rect">NixOS download
     page</a>.
    </p></li><li class="listitem"><p>
     Using AMIs for Amazon’s EC2. To find one for your region and instance
     type, please refer to the
     <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/virtualisation/ec2-amis.nix" target="_top" shape="rect">list
     of most recent AMIs</a>.
    </p></li><li class="listitem"><p>
     Using NixOps, the NixOS-based cloud deployment tool, which allows you to
     provision VirtualBox and EC2 NixOS instances from declarative
     specifications. Check out the
     <a class="link" href="https://nixos.org/nixops" target="_top" shape="rect">NixOps homepage</a> for
     details.
    </p></li></ul></div><p>
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-installation" class="title">Chapter&nbsp;2.&nbsp;Installing NixOS<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-installation" aria-label="Anchor link for: sec installation" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-installation-booting" shape="rect">2.1. Booting the system</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-installation-partitioning" shape="rect">2.2. Partitioning and formatting</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-installation-installing" shape="rect">2.3. Installing</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-installation-summary" shape="rect">2.4. Installation summary</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-installation-additional-notes" shape="rect">2.5. Additional installation notes</a></span></dt></dl></div><section class="section"><div class="titlepage"><div><div><h2 id="sec-installation-booting" class="title" style="clear: both">2.1.&nbsp;Booting the system<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-installation-booting" aria-label="Anchor link for: sec installation booting" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   NixOS can be installed on BIOS or UEFI systems. The procedure for a UEFI
   installation is by and large the same as a BIOS installation. The
   differences are mentioned in the steps that follow.
  </p><p>
   The installation media can be burned to a CD, or now more commonly, "burned"
   to a USB drive (see <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-booting-from-usb" title="2.5.1. Booting from a USB Drive" shape="rect">Section&nbsp;2.5.1, “Booting from a USB Drive”</a>).
  </p><p>
   The installation media contains a basic NixOS installation. When it’s
   finished booting, it should have detected most of your hardware.
  </p><p>
   The NixOS manual is available by running <span class="command"><strong>nixos-help</strong></span>.
  </p><p>
   You are logged-in automatically as <code class="literal">nixos</code>.
   The <code class="literal">nixos</code> user account has an empty password so you
   can use <span class="command"><strong>sudo</strong></span> without a password.
  </p><p>
   If you downloaded the graphical ISO image, you can run <span class="command"><strong>systemctl
   start display-manager</strong></span> to start the desktop environment. If you want to continue on the
   terminal, you can use <span class="command"><strong>loadkeys</strong></span> to switch to your
   preferred keyboard layout. (We even provide neo2 via <span class="command"><strong>loadkeys de
   neo</strong></span>!)
  </p><p>
   If the text is too small to be legible, try <span class="command"><strong>setfont ter-v32n</strong></span>
   to increase the font size.
  </p><section class="section"><div class="titlepage"><div><div><h3 id="sec-installation-booting-networking" class="title">2.1.1.&nbsp;Networking in the installer<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-installation-booting-networking" aria-label="Anchor link for: sec installation booting networking" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    The boot process should have brought up networking (check <span class="command"><strong>ip
    a</strong></span>). Networking is necessary for the installer, since it will
    download lots of stuff (such as source tarballs or Nixpkgs channel
    binaries). It’s best if you have a DHCP server on your network. Otherwise
    configure networking manually using <span class="command"><strong>ifconfig</strong></span>.
   </p><p>
    To manually configure the network on the graphical installer, first disable
    network-manager with <span class="command"><strong>systemctl stop NetworkManager</strong></span>.
   </p><p>
    To manually configure the wifi on the minimal installer, run
    <span class="command"><strong>wpa_supplicant -B -i interface -c &lt;(wpa_passphrase 'SSID'
    'key')</strong></span>.
   </p><p>
    If you would like to continue the installation from a different machine you
    can use activated SSH daemon. You need to copy your ssh key to either
    <code class="literal">/home/nixos/.ssh/authorized_keys</code> or
    <code class="literal">/root/.ssh/authorized_keys</code> (Tip: For installers with a
    modifiable filesystem such as the sd-card installer image a key can be manually
    placed by mounting the image on a different machine). Alternatively you must set
    a password for either <code class="literal">root</code> or <code class="literal">nixos</code> with
    <span class="command"><strong>passwd</strong></span> to be able to login.
   </p></section></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-installation-partitioning" class="title" style="clear: both">2.2.&nbsp;Partitioning and formatting<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-installation-partitioning" aria-label="Anchor link for: sec installation partitioning" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   The NixOS installer doesn’t do any partitioning or formatting, so you need
   to do that yourself.
  </p><p>
   The NixOS installer ships with multiple partitioning tools. The examples
   below use <span class="command"><strong>parted</strong></span>, but also provides
   <span class="command"><strong>fdisk</strong></span>, <span class="command"><strong>gdisk</strong></span>,
   <span class="command"><strong>cfdisk</strong></span>, and <span class="command"><strong>cgdisk</strong></span>.
  </p><p>
   The recommended partition scheme differs depending if the computer uses
   <span class="emphasis"><em>Legacy Boot</em></span> or <span class="emphasis"><em>UEFI</em></span>.
  </p><section class="section"><div class="titlepage"><div><div><h3 id="sec-installation-partitioning-UEFI" class="title">2.2.1.&nbsp;UEFI (GPT)<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-installation-partitioning-UEFI" aria-label="Anchor link for: sec installation partitioning UEFI" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    Here's an example partition scheme for UEFI, using
    <code class="filename">/dev/sda</code> as the device.
    </p><div class="alert alert-info"><strong>Note:</strong> 
      You can safely ignore <span class="command"><strong>parted</strong></span>'s informational message
      about needing to update /etc/fstab.
     </div><p>
   </p><p>
    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
       Create a <span class="emphasis"><em>GPT</em></span> partition table.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mklabel gpt</span></span></pre><p>
      </p></li><li class="listitem"><p>
       Add the <span class="emphasis"><em>root</em></span> partition. This will fill the disk
       except for the end part, where the swap will live, and the space left in
       front (512MiB) which will be used by the boot partition.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mkpart primary 512MiB -8GiB</span></span></pre><p>
      </p></li><li class="listitem"><p>
       Next, add a <span class="emphasis"><em>swap</em></span> partition. The size required will
       vary according to needs, here a 8GiB one is created.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mkpart primary linux-swap -8GiB 100%</span></span></pre><p>
       </p><div class="alert alert-info"><strong>Note:</strong> 
         The swap partition size rules are no different than for other Linux
         distributions.
        </div><p>
      </p></li><li class="listitem"><p>
       Finally, the <span class="emphasis"><em>boot</em></span> partition. NixOS by default uses
       the ESP (EFI system partition) as its <span class="emphasis"><em>/boot</em></span>
       partition. It uses the initially reserved 512MiB at the start of the
       disk.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mkpart ESP fat32 1MiB 512MiB</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- set 3 esp on</span></span></pre><p>
      </p></li></ol></div><p>
   </p><p>
    Once complete, you can follow with
    <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-installation-partitioning-formatting" title="2.2.3. Formatting" shape="rect">Section&nbsp;2.2.3, “Formatting”</a>.
   </p></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-installation-partitioning-MBR" class="title">2.2.2.&nbsp;Legacy Boot (MBR)<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-installation-partitioning-MBR" aria-label="Anchor link for: sec installation partitioning MBR" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    Here's an example partition scheme for Legacy Boot, using
    <code class="filename">/dev/sda</code> as the device.
    </p><div class="alert alert-info"><strong>Note:</strong> 
      You can safely ignore <span class="command"><strong>parted</strong></span>'s informational message
      about needing to update /etc/fstab.
     </div><p>
   </p><p>
    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
       Create a <span class="emphasis"><em>MBR</em></span> partition table.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mklabel msdos</span></span></pre><p>
      </p></li><li class="listitem"><p>
       Add the <span class="emphasis"><em>root</em></span> partition. This will fill the the disk
       except for the end part, where the swap will live.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mkpart primary 1MiB -8GiB</span></span></pre><p>
      </p></li><li class="listitem"><p>
       Finally, add a <span class="emphasis"><em>swap</em></span> partition. The size required
       will vary according to needs, here a 8GiB one is created.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mkpart primary linux-swap -8GiB 100%</span></span></pre><p>
       </p><div class="alert alert-info"><strong>Note:</strong> 
         The swap partition size rules are no different than for other Linux
         distributions.
        </div><p>
      </p></li></ol></div><p>
   </p><p>
    Once complete, you can follow with
    <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-installation-partitioning-formatting" title="2.2.3. Formatting" shape="rect">Section&nbsp;2.2.3, “Formatting”</a>.
   </p></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-installation-partitioning-formatting" class="title">2.2.3.&nbsp;Formatting<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-installation-partitioning-formatting" aria-label="Anchor link for: sec installation partitioning formatting" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    Use the following commands:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       For initialising Ext4 partitions: <span class="command"><strong>mkfs.ext4</strong></span>. It is
       recommended that you assign a unique symbolic label to the file system
       using the option <code class="option">-L <em class="replaceable"><code>label</code></em></code>,
       since this makes the file system configuration independent from device
       changes. For example:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mkfs.ext4 -L nixos /dev/sda1</span></span></pre><p>
      </p></li><li class="listitem"><p>
       For creating swap partitions: <span class="command"><strong>mkswap</strong></span>. Again it’s
       recommended to assign a label to the swap partition: <code class="option">-L
       <em class="replaceable"><code>label</code></em></code>. For example:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mkswap -L swap /dev/sda2</span></span></pre><p>
      </p></li><li class="listitem"><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         UEFI systems
        </span></dt><dd><p>
          For creating boot partitions: <span class="command"><strong>mkfs.fat</strong></span>. Again
          it’s recommended to assign a label to the boot partition:
          <code class="option">-n <em class="replaceable"><code>label</code></em></code>. For example:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mkfs.fat -F 32 -n boot /dev/sda3</span></span></pre><p>
         </p></dd></dl></div></li><li class="listitem"><p>
       For creating LVM volumes, the LVM commands, e.g.,
       <span class="command"><strong>pvcreate</strong></span>, <span class="command"><strong>vgcreate</strong></span>, and
       <span class="command"><strong>lvcreate</strong></span>.
      </p></li><li class="listitem"><p>
       For creating software RAID devices, use <span class="command"><strong>mdadm</strong></span>.
      </p></li></ul></div><p>
   </p></section></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-installation-installing" class="title" style="clear: both">2.3.&nbsp;Installing<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-installation-installing" aria-label="Anchor link for: sec installation installing" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
     Mount the target file system on which NixOS should be installed on
     <code class="filename">/mnt</code>, e.g.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mount /dev/disk/by-label/nixos /mnt</span></span>
</pre><p>
    </p></li><li class="listitem"><div class="variablelist"><dl class="variablelist"><dt><span class="term">
       UEFI systems
      </span></dt><dd><p>
        Mount the boot file system on <code class="filename">/mnt/boot</code>, e.g.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mkdir -p /mnt/boot</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mount /dev/disk/by-label/boot /mnt/boot</span></span>
</pre><p>
       </p></dd></dl></div></li><li class="listitem"><p>
     If your machine has a limited amount of memory, you may want to activate
     swap devices now (<span class="command"><strong>swapon
     <em class="replaceable"><code>device</code></em></strong></span>). The installer (or rather,
     the build actions that it may spawn) may need quite a bit of RAM,
     depending on your configuration.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">swapon /dev/sda2</span></span></pre><p>
    </p></li><li class="listitem"><p>
     You now need to create a file
     <code class="filename">/mnt/etc/nixos/configuration.nix</code> that specifies the
     intended configuration of the system. This is because NixOS has a
     <span class="emphasis"><em>declarative</em></span> configuration model: you create or edit a
     description of the desired configuration of your system, and then NixOS
     takes care of making it happen. The syntax of the NixOS configuration file
     is described in <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-configuration-syntax" title="Chapter 5. Configuration Syntax" shape="rect">Chapter&nbsp;5, <em>Configuration Syntax</em></a>, while a list
     of available configuration options appears in
     <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html" title="Appendix A. Configuration Options" shape="rect">Appendix&nbsp;A, <em>Configuration Options</em></a>. A minimal example is shown in
     <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-config" title="Example 2.4. NixOS Configuration" shape="rect">Example&nbsp;2.4, “NixOS Configuration”</a>.
    </p><p>
     The command <span class="command"><strong>nixos-generate-config</strong></span> can generate an
     initial configuration file for you:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-generate-config --root /mnt</span></span></pre><p>
     You should then edit <code class="filename">/mnt/etc/nixos/configuration.nix</code>
     to suit your needs:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nano /mnt/etc/nixos/configuration.nix</span></span>
</pre><p>
     If you’re using the graphical ISO image, other editors may be available
     (such as <span class="command"><strong>vim</strong></span>). If you have network access, you can also
     install other editors — for instance, you can install Emacs by running
     <code class="literal">nix-env -f '&lt;nixpkgs&gt;' -iA emacs</code>.
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
       BIOS systems
      </span></dt><dd><p>
        You <span class="emphasis"><em>must</em></span> set the option
        <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.grub.device" shape="rect"><code class="option">boot.loader.grub.device</code></a> to specify on which disk
        the GRUB boot loader is to be installed. Without it, NixOS cannot boot.
       </p></dd><dt><span class="term">
       UEFI systems
      </span></dt><dd><p>
        You <span class="emphasis"><em>must</em></span> set the option
        <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.systemd-boot.enable" shape="rect"><code class="option">boot.loader.systemd-boot.enable</code></a> to
        <code class="literal">true</code>. <span class="command"><strong>nixos-generate-config</strong></span>
        should do this automatically for new configurations when booted in UEFI
        mode.
       </p><p>
        You may want to look at the options starting with
        <code class="option"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.efi.canTouchEfiVariables" shape="rect">boot.loader.efi</a></code>
        and
        <code class="option"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.systemd-boot.enable" shape="rect">boot.loader.systemd</a></code>
        as well.
       </p></dd></dl></div><p>
     If there are other operating systems running on the machine before
     installing NixOS, the <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.grub.useOSProber" shape="rect"><code class="option">boot.loader.grub.useOSProber</code></a>
     option can be set to <code class="literal">true</code> to automatically add them to
     the grub menu.
    </p><p>
     If you need to configure networking for your machine the configuration
     options are described in <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-networking" title="Chapter 12. Networking" shape="rect">Chapter&nbsp;12, <em>Networking</em></a>. In particular,
     while wifi is supported on the installation image, it is not enabled by
     default in the configuration generated by
     <span class="command"><strong>nixos-generate-config</strong></span>.
    </p><p>
     Another critical option is <code class="option">fileSystems</code>, specifying the
     file systems that need to be mounted by NixOS. However, you typically
     don’t need to set it yourself, because
     <span class="command"><strong>nixos-generate-config</strong></span> sets it automatically in
     <code class="filename">/mnt/etc/nixos/hardware-configuration.nix</code> from your
     currently mounted file systems. (The configuration file
     <code class="filename">hardware-configuration.nix</code> is included from
     <code class="filename">configuration.nix</code> and will be overwritten by future
     invocations of <span class="command"><strong>nixos-generate-config</strong></span>; thus, you
     generally should not modify it.) Additionally, you may want to look at
     <a class="link" href="https://github.com/NixOS/nixos-hardware" target="_top" shape="rect">Hardware
     configuration for known-hardware</a> at this point or after
     installation.

    </p><div class="alert alert-info"><strong>Note:</strong> 
      Depending on your hardware configuration or type of file system, you may
      need to set the option <code class="option">boot.initrd.kernelModules</code> to
      include the kernel modules that are necessary for mounting the root file
      system, otherwise the installed system will not be able to boot. (If this
      happens, boot from the installation media again, mount the target file
      system on <code class="filename">/mnt</code>, fix
      <code class="filename">/mnt/etc/nixos/configuration.nix</code> and rerun
      <code class="filename">nixos-install</code>.) In most cases,
      <span class="command"><strong>nixos-generate-config</strong></span> will figure out the required
      modules.
     </div></li><li class="listitem"><p>
     Do the installation:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-install</span></span></pre><p>
     This will install your system based on the configuration you provided.
     If anything fails due to a configuration problem or any other issue
     (such as a network outage while downloading binaries from the NixOS
     binary cache), you can re-run <span class="command"><strong>nixos-install</strong></span> after
     fixing your <code class="filename">configuration.nix</code>.
    </p><p>
     As the last step, <span class="command"><strong>nixos-install</strong></span> will ask you to set the
     password for the <code class="literal">root</code> user, e.g.
</p><pre class="screen hljs" xml:space="preserve">setting root password...
Enter new UNIX password: ***
Retype new UNIX password: ***</pre><p>
     </p><div class="alert alert-info"><strong>Note:</strong> 
       For unattended installations, it is possible to use
       <span class="command"><strong>nixos-install --no-root-passwd</strong></span> in order to disable
       the password prompt entirely.
      </div><p>
    </p></li><li class="listitem"><p>
     If everything went well:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">reboot</span></span></pre><p>
    </p></li><li class="listitem"><p>
     You should now be able to boot into the installed NixOS. The GRUB boot
     menu shows a list of <span class="emphasis"><em>available configurations</em></span>
     (initially just one). Every time you change the NixOS configuration (see
     <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#sec-changing-config" title="Chapter 3. Changing the Configuration" shape="rect">Changing Configuration</a>
     ), a new item is added to the menu. This allows you to easily roll back to
     a previous configuration if something goes wrong.
    </p><p>
     You should log in and change the <code class="literal">root</code> password with
     <span class="command"><strong>passwd</strong></span>.
    </p><p>
     You’ll probably want to create some user accounts as well, which can be
     done with <span class="command"><strong>useradd</strong></span>:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>useradd -c <span class="hljs-string"><span class="hljs-string">'Eelco Dolstra'</span></span> -m eelco
<code class="prompt">$ </code>passwd eelco</pre><p>
    </p><p>
     You may also want to install some software. For instance,
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-env -qaP \*</pre><p>
     shows what packages are available, and
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>nix-env -f <span class="hljs-string"><span class="hljs-string">'&lt;nixpkgs&gt;'</span></span> -iA w3m</pre><p>
     installs the <code class="literal">w3m</code> browser.
    </p></li></ol></div></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-installation-summary" class="title" style="clear: both">2.4.&nbsp;Installation summary<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-installation-summary" aria-label="Anchor link for: sec installation summary" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   To summarise, <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-install-sequence" title="Example 2.3. Commands for Installing NixOS on /dev/sda" shape="rect">Example&nbsp;2.3, “Commands for Installing NixOS on <code class="filename">/dev/sda</code>”</a> shows a typical
   sequence of commands for installing NixOS on an empty hard drive (here
   <code class="filename">/dev/sda</code>). <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-config" title="Example 2.4. NixOS Configuration" shape="rect">Example&nbsp;2.4, “NixOS Configuration”</a> shows a
   corresponding configuration Nix expression.
  </p><div class="example"><a id="ex-partition-scheme-MBR" shape="rect"></a><p class="title"><strong>Example&nbsp;2.1.&nbsp;Example partition schemes for NixOS on <code class="filename">/dev/sda</code> (MBR)</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mklabel msdos</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mkpart primary 1MiB -8GiB</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mkpart primary linux-swap -8GiB 100%</span></span></pre></div></div><br class="example-break" clear="none"><br><div class="example"><a id="ex-partition-scheme-UEFI" shape="rect"></a><p class="title"><strong>Example&nbsp;2.2.&nbsp;Example partition schemes for NixOS on <code class="filename">/dev/sda</code> (UEFI)</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mklabel gpt</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mkpart primary 512MiB -8GiB</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mkpart primary linux-swap -8GiB 100%</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- mkpart ESP fat32 1MiB 512MiB</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">parted /dev/sda -- set 3 esp on</span></span></pre></div></div><br class="example-break" clear="none"><br><div class="example"><a id="ex-install-sequence" shape="rect"></a><p class="title"><strong>Example&nbsp;2.3.&nbsp;Commands for Installing NixOS on <code class="filename">/dev/sda</code></strong></p><div class="example-contents"><p>
    With a partitioned disk.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mkfs.ext4 -L nixos /dev/sda1</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mkswap -L swap /dev/sda2</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">swapon /dev/sda2</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mkfs.fat -F 32 -n boot /dev/sda3        # </span></span><em class="lineannotation"><span class="lineannotation"><span class="hljs-comment"><span class="hljs-comment">(for UEFI systems only)</span></span></span></em>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mount /dev/disk/by-label/nixos /mnt</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mkdir -p /mnt/boot                      # </span></span><em class="lineannotation"><span class="lineannotation"><span class="hljs-comment"><span class="hljs-comment">(for UEFI systems only)</span></span></span></em>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mount /dev/disk/by-label/boot /mnt/boot # </span></span><em class="lineannotation"><span class="lineannotation"><span class="hljs-comment"><span class="hljs-comment">(for UEFI systems only)</span></span></span></em>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-generate-config --root /mnt</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nano /mnt/etc/nixos/configuration.nix</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-install</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">reboot</span></span></pre><p>
   </p></div></div><br class="example-break" clear="none"><br><div class="example"><a id="ex-config" shape="rect"></a><p class="title"><strong>Example&nbsp;2.4.&nbsp;NixOS Configuration</strong></p><div class="example-contents"><pre class="programlisting hljs nix" xml:space="preserve">{ config, pkgs, ... }: {
  <span class="hljs-attr"><span class="hljs-attr">imports</span></span> = [
    <span class="hljs-comment"><span class="hljs-comment"># Include the results of the hardware scan.</span></span>
    ./hardware-configuration.nix
  ];

  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.grub.device" shape="rect"><code class="option">boot.loader.grub.<span class="hljs-attr"><span class="hljs-attr">device</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"/dev/sda"</span></span>;   <span class="hljs-comment"><span class="hljs-comment"># </span></span><em class="lineannotation"><span class="lineannotation"><span class="hljs-comment"><span class="hljs-comment">(for BIOS systems only)</span></span></span></em>
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.systemd-boot.enable" shape="rect"><code class="option">boot.loader.systemd-boot.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment"># </span></span><em class="lineannotation"><span class="lineannotation"><span class="hljs-comment"><span class="hljs-comment">(for UEFI systems only)</span></span></span></em>

  <span class="hljs-comment"><span class="hljs-comment"># Note: setting fileSystems is generally not</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># necessary, since nixos-generate-config figures them out</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># automatically in hardware-configuration.nix.</span></span>
  <span class="hljs-comment"><span class="hljs-comment">#</span></span><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-fileSystems._name_.device" shape="rect"><span class="hljs-comment"><span class="hljs-comment">fileSystems."/".device</span></span></a><span class="hljs-comment"><span class="hljs-comment"> = "/dev/disk/by-label/nixos";</span></span>

  <span class="hljs-comment"><span class="hljs-comment"># Enable the OpenSSH server.</span></span>
  services.sshd.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
}
</pre></div></div><br class="example-break" clear="none"><br></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-installation-additional-notes" class="title" style="clear: both">2.5.&nbsp;Additional installation notes<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-installation-additional-notes" aria-label="Anchor link for: sec installation additional notes" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><section class="section"><div class="titlepage"><div><div><h3 id="sec-booting-from-usb" class="title">2.5.1.&nbsp;Booting from a USB Drive<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-booting-from-usb" aria-label="Anchor link for: sec booting from usb" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
  For systems without CD drive, the NixOS live CD can be booted from a USB
  stick. You can use the <span class="command"><strong>dd</strong></span> utility to write the image:
  <span class="command"><strong>dd if=<em class="replaceable"><code>path-to-image</code></em>
  of=<em class="replaceable"><code>/dev/sdX</code></em></strong></span>. Be careful about specifying
  the correct drive; you can use the <span class="command"><strong>lsblk</strong></span> command to get a
  list of block devices.
  </p><div class="note"><h3 class="title" id="on-macos">On macOS<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#on-macos" aria-label="Anchor link for: on macos" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3><p>
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>diskutil list
[..]
/dev/diskN (external, physical):
   <span class="hljs-comment"><span class="hljs-comment">#:                       TYPE NAME                    SIZE       IDENTIFIER</span></span>
[..]
<code class="prompt">$ </code>diskutil unmountDisk diskN
Unmount of all volumes on diskN was successful
<code class="prompt">$ </code>sudo dd <span class="hljs-attr"><span class="hljs-attr">if=nix.iso</span></span> <span class="hljs-attr"><span class="hljs-attr">of=/dev/rdiskN</span></span>
</pre><p>
    Using the 'raw' <span class="command"><strong>rdiskN</strong></span> device instead of
    <span class="command"><strong>diskN</strong></span> completes in minutes instead of hours. After
    <span class="command"><strong>dd</strong></span> completes, a GUI dialog "The disk you inserted was
    not readable by this computer" will pop up, which can be ignored.
   </p></div><p>
 </p><p>
  The <span class="command"><strong>dd</strong></span> utility will write the image verbatim to the drive,
  making it the recommended option for both UEFI and non-UEFI installations.
 </p></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-booting-from-pxe" class="title">2.5.2.&nbsp;Booting from the <span class="quote">“<span class="quote">netboot</span>”</span> media (PXE)<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-booting-from-pxe" aria-label="Anchor link for: sec booting from pxe" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
  Advanced users may wish to install NixOS using an existing PXE or iPXE setup.
 </p><p>
  These instructions assume that you have an existing PXE or iPXE
  infrastructure and simply want to add the NixOS installer as another option.
  To build the necessary files from a recent version of nixpkgs, you can run:
 </p><pre class="programlisting hljs" xml:space="preserve">nix-build -A netboot.x86_64-linux nixos/release.nix
</pre><p>
  This will create a <code class="literal">result</code> directory containing: *
  <code class="literal">bzImage</code> – the Linux kernel * <code class="literal">initrd</code>
  – the initrd file * <code class="literal">netboot.ipxe</code> – an example ipxe
  script demonstrating the appropriate kernel command line arguments for this
  image
 </p><p>
  If you’re using plain PXE, configure your boot loader to use the
  <code class="literal">bzImage</code> and <code class="literal">initrd</code> files and have it
  provide the same kernel command line arguments found in
  <code class="literal">netboot.ipxe</code>.
 </p><p>
  If you’re using iPXE, depending on how your HTTP/FTP/etc. server is
  configured you may be able to use <code class="literal">netboot.ipxe</code> unmodified,
  or you may need to update the paths to the files to match your server’s
  directory layout
 </p><p>
  In the future we may begin making these files available as build products
  from hydra at which point we will update this documentation with instructions
  on how to obtain them either for placing on a dedicated TFTP server or to
  boot them directly over the internet.
 </p></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-instaling-virtualbox-guest" class="title">2.5.3.&nbsp;Installing in a VirtualBox guest<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-instaling-virtualbox-guest" aria-label="Anchor link for: sec instaling virtualbox guest" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
  Installing NixOS into a VirtualBox guest is convenient for users who want to
  try NixOS without installing it on bare metal. If you want to use a pre-made
  VirtualBox appliance, it is available at
  <a class="link" href="https://nixos.org/nixos/download.html" target="_top" shape="rect">the downloads
  page</a>. If you want to set up a VirtualBox guest manually, follow these
  instructions:
 </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
    Add a New Machine in VirtualBox with OS Type "Linux / Other Linux"
   </p></li><li class="listitem"><p>
    Base Memory Size: 768 MB or higher.
   </p></li><li class="listitem"><p>
    New Hard Disk of 8 GB or higher.
   </p></li><li class="listitem"><p>
    Mount the CD-ROM with the NixOS ISO (by clicking on CD/DVD-ROM)
   </p></li><li class="listitem"><p>
    Click on Settings / System / Processor and enable PAE/NX
   </p></li><li class="listitem"><p>
    Click on Settings / System / Acceleration and enable "VT-x/AMD-V"
    acceleration
   </p></li><li class="listitem"><p>
    Click on Settings / Display / Screen and select VMSVGA as Graphics Controller
   </p></li><li class="listitem"><p>
    Save the settings, start the virtual machine, and continue installation
    like normal
   </p></li></ol></div><p>
  There are a few modifications you should make in configuration.nix. Enable
  booting:
 </p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.grub.device" shape="rect"><code class="option">boot.loader.grub.<span class="hljs-attr"><span class="hljs-attr">device</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"/dev/sda"</span></span>;
</pre><p>
  Also remove the fsck that runs at startup. It will always fail to run,
  stopping your boot until you press <code class="literal">*</code>.
 </p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.initrd.checkJournalingFS" shape="rect"><code class="option">boot.initrd.<span class="hljs-attr"><span class="hljs-attr">checkJournalingFS</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
</pre><p>
  Shared folders can be given a name and a path in the host system in the
  VirtualBox settings (Machine / Settings / Shared Folders, then click on the
  "Add" icon). Add the following to the
  <code class="literal">/etc/nixos/configuration.nix</code> to auto-mount them. If you do
  not add <code class="literal">"nofail"</code>, the system will no boot properly. The
  same goes for disabling <code class="literal">rngd</code> which is normally used to get
  randomness but this does not work in virtual machines.
 </p><pre class="programlisting hljs nix" xml:space="preserve">{ config, pkgs, ...} :
{
  security.rngd.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; // otherwise vm will not boot
  ...

  fileSystems.<span class="hljs-string"><span class="hljs-string">"/virtualboxshare"</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">fsType</span></span> = <span class="hljs-string"><span class="hljs-string">"vboxsf"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">device</span></span> = <span class="hljs-string"><span class="hljs-string">"nameofthesharedfolder"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">options</span></span> = [ <span class="hljs-string"><span class="hljs-string">"rw"</span></span> <span class="hljs-string"><span class="hljs-string">"nofail"</span></span> ];
  };
}
</pre><p>
  The folder will be available directly under the root directory.
 </p></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-installing-from-other-distro" class="title">2.5.4.&nbsp;Installing from another Linux distribution<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-installing-from-other-distro" aria-label="Anchor link for: sec installing from other distro" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
  Because Nix (the package manager) &amp; Nixpkgs (the Nix packages collection)
  can both be installed on any (most?) Linux distributions, they can be used to
  install NixOS in various creative ways. You can, for instance:
 </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
    Install NixOS on another partition, from your existing Linux distribution
    (without the use of a USB or optical device!)
   </p></li><li class="listitem"><p>
    Install NixOS on the same partition (in place!), from your existing
    non-NixOS Linux distribution using <code class="literal">NIXOS_LUSTRATE</code>.
   </p></li><li class="listitem"><p>
    Install NixOS on your hard drive from the Live CD of any Linux
    distribution.
   </p></li></ol></div><p>
  The first steps to all these are the same:
 </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
    Install the Nix package manager:
   </p><p>
    Short version:
   </p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>curl -L https://nixos.org/nix/install | sh
<code class="prompt">$ </code>. <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/.nix-profile/etc/profile.d/nix.sh <span class="hljs-comment"><span class="hljs-comment"># …or open a fresh shell</span></span></pre><p>
    More details in the
    <a class="link" href="https://nixos.org/nix/manual/#chap-quick-start" target="_top" shape="rect">
    Nix manual</a>
   </p></li><li class="listitem"><p>
    Switch to the NixOS channel:
   </p><p>
    If you've just installed Nix on a non-NixOS distribution, you will be on
    the <code class="literal">nixpkgs</code> channel by default.
   </p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-channel --list
nixpkgs https://nixos.org/channels/nixpkgs-unstable</pre><p>
    As that channel gets released without running the NixOS tests, it will be
    safer to use the <code class="literal">nixos-*</code> channels instead:
   </p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-channel --add https://nixos.org/channels/nixos-<em class="replaceable"><code>version</code></em> nixpkgs</pre><p>
    You may want to throw in a <code class="literal">nix-channel --update</code> for good
    measure.
   </p></li><li class="listitem"><p>
    Install the NixOS installation tools:
   </p><p>
    You'll need <code class="literal">nixos-generate-config</code> and
    <code class="literal">nixos-install</code> and we'll throw in some man pages and
    <code class="literal">nixos-enter</code> just in case you want to chroot into your
    NixOS partition. They are installed by default on NixOS, but you don't have
    NixOS yet..
   </p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>nix-env -f <span class="hljs-string"><span class="hljs-string">'&lt;nixpkgs/nixos&gt;'</span></span> --arg configuration {} -iA config.system.build.{nixos-generate-config,nixos-install,nixos-enter,manual.manpages}</pre></li><li class="listitem"><div class="alert alert-info"><strong>Note:</strong> 
     The following 5 steps are only for installing NixOS to another partition.
     For installing NixOS in place using <code class="literal">NIXOS_LUSTRATE</code>,
     skip ahead.
    </div><p>
    Prepare your target partition:
   </p><p>
    At this point it is time to prepare your target partition. Please refer to
    the partitioning, file-system creation, and mounting steps of
    <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-installation" title="Chapter 2. Installing NixOS" shape="rect">Chapter&nbsp;2, <em>Installing NixOS</em></a>
   </p><p>
    If you're about to install NixOS in place using
    <code class="literal">NIXOS_LUSTRATE</code> there is nothing to do for this step.
   </p></li><li class="listitem"><p>
    Generate your NixOS configuration:
   </p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>sudo `<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> nixos-generate-config` --root /mnt</pre><p>
    You'll probably want to edit the configuration files. Refer to the
    <code class="literal">nixos-generate-config</code> step in
    <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-installation" title="Chapter 2. Installing NixOS" shape="rect">Chapter&nbsp;2, <em>Installing NixOS</em></a> for more
    information.
   </p><p>
    Consider setting up the NixOS bootloader to give you the ability to boot on
    your existing Linux partition. For instance, if you're using GRUB and your
    existing distribution is running Ubuntu, you may want to add something like
    this to your <code class="literal">configuration.nix</code>:
   </p><pre class="programlisting hljs bash" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.grub.extraEntries" shape="rect"><code class="option">boot.loader.grub.extraEntries</code></a> = <span class="hljs-string"><span class="hljs-string">''</span></span>
  menuentry <span class="hljs-string"><span class="hljs-string">"Ubuntu"</span></span> {
    search --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>=ubuntu --fs-uuid 3cc3e652-0c1f-4800-8451-033754f68e6e
    configfile <span class="hljs-string"><span class="hljs-string">"(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ubuntu</span></span></span><span class="hljs-string">)/boot/grub/grub.cfg"</span></span>
  }
<span class="hljs-string"><span class="hljs-string">''</span></span>;</pre><p>
    (You can find the appropriate UUID for your partition in
    <code class="literal">/dev/disk/by-uuid</code>)
   </p></li><li class="listitem"><p>
    Create the <code class="literal">nixbld</code> group and user on your original
    distribution:
   </p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>sudo groupadd -g 30000 nixbld
<code class="prompt">$ </code>sudo useradd -u 30000 -g nixbld -G nixbld nixbld</pre></li><li class="listitem"><p>
    Download/build/install NixOS:
   </p><div class="alert alert-warning"><strong>Warning:</strong> 
     Once you complete this step, you might no longer be able to boot on
     existing systems without the help of a rescue USB drive or similar.
    </div><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>sudo PATH=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PATH</span></span></span><span class="hljs-string">"</span></span> NIX_PATH=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NIX_PATH</span></span></span><span class="hljs-string">"</span></span> `<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> nixos-install` --root /mnt</pre><p>
    Again, please refer to the <code class="literal">nixos-install</code> step in
    <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-installation" title="Chapter 2. Installing NixOS" shape="rect">Chapter&nbsp;2, <em>Installing NixOS</em></a> for more information.
   </p><p>
    That should be it for installation to another partition!
   </p></li><li class="listitem"><p>
    Optionally, you may want to clean up your non-NixOS distribution:
   </p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>sudo userdel nixbld
<code class="prompt">$ </code>sudo groupdel nixbld</pre><p>
    If you do not wish to keep the Nix package manager installed either, run
    something like <code class="literal">sudo rm -rv ~/.nix-* /nix</code> and remove the
    line that the Nix installer added to your <code class="literal">~/.profile</code>.
   </p></li><li class="listitem"><div class="alert alert-info"><strong>Note:</strong> 
     The following steps are only for installing NixOS in place using
     <code class="literal">NIXOS_LUSTRATE</code>:
    </div><p>
    Generate your NixOS configuration:
   </p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>sudo `<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> nixos-generate-config` --root /</pre><p>
    Note that this will place the generated configuration files in
    <code class="literal">/etc/nixos</code>. You'll probably want to edit the
    configuration files. Refer to the <code class="literal">nixos-generate-config</code>
    step in <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-installation" title="Chapter 2. Installing NixOS" shape="rect">Chapter&nbsp;2, <em>Installing NixOS</em></a> for more
    information.
   </p><p>
    You'll likely want to set a root password for your first boot using the
    configuration files because you won't have a chance to enter a password
    until after you reboot. You can initalize the root password to an empty one
    with this line: (and of course don't forget to set one once you've rebooted
    or to lock the account with <code class="literal">sudo passwd -l root</code> if you
    use <code class="literal">sudo</code>)
   </p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users._name_.initialHashedPassword" shape="rect">users.users.root.<span class="hljs-attr"><span class="hljs-attr">initialHashedPassword</span></span></a> = <span class="hljs-string"><span class="hljs-string">""</span></span>;
</pre></li><li class="listitem"><p>
    Build the NixOS closure and install it in the <code class="literal">system</code>
    profile:
   </p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>nix-env -p /nix/var/nix/profiles/system -f '&lt;nixpkgs/nixos&gt;' -I <span class="hljs-attr"><span class="hljs-attr">nixos-config=/etc/nixos/configuration.nix</span></span> -iA system</pre></li><li class="listitem"><p>
    Change ownership of the <code class="literal">/nix</code> tree to root (since your
    Nix install was probably single user):
   </p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>sudo chown -R 0.0 /nix</pre></li><li class="listitem"><p>
    Set up the <code class="literal">/etc/NIXOS</code> and
    <code class="literal">/etc/NIXOS_LUSTRATE</code> files:
   </p><p>
    <code class="literal">/etc/NIXOS</code> officializes that this is now a NixOS
    partition (the bootup scripts require its presence).
   </p><p>
    <code class="literal">/etc/NIXOS_LUSTRATE</code> tells the NixOS bootup scripts to
    move <span class="emphasis"><em>everything</em></span> that's in the root partition to
    <code class="literal">/old-root</code>. This will move your existing distribution out
    of the way in the very early stages of the NixOS bootup. There are
    exceptions (we do need to keep NixOS there after all), so the NixOS
    lustrate process will not touch:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      The <code class="literal">/nix</code> directory
     </p></li><li class="listitem"><p>
      The <code class="literal">/boot</code> directory
     </p></li><li class="listitem"><p>
      Any file or directory listed in <code class="literal">/etc/NIXOS_LUSTRATE</code>
      (one per line)
     </p></li></ul></div><div class="note"><h3 class="title" id="note">Note<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#note" aria-label="Anchor link for: note" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3><p>
     Support for <code class="literal">NIXOS_LUSTRATE</code> was added in NixOS 16.09.
     The act of "lustrating" refers to the wiping of the existing distribution.
     Creating <code class="literal">/etc/NIXOS_LUSTRATE</code> can also be used on NixOS
     to remove all mutable files from your root partition (anything that's not
     in <code class="literal">/nix</code> or <code class="literal">/boot</code> gets "lustrated" on
     the next boot.
    </p><p>
     lustrate /ˈlʌstreɪt/ verb.
    </p><p>
     purify by expiatory sacrifice, ceremonial washing, or some other ritual
     action.
    </p></div><p>
    Let's create the files:
   </p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>sudo touch /etc/NIXOS
<code class="prompt">$ </code>sudo touch /etc/NIXOS_LUSTRATE
</pre><p>
    Let's also make sure the NixOS configuration files are kept once we reboot
    on NixOS:
   </p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> etc/nixos | sudo tee -a /etc/NIXOS_LUSTRATE
</pre></li><li class="listitem"><p>
    Finally, move the <code class="literal">/boot</code> directory of your current
    distribution out of the way (the lustrate process will take care of the
    rest once you reboot, but this one must be moved out now because NixOS
    needs to install its own boot files:
   </p><div class="alert alert-warning"><strong>Warning:</strong> 
     Once you complete this step, your current distribution will no longer be
     bootable! If you didn't get all the NixOS configuration right, especially
     those settings pertaining to boot loading and root partition, NixOS may
     not be bootable either. Have a USB rescue device ready in case this
     happens.
    </div><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>sudo mv -v /boot /boot.bak &amp;&amp;
sudo /nix/var/nix/profiles/system/bin/switch-to-configuration boot
</pre><p>
    Cross your fingers, reboot, hopefully you should get a NixOS prompt!
   </p></li><li class="listitem"><p>
    If for some reason you want to revert to the old distribution, you'll need
    to boot on a USB rescue disk and do something along these lines:
   </p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mkdir root</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mount /dev/sdaX root</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mkdir root/nixos-root</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mv -v root/* root/nixos-root/</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mv -v root/nixos-root/old-root/* root/</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mv -v root/boot.bak root/boot  # We had renamed this by hand earlier</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">umount root</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">reboot</span></span></pre><p>
    This may work as is or you might also need to reinstall the boot loader
   </p><p>
    And of course, if you're happy with NixOS and no longer need the old
    distribution:
   </p><pre class="screen hljs" xml:space="preserve">sudo rm -rf /old-root</pre></li><li class="listitem"><p>
    It's also worth noting that this whole process can be automated. This is
    especially useful for Cloud VMs, where provider do not provide NixOS. For
    instance,
    <a class="link" href="https://github.com/elitak/nixos-infect" target="_top" shape="rect">nixos-infect</a>
    uses the lustrate process to convert Digital Ocean droplets to NixOS from
    other distributions automatically.
   </p></li></ol></div></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-installing-behind-proxy" class="title">2.5.5.&nbsp;Installing behind a proxy<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-installing-behind-proxy" aria-label="Anchor link for: sec installing behind proxy" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
  To install NixOS behind a proxy, do the following before running
  <code class="literal">nixos-install</code>.
 </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
    Update proxy configuration in
    <code class="literal">/mnt/etc/nixos/configuration.nix</code> to keep the internet
    accessible after reboot.
   </p><pre class="programlisting hljs nix" xml:space="preserve">networking.proxy.<span class="hljs-attr"><span class="hljs-attr">default</span></span> = <span class="hljs-string"><span class="hljs-string">"http://user:password@proxy:port/"</span></span>;
networking.proxy.<span class="hljs-attr"><span class="hljs-attr">noProxy</span></span> = <span class="hljs-string"><span class="hljs-string">"127.0.0.1,localhost,internal.domain"</span></span>;
</pre></li><li class="listitem"><p>
    Setup the proxy environment variables in the shell where you are running
    <code class="literal">nixos-install</code>.
   </p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">proxy_url="http://user:password@proxy:port/"</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">export http_proxy="$proxy_url"</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">export HTTP_PROXY="$proxy_url"</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">export https_proxy="$proxy_url"</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">export HTTPS_PROXY="$proxy_url"</span></span>
</pre></li></ol></div><div class="alert alert-info"><strong>Note:</strong> 
   If you are switching networks with different proxy configurations, use the
   <code class="literal">specialisation</code> option in
   <code class="literal">configuration.nix</code> to switch proxies at runtime. Refer to
   <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html" title="Appendix A. Configuration Options" shape="rect">Appendix&nbsp;A, <em>Configuration Options</em></a> for more information.
  </div></section></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-changing-config" class="title">Chapter&nbsp;3.&nbsp;Changing the Configuration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-changing-config" aria-label="Anchor link for: sec changing config" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  The file <code class="filename">/etc/nixos/configuration.nix</code> contains the
  current configuration of your machine. Whenever you’ve
  <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#ch-configuration" title="Part II. Configuration" shape="rect">changed something</a> in that file, you
  should do
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-rebuild switch</span></span>
</pre><p>
  to build the new configuration, make it the default configuration for
  booting, and try to realise the configuration in the running system (e.g., by
  restarting system services).
  </p><div class="alert alert-warning"><strong>Warning:</strong> 
    This command doesn't start/stop <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-systemd.user.services" shape="rect">user
    services</a> automatically. <span class="command"><strong>nixos-rebuild</strong></span> only runs a
    <code class="literal">daemon-reload</code> for each user with running user services.
   </div><p>
 </p><div class="alert alert-warning"><strong>Warning:</strong> 
   These commands must be executed as root, so you should either run them from
   a root shell or by prefixing them with <code class="literal">sudo -i</code>.
  </div><p>
  You can also do
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-rebuild test</span></span>
</pre><p>
  to build the configuration and switch the running system to it, but without
  making it the boot default. So if (say) the configuration locks up your
  machine, you can just reboot to get back to a working configuration.
 </p><p>
  There is also
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-rebuild boot</span></span>
</pre><p>
  to build the configuration and make it the boot default, but not switch to it
  now (so it will only take effect after the next reboot).
 </p><p>
  You can make your configuration show up in a different submenu of the GRUB 2
  boot screen by giving it a different <span class="emphasis"><em>profile name</em></span>, e.g.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-rebuild switch -p test</span></span>
</pre><p>
  which causes the new configuration (and previous ones created using
  <code class="literal">-p test</code>) to show up in the GRUB submenu “NixOS - Profile
  'test'”. This can be useful to separate test configurations from
  “stable” configurations.
 </p><p>
  Finally, you can do
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nixos-rebuild build
</pre><p>
  to build the configuration but nothing more. This is useful to see whether
  everything compiles cleanly.
 </p><p>
  If you have a machine that supports hardware virtualisation, you can also
  test the new configuration in a sandbox by building and running a QEMU
  <span class="emphasis"><em>virtual machine</em></span> that contains the desired configuration.
  Just do
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nixos-rebuild build-vm
<code class="prompt">$ </code>./result/bin/run-*-vm
</pre><p>
  The VM does not have any data from your host system, so your existing user
  accounts and home directories will not be available unless you have set
  <code class="literal">mutableUsers = false</code>. Another way is to temporarily add
  the following to your configuration:
</p><pre class="screen hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users._name_.initialHashedPassword" shape="rect">users.users.your-user.<span class="hljs-attr"><span class="hljs-attr">initialHashedPassword</span></span></a> = <span class="hljs-string"><span class="hljs-string">"test"</span></span>;
</pre><p>
  <span class="emphasis"><em>Important:</em></span> delete the $hostname.qcow2 file if you have
  started the virtual machine at least once without the right users, otherwise
  the changes will not get picked up. You can forward ports on the host to the
  guest. For instance, the following will forward host port 2222 to guest port
  22 (SSH):
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code><span class="hljs-attr"><span class="hljs-attr">QEMU_NET_OPTS="hostfwd=tcp::2222-:22"</span></span> ./result/bin/run-*-vm
</pre><p>
  allowing you to log in via SSH (assuming you have set the appropriate
  passwords or SSH authorized keys):
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>ssh -p 2222 localhost
</pre><p>
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-upgrading" class="title">Chapter&nbsp;4.&nbsp;Upgrading NixOS<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-upgrading" aria-label="Anchor link for: sec upgrading" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-upgrading-automatic" shape="rect">4.1. Automatic Upgrades</a></span></dt></dl></div><p>
  The best way to keep your NixOS installation up to date is to use one of the
  NixOS <span class="emphasis"><em>channels</em></span>. A channel is a Nix mechanism for
  distributing Nix expressions and associated binaries. The NixOS channels are
  updated automatically from NixOS’s Git repository after certain tests have
  passed and all packages have been built. These channels are:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     <span class="emphasis"><em>Stable channels</em></span>, such as
     <code class="literal"><a class="literal" href="https://nixos.org/channels/nixos-20.09" target="_top" shape="rect">nixos-20.09</a></code>.
     These only get conservative bug fixes and package upgrades. For instance,
     a channel update may cause the Linux kernel on your system to be upgraded
     from 4.19.34 to 4.19.38 (a minor bug fix), but not from
     4.19.<em class="replaceable"><code>x</code></em> to 4.20.<em class="replaceable"><code>x</code></em> (a
     major change that has the potential to break things). Stable channels are
     generally maintained until the next stable branch is created.
    </p><p></p></li><li class="listitem"><p>
     The <span class="emphasis"><em>unstable channel</em></span>,
     <code class="literal"><a class="literal" href="https://nixos.org/channels/nixos-unstable" target="_top" shape="rect">nixos-unstable</a></code>.
     This corresponds to NixOS’s main development branch, and may thus see
     radical changes between channel updates. It’s not recommended for
     production systems.
    </p></li><li class="listitem"><p>
     <span class="emphasis"><em>Small channels</em></span>, such as
     <code class="literal"><a class="literal" href="https://nixos.org/channels/nixos-20.09-small" target="_top" shape="rect">nixos-20.09-small</a></code>
     or
     <code class="literal"><a class="literal" href="https://nixos.org/channels/nixos-unstable-small" target="_top" shape="rect">nixos-unstable-small</a></code>.
     These are identical to the stable and unstable channels described above,
     except that they contain fewer binary packages. This means they get
     updated faster than the regular channels (for instance, when a critical
     security patch is committed to NixOS’s source tree), but may require
     more packages to be built from source than usual. They’re mostly
     intended for server environments and as such contain few GUI applications.
    </p></li></ul></div><p>
  To see what channels are available, go to
  <a class="link" href="https://nixos.org/channels" target="_top" shape="rect">https://nixos.org/channels</a>. (Note that the URIs of the
  various channels redirect to a directory that contains the channel’s latest
  version and includes ISO images and VirtualBox appliances.) Please note that
  during the release process, channels that are not yet released will be
  present here as well. See the Getting NixOS page
  <a class="link" href="https://nixos.org/nixos/download.html" target="_top" shape="rect">https://nixos.org/nixos/download.html</a> to find the newest
  supported stable release.
 </p><p>
  When you first install NixOS, you’re automatically subscribed to the NixOS
  channel that corresponds to your installation source. For instance, if you
  installed from a 20.09 ISO, you will be subscribed to the
  <code class="literal">nixos-20.09</code> channel. To see which NixOS channel you’re
  subscribed to, run the following as root:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nix-channel --list | grep nixos</span></span>
nixos https://nixos.org/channels/nixos-unstable
</pre><p>
  To switch to a different NixOS channel, do
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nix-channel --add https://nixos.org/channels/</span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">channel-name</span></span></code></em><span class="hljs-comment"><span class="hljs-comment"> nixos</span></span>
</pre><p>
  (Be sure to include the <code class="literal">nixos</code> parameter at the end.) For
  instance, to use the NixOS 20.09 stable channel:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nix-channel --add https://nixos.org/channels/nixos-20.09 nixos</span></span>
</pre><p>
  If you have a server, you may want to use the “small” channel instead:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nix-channel --add https://nixos.org/channels/nixos-20.09-small nixos</span></span>
</pre><p>
  And if you want to live on the bleeding edge:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nix-channel --add https://nixos.org/channels/nixos-unstable nixos</span></span>
</pre><p>
 </p><p>
  You can then upgrade NixOS to the latest version in your chosen channel by
  running
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-rebuild switch --upgrade</span></span>
</pre><p>
  which is equivalent to the more verbose <code class="literal">nix-channel --update nixos;
  nixos-rebuild switch</code>.
 </p><div class="alert alert-info"><strong>Note:</strong> 
   Channels are set per user. This means that running <code class="literal"> nix-channel
   --add</code> as a non root user (or without sudo) will not affect
   configuration in <code class="literal">/etc/nixos/configuration.nix</code>
  </div><div class="alert alert-warning"><strong>Warning:</strong> 
   It is generally safe to switch back and forth between channels. The only
   exception is that a newer NixOS may also have a newer Nix version, which may
   involve an upgrade of Nix’s database schema. This cannot be undone easily,
   so in that case you will not be able to go back to your original channel.
  </div><section class="section"><div class="titlepage"><div><div><h2 id="sec-upgrading-automatic" class="title" style="clear: both">4.1.&nbsp;Automatic Upgrades<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-upgrading-automatic" aria-label="Anchor link for: sec upgrading automatic" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   You can keep a NixOS system up-to-date automatically by adding the following
   to <code class="filename">configuration.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-system.autoUpgrade.enable" shape="rect"><code class="option">system.autoUpgrade.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-system.autoUpgrade.allowReboot" shape="rect"><code class="option">system.autoUpgrade.<span class="hljs-attr"><span class="hljs-attr">allowReboot</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
   This enables a periodically executed systemd service named
   <code class="literal">nixos-upgrade.service</code>. If the <code class="literal">allowReboot</code>
   option is <code class="literal">false</code>, it runs <span class="command"><strong>nixos-rebuild switch
   --upgrade</strong></span> to upgrade NixOS to the latest version in the current
   channel. (To see when the service runs, see <span class="command"><strong>systemctl list-timers</strong></span>.)
   If <code class="literal">allowReboot</code> is <code class="literal">true</code>, then the
   system will automatically reboot if the new generation contains a different
   kernel, initrd or kernel modules.
   You can also specify a channel explicitly, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-system.autoUpgrade.channel" shape="rect"><code class="option">system.autoUpgrade.<span class="hljs-attr"><span class="hljs-attr">channel</span></span></code></a> = https://nixos.org/channels/nixos-<span class="hljs-number"><span class="hljs-number">20.09</span></span>;
</pre><p>
  </p></section></section></div><div class="part"><div class="titlepage"><div><div><div class="page-header"><h1 id="ch-configuration" class="title">Part&nbsp;II.&nbsp;Configuration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#ch-configuration" aria-label="Anchor link for: ch configuration" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h1></div></div></div></div><div class="partintro"><div></div><p>
   This chapter describes how to configure various aspects of a NixOS machine
   through the configuration file
   <code class="filename">/etc/nixos/configuration.nix</code>. As described in
   <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-changing-config" title="Chapter 3. Changing the Configuration" shape="rect">Chapter&nbsp;3, <em>Changing the Configuration</em></a>, changes to this file only take
   effect after you run <span class="command"><strong>nixos-rebuild</strong></span>.
  </p><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-configuration-syntax" shape="rect">5. Configuration Syntax</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-package-management" shape="rect">6. Package Management</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-user-management" shape="rect">7. User Management</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-file-systems" shape="rect">8. File Systems</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-x11" shape="rect">9. X Window System</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-gpu-accel" shape="rect">10. GPU acceleration</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-xfce" shape="rect">11. Xfce Desktop Environment</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-networking" shape="rect">12. Networking</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-kernel-config" shape="rect">13. Linux Kernel</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#chap-pantheon" shape="rect">14. Pantheon Desktop</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-matomo" shape="rect">15. Matomo</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-nextcloud" shape="rect">16. Nextcloud</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-jitsi-meet" shape="rect">17. Jitsi Meet</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-grocy" shape="rect">18. Grocy</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-networking-yggdrasil" shape="rect">19. Yggdrasil</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-prosody" shape="rect">20. Prosody</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-prometheus-exporters" shape="rect">21. Prometheus exporters</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-weechat" shape="rect">22. WeeChat</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-taskserver" shape="rect">23. Taskserver</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-matrix" shape="rect">24. Matrix</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-gitlab" shape="rect">25. Gitlab</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-mailman" shape="rect">26. Mailman</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#trezor" shape="rect">27. Trezor</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-emacs" shape="rect">28. Emacs</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-flatpak" shape="rect">29. Flatpak</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-postgresql" shape="rect">30. PostgreSQL</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-foundationdb" shape="rect">31. FoundationDB</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-borgbase" shape="rect">32. BorgBackup</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-hidepid" shape="rect">33. Hiding process information</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-security-acme" shape="rect">34. SSL/TLS Certificates with ACME</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-programs-zsh-ohmyzsh" shape="rect">35. Oh my ZSH</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-program-plotinus" shape="rect">36. Plotinus</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-programs-digitalbitbox" shape="rect">37. Digital Bitbox</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-input-methods" shape="rect">38. Input Methods</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-profiles" shape="rect">39. Profiles</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-kubernetes" shape="rect">40. Kubernetes</a></span></dt></dl></div></div><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-configuration-syntax" class="title">Chapter&nbsp;5.&nbsp;Configuration Syntax<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-configuration-syntax" aria-label="Anchor link for: sec configuration syntax" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-configuration-file" shape="rect">5.1. NixOS Configuration File</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-module-abstractions" shape="rect">5.2. Abstractions</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-modularity" shape="rect">5.3. Modularity</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-nix-syntax-summary" shape="rect">5.4. Syntax Summary</a></span></dt></dl></div><p>
  The NixOS configuration file
  <code class="filename">/etc/nixos/configuration.nix</code> is actually a <span class="emphasis"><em>Nix
  expression</em></span>, which is the Nix package manager’s purely functional
  language for describing how to build packages and configurations. This means
  you have all the expressive power of that language at your disposal,
  including the ability to abstract over common patterns, which is very useful
  when managing complex systems. The syntax and semantics of the Nix language
  are fully described in the
  <a class="link" href="https://nixos.org/nix/manual/#chap-writing-nix-expressions" target="_top" shape="rect">Nix
  manual</a>, but here we give a short overview of the most important
  constructs useful in NixOS configuration files.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="sec-configuration-file" class="title" style="clear: both">5.1.&nbsp;NixOS Configuration File<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-configuration-file" aria-label="Anchor link for: sec configuration file" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  The NixOS configuration file generally looks like this:
</p><pre class="programlisting hljs" xml:space="preserve">{ config, pkgs, ... }:

{ <em class="replaceable"><code>option definitions</code></em>
}
</pre><p>
  The first line (<code class="literal">{ config, pkgs, ... }:</code>) denotes that this
  is actually a function that takes at least the two arguments
  <code class="varname">config</code> and <code class="varname">pkgs</code>. (These are explained
  later.) The function returns a <span class="emphasis"><em>set</em></span> of option definitions
  (<code class="literal">{ <em class="replaceable"><code>...</code></em> }</code>). These definitions
  have the form <code class="literal"><em class="replaceable"><code>name</code></em> =
  <em class="replaceable"><code>value</code></em></code>, where
  <em class="replaceable"><code>name</code></em> is the name of an option and
  <em class="replaceable"><code>value</code></em> is its value. For example,
</p><pre class="programlisting hljs nix" xml:space="preserve">{ config, pkgs, ... }:

{ <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.enable" shape="rect"><code class="option">services.httpd.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.adminAddr" shape="rect"><code class="option">services.httpd.<span class="hljs-attr"><span class="hljs-attr">adminAddr</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"alice@example.org"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.virtualHosts" shape="rect">services.httpd.virtualHosts.localhost.<span class="hljs-attr"><span class="hljs-attr">documentRoot</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/webroot"</span></span>;
}
</pre><p>
  defines a configuration with three option definitions that together enable
  the Apache HTTP Server with <code class="filename">/webroot</code> as the document
  root.
 </p><p>
  Sets can be nested, and in fact dots in option names are shorthand for
  defining a set containing another set. For instance,
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.enable" shape="rect"><code class="option">services.httpd.enable</code></a> defines a set named
  <code class="varname">services</code> that contains a set named
  <code class="varname">httpd</code>, which in turn contains an option definition named
  <code class="varname">enable</code> with value <code class="literal">true</code>. This means that
  the example above can also be written as:
</p><pre class="programlisting hljs nix" xml:space="preserve">{ config, pkgs, ... }:

{ <span class="hljs-attr"><span class="hljs-attr">services</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">httpd</span></span> = {
      <span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">adminAddr</span></span> = <span class="hljs-string"><span class="hljs-string">"alice@example.org"</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">virtualHosts</span></span> = {
        <span class="hljs-attr"><span class="hljs-attr">localhost</span></span> = {
          <span class="hljs-attr"><span class="hljs-attr">documentRoot</span></span> = <span class="hljs-string"><span class="hljs-string">"/webroot"</span></span>;
        };
      };
    };
  };
}
</pre><p>
  which may be more convenient if you have lots of option definitions that
  share the same prefix (such as <code class="literal">services.httpd</code>).
 </p><p>
  NixOS checks your option definitions for correctness. For instance, if you
  try to define an option that doesn’t exist (that is, doesn’t have a
  corresponding <span class="emphasis"><em>option declaration</em></span>),
  <span class="command"><strong>nixos-rebuild</strong></span> will give an error like:
</p><pre class="screen hljs nix" xml:space="preserve">The option `services.httpd.enable' defined <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> `/etc/nixos/configuration.nix' does not exist.
</pre><p>
  Likewise, values in option definitions must have a correct type. For
  instance, <code class="option">services.httpd.enable</code> must be a Boolean
  (<code class="literal">true</code> or <code class="literal">false</code>). Trying to give it a
  value of another type, such as a string, will cause an error:
</p><pre class="screen hljs nix" xml:space="preserve">The option value `services.httpd.enable' <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> `/etc/nixos/configuration.nix' is not a boolean.
</pre><p>
 </p><p>
  Options have various types of values. The most important are:
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     Strings
    </span></dt><dd><p>
      Strings are enclosed in double quotes, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.hostName" shape="rect"><code class="option">networking.<span class="hljs-attr"><span class="hljs-attr">hostName</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"dexter"</span></span>;
</pre><p>
      Special characters can be escaped by prefixing them with a backslash
      (e.g. <code class="literal">\"</code>).
     </p><p>
      Multi-line strings can be enclosed in <span class="emphasis"><em>double single
      quotes</em></span>, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.extraHosts" shape="rect"><code class="option">networking.<span class="hljs-attr"><span class="hljs-attr">extraHosts</span></span></code></a> =
  <span class="hljs-string"><span class="hljs-string">''
    127.0.0.2 other-localhost
    10.0.0.1 server
  ''</span></span>;
</pre><p>
      The main difference is that it strips from each line a number of spaces
      equal to the minimal indentation of the string as a whole (disregarding
      the indentation of empty lines), and that characters like
      <code class="literal">"</code> and <code class="literal">\</code> are not special (making it
      more convenient for including things like shell code). See more info
      about this in the Nix manual
      <a class="link" href="https://nixos.org/nix/manual/#ssec-values" target="_top" shape="rect">here</a>.
     </p></dd><dt><span class="term">
     Booleans
    </span></dt><dd><p>
      These can be <code class="literal">true</code> or <code class="literal">false</code>, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.firewall.enable" shape="rect"><code class="option">networking.firewall.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.firewall.allowPing" shape="rect"><code class="option">networking.firewall.<span class="hljs-attr"><span class="hljs-attr">allowPing</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
</pre><p>
     </p></dd><dt><span class="term">
     Integers
    </span></dt><dd><p>
      For example,
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.kernel.sysctl" shape="rect"><code class="option">boot.kernel.sysctl</code></a>.<span class="hljs-string"><span class="hljs-string">"net.ipv4.tcp_keepalive_time"</span></span> = <span class="hljs-number"><span class="hljs-number">60</span></span>;
</pre><p>
      (Note that here the attribute name
      <code class="literal">net.ipv4.tcp_keepalive_time</code> is enclosed in quotes to
      prevent it from being interpreted as a set named <code class="literal">net</code>
      containing a set named <code class="literal">ipv4</code>, and so on. This is
      because it’s not a NixOS option but the literal name of a Linux kernel
      setting.)
     </p></dd><dt><span class="term">
     Sets
    </span></dt><dd><p>
      Sets were introduced above. They are name/value pairs enclosed in braces,
      as in the option definition
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-fileSystems" shape="rect"><code class="option">fileSystems</code></a>.<span class="hljs-string"><span class="hljs-string">"/boot"</span></span> =
  { <span class="hljs-attr"><span class="hljs-attr">device</span></span> = <span class="hljs-string"><span class="hljs-string">"/dev/sda1"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">fsType</span></span> = <span class="hljs-string"><span class="hljs-string">"ext4"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">options</span></span> = [ <span class="hljs-string"><span class="hljs-string">"rw"</span></span> <span class="hljs-string"><span class="hljs-string">"data=ordered"</span></span> <span class="hljs-string"><span class="hljs-string">"relatime"</span></span> ];
  };
</pre><p>
     </p></dd><dt><span class="term">
     Lists
    </span></dt><dd><p>
      The important thing to note about lists is that list elements are
      separated by whitespace, like this:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.kernelModules" shape="rect"><code class="option">boot.<span class="hljs-attr"><span class="hljs-attr">kernelModules</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"fuse"</span></span> <span class="hljs-string"><span class="hljs-string">"kvm-intel"</span></span> <span class="hljs-string"><span class="hljs-string">"coretemp"</span></span> ];
</pre><p>
      List elements can be any other type, e.g. sets:
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-attr"><span class="hljs-attr">swapDevices</span></span> = [ { <span class="hljs-attr"><span class="hljs-attr">device</span></span> = <span class="hljs-string"><span class="hljs-string">"/dev/disk/by-label/swap"</span></span>; } ];
</pre><p>
     </p></dd><dt><span class="term">
     Packages
    </span></dt><dd><p>
      Usually, the packages you need are already part of the Nix Packages
      collection, which is a set that can be accessed through the function
      argument <code class="varname">pkgs</code>. Typical uses:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span></code></a> =
  [ pkgs.thunderbird
    pkgs.emacs
  ];

<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.package" shape="rect"><code class="option">services.postgresql.<span class="hljs-attr"><span class="hljs-attr">package</span></span></code></a> = pkgs.postgresql_10;
</pre><p>
      The latter option definition changes the default PostgreSQL package used
      by NixOS’s PostgreSQL service to 10.x. For more information on
      packages, including how to add new ones, see
      <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-custom-packages" title="6.1.2. Adding Custom Packages" shape="rect">Section&nbsp;6.1.2, “Adding Custom Packages”</a>.
     </p></dd></dl></div><p>
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-module-abstractions" class="title" style="clear: both">5.2.&nbsp;Abstractions<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-module-abstractions" aria-label="Anchor link for: sec module abstractions" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  If you find yourself repeating yourself over and over, it’s time to
  abstract. Take, for instance, this Apache HTTP Server configuration:
</p><pre class="programlisting hljs nix" xml:space="preserve">{
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.virtualHosts" shape="rect"><code class="option">services.httpd.<span class="hljs-attr"><span class="hljs-attr">virtualHosts</span></span></code></a> =
    { <span class="hljs-string"><span class="hljs-string">"blog.example.org"</span></span> = {
        <span class="hljs-attr"><span class="hljs-attr">documentRoot</span></span> = <span class="hljs-string"><span class="hljs-string">"/webroot/blog.example.org"</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">adminAddr</span></span> = <span class="hljs-string"><span class="hljs-string">"alice@example.org"</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">forceSSL</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">enableACME</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">enablePHP</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      };
      <span class="hljs-string"><span class="hljs-string">"wiki.example.org"</span></span> = {
        <span class="hljs-attr"><span class="hljs-attr">documentRoot</span></span> = <span class="hljs-string"><span class="hljs-string">"/webroot/wiki.example.org"</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">adminAddr</span></span> = <span class="hljs-string"><span class="hljs-string">"alice@example.org"</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">forceSSL</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">enableACME</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">enablePHP</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      };
    };
}
</pre><p>
  It defines two virtual hosts with nearly identical configuration; the only
  difference is the document root directories. To prevent this
  duplication, we can use a <code class="literal">let</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
  <span class="hljs-attr"><span class="hljs-attr">commonConfig</span></span> =
    { <span class="hljs-attr"><span class="hljs-attr">adminAddr</span></span> = <span class="hljs-string"><span class="hljs-string">"alice@example.org"</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">forceSSL</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">enableACME</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    };
<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>
{
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.virtualHosts" shape="rect"><code class="option">services.httpd.<span class="hljs-attr"><span class="hljs-attr">virtualHosts</span></span></code></a> =
    { <span class="hljs-string"><span class="hljs-string">"blog.example.org"</span></span> = (commonConfig // { <span class="hljs-attr"><span class="hljs-attr">documentRoot</span></span> = <span class="hljs-string"><span class="hljs-string">"/webroot/blog.example.org"</span></span>; });
      <span class="hljs-string"><span class="hljs-string">"wiki.example.org"</span></span> = (commonConfig // { <span class="hljs-attr"><span class="hljs-attr">documentRoot</span></span> = <span class="hljs-string"><span class="hljs-string">"/webroot/wiki.example.com"</span></span>; });
    };
}
</pre><p>
  The <code class="literal">let commonConfig = <em class="replaceable"><code>...</code></em></code>
  defines a variable named <code class="literal">commonConfig</code>. The
  <code class="literal">//</code> operator merges two attribute sets, so the
  configuration of the second virtual host is the set
  <code class="literal">commonConfig</code> extended with the document root option.
 </p><p>
  You can write a <code class="literal">let</code> wherever an expression is allowed.
  Thus, you also could have written:
</p><pre class="programlisting hljs nix" xml:space="preserve">{
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.virtualHosts" shape="rect"><code class="option">services.httpd.<span class="hljs-attr"><span class="hljs-attr">virtualHosts</span></span></code></a> =
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-attr"><span class="hljs-attr">commonConfig</span></span> = <em class="replaceable"><code>...</code></em>; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>
    { <span class="hljs-string"><span class="hljs-string">"blog.example.org"</span></span> = (commonConfig // { <em class="replaceable"><code>...</code></em> })
      <span class="hljs-string"><span class="hljs-string">"wiki.example.org"</span></span> = (commonConfig // { <em class="replaceable"><code>...</code></em> })
    };
}
</pre><p>
  but not <code class="literal">{ let commonConfig = <em class="replaceable"><code>...</code></em>; in
  <em class="replaceable"><code>...</code></em>; }</code> since attributes (as opposed to
  attribute values) are not expressions.
 </p><p>
  <span class="emphasis"><em>Functions</em></span> provide another method of abstraction. For
  instance, suppose that we want to generate lots of different virtual hosts,
  all with identical configuration except for the document root. This can be done
  as follows:
</p><pre class="programlisting hljs nix" xml:space="preserve">{
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.virtualHosts" shape="rect"><code class="option">services.httpd.<span class="hljs-attr"><span class="hljs-attr">virtualHosts</span></span></code></a> =
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
      <span class="hljs-attr"><span class="hljs-attr">makeVirtualHost</span></span> = webroot:
        { <span class="hljs-attr"><span class="hljs-attr">documentRoot</span></span> = webroot;
          <span class="hljs-attr"><span class="hljs-attr">adminAddr</span></span> = <span class="hljs-string"><span class="hljs-string">"alice@example.org"</span></span>;
          <span class="hljs-attr"><span class="hljs-attr">forceSSL</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
          <span class="hljs-attr"><span class="hljs-attr">enableACME</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
        };
    <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>
      { <span class="hljs-string"><span class="hljs-string">"example.org"</span></span> = (makeVirtualHost <span class="hljs-string"><span class="hljs-string">"/webroot/example.org"</span></span>);
        <span class="hljs-string"><span class="hljs-string">"example.com"</span></span> = (makeVirtualHost <span class="hljs-string"><span class="hljs-string">"/webroot/example.com"</span></span>);
        <span class="hljs-string"><span class="hljs-string">"example.gov"</span></span> = (makeVirtualHost <span class="hljs-string"><span class="hljs-string">"/webroot/example.gov"</span></span>);
        <span class="hljs-string"><span class="hljs-string">"example.nl"</span></span> = (makeVirtualHost <span class="hljs-string"><span class="hljs-string">"/webroot/example.nl"</span></span>);
      };
}
</pre><p>
  Here, <code class="varname">makeVirtualHost</code> is a function that takes a single
  argument <code class="literal">webroot</code> and returns the configuration for a virtual
  host. That function is then called for several names to produce the list of
  virtual host configurations.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-modularity" class="title" style="clear: both">5.3.&nbsp;Modularity<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-modularity" aria-label="Anchor link for: sec modularity" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  The NixOS configuration mechanism is modular. If your
  <code class="filename">configuration.nix</code> becomes too big, you can split it into
  multiple files. Likewise, if you have multiple NixOS configurations (e.g. for
  different computers) with some commonality, you can move the common
  configuration into a shared file.
 </p><p>
  Modules have exactly the same syntax as
  <code class="filename">configuration.nix</code>. In fact,
  <code class="filename">configuration.nix</code> is itself a module. You can use other
  modules by including them from <code class="filename">configuration.nix</code>, e.g.:
</p><pre class="programlisting hljs nix" xml:space="preserve">{ config, pkgs, ... }:

{ <span class="hljs-attr"><span class="hljs-attr">imports</span></span> = [ ./vpn.nix ./kde.nix ];
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.enable" shape="rect"><code class="option">services.httpd.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span></code></a> = [ pkgs.emacs ];
  <em class="replaceable"><code>...</code></em>
}
</pre><p>
  Here, we include two modules from the same directory,
  <code class="filename">vpn.nix</code> and <code class="filename">kde.nix</code>. The latter
  might look like this:
</p><pre class="programlisting hljs nix" xml:space="preserve">{ config, pkgs, ... }:

{ <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.enable" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.sddm.enable" shape="rect"><code class="option">services.xserver.displayManager.sddm.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.desktopManager.plasma5.enable" shape="rect"><code class="option">services.xserver.desktopManager.plasma5.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span></code></a> = [ pkgs.vim ];
}
</pre><p>
  Note that both <code class="filename">configuration.nix</code> and
  <code class="filename">kde.nix</code> define the option
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.systemPackages</code></a>. When multiple modules
  define an option, NixOS will try to <span class="emphasis"><em>merge</em></span> the
  definitions. In the case of <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.systemPackages</code></a>,
  that’s easy: the lists of packages can simply be concatenated. The value in
  <code class="filename">configuration.nix</code> is merged last, so for list-type
  options, it will appear at the end of the merged list. If you want it to
  appear first, you can use <code class="varname">mkBefore</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.kernelModules" shape="rect"><code class="option">boot.<span class="hljs-attr"><span class="hljs-attr">kernelModules</span></span></code></a> = mkBefore [ <span class="hljs-string"><span class="hljs-string">"kvm-intel"</span></span> ];
</pre><p>
  This causes the <code class="literal">kvm-intel</code> kernel module to be loaded
  before any other kernel modules.
 </p><p>
  For other types of options, a merge may not be possible. For instance, if two
  modules define <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.adminAddr" shape="rect"><code class="option">services.httpd.adminAddr</code></a>,
  <span class="command"><strong>nixos-rebuild</strong></span> will give an error:
</p><pre class="screen hljs nix" xml:space="preserve">The unique option `services.httpd.adminAddr' is defined multiple times, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> `/etc/nixos/httpd.nix' <span class="hljs-literal"><span class="hljs-literal">and</span></span> `/etc/nixos/configuration.nix'.
</pre><p>
  When that happens, it’s possible to force one definition take precedence
  over the others:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.adminAddr" shape="rect"><code class="option">services.httpd.<span class="hljs-attr"><span class="hljs-attr">adminAddr</span></span></code></a> = pkgs.lib.mkForce <span class="hljs-string"><span class="hljs-string">"bob@example.org"</span></span>;
</pre><p>
 </p><p>
  When using multiple modules, you may need to access configuration values
  defined in other modules. This is what the <code class="varname">config</code> function
  argument is for: it contains the complete, merged system configuration. That
  is, <code class="varname">config</code> is the result of combining the configurations
  returned by every module
  <a href="https://nixos.org/manual/nixos/stable/#ftn.footnote-nix-is-lazy" class="footnote" id="footnote-nix-is-lazy" shape="rect"><sup class="footnote">[1]</sup></a>
  . For example, here is a module that adds some packages to
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.systemPackages</code></a> only if
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.enable" shape="rect"><code class="option">services.xserver.enable</code></a> is set to
  <code class="literal">true</code> somewhere else:
</p><pre class="programlisting hljs nix" xml:space="preserve">{ config, pkgs, ... }:

{ <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span></code></a> =
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> config.<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.enable" shape="rect"><code class="option">services.xserver.enable</code></a> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
      [ pkgs.firefox
        pkgs.thunderbird
      ]
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
      [ ];
}
</pre><p>
 </p><p>
  With multiple modules, it may not be obvious what the final value of a
  configuration option is. The command <code class="option">nixos-option</code> allows you
  to find out:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>nixos-option <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.enable" shape="rect"><code class="option">services.xserver.enable</code></a>
<span class="hljs-literal"><span class="hljs-literal">true</span></span>

<code class="prompt">$ </code>nixos-option <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.kernelModules" shape="rect"><code class="option">boot.kernelModules</code></a>
[ <span class="hljs-string"><span class="hljs-string">"tun"</span></span> <span class="hljs-string"><span class="hljs-string">"ipv6"</span></span> <span class="hljs-string"><span class="hljs-string">"loop"</span></span> <em class="replaceable"><code>...</code></em> ]
</pre><p>
  Interactive exploration of the configuration is possible using <span class="command"><strong>nix
  repl</strong></span>, a read-eval-print loop for Nix expressions. A typical use:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>nix repl '&lt;nixpkgs/nixos&gt;'

<code class="prompt">nix-repl&gt; </code>config.<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.hostName" shape="rect"><code class="option">networking.hostName</code></a>
<span class="hljs-string"><span class="hljs-string">"mandark"</span></span>

<code class="prompt">nix-repl&gt; </code><span class="hljs-built_in"><span class="hljs-built_in">map</span></span> (x: x.hostName) config.<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.virtualHosts" shape="rect"><code class="option">services.httpd.virtualHosts</code></a>
[ <span class="hljs-string"><span class="hljs-string">"example.org"</span></span> <span class="hljs-string"><span class="hljs-string">"example.gov"</span></span> ]
</pre><p>
 </p><p>
  While abstracting your configuration, you may find it useful to generate
  modules using code, instead of writing files. The example below would have
  the same effect as importing a file which sets those options.
</p><pre class="programlisting hljs nix" xml:space="preserve">{ config, pkgs, ... }:

<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-attr"><span class="hljs-attr">netConfig</span></span> = { hostName }: {
  networking.<span class="hljs-attr"><span class="hljs-attr">hostName</span></span> = hostName;
  networking.<span class="hljs-attr"><span class="hljs-attr">useDHCP</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
};

<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>

{ <span class="hljs-attr"><span class="hljs-attr">imports</span></span> = [ (netConfig <span class="hljs-string"><span class="hljs-string">"nixos.localdomain"</span></span>) ]; }
</pre><p>
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-nix-syntax-summary" class="title" style="clear: both">5.4.&nbsp;Syntax Summary<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-nix-syntax-summary" aria-label="Anchor link for: sec nix syntax summary" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Below is a summary of the most important syntactic constructs in the Nix
  expression language. It’s not complete. In particular, there are many other
  built-in functions. See the
  <a class="link" href="https://nixos.org/nix/manual/#chap-writing-nix-expressions" target="_top" shape="rect">Nix
  manual</a> for the rest.
 </p><div class="informaltable"><table class="informaltable" border="0"><colgroup span="1"><col class="c1" span="1"><col class="c2" span="1"></colgroup><thead><tr><th rowspan="1" colspan="1">Example</th><th rowspan="1" colspan="1">Description</th></tr></thead><tbody><tr><td colspan="2" rowspan="1"><span class="emphasis"><em>Basic values</em></span>
     </td></tr><tr><td rowspan="1" colspan="1"><code class="literal">"Hello world"</code>
     </td><td rowspan="1" colspan="1">A string</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">"${pkgs.bash}/bin/sh"</code>
     </td><td rowspan="1" colspan="1">A string containing an expression (expands to <code class="literal">"/nix/store/<em class="replaceable"><code>hash</code></em>-bash-<em class="replaceable"><code>version</code></em>/bin/sh"</code>)</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">true</code>, <code class="literal">false</code>
     </td><td rowspan="1" colspan="1">Booleans</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">123</code>
     </td><td rowspan="1" colspan="1">An integer</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">./foo.png</code>
     </td><td rowspan="1" colspan="1">A path (relative to the containing Nix expression)</td></tr><tr><td colspan="2" rowspan="1"><span class="emphasis"><em>Compound values</em></span>
     </td></tr><tr><td rowspan="1" colspan="1"><code class="literal">{ x = 1; y = 2; }</code>
     </td><td rowspan="1" colspan="1">A set with attributes named <code class="literal">x</code> and <code class="literal">y</code>
     </td></tr><tr><td rowspan="1" colspan="1"><code class="literal">{ foo.bar = 1; }</code>
     </td><td rowspan="1" colspan="1">A nested set, equivalent to <code class="literal">{ foo = { bar = 1; }; }</code>
     </td></tr><tr><td rowspan="1" colspan="1"><code class="literal">rec { x = "foo"; y = x + "bar"; }</code>
     </td><td rowspan="1" colspan="1">A recursive set, equivalent to <code class="literal">{ x = "foo"; y = "foobar"; }</code>
     </td></tr><tr><td rowspan="1" colspan="1"><code class="literal">[ "foo" "bar" ]</code>
     </td><td rowspan="1" colspan="1">A list with two elements</td></tr><tr><td colspan="2" rowspan="1"><span class="emphasis"><em>Operators</em></span>
     </td></tr><tr><td rowspan="1" colspan="1"><code class="literal">"foo" + "bar"</code>
     </td><td rowspan="1" colspan="1">String concatenation</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">1 + 2</code>
     </td><td rowspan="1" colspan="1">Integer addition</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">"foo" == "f" + "oo"</code>
     </td><td rowspan="1" colspan="1">Equality test (evaluates to <code class="literal">true</code>)</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">"foo" != "bar"</code>
     </td><td rowspan="1" colspan="1">Inequality test (evaluates to <code class="literal">true</code>)</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">!true</code>
     </td><td rowspan="1" colspan="1">Boolean negation</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">{ x = 1; y = 2; }.x</code>
     </td><td rowspan="1" colspan="1">Attribute selection (evaluates to <code class="literal">1</code>)</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">{ x = 1; y = 2; }.z or 3</code>
     </td><td rowspan="1" colspan="1">Attribute selection with default (evaluates to <code class="literal">3</code>)</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">{ x = 1; y = 2; } // { z = 3; }</code>
     </td><td rowspan="1" colspan="1">Merge two sets (attributes in the right-hand set taking precedence)</td></tr><tr><td colspan="2" rowspan="1"><span class="emphasis"><em>Control structures</em></span>
     </td></tr><tr><td rowspan="1" colspan="1"><code class="literal">if 1 + 1 == 2 then "yes!" else "no!"</code>
     </td><td rowspan="1" colspan="1">Conditional expression</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">assert 1 + 1 == 2; "yes!"</code>
     </td><td rowspan="1" colspan="1">Assertion check (evaluates to <code class="literal">"yes!"</code>). See <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-assertions" title="50.4. Warnings and Assertions" shape="rect">Section&nbsp;50.4, “Warnings and Assertions”</a> for using assertions in modules</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">let x = "foo"; y = "bar"; in x + y</code>
     </td><td rowspan="1" colspan="1">Variable definition</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">with pkgs.lib; head [ 1 2 3 ]</code>
     </td><td rowspan="1" colspan="1">Add all attributes from the given set to the scope
        (evaluates to <code class="literal">1</code>)</td></tr><tr><td colspan="2" rowspan="1"><span class="emphasis"><em>Functions (lambdas)</em></span>
     </td></tr><tr><td rowspan="1" colspan="1"><code class="literal">x: x + 1</code>
     </td><td rowspan="1" colspan="1">A function that expects an integer and returns it increased by 1</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">(x: x + 1) 100</code>
     </td><td rowspan="1" colspan="1">A function call (evaluates to 101)</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">let inc = x: x + 1; in inc (inc (inc 100))</code>
     </td><td rowspan="1" colspan="1">A function bound to a variable and subsequently called by name (evaluates to 103)</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">{ x, y }: x + y</code>
     </td><td rowspan="1" colspan="1">A function that expects a set with required attributes
        <code class="literal">x</code> and <code class="literal">y</code> and concatenates
        them</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">{ x, y ? "bar" }: x + y</code>
     </td><td rowspan="1" colspan="1">A function that expects a set with required attribute
        <code class="literal">x</code> and optional <code class="literal">y</code>, using
        <code class="literal">"bar"</code> as default value for
        <code class="literal">y</code>
     </td></tr><tr><td rowspan="1" colspan="1"><code class="literal">{ x, y, ... }: x + y</code>
     </td><td rowspan="1" colspan="1">A function that expects a set with required attributes
        <code class="literal">x</code> and <code class="literal">y</code> and ignores any
        other attributes</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">{ x, y } @ args: x + y</code>
     </td><td rowspan="1" colspan="1">A function that expects a set with required attributes
        <code class="literal">x</code> and <code class="literal">y</code>, and binds the
        whole set to <code class="literal">args</code>
     </td></tr><tr><td colspan="2" rowspan="1"><span class="emphasis"><em>Built-in functions</em></span>
     </td></tr><tr><td rowspan="1" colspan="1"><code class="literal">import ./foo.nix</code>
     </td><td rowspan="1" colspan="1">Load and return Nix expression in given file</td></tr><tr><td rowspan="1" colspan="1"><code class="literal">map (x: x + x) [ 1 2 3 ]</code>
     </td><td rowspan="1" colspan="1">Apply a function to every element of a list (evaluates to <code class="literal">[ 2 4 6 ]</code>)</td></tr></tbody></table></div></section><div class="footnotes"><br clear="none"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.footnote-nix-is-lazy" class="footnote"><p><a href="https://nixos.org/manual/nixos/stable/#footnote-nix-is-lazy" class="para" shape="rect"><sup class="para">[1] </sup></a>
    If you’re wondering how it’s possible that the (indirect)
    <span class="emphasis"><em>result</em></span> of a function is passed as an
    <span class="emphasis"><em>input</em></span> to that same function: that’s because Nix is a
    “lazy” language — it only computes values when they are needed. This
    works as long as no individual configuration value depends on itself.
   </p></div></div></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-package-management" class="title">Chapter&nbsp;6.&nbsp;Package Management<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-package-management" aria-label="Anchor link for: sec package management" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-declarative-package-mgmt" shape="rect">6.1. Declarative Package Management</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-ad-hoc-packages" shape="rect">6.2. Ad-Hoc Package Management</a></span></dt></dl></div><p>
  This section describes how to add additional packages to your system. NixOS
  has two distinct styles of package management:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     <span class="emphasis"><em>Declarative</em></span>, where you declare what packages you want
     in your <code class="filename">configuration.nix</code>. Every time you run
     <span class="command"><strong>nixos-rebuild</strong></span>, NixOS will ensure that you get a
     consistent set of binaries corresponding to your specification.
    </p></li><li class="listitem"><p>
     <span class="emphasis"><em>Ad hoc</em></span>, where you install, upgrade and uninstall
     packages via the <span class="command"><strong>nix-env</strong></span> command. This style allows
     mixing packages from different Nixpkgs versions. It’s the only choice
     for non-root users.
    </p></li></ul></div><p>
 </p><section class="section"><div class="titlepage"><div><div><h2 id="sec-declarative-package-mgmt" class="title" style="clear: both">6.1.&nbsp;Declarative Package Management<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-declarative-package-mgmt" aria-label="Anchor link for: sec declarative package mgmt" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  With declarative package management, you specify which packages you want on
  your system by setting the option
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.systemPackages</code></a>. For instance, adding the
  following line to <code class="filename">configuration.nix</code> enables the Mozilla
  Thunderbird email application:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span></code></a> = [ pkgs.thunderbird ];
</pre><p>
  The effect of this specification is that the Thunderbird package from Nixpkgs
  will be built or downloaded as part of the system when you run
  <span class="command"><strong>nixos-rebuild switch</strong></span>.
 </p><div class="alert alert-info"><strong>Note:</strong> 
   Some packages require additional global configuration such as D-Bus or systemd service registration so adding them to <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.systemPackages</code></a> might not be sufficient. You are advised to check the <a class="link" href="https://nixos.org/manual/nixos/stable/options.html" title="Appendix A. Configuration Options" shape="rect">list of options</a> whether a NixOS module for the package does not exist.
  </div><p>
  You can get a list of the available packages as follows:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>nix-env -qaP <span class="hljs-string"><span class="hljs-string">'*'</span></span> --description
nixos.firefox   firefox-23.0   Mozilla Firefox - the browser, reloaded
<em class="replaceable"><code>...</code></em>
</pre><p>
  The first column in the output is the <span class="emphasis"><em>attribute name</em></span>,
  such as <code class="literal">nixos.thunderbird</code>.
 </p><p>
  Note: the <code class="literal">nixos</code> prefix tells us that we want to get the
  package from the <code class="literal">nixos</code> channel and works only in CLI tools.

  In declarative configuration use <code class="literal">pkgs</code> prefix (variable).
 </p><p>
  To “uninstall” a package, simply remove it from
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.systemPackages</code></a> and run
  <span class="command"><strong>nixos-rebuild switch</strong></span>.
 </p><section class="section"><div class="titlepage"><div><div><h3 id="sec-customising-packages" class="title">6.1.1.&nbsp;Customising Packages<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-customising-packages" aria-label="Anchor link for: sec customising packages" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
  Some packages in Nixpkgs have options to enable or disable optional
  functionality or change other aspects of the package. For instance, the
  Firefox wrapper package (which provides Firefox with a set of plugins such as
  the Adobe Flash player) has an option to enable the Google Talk plugin. It
  can be set in <code class="filename">configuration.nix</code> as follows: <code class="filename">
  nixpkgs.config.firefox.enableGoogleTalkPlugin = true; </code>
 </p><div class="alert alert-warning"><strong>Warning:</strong> 
   Unfortunately, Nixpkgs currently lacks a way to query available
   configuration options.
  </div><p>
  Apart from high-level options, it’s possible to tweak a package in almost
  arbitrary ways, such as changing or disabling dependencies of a package. For
  instance, the Emacs package in Nixpkgs by default has a dependency on GTK 2.
  If you want to build it against GTK 3, you can specify that as follows:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span></code></a> = [ (pkgs.emacs.override { <span class="hljs-attr"><span class="hljs-attr">gtk</span></span> = pkgs.gtk3; }) ];
</pre><p>
  The function <code class="varname">override</code> performs the call to the Nix
  function that produces Emacs, with the original arguments amended by the set
  of arguments specified by you. So here the function argument
  <code class="varname">gtk</code> gets the value <code class="literal">pkgs.gtk3</code>, causing
  Emacs to depend on GTK 3. (The parentheses are necessary because in Nix,
  function application binds more weakly than list construction, so without
  them, <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.systemPackages</code></a> would be a list with
  two elements.)
 </p><p>
  Even greater customisation is possible using the function
  <code class="varname">overrideAttrs</code>. While the <code class="varname">override</code>
  mechanism above overrides the arguments of a package function,
  <code class="varname">overrideAttrs</code> allows changing the
  <span class="emphasis"><em>attributes</em></span> passed to <code class="literal">mkDerivation</code>.
  This permits changing any aspect of the package, such as the source code. For
  instance, if you want to override the source code of Emacs, you can say:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span></code></a> = [
  (pkgs.emacs.overrideAttrs (oldAttrs: {
    <span class="hljs-attr"><span class="hljs-attr">name</span></span> = <span class="hljs-string"><span class="hljs-string">"emacs-25.0-pre"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">src</span></span> = /path/to/my/emacs/tree;
  }))
];
</pre><p>
  Here, <code class="varname">overrideAttrs</code> takes the Nix derivation specified by
  <code class="varname">pkgs.emacs</code> and produces a new derivation in which the
  original’s <code class="literal">name</code> and <code class="literal">src</code> attribute
  have been replaced by the given values by re-calling
  <code class="literal">stdenv.mkDerivation</code>. The original attributes are
  accessible via the function argument, which is conventionally named
  <code class="varname">oldAttrs</code>.
 </p><p>
  The overrides shown above are not global. They do not affect the original
  package; other packages in Nixpkgs continue to depend on the original rather
  than the customised package. This means that if another package in your
  system depends on the original package, you end up with two instances of the
  package. If you want to have everything depend on your customised instance,
  you can apply a <span class="emphasis"><em>global</em></span> override as follows:
</p><pre class="screen hljs nix" xml:space="preserve">nixpkgs.config.<span class="hljs-attr"><span class="hljs-attr">packageOverrides</span></span> = pkgs:
  { <span class="hljs-attr"><span class="hljs-attr">emacs</span></span> = pkgs.emacs.override { <span class="hljs-attr"><span class="hljs-attr">gtk</span></span> = pkgs.gtk3; };
  };
</pre><p>
  The effect of this definition is essentially equivalent to modifying the
  <code class="literal">emacs</code> attribute in the Nixpkgs source tree. Any package in
  Nixpkgs that depends on <code class="literal">emacs</code> will be passed your
  customised instance. (However, the value <code class="literal">pkgs.emacs</code> in
  <code class="varname">nixpkgs.config.packageOverrides</code> refers to the original
  rather than overridden instance, to prevent an infinite recursion.)
 </p></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-custom-packages" class="title">6.1.2.&nbsp;Adding Custom Packages<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-custom-packages" aria-label="Anchor link for: sec custom packages" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
  It’s possible that a package you need is not available in NixOS. In that
  case, you can do two things. First, you can clone the Nixpkgs repository, add
  the package to your clone, and (optionally) submit a patch or pull request to
  have it accepted into the main Nixpkgs repository. This is described in
  detail in the <a class="link" href="https://nixos.org/nixpkgs/manual" target="_top" shape="rect">Nixpkgs
  manual</a>. In short, you clone Nixpkgs:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/NixOS/nixpkgs
<code class="prompt">$ </code><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nixpkgs
</pre><p>
  Then you write and test the package as described in the Nixpkgs manual.
  Finally, you add it to <code class="literal">environment.systemPackages</code>, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span></code></a> = [ pkgs.my-package ];
</pre><p>
  and you run <span class="command"><strong>nixos-rebuild</strong></span>, specifying your own Nixpkgs
  tree:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-rebuild switch -I nixpkgs=/path/to/my/nixpkgs</span></span></pre><p>
 </p><p>
  The second possibility is to add the package outside of the Nixpkgs tree. For
  instance, here is how you specify a build of the
  <a class="link" href="https://www.gnu.org/software/hello/" target="_top" shape="rect">GNU Hello</a>
  package directly in <code class="filename">configuration.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span></code></a> =
  <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
    <span class="hljs-attr"><span class="hljs-attr">my-hello</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> pkgs; stdenv.mkDerivation <span class="hljs-keyword"><span class="hljs-keyword">rec</span></span> {
      <span class="hljs-attr"><span class="hljs-attr">name</span></span> = <span class="hljs-string"><span class="hljs-string">"hello-2.8"</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">src</span></span> = fetchurl {
        <span class="hljs-attr"><span class="hljs-attr">url</span></span> = <span class="hljs-string"><span class="hljs-string">"mirror://gnu/hello/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${name}</span></span></span><span class="hljs-string">.tar.gz"</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">sha256</span></span> = <span class="hljs-string"><span class="hljs-string">"0wqd8sjmxfskrflaxywc7gqw7sfawrfvdxd9skxawzfgyy0pzdz6"</span></span>;
      };
    };
  <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>
  [ my-hello ];
</pre><p>
  Of course, you can also move the definition of <code class="literal">my-hello</code>
  into a separate Nix expression, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span></code></a> = [ (<span class="hljs-built_in"><span class="hljs-built_in">import</span></span> ./my-hello.nix) ];
</pre><p>
  where <code class="filename">my-hello.nix</code> contains:
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-built_in"><span class="hljs-built_in">import</span></span> &lt;nixpkgs&gt; {}; <span class="hljs-comment"><span class="hljs-comment"># bring all of Nixpkgs into scope</span></span>

stdenv.mkDerivation <span class="hljs-keyword"><span class="hljs-keyword">rec</span></span> {
  <span class="hljs-attr"><span class="hljs-attr">name</span></span> = <span class="hljs-string"><span class="hljs-string">"hello-2.8"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">src</span></span> = fetchurl {
    <span class="hljs-attr"><span class="hljs-attr">url</span></span> = <span class="hljs-string"><span class="hljs-string">"mirror://gnu/hello/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${name}</span></span></span><span class="hljs-string">.tar.gz"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">sha256</span></span> = <span class="hljs-string"><span class="hljs-string">"0wqd8sjmxfskrflaxywc7gqw7sfawrfvdxd9skxawzfgyy0pzdz6"</span></span>;
  };
}
</pre><p>
  This allows testing the package easily:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-build my-hello.nix
<code class="prompt">$ </code>./result/bin/hello
Hello, world!
</pre><p>
 </p></section></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-ad-hoc-packages" class="title" style="clear: both">6.2.&nbsp;Ad-Hoc Package Management<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-ad-hoc-packages" aria-label="Anchor link for: sec ad hoc packages" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  With the command <span class="command"><strong>nix-env</strong></span>, you can install and uninstall
  packages from the command line. For instance, to install Mozilla Thunderbird:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-env -iA nixos.thunderbird</pre><p>
  If you invoke this as root, the package is installed in the Nix profile
  <code class="filename">/nix/var/nix/profiles/default</code> and visible to all users
  of the system; otherwise, the package ends up in
  <code class="filename">/nix/var/nix/profiles/per-user/<em class="replaceable"><code>username</code></em>/profile</code>
  and is not visible to other users. The <code class="option">-A</code> flag specifies the
  package by its attribute name; without it, the package is installed by
  matching against its package name (e.g. <code class="literal">thunderbird</code>). The
  latter is slower because it requires matching against all available Nix
  packages, and is ambiguous if there are multiple matching packages.
 </p><p>
  Packages come from the NixOS channel. You typically upgrade a package by
  updating to the latest version of the NixOS channel:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-channel --update nixos
</pre><p>
  and then running <code class="literal">nix-env -i</code> again. Other packages in the
  profile are <span class="emphasis"><em>not</em></span> affected; this is the crucial difference
  with the declarative style of package management, where running
  <span class="command"><strong>nixos-rebuild switch</strong></span> causes all packages to be updated to
  their current versions in the NixOS channel. You can however upgrade all
  packages for which there is a newer version by doing:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>nix-env -u <span class="hljs-string"><span class="hljs-string">'*'</span></span>
</pre><p>
 </p><p>
  A package can be uninstalled using the <code class="option">-e</code> flag:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-env -e thunderbird
</pre><p>
 </p><p>
  Finally, you can roll back an undesirable <span class="command"><strong>nix-env</strong></span> action:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-env --rollback
</pre><p>
 </p><p>
  <span class="command"><strong>nix-env</strong></span> has many more flags. For details, see the
  <span class="citerefentry"><span class="refentrytitle">nix-env</span>(1)</span> manpage or the Nix manual.
 </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-user-management" class="title">Chapter&nbsp;7.&nbsp;User Management<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-user-management" aria-label="Anchor link for: sec user management" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  NixOS supports both declarative and imperative styles of user management. In
  the declarative style, users are specified in
  <code class="filename">configuration.nix</code>. For instance, the following states
  that a user account named <code class="literal">alice</code> shall exist:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users" shape="rect"><code class="option">users.users</code></a>.<span class="hljs-attr"><span class="hljs-attr">alice</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users._name_.isNormalUser" shape="rect"><span class="hljs-attr"><span class="hljs-attr">isNormalUser</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users._name_.home" shape="rect"><span class="hljs-attr"><span class="hljs-attr">home</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/home/alice"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users._name_.description" shape="rect"><span class="hljs-attr"><span class="hljs-attr">description</span></span></a> = <span class="hljs-string"><span class="hljs-string">"Alice Foobar"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users._name_.extraGroups" shape="rect"><span class="hljs-attr"><span class="hljs-attr">extraGroups</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"wheel"</span></span> <span class="hljs-string"><span class="hljs-string">"networkmanager"</span></span> ];
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users._name_.openssh.authorizedKeys.keys" shape="rect">openssh.authorizedKeys.<span class="hljs-attr"><span class="hljs-attr">keys</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"ssh-dss AAAAB3Nza... alice@foobar"</span></span> ];
};
</pre><p>
  Note that <code class="literal">alice</code> is a member of the
  <code class="literal">wheel</code> and <code class="literal">networkmanager</code> groups, which
  allows her to use <span class="command"><strong>sudo</strong></span> to execute commands as
  <code class="literal">root</code> and to configure the network, respectively. Also note
  the SSH public key that allows remote logins with the corresponding private
  key. Users created in this way do not have a password by default, so they
  cannot log in via mechanisms that require a password. However, you can use
  the <span class="command"><strong>passwd</strong></span> program to set a password, which is retained
  across invocations of <span class="command"><strong>nixos-rebuild</strong></span>.
 </p><p>
  If you set <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.mutableUsers" shape="rect"><code class="option">users.mutableUsers</code></a> to false, then the
  contents of <code class="literal">/etc/passwd</code> and <code class="literal">/etc/group</code>
  will be congruent to your NixOS configuration. For instance, if you remove a
  user from <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users" shape="rect"><code class="option">users.users</code></a> and run nixos-rebuild, the user
  account will cease to exist. Also, imperative commands for managing users and
  groups, such as useradd, are no longer available. Passwords may still be
  assigned by setting the user's
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users._name_.hashedPassword" shape="rect">hashedPassword</a>
  option. A hashed password can be generated using <span class="command"><strong>mkpasswd -m
  sha-512</strong></span> after installing the <code class="literal">mkpasswd</code> package.
 </p><p>
  A user ID (uid) is assigned automatically. You can also specify a uid
  manually by adding
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-attr"><span class="hljs-attr">uid</span></span> = <span class="hljs-number"><span class="hljs-number">1000</span></span>;
</pre><p>
  to the user specification.
 </p><p>
  Groups can be specified similarly. The following states that a group named
  <code class="literal">students</code> shall exist:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.groups" shape="rect"><code class="option">users.groups</code></a>.students.<span class="hljs-attr"><span class="hljs-attr">gid</span></span> = <span class="hljs-number"><span class="hljs-number">1000</span></span>;
</pre><p>
  As with users, the group ID (gid) is optional and will be assigned
  automatically if it’s missing.
 </p><p>
  In the imperative style, users and groups are managed by commands such as
  <span class="command"><strong>useradd</strong></span>, <span class="command"><strong>groupmod</strong></span> and so on. For
  instance, to create a user account named <code class="literal">alice</code>:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">useradd -m </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">alice</span></span></code></em></pre><p>
  To make all nix tools available to this new user use `su - USER` which opens
  a login shell (==shell that loads the profile) for given user. This will
  create the ~/.nix-defexpr symlink. So run:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">su - </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">alice</span></span></code></em><span class="hljs-comment"><span class="hljs-comment"> -c "true"</span></span></pre><p>
  The flag <code class="option">-m</code> causes the creation of a home directory for the
  new user, which is generally what you want. The user does not have an initial
  password and therefore cannot log in. A password can be set using the
  <span class="command"><strong>passwd</strong></span> utility:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">passwd </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">alice</span></span></code></em>
Enter new UNIX password: ***
Retype new UNIX password: ***
</pre><p>
  A user can be deleted using <span class="command"><strong>userdel</strong></span>:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">userdel -r </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">alice</span></span></code></em></pre><p>
  The flag <code class="option">-r</code> deletes the user’s home directory. Accounts
  can be modified using <span class="command"><strong>usermod</strong></span>. Unix groups can be managed
  using <span class="command"><strong>groupadd</strong></span>, <span class="command"><strong>groupmod</strong></span> and
  <span class="command"><strong>groupdel</strong></span>.
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="ch-file-systems" class="title">Chapter&nbsp;8.&nbsp;File Systems<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#ch-file-systems" aria-label="Anchor link for: ch file systems" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-luks-file-systems" shape="rect">8.1. LUKS-Encrypted File Systems</a></span></dt></dl></div><p>
  You can define file systems using the <code class="option">fileSystems</code>
  configuration option. For instance, the following definition causes NixOS to
  mount the Ext4 file system on device
  <code class="filename">/dev/disk/by-label/data</code> onto the mount point
  <code class="filename">/data</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-fileSystems" shape="rect"><code class="option">fileSystems</code></a>.<span class="hljs-string"><span class="hljs-string">"/data"</span></span> =
  { <span class="hljs-attr"><span class="hljs-attr">device</span></span> = <span class="hljs-string"><span class="hljs-string">"/dev/disk/by-label/data"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">fsType</span></span> = <span class="hljs-string"><span class="hljs-string">"ext4"</span></span>;
  };
</pre><p>
  This will create an entry in <code class="filename">/etc/fstab</code>, which will
  generate a corresponding
  <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd.mount.html" target="_top" shape="rect">systemd.mount</a>
  unit via
  <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-fstab-generator.html" target="_top" shape="rect">systemd-fstab-generator</a>.
  The filesystem will be mounted automatically unless
  <code class="literal">"noauto"</code> is present in <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-fileSystems._name_.options" shape="rect">options</a>.
  <code class="literal">"noauto"</code> filesystems can be mounted explicitly using
  <span class="command"><strong>systemctl</strong></span> e.g. <span class="command"><strong>systemctl start
  data.mount</strong></span>.
  Mount points are created automatically if they don’t already exist. For
  <code class="option"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-fileSystems._name_.device" shape="rect">device</a></code>,
  it’s best to use the topology-independent device aliases in
  <code class="filename">/dev/disk/by-label</code> and
  <code class="filename">/dev/disk/by-uuid</code>, as these don’t change if the
  topology changes (e.g. if a disk is moved to another IDE controller).
 </p><p>
  You can usually omit the file system type
  (<code class="option"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-fileSystems._name_.fsType" shape="rect">fsType</a></code>),
  since <span class="command"><strong>mount</strong></span> can usually detect the type and load the
  necessary kernel module automatically. However, if the file system is needed
  at early boot (in the initial ramdisk) and is not <code class="literal">ext2</code>,
  <code class="literal">ext3</code> or <code class="literal">ext4</code>, then it’s best to
  specify <code class="option">fsType</code> to ensure that the kernel module is
  available.
 </p><div class="alert alert-info"><strong>Note:</strong> 
   System startup will fail if any of the filesystems fails to mount, dropping
   you to the emergency shell. You can make a mount asynchronous and
   non-critical by adding
   <code class="literal"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-fileSystems._name_.options" shape="rect">options</a> = [
   "nofail" ];</code>.
  </div><section class="section"><div class="titlepage"><div><div><h2 id="sec-luks-file-systems" class="title" style="clear: both">8.1.&nbsp;LUKS-Encrypted File Systems<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-luks-file-systems" aria-label="Anchor link for: sec luks file systems" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  NixOS supports file systems that are encrypted using
  <span class="emphasis"><em>LUKS</em></span> (Linux Unified Key Setup). For example, here is how
  you create an encrypted Ext4 file system on the device
  <code class="filename">/dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d</code>:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">cryptsetup luksFormat </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">/dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d</span></span></code></em>

WARNING!
========
This will overwrite data on /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d irrevocably.

Are you sure? (Type uppercase yes): YES
Enter LUKS passphrase: ***
Verify passphrase: ***

<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">cryptsetup luksOpen </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">/dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d</span></span></code></em><span class="hljs-comment"><span class="hljs-comment"> </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">crypted</span></span></code></em>
Enter passphrase <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d: ***

<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mkfs.ext4 /dev/mapper/</span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">crypted</span></span></code></em>
</pre><p>
  To ensure that this file system is automatically mounted at boot time as
  <code class="filename">/</code>, add the following to
  <code class="filename">configuration.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.initrd.luks.devices._name_.device" shape="rect">boot.initrd.luks.devices.crypted.<span class="hljs-attr"><span class="hljs-attr">device</span></span></a> = <span class="hljs-string"><span class="hljs-string">"</span></span><em class="replaceable"><code><span class="hljs-string"><span class="hljs-string">/dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d</span></span></code></em><span class="hljs-string"><span class="hljs-string">"</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-fileSystems" shape="rect"><code class="option">fileSystems</code></a>.<span class="hljs-string"><span class="hljs-string">"/"</span></span>.<span class="hljs-attr"><span class="hljs-attr">device</span></span> = <span class="hljs-string"><span class="hljs-string">"/dev/mapper/</span></span><em class="replaceable"><code><span class="hljs-string"><span class="hljs-string">crypted</span></span></code></em><span class="hljs-string"><span class="hljs-string">"</span></span>;
</pre><p>
  Should grub be used as bootloader, and <code class="filename">/boot</code> is located
  on an encrypted partition, it is necessary to add the following grub option:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.grub.enableCryptodisk" shape="rect"><code class="option">boot.loader.grub.<span class="hljs-attr"><span class="hljs-attr">enableCryptodisk</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</pre><p>
 </p><section class="section"><div class="titlepage"><div><div><h3 id="sec-luks-file-systems-fido2" class="title">8.1.1.&nbsp;FIDO2<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-luks-file-systems-fido2" aria-label="Anchor link for: sec luks file systems fido2" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   NixOS also supports unlocking your LUKS-Encrypted file system using a FIDO2 compatible token. In the following example, we will create a new FIDO2 credential
   and add it as a new key to our existing device <code class="filename">/dev/sda2</code>:

   </p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">export FIDO2_LABEL="</span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">/dev/sda2</span></span></code></em><span class="hljs-comment"><span class="hljs-comment"> @ $HOSTNAME"</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">fido2luks credential "$FIDO2_LABEL"</span></span>
f1d00200108b9d6e849a8b388da457688e3dd653b4e53770012d8f28e5d3b269865038c346802f36f3da7278b13ad6a3bb6a1452e24ebeeaa24ba40eef559b1b287d2a2f80b7

<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">fido2luks -i add-key </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">/dev/sda2</span></span></code></em><span class="hljs-comment"><span class="hljs-comment"> </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">f1d00200108b9d6e849a8b388da457688e3dd653b4e53770012d8f28e5d3b269865038c346802f36f3da7278b13ad6a3bb6a1452e24ebeeaa24ba40eef559b1b287d2a2f80b7</span></span></code></em>
Password:
Password (again):
Old password:
Old password (again):
Added to key to device /dev/sda2, slot: <span class="hljs-number"><span class="hljs-number">2</span></span>
</pre><p>

  To ensure that this file system is decrypted using the FIDO2 compatible key, add the following to <code class="filename">configuration.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.initrd.luks.fido2Support" shape="rect">boot.initrd.luks.<span class="hljs-attr"><span class="hljs-attr">fido2Support</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.initrd.luks.devices._name_.fido2.credential" shape="rect">boot.initrd.luks.devices.<span class="hljs-string"><span class="hljs-string">"</span></span><em class="replaceable"><code><span class="hljs-string"><span class="hljs-string">/dev/sda2</span></span></code></em><span class="hljs-string"><span class="hljs-string">"</span></span>.fido2.<span class="hljs-attr"><span class="hljs-attr">credential</span></span></a> = <span class="hljs-string"><span class="hljs-string">"</span></span><em class="replaceable"><code><span class="hljs-string"><span class="hljs-string">f1d00200108b9d6e849a8b388da457688e3dd653b4e53770012d8f28e5d3b269865038c346802f36f3da7278b13ad6a3bb6a1452e24ebeeaa24ba40eef559b1b287d2a2f80b7</span></span></code></em><span class="hljs-string"><span class="hljs-string">"</span></span>;
</pre><p>

  You can also use the FIDO2 passwordless setup, but for security reasons, you might want to enable it only when your device is PIN protected, such as <a class="link" href="https://trezor.io/" target="_top" shape="rect">Trezor</a>.

</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.initrd.luks.devices._name_.fido2.passwordLess" shape="rect">boot.initrd.luks.devices.<span class="hljs-string"><span class="hljs-string">"</span></span><em class="replaceable"><code><span class="hljs-string"><span class="hljs-string">/dev/sda2</span></span></code></em><span class="hljs-string"><span class="hljs-string">"</span></span>.fido2.<span class="hljs-attr"><span class="hljs-attr">passwordLess</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
  </p></section></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-x11" class="title">Chapter&nbsp;9.&nbsp;X Window System<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-x11" aria-label="Anchor link for: sec x11" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  The X Window System (X11) provides the basis of NixOS’ graphical user
  interface. It can be enabled as follows:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.enable" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
  The X server will automatically detect and use the appropriate video driver
  from a set of X.org drivers (such as <code class="literal">vesa</code> and
  <code class="literal">intel</code>). You can also specify a driver manually, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.videoDrivers" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">videoDrivers</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"r128"</span></span> ];
</pre><p>
  to enable X.org’s <code class="literal">xf86-video-r128</code> driver.
 </p><p>
  You also need to enable at least one desktop or window manager. Otherwise,
  you can only log into a plain undecorated <span class="command"><strong>xterm</strong></span> window.
  Thus you should pick one or more of the following lines:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.desktopManager.plasma5.enable" shape="rect"><code class="option">services.xserver.desktopManager.plasma5.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.desktopManager.xfce.enable" shape="rect"><code class="option">services.xserver.desktopManager.xfce.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.desktopManager.gnome3.enable" shape="rect"><code class="option">services.xserver.desktopManager.gnome3.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.desktopManager.mate.enable" shape="rect"><code class="option">services.xserver.desktopManager.mate.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.windowManager.xmonad.enable" shape="rect"><code class="option">services.xserver.windowManager.xmonad.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.windowManager.twm.enable" shape="rect"><code class="option">services.xserver.windowManager.twm.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.windowManager.icewm.enable" shape="rect"><code class="option">services.xserver.windowManager.icewm.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.windowManager.i3.enable" shape="rect"><code class="option">services.xserver.windowManager.i3.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.windowManager.herbstluftwm.enable" shape="rect"><code class="option">services.xserver.windowManager.herbstluftwm.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
 </p><p>
  NixOS’s default <span class="emphasis"><em>display manager</em></span> (the program that
  provides a graphical login prompt and manages the X server) is LightDM. You
  can select an alternative one by picking one of the following lines:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.sddm.enable" shape="rect"><code class="option">services.xserver.displayManager.sddm.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.gdm.enable" shape="rect"><code class="option">services.xserver.displayManager.gdm.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
 </p><p>
  You can set the keyboard layout (and optionally the layout variant):
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.layout" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">layout</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"de"</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.xkbVariant" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">xkbVariant</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"neo"</span></span>;
</pre><p>
 </p><p>
  The X server is started automatically at boot time. If you don’t want this
  to happen, you can set:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.autorun" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">autorun</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
</pre><p>
  The X server can then be started manually:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">systemctl start display-manager.service</span></span>
</pre><p>
 </p><p>
  On 64-bit systems, if you want OpenGL for 32-bit programs such as in Wine,
  you should also set the following:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-hardware.opengl.driSupport32Bit" shape="rect"><code class="option">hardware.opengl.<span class="hljs-attr"><span class="hljs-attr">driSupport32Bit</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
 </p><div class="simplesect"><div class="titlepage"><div><div><h2 id="sec-x11-auto-login" class="title" style="clear: both">Auto-login<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-x11-auto-login" aria-label="Anchor link for: sec x11 auto login" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  The x11 login screen can be skipped entirely, automatically logging you into
  your window manager and desktop environment when you boot your computer.
  </p><p>
  This is especially helpful if you have disk encryption enabled. Since you
  already have to provide a password to decrypt your disk, entering a second
  password to login can be redundant.
  </p><p>
  To enable auto-login, you need to define your default window manager and
  desktop environment. If you wanted no desktop environment and i3 as your your
  window manager, you'd define:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.defaultSession" shape="rect"><code class="option">services.xserver.displayManager.<span class="hljs-attr"><span class="hljs-attr">defaultSession</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"none+i3"</span></span>;
</pre><p>
  Every display manager in NixOS supports auto-login, here is an example
  using lightdm for a user <code class="literal">alice</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.lightdm.enable" shape="rect"><code class="option">services.xserver.displayManager.lightdm.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.autoLogin.enable" shape="rect"><code class="option">services.xserver.displayManager.autoLogin.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.autoLogin.user" shape="rect"><code class="option">services.xserver.displayManager.autoLogin.<span class="hljs-attr"><span class="hljs-attr">user</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"alice"</span></span>;
</pre><p>
  </p></div><div class="simplesect"><div class="titlepage"><div><div><h2 id="sec-x11--graphics-cards-intel" class="title" style="clear: both">Intel Graphics drivers<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-x11--graphics-cards-intel" aria-label="Anchor link for: sec x11  graphics cards intel" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   There are two choices for Intel Graphics drivers in X.org:
   <code class="literal">modesetting</code> (included in the <span class="package">xorg-server</span> itself)
   and <code class="literal">intel</code> (provided by the package <span class="package">xf86-video-intel</span>).
  </p><p>
   The default and recommended is <code class="literal">modesetting</code>.
   It is a generic driver which uses the kernel
   <a class="link" href="https://en.wikipedia.org/wiki/Mode_setting" target="_top" shape="rect">mode setting</a>
   (KMS) mechanism. It supports Glamor (2D graphics acceleration via OpenGL)
   and is actively maintained but may perform worse in some cases (like in old chipsets).
  </p><p>
   The second driver, <code class="literal">intel</code>, is specific to Intel GPUs,
   but not recommended by most distributions: it lacks several modern features
   (for example, it doesn't support Glamor) and the package hasn't been officially
   updated since 2015.
  </p><p>
   The results vary depending on the hardware, so you may have to try both drivers.
   Use the option <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.videoDrivers" shape="rect"><code class="option">services.xserver.videoDrivers</code></a> to set one.
   The recommended configuration for modern systems is:
</p><pre class="programlisting hljs nix" xml:space="preserve">  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.videoDrivers" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">videoDrivers</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"modesetting"</span></span> ];
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.useGlamor" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">useGlamor</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
   If you experience screen tearing no matter what, this configuration was
   reported to resolve the issue:
</p><pre class="programlisting hljs bash" xml:space="preserve">  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.videoDrivers" shape="rect"><code class="option">services.xserver.videoDrivers</code></a> = [ <span class="hljs-string"><span class="hljs-string">"intel"</span></span> ];
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.deviceSection" shape="rect"><code class="option">services.xserver.deviceSection</code></a> = <span class="hljs-string"><span class="hljs-string">''</span></span>
    Option <span class="hljs-string"><span class="hljs-string">"DRI"</span></span> <span class="hljs-string"><span class="hljs-string">"2"</span></span>
    Option <span class="hljs-string"><span class="hljs-string">"TearFree"</span></span> <span class="hljs-string"><span class="hljs-string">"true"</span></span>
  <span class="hljs-string"><span class="hljs-string">''</span></span>;
</pre><p>
   Note that this will likely downgrade the performance compared to
  <code class="literal">modesetting</code> or <code class="literal">intel</code> with DRI 3 (default).
  </p></div><div class="simplesect"><div class="titlepage"><div><div><h2 id="sec-x11-graphics-cards-nvidia" class="title" style="clear: both">Proprietary NVIDIA drivers<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-x11-graphics-cards-nvidia" aria-label="Anchor link for: sec x11 graphics cards nvidia" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   NVIDIA provides a proprietary driver for its graphics cards that has better
   3D performance than the X.org drivers. It is not enabled by default because
   it’s not free software. You can enable it as follows:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.videoDrivers" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">videoDrivers</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"nvidia"</span></span> ];
</pre><p>
   Or if you have an older card, you may have to use one of the legacy drivers:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.videoDrivers" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">videoDrivers</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"nvidiaLegacy390"</span></span> ];
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.videoDrivers" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">videoDrivers</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"nvidiaLegacy340"</span></span> ];
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.videoDrivers" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">videoDrivers</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"nvidiaLegacy304"</span></span> ];
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.videoDrivers" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">videoDrivers</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"nvidiaLegacy173"</span></span> ];
</pre><p>
   You may need to reboot after enabling this driver to prevent a clash with
   other kernel modules.
  </p></div><div class="simplesect"><div class="titlepage"><div><div><h2 id="sec-x11--graphics-cards-amd" class="title" style="clear: both">Proprietary AMD drivers<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-x11--graphics-cards-amd" aria-label="Anchor link for: sec x11  graphics cards amd" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   AMD provides a proprietary driver for its graphics cards that has better 3D
   performance than the X.org drivers. It is not enabled by default because
   it’s not free software. You can enable it as follows:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.videoDrivers" shape="rect"><code class="option">services.xserver.<span class="hljs-attr"><span class="hljs-attr">videoDrivers</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"ati_unfree"</span></span> ];
</pre><p>
   You will need to reboot after enabling this driver to prevent a clash with
   other kernel modules.
  </p><div class="alert alert-info"><strong>Note:</strong> 
   For recent AMD GPUs you most likely want to keep either the defaults
   or <code class="literal">"amdgpu"</code> (both free).
  </div></div><div class="simplesect"><div class="titlepage"><div><div><h2 id="sec-x11-touchpads" class="title" style="clear: both">Touchpads<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-x11-touchpads" aria-label="Anchor link for: sec x11 touchpads" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Support for Synaptics touchpads (found in many laptops such as the Dell
   Latitude series) can be enabled as follows:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.libinput.enable" shape="rect"><code class="option">services.xserver.libinput.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
   The driver has many options (see <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html" title="Appendix A. Configuration Options" shape="rect">Appendix&nbsp;A, <em>Configuration Options</em></a>). For
   instance, the following disables tap-to-click behavior:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.libinput.tapping" shape="rect"><code class="option">services.xserver.libinput.<span class="hljs-attr"><span class="hljs-attr">tapping</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
</pre><p>
   Note: the use of <code class="literal">services.xserver.synaptics</code> is deprecated
   since NixOS 17.09.
  </p></div><div class="simplesect"><div class="titlepage"><div><div><h2 id="sec-x11-gtk-and-qt-themes" class="title" style="clear: both">GTK/Qt themes<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-x11-gtk-and-qt-themes" aria-label="Anchor link for: sec x11 gtk and qt themes" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   GTK themes can be installed either to user profile or system-wide (via
   <code class="literal">environment.systemPackages</code>). To make Qt 5 applications
   look similar to GTK2 ones, you can install <code class="literal">qt5.qtbase.gtk</code>
   package into your system environment. It should work for all Qt 5 library
   versions.
  </p></div><div class="simplesect"><div class="titlepage"><div><div><h2 id="custom-xkb-layouts" class="title" style="clear: both">Custom XKB layouts<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#custom-xkb-layouts" aria-label="Anchor link for: custom xkb layouts" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   It is possible to install custom
   <a class="link" href="https://en.wikipedia.org/wiki/X_keyboard_extension" target="_top" shape="rect">
    XKB
   </a>
   keyboard layouts using the option
   <code class="option">
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.extraLayouts" shape="rect">
     services.xserver.extraLayouts
    </a>
   </code>.
   As a first example, we are going to create a layout based on the basic US
   layout, with an additional layer to type some greek symbols by pressing the
   right-alt key.
  </p><p>
   To do this we are going to create a <code class="literal">us-greek</code> file
   with a <code class="literal">xkb_symbols</code> section.
  </p><pre class="programlisting hljs nix" xml:space="preserve">xkb_symbols <span class="hljs-string"><span class="hljs-string">"us-greek"</span></span>
{
  include <span class="hljs-string"><span class="hljs-string">"us(basic)"</span></span>            // includes the base US keys
  include <span class="hljs-string"><span class="hljs-string">"level3(ralt_switch)"</span></span>  // configures right alt as a third level switch

  key &lt;LatA&gt; { [ a, A, Greek_alpha ] };
  key &lt;LatB&gt; { [ b, B, Greek_beta  ] };
  key &lt;LatG&gt; { [ g, G, Greek_gamma ] };
  key &lt;LatD&gt; { [ d, D, Greek_delta ] };
  key &lt;LatZ&gt; { [ z, Z, Greek_zeta  ] };
};
</pre><p>
   To install the layout, the filepath, a description and the list of
   languages must be given:
  </p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.extraLayouts" shape="rect"><code class="option">services.xserver.extraLayouts</code></a>.<span class="hljs-attr"><span class="hljs-attr">us-greek</span></span> = {
  <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">"US layout with alt-gr greek"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">languages</span></span>   = [ <span class="hljs-string"><span class="hljs-string">"eng"</span></span> ];
  <span class="hljs-attr"><span class="hljs-attr">symbolsFile</span></span> = /path/to/us-greek;
}
</pre><div class="alert alert-info"><strong>Note:</strong> 
   The name should match the one given to the
   <code class="literal">xkb_symbols</code> block.
  </div><p>
   The layout should now be installed and ready to use: try it by
   running <code class="literal">setxkbmap us-greek</code> and type
   <code class="literal">&lt;alt&gt;+a</code>. To change the default the usual
   <code class="option">
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.layout" shape="rect">
     services.xserver.layout
    </a>
   </code>
   option can still be used.
  </p><p>
   A layout can have several other components besides
   <code class="literal">xkb_symbols</code>, for example we will define new
   keycodes for some multimedia key and bind these to some symbol.
  </p><p>
   Use the <span class="emphasis"><em>xev</em></span> utility from
   <code class="literal">pkgs.xorg.xev</code> to find the codes of the keys of
   interest, then create a <code class="literal">media-key</code> file to hold
   the keycodes definitions
  </p><pre class="programlisting hljs nix" xml:space="preserve">xkb_keycodes <span class="hljs-string"><span class="hljs-string">"media"</span></span>
{
 &lt;volUp&gt;   = <span class="hljs-number"><span class="hljs-number">123</span></span>;
 &lt;volDown&gt; = <span class="hljs-number"><span class="hljs-number">456</span></span>;
}
</pre><p>
    Now use the newly define keycodes in <code class="literal">media-sym</code>:
  </p><pre class="programlisting hljs nix" xml:space="preserve">xkb_symbols <span class="hljs-string"><span class="hljs-string">"media"</span></span>
{
 key.<span class="hljs-attr"><span class="hljs-attr">type</span></span> = <span class="hljs-string"><span class="hljs-string">"ONE_LEVEL"</span></span>;
 key &lt;volUp&gt;   { [ XF86AudioLowerVolume ] };
 key &lt;volDown&gt; { [ XF86AudioRaiseVolume ] };
}
</pre><p>
    As before, to install the layout do
  </p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.extraLayouts" shape="rect"><code class="option">services.xserver.extraLayouts</code></a>.<span class="hljs-attr"><span class="hljs-attr">media</span></span> = {
  <span class="hljs-attr"><span class="hljs-attr">description</span></span>  = <span class="hljs-string"><span class="hljs-string">"Multimedia keys remapping"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">languages</span></span>    = [ <span class="hljs-string"><span class="hljs-string">"eng"</span></span> ];
  <span class="hljs-attr"><span class="hljs-attr">symbolsFile</span></span>  = /path/to/media-key;
  <span class="hljs-attr"><span class="hljs-attr">keycodesFile</span></span> = /path/to/media-sym;
};
</pre><div class="alert alert-info"><strong>Note:</strong> 
   The function <code class="literal">pkgs.writeText &lt;filename&gt; &lt;content&gt;
   </code> can be useful if you prefer to keep the layout definitions
   inside the NixOS configuration.
  </div><p>
    Unfortunately, the Xorg server does not (currently) support setting a
    keymap directly but relies instead on XKB rules to select the matching
    components (keycodes, types, ...) of a layout. This means that components
    other than symbols won't be loaded by default. As a workaround, you
    can set the keymap using <code class="literal">setxkbmap</code> at the start of the
    session with:
  </p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.sessionCommands" shape="rect"><code class="option">services.xserver.displayManager.<span class="hljs-attr"><span class="hljs-attr">sessionCommands</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"setxkbmap -keycodes media"</span></span>;
</pre><p>
    If you are manually starting the X server, you should set the argument
    <code class="literal">-xkbdir /etc/X11/xkb</code>, otherwise X won't find your layout files.
    For example with <span class="command"><strong>xinit</strong></span> run
    </p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>xinit -- -xkbdir /etc/X11/xkb</pre><p>
  </p><p>
   To learn how to write layouts take a look at the XKB
  <a class="link" href="https://www.x.org/releases/current/doc/xorg-docs/input/XKB-Enhancing.html#Defining_New_Layouts" target="_top" shape="rect">
   documentation
  </a>. More example layouts can also be found
  <a class="link" href="https://wiki.archlinux.org/index.php/X_KeyBoard_extension#Basic_examples" target="_top" shape="rect">
   here
  </a>.
  </p></div></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-gpu-accel" class="title">Chapter&nbsp;10.&nbsp;GPU acceleration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel" aria-label="Anchor link for: sec gpu accel" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-gpu-accel-opencl" shape="rect">10.1. OpenCL</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-gpu-accel-vulkan" shape="rect">10.2. Vulkan</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-gpu-accel-common-issues" shape="rect">10.3. Common issues</a></span></dt></dl></div><p>
    NixOS provides various APIs that benefit from GPU hardware
    acceleration, such as VA-API and VDPAU for video playback; OpenGL and
    Vulkan for 3D graphics; and OpenCL for general-purpose computing.
    This chapter describes how to set up GPU hardware acceleration (as far
    as this is not done automatically) and how to verify that hardware
    acceleration is indeed used.
  </p><p>
    Most of the aforementioned APIs are agnostic with regards to which
    display server is used. Consequently, these instructions should apply
    both to the X Window System and Wayland compositors.
  </p><section class="section"><div class="titlepage"><div><div><h2 id="sec-gpu-accel-opencl" class="title" style="clear: both">10.1.&nbsp;OpenCL<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-opencl" aria-label="Anchor link for: sec gpu accel opencl" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
      <a class="link" href="https://en.wikipedia.org/wiki/OpenCL" target="_top" shape="rect">OpenCL</a> is a
      general compute API. It is used by various applications such as
      Blender and Darktable to accelerate certain operations.
    </p><p>
      OpenCL applications load drivers through the <span class="emphasis"><em>Installable Client
      Driver</em></span> (ICD) mechanism. In this mechanism, an ICD file
      specifies the path to the OpenCL driver for a particular GPU family.
      In NixOS, there are two ways to make ICD files visible to the ICD
      loader. The first is through the <code class="varname">OCL_ICD_VENDORS</code>
      environment variable. This variable can contain a directory which
      is scanned by the ICL loader for ICD files. For example:

      </p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$</code> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> \
  OCL_ICD_VENDORS=`nix-build <span class="hljs-string"><span class="hljs-string">'&lt;nixpkgs&gt;'</span></span> --no-out-link -A rocm-opencl-icd`/etc/OpenCL/vendors/</pre><p>
    </p><p>
      The second mechanism is to add the OpenCL driver package to
      <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-hardware.opengl.extraPackages" shape="rect"><code class="option">hardware.opengl.extraPackages</code></a>. This links the
      ICD file under <code class="filename">/run/opengl-driver</code>, where it will
      be visible to the ICD loader.
    </p><p>
      The proper installation of OpenCL drivers can be verified through
      the <span class="command"><strong>clinfo</strong></span> command of the <span class="package">clinfo</span>
      package. This command will report the number of hardware devices
      that is found and give detailed information for each device:
    </p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$</code> clinfo | head -n3
Number of platforms  1
Platform Name        AMD Accelerated Parallel Processing
Platform Vendor      Advanced Micro Devices, Inc.</pre><section class="section"><div class="titlepage"><div><div><h3 id="sec-gpu-accel-opencl-amd" class="title">10.1.1.&nbsp;AMD<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-opencl-amd" aria-label="Anchor link for: sec gpu accel opencl amd" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
	Modern AMD <a class="link" href="https://en.wikipedia.org/wiki/Graphics_Core_Next" target="_top" shape="rect">Graphics
	Core Next</a> (GCN) GPUs are supported through the
	<span class="package">rocm-opencl-icd</span> package. Adding this package to
	<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-hardware.opengl.extraPackages" shape="rect"><code class="option">hardware.opengl.extraPackages</code></a> enables OpenCL
	support:

	</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-hardware.opengl.extraPackages" shape="rect"><code class="option">hardware.opengl.<span class="hljs-attr"><span class="hljs-attr">extraPackages</span></span></code></a> = [
  rocm-opencl-icd
];</pre><p>
      </p></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-gpu-accel-opencl-intel" class="title">10.1.2.&nbsp;Intel<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-opencl-intel" aria-label="Anchor link for: sec gpu accel opencl intel" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
       <a class="link" href="https://en.wikipedia.org/wiki/List_of_Intel_graphics_processing_units#Gen8" target="_top" shape="rect">Intel
       Gen8 and later GPUs</a> are supported by the Intel NEO OpenCL
       runtime that is provided by the
       <span class="package">intel-compute-runtime</span> package. For Gen7 GPUs,
       the deprecated Beignet runtime can be used, which is provided
       by the <span class="package">beignet</span> package. The proprietary Intel
       OpenCL runtime, in the <span class="package">intel-ocl</span> package, is
       an alternative for Gen7 GPUs.
      </p><p>
       The <span class="package">intel-compute-runtime</span>, <span class="package">beignet</span>,
       or <span class="package">intel-ocl</span> package can be added to
       <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-hardware.opengl.extraPackages" shape="rect"><code class="option">hardware.opengl.extraPackages</code></a> to enable OpenCL
       support. For example, for Gen8 and later GPUs, the following
       configuration can be used:

	      </p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-hardware.opengl.extraPackages" shape="rect"><code class="option">hardware.opengl.<span class="hljs-attr"><span class="hljs-attr">extraPackages</span></span></code></a> = [
  intel-compute-runtime
];</pre><p>

      </p></section></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-gpu-accel-vulkan" class="title" style="clear: both">10.2.&nbsp;Vulkan<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-vulkan" aria-label="Anchor link for: sec gpu accel vulkan" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
      <a class="link" href="https://en.wikipedia.org/wiki/Vulkan_(API)" target="_top" shape="rect">Vulkan</a> is a
      graphics and compute API for GPUs. It is used directly by games or indirectly though
      compatibility layers like <a class="link" href="https://github.com/doitsujin/dxvk/wiki" target="_top" shape="rect">DXVK</a>.
    </p><p>
     By default, if <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-hardware.opengl.driSupport" shape="rect"><code class="option">hardware.opengl.driSupport</code></a> is enabled,
     <span class="package">mesa</span> is installed and provides Vulkan for supported hardware.
    </p><p>
      Similar to OpenCL, Vulkan drivers are loaded through the <span class="emphasis"><em>Installable Client
      Driver</em></span> (ICD) mechanism. ICD files for Vulkan are JSON files that specify
      the path to the driver library and the supported Vulkan version. All successfully
      loaded drivers are exposed to the application as different GPUs.
      In NixOS, there are two ways to make ICD files visible to Vulkan applications: an
      environment variable and a module option.
    </p><p>
      The first option is through the <code class="varname">VK_ICD_FILENAMES</code>
      environment variable. This variable can contain multiple JSON files, separated by
      <code class="literal">:</code>. For example:

      </p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$</code> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> \
  VK_ICD_FILENAMES=`nix-build <span class="hljs-string"><span class="hljs-string">'&lt;nixpkgs&gt;'</span></span> --no-out-link -A amdvlk`/share/vulkan/icd.d/amd_icd64.json</pre><p>
    </p><p>
      The second mechanism is to add the Vulkan driver package to
      <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-hardware.opengl.extraPackages" shape="rect"><code class="option">hardware.opengl.extraPackages</code></a>. This links the
      ICD file under <code class="filename">/run/opengl-driver</code>, where it will
      be visible to the ICD loader.
    </p><p>
      The proper installation of Vulkan drivers can be verified through
      the <span class="command"><strong>vulkaninfo</strong></span> command of the <span class="package">vulkan-tools</span>
      package. This command will report the hardware devices and drivers found,
      in this example output amdvlk and radv:
    </p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$</code> vulkaninfo | grep GPU
                GPU id  : <span class="hljs-number"><span class="hljs-number">0</span></span> (Unknown AMD GPU)
                GPU id  : <span class="hljs-number"><span class="hljs-number">1</span></span> (AMD RADV NAVI10 (LLVM <span class="hljs-number"><span class="hljs-number">9.0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>))
     ...
GPU0:
        <span class="hljs-attr"><span class="hljs-attr">deviceType</span></span>     = PHYSICAL_DEVICE_TYPE_DISCRETE_GPU
        <span class="hljs-attr"><span class="hljs-attr">deviceName</span></span>     = Unknown AMD GPU
GPU1:
        <span class="hljs-attr"><span class="hljs-attr">deviceType</span></span>     = PHYSICAL_DEVICE_TYPE_DISCRETE_GPU</pre><p>
      A simple graphical application that uses Vulkan is <span class="command"><strong>vkcube</strong></span>
      from the <span class="package">vulkan-tools</span> package.
    </p><section class="section"><div class="titlepage"><div><div><h3 id="sec-gpu-accel-vulkan-amd" class="title">10.2.1.&nbsp;AMD<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-vulkan-amd" aria-label="Anchor link for: sec gpu accel vulkan amd" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
	Modern AMD <a class="link" href="https://en.wikipedia.org/wiki/Graphics_Core_Next" target="_top" shape="rect">Graphics
	Core Next</a> (GCN) GPUs are supported through either radv, which is
	part of <span class="package">mesa</span>, or the <span class="package">amdvlk</span> package.
	Adding the <span class="package">amdvlk</span> package to
	<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-hardware.opengl.extraPackages" shape="rect"><code class="option">hardware.opengl.extraPackages</code></a> makes both drivers
	available for applications and lets them choose. A specific driver can
	be forced as follows:

	</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-hardware.opengl.extraPackages" shape="rect"><code class="option">hardware.opengl.<span class="hljs-attr"><span class="hljs-attr">extraPackages</span></span></code></a> = [
  <span class="package">amdvlk</span>
];

<span class="hljs-comment"><span class="hljs-comment"># For amdvlk</span></span>
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.variables" shape="rect"><code class="option">environment.variables</code></a>.<span class="hljs-attr"><span class="hljs-attr">VK_ICD_FILENAMES</span></span> =
   <span class="hljs-string"><span class="hljs-string">"/run/opengl-driver/share/vulkan/icd.d/amd_icd64.json"</span></span>;
<span class="hljs-comment"><span class="hljs-comment"># For radv</span></span>
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.variables" shape="rect"><code class="option">environment.variables</code></a>.<span class="hljs-attr"><span class="hljs-attr">VK_ICD_FILENAMES</span></span> =
  <span class="hljs-string"><span class="hljs-string">"/run/opengl-driver/share/vulkan/icd.d/radeon_icd.x86_64.json"</span></span>;
</pre><p>
      </p></section></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-gpu-accel-common-issues" class="title" style="clear: both">10.3.&nbsp;Common issues<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-common-issues" aria-label="Anchor link for: sec gpu accel common issues" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><section class="section"><div class="titlepage"><div><div><h3 id="sec-gpu-accel-common-issues-permissions" class="title">10.3.1.&nbsp;User permissions<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-common-issues-permissions" aria-label="Anchor link for: sec gpu accel common issues permissions" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
     Except where noted explicitly, it should not be necessary to
     adjust user permissions to use these acceleration APIs. In the default
     configuration, GPU devices have world-read/write permissions
     (<code class="filename">/dev/dri/renderD*</code>) or are tagged as
     <code class="code">uaccess</code> (<code class="filename">/dev/dri/card*</code>).  The
     access control lists of devices with the <code class="varname">uaccess</code>
     tag will be updated automatically when a user logs in through
     <span class="command"><strong>systemd-logind</strong></span>. For example, if the user
     <span class="emphasis"><em>jane</em></span> is logged in, the access control list
     should look as follows:

     </p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$</code> getfacl /dev/dri/card0
<span class="hljs-comment"><span class="hljs-comment"># file: dev/dri/card0</span></span>
<span class="hljs-comment"><span class="hljs-comment"># owner: root</span></span>
<span class="hljs-comment"><span class="hljs-comment"># group: video</span></span>
user::rw-
user:jane:rw-
group::rw-
mask::rw-
other::---</pre><p>

     If you disabled (this functionality of) <span class="command"><strong>systemd-logind</strong></span>,
     you may need to add the user to the <code class="code">video</code> group and
     log in again.
    </p></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-gpu-accel-common-issues-mixing-nixpkgs" class="title">10.3.2.&nbsp;Mixing different versions of nixpkgs<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-common-issues-mixing-nixpkgs" aria-label="Anchor link for: sec gpu accel common issues mixing nixpkgs" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
     The <span class="emphasis"><em>Installable Client Driver</em></span> (ICD)
     mechanism used by OpenCL and Vulkan loads runtimes into its address
     space using <code class="code">dlopen</code>. Mixing an ICD loader mechanism and
     runtimes from different version of nixpkgs may not work. For example,
     if the ICD loader uses an older version of <span class="package">glibc</span>
     than the runtime, the runtime may not be loadable due to
     missing symbols. Unfortunately, the loader will generally be quiet
     about such issues.
    </p><p>
     If you suspect that you are running into library version mismatches
     between an ICL loader and a runtime, you could run an application with
     the <code class="code">LD_DEBUG</code> variable set to get more diagnostic
     information. For example, OpenCL can be tested with
     <code class="code">LD_DEBUG=files clinfo</code>, which should report missing
     symbols.
    </p></section></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-xfce" class="title">Chapter&nbsp;11.&nbsp;Xfce Desktop Environment<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-xfce" aria-label="Anchor link for: sec xfce" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  To enable the Xfce Desktop Environment, set
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.desktopManager.xfce.enable" shape="rect"><code class="option">services.xserver.desktopManager.xfce.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.defaultSession" shape="rect"><code class="option">services.xserver.displayManager.<span class="hljs-attr"><span class="hljs-attr">defaultSession</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"xfce"</span></span>;
</pre><p>
 </p><p>
  Optionally, <span class="emphasis"><em>picom</em></span> can be enabled for nice graphical
  effects, some example settings:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.picom.enable" shape="rect">services.<span class="hljs-attr"><span class="hljs-attr">picom</span></span></a> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.picom.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.picom.fade" shape="rect"><span class="hljs-attr"><span class="hljs-attr">fade</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.picom.inactiveOpacity" shape="rect"><span class="hljs-attr"><span class="hljs-attr">inactiveOpacity</span></span></a> = <span class="hljs-number"><span class="hljs-number">0.9</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.picom.shadow" shape="rect"><span class="hljs-attr"><span class="hljs-attr">shadow</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.picom.fadeDelta" shape="rect"><span class="hljs-attr"><span class="hljs-attr">fadeDelta</span></span></a> = <span class="hljs-number"><span class="hljs-number">4</span></span>;
};
</pre><p>
 </p><p>
  Some Xfce programs are not installed automatically. To install them manually
  (system wide), put them into your
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.systemPackages</code></a> from <code class="literal">pkgs.xfce</code>.
 </p><div class="simplesect"><div class="titlepage"><div><div><h2 id="sec-xfce-thunar-plugins" class="title" style="clear: both">Thunar Plugins<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-xfce-thunar-plugins" aria-label="Anchor link for: sec xfce thunar plugins" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
    If you'd like to add extra plugins to Thunar, add them to
    <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.desktopManager.xfce.thunarPlugins" shape="rect"><code class="option">services.xserver.desktopManager.xfce.thunarPlugins</code></a>.
    You shouldn't just add them to <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.systemPackages</code></a>.
  </p></div><div class="simplesect"><div class="titlepage"><div><div><h2 id="sec-xfce-troubleshooting" class="title" style="clear: both">Troubleshooting<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-xfce-troubleshooting" aria-label="Anchor link for: sec xfce troubleshooting" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Even after enabling udisks2, volume management might not work. Thunar and/or
   the desktop takes time to show up. Thunar will spit out this kind of message
   on start (look at <span class="command"><strong>journalctl --user -b</strong></span>).
</p><pre class="programlisting hljs nix" xml:space="preserve">Thunar:<span class="hljs-number"><span class="hljs-number">2410</span></span>): GVFS-RemoteVolumeMonitor-WARNING **: remote volume monitor <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> dbus name org.gtk.Private.UDisks2VolumeMonitor is not supported
</pre><p>
   This is caused by some needed GNOME services not running. This is all fixed
   by enabling "Launch GNOME services on startup" in the Advanced tab of the
   Session and Startup settings panel. Alternatively, you can run this command
   to do the same thing.
</p><pre class="programlisting hljs nix" xml:space="preserve"><code class="prompt">$ </code>xfconf-query -c xfce4-session -p /compat/LaunchGNOME -s <span class="hljs-literal"><span class="hljs-literal">true</span></span>
</pre><p>
   A log-out and re-log will be needed for this to take effect.
  </p></div></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-networking" class="title">Chapter&nbsp;12.&nbsp;Networking<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-networking" aria-label="Anchor link for: sec networking" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-networkmanager" shape="rect">12.1. NetworkManager</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-ssh" shape="rect">12.2. Secure Shell Access</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-ipv4" shape="rect">12.3. IPv4 Configuration</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-ipv6" shape="rect">12.4. IPv6 Configuration</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-firewall" shape="rect">12.5. Firewall</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-wireless" shape="rect">12.6. Wireless Networks</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#ad-hoc-network-config" shape="rect">12.7. Ad-Hoc Configuration</a></span></dt></dl></div><p>
  This section describes how to configure networking components on your NixOS
  machine.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="sec-networkmanager" class="title" style="clear: both">12.1.&nbsp;NetworkManager<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-networkmanager" aria-label="Anchor link for: sec networkmanager" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  To facilitate network configuration, some desktop environments use
  NetworkManager. You can enable NetworkManager by setting:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.networkmanager.enable" shape="rect"><code class="option">networking.networkmanager.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
  some desktop managers (e.g., GNOME) enable NetworkManager automatically for
  you.
 </p><p>
  All users that should have permission to change network settings must belong
  to the <code class="code">networkmanager</code> group:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users._name_.extraGroups" shape="rect">users.users.alice.<span class="hljs-attr"><span class="hljs-attr">extraGroups</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"networkmanager"</span></span> ];
</pre><p>
 </p><p>
  NetworkManager is controlled using either <span class="command"><strong>nmcli</strong></span> or
  <span class="command"><strong>nmtui</strong></span> (curses-based terminal user interface). See their
  manual pages for details on their usage. Some desktop environments (GNOME,
  KDE) have their own configuration tools for NetworkManager. On XFCE, there is
  no configuration tool for NetworkManager by default: by enabling <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-programs.nm-applet.enable" shape="rect"><code class="option">programs.nm-applet.enable</code></a>, the
  graphical applet will be installed and will launch automatically when the graphical session is started.
 </p><div class="note"><h3 class="title" id="note-1">Note<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#note-1" aria-label="Anchor link for: note 1" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3><p>
   <code class="code">networking.networkmanager</code> and <code class="code">networking.wireless</code>
   (WPA Supplicant) can be used together if desired. To do this you need to instruct
   NetworkManager to ignore those interfaces like:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.networkmanager.unmanaged" shape="rect"><code class="option">networking.networkmanager.<span class="hljs-attr"><span class="hljs-attr">unmanaged</span></span></code></a> = [
   <span class="hljs-string"><span class="hljs-string">"*"</span></span> <span class="hljs-string"><span class="hljs-string">"except:type:wwan"</span></span> <span class="hljs-string"><span class="hljs-string">"except:type:gsm"</span></span>
];
</pre><p>
   Refer to the option description for the exact syntax and references to external documentation.
  </p></div></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-ssh" class="title" style="clear: both">12.2.&nbsp;Secure Shell Access<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-ssh" aria-label="Anchor link for: sec ssh" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Secure shell (SSH) access to your machine can be enabled by setting:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.openssh.enable" shape="rect"><code class="option">services.openssh.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
  By default, root logins using a password are disallowed. They can be disabled
  entirely by setting <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.openssh.permitRootLogin" shape="rect"><code class="option">services.openssh.permitRootLogin</code></a> to
  <code class="literal">"no"</code>.
 </p><p>
  You can declaratively specify authorised RSA/DSA public keys for a user as
  follows:

</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users._name_.openssh.authorizedKeys.keys" shape="rect">users.users.alice.openssh.authorizedKeys.<span class="hljs-attr"><span class="hljs-attr">keys</span></span></a> =
  [ <span class="hljs-string"><span class="hljs-string">"ssh-dss AAAAB3NzaC1kc3MAAACBAPIkGWVEt4..."</span></span> ];
</pre><p>
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-ipv4" class="title" style="clear: both">12.3.&nbsp;IPv4 Configuration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-ipv4" aria-label="Anchor link for: sec ipv4" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  By default, NixOS uses DHCP (specifically, <span class="command"><strong>dhcpcd</strong></span>) to
  automatically configure network interfaces. However, you can configure an
  interface manually as follows:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.interfaces._name_.ipv4.addresses" shape="rect">networking.interfaces.eth0.ipv4.<span class="hljs-attr"><span class="hljs-attr">addresses</span></span></a> = [ {
  <span class="hljs-attr"><span class="hljs-attr">address</span></span> = <span class="hljs-string"><span class="hljs-string">"192.168.1.2"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">prefixLength</span></span> = <span class="hljs-number"><span class="hljs-number">24</span></span>;
} ];
</pre><p>
  Typically you’ll also want to set a default gateway and set of name
  servers:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.defaultGateway" shape="rect"><code class="option">networking.<span class="hljs-attr"><span class="hljs-attr">defaultGateway</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"192.168.1.1"</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.nameservers" shape="rect"><code class="option">networking.<span class="hljs-attr"><span class="hljs-attr">nameservers</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"8.8.8.8"</span></span> ];
</pre><p>
 </p><div class="alert alert-info"><strong>Note:</strong> 
   Statically configured interfaces are set up by the systemd service
   <em class="replaceable"><code>interface-name</code></em><code class="literal">-cfg.service</code>.
   The default gateway and name server configuration is performed by
   <code class="literal">network-setup.service</code>.
  </div><p>
  The host name is set using <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.hostName" shape="rect"><code class="option">networking.hostName</code></a>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.hostName" shape="rect"><code class="option">networking.<span class="hljs-attr"><span class="hljs-attr">hostName</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"cartman"</span></span>;
</pre><p>
  The default host name is <code class="literal">nixos</code>. Set it to the empty string
  (<code class="literal">""</code>) to allow the DHCP server to provide the host name.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-ipv6" class="title" style="clear: both">12.4.&nbsp;IPv6 Configuration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-ipv6" aria-label="Anchor link for: sec ipv6" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  IPv6 is enabled by default. Stateless address autoconfiguration is used to
  automatically assign IPv6 addresses to all interfaces. You can disable IPv6
  support globally by setting:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.enableIPv6" shape="rect"><code class="option">networking.<span class="hljs-attr"><span class="hljs-attr">enableIPv6</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
</pre><p>
 </p><p>
  You can disable IPv6 on a single interface using a normal sysctl (in this
  example, we use interface <code class="varname">eth0</code>):
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.kernel.sysctl" shape="rect"><code class="option">boot.kernel.sysctl</code></a>.<span class="hljs-string"><span class="hljs-string">"net.ipv6.conf.eth0.disable_ipv6"</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
 </p><p>
  As with IPv4 networking interfaces are automatically configured via DHCPv6.
  You can configure an interface manually:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.interfaces._name_.ipv6.addresses" shape="rect">networking.interfaces.eth0.ipv6.<span class="hljs-attr"><span class="hljs-attr">addresses</span></span></a> = [ {
  <span class="hljs-attr"><span class="hljs-attr">address</span></span> = <span class="hljs-string"><span class="hljs-string">"fe00:aa:bb:cc::2"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">prefixLength</span></span> = <span class="hljs-number"><span class="hljs-number">64</span></span>;
} ];
</pre><p>
 </p><p>
  For configuring a gateway, optionally with explicitly specified interface:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.defaultGateway6" shape="rect"><code class="option">networking.<span class="hljs-attr"><span class="hljs-attr">defaultGateway6</span></span></code></a> = {
  <span class="hljs-attr"><span class="hljs-attr">address</span></span> = <span class="hljs-string"><span class="hljs-string">"fe00::1"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">interface</span></span> = <span class="hljs-string"><span class="hljs-string">"enp0s3"</span></span>;
};
</pre><p>
 </p><p>
  See <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-ipv4" title="12.3. IPv4 Configuration" shape="rect">Section&nbsp;12.3, “IPv4 Configuration”</a> for similar examples and additional
  information.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-firewall" class="title" style="clear: both">12.5.&nbsp;Firewall<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-firewall" aria-label="Anchor link for: sec firewall" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  NixOS has a simple stateful firewall that blocks incoming connections and
  other unexpected packets. The firewall applies to both IPv4 and IPv6 traffic.
  It is enabled by default. It can be disabled as follows:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.firewall.enable" shape="rect"><code class="option">networking.firewall.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
</pre><p>
  If the firewall is enabled, you can open specific TCP ports to the outside
  world:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.firewall.allowedTCPPorts" shape="rect"><code class="option">networking.firewall.<span class="hljs-attr"><span class="hljs-attr">allowedTCPPorts</span></span></code></a> = [ <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ];
</pre><p>
  Note that TCP port 22 (ssh) is opened automatically if the SSH daemon is
  enabled (<code class="option"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.openssh.enable" shape="rect"><code class="option">services.openssh.enable</code></a> =
  true</code>). UDP ports can be opened through
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.firewall.allowedUDPPorts" shape="rect"><code class="option">networking.firewall.allowedUDPPorts</code></a>.
 </p><p>
  To open ranges of TCP ports:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.firewall.allowedTCPPortRanges" shape="rect"><code class="option">networking.firewall.<span class="hljs-attr"><span class="hljs-attr">allowedTCPPortRanges</span></span></code></a> = [
  { <span class="hljs-attr"><span class="hljs-attr">from</span></span> = <span class="hljs-number"><span class="hljs-number">4000</span></span>; <span class="hljs-attr"><span class="hljs-attr">to</span></span> = <span class="hljs-number"><span class="hljs-number">4007</span></span>; }
  { <span class="hljs-attr"><span class="hljs-attr">from</span></span> = <span class="hljs-number"><span class="hljs-number">8000</span></span>; <span class="hljs-attr"><span class="hljs-attr">to</span></span> = <span class="hljs-number"><span class="hljs-number">8010</span></span>; }
];
</pre><p>
  Similarly, UDP port ranges can be opened through
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.firewall.allowedUDPPortRanges" shape="rect"><code class="option">networking.firewall.allowedUDPPortRanges</code></a>.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-wireless" class="title" style="clear: both">12.6.&nbsp;Wireless Networks<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-wireless" aria-label="Anchor link for: sec wireless" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  For a desktop installation using NetworkManager (e.g., GNOME), you just have
  to make sure the user is in the <code class="code">networkmanager</code> group and you can
  skip the rest of this section on wireless networks.
 </p><p>
  NixOS will start wpa_supplicant for you if you enable this setting:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.wireless.enable" shape="rect"><code class="option">networking.wireless.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
  NixOS lets you specify networks for wpa_supplicant declaratively:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.wireless.networks" shape="rect"><code class="option">networking.wireless.<span class="hljs-attr"><span class="hljs-attr">networks</span></span></code></a> = {
  <span class="hljs-attr"><span class="hljs-attr">echelon</span></span> = {                <span class="hljs-comment"><span class="hljs-comment"># SSID with no spaces or special characters</span></span>
    <span class="hljs-attr"><span class="hljs-attr">psk</span></span> = <span class="hljs-string"><span class="hljs-string">"abcdefgh"</span></span>;
  };
  <span class="hljs-string"><span class="hljs-string">"echelon's AP"</span></span> = {         <span class="hljs-comment"><span class="hljs-comment"># SSID with spaces and/or special characters</span></span>
    <span class="hljs-attr"><span class="hljs-attr">psk</span></span> = <span class="hljs-string"><span class="hljs-string">"ijklmnop"</span></span>;
  };
  <span class="hljs-attr"><span class="hljs-attr">echelon</span></span> = {                <span class="hljs-comment"><span class="hljs-comment"># Hidden SSID</span></span>
    <span class="hljs-attr"><span class="hljs-attr">hidden</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">psk</span></span> = <span class="hljs-string"><span class="hljs-string">"qrstuvwx"</span></span>;
  };
  free.<span class="hljs-attr"><span class="hljs-attr">wifi</span></span> = {};            <span class="hljs-comment"><span class="hljs-comment"># Public wireless network</span></span>
};
</pre><p>
  Be aware that keys will be written to the nix store in plaintext! When no
  networks are set, it will default to using a configuration file at
  <code class="literal">/etc/wpa_supplicant.conf</code>. You should edit this file
  yourself to define wireless networks, WPA keys and so on (see <span class="citerefentry"><span class="refentrytitle">wpa_supplicant.conf</span>(5)</span>).
 </p><p>
  If you are using WPA2 you can generate pskRaw key using
  <span class="command"><strong>wpa_passphrase</strong></span>:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>wpa_passphrase ESSID PSK
<span class="hljs-attr"><span class="hljs-attr">network={</span></span>
        <span class="hljs-attr"><span class="hljs-attr">ssid="echelon"</span></span>
        <span class="hljs-comment"><span class="hljs-comment">#psk="abcdefgh"</span></span>
        <span class="hljs-attr"><span class="hljs-attr">psk=dca6d6ed41f4ab5a984c9f55f6f66d4efdc720ebf66959810f4329bb391c5435</span></span>
}
</pre><p>
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.wireless.networks" shape="rect"><code class="option">networking.wireless.<span class="hljs-attr"><span class="hljs-attr">networks</span></span></code></a> = {
  <span class="hljs-attr"><span class="hljs-attr">echelon</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">pskRaw</span></span> = <span class="hljs-string"><span class="hljs-string">"dca6d6ed41f4ab5a984c9f55f6f66d4efdc720ebf66959810f4329bb391c5435"</span></span>;
  };
}
</pre><p>
  or you can use it to directly generate the
  <code class="literal">wpa_supplicant.conf</code>:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">wpa_passphrase ESSID PSK &gt; /etc/wpa_supplicant.conf</span></span></pre><p>
  After you have edited the <code class="literal">wpa_supplicant.conf</code>, you need to
  restart the wpa_supplicant service.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">systemctl restart wpa_supplicant.service</span></span></pre><p>
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="ad-hoc-network-config" class="title" style="clear: both">12.7.&nbsp;Ad-Hoc Configuration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#ad-hoc-network-config" aria-label="Anchor link for: ad hoc network config" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  You can use <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.localCommands" shape="rect"><code class="option">networking.localCommands</code></a> to specify shell
  commands to be run at the end of <code class="literal">network-setup.service</code>.
  This is useful for doing network configuration not covered by the existing
  NixOS modules. For instance, to statically configure an IPv6 address:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.localCommands" shape="rect"><code class="option">networking.<span class="hljs-attr"><span class="hljs-attr">localCommands</span></span></code></a> =
  <span class="hljs-string"><span class="hljs-string">''
    ip -6 addr add 2001:610:685:1::1/64 dev eth0
  ''</span></span>;
</pre><p>
 </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-kernel-config" class="title">Chapter&nbsp;13.&nbsp;Linux Kernel<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-kernel-config" aria-label="Anchor link for: sec kernel config" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-linux-config-customizing" shape="rect">13.1. Customize your kernel</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-linux-config-developing-modules" shape="rect">13.2. Developing kernel modules</a></span></dt></dl></div><p>
  You can override the Linux kernel and associated packages using the option
  <code class="option">boot.kernelPackages</code>. For instance, this selects the Linux
  3.10 kernel:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.kernelPackages" shape="rect"><code class="option">boot.<span class="hljs-attr"><span class="hljs-attr">kernelPackages</span></span></code></a> = pkgs.linuxPackages_3_10;
</pre><p>
  Note that this not only replaces the kernel, but also packages that are
  specific to the kernel version, such as the NVIDIA video drivers. This
  ensures that driver packages are consistent with the kernel.
 </p><p>
  The default Linux kernel configuration should be fine for most users. You can
  see the configuration of your current kernel with the following command:
</p><pre class="programlisting hljs" xml:space="preserve">zcat /proc/config.gz
</pre><p>
  If you want to change the kernel configuration, you can use the
  <code class="option">packageOverrides</code> feature (see
  <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-customising-packages" title="6.1.1. Customising Packages" shape="rect">Section&nbsp;6.1.1, “Customising Packages”</a>). For instance, to enable support
  for the kernel debugger KGDB:
</p><pre class="programlisting hljs nix" xml:space="preserve">nixpkgs.config.<span class="hljs-attr"><span class="hljs-attr">packageOverrides</span></span> = pkgs:
  { <span class="hljs-attr"><span class="hljs-attr">linux_3_4</span></span> = pkgs.linux_3_4.override {
      <span class="hljs-attr"><span class="hljs-attr">extraConfig</span></span> =
        <span class="hljs-string"><span class="hljs-string">''
          KGDB y
        ''</span></span>;
    };
  };
</pre><p>
  <code class="varname">extraConfig</code> takes a list of Linux kernel configuration
  options, one per line. The name of the option should not include the prefix
  <code class="literal">CONFIG_</code>. The option value is typically
  <code class="literal">y</code>, <code class="literal">n</code> or <code class="literal">m</code> (to build
  something as a kernel module).
 </p><p>
  Kernel modules for hardware devices are generally loaded automatically by
  <span class="command"><strong>udev</strong></span>. You can force a module to be loaded via
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.kernelModules" shape="rect"><code class="option">boot.kernelModules</code></a>, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.kernelModules" shape="rect"><code class="option">boot.<span class="hljs-attr"><span class="hljs-attr">kernelModules</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"fuse"</span></span> <span class="hljs-string"><span class="hljs-string">"kvm-intel"</span></span> <span class="hljs-string"><span class="hljs-string">"coretemp"</span></span> ];
</pre><p>
  If the module is required early during the boot (e.g. to mount the root file
  system), you can use <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.initrd.kernelModules" shape="rect"><code class="option">boot.initrd.kernelModules</code></a>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.initrd.kernelModules" shape="rect"><code class="option">boot.initrd.<span class="hljs-attr"><span class="hljs-attr">kernelModules</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"cifs"</span></span> ];
</pre><p>
  This causes the specified modules and their dependencies to be added to the
  initial ramdisk.
 </p><p>
  Kernel runtime parameters can be set through
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.kernel.sysctl" shape="rect"><code class="option">boot.kernel.sysctl</code></a>, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.kernel.sysctl" shape="rect"><code class="option">boot.kernel.sysctl</code></a>.<span class="hljs-string"><span class="hljs-string">"net.ipv4.tcp_keepalive_time"</span></span> = <span class="hljs-number"><span class="hljs-number">120</span></span>;
</pre><p>
  sets the kernel’s TCP keepalive time to 120 seconds. To see the available
  parameters, run <span class="command"><strong>sysctl -a</strong></span>.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="sec-linux-config-customizing" class="title" style="clear: both">13.1.&nbsp;Customize your kernel<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-linux-config-customizing" aria-label="Anchor link for: sec linux config customizing" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   The first step before compiling the kernel is to generate an appropriate
   <code class="literal">.config</code> configuration. Either you pass your own config
   via the <code class="literal">configfile</code> setting of
   <code class="literal">linuxManualConfig</code>:
</p><pre class="screen hljs nix" xml:space="preserve">  <span class="hljs-attr"><span class="hljs-attr">custom-kernel</span></span> = super.linuxManualConfig {
    <span class="hljs-keyword"><span class="hljs-keyword">inherit</span></span> (super) stdenv hostPlatform;
    <span class="hljs-keyword"><span class="hljs-keyword">inherit</span></span> (linux_4_9) src;
    <span class="hljs-attr"><span class="hljs-attr">version</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${linux_4_9.version}</span></span></span><span class="hljs-string">-custom"</span></span>;

    <span class="hljs-attr"><span class="hljs-attr">configfile</span></span> = /home/me/my_kernel_config;
    <span class="hljs-attr"><span class="hljs-attr">allowImportFromDerivation</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  };
  </pre><p>
   You can edit the config with this snippet (by default <span class="command"><strong>make
   menuconfig</strong></span> won't work out of the box on nixos):
</p><pre class="screen hljs nix" xml:space="preserve">      nix-shell -E '<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-built_in"><span class="hljs-built_in">import</span></span> &lt;nixpkgs&gt; {}; kernelToOverride.overrideAttrs (o: {<span class="hljs-attr"><span class="hljs-attr">nativeBuildInputs=o.nativeBuildInputs</span></span> ++ [ pkgconfig ncurses ];})'
  </pre><p>
   or you can let nixpkgs generate the configuration. Nixpkgs generates it via
   answering the interactive kernel utility <span class="command"><strong>make config</strong></span>. The
   answers depend on parameters passed to
   <code class="filename">pkgs/os-specific/linux/kernel/generic.nix</code> (which you
   can influence by overriding <code class="literal">extraConfig, autoModules,
   modDirVersion, preferBuiltin, extraConfig</code>).
</p><pre class="screen hljs nix" xml:space="preserve">
  mptcp93.override ({
      <span class="hljs-attr"><span class="hljs-attr">name="mptcp-local";</span></span>

      <span class="hljs-attr"><span class="hljs-attr">ignoreConfigErrors</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">autoModules</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">kernelPreferBuiltin</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;

      <span class="hljs-attr"><span class="hljs-attr">enableParallelBuilding</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;

      <span class="hljs-attr"><span class="hljs-attr">extraConfig</span></span> = <span class="hljs-string"><span class="hljs-string">''
        DEBUG_KERNEL y
        FRAME_POINTER y
        KGDB y
        KGDB_SERIAL_CONSOLE y
        DEBUG_INFO y
      ''</span></span>;
    });
  </pre><p>
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-linux-config-developing-modules" class="title" style="clear: both">13.2.&nbsp;Developing kernel modules<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-linux-config-developing-modules" aria-label="Anchor link for: sec linux config developing modules" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   When developing kernel modules it's often convenient to run edit-compile-run
   loop as quickly as possible. See below snippet as an example of developing
   <code class="literal">mellanox</code> drivers.
  </p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>nix-build <span class="hljs-string"><span class="hljs-string">'&lt;nixpkgs&gt;'</span></span> -A linuxPackages.kernel.dev
<code class="prompt">$ </code>nix-shell <span class="hljs-string"><span class="hljs-string">'&lt;nixpkgs&gt;'</span></span> -A linuxPackages.kernel
<code class="prompt">$ </code>unpackPhase
<code class="prompt">$ </code><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> linux-*
<code class="prompt">$ </code>make -C <span class="hljs-variable"><span class="hljs-variable">$dev</span></span>/lib/modules/*/build M=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>)/drivers/net/ethernet/mellanox modules
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">insmod ./drivers/net/ethernet/mellanox/mlx5/core/mlx5_core.ko</span></span>
</pre></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="chap-pantheon" class="title">Chapter&nbsp;14.&nbsp;Pantheon Desktop<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#chap-pantheon" aria-label="Anchor link for: chap pantheon" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-pantheon-enable" shape="rect">14.1. Enabling Pantheon</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-pantheon-wingpanel-switchboard" shape="rect">14.2. Wingpanel and Switchboard plugins</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-pantheon-faq" shape="rect">14.3. FAQ</a></span></dt></dl></div><p>
  Pantheon is the desktop environment created for the elementary OS distribution. It is written from scratch in Vala, utilizing GNOME technologies with GTK 3 and Granite.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="sec-pantheon-enable" class="title" style="clear: both">14.1.&nbsp;Enabling Pantheon<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-pantheon-enable" aria-label="Anchor link for: sec pantheon enable" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   All of Pantheon is working in NixOS and the applications should be available, aside from a few <a class="link" href="https://github.com/NixOS/nixpkgs/issues/58161" target="_top" shape="rect">exceptions</a>. To enable Pantheon, set
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.desktopManager.pantheon.enable" shape="rect"><code class="option">services.xserver.desktopManager.pantheon.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
   This automatically enables LightDM and Pantheon's LightDM greeter. If you'd like to disable this, set
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.lightdm.greeters.pantheon.enable" shape="rect"><code class="option">services.xserver.displayManager.lightdm.greeters.pantheon.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.lightdm.enable" shape="rect"><code class="option">services.xserver.displayManager.lightdm.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
</pre><p>
   but please be aware using Pantheon without LightDM as a display manager will break screenlocking from the UI. The NixOS module for Pantheon installs all of Pantheon's default applications. If you'd like to not install Pantheon's apps, set
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.pantheon.apps.enable" shape="rect"><code class="option">services.pantheon.apps.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
</pre><p>
   You can also use <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.pantheon.excludePackages" shape="rect"><code class="option">environment.pantheon.excludePackages</code></a> to remove any other app (like <span class="package">geary</span>).
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-pantheon-wingpanel-switchboard" class="title" style="clear: both">14.2.&nbsp;Wingpanel and Switchboard plugins<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-pantheon-wingpanel-switchboard" aria-label="Anchor link for: sec pantheon wingpanel switchboard" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Wingpanel and Switchboard work differently than they do in other distributions, as far as using plugins. You cannot install a plugin globally (like with <code class="option">environment.systemPackages</code>) to start using it. You should instead be using the following options:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.desktopManager.pantheon.extraWingpanelIndicators" shape="rect"><code class="option">services.xserver.desktopManager.pantheon.extraWingpanelIndicators</code></a>
     </p></li><li class="listitem"><p>
      <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.desktopManager.pantheon.extraSwitchboardPlugs" shape="rect"><code class="option">services.xserver.desktopManager.pantheon.extraSwitchboardPlugs</code></a>
     </p></li></ul></div><p>
   to configure the programs with plugs or indicators.
  </p><p>
   The difference in NixOS is both these programs are patched to load plugins from a directory that is the value of an environment variable. All of which is controlled in Nix. If you need to configure the particular packages manually you can override the packages like:
</p><pre class="programlisting hljs nix" xml:space="preserve">wingpanel-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-indicators.override {
  <span class="hljs-attr"><span class="hljs-attr">indicators</span></span> = [
    pkgs.some-special-indicator
  ];
};

switchboard-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-plugs.override {
  <span class="hljs-attr"><span class="hljs-attr">plugs</span></span> = [
    pkgs.some-special-plug
  ];
};
</pre><p>
   please note that, like how the NixOS options describe these as extra plugins, this would only add to the default plugins included with the programs. If for some reason you'd like to configure which plugins to use exactly, both packages have an argument for this:
</p><pre class="programlisting hljs nix" xml:space="preserve">wingpanel-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-indicators.override {
  <span class="hljs-attr"><span class="hljs-attr">useDefaultIndicators</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">indicators</span></span> = specialListOfIndicators;
};

switchboard-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-plugs.override {
  <span class="hljs-attr"><span class="hljs-attr">useDefaultPlugs</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">plugs</span></span> = specialListOfPlugs;
};
</pre><p>
   this could be most useful for testing a particular plug-in in isolation.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-pantheon-faq" class="title" style="clear: both">14.3.&nbsp;FAQ<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-pantheon-faq" aria-label="Anchor link for: sec pantheon faq" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="variablelist"><dl class="variablelist"><dt><a id="sec-pantheon-faq-messed-up-theme" shape="rect"></a><span class="term">
     I have switched from a different desktop and Pantheon’s theming looks messed up.
    </span></dt><dd><p>
      Open Switchboard and go to: <span class="guilabel">Administration</span> → <span class="guilabel">About</span> → <span class="guilabel">Restore Default Settings</span> → <span class="guibutton">Restore Settings</span>. This will reset any dconf settings to their Pantheon defaults. Note this could reset certain GNOME specific preferences if that desktop was used prior.
     </p></dd><dt><a id="sec-pantheon-faq-gnome3-and-pantheon" shape="rect"></a><span class="term">
     I cannot enable both GNOME 3 and Pantheon.
    </span></dt><dd><p>
      This is a known <a class="link" href="https://github.com/NixOS/nixpkgs/issues/64611" target="_top" shape="rect">issue</a> and there is no known workaround.
     </p></dd><dt><a id="sec-pantheon-faq-appcenter" shape="rect"></a><span class="term">
     Does AppCenter work, or is it available?
    </span></dt><dd><p>
      AppCenter has been available since 20.03, but it is of little use. This is because there is no functioning PackageKit backend for Nix 2.0. In the near future you will be able to install Flatpak applications from AppCenter on NixOS. See this <a class="link" href="https://github.com/NixOS/nixpkgs/issues/70214" target="_top" shape="rect">issue</a>.
     </p></dd></dl></div></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-matomo" class="title">Chapter&nbsp;15.&nbsp;Matomo<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-matomo" aria-label="Anchor link for: module services matomo" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-matomo-database-setup" shape="rect">15.1. Database Setup</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-matomo-archive-processing" shape="rect">15.2. Archive Processing</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-matomo-backups" shape="rect">15.3. Backup</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-matomo-issues" shape="rect">15.4. Issues</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-matomo-other-web-servers" shape="rect">15.5. Using other Web Servers than nginx</a></span></dt></dl></div><p>
  Matomo is a real-time web analytics application. This module configures
  php-fpm as backend for Matomo, optionally configuring an nginx vhost as well.
 </p><p>
  An automatic setup is not suported by Matomo, so you need to configure Matomo
  itself in the browser-based Matomo setup.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-matomo-database-setup" class="title" style="clear: both">15.1.&nbsp;Database Setup<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-matomo-database-setup" aria-label="Anchor link for: module services matomo database setup" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   You also need to configure a MariaDB or MySQL database and -user for Matomo
   yourself, and enter those credentials in your browser. You can use
   passwordless database authentication via the UNIX_SOCKET authentication
   plugin with the following SQL commands:
</p><pre class="programlisting hljs bash" xml:space="preserve"><span class="hljs-comment"><span class="hljs-comment"># For MariaDB</span></span>
INSTALL PLUGIN unix_socket SONAME <span class="hljs-string"><span class="hljs-string">'auth_socket'</span></span>;
CREATE DATABASE matomo;
CREATE USER <span class="hljs-string"><span class="hljs-string">'matomo'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> IDENTIFIED WITH unix_socket;
GRANT ALL PRIVILEGES ON matomo.* TO <span class="hljs-string"><span class="hljs-string">'matomo'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>;

<span class="hljs-comment"><span class="hljs-comment"># For MySQL</span></span>
INSTALL PLUGIN auth_socket SONAME <span class="hljs-string"><span class="hljs-string">'auth_socket.so'</span></span>;
CREATE DATABASE matomo;
CREATE USER <span class="hljs-string"><span class="hljs-string">'matomo'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> IDENTIFIED WITH auth_socket;
GRANT ALL PRIVILEGES ON matomo.* TO <span class="hljs-string"><span class="hljs-string">'matomo'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>;
</pre><p>
   Then fill in <code class="literal">matomo</code> as database user and database name,
   and leave the password field blank. This authentication works by allowing
   only the <code class="literal">matomo</code> unix user to authenticate as the
   <code class="literal">matomo</code> database user (without needing a password), but no
   other users. For more information on passwordless login, see
   <a class="link" href="https://mariadb.com/kb/en/mariadb/unix_socket-authentication-plugin/" target="_top" shape="rect">https://mariadb.com/kb/en/mariadb/unix_socket-authentication-plugin/</a>.
  </p><p>
   Of course, you can use password based authentication as well, e.g. when the
   database is not on the same host.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-matomo-archive-processing" class="title" style="clear: both">15.2.&nbsp;Archive Processing<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-matomo-archive-processing" aria-label="Anchor link for: module services matomo archive processing" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   This module comes with the systemd service
   <code class="literal">matomo-archive-processing.service</code> and a timer that
   automatically triggers archive processing every hour. This means that you
   can safely
   <a class="link" href="https://matomo.org/docs/setup-auto-archiving/#disable-browser-triggers-for-matomo-archiving-and-limit-matomo-reports-to-updating-every-hour" target="_top" shape="rect">
   disable browser triggers for Matomo archiving </a> at
   <code class="literal">Administration &gt; System &gt; General Settings</code>.
  </p><p>
   With automatic archive processing, you can now also enable to
   <a class="link" href="https://matomo.org/docs/privacy/#step-2-delete-old-visitors-logs" target="_top" shape="rect">
   delete old visitor logs </a> at <code class="literal">Administration &gt; System &gt;
   Privacy</code>, but make sure that you run <code class="literal">systemctl start
   matomo-archive-processing.service</code> at least once without errors if
   you have already collected data before, so that the reports get archived
   before the source data gets deleted.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-matomo-backups" class="title" style="clear: both">15.3.&nbsp;Backup<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-matomo-backups" aria-label="Anchor link for: module services matomo backups" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   You only need to take backups of your MySQL database and the
   <code class="filename">/var/lib/matomo/config/config.ini.php</code> file. Use a user
   in the <code class="literal">matomo</code> group or root to access the file. For more
   information, see
   <a class="link" href="https://matomo.org/faq/how-to-install/faq_138/" target="_top" shape="rect">https://matomo.org/faq/how-to-install/faq_138/</a>.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-matomo-issues" class="title" style="clear: both">15.4.&nbsp;Issues<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-matomo-issues" aria-label="Anchor link for: module services matomo issues" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Matomo will warn you that the JavaScript tracker is not writable. This is
     because it's located in the read-only nix store. You can safely ignore
     this, unless you need a plugin that needs JavaScript tracker access.
    </p></li></ul></div></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-matomo-other-web-servers" class="title" style="clear: both">15.5.&nbsp;Using other Web Servers than nginx<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-matomo-other-web-servers" aria-label="Anchor link for: module services matomo other web servers" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   You can use other web servers by forwarding calls for
   <code class="filename">index.php</code> and <code class="filename">piwik.php</code> to the
   <code class="literal"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.phpfpm.pools._name_.socket" shape="rect">services.phpfpm.pools.&lt;name&gt;.socket</a></code> fastcgi unix socket. You can use
   the nginx configuration in the module code as a reference to what else
   should be configured.
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-nextcloud" class="title">Chapter&nbsp;16.&nbsp;Nextcloud<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud" aria-label="Anchor link for: module services nextcloud" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-nextcloud-basic-usage" shape="rect">16.1. Basic usage</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-nextcloud-pitfalls-during-upgrade" shape="rect">16.2. Pitfalls</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-nextcloud-httpd" shape="rect">16.3. Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-nextcloud-maintainer-info" shape="rect">16.4. Maintainer information</a></span></dt></dl></div><p>
  <a class="link" href="https://nextcloud.com/" target="_top" shape="rect">Nextcloud</a> is an open-source,
  self-hostable cloud platform. The server setup can be automated using
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.enable" shape="rect">services.nextcloud</a>. A
  desktop client is packaged at <code class="literal">pkgs.nextcloud-client</code>.
 </p><p>
  The current default by NixOS is <span class="package">nextcloud19</span> though it's recommended
  to upgrade to the latest version, <span class="package">nextcloud20</span>.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-nextcloud-basic-usage" class="title" style="clear: both">16.1.&nbsp;Basic usage<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud-basic-usage" aria-label="Anchor link for: module services nextcloud basic usage" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Nextcloud is a PHP-based application which requires an HTTP server
   (<code class="literal"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.enable" shape="rect">services.nextcloud</a></code>
   optionally supports
   <code class="literal"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.enable" shape="rect">services.nginx</a></code>)
   and a database (it's recommended to use
   <code class="literal"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.enable" shape="rect">services.postgresql</a></code>).
  </p><p>
   A very basic configuration may look like this:
</p><pre class="programlisting hljs nix" xml:space="preserve">{ pkgs, ... }:
{
  services.<span class="hljs-attr"><span class="hljs-attr">nextcloud</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.hostName" shape="rect"><span class="hljs-attr"><span class="hljs-attr">hostName</span></span></a> = <span class="hljs-string"><span class="hljs-string">"nextcloud.tld"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">config</span></span> = {
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.config.dbtype" shape="rect"><span class="hljs-attr"><span class="hljs-attr">dbtype</span></span></a> = <span class="hljs-string"><span class="hljs-string">"pgsql"</span></span>;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.config.dbuser" shape="rect"><span class="hljs-attr"><span class="hljs-attr">dbuser</span></span></a> = <span class="hljs-string"><span class="hljs-string">"nextcloud"</span></span>;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.config.dbhost" shape="rect"><span class="hljs-attr"><span class="hljs-attr">dbhost</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/run/postgresql"</span></span>; <span class="hljs-comment"><span class="hljs-comment"># nextcloud will add /.s.PGSQL.5432 by itself</span></span>
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.config.dbname" shape="rect"><span class="hljs-attr"><span class="hljs-attr">dbname</span></span></a> = <span class="hljs-string"><span class="hljs-string">"nextcloud"</span></span>;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.config.adminpassFile" shape="rect"><span class="hljs-attr"><span class="hljs-attr">adminpassFile</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/path/to/admin-pass-file"</span></span>;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.config.adminuser" shape="rect"><span class="hljs-attr"><span class="hljs-attr">adminuser</span></span></a> = <span class="hljs-string"><span class="hljs-string">"root"</span></span>;
    };
  };

  services.<span class="hljs-attr"><span class="hljs-attr">postgresql</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.ensureDatabases" shape="rect"><span class="hljs-attr"><span class="hljs-attr">ensureDatabases</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"nextcloud"</span></span> ];
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.ensureUsers" shape="rect"><span class="hljs-attr"><span class="hljs-attr">ensureUsers</span></span></a> = [
     { <span class="hljs-attr"><span class="hljs-attr">name</span></span> = <span class="hljs-string"><span class="hljs-string">"nextcloud"</span></span>;
       ensurePermissions.<span class="hljs-string"><span class="hljs-string">"DATABASE nextcloud"</span></span> = <span class="hljs-string"><span class="hljs-string">"ALL PRIVILEGES"</span></span>;
     }
    ];
  };

  <span class="hljs-comment"><span class="hljs-comment"># ensure that postgres is running *before* running the setup</span></span>
  systemd.services.<span class="hljs-string"><span class="hljs-string">"nextcloud-setup"</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">requires</span></span> = [<span class="hljs-string"><span class="hljs-string">"postgresql.service"</span></span>];
    <span class="hljs-attr"><span class="hljs-attr">after</span></span> = [<span class="hljs-string"><span class="hljs-string">"postgresql.service"</span></span>];
  };

  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.firewall.allowedTCPPorts" shape="rect">networking.firewall.<span class="hljs-attr"><span class="hljs-attr">allowedTCPPorts</span></span></a> = [ <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ];
}</pre><p>
  </p><p>
   The <code class="literal">hostName</code> option is used internally to configure an HTTP
   server using <code class="literal"><a class="link" href="https://php-fpm.org/" target="_top" shape="rect">PHP-FPM</a></code>
   and <code class="literal">nginx</code>. The <code class="literal">config</code> attribute set is
   used by the imperative installer and all values are written to an additional file
   to ensure that changes can be applied by changing the module's options.
  </p><p>
   In case the application serves multiple domains (those are checked with
   <code class="literal"><a class="link" href="http://php.net/manual/en/reserved.variables.server.php" target="_top" shape="rect">$_SERVER['HTTP_HOST']</a></code>)
   it's needed to add them to
   <code class="literal"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.config.extraTrustedDomains" shape="rect">services.nextcloud.config.extraTrustedDomains</a></code>.
  </p><p>
   Auto updates for Nextcloud apps can be enabled using
   <code class="literal"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.autoUpdateApps.enable" shape="rect">services.nextcloud.autoUpdateApps</a></code>.
</p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-nextcloud-pitfalls-during-upgrade" class="title" style="clear: both">16.2.&nbsp;Pitfalls<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud-pitfalls-during-upgrade" aria-label="Anchor link for: module services nextcloud pitfalls during upgrade" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Unfortunately Nextcloud appears to be very stateful when it comes to
   managing its own configuration. The config file lives in the home directory
   of the <code class="literal">nextcloud</code> user (by default
   <code class="literal">/var/lib/nextcloud/config/config.php</code>) and is also used to
   track several states of the application (e.g. whether installed or not).
  </p><p>
   All configuration parameters are also stored in
   <code class="literal">/var/lib/nextcloud/config/override.config.php</code> which is generated by
   the module and linked from the store to ensure that all values from <code class="literal">config.php</code>
   can be modified by the module.
   However <code class="literal">config.php</code> manages the application's state and shouldn't be touched
   manually because of that.
  </p><div class="alert alert-warning"><strong>Warning:</strong> Don't delete <code class="literal">config.php</code>! This file
   tracks the application's state and a deletion can cause unwanted
   side-effects!</div><div class="alert alert-warning"><strong>Warning:</strong> Don't rerun <code class="literal">nextcloud-occ
   maintenance:install</code>! This command tries to install the application
   and can cause unwanted side-effects!</div><p>
   Nextcloud doesn't allow to move more than one major-version forward. If you're e.g. on
   <code class="literal">v16</code>, you cannot upgrade to <code class="literal">v18</code>, you need to upgrade to
   <code class="literal">v17</code> first. This is ensured automatically as long as the
   <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-system.stateVersion" shape="rect">stateVersion</a> is declared properly. In that case
   the oldest version available (one major behind the one from the previous NixOS
   release) will be selected by default and the module will generate a warning that reminds
   the user to upgrade to latest Nextcloud <span class="emphasis"><em>after</em></span> that deploy.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-nextcloud-httpd" class="title" style="clear: both">16.3.&nbsp;Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud-httpd" aria-label="Anchor link for: module services nextcloud httpd" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   By default, <span class="package">nginx</span> is used as reverse-proxy for <span class="package">nextcloud</span>.
   However, it's possible to use e.g. <span class="package">httpd</span> by explicitly disabling
   <span class="package">nginx</span> using <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.enable" shape="rect"><code class="option">services.nginx.enable</code></a> and fixing the
   settings <code class="literal">listen.owner</code> &amp; <code class="literal">listen.group</code> in the
   <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.phpfpm.pools" shape="rect">corresponding <code class="literal">phpfpm</code> pool</a>.
  </p><p>
   An exemplary configuration may look like this:
</p><pre class="programlisting hljs nix" xml:space="preserve">{ config, lib, pkgs, ... }: {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.enable" shape="rect">services.nginx.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
  services.<span class="hljs-attr"><span class="hljs-attr">nextcloud</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.hostName" shape="rect"><span class="hljs-attr"><span class="hljs-attr">hostName</span></span></a> = <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>;

    <span class="hljs-comment"><span class="hljs-comment">/* further, required options */</span></span>
  };
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.phpfpm.pools._name_.settings" shape="rect">services.phpfpm.pools.nextcloud.<span class="hljs-attr"><span class="hljs-attr">settings</span></span></a> = {
    <span class="hljs-string"><span class="hljs-string">"listen.owner"</span></span> = config.services.httpd.user;
    <span class="hljs-string"><span class="hljs-string">"listen.group"</span></span> = config.services.httpd.group;
  };
  services.<span class="hljs-attr"><span class="hljs-attr">httpd</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.adminAddr" shape="rect"><span class="hljs-attr"><span class="hljs-attr">adminAddr</span></span></a> = <span class="hljs-string"><span class="hljs-string">"webmaster@localhost"</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.extraModules" shape="rect"><span class="hljs-attr"><span class="hljs-attr">extraModules</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"proxy_fcgi"</span></span> ];
    virtualHosts.<span class="hljs-string"><span class="hljs-string">"localhost"</span></span> = {
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.virtualHosts._name_.documentRoot" shape="rect"><span class="hljs-attr"><span class="hljs-attr">documentRoot</span></span></a> = config.services.nextcloud.package;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.virtualHosts._name_.extraConfig" shape="rect"><span class="hljs-attr"><span class="hljs-attr">extraConfig</span></span></a> = <span class="hljs-string"><span class="hljs-string">''
        &lt;Directory "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${config.services.nextcloud.package}</span></span></span><span class="hljs-string">"&gt;
          &lt;FilesMatch "\.php$"&gt;
            &lt;If "-f %{REQUEST_FILENAME}"&gt;
              SetHandler "proxy:unix:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${config.services.phpfpm.pools.nextcloud.socket}</span></span></span><span class="hljs-string">|fcgi://localhost/"
            &lt;/If&gt;
          &lt;/FilesMatch&gt;
          &lt;IfModule mod_rewrite.c&gt;
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.php$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.php [L]
          &lt;/IfModule&gt;
          DirectoryIndex index.php
          Require all granted
          Options +FollowSymLinks
        &lt;/Directory&gt;
      ''</span></span>;
    };
  };
}</pre><p>
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-nextcloud-maintainer-info" class="title" style="clear: both">16.4.&nbsp;Maintainer information<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud-maintainer-info" aria-label="Anchor link for: module services nextcloud maintainer info" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   As stated in the previous paragraph, we must provide a clean upgrade-path for Nextcloud
   since it cannot move more than one major version forward on a single upgrade. This chapter
   adds some notes how Nextcloud updates should be rolled out in the future.
  </p><p>
   While minor and patch-level updates are no problem and can be done directly in the
   package-expression (and should be backported to supported stable branches after that),
   major-releases should be added in a new attribute (e.g. Nextcloud <code class="literal">v19.0.0</code>
   should be available in <code class="literal">nixpkgs</code> as <code class="literal">pkgs.nextcloud19</code>).
   To provide simple upgrade paths it's generally useful to backport those as well to stable
   branches. As long as the package-default isn't altered, this won't break existing setups.
   After that, the versioning-warning in the <code class="literal">nextcloud</code>-module should be
   updated to make sure that the
   <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nextcloud.package" shape="rect">package</a>-option selects the latest version
   on fresh setups.
  </p><p>
   If major-releases will be abandoned by upstream, we should check first if those are needed
   in NixOS for a safe upgrade-path before removing those. In that case we shold keep those
   packages, but mark them as insecure in an expression like this (in
   <code class="literal">&lt;nixpkgs/pkgs/servers/nextcloud/default.nix&gt;</code>):
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span>
{
  <span class="hljs-attr"><span class="hljs-attr">nextcloud17</span></span> = generic {
    <span class="hljs-attr"><span class="hljs-attr">version</span></span> = <span class="hljs-string"><span class="hljs-string">"17.0.x"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">sha256</span></span> = <span class="hljs-string"><span class="hljs-string">"0000000000000000000000000000000000000000000000000000"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">eol</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  };
}</pre><p>
  </p><p>
   Ideally we should make sure that it's possible to jump two NixOS versions forward:
   i.e. the warnings and the logic in the module should guard a user to upgrade from a
   Nextcloud on e.g. 19.09 to a Nextcloud on 20.09.
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-jitsi-meet" class="title">Chapter&nbsp;17.&nbsp;Jitsi Meet<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-jitsi-meet" aria-label="Anchor link for: module services jitsi meet" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-jitsi-basic-usage" shape="rect">17.1. Basic usage</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-jitsi-configuration" shape="rect">17.2. Configuration</a></span></dt></dl></div><p>
   With Jitsi Meet on NixOS you can quickly configure a complete,
   private, self-hosted video conferencing solution.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-jitsi-basic-usage" class="title" style="clear: both">17.1.&nbsp;Basic usage<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-jitsi-basic-usage" aria-label="Anchor link for: module services jitsi basic usage" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
     A minimal configuration using Let's Encrypt for TLS certificates looks like this:
</p><pre class="programlisting hljs nix" xml:space="preserve">{
  services.<span class="hljs-attr"><span class="hljs-attr">jitsi-meet</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.jitsi-meet.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.jitsi-meet.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">hostName</span></span></a> = <span class="hljs-string"><span class="hljs-string">"jitsi.example.com"</span></span>;
  };
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.jitsi-videobridge.openFirewall" shape="rect">services.jitsi-videobridge.<span class="hljs-attr"><span class="hljs-attr">openFirewall</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.firewall.allowedTCPPorts" shape="rect">networking.firewall.<span class="hljs-attr"><span class="hljs-attr">allowedTCPPorts</span></span></a> = [ <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ];
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.email" shape="rect">security.acme.<span class="hljs-attr"><span class="hljs-attr">email</span></span></a> = <span class="hljs-string"><span class="hljs-string">"me@example.com"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.acceptTerms" shape="rect">security.acme.<span class="hljs-attr"><span class="hljs-attr">acceptTerms</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
}</pre><p>
   </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-jitsi-configuration" class="title" style="clear: both">17.2.&nbsp;Configuration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-jitsi-configuration" aria-label="Anchor link for: module services jitsi configuration" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
     Here is the minimal configuration with additional configurations:
</p><pre class="programlisting hljs nix" xml:space="preserve">{
  services.<span class="hljs-attr"><span class="hljs-attr">jitsi-meet</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.jitsi-meet.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.jitsi-meet.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">hostName</span></span></a> = <span class="hljs-string"><span class="hljs-string">"jitsi.example.com"</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.jitsi-meet.config" shape="rect"><span class="hljs-attr"><span class="hljs-attr">config</span></span></a> = {
      <span class="hljs-attr"><span class="hljs-attr">enableWelcomePage</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">prejoinPageEnabled</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">defaultLang</span></span> = <span class="hljs-string"><span class="hljs-string">"fi"</span></span>;
    };
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.jitsi-meet.interfaceConfig" shape="rect"><span class="hljs-attr"><span class="hljs-attr">interfaceConfig</span></span></a> = {
      <span class="hljs-attr"><span class="hljs-attr">SHOW_JITSI_WATERMARK</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">SHOW_WATERMARK_FOR_GUESTS</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
    };
  };
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.jitsi-videobridge.openFirewall" shape="rect">services.jitsi-videobridge.<span class="hljs-attr"><span class="hljs-attr">openFirewall</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.firewall.allowedTCPPorts" shape="rect">networking.firewall.<span class="hljs-attr"><span class="hljs-attr">allowedTCPPorts</span></span></a> = [ <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ];
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.email" shape="rect">security.acme.<span class="hljs-attr"><span class="hljs-attr">email</span></span></a> = <span class="hljs-string"><span class="hljs-string">"me@example.com"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.acceptTerms" shape="rect">security.acme.<span class="hljs-attr"><span class="hljs-attr">acceptTerms</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
}</pre><p>
   </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-grocy" class="title">Chapter&nbsp;18.&nbsp;Grocy<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-grocy" aria-label="Anchor link for: module services grocy" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-grocy-basic-usage" shape="rect">18.1. Basic usage</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-grocy-settings" shape="rect">18.2. Settings</a></span></dt></dl></div><p>
    <a class="link" href="https://grocy.info/" target="_top" shape="rect">Grocy</a> is a web-based self-hosted groceries
    &amp; household management solution for your home.
  </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-grocy-basic-usage" class="title" style="clear: both">18.1.&nbsp;Basic usage<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-grocy-basic-usage" aria-label="Anchor link for: module services grocy basic usage" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
    A very basic configuration may look like this:
</p><pre class="programlisting hljs nix" xml:space="preserve">{ pkgs, ... }:
{
  services.<span class="hljs-attr"><span class="hljs-attr">grocy</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.grocy.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.grocy.hostName" shape="rect"><span class="hljs-attr"><span class="hljs-attr">hostName</span></span></a> = <span class="hljs-string"><span class="hljs-string">"grocy.tld"</span></span>;
  };
}</pre><p>
    This configures a simple vhost using <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.enable" shape="rect">nginx</a>
    which listens to <code class="literal">grocy.tld</code> with fully configured ACME/LE (this can be
    disabled by setting <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.grocy.nginx.enableSSL" shape="rect">services.grocy.nginx.enableSSL</a>
    to <code class="literal">false</code>). After the initial setup the credentials <code class="literal">admin:admin</code>
    can be used to login.
   </p><p>
    The application's state is persisted at <code class="literal">/var/lib/grocy/grocy.db</code> in a
    <span class="package">sqlite3</span> database. The migration is applied when requesting the <code class="literal">/</code>-route
    of the application.
   </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-grocy-settings" class="title" style="clear: both">18.2.&nbsp;Settings<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-grocy-settings" aria-label="Anchor link for: module services grocy settings" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
    The configuration for <code class="literal">grocy</code> is located at <code class="literal">/etc/grocy/config.php</code>.
    By default, the following settings can be defined in the NixOS-configuration:
</p><pre class="programlisting hljs nix" xml:space="preserve">{ pkgs, ... }:
{
  services.grocy.<span class="hljs-attr"><span class="hljs-attr">settings</span></span> = {
    <span class="hljs-comment"><span class="hljs-comment"># The default currency in the system for invoices etc.</span></span>
    <span class="hljs-comment"><span class="hljs-comment"># Please note that exchange rates aren't taken into account, this</span></span>
    <span class="hljs-comment"><span class="hljs-comment"># is just the setting for what's shown in the frontend.</span></span>
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.grocy.settings.currency" shape="rect"><span class="hljs-attr"><span class="hljs-attr">currency</span></span></a> = <span class="hljs-string"><span class="hljs-string">"EUR"</span></span>;

    <span class="hljs-comment"><span class="hljs-comment"># The display language (and locale configuration) for grocy.</span></span>
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.grocy.settings.currency" shape="rect"><span class="hljs-attr"><span class="hljs-attr">culture</span></span></a> = <span class="hljs-string"><span class="hljs-string">"de"</span></span>;

    <span class="hljs-attr"><span class="hljs-attr">calendar</span></span> = {
      <span class="hljs-comment"><span class="hljs-comment"># Whether or not to show the week-numbers</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># in the calendar.</span></span>
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.grocy.settings.calendar.showWeekNumber" shape="rect"><span class="hljs-attr"><span class="hljs-attr">showWeekNumber</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;

      <span class="hljs-comment"><span class="hljs-comment"># Index of the first day to be shown in the calendar (0=Sunday, 1=Monday,</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># 2=Tuesday and so on).</span></span>
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.grocy.settings.calendar.firstDayOfWeek" shape="rect"><span class="hljs-attr"><span class="hljs-attr">firstDayOfWeek</span></span></a> = <span class="hljs-number"><span class="hljs-number">2</span></span>;
    };
  };
}</pre><p>
   </p><p>
    If you want to alter the configuration file on your own, you can do this manually with
    an expression like this:
</p><pre class="programlisting hljs bash" xml:space="preserve">{ lib, ... }:
{
  environment.etc.<span class="hljs-string"><span class="hljs-string">"grocy/config.php"</span></span>.text = lib.mkAfter <span class="hljs-string"><span class="hljs-string">''</span></span>
    // Arbitrary PHP code <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> grocy<span class="hljs-string"><span class="hljs-string">'s configuration file
  '</span></span><span class="hljs-string"><span class="hljs-string">';
}</span></span></pre><p>
   </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-networking-yggdrasil" class="title">Chapter&nbsp;19.&nbsp;Yggdrasil<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil" aria-label="Anchor link for: module services networking yggdrasil" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-networking-yggdrasil-configuration" shape="rect">19.1. Configuration</a></span></dt></dl></div><p>
    <span class="emphasis"><em>Source:</em></span>
    <code class="filename">modules/services/networking/yggdrasil/default.nix</code>
  </p><p>
    <span class="emphasis"><em>Upstream documentation:</em></span>
    <a class="link" href="https://yggdrasil-network.github.io/" target="_top" shape="rect">https://yggdrasil-network.github.io/</a>
  </p><p>
Yggdrasil is an early-stage implementation of a fully end-to-end encrypted,
self-arranging IPv6 network.
</p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-networking-yggdrasil-configuration" class="title" style="clear: both">19.1.&nbsp;Configuration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil-configuration" aria-label="Anchor link for: module services networking yggdrasil configuration" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><section class="section"><div class="titlepage"><div><div><h3 id="module-services-networking-yggdrasil-configuration-simple" class="title">19.1.1.&nbsp;Simple ephemeral node<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil-configuration-simple" aria-label="Anchor link for: module services networking yggdrasil configuration simple" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
An annotated example of a simple configuration:
</p><pre class="programlisting hljs nix" xml:space="preserve">{
  services.<span class="hljs-attr"><span class="hljs-attr">yggdrasil</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">persistentKeys</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
      <span class="hljs-comment"><span class="hljs-comment"># The NixOS module will generate new keys and a new IPv6 address each time</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># it is started if persistentKeys is not enabled.</span></span>

    <span class="hljs-attr"><span class="hljs-attr">config</span></span> = {
      <span class="hljs-attr"><span class="hljs-attr">Peers</span></span> = [
        <span class="hljs-comment"><span class="hljs-comment"># Yggdrasil will automatically connect and "peer" with other nodes it</span></span>
        <span class="hljs-comment"><span class="hljs-comment"># discovers via link-local multicast annoucements. Unless this is the</span></span>
        <span class="hljs-comment"><span class="hljs-comment"># case (it probably isn't) a node needs peers within the existing</span></span>
        <span class="hljs-comment"><span class="hljs-comment"># network that it can tunnel to.</span></span>
        <span class="hljs-string"><span class="hljs-string">"tcp://1.2.3.4:1024"</span></span>
        <span class="hljs-string"><span class="hljs-string">"tcp://1.2.3.5:1024"</span></span>
        <span class="hljs-comment"><span class="hljs-comment"># Public peers can be found at</span></span>
        <span class="hljs-comment"><span class="hljs-comment"># https://github.com/yggdrasil-network/public-peers</span></span>
      ];
    };
  };
}
</pre><p>
   </p></section><section class="section"><div class="titlepage"><div><div><h3 id="module-services-networking-yggdrasil-configuration-prefix" class="title">19.1.2.&nbsp;Persistent node with prefix<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil-configuration-prefix" aria-label="Anchor link for: module services networking yggdrasil configuration prefix" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
A node with a fixed address that announces a prefix:
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
  <span class="hljs-attr"><span class="hljs-attr">address</span></span> = <span class="hljs-string"><span class="hljs-string">"210:5217:69c0:9afc:1b95:b9f:8718:c3d2"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">prefix</span></span> = <span class="hljs-string"><span class="hljs-string">"310:5217:69c0:9afc"</span></span>;
  <span class="hljs-comment"><span class="hljs-comment"># taken from the output of "yggdrasilctl getself".</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {

  services.<span class="hljs-attr"><span class="hljs-attr">yggdrasil</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">persistentKeys</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment"># Maintain a fixed public key and IPv6 address.</span></span>
    <span class="hljs-attr"><span class="hljs-attr">config</span></span> = {
      <span class="hljs-attr"><span class="hljs-attr">Peers</span></span> = [ <span class="hljs-string"><span class="hljs-string">"tcp://1.2.3.4:1024"</span></span> <span class="hljs-string"><span class="hljs-string">"tcp://1.2.3.5:1024"</span></span> ];
      <span class="hljs-attr"><span class="hljs-attr">NodeInfo</span></span> = {
        <span class="hljs-comment"><span class="hljs-comment"># This information is visible to the network.</span></span>
        <span class="hljs-attr"><span class="hljs-attr">name</span></span> = config.networking.hostName;
        <span class="hljs-attr"><span class="hljs-attr">location</span></span> = <span class="hljs-string"><span class="hljs-string">"The North Pole"</span></span>;
      };
    };
  };

  boot.kernel.sysctl.<span class="hljs-string"><span class="hljs-string">"net.ipv6.conf.all.forwarding"</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>;
    <span class="hljs-comment"><span class="hljs-comment"># Forward traffic under the prefix.</span></span>

  networking.interfaces.${eth0}.ipv6.<span class="hljs-attr"><span class="hljs-attr">addresses</span></span> = [{
    <span class="hljs-comment"><span class="hljs-comment"># Set a 300::/8 address on the local physical device.</span></span>
    <span class="hljs-attr"><span class="hljs-attr">address</span></span> = prefix + <span class="hljs-string"><span class="hljs-string">"::1"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">prefixLength</span></span> = <span class="hljs-number"><span class="hljs-number">64</span></span>;
  }];

  services.<span class="hljs-attr"><span class="hljs-attr">radvd</span></span> = {
    <span class="hljs-comment"><span class="hljs-comment"># Annouce the 300::/8 prefix to eth0.</span></span>
    <span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">config</span></span> = <span class="hljs-string"><span class="hljs-string">''
      interface eth0
      {
        AdvSendAdvert on;
        AdvDefaultLifetime 0;
        prefix </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${prefix}</span></span></span><span class="hljs-string">::/64 {
          AdvOnLink on;
          AdvAutonomous on;
        };
        route 200::/8 {};
      };
    ''</span></span>;
  };
}
</pre><p>
  </p></section><section class="section"><div class="titlepage"><div><div><h3 id="module-services-networking-yggdrasil-configuration-container" class="title">19.1.3.&nbsp;Yggdrasil attached Container<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil-configuration-container" aria-label="Anchor link for: module services networking yggdrasil configuration container" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
A NixOS container attached to the Yggdrasil network via a node running on the
host:
        </p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
  <span class="hljs-attr"><span class="hljs-attr">yggPrefix64</span></span> = <span class="hljs-string"><span class="hljs-string">"310:5217:69c0:9afc"</span></span>;
    <span class="hljs-comment"><span class="hljs-comment"># Again, taken from the output of "yggdrasilctl getself".</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>
{
  boot.kernel.sysctl.<span class="hljs-string"><span class="hljs-string">"net.ipv6.conf.all.forwarding"</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>;
  <span class="hljs-comment"><span class="hljs-comment"># Enable IPv6 forwarding.</span></span>

  <span class="hljs-attr"><span class="hljs-attr">networking</span></span> = {
    bridges.br0.<span class="hljs-attr"><span class="hljs-attr">interfaces</span></span> = [ ];
    <span class="hljs-comment"><span class="hljs-comment"># A bridge only to containers…</span></span>

    interfaces.<span class="hljs-attr"><span class="hljs-attr">br0</span></span> = {
      <span class="hljs-comment"><span class="hljs-comment"># … configured with a prefix address.</span></span>
      ipv6.<span class="hljs-attr"><span class="hljs-attr">addresses</span></span> = [{
        <span class="hljs-attr"><span class="hljs-attr">address</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${yggPrefix64}</span></span></span><span class="hljs-string">::1"</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">prefixLength</span></span> = <span class="hljs-number"><span class="hljs-number">64</span></span>;
      }];
    };
  };

  containers.<span class="hljs-attr"><span class="hljs-attr">foo</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">autoStart</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">privateNetwork</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">hostBridge</span></span> = <span class="hljs-string"><span class="hljs-string">"br0"</span></span>;
    <span class="hljs-comment"><span class="hljs-comment"># Attach the container to the bridge only.</span></span>
    <span class="hljs-attr"><span class="hljs-attr">config</span></span> = { config, pkgs, ... }: {
      networking.interfaces.eth0.<span class="hljs-attr"><span class="hljs-attr">ipv6</span></span> = {
        <span class="hljs-attr"><span class="hljs-attr">addresses</span></span> = [{
          <span class="hljs-comment"><span class="hljs-comment"># Configure a prefix address.</span></span>
          <span class="hljs-attr"><span class="hljs-attr">address</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${yggPrefix64}</span></span></span><span class="hljs-string">::2"</span></span>;
          <span class="hljs-attr"><span class="hljs-attr">prefixLength</span></span> = <span class="hljs-number"><span class="hljs-number">64</span></span>;
        }];
        <span class="hljs-attr"><span class="hljs-attr">routes</span></span> = [{
          <span class="hljs-comment"><span class="hljs-comment"># Configure the prefix route.</span></span>
          <span class="hljs-attr"><span class="hljs-attr">address</span></span> = <span class="hljs-string"><span class="hljs-string">"200::"</span></span>;
          <span class="hljs-attr"><span class="hljs-attr">prefixLength</span></span> = <span class="hljs-number"><span class="hljs-number">7</span></span>;
          <span class="hljs-attr"><span class="hljs-attr">via</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${yggPrefix64}</span></span></span><span class="hljs-string">::1"</span></span>;
        }];
      };

      services.httpd.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      networking.firewall.<span class="hljs-attr"><span class="hljs-attr">allowedTCPPorts</span></span> = [ <span class="hljs-number"><span class="hljs-number">80</span></span> ];
    };
  };

}
</pre><p>
      </p></section></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-prosody" class="title">Chapter&nbsp;20.&nbsp;Prosody<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-prosody" aria-label="Anchor link for: module services prosody" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-prosody-basic-usage" shape="rect">20.1. Basic usage</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-prosody-letsencrypt" shape="rect">20.2. Let's Encrypt Configuration</a></span></dt></dl></div><p>
  <a class="link" href="https://prosody.im/" target="_top" shape="rect">Prosody</a> is an open-source, modern XMPP server.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-prosody-basic-usage" class="title" style="clear: both">20.1.&nbsp;Basic usage<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-prosody-basic-usage" aria-label="Anchor link for: module services prosody basic usage" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
    A common struggle for most XMPP newcomers is to find the right set
    of XMPP Extensions (XEPs) to setup. Forget to activate a few of
    those and your XMPP experience might turn into a nightmare!
  </p><p>
    The XMPP community tackles this problem by creating a meta-XEP
    listing a decent set of XEPs you should implement. This meta-XEP
    is issued every year, the 2020 edition being
    <a class="link" href="https://xmpp.org/extensions/xep-0423.html" target="_top" shape="rect">XEP-0423</a>.
  </p><p>
    The NixOS Prosody module will implement most of these recommendend XEPs out of
    the box. That being said, two components still require some
    manual configuration: the
    <a class="link" href="https://xmpp.org/extensions/xep-0045.html" target="_top" shape="rect">Multi User Chat (MUC)</a>
    and the <a class="link" href="https://xmpp.org/extensions/xep-0363.html" target="_top" shape="rect">HTTP File Upload</a> ones.
    You'll need to create a DNS subdomain for each of those. The current convention is to name your
    MUC endpoint <code class="literal">conference.example.org</code> and your HTTP upload domain <code class="literal">upload.example.org</code>.
  </p><p>
    A good configuration to start with, including a
    <a class="link" href="https://xmpp.org/extensions/xep-0045.html" target="_top" shape="rect">Multi User Chat (MUC)</a>
    endpoint as well as a <a class="link" href="https://xmpp.org/extensions/xep-0363.html" target="_top" shape="rect">HTTP File Upload</a>
    endpoint will look like this:
    </p><pre class="programlisting hljs nix" xml:space="preserve">services.<span class="hljs-attr"><span class="hljs-attr">prosody</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.admins" shape="rect"><span class="hljs-attr"><span class="hljs-attr">admins</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"root@example.org"</span></span> ];
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.ssl.cert" shape="rect">ssl.<span class="hljs-attr"><span class="hljs-attr">cert</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/lib/acme/example.org/fullchain.pem"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.ssl.key" shape="rect">ssl.<span class="hljs-attr"><span class="hljs-attr">key</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/lib/acme/example.org/key.pem"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.virtualHosts" shape="rect">virtualHosts</a>.<span class="hljs-string"><span class="hljs-string">"example.org"</span></span> = {
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.virtualHosts._name_.enabled" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enabled</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.virtualHosts._name_.domain" shape="rect"><span class="hljs-attr"><span class="hljs-attr">domain</span></span></a> = <span class="hljs-string"><span class="hljs-string">"example.org"</span></span>;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.virtualHosts._name_.ssl.cert" shape="rect">ssl.<span class="hljs-attr"><span class="hljs-attr">cert</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/lib/acme/example.org/fullchain.pem"</span></span>;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.virtualHosts._name_.ssl.key" shape="rect">ssl.<span class="hljs-attr"><span class="hljs-attr">key</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/lib/acme/example.org/key.pem"</span></span>;
  };
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.muc" shape="rect"><span class="hljs-attr"><span class="hljs-attr">muc</span></span></a> = [ {
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.muc" shape="rect"><span class="hljs-attr"><span class="hljs-attr">domain</span></span></a> = <span class="hljs-string"><span class="hljs-string">"conference.example.org"</span></span>;
  } ];
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.uploadHttp" shape="rect"><span class="hljs-attr"><span class="hljs-attr">uploadHttp</span></span></a> = {
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.prosody.uploadHttp.domain" shape="rect"><span class="hljs-attr"><span class="hljs-attr">domain</span></span></a> = <span class="hljs-string"><span class="hljs-string">"upload.example.org"</span></span>;
  };
};</pre><p>
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-prosody-letsencrypt" class="title" style="clear: both">20.2.&nbsp;Let's Encrypt Configuration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-prosody-letsencrypt" aria-label="Anchor link for: module services prosody letsencrypt" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   As you can see in the code snippet from the
   <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#module-services-prosody-basic-usage" title="20.1. Basic usage" shape="rect">previous section</a>,
   you'll need a single TLS certificate covering your main endpoint,
   the MUC one as well as the HTTP Upload one. We can generate such a
   certificate by leveraging the ACME
   <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.extraDomainNames" shape="rect">extraDomainNames</a> module option.
 </p><p>
   Provided the setup detailed in the previous section, you'll need the following acme configuration to generate
   a TLS certificate for the three endponits:
    </p><pre class="programlisting hljs nix" xml:space="preserve">security.<span class="hljs-attr"><span class="hljs-attr">acme</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.email" shape="rect"><span class="hljs-attr"><span class="hljs-attr">email</span></span></a> = <span class="hljs-string"><span class="hljs-string">"root@example.org"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.acceptTerms" shape="rect"><span class="hljs-attr"><span class="hljs-attr">acceptTerms</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs" shape="rect"><span class="hljs-attr"><span class="hljs-attr">certs</span></span></a> = {
    <span class="hljs-string"><span class="hljs-string">"example.org"</span></span> = {
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.webroot" shape="rect"><span class="hljs-attr"><span class="hljs-attr">webroot</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/www/example.org"</span></span>;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.email" shape="rect"><span class="hljs-attr"><span class="hljs-attr">email</span></span></a> = <span class="hljs-string"><span class="hljs-string">"root@example.org"</span></span>;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.extraDomainNames" shape="rect"><span class="hljs-attr"><span class="hljs-attr">extraDomainNames</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"conference.example.org"</span></span> <span class="hljs-string"><span class="hljs-string">"upload.example.org"</span></span> ];
    };
  };
};</pre><p>
 </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-prometheus-exporters" class="title">Chapter&nbsp;21.&nbsp;Prometheus exporters<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters" aria-label="Anchor link for: module services prometheus exporters" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-prometheus-exporters-configuration" shape="rect">21.1. Configuration</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-prometheus-exporters-new-exporter" shape="rect">21.2. Adding a new exporter</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-prometheus-exporters-update-exporter-module" shape="rect">21.3. Updating an exporter module</a></span></dt></dl></div><p>
  Prometheus exporters provide metrics for the
  <a class="link" href="https://prometheus.io/" target="_top" shape="rect">prometheus monitoring system</a>.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-prometheus-exporters-configuration" class="title" style="clear: both">21.1.&nbsp;Configuration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters-configuration" aria-label="Anchor link for: module services prometheus exporters configuration" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   One of the most common exporters is the
   <a class="link" href="https://github.com/prometheus/node_exporter" target="_top" shape="rect">node
   exporter</a>, it provides hardware and OS metrics from the host it's
   running on. The exporter could be configured as follows:
</p><pre class="programlisting hljs nix" xml:space="preserve">  services.prometheus.exporters.<span class="hljs-attr"><span class="hljs-attr">node</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">enabledCollectors</span></span> = [
      <span class="hljs-string"><span class="hljs-string">"logind"</span></span>
      <span class="hljs-string"><span class="hljs-string">"systemd"</span></span>
    ];
    <span class="hljs-attr"><span class="hljs-attr">disabledCollectors</span></span> = [
      <span class="hljs-string"><span class="hljs-string">"textfile"</span></span>
    ];
    <span class="hljs-attr"><span class="hljs-attr">openFirewall</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">firewallFilter</span></span> = <span class="hljs-string"><span class="hljs-string">"-i br0 -p tcp -m tcp --dport 9100"</span></span>;
  };
</pre><p>
   It should now serve all metrics from the collectors that are explicitly
   enabled and the ones that are
   <a class="link" href="https://github.com/prometheus/node_exporter#enabled-by-default" target="_top" shape="rect">enabled
   by default</a>, via http under <code class="literal">/metrics</code>. In this
   example the firewall should just allow incoming connections to the
   exporter's port on the bridge interface <code class="literal">br0</code> (this would
   have to be configured seperately of course). For more information about
   configuration see <code class="literal">man configuration.nix</code> or search through
   the
   <a class="link" href="https://nixos.org/nixos/options.html#prometheus.exporters" target="_top" shape="rect">available
   options</a>.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-prometheus-exporters-new-exporter" class="title" style="clear: both">21.2.&nbsp;Adding a new exporter<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters-new-exporter" aria-label="Anchor link for: module services prometheus exporters new exporter" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   To add a new exporter, it has to be packaged first (see
   <code class="literal">nixpkgs/pkgs/servers/monitoring/prometheus/</code> for
   examples), then a module can be added. The postfix exporter is used in this
   example:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Some default options for all exporters are provided by
     <code class="literal">nixpkgs/nixos/modules/services/monitoring/prometheus/exporters.nix</code>:
    </p></li><li class="listitem" style="list-style-type: none"><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
       <code class="literal">enable</code>
      </p></li><li class="listitem"><p>
       <code class="literal">port</code>
      </p></li><li class="listitem"><p>
       <code class="literal">listenAddress</code>
      </p></li><li class="listitem"><p>
       <code class="literal">extraFlags</code>
      </p></li><li class="listitem"><p>
       <code class="literal">openFirewall</code>
      </p></li><li class="listitem"><p>
       <code class="literal">firewallFilter</code>
      </p></li><li class="listitem"><p>
       <code class="literal">user</code>
      </p></li><li class="listitem"><p>
       <code class="literal">group</code>
      </p></li></ul></div></li><li class="listitem"><p>
     As there is already a package available, the module can now be added. This
     is accomplished by adding a new file to the
     <code class="literal">nixos/modules/services/monitoring/prometheus/exporters/</code>
     directory, which will be called postfix.nix and contains all exporter
     specific options and configuration:
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-comment"><span class="hljs-comment"># nixpgs/nixos/modules/services/prometheus/exporters/postfix.nix</span></span>
{ config, lib, pkgs, options }:

<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> lib;

<span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># for convenience we define cfg here</span></span>
  <span class="hljs-attr"><span class="hljs-attr">cfg</span></span> = config.services.prometheus.exporters.postfix;
<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>
{
  <span class="hljs-attr"><span class="hljs-attr">port</span></span> = <span class="hljs-number"><span class="hljs-number">9154</span></span>; <span class="hljs-comment"><span class="hljs-comment"># The postfix exporter listens on this port by default</span></span>

  <span class="hljs-comment"><span class="hljs-comment"># `extraOpts` is an attribute set which contains additional options</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># (and optional overrides for default options).</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># Note that this attribute is optional.</span></span>
  <span class="hljs-attr"><span class="hljs-attr">extraOpts</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">telemetryPath</span></span> = mkOption {
      <span class="hljs-attr"><span class="hljs-attr">type</span></span> = types.str;
      <span class="hljs-attr"><span class="hljs-attr">default</span></span> = <span class="hljs-string"><span class="hljs-string">"/metrics"</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">''
        Path under which to expose metrics.
      ''</span></span>;
    };
    <span class="hljs-attr"><span class="hljs-attr">logfilePath</span></span> = mkOption {
      <span class="hljs-attr"><span class="hljs-attr">type</span></span> = types.path;
      <span class="hljs-attr"><span class="hljs-attr">default</span></span> = /var/log/postfix_exporter_input.log;
      <span class="hljs-attr"><span class="hljs-attr">example</span></span> = /var/log/mail.log;
      <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">''
        Path where Postfix writes log entries.
        This file will be truncated by this exporter!
      ''</span></span>;
    };
    <span class="hljs-attr"><span class="hljs-attr">showqPath</span></span> = mkOption {
      <span class="hljs-attr"><span class="hljs-attr">type</span></span> = types.path;
      <span class="hljs-attr"><span class="hljs-attr">default</span></span> = /var/spool/postfix/public/showq;
      <span class="hljs-attr"><span class="hljs-attr">example</span></span> = /var/lib/postfix/queue/public/showq;
      <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">''
        Path at which Postfix places its showq socket.
      ''</span></span>;
    };
  };

  <span class="hljs-comment"><span class="hljs-comment"># `serviceOpts` is an attribute set which contains configuration</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># for the exporter's systemd service. One of</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># `serviceOpts.script` and `serviceOpts.serviceConfig.ExecStart`</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># has to be specified here. This will be merged with the default</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># service confiuration.</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># Note that by default 'DynamicUser' is 'true'.</span></span>
  <span class="hljs-attr"><span class="hljs-attr">serviceOpts</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">serviceConfig</span></span> = {
      <span class="hljs-attr"><span class="hljs-attr">DynamicUser</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">ExecStart</span></span> = <span class="hljs-string"><span class="hljs-string">''
        </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${pkgs.prometheus-postfix-exporter}</span></span></span><span class="hljs-string">/bin/postfix_exporter \
          --web.listen-address </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${cfg.listenAddress}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">toString</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> cfg.port}</span></span></span><span class="hljs-string"> \
          --web.telemetry-path </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${cfg.telemetryPath}</span></span></span><span class="hljs-string"> \
          </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${concatStringsSep </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">" \\\n  "</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> cfg.extraFlags}</span></span></span><span class="hljs-string">
      ''</span></span>;
    };
  };
}
</pre><p>
    </p></li><li class="listitem"><p>
     This should already be enough for the postfix exporter. Additionally one
     could now add assertions and conditional default values. This can be done
     in the 'meta-module' that combines all exporter definitions and generates
     the submodules:
     <code class="literal">nixpkgs/nixos/modules/services/prometheus/exporters.nix</code>
    </p></li></ul></div></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-prometheus-exporters-update-exporter-module" class="title" style="clear: both">21.3.&nbsp;Updating an exporter module<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters-update-exporter-module" aria-label="Anchor link for: module services prometheus exporters update exporter module" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
     Should an exporter option change at some point, it is possible to add
     information about the change to the exporter definition similar to
     <code class="literal">nixpkgs/nixos/modules/rename.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve">{ config, lib, pkgs, options }:

<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> lib;

<span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
  <span class="hljs-attr"><span class="hljs-attr">cfg</span></span> = config.services.prometheus.exporters.nginx;
<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>
{
  <span class="hljs-attr"><span class="hljs-attr">port</span></span> = <span class="hljs-number"><span class="hljs-number">9113</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">extraOpts</span></span> = {
    <span class="hljs-comment"><span class="hljs-comment"># additional module options</span></span>
    <span class="hljs-comment"><span class="hljs-comment"># ...</span></span>
  };
  <span class="hljs-attr"><span class="hljs-attr">serviceOpts</span></span> = {
    <span class="hljs-comment"><span class="hljs-comment"># service configuration</span></span>
    <span class="hljs-comment"><span class="hljs-comment"># ...</span></span>
  };
  <span class="hljs-attr"><span class="hljs-attr">imports</span></span> = [
    <span class="hljs-comment"><span class="hljs-comment"># 'services.prometheus.exporters.nginx.telemetryEndpoint' -&gt; 'services.prometheus.exporters.nginx.telemetryPath'</span></span>
    (mkRenamedOptionModule [ <span class="hljs-string"><span class="hljs-string">"telemetryEndpoint"</span></span> ] [ <span class="hljs-string"><span class="hljs-string">"telemetryPath"</span></span> ])

    <span class="hljs-comment"><span class="hljs-comment"># removed option 'services.prometheus.exporters.nginx.insecure'</span></span>
    (mkRemovedOptionModule [ <span class="hljs-string"><span class="hljs-string">"insecure"</span></span> ] <span class="hljs-string"><span class="hljs-string">''
      This option was replaced by 'prometheus.exporters.nginx.sslVerify' which defaults to true.
    ''</span></span>)
    ({ options.<span class="hljs-attr"><span class="hljs-attr">warnings</span></span> = options.warnings; })
  ];
}
</pre><p>
    </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-weechat" class="title">Chapter&nbsp;22.&nbsp;WeeChat<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-weechat" aria-label="Anchor link for: module services weechat" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-weechat-basic-usage" shape="rect">22.1. Basic Usage</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-weechat-reattach" shape="rect">22.2. Re-attaching to WeeChat</a></span></dt></dl></div><p>
  <a class="link" href="https://weechat.org/" target="_top" shape="rect">WeeChat</a> is a fast and
  extensible IRC client.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-weechat-basic-usage" class="title" style="clear: both">22.1.&nbsp;Basic Usage<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-weechat-basic-usage" aria-label="Anchor link for: module services weechat basic usage" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   By default, the module creates a
   <code class="literal"><a class="link" href="https://www.freedesktop.org/wiki/Software/systemd/" target="_top" shape="rect">systemd</a></code>
   unit which runs the chat client in a detached
   <code class="literal"><a class="link" href="https://www.gnu.org/software/screen/" target="_top" shape="rect">screen</a></code>
   session.
  </p><p>
   This can be done by enabling the <code class="literal">weechat</code> service:
</p><pre class="programlisting hljs nix" xml:space="preserve">{ ... }:

{
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.weechat.enable" shape="rect">services.weechat.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
}
</pre><p>
  </p><p>
   The service is managed by a dedicated user named <code class="literal">weechat</code>
   in the state directory <code class="literal">/var/lib/weechat</code>.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-weechat-reattach" class="title" style="clear: both">22.2.&nbsp;Re-attaching to WeeChat<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-weechat-reattach" aria-label="Anchor link for: module services weechat reattach" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   WeeChat runs in a screen session owned by a dedicated user. To explicitly
   allow your another user to attach to this session, the
   <code class="literal">screenrc</code> needs to be tweaked by adding
   <a class="link" href="https://www.gnu.org/software/screen/manual/html_node/Multiuser.html#Multiuser" target="_top" shape="rect">multiuser</a>
   support:
</p><pre class="programlisting hljs nix" xml:space="preserve">{
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-programs.screen.screenrc" shape="rect">programs.screen.<span class="hljs-attr"><span class="hljs-attr">screenrc</span></span></a> = <span class="hljs-string"><span class="hljs-string">''
    multiuser on
    acladd normal_user
  ''</span></span>;
}
</pre><p>
   Now, the session can be re-attached like this:
</p><pre class="programlisting hljs" xml:space="preserve">screen -x weechat/weechat-screen
</pre><p>
  </p><p>
   <span class="emphasis"><em>The session name can be changed using
   <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.weechat.sessionName" shape="rect">services.weechat.sessionName.</a></em></span>
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-taskserver" class="title">Chapter&nbsp;23.&nbsp;Taskserver<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-taskserver" aria-label="Anchor link for: module taskserver" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-taskserver-configuration" shape="rect">23.1. Configuration</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-taskserver-nixos-taskserver-tool" shape="rect">23.2. The nixos-taskserver tool</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-taskserver-declarative-ca-management" shape="rect">23.3. Declarative/automatic CA management</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-taskserver-manual-ca-management" shape="rect">23.4. Manual CA management</a></span></dt></dl></div><p>
  Taskserver is the server component of
  <a class="link" href="https://taskwarrior.org/" target="_top" shape="rect">Taskwarrior</a>, a free and
  open source todo list application.
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span>
  <a class="link" href="https://taskwarrior.org/docs/#taskd" target="_top" shape="rect">https://taskwarrior.org/docs/#taskd</a>
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-taskserver-configuration" class="title" style="clear: both">23.1.&nbsp;Configuration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-taskserver-configuration" aria-label="Anchor link for: module services taskserver configuration" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Taskserver does all of its authentication via TLS using client certificates,
   so you either need to roll your own CA or purchase a certificate from a
   known CA, which allows creation of client certificates. These certificates
   are usually advertised as <span class="quote">“<span class="quote">server certificates</span>”</span>.
  </p><p>
   So in order to make it easier to handle your own CA, there is a helper tool
   called <span class="command"><strong>nixos-taskserver</strong></span> which manages the custom CA along
   with Taskserver organisations, users and groups.
  </p><p>
   While the client certificates in Taskserver only authenticate whether a user
   is allowed to connect, every user has its own UUID which identifies it as an
   entity.
  </p><p>
   With <span class="command"><strong>nixos-taskserver</strong></span> the client certificate is created
   along with the UUID of the user, so it handles all of the credentials needed
   in order to setup the Taskwarrior client to work with a Taskserver.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-taskserver-nixos-taskserver-tool" class="title" style="clear: both">23.2.&nbsp;The nixos-taskserver tool<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-taskserver-nixos-taskserver-tool" aria-label="Anchor link for: module services taskserver nixos taskserver tool" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Because Taskserver by default only provides scripts to setup users
   imperatively, the <span class="command"><strong>nixos-taskserver</strong></span> tool is used for
   addition and deletion of organisations along with users and groups defined
   by <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.taskserver.organisations" shape="rect"><code class="option">services.taskserver.organisations</code></a> and as well for
   imperative set up.
  </p><p>
   The tool is designed to not interfere if the command is used to manually set
   up some organisations, users or groups.
  </p><p>
   For example if you add a new organisation using <span class="command"><strong>nixos-taskserver
   org add foo</strong></span>, the organisation is not modified and deleted no
   matter what you define in
   <code class="option">services.taskserver.organisations</code>, even if you're adding
   the same organisation in that option.
  </p><p>
   The tool is modelled to imitate the official <span class="command"><strong>taskd</strong></span>
   command, documentation for each subcommand can be shown by using the
   <code class="option">--help</code> switch.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-taskserver-declarative-ca-management" class="title" style="clear: both">23.3.&nbsp;Declarative/automatic CA management<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-taskserver-declarative-ca-management" aria-label="Anchor link for: module services taskserver declarative ca management" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Everything is done according to what you specify in the module options,
   however in order to set up a Taskwarrior client for synchronisation with a
   Taskserver instance, you have to transfer the keys and certificates to the
   client machine.
  </p><p>
   This is done using <span class="command"><strong>nixos-taskserver user export $orgname
   $username</strong></span> which is printing a shell script fragment to stdout
   which can either be used verbatim or adjusted to import the user on the
   client machine.
  </p><p>
   For example, let's say you have the following configuration:
</p><pre class="screen hljs nix" xml:space="preserve">{
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.taskserver.enable" shape="rect"><code class="option">services.taskserver.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.taskserver.fqdn" shape="rect"><code class="option">services.taskserver.<span class="hljs-attr"><span class="hljs-attr">fqdn</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"server"</span></span>;
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.taskserver.listenHost" shape="rect"><code class="option">services.taskserver.<span class="hljs-attr"><span class="hljs-attr">listenHost</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"::"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.taskserver.organisations._name_.users" shape="rect">services.taskserver.organisations.my-company.<span class="hljs-attr"><span class="hljs-attr">users</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"alice"</span></span> ];
}
</pre><p>
   This creates an organisation called <code class="literal">my-company</code> with the
   user <code class="literal">alice</code>.
  </p><p>
   Now in order to import the <code class="literal">alice</code> user to another machine
   <code class="literal">alicebox</code>, all we need to do is something like this:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>ssh server nixos-taskserver user <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> my-company alice | sh
</pre><p>
   Of course, if no SSH daemon is available on the server you can also copy
   &amp; paste it directly into a shell.
  </p><p>
   After this step the user should be set up and you can start synchronising
   your tasks for the first time with <span class="command"><strong>task sync init</strong></span> on
   <code class="literal">alicebox</code>.
  </p><p>
   Subsequent synchronisation requests merely require the command <span class="command"><strong>task
   sync</strong></span> after that stage.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-taskserver-manual-ca-management" class="title" style="clear: both">23.4.&nbsp;Manual CA management<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-taskserver-manual-ca-management" aria-label="Anchor link for: module services taskserver manual ca management" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   If you set any options within
   <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.taskserver.pki.manual.ca.cert" shape="rect">service.taskserver.pki.manual</a>.*,
   <span class="command"><strong>nixos-taskserver</strong></span> won't issue certificates, but you can
   still use it for adding or removing user accounts.
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-matrix" class="title">Chapter&nbsp;24.&nbsp;Matrix<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-matrix" aria-label="Anchor link for: module services matrix" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-matrix-synapse" shape="rect">24.1. Synapse Homeserver</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-matrix-element-web" shape="rect">24.2. Element (formerly known as Riot) Web Client</a></span></dt></dl></div><p>
  <a class="link" href="https://matrix.org/" target="_top" shape="rect">Matrix</a> is an open standard for
  interoperable, decentralised, real-time communication over IP. It can be used
  to power Instant Messaging, VoIP/WebRTC signalling, Internet of Things
  communication - or anywhere you need a standard HTTP API for publishing and
  subscribing to data whilst tracking the conversation history.
 </p><p>
  This chapter will show you how to set up your own, self-hosted Matrix
  homeserver using the Synapse reference homeserver, and how to serve your own
  copy of the Element web client. See the
  <a class="link" href="https://matrix.org/docs/projects/try-matrix-now.html" target="_top" shape="rect">Try
  Matrix Now!</a> overview page for links to Element Apps for Android and iOS,
  desktop clients, as well as bridges to other networks and other projects
  around Matrix.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-matrix-synapse" class="title" style="clear: both">24.1.&nbsp;Synapse Homeserver<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-matrix-synapse" aria-label="Anchor link for: module services matrix synapse" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   <a class="link" href="https://github.com/matrix-org/synapse" target="_top" shape="rect">Synapse</a> is
   the reference homeserver implementation of Matrix from the core development
   team at matrix.org. The following configuration example will set up a
   synapse server for the <code class="literal">example.org</code> domain, served from
   the host <code class="literal">myhostname.example.org</code>. For more information,
   please refer to the
   <a class="link" href="https://github.com/matrix-org/synapse#synapse-installation" target="_top" shape="rect">
   installation instructions of Synapse </a>.
</p><pre class="programlisting hljs nix" xml:space="preserve">{ pkgs, ... }:
<span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
  <span class="hljs-attr"><span class="hljs-attr">fqdn</span></span> =
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
      <span class="hljs-attr"><span class="hljs-attr">join</span></span> = hostName: domain: hostName + optionalString (domain != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-string"><span class="hljs-string">".</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${domain}</span></span></span><span class="hljs-string">"</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> join config.networking.hostName config.networking.domain;
<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {
  <span class="hljs-attr"><span class="hljs-attr">networking</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.hostName" shape="rect"><span class="hljs-attr"><span class="hljs-attr">hostName</span></span></a> = <span class="hljs-string"><span class="hljs-string">"myhostname"</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.domain" shape="rect"><span class="hljs-attr"><span class="hljs-attr">domain</span></span></a> = <span class="hljs-string"><span class="hljs-string">"example.org"</span></span>;
  };
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.firewall.allowedTCPPorts" shape="rect">networking.firewall.<span class="hljs-attr"><span class="hljs-attr">allowedTCPPorts</span></span></a> = [ <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ];

  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.enable" shape="rect">services.postgresql.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.initialScript" shape="rect">services.postgresql.<span class="hljs-attr"><span class="hljs-attr">initialScript</span></span></a> = pkgs.writeText <span class="hljs-string"><span class="hljs-string">"synapse-init.sql"</span></span> <span class="hljs-string"><span class="hljs-string">''
    CREATE ROLE "matrix-synapse" WITH LOGIN PASSWORD 'synapse';
    CREATE DATABASE "matrix-synapse" WITH OWNER "matrix-synapse"
      TEMPLATE template0
      LC_COLLATE = "C"
      LC_CTYPE = "C";
  ''</span></span>;

  services.<span class="hljs-attr"><span class="hljs-attr">nginx</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <span class="hljs-comment"><span class="hljs-comment"># only recommendedProxySettings and recommendedGzipSettings are strictly required,</span></span>
    <span class="hljs-comment"><span class="hljs-comment"># but the rest make sense as well</span></span>
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.recommendedTlsSettings" shape="rect"><span class="hljs-attr"><span class="hljs-attr">recommendedTlsSettings</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.recommendedOptimisation" shape="rect"><span class="hljs-attr"><span class="hljs-attr">recommendedOptimisation</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.recommendedGzipSettings" shape="rect"><span class="hljs-attr"><span class="hljs-attr">recommendedGzipSettings</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.recommendedProxySettings" shape="rect"><span class="hljs-attr"><span class="hljs-attr">recommendedProxySettings</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;

    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts" shape="rect"><span class="hljs-attr"><span class="hljs-attr">virtualHosts</span></span></a> = {
      <span class="hljs-comment"><span class="hljs-comment"># This host section can be placed on a different host than the rest,</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># i.e. to delegate from the host being accessible as ${config.networking.domain}</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># to another host actually running the Matrix homeserver.</span></span>
      <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${config.networking.domain}</span></span></span><span class="hljs-string">"</span></span> = {
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.locations._name_.extraConfig" shape="rect">locations.<span class="hljs-string"><span class="hljs-string">"= /.well-known/matrix/server"</span></span>.<span class="hljs-attr"><span class="hljs-attr">extraConfig</span></span></a> =
          <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
            <span class="hljs-comment"><span class="hljs-comment"># use 443 instead of the default 8448 port to unite</span></span>
            <span class="hljs-comment"><span class="hljs-comment"># the client-server and server-server port for simplicity</span></span>
            <span class="hljs-attr"><span class="hljs-attr">server</span></span> = { <span class="hljs-string"><span class="hljs-string">"m.server"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${fqdn}</span></span></span><span class="hljs-string">:443"</span></span>; };
          <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">''
            add_header Content-Type application/json;
            return 200 '</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">builtins</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.toJSON server}</span></span></span><span class="hljs-string">';
          ''</span></span>;
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.locations._name_.extraConfig" shape="rect">locations.<span class="hljs-string"><span class="hljs-string">"= /.well-known/matrix/client"</span></span>.<span class="hljs-attr"><span class="hljs-attr">extraConfig</span></span></a> =
          <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
            <span class="hljs-attr"><span class="hljs-attr">client</span></span> = {
              <span class="hljs-string"><span class="hljs-string">"m.homeserver"</span></span> =  { <span class="hljs-string"><span class="hljs-string">"base_url"</span></span> = <span class="hljs-string"><span class="hljs-string">"https://</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${fqdn}</span></span></span><span class="hljs-string">"</span></span>; };
              <span class="hljs-string"><span class="hljs-string">"m.identity_server"</span></span> =  { <span class="hljs-string"><span class="hljs-string">"base_url"</span></span> = <span class="hljs-string"><span class="hljs-string">"https://vector.im"</span></span>; };
            };
          <span class="hljs-comment"><span class="hljs-comment"># ACAO required to allow element-web on any URL to request this json file</span></span>
          <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">''
            add_header Content-Type application/json;
            add_header Access-Control-Allow-Origin *;
            return 200 '</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">builtins</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.toJSON client}</span></span></span><span class="hljs-string">';
          ''</span></span>;
      };

      <span class="hljs-comment"><span class="hljs-comment"># Reverse proxy for Matrix client-server and server-server communication</span></span>
      ${fqdn} = {
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.enableACME" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enableACME</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.forceSSL" shape="rect"><span class="hljs-attr"><span class="hljs-attr">forceSSL</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;

        <span class="hljs-comment"><span class="hljs-comment"># Or do a redirect instead of the 404, or whatever is appropriate for you.</span></span>
        <span class="hljs-comment"><span class="hljs-comment"># But do not put a Matrix Web client here! See the Element web section below.</span></span>
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.locations._name_.extraConfig" shape="rect">locations.<span class="hljs-string"><span class="hljs-string">"/"</span></span>.<span class="hljs-attr"><span class="hljs-attr">extraConfig</span></span></a> = <span class="hljs-string"><span class="hljs-string">''
          return 404;
        ''</span></span>;

        <span class="hljs-comment"><span class="hljs-comment"># forward all Matrix API calls to the synapse Matrix homeserver</span></span>
        locations.<span class="hljs-string"><span class="hljs-string">"/_matrix"</span></span> = {
          <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.locations._name_.proxyPass" shape="rect"><span class="hljs-attr"><span class="hljs-attr">proxyPass</span></span></a> = <span class="hljs-string"><span class="hljs-string">"http://[::1]:8008"</span></span>; <span class="hljs-comment"><span class="hljs-comment"># without a trailing /</span></span>
        };
      };
    };
  };
  services.<span class="hljs-attr"><span class="hljs-attr">matrix-synapse</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.server_name" shape="rect"><span class="hljs-attr"><span class="hljs-attr">server_name</span></span></a> = config.networking.domain;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.listeners" shape="rect"><span class="hljs-attr"><span class="hljs-attr">listeners</span></span></a> = [
      {
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.listeners._.port" shape="rect"><span class="hljs-attr"><span class="hljs-attr">port</span></span></a> = <span class="hljs-number"><span class="hljs-number">8008</span></span>;
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.listeners._.bind_address" shape="rect"><span class="hljs-attr"><span class="hljs-attr">bind_address</span></span></a> = <span class="hljs-string"><span class="hljs-string">"::1"</span></span>;
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.listeners._.type" shape="rect"><span class="hljs-attr"><span class="hljs-attr">type</span></span></a> = <span class="hljs-string"><span class="hljs-string">"http"</span></span>;
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.listeners._.tls" shape="rect"><span class="hljs-attr"><span class="hljs-attr">tls</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.listeners._.x_forwarded" shape="rect"><span class="hljs-attr"><span class="hljs-attr">x_forwarded</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.listeners._.resources" shape="rect"><span class="hljs-attr"><span class="hljs-attr">resources</span></span></a> = [
          {
            <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.listeners._.resources._.names" shape="rect"><span class="hljs-attr"><span class="hljs-attr">names</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"client"</span></span> <span class="hljs-string"><span class="hljs-string">"federation"</span></span> ];
            <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.listeners._.resources._.compress" shape="rect"><span class="hljs-attr"><span class="hljs-attr">compress</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
          }
        ];
      }
    ];
  };
};
</pre><p>
  </p><p>
   If the <code class="code">A</code> and <code class="code">AAAA</code> DNS records on
   <code class="literal">example.org</code> do not point on the same host as the records
   for <code class="code">myhostname.example.org</code>, you can easily move the
   <code class="code">/.well-known</code> virtualHost section of the code to the host that
   is serving <code class="literal">example.org</code>, while the rest stays on
   <code class="literal">myhostname.example.org</code> with no other changes required.
   This pattern also allows to seamlessly move the homeserver from
   <code class="literal">myhostname.example.org</code> to
   <code class="literal">myotherhost.example.org</code> by only changing the
   <code class="code">/.well-known</code> redirection target.
  </p><p>
   If you want to run a server with public registration by anybody, you can
   then enable <code class="literal"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.enable_registration" shape="rect">services.matrix-synapse.enable_registration</a> =
   true;</code>. Otherwise, or you can generate a registration secret with
   <span class="command"><strong>pwgen -s 64 1</strong></span> and set it with
   <code class="option"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.registration_shared_secret" shape="rect">services.matrix-synapse.registration_shared_secret</a></code>. To
   create a new user or admin, run the following after you have set the secret
   and have rebuilt NixOS:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix run nixpkgs.matrix-synapse
<code class="prompt">$ </code>register_new_matrix_user -k <em class="replaceable"><code>your-registration-shared-secret</code></em> http://localhost:8008
<code class="prompt">New user localpart: </code><em class="replaceable"><code>your-username</code></em>
<code class="prompt">Password:</code>
<code class="prompt">Confirm password:</code>
<code class="prompt">Make admin [no]:</code>
Success!
</pre><p>
   In the example, this would create a user with the Matrix Identifier
   <code class="literal">@your-username:example.org</code>. Note that the registration
   secret ends up in the nix store and therefore is world-readable by any user
   on your machine, so it makes sense to only temporarily activate the
   <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.matrix-synapse.registration_shared_secret" shape="rect">registration_shared_secret</a>
   option until a better solution for NixOS is in place.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-matrix-element-web" class="title" style="clear: both">24.2.&nbsp;Element (formerly known as Riot) Web Client<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-matrix-element-web" aria-label="Anchor link for: module services matrix element web" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   <a class="link" href="https://github.com/vector-im/riot-web/" target="_top" shape="rect">Element Web</a> is
   the reference web client for Matrix and developed by the core team at
   matrix.org. Element was formerly known as Riot.im, see the
   <a class="link" href="https://element.io/blog/welcome-to-element/" target="_top" shape="rect">Element introductory blog post</a>
   for more information. The following snippet can be optionally added to the code before
   to complete the synapse installation with a web client served at
   <code class="code">https://element.myhostname.example.org</code> and
   <code class="code">https://element.example.org</code>. Alternatively, you can use the hosted
   copy at <a class="link" href="https://app.element.io/" target="_top" shape="rect">https://app.element.io/</a>,
   or use other web clients or native client applications. Due to the
   <code class="literal">/.well-known</code> urls set up done above, many clients should
   fill in the required connection details automatically when you enter your
   Matrix Identifier. See
   <a class="link" href="https://matrix.org/docs/projects/try-matrix-now.html" target="_top" shape="rect">Try
   Matrix Now!</a> for a list of existing clients and their supported
   featureset.
</p><pre class="programlisting hljs nix" xml:space="preserve">{
  services.nginx.virtualHosts.<span class="hljs-string"><span class="hljs-string">"element.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${fqdn}</span></span></span><span class="hljs-string">"</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.enableACME" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enableACME</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.forceSSL" shape="rect"><span class="hljs-attr"><span class="hljs-attr">forceSSL</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.serverAliases" shape="rect"><span class="hljs-attr"><span class="hljs-attr">serverAliases</span></span></a> = [
      <span class="hljs-string"><span class="hljs-string">"element.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${config.networking.domain}</span></span></span><span class="hljs-string">"</span></span>
    ];

    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.root" shape="rect"><span class="hljs-attr"><span class="hljs-attr">root</span></span></a> = pkgs.element-web.override {
      <span class="hljs-attr"><span class="hljs-attr">conf</span></span> = {
        default_server_config.<span class="hljs-string"><span class="hljs-string">"m.homeserver"</span></span> = {
          <span class="hljs-string"><span class="hljs-string">"base_url"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${config.networking.domain}</span></span></span><span class="hljs-string">"</span></span>;
          <span class="hljs-string"><span class="hljs-string">"server_name"</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${fqdn}</span></span></span><span class="hljs-string">"</span></span>;
        };
      };
    };
  };
}
</pre><p>
  </p><p>
   Note that the Element developers do not recommend running Element and your Matrix
   homeserver on the same fully-qualified domain name for security reasons. In
   the example, this means that you should not reuse the
   <code class="literal">myhostname.example.org</code> virtualHost to also serve Element,
   but instead serve it on a different subdomain, like
   <code class="literal">element.example.org</code> in the example. See the
   <a class="link" href="https://github.com/vector-im/riot-web#important-security-note" target="_top" shape="rect">Element
   Important Security Notes</a> for more information on this subject.
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-gitlab" class="title">Chapter&nbsp;25.&nbsp;Gitlab<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-gitlab" aria-label="Anchor link for: module services gitlab" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-gitlab-prerequisites" shape="rect">25.1. Prerequisites</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-gitlab-configuring" shape="rect">25.2. Configuring</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-gitlab-maintenance" shape="rect">25.3. Maintenance</a></span></dt></dl></div><p>
  Gitlab is a feature-rich git hosting service.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-gitlab-prerequisites" class="title" style="clear: both">25.1.&nbsp;Prerequisites<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-gitlab-prerequisites" aria-label="Anchor link for: module services gitlab prerequisites" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   The gitlab service exposes only an Unix socket at
   <code class="literal">/run/gitlab/gitlab-workhorse.socket</code>. You need to
   configure a webserver to proxy HTTP requests to the socket.
  </p><p>
   For instance, the following configuration could be used to use nginx as
   frontend proxy:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.enable" shape="rect">services.<span class="hljs-attr"><span class="hljs-attr">nginx</span></span></a> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.recommendedGzipSettings" shape="rect"><span class="hljs-attr"><span class="hljs-attr">recommendedGzipSettings</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.recommendedOptimisation" shape="rect"><span class="hljs-attr"><span class="hljs-attr">recommendedOptimisation</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.recommendedProxySettings" shape="rect"><span class="hljs-attr"><span class="hljs-attr">recommendedProxySettings</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.recommendedTlsSettings" shape="rect"><span class="hljs-attr"><span class="hljs-attr">recommendedTlsSettings</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts" shape="rect">virtualHosts</a>.<span class="hljs-string"><span class="hljs-string">"git.example.com"</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.enableACME" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enableACME</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.forceSSL" shape="rect"><span class="hljs-attr"><span class="hljs-attr">forceSSL</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.locations._name_.proxyPass" shape="rect">locations.<span class="hljs-string"><span class="hljs-string">"/"</span></span>.<span class="hljs-attr"><span class="hljs-attr">proxyPass</span></span></a> = <span class="hljs-string"><span class="hljs-string">"http://unix:/run/gitlab/gitlab-workhorse.socket"</span></span>;
  };
};
</pre><p>
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-gitlab-configuring" class="title" style="clear: both">25.2.&nbsp;Configuring<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-gitlab-configuring" aria-label="Anchor link for: module services gitlab configuring" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Gitlab depends on both PostgreSQL and Redis and will automatically enable
   both services. In the case of PostgreSQL, a database and a role will be
   created.
  </p><p>
   The default state dir is <code class="literal">/var/gitlab/state</code>. This is where
   all data like the repositories and uploads will be stored.
  </p><p>
   A basic configuration with some custom settings could look like this:
</p><pre class="programlisting hljs nix" xml:space="preserve">services.<span class="hljs-attr"><span class="hljs-attr">gitlab</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.databasePasswordFile" shape="rect"><span class="hljs-attr"><span class="hljs-attr">databasePasswordFile</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/keys/gitlab/db_password"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.initialRootPasswordFile" shape="rect"><span class="hljs-attr"><span class="hljs-attr">initialRootPasswordFile</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/keys/gitlab/root_password"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.https" shape="rect"><span class="hljs-attr"><span class="hljs-attr">https</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.host" shape="rect"><span class="hljs-attr"><span class="hljs-attr">host</span></span></a> = <span class="hljs-string"><span class="hljs-string">"git.example.com"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.port" shape="rect"><span class="hljs-attr"><span class="hljs-attr">port</span></span></a> = <span class="hljs-number"><span class="hljs-number">443</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.user" shape="rect"><span class="hljs-attr"><span class="hljs-attr">user</span></span></a> = <span class="hljs-string"><span class="hljs-string">"git"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.group" shape="rect"><span class="hljs-attr"><span class="hljs-attr">group</span></span></a> = <span class="hljs-string"><span class="hljs-string">"git"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">smtp</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.smtp.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.smtp.address" shape="rect"><span class="hljs-attr"><span class="hljs-attr">address</span></span></a> = <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.smtp.port" shape="rect"><span class="hljs-attr"><span class="hljs-attr">port</span></span></a> = <span class="hljs-number"><span class="hljs-number">25</span></span>;
  };
  <span class="hljs-attr"><span class="hljs-attr">secrets</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.secrets.dbFile" shape="rect"><span class="hljs-attr"><span class="hljs-attr">dbFile</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/keys/gitlab/db"</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.secrets.secretFile" shape="rect"><span class="hljs-attr"><span class="hljs-attr">secretFile</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/keys/gitlab/secret"</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.secrets.otpFile" shape="rect"><span class="hljs-attr"><span class="hljs-attr">otpFile</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/keys/gitlab/otp"</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.secrets.jwsFile" shape="rect"><span class="hljs-attr"><span class="hljs-attr">jwsFile</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/keys/gitlab/jws"</span></span>;
  };
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.extraConfig" shape="rect"><span class="hljs-attr"><span class="hljs-attr">extraConfig</span></span></a> = {
    <span class="hljs-attr"><span class="hljs-attr">gitlab</span></span> = {
      <span class="hljs-attr"><span class="hljs-attr">email_from</span></span> = <span class="hljs-string"><span class="hljs-string">"gitlab-no-reply@example.com"</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">email_display_name</span></span> = <span class="hljs-string"><span class="hljs-string">"Example GitLab"</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">email_reply_to</span></span> = <span class="hljs-string"><span class="hljs-string">"gitlab-no-reply@example.com"</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">default_projects_features</span></span> = { <span class="hljs-attr"><span class="hljs-attr">builds</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; };
    };
  };
};
</pre><p>
  </p><p>
   If you're setting up a new Gitlab instance, generate new
   secrets. You for instance use <code class="literal">tr -dc A-Za-z0-9 &lt;
   /dev/urandom | head -c 128 &gt; /var/keys/gitlab/db</code> to
   generate a new db secret. Make sure the files can be read by, and
   only by, the user specified by <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.user" shape="rect">services.gitlab.user</a>. Gitlab
   encrypts sensitive data stored in the database. If you're restoring
   an existing Gitlab instance, you must specify the secrets secret
   from <code class="literal">config/secrets.yml</code> located in your Gitlab
   state folder.
  </p><p>
    When <code class="literal">icoming_mail.enabled</code> is set to <code class="literal">true</code>
    in <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.extraConfig" shape="rect">extraConfig</a> an additional
    service called <code class="literal">gitlab-mailroom</code> is enabled for fetching incoming mail.
  </p><p>
   Refer to <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html" title="Appendix A. Configuration Options" shape="rect">Appendix&nbsp;A, <em>Configuration Options</em></a> for all available configuration
   options for the
   <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.gitlab.enable" shape="rect">services.gitlab</a> module.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-gitlab-maintenance" class="title" style="clear: both">25.3.&nbsp;Maintenance<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-gitlab-maintenance" aria-label="Anchor link for: module services gitlab maintenance" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   You can run Gitlab's rake tasks with <code class="literal">gitlab-rake</code> which
   will be available on the system when gitlab is enabled. You will have to run
   the command as the user that you configured to run gitlab with.
  </p><p>
   For example, to backup a Gitlab instance:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>sudo -u git -H gitlab-rake gitlab:backup:create
</pre><p>
   A list of all availabe rake tasks can be obtained by running:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>sudo -u git -H gitlab-rake -T
</pre><p>
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-mailman" class="title">Chapter&nbsp;26.&nbsp;Mailman<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-mailman" aria-label="Anchor link for: module services mailman" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-mailman-basic-usage" shape="rect">26.1. Basic usage</a></span></dt></dl></div><p>
    <a class="link" href="https://www.list.org/" target="_top" shape="rect">Mailman</a> is free
    software for managing electronic mail discussion and e-newsletter
    lists. Mailman and its web interface can be configured using the
    corresponding NixOS module. Note that this service is best used with
    an existing, securely configured Postfix setup, as it does not automatically configure this.
  </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-mailman-basic-usage" class="title" style="clear: both">26.1.&nbsp;Basic usage<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-mailman-basic-usage" aria-label="Anchor link for: module services mailman basic usage" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
      For a basic configuration, the following settings are suggested:
      </p><pre class="programlisting hljs nix" xml:space="preserve">{ config, ... }: {
  services.<span class="hljs-attr"><span class="hljs-attr">postfix</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">relayDomains</span></span> = [<span class="hljs-string"><span class="hljs-string">"hash:/var/lib/mailman/data/postfix_domains"</span></span>];
    <span class="hljs-attr"><span class="hljs-attr">sslCert</span></span> = config.security.acme.certs.<span class="hljs-string"><span class="hljs-string">"lists.example.org"</span></span>.directory + <span class="hljs-string"><span class="hljs-string">"/full.pem"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">sslKey</span></span> = config.security.acme.certs.<span class="hljs-string"><span class="hljs-string">"lists.example.org"</span></span>.directory + <span class="hljs-string"><span class="hljs-string">"/key.pem"</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">config</span></span> = {
      <span class="hljs-attr"><span class="hljs-attr">transport_maps</span></span> = [<span class="hljs-string"><span class="hljs-string">"hash:/var/lib/mailman/data/postfix_lmtp"</span></span>];
      <span class="hljs-attr"><span class="hljs-attr">local_recipient_maps</span></span> = [<span class="hljs-string"><span class="hljs-string">"hash:/var/lib/mailman/data/postfix_lmtp"</span></span>];
    };
  };
  services.<span class="hljs-attr"><span class="hljs-attr">mailman</span></span> = {
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.mailman.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.mailman.serve.enable" shape="rect">serve.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.mailman.hyperkitty.enable" shape="rect">hyperkitty.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.mailman.hyperkitty.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">webHosts</span></span></a> = [<span class="hljs-string"><span class="hljs-string">"lists.example.org"</span></span>];
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.mailman.hyperkitty.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">siteOwner</span></span></a> = <span class="hljs-string"><span class="hljs-string">"mailman@example.org"</span></span>;
  };
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.enableACME" shape="rect">services.nginx.virtualHosts.<span class="hljs-string"><span class="hljs-string">"lists.example.org"</span></span>.<span class="hljs-attr"><span class="hljs-attr">enableACME</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.mailman.hyperkitty.enable" shape="rect">networking.firewall.<span class="hljs-attr"><span class="hljs-attr">allowedTCPPorts</span></span></a> = [ <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ];
}</pre><p>
    </p><p>
      DNS records will also be required:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">AAAA</code> and <code class="literal">A</code> records pointing to the host in question, in order for browsers to be able to discover the address of the web server;</p></li><li class="listitem"><p>An <code class="literal">MX</code> record pointing to a domain name at which the host is reachable, in order for other mail servers to be able to deliver emails to the mailing lists it hosts.</p></li></ul></div><p>
    </p><p>
      After this has been done and appropriate DNS records have been
      set up, the Postorius mailing list manager and the Hyperkitty
      archive browser will be available at
      https://lists.example.org/. Note that this setup is not
      sufficient to deliver emails to most email providers nor to
      avoid spam -- a number of additional measures for authenticating
      incoming and outgoing mails, such as SPF, DMARC and DKIM are
      necessary, but outside the scope of the Mailman module.
    </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="trezor" class="title">Chapter&nbsp;27.&nbsp;Trezor<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#trezor" aria-label="Anchor link for: trezor" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Trezor is an open-source cryptocurrency hardware wallet and security token
  allowing secure storage of private keys.
 </p><p>
  It offers advanced features such U2F two-factor authorization, SSH login
  through
  <a class="link" href="https://wiki.trezor.io/Apps:SSH_agent" target="_top" shape="rect">Trezor SSH agent</a>,
  <a class="link" href="https://wiki.trezor.io/GPG" target="_top" shape="rect">GPG</a> and a
  <a class="link" href="https://wiki.trezor.io/Trezor_Password_Manager" target="_top" shape="rect">password manager</a>.
  For more information, guides and documentation, see <a class="link" href="https://wiki.trezor.io/" target="_top" shape="rect">https://wiki.trezor.io</a>.
 </p><p>
  To enable Trezor support, add the following to your <code class="filename">configuration.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.trezord.enable" shape="rect"><code class="option">services.trezord.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
  This will add all necessary udev rules and start Trezor Bridge.
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-emacs" class="title">Chapter&nbsp;28.&nbsp;Emacs<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs" aria-label="Anchor link for: module services emacs" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-emacs-installing" shape="rect">28.1. Installing <span class="application">Emacs</span></a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-emacs-running" shape="rect">28.2. Running Emacs as a Service</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-emacs-configuring" shape="rect">28.3. Configuring Emacs</a></span></dt></dl></div><p>
  <a class="link" href="https://www.gnu.org/software/emacs/" target="_top" shape="rect">Emacs</a> is an
  extensible, customizable, self-documenting real-time display editor — and
  more. At its core is an interpreter for Emacs Lisp, a dialect of the Lisp
  programming language with extensions to support text editing.
 </p><p>
  Emacs runs within a graphical desktop environment using the X Window System,
  but works equally well on a text terminal. Under
  <span class="productname">macOS</span>, a "Mac port" edition is available, which
  uses Apple's native GUI frameworks.
 </p><p>
  <span class="productname">Nixpkgs</span> provides a superior environment for
  running <span class="application">Emacs</span>. It's simple to create custom builds
  by overriding the default packages. Chaotic collections of Emacs Lisp code
  and extensions can be brought under control using declarative package
  management. <span class="productname">NixOS</span> even provides a
  <span class="command"><strong>systemd</strong></span> user service for automatically starting the Emacs
  daemon.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-emacs-installing" class="title" style="clear: both">28.1.&nbsp;Installing <span class="application">Emacs</span><a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs-installing" aria-label="Anchor link for: module services emacs installing" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Emacs can be installed in the normal way for Nix (see
   <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-package-management" title="Chapter 6. Package Management" shape="rect">Chapter&nbsp;6, <em>Package Management</em></a>). In addition, a NixOS
   <span class="emphasis"><em>service</em></span> can be enabled.
  </p><section class="section"><div class="titlepage"><div><div><h3 id="module-services-emacs-releases" class="title">28.1.1.&nbsp;The Different Releases of Emacs<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs-releases" aria-label="Anchor link for: module services emacs releases" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    <span class="productname">Nixpkgs</span> defines several basic Emacs packages.
    The following are attributes belonging to the <code class="varname">pkgs</code> set:
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
       <code class="varname">emacs</code>
      , </span><span class="term">
       <code class="varname">emacs</code>
      </span></dt><dd><p>
        The latest stable version of Emacs using the
        <a class="link" href="http://www.gtk.org/" target="_top" shape="rect">GTK 2</a>
        widget toolkit.
       </p></dd><dt><span class="term">
       <code class="varname">emacs-nox</code>
      </span></dt><dd><p>
        Emacs built without any dependency on X11 libraries.
       </p></dd><dt><span class="term">
       <code class="varname">emacsMacport</code>
      , </span><span class="term">
       <code class="varname">emacsMacport</code>
      </span></dt><dd><p>
        Emacs with the "Mac port" patches, providing a more native look and
        feel under macOS.
       </p></dd></dl></div><p>
   </p><p>
    If those aren't suitable, then the following imitation Emacs editors are
    also available in Nixpkgs:
    <a class="link" href="https://www.gnu.org/software/zile/" target="_top" shape="rect">Zile</a>,
    <a class="link" href="http://homepage.boetes.org/software/mg/" target="_top" shape="rect">mg</a>,
    <a class="link" href="http://yi-editor.github.io/" target="_top" shape="rect">Yi</a>,
    <a class="link" href="https://joe-editor.sourceforge.io/" target="_top" shape="rect">jmacs</a>.
   </p></section><section class="section"><div class="titlepage"><div><div><h3 id="module-services-emacs-adding-packages" class="title">28.1.2.&nbsp;Adding Packages to Emacs<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs-adding-packages" aria-label="Anchor link for: module services emacs adding packages" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    Emacs includes an entire ecosystem of functionality beyond text editing,
    including a project planner, mail and news reader, debugger interface,
    calendar, and more.
   </p><p>
    Most extensions are gotten with the Emacs packaging system
    (<code class="filename">package.el</code>) from
    <a class="link" href="https://elpa.gnu.org/" target="_top" shape="rect">Emacs Lisp Package Archive
    (<acronym class="acronym">ELPA</acronym>)</a>,
    <a class="link" href="https://melpa.org/" target="_top" shape="rect"><acronym class="acronym">MELPA</acronym></a>,
    <a class="link" href="https://stable.melpa.org/" target="_top" shape="rect">MELPA Stable</a>, and
    <a class="link" href="http://orgmode.org/elpa.html" target="_top" shape="rect">Org ELPA</a>. Nixpkgs is
    regularly updated to mirror all these archives.
   </p><p>
    Under NixOS, you can continue to use
    <code class="function">package-list-packages</code> and
    <code class="function">package-install</code> to install packages. You can also
    declare the set of Emacs packages you need using the derivations from
    Nixpkgs. The rest of this section discusses declarative installation of
    Emacs packages through nixpkgs.
   </p><p>
    The first step to declare the list of packages you want in your Emacs
    installation is to create a dedicated derivation. This can be done in a
    dedicated <code class="filename">emacs.nix</code> file such as:
    </p><div class="example"><a id="ex-emacsNix" shape="rect"></a><p class="title"><strong>Example&nbsp;28.1.&nbsp;Nix expression to build Emacs with packages (<code class="filename">emacs.nix</code>)</strong></p><div class="example-contents"><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-comment"><span class="hljs-comment">/*
This is a nix expression to build Emacs and some Emacs packages I like
from source on any distribution where Nix is installed. This will install
all the dependencies from the nixpkgs repository and build the binary files
without interfering with the host distribution.

To build the project, type the following from the current directory:

$ nix-build emacs.nix

To run the newly compiled executable:

$ ./result/bin/emacs
*/</span></span>
{ pkgs ? <span class="hljs-built_in"><span class="hljs-built_in">import</span></span> &lt;nixpkgs&gt; {} }: <a id="ex-emacsNix-1" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/1.svg" alt="1" border="0"></span>

<span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
  <span class="hljs-attr"><span class="hljs-attr">myEmacs</span></span> = pkgs.emacs; <a id="ex-emacsNix-2" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/2.svg" alt="2" border="0"></span>
  <span class="hljs-attr"><span class="hljs-attr">emacsWithPackages</span></span> = (pkgs.emacsPackagesGen myEmacs).emacsWithPackages; <a id="ex-emacsNix-3" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/3.svg" alt="3" border="0"></span>
<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>
  emacsWithPackages (epkgs: (<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> epkgs.melpaStablePackages; [ <a id="ex-emacsNix-4" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/4.svg" alt="4" border="0"></span>
    magit          <span class="hljs-comment"><span class="hljs-comment"># ; Integrate git &lt;C-x g&gt;</span></span>
    zerodark-theme <span class="hljs-comment"><span class="hljs-comment"># ; Nicolas' theme</span></span>
  ]) ++ (<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> epkgs.melpaPackages; [ <a id="ex-emacsNix-5" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/5.svg" alt="5" border="0"></span>
    undo-tree      <span class="hljs-comment"><span class="hljs-comment"># ; &lt;C-x u&gt; to show the undo tree</span></span>
    zoom-frm       <span class="hljs-comment"><span class="hljs-comment"># ; increase/decrease font size for all buffers %lt;C-x C-+&gt;</span></span>
  ]) ++ (<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> epkgs.elpaPackages; [ <a id="ex-emacsNix-6" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/6.svg" alt="6" border="0"></span>
    auctex         <span class="hljs-comment"><span class="hljs-comment"># ; LaTeX mode</span></span>
    beacon         <span class="hljs-comment"><span class="hljs-comment"># ; highlight my cursor when scrolling</span></span>
    nameless       <span class="hljs-comment"><span class="hljs-comment"># ; hide current package name everywhere in elisp code</span></span>
  ]) ++ [
    pkgs.notmuch   <span class="hljs-comment"><span class="hljs-comment"># From main packages set </span></span><a id="ex-emacsNix-7" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/7.svg" alt="7" border="0"></span>
  ])
</pre></div></div><p><br class="example-break" clear="none"><br>
    </p><div class="calloutlist"><table class="table table-striped" border="0" summary="Callout list"><tbody><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#ex-emacsNix-1" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/1.svg" alt="1" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
       The first non-comment line in this file (<code class="literal">{ pkgs ? ...
       }</code>) indicates that the whole file represents a function.
      </p></td></tr><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#ex-emacsNix-2" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/2.svg" alt="2" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
       The <code class="varname">let</code> expression below defines a
       <code class="varname">myEmacs</code> binding pointing to the current stable
       version of Emacs. This binding is here to separate the choice of the
       Emacs binary from the specification of the required packages.
      </p></td></tr><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#ex-emacsNix-3" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/3.svg" alt="3" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
       This generates an <code class="varname">emacsWithPackages</code> function. It
       takes a single argument: a function from a package set to a list of
       packages (the packages that will be available in Emacs).
      </p></td></tr><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#ex-emacsNix-4" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/4.svg" alt="4" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
       The rest of the file specifies the list of packages to install. In the
       example, two packages (<code class="varname">magit</code> and
       <code class="varname">zerodark-theme</code>) are taken from MELPA stable.
      </p></td></tr><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#ex-emacsNix-5" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/5.svg" alt="5" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
       Two packages (<code class="varname">undo-tree</code> and
       <code class="varname">zoom-frm</code>) are taken from MELPA.
      </p></td></tr><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#ex-emacsNix-6" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/6.svg" alt="6" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
       Three packages are taken from GNU ELPA.
      </p></td></tr><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#ex-emacsNix-7" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/7.svg" alt="7" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
       <code class="varname">notmuch</code> is taken from a nixpkgs derivation which
       contains an Emacs mode.
      </p></td></tr></tbody></table></div><p>
   </p><p>
    The result of this configuration will be an <span class="command"><strong>emacs</strong></span>
    command which launches Emacs with all of your chosen packages in the
    <code class="varname">load-path</code>.
   </p><p>
    You can check that it works by executing this in a terminal:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-build emacs.nix
<code class="prompt">$ </code>./result/bin/emacs -q
</pre><p>
    and then typing <code class="literal">M-x package-initialize</code>. Check that you
    can use all the packages you want in this Emacs instance. For example, try
    switching to the zerodark theme through <code class="literal">M-x load-theme &lt;RET&gt;
    zerodark &lt;RET&gt; y</code>.
   </p><div class="tip"><h3 class="title" id="tip">Tip<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#tip" aria-label="Anchor link for: tip" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3><p>
     A few popular extensions worth checking out are: auctex, company,
     edit-server, flycheck, helm, iedit, magit, multiple-cursors, projectile,
     and yasnippet.
    </p></div><p>
    The list of available packages in the various ELPA repositories can be seen
    with the following commands:
    </p><div class="example"><a id="module-services-emacs-querying-packages" shape="rect"></a><p class="title"><strong>Example&nbsp;28.2.&nbsp;Querying Emacs packages</strong></p><div class="example-contents"><pre class="programlisting hljs nix" xml:space="preserve">nix-env -f <span class="hljs-string"><span class="hljs-string">"&lt;nixpkgs&gt;"</span></span> -qaP -A emacsPackages.elpaPackages
nix-env -f <span class="hljs-string"><span class="hljs-string">"&lt;nixpkgs&gt;"</span></span> -qaP -A emacsPackages.melpaPackages
nix-env -f <span class="hljs-string"><span class="hljs-string">"&lt;nixpkgs&gt;"</span></span> -qaP -A emacsPackages.melpaStablePackages
nix-env -f <span class="hljs-string"><span class="hljs-string">"&lt;nixpkgs&gt;"</span></span> -qaP -A emacsPackages.orgPackages
</pre></div></div><p><br class="example-break" clear="none"><br>
   </p><p>
    If you are on NixOS, you can install this particular Emacs for all users by
    adding it to the list of system packages (see
    <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-declarative-package-mgmt" title="6.1. Declarative Package Management" shape="rect">Section&nbsp;6.1, “Declarative Package Management”</a>). Simply modify your file
    <code class="filename">configuration.nix</code> to make it contain:
    </p><div class="example"><a id="module-services-emacs-configuration-nix" shape="rect"></a><p class="title"><strong>Example&nbsp;28.3.&nbsp;Custom Emacs in <code class="filename">configuration.nix</code></strong></p><div class="example-contents"><pre class="programlisting hljs nix" xml:space="preserve">{
 environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span> = [
   <span class="hljs-comment"><span class="hljs-comment"># [...]</span></span>
   (<span class="hljs-built_in"><span class="hljs-built_in">import</span></span> /path/to/emacs.nix { <span class="hljs-keyword"><span class="hljs-keyword">inherit</span></span> pkgs; })
  ];
}
</pre></div></div><p><br class="example-break" clear="none"><br>
   </p><p>
    In this case, the next <span class="command"><strong>nixos-rebuild switch</strong></span> will take
    care of adding your <span class="command"><strong>emacs</strong></span> to the <code class="varname">PATH</code>
    environment variable (see <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-changing-config" title="Chapter 3. Changing the Configuration" shape="rect">Chapter&nbsp;3, <em>Changing the Configuration</em></a>).
   </p><p>
    If you are not on NixOS or want to install this particular Emacs only for
    yourself, you can do so by adding it to your
    <code class="filename">~/.config/nixpkgs/config.nix</code> (see
    <a class="link" href="https://nixos.org/nixpkgs/manual/#sec-modify-via-packageOverrides" target="_top" shape="rect">Nixpkgs
    manual</a>):
    </p><div class="example"><a id="module-services-emacs-config-nix" shape="rect"></a><p class="title"><strong>Example&nbsp;28.4.&nbsp;Custom Emacs in <code class="filename">~/.config/nixpkgs/config.nix</code></strong></p><div class="example-contents"><pre class="programlisting hljs nix" xml:space="preserve">{
  <span class="hljs-attr"><span class="hljs-attr">packageOverrides</span></span> = super: <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-attr"><span class="hljs-attr">self</span></span> = super.pkgs; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {
    <span class="hljs-attr"><span class="hljs-attr">myemacs</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">import</span></span> /path/to/emacs.nix { <span class="hljs-attr"><span class="hljs-attr">pkgs</span></span> = self; };
  };
}
</pre></div></div><p><br class="example-break" clear="none"><br>
   </p><p>
    In this case, the next <code class="literal">nix-env -f '&lt;nixpkgs&gt;' -iA
    myemacs</code> will take care of adding your emacs to the
    <code class="varname">PATH</code> environment variable.
   </p></section><section class="section"><div class="titlepage"><div><div><h3 id="module-services-emacs-advanced" class="title">28.1.3.&nbsp;Advanced Emacs Configuration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs-advanced" aria-label="Anchor link for: module services emacs advanced" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    If you want, you can tweak the Emacs package itself from your
    <code class="filename">emacs.nix</code>. For example, if you want to have a
    GTK 3-based Emacs instead of the default GTK 2-based binary and remove the
    automatically generated <code class="filename">emacs.desktop</code> (useful if you
    only use <span class="command"><strong>emacsclient</strong></span>), you can change your file
    <code class="filename">emacs.nix</code> in this way:
   </p><div class="example"><a id="ex-emacsGtk3Nix" shape="rect"></a><p class="title"><strong>Example&nbsp;28.5.&nbsp;Custom Emacs build</strong></p><div class="example-contents"><pre class="programlisting hljs nix" xml:space="preserve">{ pkgs ? <span class="hljs-built_in"><span class="hljs-built_in">import</span></span> &lt;nixpkgs&gt; {} }:
<span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
  <span class="hljs-attr"><span class="hljs-attr">myEmacs</span></span> = (pkgs.emacs.override {
    <span class="hljs-comment"><span class="hljs-comment"># Use gtk3 instead of the default gtk2</span></span>
    <span class="hljs-attr"><span class="hljs-attr">withGTK3</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">withGTK2</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
  }).overrideAttrs (attrs: {
    <span class="hljs-comment"><span class="hljs-comment"># I don't want emacs.desktop file because I only use</span></span>
    <span class="hljs-comment"><span class="hljs-comment"># emacsclient.</span></span>
    <span class="hljs-attr"><span class="hljs-attr">postInstall</span></span> = (attrs.postInstall <span class="hljs-literal"><span class="hljs-literal">or</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">''
      rm $out/share/applications/emacs.desktop
    ''</span></span>;
  });
<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [...]
</pre></div></div><br class="example-break" clear="none"><br><p>
    After building this file as shown in <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-emacsNix" title="Example 28.1. Nix expression to build Emacs with packages (emacs.nix)" shape="rect">Example&nbsp;28.1, “Nix expression to build Emacs with packages (<code class="filename">emacs.nix</code>)”</a>, you
    will get an GTK 3-based Emacs binary pre-loaded with your favorite packages.
   </p></section></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-emacs-running" class="title" style="clear: both">28.2.&nbsp;Running Emacs as a Service<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs-running" aria-label="Anchor link for: module services emacs running" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   <span class="productname">NixOS</span> provides an optional
   <span class="command"><strong>systemd</strong></span> service which launches
   <a class="link" href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html" target="_top" shape="rect">
   Emacs daemon </a> with the user's login session.
  </p><p>
   <span class="emphasis"><em>Source:</em></span>
   <code class="filename">modules/services/editors/emacs.nix</code>
  </p><section class="section"><div class="titlepage"><div><div><h3 id="module-services-emacs-enabling" class="title">28.2.1.&nbsp;Enabling the Service<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs-enabling" aria-label="Anchor link for: module services emacs enabling" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    To install and enable the <span class="command"><strong>systemd</strong></span> user service for Emacs
    daemon, add the following to your <code class="filename">configuration.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.emacs.enable" shape="rect"><code class="option">services.emacs.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.emacs.package" shape="rect"><code class="option">services.emacs.<span class="hljs-attr"><span class="hljs-attr">package</span></span></code></a> = <span class="hljs-built_in"><span class="hljs-built_in">import</span></span> /home/cassou/.emacs.d { <span class="hljs-attr"><span class="hljs-attr">pkgs</span></span> = pkgs; };
</pre><p>
   </p><p>
    The <code class="varname">services.emacs.package</code> option allows a custom
    derivation to be used, for example, one created by
    <code class="function">emacsWithPackages</code>.
   </p><p>
    Ensure that the Emacs server is enabled for your user's Emacs
    configuration, either by customizing the <code class="varname">server-mode</code>
    variable, or by adding <code class="literal">(server-start)</code> to
    <code class="filename">~/.emacs.d/init.el</code>.
   </p><p>
    To start the daemon, execute the following:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>nixos-rebuild switch  <span class="hljs-comment"><span class="hljs-comment"># to activate the new configuration.nix</span></span>
<code class="prompt">$ </code>systemctl --user daemon-reload        <span class="hljs-comment"><span class="hljs-comment"># to force systemd reload</span></span>
<code class="prompt">$ </code>systemctl --user start emacs.service  <span class="hljs-comment"><span class="hljs-comment"># to start the Emacs daemon</span></span>
</pre><p>
    The server should now be ready to serve Emacs clients.
   </p></section><section class="section"><div class="titlepage"><div><div><h3 id="module-services-emacs-starting-client" class="title">28.2.2.&nbsp;Starting the client<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs-starting-client" aria-label="Anchor link for: module services emacs starting client" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    Ensure that the emacs server is enabled, either by customizing the
    <code class="varname">server-mode</code> variable, or by adding
    <code class="literal">(server-start)</code> to <code class="filename">~/.emacs</code>.
   </p><p>
    To connect to the emacs daemon, run one of the following:
</p><pre class="programlisting hljs nix" xml:space="preserve">emacsclient FILENAME
emacsclient --create-frame  <span class="hljs-comment"><span class="hljs-comment"># opens a new frame (window)</span></span>
emacsclient --create-frame --tty  <span class="hljs-comment"><span class="hljs-comment"># opens a new frame on the current terminal</span></span>
</pre><p>
   </p></section><section class="section"><div class="titlepage"><div><div><h3 id="module-services-emacs-editor-variable" class="title">28.2.3.&nbsp;Configuring the <code class="varname">EDITOR</code> variable<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs-editor-variable" aria-label="Anchor link for: module services emacs editor variable" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    If <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.emacs.defaultEditor" shape="rect"><code class="option">services.emacs.defaultEditor</code></a> is
    <code class="literal">true</code>, the <code class="varname">EDITOR</code> variable will be set
    to a wrapper script which launches <span class="command"><strong>emacsclient</strong></span>.
   </p><p>
    Any setting of <code class="varname">EDITOR</code> in the shell config files will
    override <code class="varname">services.emacs.defaultEditor</code>. To make sure
    <code class="varname">EDITOR</code> refers to the Emacs wrapper script, remove any
    existing <code class="varname">EDITOR</code> assignment from
    <code class="filename">.profile</code>, <code class="filename">.bashrc</code>,
    <code class="filename">.zshenv</code> or any other shell config file.
   </p><p>
    If you have formed certain bad habits when editing files, these can be
    corrected with a shell alias to the wrapper script:
</p><pre class="programlisting hljs bash" xml:space="preserve"><span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> vi=<span class="hljs-variable"><span class="hljs-variable">$EDITOR</span></span></pre><p>
   </p></section><section class="section"><div class="titlepage"><div><div><h3 id="module-services-emacs-per-user" class="title">28.2.4.&nbsp;Per-User Enabling of the Service<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs-per-user" aria-label="Anchor link for: module services emacs per user" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    In general, <span class="command"><strong>systemd</strong></span> user services are globally enabled
    by symlinks in <code class="filename">/etc/systemd/user</code>. In the case where
    Emacs daemon is not wanted for all users, it is possible to install the
    service but not globally enable it:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.emacs.enable" shape="rect"><code class="option">services.emacs.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.emacs.install" shape="rect"><code class="option">services.emacs.<span class="hljs-attr"><span class="hljs-attr">install</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
   </p><p>
    To enable the <span class="command"><strong>systemd</strong></span> user service for just the
    currently logged in user, run:
</p><pre class="programlisting hljs bash" xml:space="preserve">systemctl --user <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> emacs</pre><p>
    This will add the symlink
    <code class="filename">~/.config/systemd/user/emacs.service</code>.
   </p></section></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-emacs-configuring" class="title" style="clear: both">28.3.&nbsp;Configuring Emacs<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs-configuring" aria-label="Anchor link for: module services emacs configuring" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   The Emacs init file should be changed to load the extension packages at
   startup:
   </p><div class="example"><a id="module-services-emacs-package-initialisation" shape="rect"></a><p class="title"><strong>Example&nbsp;28.6.&nbsp;Package initialization in <code class="filename">.emacs</code></strong></p><div class="example-contents"><pre class="programlisting hljs" xml:space="preserve">(require 'package)

;; optional. makes unpure packages archives unavailable
(setq package-archives nil)

(setq package-enable-at-startup nil)
(package-initialize)
</pre></div></div><p><br class="example-break" clear="none"><br>
  </p><p>
   After the declarative emacs package configuration has been tested,
   previously downloaded packages can be cleaned up by removing
   <code class="filename">~/.emacs.d/elpa</code> (do make a backup first, in case you
   forgot a package).
  </p><section class="section"><div class="titlepage"><div><div><h3 id="module-services-emacs-major-mode" class="title">28.3.1.&nbsp;A Major Mode for Nix Expressions<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs-major-mode" aria-label="Anchor link for: module services emacs major mode" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    Of interest may be <code class="varname">melpaPackages.nix-mode</code>, which
    provides syntax highlighting for the Nix language. This is particularly
    convenient if you regularly edit Nix files.
   </p></section><section class="section"><div class="titlepage"><div><div><h3 id="module-services-emacs-man-pages" class="title">28.3.2.&nbsp;Accessing man pages<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-emacs-man-pages" aria-label="Anchor link for: module services emacs man pages" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    You can use <code class="function">woman</code> to get completion of all available
    man pages. For example, type <code class="literal">M-x woman &lt;RET&gt; nixos-rebuild
    &lt;RET&gt;.</code>
   </p></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-emacs-docbook-xml" class="title">28.3.3.&nbsp;Editing DocBook 5 XML Documents<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-emacs-docbook-xml" aria-label="Anchor link for: sec emacs docbook xml" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    Emacs includes
    <a class="link" href="https://www.gnu.org/software/emacs/manual/html_node/nxml-mode/Introduction.html" target="_top" shape="rect">nXML</a>,
    a major-mode for validating and editing XML documents. When editing DocBook
    5.0 documents, such as <a class="link" href="https://nixos.org/manual/nixos/stable/index.html" title="NixOS Manual" shape="rect">this one</a>,
    nXML needs to be configured with the relevant schema, which is not
    included.
   </p><p>
    To install the DocBook 5.0 schemas, either add
    <code class="varname">pkgs.docbook5</code> to
    <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.systemPackages</code></a>
    (<a class="link" href="https://nixos.org/manual/nixos/stable/index.html#sec-declarative-package-mgmt" title="6.1. Declarative Package Management" shape="rect">NixOS</a>), or run
    <code class="literal">nix-env -f '&lt;nixpkgs&gt;' -iA docbook5</code>
    (<a class="link" href="https://nixos.org/manual/nixos/stable/index.html#sec-ad-hoc-packages" title="6.2. Ad-Hoc Package Management" shape="rect">Nix</a>).
   </p><p>
    Then customize the variable <code class="varname">rng-schema-locating-files</code> to
    include <code class="filename">~/.emacs.d/schemas.xml</code> and put the following
    text into that file:
    </p><div class="example"><a id="ex-emacs-docbook-xml" shape="rect"></a><p class="title"><strong>Example&nbsp;28.7.&nbsp;nXML Schema Configuration (<code class="filename">~/.emacs.d/schemas.xml</code>)</strong></p><div class="example-contents"><pre class="programlisting hljs nix" xml:space="preserve">&lt;?xml <span class="hljs-attr"><span class="hljs-attr">version="1.0"?&gt;</span></span>
&lt;!--
  To <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> emacs find this file, evaluate:
  (add-to-list 'rng-schema-locating-files <span class="hljs-string"><span class="hljs-string">"~/.emacs.d/schemas.xml"</span></span>)
--&gt;
&lt;locatingRules <span class="hljs-attr"><span class="hljs-attr">xmlns="http://thaiopensource.com/ns/locating-rules/1.0"&gt;</span></span>
  &lt;!--
    Use this variation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pkgs.docbook5 is added to environment.systemPackages
  --&gt;
  &lt;namespace <span class="hljs-attr"><span class="hljs-attr">ns="http://docbook.org/ns/docbook"</span></span>
             <span class="hljs-attr"><span class="hljs-attr">uri="/run/current-system/sw/share/xml/docbook-5.0/rng/docbookxi.rnc"/&gt;</span></span>
  &lt;!--
    Use this variation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> installing schema <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-string"><span class="hljs-string">"nix-env -iA pkgs.docbook5"</span></span>.
  &lt;namespace <span class="hljs-attr"><span class="hljs-attr">ns="http://docbook.org/ns/docbook"</span></span>
             <span class="hljs-attr"><span class="hljs-attr">uri="../.nix-profile/share/xml/docbook-5.0/rng/docbookxi.rnc"/&gt;</span></span>
  --&gt;
&lt;/locatingRules&gt;
</pre></div></div><p><br class="example-break" clear="none"><br>
   </p></section></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-flatpak" class="title">Chapter&nbsp;29.&nbsp;Flatpak<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-flatpak" aria-label="Anchor link for: module services flatpak" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  <span class="emphasis"><em>Source:</em></span>
  <code class="filename">modules/services/desktop/flatpak.nix</code>
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span>
  <a class="link" href="https://github.com/flatpak/flatpak/wiki" target="_top" shape="rect">https://github.com/flatpak/flatpak/wiki</a>
 </p><p>
  Flatpak is a system for building, distributing, and running sandboxed desktop
  applications on Linux.
 </p><p>
  To enable Flatpak, add the following to your
  <code class="filename">configuration.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve">  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.flatpak.enable" shape="rect"><code class="option">services.flatpak.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
 </p><p>
  For the sandboxed apps to work correctly, desktop integration portals need to
  be installed. If you run GNOME, this will be handled automatically for you;
  in other cases, you will need to add something like the following to your
  <code class="filename">configuration.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve">  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-xdg.portal.extraPortals" shape="rect"><code class="option">xdg.portal.<span class="hljs-attr"><span class="hljs-attr">extraPortals</span></span></code></a> = [ pkgs.xdg-desktop-portal-gtk ];
</pre><p>
 </p><p>
  Then, you will need to add a repository, for example,
  <a class="link" href="https://github.com/flatpak/flatpak/wiki" target="_top" shape="rect">Flathub</a>,
  either using the following commands:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>flatpak remote-add --<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
<code class="prompt">$ </code>flatpak update
</pre><p>
  or by opening the
  <a class="link" href="https://flathub.org/repo/flathub.flatpakrepo" target="_top" shape="rect">repository
  file</a> in GNOME Software.
 </p><p>
  Finally, you can search and install programs:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>flatpak search bustle
<code class="prompt">$ </code>flatpak install flathub org.freedesktop.Bustle
<code class="prompt">$ </code>flatpak run org.freedesktop.Bustle
</pre><p>
  Again, GNOME Software offers graphical interface for these tasks.
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-postgresql" class="title">Chapter&nbsp;30.&nbsp;PostgreSQL<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-postgresql" aria-label="Anchor link for: module postgresql" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-postgres-configuring" shape="rect">30.1. Configuring</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-postgres-upgrading" shape="rect">30.2. Upgrading</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-postgres-options" shape="rect">30.3. Options</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-postgres-plugins" shape="rect">30.4. Plugins</a></span></dt></dl></div><p>
  <span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/databases/postgresql.nix</code>
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="http://www.postgresql.org/docs/" target="_top" shape="rect">http://www.postgresql.org/docs/</a>
 </p><p>
  PostgreSQL is an advanced, free relational database.

 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-postgres-configuring" class="title" style="clear: both">30.1.&nbsp;Configuring<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-postgres-configuring" aria-label="Anchor link for: module services postgres configuring" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   To enable PostgreSQL, add the following to your <code class="filename">configuration.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.enable" shape="rect"><code class="option">services.postgresql.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.package" shape="rect"><code class="option">services.postgresql.<span class="hljs-attr"><span class="hljs-attr">package</span></span></code></a> = pkgs.postgresql_11;
</pre><p>
   Note that you are required to specify the desired version of PostgreSQL (e.g. <code class="literal">pkgs.postgresql_11</code>). Since upgrading your PostgreSQL version requires a database dump and reload (see below), NixOS cannot provide a default value for <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.package" shape="rect"><code class="option">services.postgresql.package</code></a> such as the most recent release of PostgreSQL.
  </p><p>
   By default, PostgreSQL stores its databases in <code class="filename">/var/lib/postgresql/$psqlSchema</code>. You can override this using <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.dataDir" shape="rect"><code class="option">services.postgresql.dataDir</code></a>, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.dataDir" shape="rect"><code class="option">services.postgresql.<span class="hljs-attr"><span class="hljs-attr">dataDir</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"/data/postgresql"</span></span>;
</pre><p>
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-postgres-upgrading" class="title" style="clear: both">30.2.&nbsp;Upgrading<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-postgres-upgrading" aria-label="Anchor link for: module services postgres upgrading" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Major PostgreSQL upgrade requires PostgreSQL downtime and a few imperative steps to be called. To simplify this process, use the following NixOS module:
</p><pre class="programlisting hljs bash" xml:space="preserve">  containers.temp-pg.config.services.postgresql = {
    <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    package = pkgs.postgresql_12;
    <span class="hljs-comment"><span class="hljs-comment">## set a custom new dataDir</span></span>
    <span class="hljs-comment"><span class="hljs-comment"># dataDir = "/some/data/dir";</span></span>
  };
  environment.systemPackages =
    <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> newpg = config.containers.temp-pg.config.services.postgresql;
    <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [
      (pkgs.writeScriptBin <span class="hljs-string"><span class="hljs-string">"upgrade-pg-cluster"</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>
        <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> -x
        <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> OLDDATA=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${config.services.postgresql.dataDir}</span></span></span><span class="hljs-string">"</span></span>
        <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> NEWDATA=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${newpg.dataDir}</span></span></span><span class="hljs-string">"</span></span>
        <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> OLDBIN=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${config.services.postgresql.package}</span></span></span><span class="hljs-string">/bin"</span></span>
        <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> NEWBIN=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${newpg.package}</span></span></span><span class="hljs-string">/bin"</span></span>

        install -d -m 0700 -o postgres -g postgres <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NEWDATA</span></span></span><span class="hljs-string">"</span></span>
        <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NEWDATA</span></span></span><span class="hljs-string">"</span></span>
        sudo -u postgres <span class="hljs-variable"><span class="hljs-variable">$NEWBIN</span></span>/initdb -D <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NEWDATA</span></span></span><span class="hljs-string">"</span></span>

        systemctl stop postgresql    <span class="hljs-comment"><span class="hljs-comment"># old one</span></span>

        sudo -u postgres <span class="hljs-variable"><span class="hljs-variable">$NEWBIN</span></span>/pg_upgrade \
          --old-datadir <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$OLDDATA</span></span></span><span class="hljs-string">"</span></span> --new-datadir <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NEWDATA</span></span></span><span class="hljs-string">"</span></span> \
          --old-bindir <span class="hljs-variable"><span class="hljs-variable">$OLDBIN</span></span> --new-bindir <span class="hljs-variable"><span class="hljs-variable">$NEWBIN</span></span> \
          <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$@</span></span></span><span class="hljs-string">"</span></span>
      <span class="hljs-string"><span class="hljs-string">''</span></span>)
    ];
</pre><p>
  </p><p>
   The upgrade process is:
  </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
     Rebuild nixos configuration with the configuration above added to your <code class="filename">configuration.nix</code>. Alternatively, add that into separate file and reference it in <code class="literal">imports</code> list.
    </p></li><li class="listitem"><p>
     Login as root (<code class="literal">sudo su -</code>)
    </p></li><li class="listitem"><p>
     Run <code class="literal">upgrade-pg-cluster</code>. It will stop old postgresql, initialize new one and migrate old one to new one. You may supply arguments like <code class="literal">--jobs 4</code> and <code class="literal">--link</code> to speedup migration process. See <a class="link" href="https://www.postgresql.org/docs/current/pgupgrade.html" target="_top" shape="rect">https://www.postgresql.org/docs/current/pgupgrade.html</a> for details.
    </p></li><li class="listitem"><p>
     Change postgresql package in NixOS configuration to the one you were upgrading to, and change <code class="literal">dataDir</code> to the one you have migrated to. Rebuild NixOS. This should start new postgres using upgraded data directory.
    </p></li><li class="listitem"><p>
     After upgrade you may want to <code class="literal">ANALYZE</code> new db.
    </p></li></ol></div></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-postgres-options" class="title" style="clear: both">30.3.&nbsp;Options<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-postgres-options" aria-label="Anchor link for: module services postgres options" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   A complete list of options for the PostgreSQL module may be found <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.enable" shape="rect">here</a>.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-postgres-plugins" class="title" style="clear: both">30.4.&nbsp;Plugins<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-postgres-plugins" aria-label="Anchor link for: module services postgres plugins" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Plugins collection for each PostgreSQL version can be accessed with <code class="literal">.pkgs</code>. For example, for <code class="literal">pkgs.postgresql_11</code> package, its plugin collection is accessed by <code class="literal">pkgs.postgresql_11.pkgs</code>:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>nix repl <span class="hljs-string"><span class="hljs-string">'&lt;nixpkgs&gt;'</span></span>

Loading <span class="hljs-string"><span class="hljs-string">'&lt;nixpkgs&gt;'</span></span>...
Added 10574 variables.

<code class="prompt">nix-repl&gt; </code>postgresql_11.pkgs.&lt;TAB&gt;&lt;TAB&gt;
postgresql_11.pkgs.cstore_fdw        postgresql_11.pkgs.pg_repack
postgresql_11.pkgs.pg_auto_failover  postgresql_11.pkgs.pg_safeupdate
postgresql_11.pkgs.pg_bigm           postgresql_11.pkgs.pg_similarity
postgresql_11.pkgs.pg_cron           postgresql_11.pkgs.pg_topn
postgresql_11.pkgs.pg_hll            postgresql_11.pkgs.pgjwt
postgresql_11.pkgs.pg_partman        postgresql_11.pkgs.pgroonga
...
</pre><p>
  </p><p>
   To add plugins via NixOS configuration, set <code class="literal">services.postgresql.extraPlugins</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.package" shape="rect"><code class="option">services.postgresql.<span class="hljs-attr"><span class="hljs-attr">package</span></span></code></a> = pkgs.postgresql_11;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.extraPlugins" shape="rect"><code class="option">services.postgresql.<span class="hljs-attr"><span class="hljs-attr">extraPlugins</span></span></code></a> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> pkgs.postgresql_11.pkgs; [
  pg_repack
  postgis
];
</pre><p>
  </p><p>
   You can build custom PostgreSQL-with-plugins (to be used outside of NixOS) using function <code class="literal">.withPackages</code>. For example, creating a custom PostgreSQL package in an overlay can look like:
</p><pre class="programlisting hljs nix" xml:space="preserve">self: super: {
  <span class="hljs-attr"><span class="hljs-attr">postgresql_custom</span></span> = self.postgresql_11.withPackages (ps: [
    ps.pg_repack
    ps.postgis
  ]);
}
</pre><p>
  </p><p>
   Here's a recipe on how to override a particular plugin through an overlay:
</p><pre class="programlisting hljs nix" xml:space="preserve">self: super: {
  <span class="hljs-attr"><span class="hljs-attr">postgresql_11</span></span> = super.postgresql_11.override { <span class="hljs-attr"><span class="hljs-attr">this</span></span> = self.postgresql_11; } // {
    <span class="hljs-attr"><span class="hljs-attr">pkgs</span></span> = super.postgresql_11.pkgs // {
      <span class="hljs-attr"><span class="hljs-attr">pg_repack</span></span> = super.postgresql_11.pkgs.pg_repack.overrideAttrs (_: {
        <span class="hljs-attr"><span class="hljs-attr">name</span></span> = <span class="hljs-string"><span class="hljs-string">"pg_repack-v20181024"</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">src</span></span> = self.fetchzip {
          <span class="hljs-attr"><span class="hljs-attr">url</span></span> = <span class="hljs-string"><span class="hljs-string">"https://github.com/reorg/pg_repack/archive/923fa2f3c709a506e111cc963034bf2fd127aa00.tar.gz"</span></span>;
          <span class="hljs-attr"><span class="hljs-attr">sha256</span></span> = <span class="hljs-string"><span class="hljs-string">"17k6hq9xaax87yz79j773qyigm4fwk8z4zh5cyp6z0sxnwfqxxw5"</span></span>;
        };
      });
    };
  };
}
</pre><p>
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-foundationdb" class="title">Chapter&nbsp;31.&nbsp;FoundationDB<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb" aria-label="Anchor link for: module services foundationdb" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-foundationdb-configuring" shape="rect">31.1. Configuring and basic setup</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-foundationdb-scaling" shape="rect">31.2. Scaling processes and backup agents</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-foundationdb-clustering" shape="rect">31.3. Clustering</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-foundationdb-connectivity" shape="rect">31.4. Client connectivity</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-foundationdb-authorization" shape="rect">31.5. Client authorization and TLS</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-foundationdb-disaster-recovery" shape="rect">31.6. Backups and Disaster Recovery</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-foundationdb-limitations" shape="rect">31.7. Known limitations</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-foundationdb-options" shape="rect">31.8. Options</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-foundationdb-full-docs" shape="rect">31.9. Full documentation</a></span></dt></dl></div><p>
  <span class="emphasis"><em>Source:</em></span>
  <code class="filename">modules/services/databases/foundationdb.nix</code>
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span>
  <a class="link" href="https://apple.github.io/foundationdb/" target="_top" shape="rect">https://apple.github.io/foundationdb/</a>
 </p><p>
  <span class="emphasis"><em>Maintainer:</em></span> Austin Seipp
 </p><p>
  <span class="emphasis"><em>Available version(s):</em></span> 5.1.x, 5.2.x, 6.0.x
 </p><p>
  FoundationDB (or "FDB") is an open source, distributed, transactional
  key-value store.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-foundationdb-configuring" class="title" style="clear: both">31.1.&nbsp;Configuring and basic setup<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-configuring" aria-label="Anchor link for: module services foundationdb configuring" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   To enable FoundationDB, add the following to your
   <code class="filename">configuration.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve">services.foundationdb.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
services.foundationdb.<span class="hljs-attr"><span class="hljs-attr">package</span></span> = pkgs.foundationdb52; <span class="hljs-comment"><span class="hljs-comment"># FoundationDB 5.2.x</span></span>
</pre><p>
  </p><p>
   The <code class="option">services.foundationdb.package</code> option is required, and
   must always be specified. Due to the fact FoundationDB network protocols and
   on-disk storage formats may change between (major) versions, and upgrades
   must be explicitly handled by the user, you must always manually specify
   this yourself so that the NixOS module will use the proper version. Note
   that minor, bugfix releases are always compatible.
  </p><p>
   After running <span class="command"><strong>nixos-rebuild</strong></span>, you can verify whether
   FoundationDB is running by executing <span class="command"><strong>fdbcli</strong></span> (which is
   added to <code class="option">environment.systemPackages</code>):
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>sudo -u foundationdb fdbcli
Using cluster file `/etc/foundationdb/fdb.cluster'.

The database is available.

Welcome to the fdbcli. For help, type `help'.
<code class="prompt">fdb&gt; </code>status

Using cluster file `/etc/foundationdb/fdb.cluster'.

Configuration:
  Redundancy mode        - single
  Storage engine         - memory
  Coordinators           - <span class="hljs-number"><span class="hljs-number">1</span></span>

Cluster:
  FoundationDB processes - <span class="hljs-number"><span class="hljs-number">1</span></span>
  Machines               - <span class="hljs-number"><span class="hljs-number">1</span></span>
  Memory availability    - <span class="hljs-number"><span class="hljs-number">5.4</span></span> GB per process on machine <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> least available
  Fault Tolerance        - <span class="hljs-number"><span class="hljs-number">0</span></span> machines
  Server time            - <span class="hljs-number"><span class="hljs-number">04</span></span>/<span class="hljs-number"><span class="hljs-number">20</span></span>/<span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>

...

<code class="prompt">fdb&gt;</code>
</pre><p>
  </p><p>
   You can also write programs using the available client libraries. For
   example, the following Python program can be run in order to grab the
   cluster status, as a quick example. (This example uses
   <span class="command"><strong>nix-shell</strong></span> shebang support to automatically supply the
   necessary Python modules).
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">a@link&gt; </code>cat fdb-status.py
<span class="hljs-comment"><span class="hljs-comment">#! /usr/bin/env nix-shell</span></span>
<span class="hljs-comment"><span class="hljs-comment">#! nix-shell -i python -p python pythonPackages.foundationdb52</span></span>

import fdb
import json

def main():
    fdb.api_version(520)
    db = fdb.open()

    @fdb.transactional
    def get_status(tr):
        <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> str(tr[<span class="hljs-string"><span class="hljs-string">'\xff\xff/status/json'</span></span>])

    obj = json.loads(get_status(db))
    <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">'FoundationDB available: %s'</span></span> % obj[<span class="hljs-string"><span class="hljs-string">'client'</span></span>][<span class="hljs-string"><span class="hljs-string">'database_status'</span></span>][<span class="hljs-string"><span class="hljs-string">'available'</span></span>])

<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>:
    main()
<code class="prompt">a@link&gt; </code>chmod +x fdb-status.py
<code class="prompt">a@link&gt; </code>./fdb-status.py
FoundationDB available: True
<code class="prompt">a@link&gt;</code>
</pre><p>
  </p><p>
   FoundationDB is run under the <span class="command"><strong>foundationdb</strong></span> user and group
   by default, but this may be changed in the NixOS configuration. The systemd
   unit <span class="command"><strong>foundationdb.service</strong></span> controls the
   <span class="command"><strong>fdbmonitor</strong></span> process.
  </p><p>
   By default, the NixOS module for FoundationDB creates a single SSD-storage
   based database for development and basic usage. This storage engine is
   designed for SSDs and will perform poorly on HDDs; however it can handle far
   more data than the alternative "memory" engine and is a better default
   choice for most deployments. (Note that you can change the storage backend
   on-the-fly for a given FoundationDB cluster using
   <span class="command"><strong>fdbcli</strong></span>.)
  </p><p>
   Furthermore, only 1 server process and 1 backup agent are started in the
   default configuration. See below for more on scaling to increase this.
  </p><p>
   FoundationDB stores all data for all server processes under
   <code class="filename">/var/lib/foundationdb</code>. You can override this using
   <code class="option">services.foundationdb.dataDir</code>, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve">services.foundationdb.<span class="hljs-attr"><span class="hljs-attr">dataDir</span></span> = <span class="hljs-string"><span class="hljs-string">"/data/fdb"</span></span>;
</pre><p>
  </p><p>
   Similarly, logs are stored under <code class="filename">/var/log/foundationdb</code>
   by default, and there is a corresponding
   <code class="option">services.foundationdb.logDir</code> as well.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-foundationdb-scaling" class="title" style="clear: both">31.2.&nbsp;Scaling processes and backup agents<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-scaling" aria-label="Anchor link for: module services foundationdb scaling" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Scaling the number of server processes is quite easy; simply specify
   <code class="option">services.foundationdb.serverProcesses</code> to be the number of
   FoundationDB worker processes that should be started on the machine.
  </p><p>
   FoundationDB worker processes typically require 4GB of RAM per-process at
   minimum for good performance, so this option is set to 1 by default since
   the maximum amount of RAM is unknown. You're advised to abide by this
   restriction, so pick a number of processes so that each has 4GB or more.
  </p><p>
   A similar option exists in order to scale backup agent processes,
   <code class="option">services.foundationdb.backupProcesses</code>. Backup agents are
   not as performance/RAM sensitive, so feel free to experiment with the number
   of available backup processes.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-foundationdb-clustering" class="title" style="clear: both">31.3.&nbsp;Clustering<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-clustering" aria-label="Anchor link for: module services foundationdb clustering" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   FoundationDB on NixOS works similarly to other Linux systems, so this
   section will be brief. Please refer to the full FoundationDB documentation
   for more on clustering.
  </p><p>
   FoundationDB organizes clusters using a set of
   <span class="emphasis"><em>coordinators</em></span>, which are just specially-designated
   worker processes. By default, every installation of FoundationDB on NixOS
   will start as its own individual cluster, with a single coordinator: the
   first worker process on <span class="command"><strong>localhost</strong></span>.
  </p><p>
   Coordinators are specified globally using the
   <span class="command"><strong>/etc/foundationdb/fdb.cluster</strong></span> file, which all servers and
   client applications will use to find and join coordinators. Note that this
   file <span class="emphasis"><em>can not</em></span> be managed by NixOS so easily:
   FoundationDB is designed so that it will rewrite the file at runtime for all
   clients and nodes when cluster coordinators change, with clients
   transparently handling this without intervention. It is fundamentally a
   mutable file, and you should not try to manage it in any way in NixOS.
  </p><p>
   When dealing with a cluster, there are two main things you want to do:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Add a node to the cluster for storage/compute.
    </p></li><li class="listitem"><p>
     Promote an ordinary worker to a coordinator.
    </p></li></ul></div><p>
   A node must already be a member of the cluster in order to properly be
   promoted to a coordinator, so you must always add it first if you wish to
   promote it.
  </p><p>
   To add a machine to a FoundationDB cluster:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Choose one of the servers to start as the initial coordinator.
    </p></li><li class="listitem"><p>
     Copy the <span class="command"><strong>/etc/foundationdb/fdb.cluster</strong></span> file from this
     server to all the other servers. Restart FoundationDB on all of these
     other servers, so they join the cluster.
    </p></li><li class="listitem"><p>
     All of these servers are now connected and working together in the
     cluster, under the chosen coordinator.
    </p></li></ul></div><p>
   At this point, you can add as many nodes as you want by just repeating the
   above steps. By default there will still be a single coordinator: you can
   use <span class="command"><strong>fdbcli</strong></span> to change this and add new coordinators.
  </p><p>
   As a convenience, FoundationDB can automatically assign coordinators based
   on the redundancy mode you wish to achieve for the cluster. Once all the
   nodes have been joined, simply set the replication policy, and then issue
   the <span class="command"><strong>coordinators auto</strong></span> command
  </p><p>
   For example, assuming we have 3 nodes available, we can enable double
   redundancy mode, then auto-select coordinators. For double redundancy, 3
   coordinators is ideal: therefore FoundationDB will make
   <span class="emphasis"><em>every</em></span> node a coordinator automatically:
  </p><pre class="screen hljs" xml:space="preserve"><code class="prompt">fdbcli&gt; </code>configure double ssd
<code class="prompt">fdbcli&gt; </code>coordinators auto
</pre><p>
   This will transparently update all the servers within seconds, and
   appropriately rewrite the <span class="command"><strong>fdb.cluster</strong></span> file, as well as
   informing all client processes to do the same.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-foundationdb-connectivity" class="title" style="clear: both">31.4.&nbsp;Client connectivity<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-connectivity" aria-label="Anchor link for: module services foundationdb connectivity" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   By default, all clients must use the current <span class="command"><strong>fdb.cluster</strong></span>
   file to access a given FoundationDB cluster. This file is located by default
   in <span class="command"><strong>/etc/foundationdb/fdb.cluster</strong></span> on all machines with the
   FoundationDB service enabled, so you may copy the active one from your
   cluster to a new node in order to connect, if it is not part of the cluster.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-foundationdb-authorization" class="title" style="clear: both">31.5.&nbsp;Client authorization and TLS<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-authorization" aria-label="Anchor link for: module services foundationdb authorization" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   By default, any user who can connect to a FoundationDB process with the
   correct cluster configuration can access anything. FoundationDB uses a
   pluggable design to transport security, and out of the box it supports a
   LibreSSL-based plugin for TLS support. This plugin not only does in-flight
   encryption, but also performs client authorization based on the given
   endpoint's certificate chain. For example, a FoundationDB server may be
   configured to only accept client connections over TLS, where the client TLS
   certificate is from organization <span class="emphasis"><em>Acme Co</em></span> in the
   <span class="emphasis"><em>Research and Development</em></span> unit.
  </p><p>
   Configuring TLS with FoundationDB is done using the
   <code class="option">services.foundationdb.tls</code> options in order to control the
   peer verification string, as well as the certificate and its private key.
  </p><p>
   Note that the certificate and its private key must be accessible to the
   FoundationDB user account that the server runs under. These files are also
   NOT managed by NixOS, as putting them into the store may reveal private
   information.
  </p><p>
   After you have a key and certificate file in place, it is not enough to
   simply set the NixOS module options -- you must also configure the
   <span class="command"><strong>fdb.cluster</strong></span> file to specify that a given set of
   coordinators use TLS. This is as simple as adding the suffix
   <span class="command"><strong>:tls</strong></span> to your cluster coordinator configuration, after the
   port number. For example, assuming you have a coordinator on localhost with
   the default configuration, simply specifying:
  </p><pre class="programlisting hljs" xml:space="preserve">XXXXXX:XXXXXX@127.0.0.1:4500:tls
</pre><p>
   will configure all clients and server processes to use TLS from now on.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-foundationdb-disaster-recovery" class="title" style="clear: both">31.6.&nbsp;Backups and Disaster Recovery<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-disaster-recovery" aria-label="Anchor link for: module services foundationdb disaster recovery" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   The usual rules for doing FoundationDB backups apply on NixOS as written in
   the FoundationDB manual. However, one important difference is the security
   profile for NixOS: by default, the <span class="command"><strong>foundationdb</strong></span> systemd
   unit uses <span class="emphasis"><em>Linux namespaces</em></span> to restrict write access to
   the system, except for the log directory, data directory, and the
   <span class="command"><strong>/etc/foundationdb/</strong></span> directory. This is enforced by default
   and cannot be disabled.
  </p><p>
   However, a side effect of this is that the <span class="command"><strong>fdbbackup</strong></span>
   command doesn't work properly for local filesystem backups: FoundationDB
   uses a server process alongside the database processes to perform backups
   and copy the backups to the filesystem. As a result, this process is put
   under the restricted namespaces above: the backup process can only write to
   a limited number of paths.
  </p><p>
   In order to allow flexible backup locations on local disks, the FoundationDB
   NixOS module supports a
   <code class="option">services.foundationdb.extraReadWritePaths</code> option. This
   option takes a list of paths, and adds them to the systemd unit, allowing
   the processes inside the service to write (and read) the specified
   directories.
  </p><p>
   For example, to create backups in <span class="command"><strong>/opt/fdb-backups</strong></span>, first
   set up the paths in the module options:
  </p><pre class="programlisting hljs nix" xml:space="preserve">services.foundationdb.<span class="hljs-attr"><span class="hljs-attr">extraReadWritePaths</span></span> = [ <span class="hljs-string"><span class="hljs-string">"/opt/fdb-backups"</span></span> ];
</pre><p>
   Restart the FoundationDB service, and it will now be able to write to this
   directory (even if it does not yet exist.) Note: this path
   <span class="emphasis"><em>must</em></span> exist before restarting the unit. Otherwise,
   systemd will not include it in the private FoundationDB namespace (and it
   will not add it dynamically at runtime).
  </p><p>
   You can now perform a backup:
  </p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>sudo -u foundationdb fdbbackup start  -t default -d file:///opt/fdb-backups
<code class="prompt">$ </code>sudo -u foundationdb fdbbackup status -t default
</pre></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-foundationdb-limitations" class="title" style="clear: both">31.7.&nbsp;Known limitations<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-limitations" aria-label="Anchor link for: module services foundationdb limitations" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   The FoundationDB setup for NixOS should currently be considered beta.
   FoundationDB is not new software, but the NixOS compilation and integration
   has only undergone fairly basic testing of all the available functionality.
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     There is no way to specify individual parameters for individual
     <span class="command"><strong>fdbserver</strong></span> processes. Currently, all server processes
     inherit all the global <span class="command"><strong>fdbmonitor</strong></span> settings.
    </p></li><li class="listitem"><p>
     Ruby bindings are not currently installed.
    </p></li><li class="listitem"><p>
     Go bindings are not currently installed.
    </p></li></ul></div></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-foundationdb-options" class="title" style="clear: both">31.8.&nbsp;Options<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-options" aria-label="Anchor link for: module services foundationdb options" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   NixOS's FoundationDB module allows you to configure all of the most relevant
   configuration options for <span class="command"><strong>fdbmonitor</strong></span>, matching it quite
   closely. A complete list of options for the FoundationDB module may be found
   <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.foundationdb.enable" shape="rect">here</a>. You should
   also read the FoundationDB documentation as well.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-foundationdb-full-docs" class="title" style="clear: both">31.9.&nbsp;Full documentation<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-full-docs" aria-label="Anchor link for: module services foundationdb full docs" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   FoundationDB is a complex piece of software, and requires careful
   administration to properly use. Full documentation for administration can be
   found here: <a class="link" href="https://apple.github.io/foundationdb/" target="_top" shape="rect">https://apple.github.io/foundationdb/</a>.
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-borgbase" class="title">Chapter&nbsp;32.&nbsp;BorgBackup<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-borgbase" aria-label="Anchor link for: module borgbase" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-backup-borgbackup-configuring" shape="rect">32.1. Configuring</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#opt-services-backup-borgbackup-local-directory" shape="rect">32.2. Basic usage for a local backup</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#opt-services-backup-create-server" shape="rect">32.3. Create a borg backup server</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#opt-services-backup-borgbackup-remote-server" shape="rect">32.4. Backup to the borg repository server</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#opt-services-backup-borgbackup-borgbase" shape="rect">32.5. Backup to a hosting service</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#opt-services-backup-borgbackup-vorta" shape="rect">32.6. Vorta backup client for the desktop</a></span></dt></dl></div><p>
  <span class="emphasis"><em>Source:</em></span>
  <code class="filename">modules/services/backup/borgbackup.nix</code>
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span>
  <a class="link" href="https://borgbackup.readthedocs.io/" target="_top" shape="rect">https://borgbackup.readthedocs.io/</a>
 </p><p>
  <a class="link" href="https://www.borgbackup.org/" target="_top" shape="rect">BorgBackup</a> (short: Borg)
  is a deduplicating backup program. Optionally, it supports compression and
  authenticated encryption.
  </p><p>
  The main goal of Borg is to provide an efficient and secure way to backup
  data. The data deduplication technique used makes Borg suitable for daily
  backups since only changes are stored. The authenticated encryption technique
  makes it suitable for backups to not fully trusted targets.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-services-backup-borgbackup-configuring" class="title" style="clear: both">32.1.&nbsp;Configuring<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-backup-borgbackup-configuring" aria-label="Anchor link for: module services backup borgbackup configuring" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   A complete list of options for the Borgbase module may be found
   <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.borgbackup.jobs" shape="rect">here</a>.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="opt-services-backup-borgbackup-local-directory" class="title" style="clear: both">32.2.&nbsp;Basic usage for a local backup<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#opt-services-backup-borgbackup-local-directory" aria-label="Anchor link for: opt services backup borgbackup local directory" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   A very basic configuration for backing up to a locally accessible directory
   is:
</p><pre class="programlisting hljs nix" xml:space="preserve">{
    opt.services.borgbackup.<span class="hljs-attr"><span class="hljs-attr">jobs</span></span> = {
      { <span class="hljs-attr"><span class="hljs-attr">rootBackup</span></span> = {
          <span class="hljs-attr"><span class="hljs-attr">paths</span></span> = <span class="hljs-string"><span class="hljs-string">"/"</span></span>;
          <span class="hljs-attr"><span class="hljs-attr">exclude</span></span> = [ <span class="hljs-string"><span class="hljs-string">"/nix"</span></span> <span class="hljs-string"><span class="hljs-string">"/path/to/local/repo"</span></span> ];
          <span class="hljs-attr"><span class="hljs-attr">repo</span></span> = <span class="hljs-string"><span class="hljs-string">"/path/to/local/repo"</span></span>;
          <span class="hljs-attr"><span class="hljs-attr">doInit</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
          <span class="hljs-attr"><span class="hljs-attr">encryption</span></span> = {
            <span class="hljs-attr"><span class="hljs-attr">mode</span></span> = <span class="hljs-string"><span class="hljs-string">"repokey"</span></span>;
            <span class="hljs-attr"><span class="hljs-attr">passphrase</span></span> = <span class="hljs-string"><span class="hljs-string">"secret"</span></span>;
          };
          <span class="hljs-attr"><span class="hljs-attr">compression</span></span> = <span class="hljs-string"><span class="hljs-string">"auto,lzma"</span></span>;
          <span class="hljs-attr"><span class="hljs-attr">startAt</span></span> = <span class="hljs-string"><span class="hljs-string">"weekly"</span></span>;
        };
      }
    };
}</pre><p>
  </p><div class="alert alert-warning"><strong>Warning:</strong> 
        If you do not want the passphrase to be stored in the world-readable
        Nix store, use passCommand. You find an example below.
    </div></section><section class="section"><div class="titlepage"><div><div><h2 id="opt-services-backup-create-server" class="title" style="clear: both">32.3.&nbsp;Create a borg backup server<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#opt-services-backup-create-server" aria-label="Anchor link for: opt services backup create server" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>You should use a different SSH key for each repository you write to,
    because the specified keys are restricted to running borg serve and can only
    access this single repository. You need the output of the generate pub file.
  </p><p>
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">sudo ssh-keygen -N '' -t ed25519 -f /run/keys/id_ed25519_my_borg_repo</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">cat /run/keys/id_ed25519_my_borg_repo</span></span>
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAID78zmOyA+<span class="hljs-number"><span class="hljs-number">5</span></span>uPG4Ot0hfAy+sLDPU1L4AiIoRYEIVbbQ/ root@nixos</pre><p>
    </p><p>
      Add the following snippet to your NixOS configuration:
      </p><pre class="programlisting hljs nix" xml:space="preserve">{
  services.borgbackup.<span class="hljs-attr"><span class="hljs-attr">repos</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">my_borg_repo</span></span> = {
      <span class="hljs-attr"><span class="hljs-attr">authorizedKeys</span></span> = [
        <span class="hljs-string"><span class="hljs-string">"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAID78zmOyA+5uPG4Ot0hfAy+sLDPU1L4AiIoRYEIVbbQ/ root@nixos"</span></span>
      ] ;
      <span class="hljs-attr"><span class="hljs-attr">path</span></span> = <span class="hljs-string"><span class="hljs-string">"/var/lib/my_borg_repo"</span></span> ;
    };
  };
}</pre><p>
    </p></section><section class="section"><div class="titlepage"><div><div><h2 id="opt-services-backup-borgbackup-remote-server" class="title" style="clear: both">32.4.&nbsp;Backup to the borg repository server<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#opt-services-backup-borgbackup-remote-server" aria-label="Anchor link for: opt services backup borgbackup remote server" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>The following NixOS snippet creates an hourly backup to the service
    (on the host nixos) as created in the section above. We assume
    that you have stored a secret passphrasse in the file
    <code class="code">/run/keys/borgbackup_passphrase</code>, which should be only
    accessible by root
  </p><p>
      </p><pre class="programlisting hljs nix" xml:space="preserve">{
  services.borgbackup.<span class="hljs-attr"><span class="hljs-attr">jobs</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">backupToLocalServer</span></span> = {
      <span class="hljs-attr"><span class="hljs-attr">paths</span></span> = [ <span class="hljs-string"><span class="hljs-string">"/etc/nixos"</span></span> ];
      <span class="hljs-attr"><span class="hljs-attr">doInit</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">repo</span></span> =  <span class="hljs-string"><span class="hljs-string">"borg@nixos:."</span></span> ;
      <span class="hljs-attr"><span class="hljs-attr">encryption</span></span> = {
        <span class="hljs-attr"><span class="hljs-attr">mode</span></span> = <span class="hljs-string"><span class="hljs-string">"repokey-blake2"</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">passCommand</span></span> = <span class="hljs-string"><span class="hljs-string">"cat /run/keys/borgbackup_passphrase"</span></span>;
      };
      <span class="hljs-attr"><span class="hljs-attr">environment</span></span> = { <span class="hljs-attr"><span class="hljs-attr">BORG_RSH</span></span> = <span class="hljs-string"><span class="hljs-string">"ssh -i /run/keys/id_ed25519_my_borg_repo"</span></span>; };
      <span class="hljs-attr"><span class="hljs-attr">compression</span></span> = <span class="hljs-string"><span class="hljs-string">"auto,lzma"</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">startAt</span></span> = <span class="hljs-string"><span class="hljs-string">"hourly"</span></span>;
    };
  };
};</pre><p>
  </p><p>The following few commands (run as root) let you test your backup.
      </p><pre class="programlisting hljs nix" xml:space="preserve">&gt; nixos-rebuild switch
...restarting the following units: polkit.service
&gt; systemctl restart borgbackup-job-backupToLocalServer
&gt; sleep <span class="hljs-number"><span class="hljs-number">10</span></span>
&gt; systemctl restart borgbackup-job-backupToLocalServer
&gt; export <span class="hljs-attr"><span class="hljs-attr">BORG_PASSPHRASE=topSecrect</span></span>
&gt; borg list <span class="hljs-attr"><span class="hljs-attr">--rsh='ssh</span></span> -i /run/keys/id_ed25519_my_borg_repo' borg@nixos:.
nixos-backupToLocalServer-<span class="hljs-number"><span class="hljs-number">2020</span></span>-<span class="hljs-number"><span class="hljs-number">03</span></span>-<span class="hljs-number"><span class="hljs-number">30</span></span>T21:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span> Mon, <span class="hljs-number"><span class="hljs-number">2020</span></span>-<span class="hljs-number"><span class="hljs-number">03</span></span>-<span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> [<span class="hljs-number"><span class="hljs-number">84</span></span>feb97710954931ca384182f5f3cb90665f35cef214760abd7350fb064786ac]
nixos-backupToLocalServer-<span class="hljs-number"><span class="hljs-number">2020</span></span>-<span class="hljs-number"><span class="hljs-number">03</span></span>-<span class="hljs-number"><span class="hljs-number">30</span></span>T21:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span> Mon, <span class="hljs-number"><span class="hljs-number">2020</span></span>-<span class="hljs-number"><span class="hljs-number">03</span></span>-<span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">32</span></span> [e77321694ecd160ca2228611747c6ad1be177d6e0d894538898de7a2621b6e68]</pre><p>
    </p></section><section class="section"><div class="titlepage"><div><div><h2 id="opt-services-backup-borgbackup-borgbase" class="title" style="clear: both">32.5.&nbsp;Backup to a hosting service<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#opt-services-backup-borgbackup-borgbase" aria-label="Anchor link for: opt services backup borgbackup borgbase" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
    Several companies offer <a class="link" href="https://www.borgbackup.org/support/commercial.html" target="_top" shape="rect">(paid)
      hosting services</a> for Borg repositories.
  </p><p>
    To backup your home directory to borgbase you have to:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      Generate a SSH key without a password, to access the remote server. E.g.
    </p><p>
        </p><pre class="programlisting hljs bash" xml:space="preserve">sudo ssh-keygen -N <span class="hljs-string"><span class="hljs-string">''</span></span> -t ed25519 -f /run/keys/id_ed25519_borgbase</pre><p>
    </p></li><li class="listitem"><p>
      Create the repository on the server by following the instructions for your
      hosting server.
    </p></li><li class="listitem"><p>
      Initialize the repository on the server. Eg.
      </p><pre class="programlisting hljs nix" xml:space="preserve">sudo borg init <span class="hljs-attr"><span class="hljs-attr">--encryption=repokey-blake2</span></span>  \
    -rsh <span class="hljs-string"><span class="hljs-string">"ssh -i /run/keys/id_ed25519_borgbase"</span></span> \
    zzz2aaaaa@zzz2aaaaa.repo.borgbase.com:repo</pre><p>
  </p></li><li class="listitem"><p>Add it to your NixOS configuration, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve">{
    services.borgbackup.<span class="hljs-attr"><span class="hljs-attr">jobs</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">my_Remote_Backup</span></span> = {
        <span class="hljs-attr"><span class="hljs-attr">paths</span></span> = [ <span class="hljs-string"><span class="hljs-string">"/"</span></span> ];
        <span class="hljs-attr"><span class="hljs-attr">exclude</span></span> = [ <span class="hljs-string"><span class="hljs-string">"/nix"</span></span> <span class="hljs-string"><span class="hljs-string">"'**/.cache'"</span></span> ];
        <span class="hljs-attr"><span class="hljs-attr">repo</span></span> =  <span class="hljs-string"><span class="hljs-string">"zzz2aaaaa@zzz2aaaaa.repo.borgbase.com:repo"</span></span>;
          <span class="hljs-attr"><span class="hljs-attr">encryption</span></span> = {
          <span class="hljs-attr"><span class="hljs-attr">mode</span></span> = <span class="hljs-string"><span class="hljs-string">"repokey-blake2"</span></span>;
          <span class="hljs-attr"><span class="hljs-attr">passCommand</span></span> = <span class="hljs-string"><span class="hljs-string">"cat /run/keys/borgbackup_passphrase"</span></span>;
        };
        <span class="hljs-attr"><span class="hljs-attr">BORG_RSH</span></span> = <span class="hljs-string"><span class="hljs-string">"ssh -i /run/keys/id_ed25519_borgbase"</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">compression</span></span> = <span class="hljs-string"><span class="hljs-string">"auto,lzma"</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">startAt</span></span> = <span class="hljs-string"><span class="hljs-string">"daily"</span></span>;
    };
  };
}}</pre><p>
  </p></li></ul></div></section><section class="section"><div class="titlepage"><div><div><h2 id="opt-services-backup-borgbackup-vorta" class="title" style="clear: both">32.6.&nbsp;Vorta backup client for the desktop<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#opt-services-backup-borgbackup-vorta" aria-label="Anchor link for: opt services backup borgbackup vorta" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
    Vorta is a backup client for macOS and Linux desktops. It integrates the
    mighty BorgBackup with your desktop environment to protect your data from
    disk failure, ransomware and theft.
  </p><p>
   It can be installed in NixOS e.g. by adding <span class="package">pkgs.vorta</span>
   to <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.systemPackages</code></a>.
  </p><p>
    Details about using Vorta can be found under <a class="link" href="https://vorta.borgbase.com/usage" target="_top" shape="rect">https://vorta.borgbase.com
      </a>.
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-hidepid" class="title">Chapter&nbsp;33.&nbsp;Hiding process information<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-hidepid" aria-label="Anchor link for: sec hidepid" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Setting
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.hideProcessInformation" shape="rect"><code class="option">security.<span class="hljs-attr"><span class="hljs-attr">hideProcessInformation</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
  ensures that access to process information is restricted to the owning user.
  This implies, among other things, that command-line arguments remain private.
  Unless your deployment relies on unprivileged users being able to inspect the
  process information of other users, this option should be safe to enable.
 </p><p>
  Members of the <code class="literal">proc</code> group are exempt from process
  information hiding.
 </p><p>
  To allow a service <em class="replaceable"><code>foo</code></em> to run without process
  information hiding, set
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-systemd.services._name_.serviceConfig" shape="rect">systemd.services.<em class="replaceable"><code>foo</code></em>.serviceConfig</a>.<span class="hljs-attr"><span class="hljs-attr">SupplementaryGroups</span></span> = [ <span class="hljs-string"><span class="hljs-string">"proc"</span></span> ];
</pre><p>
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-security-acme" class="title">Chapter&nbsp;34.&nbsp;SSL/TLS Certificates with ACME<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-security-acme" aria-label="Anchor link for: module security acme" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-security-acme-prerequisites" shape="rect">34.1. Prerequisites</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-security-acme-nginx" shape="rect">34.2. Using ACME certificates in Nginx</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-security-acme-httpd" shape="rect">34.3. Using ACME certificates in Apache/httpd</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-security-acme-configuring" shape="rect">34.4. Manual configuration of HTTP-01 validation</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-security-acme-config-dns" shape="rect">34.5. Configuring ACME for DNS validation</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-security-acme-regenerate" shape="rect">34.6. Regenerating certificates</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-security-acme-fix-jws" shape="rect">34.7. Fixing JWS Verification error</a></span></dt></dl></div><p>
  NixOS supports automatic domain validation &amp; certificate retrieval and
  renewal using the ACME protocol. Any provider can be used, but by default
  NixOS uses Let's Encrypt. The alternative ACME client <code class="literal">lego</code>
  is used under the hood.
 </p><p>
  Automatic cert validation and configuration for Apache and Nginx virtual
  hosts is included in NixOS, however if you would like to generate a wildcard
  cert or you are not using a web server you will have to configure DNS
  based validation.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-security-acme-prerequisites" class="title" style="clear: both">34.1.&nbsp;Prerequisites<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-security-acme-prerequisites" aria-label="Anchor link for: module security acme prerequisites" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   To use the ACME module, you must accept the provider's terms of service
   by setting <code class="literal"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.acceptTerms" shape="rect"><code class="option">security.acme.acceptTerms</code></a></code>
   to <code class="literal">true</code>. The Let's Encrypt ToS can be found
   <a class="link" href="https://letsencrypt.org/repository/" target="_top" shape="rect">here</a>.
  </p><p>
   You must also set an email address to be used when creating accounts with
   Let's Encrypt. You can set this for all certs with
   <code class="literal"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.email" shape="rect"><code class="option">security.acme.email</code></a></code>
   and/or on a per-cert basis with
   <code class="literal"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.email" shape="rect"><code class="option">security.acme.certs.&lt;name&gt;.email</code></a></code>.
   This address is only used for registration and renewal reminders,
   and cannot be used to administer the certificates in any way.
  </p><p>
   Alternatively, you can use a different ACME server by changing the
   <code class="literal"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.server" shape="rect"><code class="option">security.acme.server</code></a></code> option
   to a provider of your choosing, or just change the server for one cert with
   <code class="literal"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.server" shape="rect"><code class="option">security.acme.certs.&lt;name&gt;.server</code></a></code>.
  </p><p>
   You will need an HTTP server or DNS server for verification. For HTTP,
   the server must have a webroot defined that can serve
   <code class="filename">.well-known/acme-challenge</code>. This directory must be
   writeable by the user that will run the ACME client. For DNS, you must
   set up credentials with your provider/server for use with lego.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-security-acme-nginx" class="title" style="clear: both">34.2.&nbsp;Using ACME certificates in Nginx<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-security-acme-nginx" aria-label="Anchor link for: module security acme nginx" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   NixOS supports fetching ACME certificates for you by setting
   <code class="literal"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.enableACME" shape="rect">enableACME</a>
   = true;</code> in a virtualHost config. We first create self-signed
   placeholder certificates in place of the real ACME certs. The placeholder
   certs are overwritten when the ACME certs arrive. For
   <code class="literal">foo.example.com</code> the config would look like.
  </p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.acceptTerms" shape="rect"><code class="option">security.acme.<span class="hljs-attr"><span class="hljs-attr">acceptTerms</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.email" shape="rect"><code class="option">security.acme.<span class="hljs-attr"><span class="hljs-attr">email</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"admin+acme@example.com"</span></span>;
services.<span class="hljs-attr"><span class="hljs-attr">nginx</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts" shape="rect"><span class="hljs-attr"><span class="hljs-attr">virtualHosts</span></span></a> = {
    <span class="hljs-string"><span class="hljs-string">"foo.example.com"</span></span> = {
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.forceSSL" shape="rect"><span class="hljs-attr"><span class="hljs-attr">forceSSL</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.enableACME" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enableACME</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      <span class="hljs-comment"><span class="hljs-comment"># All serverAliases will be added as </span></span><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.extraDomainNames" shape="rect"><span class="hljs-comment"><span class="hljs-comment">extra domain names</span></span></a><span class="hljs-comment"><span class="hljs-comment"> on the certificate.</span></span>
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.serverAliases" shape="rect"><span class="hljs-attr"><span class="hljs-attr">serverAliases</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"bar.example.com"</span></span> ];
      locations.<span class="hljs-string"><span class="hljs-string">"/"</span></span> = {
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.locations._name_.root" shape="rect"><span class="hljs-attr"><span class="hljs-attr">root</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/www"</span></span>;
      };
    };

    <span class="hljs-comment"><span class="hljs-comment"># We can also add a different vhost and reuse the same certificate</span></span>
    <span class="hljs-comment"><span class="hljs-comment"># but we have to append extraDomainNames manually.</span></span>
    <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.extraDomainNames" shape="rect">security.acme.certs.<span class="hljs-string"><span class="hljs-string">"foo.example.com"</span></span>.<span class="hljs-attr"><span class="hljs-attr">extraDomainNames</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"baz.example.com"</span></span> ];
    <span class="hljs-string"><span class="hljs-string">"baz.example.com"</span></span> = {
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.forceSSL" shape="rect"><span class="hljs-attr"><span class="hljs-attr">forceSSL</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.useACMEHost" shape="rect"><span class="hljs-attr"><span class="hljs-attr">useACMEHost</span></span></a> = <span class="hljs-string"><span class="hljs-string">"foo.example.com"</span></span>;
      locations.<span class="hljs-string"><span class="hljs-string">"/"</span></span> = {
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.locations._name_.root" shape="rect"><span class="hljs-attr"><span class="hljs-attr">root</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/www"</span></span>;
      };
    };
  };
}
</pre></section><section class="section"><div class="titlepage"><div><div><h2 id="module-security-acme-httpd" class="title" style="clear: both">34.3.&nbsp;Using ACME certificates in Apache/httpd<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-security-acme-httpd" aria-label="Anchor link for: module security acme httpd" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Using ACME certificates with Apache virtual hosts is identical
   to using them with Nginx. The attribute names are all the same, just replace
   "nginx" with "httpd" where appropriate.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-security-acme-configuring" class="title" style="clear: both">34.4.&nbsp;Manual configuration of HTTP-01 validation<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-security-acme-configuring" aria-label="Anchor link for: module security acme configuring" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   First off you will need to set up a virtual host to serve the challenges.
   This example uses a vhost called <code class="literal">certs.example.com</code>, with
   the intent that you will generate certs for all your vhosts and redirect
   everyone to HTTPS.
  </p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.acceptTerms" shape="rect"><code class="option">security.acme.<span class="hljs-attr"><span class="hljs-attr">acceptTerms</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.email" shape="rect"><code class="option">security.acme.<span class="hljs-attr"><span class="hljs-attr">email</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"admin+acme@example.com"</span></span>;
services.<span class="hljs-attr"><span class="hljs-attr">nginx</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts" shape="rect"><span class="hljs-attr"><span class="hljs-attr">virtualHosts</span></span></a> = {
    <span class="hljs-string"><span class="hljs-string">"acmechallenge.example.com"</span></span> = {
      <span class="hljs-comment"><span class="hljs-comment"># Catchall vhost, will redirect users to HTTPS for all vhosts</span></span>
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.serverAliases" shape="rect"><span class="hljs-attr"><span class="hljs-attr">serverAliases</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"*.example.com"</span></span> ];
      <span class="hljs-comment"><span class="hljs-comment"># /var/lib/acme/.challenges must be writable by the ACME user</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># and readable by the Nginx user.</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># By default, this is the case.</span></span>
      locations.<span class="hljs-string"><span class="hljs-string">"/.well-known/acme-challenge"</span></span> = {
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.locations._name_.root" shape="rect"><span class="hljs-attr"><span class="hljs-attr">root</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/lib/acme/.challenges"</span></span>;
      };
      locations.<span class="hljs-string"><span class="hljs-string">"/"</span></span> = {
        <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.virtualHosts._name_.locations._name_.return" shape="rect"><span class="hljs-attr"><span class="hljs-attr">return</span></span></a> = <span class="hljs-string"><span class="hljs-string">"301 https://$host$request_uri"</span></span>;
      };
    };
  };
}
<span class="hljs-comment"><span class="hljs-comment"># Alternative config for Apache</span></span>
services.<span class="hljs-attr"><span class="hljs-attr">httpd</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</a>
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.virtualHosts" shape="rect"><span class="hljs-attr"><span class="hljs-attr">virtualHosts</span></span></a> = {
    <span class="hljs-string"><span class="hljs-string">"acmechallenge.example.com"</span></span> = {
      <span class="hljs-comment"><span class="hljs-comment"># Catchall vhost, will redirect users to HTTPS for all vhosts</span></span>
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.virtualHosts._name_.serverAliases" shape="rect"><span class="hljs-attr"><span class="hljs-attr">serverAliases</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"*.example.com"</span></span> ];
      <span class="hljs-comment"><span class="hljs-comment"># /var/lib/acme/.challenges must be writable by the ACME user and readable by the Apache user.</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># By default, this is the case.</span></span>
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.virtualHosts._name_.documentRoot" shape="rect"><span class="hljs-attr"><span class="hljs-attr">documentRoot</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/lib/acme/.challenges"</span></span>;
      <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.virtualHosts._name_.extraConfig" shape="rect"><span class="hljs-attr"><span class="hljs-attr">extraConfig</span></span></a> = <span class="hljs-string"><span class="hljs-string">''
        RewriteEngine On
        RewriteCond %{HTTPS} off
        RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge [NC]
        RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R=301]
      ''</span></span>;
    };
  };
}
</pre><p>
   Now you need to configure ACME to generate a certificate.
  </p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs" shape="rect"><code class="option">security.acme.certs</code></a>.<span class="hljs-string"><span class="hljs-string">"foo.example.com"</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.webroot" shape="rect"><span class="hljs-attr"><span class="hljs-attr">webroot</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/lib/acme/.challenges"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.email" shape="rect"><span class="hljs-attr"><span class="hljs-attr">email</span></span></a> = <span class="hljs-string"><span class="hljs-string">"foo@example.com"</span></span>;
  <span class="hljs-comment"><span class="hljs-comment"># Ensure that the web server you use can read the generated certs</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># Take a look at the </span></span><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.nginx.group" shape="rect"><span class="hljs-comment"><span class="hljs-comment">group</span></span></a><span class="hljs-comment"><span class="hljs-comment"> option for the web server you choose.</span></span>
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.group" shape="rect"><span class="hljs-attr"><span class="hljs-attr">group</span></span></a> = <span class="hljs-string"><span class="hljs-string">"nginx"</span></span>;
  <span class="hljs-comment"><span class="hljs-comment"># Since we have a wildcard vhost to handle port 80,</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># we can generate certs for anything!</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># Just make sure your DNS resolves them.</span></span>
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.extraDomainNames" shape="rect"><span class="hljs-attr"><span class="hljs-attr">extraDomainNames</span></span></a> = [ <span class="hljs-string"><span class="hljs-string">"mail.example.com"</span></span> ];
};
</pre><p>
   The private key <code class="filename">key.pem</code> and certificate
   <code class="filename">fullchain.pem</code> will be put into
   <code class="filename">/var/lib/acme/foo.example.com</code>.
  </p><p>
   Refer to <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html" title="Appendix A. Configuration Options" shape="rect">Appendix&nbsp;A, <em>Configuration Options</em></a> for all available configuration
   options for the <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs" shape="rect">security.acme</a>
   module.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-security-acme-config-dns" class="title" style="clear: both">34.5.&nbsp;Configuring ACME for DNS validation<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-security-acme-config-dns" aria-label="Anchor link for: module security acme config dns" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   This is useful if you want to generate a wildcard certificate, since
   ACME servers will only hand out wildcard certs over DNS validation.
   There a number of supported DNS providers and servers you can utilise,
   see the <a class="link" href="https://go-acme.github.io/lego/dns/" target="_top" shape="rect">lego docs</a>
   for provider/server specific configuration values. For the sake of these
   docs, we will provide a fully self-hosted example using bind.
  </p><pre class="programlisting hljs nix" xml:space="preserve">services.<span class="hljs-attr"><span class="hljs-attr">bind</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.bind.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.bind.extraConfig" shape="rect"><span class="hljs-attr"><span class="hljs-attr">extraConfig</span></span></a> = <span class="hljs-string"><span class="hljs-string">''
    include "/var/lib/secrets/dnskeys.conf";
  ''</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.bind.zones" shape="rect"><span class="hljs-attr"><span class="hljs-attr">zones</span></span></a> = [
    <span class="hljs-keyword"><span class="hljs-keyword">rec</span></span> {
      <span class="hljs-attr"><span class="hljs-attr">name</span></span> = <span class="hljs-string"><span class="hljs-string">"example.com"</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">file</span></span> = <span class="hljs-string"><span class="hljs-string">"/var/db/bind/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${name}</span></span></span><span class="hljs-string">"</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">master</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">extraConfig</span></span> = <span class="hljs-string"><span class="hljs-string">"allow-update { key rfc2136key.example.com.; };"</span></span>;
    }
  ];
}

<span class="hljs-comment"><span class="hljs-comment"># Now we can configure ACME</span></span>
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.acceptTerms" shape="rect"><code class="option">security.acme.<span class="hljs-attr"><span class="hljs-attr">acceptTerms</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.email" shape="rect"><code class="option">security.acme.<span class="hljs-attr"><span class="hljs-attr">email</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"admin+acme@example.com"</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs" shape="rect"><code class="option">security.acme.certs</code></a>.<span class="hljs-string"><span class="hljs-string">"example.com"</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.domain" shape="rect"><span class="hljs-attr"><span class="hljs-attr">domain</span></span></a> = <span class="hljs-string"><span class="hljs-string">"*.example.com"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.dnsProvider" shape="rect"><span class="hljs-attr"><span class="hljs-attr">dnsProvider</span></span></a> = <span class="hljs-string"><span class="hljs-string">"rfc2136"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.credentialsFile" shape="rect"><span class="hljs-attr"><span class="hljs-attr">credentialsFile</span></span></a> = <span class="hljs-string"><span class="hljs-string">"/var/lib/secrets/certs.secret"</span></span>;
  <span class="hljs-comment"><span class="hljs-comment"># We don't need to wait for propagation since this is a local DNS server</span></span>
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.acme.certs._name_.dnsPropagationCheck" shape="rect"><span class="hljs-attr"><span class="hljs-attr">dnsPropagationCheck</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
};
</pre><p>
   The <code class="filename">dnskeys.conf</code> and <code class="filename">certs.secret</code>
   must be kept secure and thus you should not keep their contents in your
   Nix config. Instead, generate them one time with these commands:
  </p><pre class="programlisting hljs nix" xml:space="preserve">mkdir -p /var/lib/secrets
tsig-keygen rfc2136key.example.com &gt; /var/lib/secrets/dnskeys.conf
chown named:root /var/lib/secrets/dnskeys.conf
chmod <span class="hljs-number"><span class="hljs-number">400</span></span> /var/lib/secrets/dnskeys.conf

<span class="hljs-comment"><span class="hljs-comment"># Copy the secret value from the dnskeys.conf, and put it in</span></span>
<span class="hljs-comment"><span class="hljs-comment"># RFC2136_TSIG_SECRET below</span></span>

cat &gt; /var/lib/secrets/certs.secret &lt;&lt; EOF
<span class="hljs-attr"><span class="hljs-attr">RFC2136_NAMESERVER='127.0.0.1:53'</span></span>
<span class="hljs-attr"><span class="hljs-attr">RFC2136_TSIG_ALGORITHM='hmac-sha256.'</span></span>
<span class="hljs-attr"><span class="hljs-attr">RFC2136_TSIG_KEY='rfc2136key.example.com'</span></span>
<span class="hljs-attr"><span class="hljs-attr">RFC2136_TSIG_SECRET='your</span></span> secret key'
EOF
chmod <span class="hljs-number"><span class="hljs-number">400</span></span> /var/lib/secrets/certs.secret
</pre><p>
   Now you're all set to generate certs! You should monitor the first invokation
   by running <code class="literal">systemctl start acme-example.com.service &amp;
   journalctl -fu acme-example.com.service</code> and watching its log output.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-security-acme-regenerate" class="title" style="clear: both">34.6.&nbsp;Regenerating certificates<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-security-acme-regenerate" aria-label="Anchor link for: module security acme regenerate" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Should you need to regenerate a particular certificate in a hurry, such
   as when a vulnerability is found in Let's Encrypt, there is now a convenient
   mechanism for doing so. Running
   <code class="literal">systemctl clean --what=state acme-example.com.service</code>
   will remove all certificate files and the account data for the given domain,
   allowing you to then <code class="literal">systemctl start acme-example.com.service</code>
   to generate fresh ones.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-security-acme-fix-jws" class="title" style="clear: both">34.7.&nbsp;Fixing JWS Verification error<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-security-acme-fix-jws" aria-label="Anchor link for: module security acme fix jws" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   It is possible that your account credentials file may become corrupt and need
   to be regenerated. In this scenario lego will produce the error <code class="literal">JWS verification error</code>.
   The solution is to simply delete the associated accounts file and
   re-run the affected service(s).
  </p><pre class="programlisting hljs bash" xml:space="preserve"><span class="hljs-comment"><span class="hljs-comment"># Find the accounts folder for the certificate</span></span>
systemctl cat acme-example.com.service | grep -Po <span class="hljs-string"><span class="hljs-string">'accounts/[^:]*'</span></span>
<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> accountdir=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(!!)</span></span></span><span class="hljs-string">"</span></span>
<span class="hljs-comment"><span class="hljs-comment"># Move this folder to some place else</span></span>
mv /var/lib/acme/.lego/<span class="hljs-variable"><span class="hljs-variable">$accountdir</span></span>{,.bak}
<span class="hljs-comment"><span class="hljs-comment"># Recreate the folder using systemd-tmpfiles</span></span>
systemd-tmpfiles --create
<span class="hljs-comment"><span class="hljs-comment"># Get a new account and reissue certificates</span></span>
<span class="hljs-comment"><span class="hljs-comment"># Note: Do this for all certs that share the same account email address</span></span>
systemctl start acme-example.com.service
</pre></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-programs-zsh-ohmyzsh" class="title">Chapter&nbsp;35.&nbsp;Oh my ZSH<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-programs-zsh-ohmyzsh" aria-label="Anchor link for: module programs zsh ohmyzsh" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-programs-oh-my-zsh-usage" shape="rect">35.1. Basic usage</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-programs-oh-my-zsh-additions" shape="rect">35.2. Custom additions</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-programs-oh-my-zsh-environments" shape="rect">35.3. Custom environments</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-programs-oh-my-zsh-packaging-customizations" shape="rect">35.4. Package your own customizations</a></span></dt></dl></div><p>
  <code class="literal"><a class="link" href="https://ohmyz.sh/" target="_top" shape="rect">oh-my-zsh</a></code> is a
  framework to manage your <a class="link" href="https://www.zsh.org/" target="_top" shape="rect">ZSH</a>
  configuration including completion scripts for several CLI tools or custom
  prompt themes.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="module-programs-oh-my-zsh-usage" class="title" style="clear: both">35.1.&nbsp;Basic usage<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-programs-oh-my-zsh-usage" aria-label="Anchor link for: module programs oh my zsh usage" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   The module uses the <code class="literal">oh-my-zsh</code> package with all available
   features. The initial setup using Nix expressions is fairly similar to the
   configuration format of <code class="literal">oh-my-zsh</code>.
</p><pre class="programlisting hljs nix" xml:space="preserve">{
  programs.zsh.<span class="hljs-attr"><span class="hljs-attr">ohMyZsh</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
    <span class="hljs-attr"><span class="hljs-attr">plugins</span></span> = [ <span class="hljs-string"><span class="hljs-string">"git"</span></span> <span class="hljs-string"><span class="hljs-string">"python"</span></span> <span class="hljs-string"><span class="hljs-string">"man"</span></span> ];
    <span class="hljs-attr"><span class="hljs-attr">theme</span></span> = <span class="hljs-string"><span class="hljs-string">"agnoster"</span></span>;
  };
}
</pre><p>
   For a detailed explanation of these arguments please refer to the
   <a class="link" href="https://github.com/robbyrussell/oh-my-zsh/wiki" target="_top" shape="rect"><code class="literal">oh-my-zsh</code>
   docs</a>.
  </p><p>
   The expression generates the needed configuration and writes it into your
   <code class="literal">/etc/zshrc</code>.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-programs-oh-my-zsh-additions" class="title" style="clear: both">35.2.&nbsp;Custom additions<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-programs-oh-my-zsh-additions" aria-label="Anchor link for: module programs oh my zsh additions" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Sometimes third-party or custom scripts such as a modified theme may be
   needed. <code class="literal">oh-my-zsh</code> provides the
   <a class="link" href="https://github.com/robbyrussell/oh-my-zsh/wiki/Customization#overriding-internals" target="_top" shape="rect"><code class="literal">ZSH_CUSTOM</code></a>
   environment variable for this which points to a directory with additional
   scripts.
  </p><p>
   The module can do this as well:
</p><pre class="programlisting hljs nix" xml:space="preserve">{
  programs.zsh.ohMyZsh.<span class="hljs-attr"><span class="hljs-attr">custom</span></span> = <span class="hljs-string"><span class="hljs-string">"~/path/to/custom/scripts"</span></span>;
}
</pre><p>
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-programs-oh-my-zsh-environments" class="title" style="clear: both">35.3.&nbsp;Custom environments<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-programs-oh-my-zsh-environments" aria-label="Anchor link for: module programs oh my zsh environments" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   There are several extensions for <code class="literal">oh-my-zsh</code> packaged in
   <code class="literal">nixpkgs</code>. One of them is
   <a class="link" href="https://github.com/spwhitt/nix-zsh-completions" target="_top" shape="rect">nix-zsh-completions</a>
   which bundles completion scripts and a plugin for
   <code class="literal">oh-my-zsh</code>.
  </p><p>
   Rather than using a single mutable path for <code class="literal">ZSH_CUSTOM</code>,
   it's also possible to generate this path from a list of Nix packages:
</p><pre class="programlisting hljs nix" xml:space="preserve">{ pkgs, ... }:
{
  programs.zsh.ohMyZsh.<span class="hljs-attr"><span class="hljs-attr">customPkgs</span></span> = [
    pkgs.nix-zsh-completions
    <span class="hljs-comment"><span class="hljs-comment"># and even more...</span></span>
  ];
}
</pre><p>
   Internally a single store path will be created using
   <code class="literal">buildEnv</code>. Please refer to the docs of
   <a class="link" href="https://nixos.org/nixpkgs/manual/#sec-building-environment" target="_top" shape="rect"><code class="literal">buildEnv</code></a>
   for further reference.
  </p><p>
   <span class="emphasis"><em>Please keep in mind that this is not compatible with
   <code class="literal">programs.zsh.ohMyZsh.custom</code> as it requires an immutable
   store path while <code class="literal">custom</code> shall remain mutable! An
   evaluation failure will be thrown if both <code class="literal">custom</code> and
   <code class="literal">customPkgs</code> are set.</em></span>
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="module-programs-oh-my-zsh-packaging-customizations" class="title" style="clear: both">35.4.&nbsp;Package your own customizations<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-programs-oh-my-zsh-packaging-customizations" aria-label="Anchor link for: module programs oh my zsh packaging customizations" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   If third-party customizations (e.g. new themes) are supposed to be added to
   <code class="literal">oh-my-zsh</code> there are several pitfalls to keep in mind:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     To comply with the default structure of <code class="literal">ZSH</code> the entire
     output needs to be written to <code class="literal">$out/share/zsh.</code>
    </p></li><li class="listitem"><p>
     Completion scripts are supposed to be stored at
     <code class="literal">$out/share/zsh/site-functions</code>. This directory is part
     of the
     <code class="literal"><a class="link" href="http://zsh.sourceforge.net/Doc/Release/Functions.html" target="_top" shape="rect">fpath</a></code>
     and the package should be compatible with pure <code class="literal">ZSH</code>
     setups. The module will automatically link the contents of
     <code class="literal">site-functions</code> to completions directory in the proper
     store path.
    </p></li><li class="listitem"><p>
     The <code class="literal">plugins</code> directory needs the structure
     <code class="literal">pluginname/pluginname.plugin.zsh</code> as structured in the
     <a class="link" href="https://github.com/robbyrussell/oh-my-zsh/tree/91b771914bc7c43dd7c7a43b586c5de2c225ceb7/plugins" target="_top" shape="rect">upstream
     repo.</a>
    </p></li></ul></div><p>
   A derivation for <code class="literal">oh-my-zsh</code> may look like this:
</p><pre class="programlisting hljs nix" xml:space="preserve">{ stdenv, fetchFromGitHub }:

stdenv.mkDerivation <span class="hljs-keyword"><span class="hljs-keyword">rec</span></span> {
  <span class="hljs-attr"><span class="hljs-attr">name</span></span> = <span class="hljs-string"><span class="hljs-string">"exemplary-zsh-customization-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${version}</span></span></span><span class="hljs-string">"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">version</span></span> = <span class="hljs-string"><span class="hljs-string">"1.0.0"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">src</span></span> = fetchFromGitHub {
    <span class="hljs-comment"><span class="hljs-comment"># path to the upstream repository</span></span>
  };

  <span class="hljs-attr"><span class="hljs-attr">dontBuild</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">installPhase</span></span> = <span class="hljs-string"><span class="hljs-string">''
    mkdir -p $out/share/zsh/site-functions
    cp {themes,plugins} $out/share/zsh
    cp completions $out/share/zsh/site-functions
  ''</span></span>;
}
</pre><p>
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-program-plotinus" class="title">Chapter&nbsp;36.&nbsp;Plotinus<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-program-plotinus" aria-label="Anchor link for: module program plotinus" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  <span class="emphasis"><em>Source:</em></span>
  <code class="filename">modules/programs/plotinus.nix</code>
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span>
  <a class="link" href="https://github.com/p-e-w/plotinus" target="_top" shape="rect">https://github.com/p-e-w/plotinus</a>
 </p><p>
  Plotinus is a searchable command palette in every modern GTK application.
 </p><p>
  When in a GTK 3 application and Plotinus is enabled, you can press
  <code class="literal">Ctrl+Shift+P</code> to open the command palette. The command
  palette provides a searchable list of of all menu items in the application.
 </p><p>
  To enable Plotinus, add the following to your
  <code class="filename">configuration.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-programs.plotinus.enable" shape="rect"><code class="option">programs.plotinus.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-programs-digitalbitbox" class="title">Chapter&nbsp;37.&nbsp;Digital Bitbox<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-programs-digitalbitbox" aria-label="Anchor link for: module programs digitalbitbox" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-digitalbitbox-package" shape="rect">37.1. Package</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-digitalbitbox-hardware-module" shape="rect">37.2. Hardware</a></span></dt></dl></div><p>
  Digital Bitbox is a hardware wallet and second-factor authenticator.
 </p><p>
  The <code class="literal">digitalbitbox</code> programs module may be installed by
  setting <code class="literal">programs.digitalbitbox</code> to <code class="literal">true</code>
  in a manner similar to
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-programs.digitalbitbox.enable" shape="rect"><code class="option">programs.digitalbitbox.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
  and bundles the <code class="literal">digitalbitbox</code> package (see
  <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-digitalbitbox-package" title="37.1. Package" shape="rect">Section&nbsp;37.1, “Package”</a>), which contains the
  <code class="literal">dbb-app</code> and <code class="literal">dbb-cli</code> binaries, along
  with the hardware module (see
  <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-digitalbitbox-hardware-module" title="37.2. Hardware" shape="rect">Section&nbsp;37.2, “Hardware”</a>) which sets up the
  necessary udev rules to access the device.
 </p><p>
  Enabling the digitalbitbox module is pretty much the easiest way to get a
  Digital Bitbox device working on your system.
 </p><p>
  For more information, see
  <a class="link" href="https://digitalbitbox.com/start_linux" target="_top" shape="rect">https://digitalbitbox.com/start_linux</a>.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="sec-digitalbitbox-package" class="title" style="clear: both">37.1.&nbsp;Package<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-digitalbitbox-package" aria-label="Anchor link for: sec digitalbitbox package" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   The binaries, <code class="literal">dbb-app</code> (a GUI tool) and
   <code class="literal">dbb-cli</code> (a CLI tool), are available through the
   <code class="literal">digitalbitbox</code> package which could be installed as
   follows:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.systemPackages" shape="rect"><code class="option">environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span></code></a> = [
  pkgs.digitalbitbox
];
</pre><p>
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-digitalbitbox-hardware-module" class="title" style="clear: both">37.2.&nbsp;Hardware<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-digitalbitbox-hardware-module" aria-label="Anchor link for: sec digitalbitbox hardware module" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   The digitalbitbox hardware package enables the udev rules for Digital Bitbox
   devices and may be installed as follows:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-hardware.digitalbitbox.enable" shape="rect"><code class="option">hardware.digitalbitbox.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
</pre><p>
  </p><p>
   In order to alter the udev rules, one may provide different values for the
   <code class="literal">udevRule51</code> and <code class="literal">udevRule52</code> attributes
   by means of overriding as follows:
</p><pre class="programlisting hljs nix" xml:space="preserve">programs.<span class="hljs-attr"><span class="hljs-attr">digitalbitbox</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-programs.digitalbitbox.enable" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enable</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-programs.digitalbitbox.package" shape="rect"><span class="hljs-attr"><span class="hljs-attr">package</span></span></a> = pkgs.digitalbitbox.override {
    <span class="hljs-attr"><span class="hljs-attr">udevRule51</span></span> = <span class="hljs-string"><span class="hljs-string">"something else"</span></span>;
  };
};
</pre><p>
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="module-services-input-methods" class="title">Chapter&nbsp;38.&nbsp;Input Methods<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-input-methods" aria-label="Anchor link for: module services input methods" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-input-methods-ibus" shape="rect">38.1. IBus</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-input-methods-fcitx" shape="rect">38.2. Fcitx</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-input-methods-nabi" shape="rect">38.3. Nabi</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#module-services-input-methods-uim" shape="rect">38.4. Uim</a></span></dt></dl></div><p>
  Input methods are an operating system component that allows any data, such as
  keyboard strokes or mouse movements, to be received as input. In this way
  users can enter characters and symbols not found on their input devices.
  Using an input method is obligatory for any language that has more graphemes
  than there are keys on the keyboard.
 </p><p>
  The following input methods are available in NixOS:
 </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
    IBus: The intelligent input bus.
   </p></li><li class="listitem"><p>
    Fcitx: A customizable lightweight input method.
   </p></li><li class="listitem"><p>
    Nabi: A Korean input method based on XIM.
   </p></li><li class="listitem"><p>
    Uim: The universal input method, is a library with a XIM bridge.
   </p></li></ul></div><section class="section"><div class="titlepage"><div><div><h2 id="module-services-input-methods-ibus" class="title" style="clear: both">38.1.&nbsp;IBus<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-ibus" aria-label="Anchor link for: module services input methods ibus" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   IBus is an Intelligent Input Bus. It provides full featured and user
   friendly input method user interface.
  </p><p>
   The following snippet can be used to configure IBus:
  </p><pre class="programlisting hljs nix" xml:space="preserve">i18n.<span class="hljs-attr"><span class="hljs-attr">inputMethod</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-i18n.inputMethod.enabled" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enabled</span></span></a> = <span class="hljs-string"><span class="hljs-string">"ibus"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-i18n.inputMethod.ibus.engines" shape="rect">ibus.<span class="hljs-attr"><span class="hljs-attr">engines</span></span></a> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> pkgs.ibus-engines; [ anthy hangul mozc ];
};
</pre><p>
   <code class="literal">i18n.inputMethod.ibus.engines</code> is optional and can be used
   to add extra IBus engines.
  </p><p>
   Available extra IBus engines are:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Anthy (<code class="literal">ibus-engines.anthy</code>): Anthy is a system for
     Japanese input method. It converts Hiragana text to Kana Kanji mixed text.
    </p></li><li class="listitem"><p>
     Hangul (<code class="literal">ibus-engines.hangul</code>): Korean input method.
    </p></li><li class="listitem"><p>
     m17n (<code class="literal">ibus-engines.m17n</code>): m17n is an input method that
     uses input methods and corresponding icons in the m17n database.
    </p></li><li class="listitem"><p>
     mozc (<code class="literal">ibus-engines.mozc</code>): A Japanese input method from
     Google.
    </p></li><li class="listitem"><p>
     Table (<code class="literal">ibus-engines.table</code>): An input method that load
     tables of input methods.
    </p></li><li class="listitem"><p>
     table-others (<code class="literal">ibus-engines.table-others</code>): Various
     table-based input methods. To use this, and any other table-based input
     methods, it must appear in the list of engines along with
     <code class="literal">table</code>. For example:
</p><pre class="programlisting hljs nix" xml:space="preserve">ibus.<span class="hljs-attr"><span class="hljs-attr">engines</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> pkgs.ibus-engines; [ table table-others ];
</pre><p>
    </p></li></ul></div><p>
   To use any input method, the package must be added in the configuration, as
   shown above, and also (after running <code class="literal">nixos-rebuild</code>) the
   input method must be added from IBus' preference dialog.
  </p><div class="simplesect"><div class="titlepage"><div><div><h3 id="module-services-input-methods-troubleshooting" class="title">Troubleshooting<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-troubleshooting" aria-label="Anchor link for: module services input methods troubleshooting" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
    If IBus works in some applications but not others, a likely cause of this
    is that IBus is depending on a different version of <code class="literal">glib</code>
    to what the applications are depending on. This can be checked by running
    <code class="literal">nix-store -q --requisites &lt;path&gt; | grep glib</code>,
    where <code class="literal">&lt;path&gt;</code> is the path of either IBus or an
    application in the Nix store. The <code class="literal">glib</code> packages must
    match exactly. If they do not, uninstalling and reinstalling the
    application is a likely fix.
   </p></div></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-input-methods-fcitx" class="title" style="clear: both">38.2.&nbsp;Fcitx<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-fcitx" aria-label="Anchor link for: module services input methods fcitx" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Fcitx is an input method framework with extension support. It has three
   built-in Input Method Engine, Pinyin, QuWei and Table-based input methods.
  </p><p>
   The following snippet can be used to configure Fcitx:
  </p><pre class="programlisting hljs nix" xml:space="preserve">i18n.<span class="hljs-attr"><span class="hljs-attr">inputMethod</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-i18n.inputMethod.enabled" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enabled</span></span></a> = <span class="hljs-string"><span class="hljs-string">"fcitx"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-i18n.inputMethod.fcitx.engines" shape="rect">fcitx.<span class="hljs-attr"><span class="hljs-attr">engines</span></span></a> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> pkgs.fcitx-engines; [ mozc hangul m17n ];
};
</pre><p>
   <code class="literal">i18n.inputMethod.fcitx.engines</code> is optional and can be
   used to add extra Fcitx engines.
  </p><p>
   Available extra Fcitx engines are:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Anthy (<code class="literal">fcitx-engines.anthy</code>): Anthy is a system for
     Japanese input method. It converts Hiragana text to Kana Kanji mixed text.
    </p></li><li class="listitem"><p>
     Chewing (<code class="literal">fcitx-engines.chewing</code>): Chewing is an
     intelligent Zhuyin input method. It is one of the most popular input
     methods among Traditional Chinese Unix users.
    </p></li><li class="listitem"><p>
     Hangul (<code class="literal">fcitx-engines.hangul</code>): Korean input method.
    </p></li><li class="listitem"><p>
     Unikey (<code class="literal">fcitx-engines.unikey</code>): Vietnamese input method.
    </p></li><li class="listitem"><p>
     m17n (<code class="literal">fcitx-engines.m17n</code>): m17n is an input method that
     uses input methods and corresponding icons in the m17n database.
    </p></li><li class="listitem"><p>
     mozc (<code class="literal">fcitx-engines.mozc</code>): A Japanese input method from
     Google.
    </p></li><li class="listitem"><p>
     table-others (<code class="literal">fcitx-engines.table-others</code>): Various
     table-based input methods.
    </p></li></ul></div></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-input-methods-nabi" class="title" style="clear: both">38.3.&nbsp;Nabi<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-nabi" aria-label="Anchor link for: module services input methods nabi" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Nabi is an easy to use Korean X input method. It allows you to enter
   phonetic Korean characters (hangul) and pictographic Korean characters
   (hanja).
  </p><p>
   The following snippet can be used to configure Nabi:
  </p><pre class="programlisting hljs nix" xml:space="preserve">i18n.<span class="hljs-attr"><span class="hljs-attr">inputMethod</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-i18n.inputMethod.enabled" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enabled</span></span></a> = <span class="hljs-string"><span class="hljs-string">"nabi"</span></span>;
};
</pre></section><section class="section"><div class="titlepage"><div><div><h2 id="module-services-input-methods-uim" class="title" style="clear: both">38.4.&nbsp;Uim<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-uim" aria-label="Anchor link for: module services input methods uim" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Uim (short for "universal input method") is a multilingual input method
   framework. Applications can use it through so-called bridges.
  </p><p>
   The following snippet can be used to configure uim:
  </p><pre class="programlisting hljs nix" xml:space="preserve">i18n.<span class="hljs-attr"><span class="hljs-attr">inputMethod</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-i18n.inputMethod.enabled" shape="rect"><span class="hljs-attr"><span class="hljs-attr">enabled</span></span></a> = <span class="hljs-string"><span class="hljs-string">"uim"</span></span>;
};
</pre><p>
   Note: The <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-i18n.inputMethod.uim.toolbar" shape="rect"><code class="option">i18n.inputMethod.uim.toolbar</code></a> option can be
   used to choose uim toolbar.
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="ch-profiles" class="title">Chapter&nbsp;39.&nbsp;Profiles<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#ch-profiles" aria-label="Anchor link for: ch profiles" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-all-hardware" shape="rect">39.1. All Hardware</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-base" shape="rect">39.2. Base</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-clone-config" shape="rect">39.3. Clone Config</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-demo" shape="rect">39.4. Demo</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-docker-container" shape="rect">39.5. Docker Container</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-graphical" shape="rect">39.6. Graphical</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-hardened" shape="rect">39.7. Hardened</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-headless" shape="rect">39.8. Headless</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-installation-device" shape="rect">39.9. Installation Device</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-minimal" shape="rect">39.10. Minimal</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-qemu-guest" shape="rect">39.11. QEMU Guest</a></span></dt></dl></div><p>
  In some cases, it may be desirable to take advantage of commonly-used,
  predefined configurations provided by nixpkgs, but different from those that
  come as default. This is a role fulfilled by NixOS's Profiles, which come as
  files living in <code class="filename">&lt;nixpkgs/nixos/modules/profiles&gt;</code>.
  That is to say, expected usage is to add them to the imports list of your
  <code class="filename">/etc/configuration.nix</code> as such:
 </p><pre class="programlisting hljs nix" xml:space="preserve">  <span class="hljs-attr"><span class="hljs-attr">imports</span></span> = [
   &lt;nixpkgs/nixos/modules/profiles/profile-name.nix&gt;
  ];
</pre><p>
  Even if some of these profiles seem only useful in the context of install
  media, many are actually intended to be used in real installs.
 </p><p>
  What follows is a brief explanation on the purpose and use-case for each
  profile. Detailing each option configured by each one is out of scope.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="sec-profile-all-hardware" class="title" style="clear: both">39.1.&nbsp;All Hardware<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-profile-all-hardware" aria-label="Anchor link for: sec profile all hardware" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Enables all hardware supported by NixOS: i.e., all firmware is included, and
  all devices from which one may boot are enabled in the initrd. Its primary
  use is in the NixOS installation CDs.
 </p><p>
  The enabled kernel modules include support for SATA and PATA, SCSI
  (partially), USB, Firewire (untested), Virtio (QEMU, KVM, etc.), VMware, and
  Hyper-V. Additionally, <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-hardware.enableAllFirmware" shape="rect"><code class="option">hardware.enableAllFirmware</code></a> is
  enabled, and the firmware for the ZyDAS ZD1211 chipset is specifically
  installed.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-profile-base" class="title" style="clear: both">39.2.&nbsp;Base<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-profile-base" aria-label="Anchor link for: sec profile base" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Defines the software packages included in the "minimal" installation CD. It
  installs several utilities useful in a simple recovery or install media, such
  as a text-mode web browser, and tools for manipulating block devices,
  networking, hardware diagnostics, and filesystems (with their respective
  kernel modules).
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-profile-clone-config" class="title" style="clear: both">39.3.&nbsp;Clone Config<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-profile-clone-config" aria-label="Anchor link for: sec profile clone config" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  This profile is used in installer images. It provides an editable
  configuration.nix that imports all the modules that were also used when
  creating the image in the first place. As a result it allows users to edit
  and rebuild the live-system.
 </p><p>
  On images where the installation media also becomes an installation target,
  copying over <code class="literal">configuration.nix</code> should be disabled by
  setting <code class="literal">installer.cloneConfig</code> to <code class="literal">false</code>.
  For example, this is done in <code class="literal">sd-image-aarch64.nix</code>.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-profile-demo" class="title" style="clear: both">39.4.&nbsp;Demo<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-profile-demo" aria-label="Anchor link for: sec profile demo" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  This profile just enables a <code class="systemitem">demo</code>
  user, with password <code class="literal">demo</code>, uid <code class="literal">1000</code>,
  <code class="systemitem">wheel</code> group and
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.autoLogin" shape="rect">autologin in the SDDM display manager</a>.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-profile-docker-container" class="title" style="clear: both">39.5.&nbsp;Docker Container<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-profile-docker-container" aria-label="Anchor link for: sec profile docker container" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  This is the profile from which the Docker images are generated. It prepares a
  working system by importing the
  <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-minimal" title="39.10. Minimal" shape="rect">Minimal</a> and
  <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-clone-config" title="39.3. Clone Config" shape="rect">Clone Config</a> profiles, and
  setting appropriate configuration options that are useful inside a container
  context, like <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.isContainer" shape="rect"><code class="option">boot.isContainer</code></a>.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-profile-graphical" class="title" style="clear: both">39.6.&nbsp;Graphical<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-profile-graphical" aria-label="Anchor link for: sec profile graphical" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Defines a NixOS configuration with the Plasma 5 desktop. It's used by the
  graphical installation CD.
 </p><p>
  It sets <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.enable" shape="rect"><code class="option">services.xserver.enable</code></a>,
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.displayManager.sddm.enable" shape="rect"><code class="option">services.xserver.displayManager.sddm.enable</code></a>,
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.desktopManager.plasma5.enable" shape="rect"><code class="option">services.xserver.desktopManager.plasma5.enable</code></a>, and
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.xserver.libinput.enable" shape="rect"><code class="option">services.xserver.libinput.enable</code></a> to true. It also
  includes glxinfo and firefox in the system packages list.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-profile-hardened" class="title" style="clear: both">39.7.&nbsp;Hardened<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-profile-hardened" aria-label="Anchor link for: sec profile hardened" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  A profile with most (vanilla) hardening options enabled by default,
  potentially at the cost of stability, features and performance.
 </p><p>
  This includes a hardened kernel, and limiting the system information
  available to processes through the <code class="filename">/sys</code> and
  <code class="filename">/proc</code> filesystems. It also disables the User Namespaces
  feature of the kernel, which stops Nix from being able to build anything
  (this particular setting can be overriden via
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.allowUserNamespaces" shape="rect"><code class="option">security.allowUserNamespaces</code></a>). See the
  <code class="literal"><a class="literal" href="https://github.com/nixos/nixpkgs/tree/master/nixos/modules/profiles/hardened.nix" target="_top" shape="rect">
  profile source</a></code> for further detail on which settings are altered.
 </p><div class="alert alert-warning"><strong>Warning:</strong> 
     This profile enables options that are known to affect system
     stability. If you experience any stability issues when using the
     profile, try disabling it. If you report an issue and use this
     profile, always mention that you do.
   </div></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-profile-headless" class="title" style="clear: both">39.8.&nbsp;Headless<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-profile-headless" aria-label="Anchor link for: sec profile headless" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Common configuration for headless machines (e.g., Amazon EC2 instances).
 </p><p>
  Disables <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-sound.enable" shape="rect">sound</a>,
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.vesa" shape="rect">vesa</a>, serial consoles,
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-systemd.enableEmergencyMode" shape="rect">emergency mode</a>,
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.loader.grub.splashImage" shape="rect">grub splash images</a>
  and configures the kernel to reboot automatically on panic.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-profile-installation-device" class="title" style="clear: both">39.9.&nbsp;Installation Device<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-profile-installation-device" aria-label="Anchor link for: sec profile installation device" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Provides a basic configuration for installation devices like CDs.
  This enables redistributable firmware, includes the
  <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-clone-config" title="39.3. Clone Config" shape="rect">Clone Config profile</a>
  and a copy of the Nixpkgs channel, so <span class="command"><strong>nixos-install</strong></span>
  works out of the box.
 </p><p>
  Documentation for <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-documentation.enable" shape="rect">Nixpkgs</a>
  and <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-documentation.nixos.enable" shape="rect">NixOS</a> are
  forcefully enabled (to override the
  <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#sec-profile-minimal" title="39.10. Minimal" shape="rect">Minimal profile</a> preference); the
  NixOS manual is shown automatically on TTY 8, udisks is disabled.
  Autologin is enabled as <code class="literal">nixos</code> user, while passwordless
  login as both <code class="literal">root</code> and <code class="literal">nixos</code> is possible.
  Passwordless <span class="command"><strong>sudo</strong></span> is enabled too.
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.wireless.enable" shape="rect">wpa_supplicant</a> is
  enabled, but configured to not autostart.
 </p><p>
  It is explained how to login, start the ssh server, and if available,
  how to start the display manager.
 </p><p>
  Several settings are tweaked so that the installer has a better chance of
  succeeding under low-memory environments.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-profile-minimal" class="title" style="clear: both">39.10.&nbsp;Minimal<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-profile-minimal" aria-label="Anchor link for: sec profile minimal" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  This profile defines a small NixOS configuration. It does not contain any
  graphical stuff. It's a very short file that enables
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.noXlibs" shape="rect">noXlibs</a>, sets
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-i18n.supportedLocales" shape="rect">i18n.supportedLocales</a> to
  only support the user-selected locale,
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-documentation.enable" shape="rect">disables packages' documentation
  </a>, and <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-sound.enable" shape="rect">disables sound</a>.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-profile-qemu-guest" class="title" style="clear: both">39.11.&nbsp;QEMU Guest<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-profile-qemu-guest" aria-label="Anchor link for: sec profile qemu guest" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  This profile contains common configuration for virtual machines running under
  QEMU (using virtio).
 </p><p>
  It makes virtio modules available on the initrd, sets the system time from
  the hardware clock to work around a bug in qemu-kvm, and
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-security.rngd.enable" shape="rect">enables rngd</a>.
 </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-kubernetes" class="title">Chapter&nbsp;40.&nbsp;Kubernetes<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-kubernetes" aria-label="Anchor link for: sec kubernetes" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  The NixOS Kubernetes module is a collective term for a handful of individual
  submodules implementing the Kubernetes cluster components.
 </p><p>
  There are generally two ways of enabling Kubernetes on NixOS. One way is to
  enable and configure cluster components appropriately by hand:
</p><pre class="programlisting hljs nix" xml:space="preserve">services.<span class="hljs-attr"><span class="hljs-attr">kubernetes</span></span> = {
  apiserver.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  controllerManager.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  scheduler.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  addonManager.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  proxy.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  flannel.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
};
</pre><p>
  Another way is to assign cluster roles ("master" and/or "node") to the host.
  This enables apiserver, controllerManager, scheduler, addonManager,
  kube-proxy and etcd:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.kubernetes.roles" shape="rect"><code class="option">services.kubernetes.<span class="hljs-attr"><span class="hljs-attr">roles</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"master"</span></span> ];
</pre><p>
  While this will enable the kubelet and kube-proxy only:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.kubernetes.roles" shape="rect"><code class="option">services.kubernetes.<span class="hljs-attr"><span class="hljs-attr">roles</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"node"</span></span> ];
</pre><p>
  Assigning both the master and node roles is usable if you want a single node
  Kubernetes cluster for dev or testing purposes:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.kubernetes.roles" shape="rect"><code class="option">services.kubernetes.<span class="hljs-attr"><span class="hljs-attr">roles</span></span></code></a> = [ <span class="hljs-string"><span class="hljs-string">"master"</span></span> <span class="hljs-string"><span class="hljs-string">"node"</span></span> ];
</pre><p>
  Note: Assigning either role will also default both
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.kubernetes.flannel.enable" shape="rect"><code class="option">services.kubernetes.flannel.enable</code></a> and
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.kubernetes.easyCerts" shape="rect"><code class="option">services.kubernetes.easyCerts</code></a> to true. This sets up
  flannel as CNI and activates automatic PKI bootstrapping.
 </p><p>
  As of kubernetes 1.10.X it has been deprecated to open non-tls-enabled ports
  on kubernetes components. Thus, from NixOS 19.03 all plain HTTP ports have
  been disabled by default. While opening insecure ports is still possible, it
  is recommended not to bind these to other interfaces than loopback. To
  re-enable the insecure port on the apiserver, see options:
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.kubernetes.apiserver.insecurePort" shape="rect"><code class="option">services.kubernetes.apiserver.insecurePort</code></a> and
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.kubernetes.apiserver.insecureBindAddress" shape="rect"><code class="option">services.kubernetes.apiserver.insecureBindAddress</code></a>
 </p><div class="alert alert-info"><strong>Note:</strong> 
   As of NixOS 19.03, it is mandatory to configure:
   <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.kubernetes.masterAddress" shape="rect"><code class="option">services.kubernetes.masterAddress</code></a>. The masterAddress
   must be resolveable and routeable by all cluster nodes. In single node
   clusters, this can be set to <code class="literal">localhost</code>.
  </div><p>
  Role-based access control (RBAC) authorization mode is enabled by default.
  This means that anonymous requests to the apiserver secure port will
  expectedly cause a permission denied error. All cluster components must
  therefore be configured with x509 certificates for two-way tls communication.
  The x509 certificate subject section determines the roles and permissions
  granted by the apiserver to perform clusterwide or namespaced operations. See
  also:
  <a class="link" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" target="_top" shape="rect">
  Using RBAC Authorization</a>.
 </p><p>
  The NixOS kubernetes module provides an option for automatic certificate
  bootstrapping and configuration,
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.kubernetes.easyCerts" shape="rect"><code class="option">services.kubernetes.easyCerts</code></a>. The PKI bootstrapping
  process involves setting up a certificate authority (CA) daemon (cfssl) on
  the kubernetes master node. cfssl generates a CA-cert for the cluster, and
  uses the CA-cert for signing subordinate certs issued to each of the cluster
  components. Subsequently, the certmgr daemon monitors active certificates and
  renews them when needed. For single node Kubernetes clusters, setting
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.kubernetes.easyCerts" shape="rect"><code class="option">services.kubernetes.easyCerts</code></a> = true is sufficient and
  no further action is required. For joining extra node machines to an existing
  cluster on the other hand, establishing initial trust is mandatory.
 </p><p>
  To add new nodes to the cluster: On any (non-master) cluster node where
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.kubernetes.easyCerts" shape="rect"><code class="option">services.kubernetes.easyCerts</code></a> is enabled, the helper
  script <code class="literal">nixos-kubernetes-node-join</code> is available on PATH.
  Given a token on stdin, it will copy the token to the kubernetes secrets
  directory and restart the certmgr service. As requested certificates are
  issued, the script will restart kubernetes cluster components as needed for
  them to pick up new keypairs.
 </p><div class="alert alert-info"><strong>Note:</strong> 
   Multi-master (HA) clusters are not supported by the easyCerts module.
  </div><p>
  In order to interact with an RBAC-enabled cluster as an administrator, one
  needs to have cluster-admin privileges. By default, when easyCerts is
  enabled, a cluster-admin kubeconfig file is generated and linked into
  <code class="literal">/etc/kubernetes/cluster-admin.kubeconfig</code> as determined by
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.kubernetes.pki.etcClusterAdminKubeconfig" shape="rect"><code class="option">services.kubernetes.pki.etcClusterAdminKubeconfig</code></a>.
  <code class="literal">export KUBECONFIG=/etc/kubernetes/cluster-admin.kubeconfig</code>
  will make kubectl use this kubeconfig to access and authenticate the cluster.
  The cluster-admin kubeconfig references an auto-generated keypair owned by
  root. Thus, only root on the kubernetes master may obtain cluster-admin
  rights by means of this file.
 </p></section></div><div class="part"><div class="titlepage"><div><div><div class="page-header"><h1 id="ch-running" class="title">Part&nbsp;III.&nbsp;Administration<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#ch-running" aria-label="Anchor link for: ch running" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h1></div></div></div></div><div class="partintro"><div></div><p>
   This chapter describes various aspects of managing a running NixOS system,
   such as how to use the <span class="command"><strong>systemd</strong></span> service manager.
  </p><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-systemctl" shape="rect">41. Service Management</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-rebooting" shape="rect">42. Rebooting and Shutting Down</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-user-sessions" shape="rect">43. User Sessions</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-cgroups" shape="rect">44. Control Groups</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-logging" shape="rect">45. Logging</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-nix-gc" shape="rect">46. Cleaning the Nix Store</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-containers" shape="rect">47. Container Management</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-troubleshooting" shape="rect">48. Troubleshooting</a></span></dt></dl></div></div><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-systemctl" class="title">Chapter&nbsp;41.&nbsp;Service Management<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-systemctl" aria-label="Anchor link for: sec systemctl" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  In NixOS, all system services are started and monitored using the systemd
  program. Systemd is the “init” process of the system (i.e. PID 1), the
  parent of all other processes. It manages a set of so-called “units”,
  which can be things like system services (programs), but also mount points,
  swap files, devices, targets (groups of units) and more. Units can have
  complex dependencies; for instance, one unit can require that another unit
  must be successfully started before the first unit can be started. When the
  system boots, it starts a unit named <code class="literal">default.target</code>; the
  dependencies of this unit cause all system services to be started, file
  systems to be mounted, swap files to be activated, and so on.
 </p><p>
  The command <span class="command"><strong>systemctl</strong></span> is the main way to interact with
  <span class="command"><strong>systemd</strong></span>. Without any arguments, it shows the status of
  active units:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>systemctl
-.mount          loaded active mounted   /
swapfile.swap    loaded active active    /swapfile
sshd.service     loaded active running   SSH Daemon
graphical.target loaded active active    Graphical Interface
<em class="replaceable"><code>...</code></em>
</pre><p>
 </p><p>
  You can ask for detailed status information about a unit, for instance, the
  PostgreSQL database service:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>systemctl status postgresql.service
postgresql.service - PostgreSQL Server
          Loaded: loaded (/nix/store/pn3q73mvh75gsrl8w7fdlfk3fq5qm5mw-unit/postgresql.service)
          Active: active (running) since Mon, <span class="hljs-number"><span class="hljs-number">2013</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span> CET; <span class="hljs-number"><span class="hljs-number">9</span></span>h ago
        Main PID: <span class="hljs-number"><span class="hljs-number">2390</span></span> (postgres)
          CGroup: <span class="hljs-attr"><span class="hljs-attr">name=systemd:/system/postgresql.service</span></span>
                  ├─<span class="hljs-number"><span class="hljs-number">2390</span></span> postgres
                  ├─<span class="hljs-number"><span class="hljs-number">2418</span></span> postgres: writer process
                  ├─<span class="hljs-number"><span class="hljs-number">2419</span></span> postgres: wal writer process
                  ├─<span class="hljs-number"><span class="hljs-number">2420</span></span> postgres: autovacuum launcher process
                  ├─<span class="hljs-number"><span class="hljs-number">2421</span></span> postgres: stats collector process
                  └─<span class="hljs-number"><span class="hljs-number">2498</span></span> postgres: zabbix zabbix [local] idle

Jan <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span> hagbard postgres[<span class="hljs-number"><span class="hljs-number">2394</span></span>]: [<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>] LOG:  database system was shut down at <span class="hljs-number"><span class="hljs-number">2013</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span> CET
Jan <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span> hagbard postgres[<span class="hljs-number"><span class="hljs-number">2390</span></span>]: [<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>] LOG:  database system is ready to accept connections
Jan <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span> hagbard postgres[<span class="hljs-number"><span class="hljs-number">2420</span></span>]: [<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>] LOG:  autovacuum launcher started
Jan <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span> hagbard systemd[<span class="hljs-number"><span class="hljs-number">1</span></span>]: Started PostgreSQL Server.
</pre><p>
  Note that this shows the status of the unit (active and running), all the
  processes belonging to the service, as well as the most recent log messages
  from the service.
 </p><p>
  Units can be stopped, started or restarted:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">systemctl stop postgresql.service</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">systemctl start postgresql.service</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">systemctl restart postgresql.service</span></span>
</pre><p>
  These operations are synchronous: they wait until the service has finished
  starting or stopping (or has failed). Starting a unit will cause the
  dependencies of that unit to be started as well (if necessary).
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-rebooting" class="title">Chapter&nbsp;42.&nbsp;Rebooting and Shutting Down<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-rebooting" aria-label="Anchor link for: sec rebooting" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  The system can be shut down (and automatically powered off) by doing:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">shutdown</span></span>
</pre><p>
  This is equivalent to running <span class="command"><strong>systemctl poweroff</strong></span>.
 </p><p>
  To reboot the system, run
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">reboot</span></span>
</pre><p>
  which is equivalent to <span class="command"><strong>systemctl reboot</strong></span>. Alternatively,
  you can quickly reboot the system using <code class="literal">kexec</code>, which
  bypasses the BIOS by directly loading the new kernel into memory:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">systemctl kexec</span></span>
</pre><p>
 </p><p>
  The machine can be suspended to RAM (if supported) using <span class="command"><strong>systemctl
  suspend</strong></span>, and suspended to disk using <span class="command"><strong>systemctl
  hibernate</strong></span>.
 </p><p>
  These commands can be run by any user who is logged in locally, i.e. on a
  virtual console or in X11; otherwise, the user is asked for authentication.
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-user-sessions" class="title">Chapter&nbsp;43.&nbsp;User Sessions<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-user-sessions" aria-label="Anchor link for: sec user sessions" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Systemd keeps track of all users who are logged into the system (e.g. on a
  virtual console or remotely via SSH). The command <span class="command"><strong>loginctl</strong></span>
  allows querying and manipulating user sessions. For instance, to list all
  user sessions:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>loginctl
   SESSION        UID USER             SEAT
        c1        500 eelco            seat0
        c3          0 root             seat0
        c4        500 alice
</pre><p>
  This shows that two users are logged in locally, while another is logged in
  remotely. (“Seats” are essentially the combinations of displays and input
  devices attached to the system; usually, there is only one seat.) To get
  information about a session:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>loginctl session-status c3
c3 - root (<span class="hljs-number"><span class="hljs-number">0</span></span>)
           Since: Tue, <span class="hljs-number"><span class="hljs-number">2013</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> CET; <span class="hljs-number"><span class="hljs-number">4</span></span>min <span class="hljs-number"><span class="hljs-number">42</span></span>s ago
          Leader: <span class="hljs-number"><span class="hljs-number">2536</span></span> (login)
            Seat: seat0; vc3
             TTY: /dev/tty3
         Service: login; type tty; class user
           State: online
          CGroup: <span class="hljs-attr"><span class="hljs-attr">name=systemd:/user/root/c3</span></span>
                  ├─ <span class="hljs-number"><span class="hljs-number">2536</span></span> /nix/store/<span class="hljs-number"><span class="hljs-number">10</span></span>mn4xip9n7y9bxqwnsx7xwx2v2g34xn-shadow-<span class="hljs-number"><span class="hljs-number">4.1</span></span>.<span class="hljs-number"><span class="hljs-number">5.1</span></span>/bin/login --
                  ├─<span class="hljs-number"><span class="hljs-number">10339</span></span> -bash
                  └─<span class="hljs-number"><span class="hljs-number">10355</span></span> w3m nixos.org
</pre><p>
  This shows that the user is logged in on virtual console 3. It also lists the
  processes belonging to this session. Since systemd keeps track of this, you
  can terminate a session in a way that ensures that all the session’s
  processes are gone:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">loginctl terminate-session c3</span></span>
</pre><p>
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-cgroups" class="title">Chapter&nbsp;44.&nbsp;Control Groups<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-cgroups" aria-label="Anchor link for: sec cgroups" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  To keep track of the processes in a running system, systemd uses
  <span class="emphasis"><em>control groups</em></span> (cgroups). A control group is a set of
  processes used to allocate resources such as CPU, memory or I/O bandwidth.
  There can be multiple control group hierarchies, allowing each kind of
  resource to be managed independently.
 </p><p>
  The command <span class="command"><strong>systemd-cgls</strong></span> lists all control groups in the
  <code class="literal">systemd</code> hierarchy, which is what systemd uses to keep
  track of the processes belonging to each service or user session:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>systemd-cgls
├─user
│ └─eelco
│   └─c1
│     ├─ 2567 -:0
│     ├─ 2682 kdeinit4: kdeinit4 Running...
│     ├─ <em class="replaceable"><code>...</code></em>
│     └─10851 sh -c less -R
└─system
  ├─httpd.service
  │ ├─2444 httpd -f /nix/store/3pyacby5cpr55a03qwbnndizpciwq161-httpd.conf -DNO_DETACH
  │ └─<em class="replaceable"><code>...</code></em>
  ├─dhcpcd.service
  │ └─2376 dhcpcd --config /nix/store/f8dif8dsi2yaa70n03xir8r653776ka6-dhcpcd.conf
  └─ <em class="replaceable"><code>...</code></em>
</pre><p>
  Similarly, <span class="command"><strong>systemd-cgls cpu</strong></span> shows the cgroups in the CPU
  hierarchy, which allows per-cgroup CPU scheduling priorities. By default,
  every systemd service gets its own CPU cgroup, while all user sessions are in
  the top-level CPU cgroup. This ensures, for instance, that a thousand
  run-away processes in the <code class="literal">httpd.service</code> cgroup cannot
  starve the CPU for one process in the <code class="literal">postgresql.service</code>
  cgroup. (By contrast, it they were in the same cgroup, then the PostgreSQL
  process would get 1/1001 of the cgroup’s CPU time.) You can limit a
  service’s CPU share in <code class="filename">configuration.nix</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-systemd.services._name_.serviceConfig" shape="rect">systemd.services.httpd.serviceConfig</a>.<span class="hljs-attr"><span class="hljs-attr">CPUShares</span></span> = <span class="hljs-number"><span class="hljs-number">512</span></span>;
</pre><p>
  By default, every cgroup has 1024 CPU shares, so this will halve the CPU
  allocation of the <code class="literal">httpd.service</code> cgroup.
 </p><p>
  There also is a <code class="literal">memory</code> hierarchy that controls memory
  allocation limits; by default, all processes are in the top-level cgroup, so
  any service or session can exhaust all available memory. Per-cgroup memory
  limits can be specified in <code class="filename">configuration.nix</code>; for
  instance, to limit <code class="literal">httpd.service</code> to 512 MiB of RAM
  (excluding swap):
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-systemd.services._name_.serviceConfig" shape="rect">systemd.services.httpd.serviceConfig</a>.<span class="hljs-attr"><span class="hljs-attr">MemoryLimit</span></span> = <span class="hljs-string"><span class="hljs-string">"512M"</span></span>;
</pre><p>
 </p><p>
  The command <span class="command"><strong>systemd-cgtop</strong></span> shows a continuously updated
  list of all cgroups with their CPU and memory usage.
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-logging" class="title">Chapter&nbsp;45.&nbsp;Logging<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-logging" aria-label="Anchor link for: sec logging" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  System-wide logging is provided by systemd’s <span class="emphasis"><em>journal</em></span>,
  which subsumes traditional logging daemons such as syslogd and klogd. Log
  entries are kept in binary files in <code class="filename">/var/log/journal/</code>.
  The command <code class="literal">journalctl</code> allows you to see the contents of
  the journal. For example,
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>journalctl -b
</pre><p>
  shows all journal entries since the last reboot. (The output of
  <span class="command"><strong>journalctl</strong></span> is piped into <span class="command"><strong>less</strong></span> by
  default.) You can use various options and match operators to restrict output
  to messages of interest. For instance, to get all messages from PostgreSQL:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>journalctl -u postgresql.service
-- Logs begin at Mon, 2013-01-07 13:28:01 CET, end at Tue, 2013-01-08 01:09:57 CET. --
...
Jan 07 15:44:14 hagbard postgres[2681]: [2-1] LOG:  database system is shut down
-- Reboot --
Jan 07 15:45:10 hagbard postgres[2532]: [1-1] LOG:  database system was shut down at 2013-01-07 15:44:14 CET
Jan 07 15:45:13 hagbard postgres[2500]: [1-1] LOG:  database system is ready to accept connections
</pre><p>
  Or to get all messages since the last reboot that have at least a
  “critical” severity level:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>journalctl -b -p crit
Dec <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span> mandark sudo[<span class="hljs-number"><span class="hljs-number">3673</span></span>]: pam_unix(sudo:auth): auth could not identify password for [alice]
Dec <span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span> mandark kernel[<span class="hljs-number"><span class="hljs-number">6131</span></span>]: [<span class="hljs-number"><span class="hljs-number">1053513.909444</span></span>] CPU6: Core temperature above threshold, cpu clock throttled (total <span class="hljs-attr"><span class="hljs-attr">events</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>)
</pre><p>
 </p><p>
  The system journal is readable by root and by users in the
  <code class="literal">wheel</code> and <code class="literal">systemd-journal</code> groups. All
  users have a private journal that can be read using
  <span class="command"><strong>journalctl</strong></span>.
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-nix-gc" class="title">Chapter&nbsp;46.&nbsp;Cleaning the Nix Store<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-nix-gc" aria-label="Anchor link for: sec nix gc" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sect-nixos-gc-boot-entries" shape="rect">46.1. NixOS Boot Entries</a></span></dt></dl></div><p>
  Nix has a purely functional model, meaning that packages are never upgraded
  in place. Instead new versions of packages end up in a different location in
  the Nix store (<code class="filename">/nix/store</code>). You should periodically run
  Nix’s <span class="emphasis"><em>garbage collector</em></span> to remove old, unreferenced
  packages. This is easy:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-collect-garbage
</pre><p>
  Alternatively, you can use a systemd unit that does the same in the
  background:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">systemctl start nix-gc.service</span></span>
</pre><p>
  You can tell NixOS in <code class="filename">configuration.nix</code> to run this unit
  automatically at certain points in time, for instance, every night at 03:15:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-nix.gc.automatic" shape="rect"><code class="option">nix.gc.<span class="hljs-attr"><span class="hljs-attr">automatic</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-nix.gc.dates" shape="rect"><code class="option">nix.gc.<span class="hljs-attr"><span class="hljs-attr">dates</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"03:15"</span></span>;
</pre><p>
 </p><p>
  The commands above do not remove garbage collector roots, such as old system
  configurations. Thus they do not remove the ability to roll back to previous
  configurations. The following command deletes old roots, removing the ability
  to roll back to them:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-collect-garbage -d
</pre><p>
  You can also do this for specific profiles, e.g.
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-env -p /nix/var/nix/profiles/per-user/eelco/profile --delete-generations old
</pre><p>
  Note that NixOS system configurations are stored in the profile
  <code class="filename">/nix/var/nix/profiles/system</code>.
 </p><p>
  Another way to reclaim disk space (often as much as 40% of the size of the
  Nix store) is to run Nix’s store optimiser, which seeks out identical files
  in the store and replaces them with hard links to a single copy.
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-store --optimise
</pre><p>
  Since this command needs to read the entire Nix store, it can take quite a
  while to finish.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="sect-nixos-gc-boot-entries" class="title" style="clear: both">46.1.&nbsp;NixOS Boot Entries<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sect-nixos-gc-boot-entries" aria-label="Anchor link for: sect nixos gc boot entries" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   If your <code class="filename">/boot</code> partition runs out of space, after
   clearing old profiles you must rebuild your system with
   <code class="literal">nixos-rebuild</code> to update the <code class="filename">/boot</code>
   partition and clear space.
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="ch-containers" class="title">Chapter&nbsp;47.&nbsp;Container Management<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#ch-containers" aria-label="Anchor link for: ch containers" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-imperative-containers" shape="rect">47.1. Imperative Container Management</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-declarative-containers" shape="rect">47.2. Declarative Container Specification</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-container-networking" shape="rect">47.3. Container Networking</a></span></dt></dl></div><p>
  NixOS allows you to easily run other NixOS instances as
  <span class="emphasis"><em>containers</em></span>. Containers are a light-weight approach to
  virtualisation that runs software in the container at the same speed as in
  the host system. NixOS containers share the Nix store of the host, making
  container creation very efficient.
 </p><div class="alert alert-warning"><strong>Warning:</strong> 
   Currently, NixOS containers are not perfectly isolated from the host system.
   This means that a user with root access to the container can do things that
   affect the host. So you should not give container root access to untrusted
   users.
  </div><p>
  NixOS containers can be created in two ways: imperatively, using the command
  <span class="command"><strong>nixos-container</strong></span>, and declaratively, by specifying them in
  your <code class="filename">configuration.nix</code>. The declarative approach implies
  that containers get upgraded along with your host system when you run
  <span class="command"><strong>nixos-rebuild</strong></span>, which is often not what you want. By
  contrast, in the imperative approach, containers are configured and updated
  independently from the host system.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="sec-imperative-containers" class="title" style="clear: both">47.1.&nbsp;Imperative Container Management<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-imperative-containers" aria-label="Anchor link for: sec imperative containers" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  We’ll cover imperative container management using
  <span class="command"><strong>nixos-container</strong></span> first. Be aware that container management
  is currently only possible as <code class="literal">root</code>.
 </p><p>
  You create a container with identifier <code class="literal">foo</code> as follows:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-container create </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">foo</span></span></code></em>
</pre><p>
  This creates the container’s root directory in
  <code class="filename">/var/lib/containers/<em class="replaceable"><code>foo</code></em></code> and a small configuration file
  in <code class="filename">/etc/containers/<em class="replaceable"><code>foo</code></em>.conf</code>. It also builds the
  container’s initial system configuration and stores it in
  <code class="filename">/nix/var/nix/profiles/per-container/<em class="replaceable"><code>foo</code></em>/system</code>. You can
  modify the initial configuration of the container on the command line. For
  instance, to create a container that has <span class="command"><strong>sshd</strong></span> running,
  with the given public key for <code class="literal">root</code>:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-container create </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">foo</span></span></code></em><span class="hljs-comment"><span class="hljs-comment"> --config '</span></span>
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.openssh.enable" shape="rect"><code class="option">services.openssh.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-users.users._name_.openssh.authorizedKeys.keys" shape="rect">users.users.root.openssh.authorizedKeys.<span class="hljs-attr"><span class="hljs-attr">keys</span></span></a> = [<span class="hljs-string"><span class="hljs-string">"ssh-dss AAAAB3N…"</span></span>];
'
</pre><p>
  By default the next free address in the <code class="literal">10.233.0.0/16</code> subnet will be chosen
  as container IP. This behavior can be altered by setting <code class="literal">--host-address</code> and
  <code class="literal">--local-address</code>:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-container create test --config-file test-container.nix \</span></span>
    --<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-address 10.235.1.2 --host-address 10.235.1.1
</pre><p>
 </p><p>
  Creating a container does not start it. To start the container, run:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-container start </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">foo</span></span></code></em>
</pre><p>
  This command will return as soon as the container has booted and has reached
  <code class="literal">multi-user.target</code>. On the host, the container runs within
  a systemd unit called
  <code class="literal">container@<em class="replaceable"><code>container-name</code></em>.service</code>.
  Thus, if something went wrong, you can get status info using
  <span class="command"><strong>systemctl</strong></span>:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">systemctl status container@</span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">foo</span></span></code></em>
</pre><p>
 </p><p>
  If the container has started successfully, you can log in as root using the
  <span class="command"><strong>root-login</strong></span> operation:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-container root-login </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">foo</span></span></code></em>
<code class="prompt">[root@foo:~]<span class="hljs-comment"><span class="hljs-comment">#</span></span></code>
</pre><p>
  Note that only root on the host can do this (since there is no
  authentication). You can also get a regular login prompt using the
  <span class="command"><strong>login</strong></span> operation, which is available to all users on the
  host:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-container login </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">foo</span></span></code></em>
foo login: alice
Password: ***
</pre><p>
  With <span class="command"><strong>nixos-container run</strong></span>, you can execute arbitrary
  commands in the container:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-container run </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">foo</span></span></code></em><span class="hljs-comment"><span class="hljs-comment"> -- uname -a</span></span>
Linux foo <span class="hljs-number"><span class="hljs-number">3.4</span></span>.<span class="hljs-number"><span class="hljs-number">82</span></span> <span class="hljs-comment"><span class="hljs-comment">#1-NixOS SMP Thu Mar 20 14:44:05 UTC 2014 x86_64 GNU/Linux</span></span>
</pre><p>
 </p><p>
  There are several ways to change the configuration of the container. First,
  on the host, you can edit
  <code class="literal">/var/lib/container/<em class="replaceable"><code>name</code></em>/etc/nixos/configuration.nix</code>,
  and run
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-container update </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">foo</span></span></code></em>
</pre><p>
  This will build and activate the new configuration. You can also specify a
  new configuration on the command line:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-container update </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">foo</span></span></code></em><span class="hljs-comment"><span class="hljs-comment"> --config '</span></span>
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.enable" shape="rect"><code class="option">services.httpd.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.httpd.adminAddr" shape="rect"><code class="option">services.httpd.<span class="hljs-attr"><span class="hljs-attr">adminAddr</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"foo@example.org"</span></span>;
  <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.firewall.allowedTCPPorts" shape="rect"><code class="option">networking.firewall.<span class="hljs-attr"><span class="hljs-attr">allowedTCPPorts</span></span></code></a> = [ <span class="hljs-number"><span class="hljs-number">80</span></span> ];
'

<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">curl http://$(nixos-container show-ip </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">foo</span></span></code></em><span class="hljs-comment"><span class="hljs-comment">)/</span></span>
&lt;!DOCTYPE HTML PUBLIC <span class="hljs-string"><span class="hljs-string">"-//W3C//DTD HTML 3.2 Final//EN"</span></span>&gt;…
</pre><p>
  However, note that this will overwrite the container’s
  <code class="filename">/etc/nixos/configuration.nix</code>.
 </p><p>
  Alternatively, you can change the configuration from within the container
  itself by running <span class="command"><strong>nixos-rebuild switch</strong></span> inside the
  container. Note that the container by default does not have a copy of the
  NixOS channel, so you should run <span class="command"><strong>nix-channel --update</strong></span>
  first.
 </p><p>
  Containers can be stopped and started using <code class="literal">nixos-container
  stop</code> and <code class="literal">nixos-container start</code>, respectively, or
  by using <span class="command"><strong>systemctl</strong></span> on the container’s service unit. To
  destroy a container, including its file system, do
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-container destroy </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">foo</span></span></code></em>
</pre><p>
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-declarative-containers" class="title" style="clear: both">47.2.&nbsp;Declarative Container Specification<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-declarative-containers" aria-label="Anchor link for: sec declarative containers" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  You can also specify containers and their configuration in the host’s
  <code class="filename">configuration.nix</code>. For example, the following specifies
  that there shall be a container named <code class="literal">database</code> running
  PostgreSQL:
</p><pre class="programlisting hljs nix" xml:space="preserve">containers.<span class="hljs-attr"><span class="hljs-attr">database</span></span> =
  { <span class="hljs-attr"><span class="hljs-attr">config</span></span> =
      { config, pkgs, ... }:
      { <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.enable" shape="rect"><code class="option">services.postgresql.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      <a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-services.postgresql.package" shape="rect"><code class="option">services.postgresql.<span class="hljs-attr"><span class="hljs-attr">package</span></span></code></a> = pkgs.postgresql_9_6;
      };
  };
</pre><p>
  If you run <code class="literal">nixos-rebuild switch</code>, the container will be
  built. If the container was already running, it will be updated in place,
  without rebooting. The container can be configured to start automatically by
  setting <code class="literal">containers.database.autoStart = true</code> in its
  configuration.
 </p><p>
  By default, declarative containers share the network namespace of the host,
  meaning that they can listen on (privileged) ports. However, they cannot
  change the network configuration. You can give a container its own network as
  follows:
</p><pre class="programlisting hljs nix" xml:space="preserve">containers.<span class="hljs-attr"><span class="hljs-attr">database</span></span> = {
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-containers._name_.privateNetwork" shape="rect"><span class="hljs-attr"><span class="hljs-attr">privateNetwork</span></span></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-containers._name_.hostAddress" shape="rect"><span class="hljs-attr"><span class="hljs-attr">hostAddress</span></span></a> = <span class="hljs-string"><span class="hljs-string">"192.168.100.10"</span></span>;
  <a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-containers._name_.localAddress" shape="rect"><span class="hljs-attr"><span class="hljs-attr">localAddress</span></span></a> = <span class="hljs-string"><span class="hljs-string">"192.168.100.11"</span></span>;
};
</pre><p>
  This gives the container a private virtual Ethernet interface with IP address
  <code class="literal">192.168.100.11</code>, which is hooked up to a virtual Ethernet
  interface on the host with IP address <code class="literal">192.168.100.10</code>. (See
  the next section for details on container networking.)
 </p><p>
  To disable the container, just remove it from
  <code class="filename">configuration.nix</code> and run <code class="literal">nixos-rebuild
  switch</code>. Note that this will not delete the root directory of the
  container in <code class="literal">/var/lib/containers</code>. Containers can be
  destroyed using the imperative method: <code class="literal">nixos-container destroy
  foo</code>.
 </p><p>
  Declarative containers can be started and stopped using the corresponding
  systemd service, e.g. <code class="literal">systemctl start container@database</code>.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-container-networking" class="title" style="clear: both">47.3.&nbsp;Container Networking<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-container-networking" aria-label="Anchor link for: sec container networking" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  When you create a container using <code class="literal">nixos-container create</code>,
  it gets it own private IPv4 address in the range
  <code class="literal">10.233.0.0/16</code>. You can get the container’s IPv4 address
  as follows:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-container show-ip foo</span></span>
<span class="hljs-number"><span class="hljs-number">10.233</span></span>.<span class="hljs-number"><span class="hljs-number">4.2</span></span>

<code class="prompt">$ </code>ping -c1 <span class="hljs-number"><span class="hljs-number">10.233</span></span>.<span class="hljs-number"><span class="hljs-number">4.2</span></span>
<span class="hljs-number"><span class="hljs-number">64</span></span> bytes from <span class="hljs-number"><span class="hljs-number">10.233</span></span>.<span class="hljs-number"><span class="hljs-number">4.2</span></span>: <span class="hljs-attr"><span class="hljs-attr">icmp_seq=1</span></span> <span class="hljs-attr"><span class="hljs-attr">ttl=64</span></span> <span class="hljs-attr"><span class="hljs-attr">time=0.106</span></span> ms
</pre><p>
 </p><p>
  Networking is implemented using a pair of virtual Ethernet devices. The
  network interface in the container is called <code class="literal">eth0</code>, while
  the matching interface in the host is called
  <code class="literal">ve-<em class="replaceable"><code>container-name</code></em></code> (e.g.,
  <code class="literal">ve-foo</code>). The container has its own network namespace and
  the <code class="literal">CAP_NET_ADMIN</code> capability, so it can perform arbitrary
  network configuration such as setting up firewall rules, without affecting or
  having access to the host’s network.
 </p><p>
  By default, containers cannot talk to the outside network. If you want that,
  you should set up Network Address Translation (NAT) rules on the host to
  rewrite container traffic to use your external IP address. This can be
  accomplished using the following configuration on the host:
</p><pre class="programlisting hljs nix" xml:space="preserve"><a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.nat.enable" shape="rect"><code class="option">networking.nat.<span class="hljs-attr"><span class="hljs-attr">enable</span></span></code></a> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.nat.internalInterfaces" shape="rect"><code class="option">networking.nat.<span class="hljs-attr"><span class="hljs-attr">internalInterfaces</span></span></code></a> = [<span class="hljs-string"><span class="hljs-string">"ve-+"</span></span>];
<a class="xref" href="https://nixos.org/manual/nixos/stable/options.html#opt-networking.nat.externalInterface" shape="rect"><code class="option">networking.nat.<span class="hljs-attr"><span class="hljs-attr">externalInterface</span></span></code></a> = <span class="hljs-string"><span class="hljs-string">"eth0"</span></span>;
</pre><p>
  where <code class="literal">eth0</code> should be replaced with the desired external
  interface. Note that <code class="literal">ve-+</code> is a wildcard that matches all
  container interfaces.
 </p><p>
  If you are using Network Manager, you need to explicitly prevent it from
  managing container interfaces:
</p><pre class="programlisting hljs nix" xml:space="preserve">networking.networkmanager.<span class="hljs-attr"><span class="hljs-attr">unmanaged</span></span> = [ <span class="hljs-string"><span class="hljs-string">"interface-name:ve-*"</span></span> ];
</pre><p>
 </p><p>
  You may need to restart your system for the changes to take effect.
 </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="ch-troubleshooting" class="title">Chapter&nbsp;48.&nbsp;Troubleshooting<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#ch-troubleshooting" aria-label="Anchor link for: ch troubleshooting" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-boot-problems" shape="rect">48.1. Boot Problems</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-maintenance-mode" shape="rect">48.2. Maintenance Mode</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-rollback" shape="rect">48.3. Rolling Back Configuration Changes</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-nix-store-corruption" shape="rect">48.4. Nix Store Corruption</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-nix-network-issues" shape="rect">48.5. Network Problems</a></span></dt></dl></div><p>
  This chapter describes solutions to common problems you might encounter when
  you manage your NixOS system.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="sec-boot-problems" class="title" style="clear: both">48.1.&nbsp;Boot Problems<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-boot-problems" aria-label="Anchor link for: sec boot problems" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  If NixOS fails to boot, there are a number of kernel command line parameters
  that may help you to identify or fix the issue. You can add these parameters
  in the GRUB boot menu by pressing “e” to modify the selected boot entry
  and editing the line starting with <code class="literal">linux</code>. The following
  are some useful kernel command line parameters that are recognised by the
  NixOS boot scripts or by systemd:
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <code class="literal">boot.shell_on_fail</code>
    </span></dt><dd><p>
      Allows the user to start a root shell if something goes wrong in stage 1
      of the boot process (the initial ramdisk). This is disabled by default
      because there is no authentication for the root shell.
     </p></dd><dt><span class="term">
     <code class="literal">boot.debug1</code>
    </span></dt><dd><p>
      Start an interactive shell in stage 1 before anything useful has been
      done. That is, no modules have been loaded and no file systems have been
      mounted, except for <code class="filename">/proc</code> and
      <code class="filename">/sys</code>.
     </p></dd><dt><span class="term">
     <code class="literal">boot.debug1devices</code>
    </span></dt><dd><p>
      Like <code class="literal">boot.debug1</code>, but runs stage1 until kernel modules are loaded and device nodes are created.
      This may help with e.g. making the keyboard work.
     </p></dd><dt><span class="term">
     <code class="literal">boot.debug1mounts</code>
    </span></dt><dd><p>
      Like <code class="literal">boot.debug1</code> or
      <code class="literal">boot.debug1devices</code>, but runs stage1 until all
      filesystems that are mounted during initrd are mounted (see
      <code class="option"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-fileSystems._name_.neededForBoot" shape="rect">neededForBoot</a></code>
      ). As a motivating example, this could be useful if you've forgotten to set
      <code class="option"><a class="link" href="https://nixos.org/manual/nixos/stable/options.html#opt-fileSystems._name_.neededForBoot" shape="rect">neededForBoot</a></code>
      on a file system.
     </p></dd><dt><span class="term">
     <code class="literal">boot.trace</code>
    </span></dt><dd><p>
      Print every shell command executed by the stage 1 and 2 boot scripts.
     </p></dd><dt><span class="term">
     <code class="literal">single</code>
    </span></dt><dd><p>
      Boot into rescue mode (a.k.a. single user mode). This will cause systemd
      to start nothing but the unit <code class="literal">rescue.target</code>, which
      runs <span class="command"><strong>sulogin</strong></span> to prompt for the root password and start
      a root login shell. Exiting the shell causes the system to continue with
      the normal boot process.
     </p></dd><dt><span class="term">
     <code class="literal">systemd.log_level=debug systemd.log_target=console</code>
    </span></dt><dd><p>
      Make systemd very verbose and send log messages to the console instead of
      the journal.
     </p></dd></dl></div><p>
  For more parameters recognised by systemd, see <span class="citerefentry"><span class="refentrytitle">systemd</span>(1)</span>.
 </p><p>
  Notice that for <code class="literal">boot.shell_on_fail</code>,
  <code class="literal">boot.debug1</code>, <code class="literal">boot.debug1devices</code>, and
  <code class="literal">boot.debug1mounts</code>, if you did <span class="emphasis"><em>not</em></span>
  select "start the new shell as pid 1", and you <code class="literal">exit</code> from
  the new shell, boot will proceed normally from the point where it failed, as
  if you'd chosen "ignore the error and continue".
 </p><p>
  If no login prompts or X11 login screens appear (e.g. due to hanging
  dependencies), you can press Alt+ArrowUp. If you’re lucky, this will start
  rescue mode (described above). (Also note that since most units have a
  90-second timeout before systemd gives up on them, the
  <span class="command"><strong>agetty</strong></span> login prompts should appear eventually unless
  something is very wrong.)
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-maintenance-mode" class="title" style="clear: both">48.2.&nbsp;Maintenance Mode<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-maintenance-mode" aria-label="Anchor link for: sec maintenance mode" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  You can enter rescue mode by running:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">systemctl rescue</span></span></pre><p>
  This will eventually give you a single-user root shell. Systemd will stop
  (almost) all system services. To get out of maintenance mode, just exit from
  the rescue shell.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-rollback" class="title" style="clear: both">48.3.&nbsp;Rolling Back Configuration Changes<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-rollback" aria-label="Anchor link for: sec rollback" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  After running <span class="command"><strong>nixos-rebuild</strong></span> to switch to a new
  configuration, you may find that the new configuration doesn’t work very
  well. In that case, there are several ways to return to a previous
  configuration.
 </p><p>
  First, the GRUB boot manager allows you to boot into any previous
  configuration that hasn’t been garbage-collected. These configurations can
  be found under the GRUB submenu “NixOS - All configurations”. This is
  especially useful if the new configuration fails to boot. After the system
  has booted, you can make the selected configuration the default for
  subsequent boots:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">/run/current-system/bin/switch-to-configuration boot</span></span></pre><p>
 </p><p>
  Second, you can switch to the previous configuration in a running system:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-rebuild switch --rollback</span></span></pre><p>
  This is equivalent to running:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">/nix/var/nix/profiles/system-</span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">N</span></span></code></em><span class="hljs-comment"><span class="hljs-comment">-link/bin/switch-to-configuration switch</span></span></pre><p>
  where <em class="replaceable"><code>N</code></em> is the number of the NixOS system
  configuration. To get a list of the available configurations, do:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>ls -l /nix/var/nix/profiles/system-*-link
<em class="replaceable"><code>...</code></em>
lrwxrwxrwx 1 root root 78 Aug 12 13:54 /nix/var/nix/profiles/system-268-link -&gt; /nix/store/202b...-nixos-13.07pre4932_5a676e4-4be1055
</pre><p>
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-nix-store-corruption" class="title" style="clear: both">48.4.&nbsp;Nix Store Corruption<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-nix-store-corruption" aria-label="Anchor link for: sec nix store corruption" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  After a system crash, it’s possible for files in the Nix store to become
  corrupted. (For instance, the Ext4 file system has the tendency to replace
  un-synced files with zero bytes.) NixOS tries hard to prevent this from
  happening: it performs a <span class="command"><strong>sync</strong></span> before switching to a new
  configuration, and Nix’s database is fully transactional. If corruption
  still occurs, you may be able to fix it automatically.
 </p><p>
  If the corruption is in a path in the closure of the NixOS system
  configuration, you can fix it by doing
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-rebuild switch --repair</span></span>
</pre><p>
  This will cause Nix to check every path in the closure, and if its
  cryptographic hash differs from the hash recorded in Nix’s database, the
  path is rebuilt or redownloaded.
 </p><p>
  You can also scan the entire Nix store for corrupt paths:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nix-store --verify --check-contents --repair</span></span>
</pre><p>
  Any corrupt paths will be redownloaded if they’re available in a binary
  cache; otherwise, they cannot be repaired.
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-nix-network-issues" class="title" style="clear: both">48.5.&nbsp;Network Problems<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-nix-network-issues" aria-label="Anchor link for: sec nix network issues" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Nix uses a so-called <span class="emphasis"><em>binary cache</em></span> to optimise building a
  package from source into downloading it as a pre-built binary. That is,
  whenever a command like <span class="command"><strong>nixos-rebuild</strong></span> needs a path in the
  Nix store, Nix will try to download that path from the Internet rather than
  build it from source. The default binary cache is
  <code class="uri">https://cache.nixos.org/</code>. If this cache is unreachable, Nix
  operations may take a long time due to HTTP connection timeouts. You can
  disable the use of the binary cache by adding <code class="option">--option
  use-binary-caches false</code>, e.g.
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-rebuild switch --option use-binary-caches false</span></span>
</pre><p>
  If you have an alternative binary cache at your disposal, you can use it
  instead:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-rebuild switch --option binary-caches </span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">http://my-cache.example.org/</span></span></code></em>
</pre><p>
 </p></section></section></div><div class="part"><div class="titlepage"><div><div><div class="page-header"><h1 id="ch-development" class="title">Part&nbsp;IV.&nbsp;Development<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#ch-development" aria-label="Anchor link for: ch development" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h1></div></div></div></div><div class="partintro"><div></div><p>
   This chapter describes how you can modify and extend NixOS.
  </p><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-getting-sources" shape="rect">49. Getting the Sources</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-writing-modules" shape="rect">50. Writing NixOS Modules</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-building-parts" shape="rect">51. Building Specific Parts of NixOS</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-writing-documentation" shape="rect">52. Writing NixOS Documentation</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-building-cd" shape="rect">53. Building Your Own NixOS CD</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-nixos-tests" shape="rect">54. NixOS Tests</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-testing-installer" shape="rect">55. Testing the Installer</a></span></dt><dt><span class="chapter"><a href="https://nixos.org/manual/nixos/stable/index.html#ch-releases" shape="rect">56. Releases</a></span></dt></dl></div></div><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-getting-sources" class="title">Chapter&nbsp;49.&nbsp;Getting the Sources<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-getting-sources" aria-label="Anchor link for: sec getting sources" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  By default, NixOS’s <span class="command"><strong>nixos-rebuild</strong></span> command uses the NixOS
  and Nixpkgs sources provided by the <code class="literal">nixos</code> channel (kept in
  <code class="filename">/nix/var/nix/profiles/per-user/root/channels/nixos</code>). To
  modify NixOS, however, you should check out the latest sources from Git. This
  is as follows:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/NixOS/nixpkgs
<code class="prompt">$ </code><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nixpkgs
<code class="prompt">$ </code>git remote update origin
</pre><p>
  This will check out the latest Nixpkgs sources to
  <code class="filename">./nixpkgs</code> the NixOS sources to
  <code class="filename">./nixpkgs/nixos</code>. (The NixOS source tree lives in a
  subdirectory of the Nixpkgs repository.) The
  <code class="literal">nixpkgs</code> repository has branches that correspond
  to each Nixpkgs/NixOS channel (see <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-upgrading" title="Chapter 4. Upgrading NixOS" shape="rect">Chapter&nbsp;4, <em>Upgrading NixOS</em></a> for more
  information about channels). Thus, the Git branch
  <code class="literal">origin/nixos-17.03</code> will contain the latest built and
  tested version available in the <code class="literal">nixos-17.03</code> channel.
 </p><p>
  It’s often inconvenient to develop directly on the master branch, since if
  somebody has just committed (say) a change to GCC, then the binary cache may
  not have caught up yet and you’ll have to rebuild everything from source.
  So you may want to create a local branch based on your current NixOS version:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>nixos-version
17.09pre104379.6e0b727 (Hummingbird)

<code class="prompt">$ </code>git checkout -b <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 6e0b727
</pre><p>
  Or, to base your local branch on the latest version available in a NixOS
  channel:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>git remote update origin
<code class="prompt">$ </code>git checkout -b <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> origin/nixos-17.03
</pre><p>
  (Replace <code class="literal">nixos-17.03</code> with the name of the channel you want
  to use.) You can use <span class="command"><strong>git merge</strong></span> or <span class="command"><strong>git
  rebase</strong></span> to keep your local branch in sync with the channel, e.g.
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>git remote update origin
<code class="prompt">$ </code>git merge origin/nixos-17.03
</pre><p>
  You can use <span class="command"><strong>git cherry-pick</strong></span> to copy commits from your
  local branch to the upstream branch.
 </p><p>
  If you want to rebuild your system using your (modified) sources, you need to
  tell <span class="command"><strong>nixos-rebuild</strong></span> about them using the
  <code class="option">-I</code> flag:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-rebuild switch -I nixpkgs=</span></span><em class="replaceable"><code><span class="hljs-comment"><span class="hljs-comment">/my/sources</span></span></code></em><span class="hljs-comment"><span class="hljs-comment">/nixpkgs</span></span>
</pre><p>
 </p><p>
  If you want <span class="command"><strong>nix-env</strong></span> to use the expressions in
  <em class="replaceable"><code>/my/sources</code></em>, use <span class="command"><strong>nix-env -f
  <em class="replaceable"><code>/my/sources</code></em>/nixpkgs</strong></span>, or change the
  default by adding a symlink in <code class="filename">~/.nix-defexpr</code>:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>ln -s <em class="replaceable"><code>/my/sources</code></em>/nixpkgs ~/.nix-defexpr/nixpkgs
</pre><p>
  You may want to delete the symlink
  <code class="filename">~/.nix-defexpr/channels_root</code> to prevent root’s NixOS
  channel from clashing with your own tree (this may break the
  command-not-found utility though). If you want to go back to the default
  state, you may just remove the <code class="filename">~/.nix-defexpr</code> directory
  completely, log out and log in again and it should have been recreated with a
  link to the root channels.
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-writing-modules" class="title">Chapter&nbsp;50.&nbsp;Writing NixOS Modules<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-writing-modules" aria-label="Anchor link for: sec writing modules" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-option-declarations" shape="rect">50.1. Option Declarations</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-option-types" shape="rect">50.2. Options Types</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-option-definitions" shape="rect">50.3. Option Definitions</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-assertions" shape="rect">50.4. Warnings and Assertions</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-meta-attributes" shape="rect">50.5. Meta Attributes</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-importing-modules" shape="rect">50.6. Importing Modules</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-replace-modules" shape="rect">50.7. Replace Modules</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-freeform-modules" shape="rect">50.8. Freeform modules</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-settings-options" shape="rect">50.9. Options for Program Settings</a></span></dt></dl></div><p>
  NixOS has a modular system for declarative configuration. This system
  combines multiple <span class="emphasis"><em>modules</em></span> to produce the full system
  configuration. One of the modules that constitute the configuration is
  <code class="filename">/etc/nixos/configuration.nix</code>. Most of the others live in
  the
  <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/modules" target="_top" shape="rect"><code class="filename">nixos/modules</code></a>
  subdirectory of the Nixpkgs tree.
 </p><p>
  Each NixOS module is a file that handles one logical aspect of the
  configuration, such as a specific kind of hardware, a service, or network
  settings. A module configuration does not have to handle everything from
  scratch; it can use the functionality provided by other modules for its
  implementation. Thus a module can <span class="emphasis"><em>declare</em></span> options that
  can be used by other modules, and conversely can <span class="emphasis"><em>define</em></span>
  options provided by other modules in its own implementation. For example, the
  module
  <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/security/pam.nix" target="_top" shape="rect"><code class="filename">pam.nix</code></a>
  declares the option <code class="option">security.pam.services</code> that allows other
  modules (e.g.
  <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/networking/ssh/sshd.nix" target="_top" shape="rect"><code class="filename">sshd.nix</code></a>)
  to define PAM services; and it defines the option
  <code class="option">environment.etc</code> (declared by
  <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/system/etc/etc.nix" target="_top" shape="rect"><code class="filename">etc.nix</code></a>)
  to cause files to be created in <code class="filename">/etc/pam.d</code>.
 </p><p><a id="para-module-syn" shape="rect"></a>
  In <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-configuration-syntax" title="Chapter 5. Configuration Syntax" shape="rect">Chapter&nbsp;5, <em>Configuration Syntax</em></a>, we saw the following structure
  of NixOS modules:
</p><pre class="programlisting hljs" xml:space="preserve">{ config, pkgs, ... }:

{ <em class="replaceable"><code>option definitions</code></em>
}
</pre><p>
  This is actually an <span class="emphasis"><em>abbreviated</em></span> form of module that only
  defines options, but does not declare any. The structure of full NixOS
  modules is shown in <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-module-syntax" title="Example 50.1. Structure of NixOS Modules" shape="rect">Example&nbsp;50.1, “Structure of NixOS Modules”</a>.
 </p><div class="example"><a id="ex-module-syntax" shape="rect"></a><p class="title"><strong>Example&nbsp;50.1.&nbsp;Structure of NixOS Modules</strong></p><div class="example-contents"><pre class="programlisting hljs nix" xml:space="preserve">{ config, pkgs, ... }: <a id="module-syntax-1" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/1.svg" alt="1" border="0"></span>

{
  <span class="hljs-attr"><span class="hljs-attr">imports</span></span> =
    [ <em class="replaceable"><code>paths of other modules</code></em> <a id="module-syntax-2" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/2.svg" alt="2" border="0"></span>
    ];

  <span class="hljs-attr"><span class="hljs-attr">options</span></span> = {
    <em class="replaceable"><code>option declarations</code></em> <a id="module-syntax-3" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/3.svg" alt="3" border="0"></span>
  };

  <span class="hljs-attr"><span class="hljs-attr">config</span></span> = {
    <em class="replaceable"><code>option definitions</code></em> <a id="module-syntax-4" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/4.svg" alt="4" border="0"></span>
  };
}</pre></div></div><br class="example-break" clear="none"><br><p>
  The meaning of each part is as follows.
  </p><div class="calloutlist"><table class="table table-striped" border="0" summary="Callout list"><tbody><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#module-syntax-1" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/1.svg" alt="1" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
     This line makes the current Nix expression a function. The variable
     <code class="varname">pkgs</code> contains Nixpkgs, while <code class="varname">config</code>
     contains the full system configuration. This line can be omitted if there
     is no reference to <code class="varname">pkgs</code> and <code class="varname">config</code>
     inside the module.
    </p></td></tr><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#module-syntax-2" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/2.svg" alt="2" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
     This list enumerates the paths to other NixOS modules that should be
     included in the evaluation of the system configuration. A default set of
     modules is defined in the file
     <code class="filename">modules/module-list.nix</code>. These don't need to be added
     in the import list.
    </p></td></tr><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#module-syntax-3" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/3.svg" alt="3" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
     The attribute <code class="varname">options</code> is a nested set of
     <span class="emphasis"><em>option declarations</em></span> (described below).
    </p></td></tr><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#module-syntax-4" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/4.svg" alt="4" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
     The attribute <code class="varname">config</code> is a nested set of
     <span class="emphasis"><em>option definitions</em></span> (also described below).
    </p></td></tr></tbody></table></div><p>
 </p><p>
  <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#locate-example" title="Example 50.2. NixOS Module for the “locate” Service" shape="rect">Example&nbsp;50.2, “NixOS Module for the “locate” Service”</a> shows a module that handles the regular
  update of the “locate” database, an index of all files in the file
  system. This module declares two options that can be defined by other modules
  (typically the user’s <code class="filename">configuration.nix</code>):
  <code class="option">services.locate.enable</code> (whether the database should be
  updated) and <code class="option">services.locate.interval</code> (when the update
  should be done). It implements its functionality by defining two options
  declared by other modules: <code class="option">systemd.services</code> (the set of all
  systemd services) and <code class="option">systemd.timers</code> (the list of commands
  to be executed periodically by <span class="command"><strong>systemd</strong></span>).
 </p><div class="example"><a id="locate-example" shape="rect"></a><p class="title"><strong>Example&nbsp;50.2.&nbsp;NixOS Module for the “locate” Service</strong></p><div class="example-contents"><pre class="programlisting hljs nix" xml:space="preserve">{ config, lib, pkgs, ... }:

<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> lib;

<span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
  <span class="hljs-attr"><span class="hljs-attr">cfg</span></span> = config.services.locate;
<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {
  options.services.<span class="hljs-attr"><span class="hljs-attr">locate</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">enable</span></span> = mkOption {
      <span class="hljs-attr"><span class="hljs-attr">type</span></span> = types.bool;
      <span class="hljs-attr"><span class="hljs-attr">default</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">''
        If enabled, NixOS will periodically update the database of
        files used by the </span></span><span class="command"><strong><span class="hljs-string"><span class="hljs-string">locate</span></span></strong></span><span class="hljs-string"><span class="hljs-string"> command.
      ''</span></span>;
    };

    <span class="hljs-attr"><span class="hljs-attr">interval</span></span> = mkOption {
      <span class="hljs-attr"><span class="hljs-attr">type</span></span> = types.str;
      <span class="hljs-attr"><span class="hljs-attr">default</span></span> = <span class="hljs-string"><span class="hljs-string">"02:15"</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">example</span></span> = <span class="hljs-string"><span class="hljs-string">"hourly"</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">''
        Update the locate database at this interval. Updates by
        default at 2:15 AM every day.

        The format is described in
        </span></span><span class="citerefentry"><span class="refentrytitle"><span class="hljs-string"><span class="hljs-string">systemd.time</span></span></span><span class="hljs-string"><span class="hljs-string">(7)</span></span></span><span class="hljs-string"><span class="hljs-string">.
      ''</span></span>;
    };

    <span class="hljs-comment"><span class="hljs-comment"># Other options omitted for documentation</span></span>
  };

  <span class="hljs-attr"><span class="hljs-attr">config</span></span> = {
    systemd.services.<span class="hljs-attr"><span class="hljs-attr">update-locatedb</span></span> =
      { <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">"Update Locate Database"</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">path</span></span>  = [ pkgs.su ];
        <span class="hljs-attr"><span class="hljs-attr">script</span></span> =
          <span class="hljs-string"><span class="hljs-string">''
            mkdir -m 0755 -p $(dirname </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">toString</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> cfg.output}</span></span></span><span class="hljs-string">)
            exec updatedb \
              --localuser=</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${cfg.localuser}</span></span></span><span class="hljs-string"> \
              </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${optionalString (!cfg.includeStore) </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"--prunepaths='/nix/store'"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string"> \
              --output=</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">toString</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> cfg.output}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${concatStringsSep </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">" "</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> cfg.extraFlags}</span></span></span><span class="hljs-string">
          ''</span></span>;
      };

    systemd.timers.<span class="hljs-attr"><span class="hljs-attr">update-locatedb</span></span> = mkIf cfg.enable
      { <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">"Update timer for locate database"</span></span>;
        <span class="hljs-attr"><span class="hljs-attr">partOf</span></span>      = [ <span class="hljs-string"><span class="hljs-string">"update-locatedb.service"</span></span> ];
        <span class="hljs-attr"><span class="hljs-attr">wantedBy</span></span>    = [ <span class="hljs-string"><span class="hljs-string">"timers.target"</span></span> ];
        timerConfig.<span class="hljs-attr"><span class="hljs-attr">OnCalendar</span></span> = cfg.interval;
      };
  };
}
</pre></div></div><br class="example-break" clear="none"><br><section class="section"><div class="titlepage"><div><div><h2 id="sec-option-declarations" class="title" style="clear: both">50.1.&nbsp;Option Declarations<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-option-declarations" aria-label="Anchor link for: sec option declarations" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  An option declaration specifies the name, type and description of a NixOS
  configuration option. It is invalid to define an option that hasn’t been
  declared in any module. An option declaration generally looks like this:
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-attr"><span class="hljs-attr">options</span></span> = {
  <em class="replaceable"><code><span class="hljs-attr"><span class="hljs-attr">name</span></span></code></em> = mkOption {
    <span class="hljs-attr"><span class="hljs-attr">type</span></span> = <em class="replaceable"><code>type specification</code></em>;
    <span class="hljs-attr"><span class="hljs-attr">default</span></span> = <em class="replaceable"><code>default value</code></em>;
    <span class="hljs-attr"><span class="hljs-attr">example</span></span> = <em class="replaceable"><code>example value</code></em>;
    <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">"</span></span><em class="replaceable"><code><span class="hljs-string"><span class="hljs-string">Description for use in the NixOS manual.</span></span></code></em><span class="hljs-string"><span class="hljs-string">"</span></span>;
  };
};
</pre><p>
  The attribute names within the <em class="replaceable"><code>name</code></em> attribute path
  must be camel cased in general but should, as an exception, match the
  <a class="link" href="https://nixos.org/nixpkgs/manual/#sec-package-naming" target="_top" shape="rect">
  package attribute name</a> when referencing a Nixpkgs package. For
  example, the option <code class="varname">services.nix-serve.bindAddress</code>
  references the <code class="varname">nix-serve</code> Nixpkgs package.
 </p><p>
  The function <code class="varname">mkOption</code> accepts the following arguments.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <code class="varname">type</code>
    </span></dt><dd><p>
      The type of the option (see <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-option-types" title="50.2. Options Types" shape="rect">Section&nbsp;50.2, “Options Types”</a>). It may
      be omitted, but that’s not advisable since it may lead to errors that
      are hard to diagnose.
     </p></dd><dt><span class="term">
     <code class="varname">default</code>
    </span></dt><dd><p>
      The default value used if no value is defined by any module. A default is
      not required; but if a default is not given, then users of the module
      will have to define the value of the option, otherwise an error will be
      thrown.
     </p></dd><dt><span class="term">
     <code class="varname">example</code>
    </span></dt><dd><p>
      An example value that will be shown in the NixOS manual.
     </p></dd><dt><span class="term">
     <code class="varname">description</code>
    </span></dt><dd><p>
      A textual description of the option, in DocBook format, that will be
      included in the NixOS manual.
     </p></dd></dl></div><p>
 </p><section class="section"><div class="titlepage"><div><div><h3 id="sec-option-declarations-eot" class="title">50.1.1.&nbsp;Extensible Option Types<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-option-declarations-eot" aria-label="Anchor link for: sec option declarations eot" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   Extensible option types is a feature that allow to extend certain types
   declaration through multiple module files. This feature only work with a
   restricted set of types, namely <code class="literal">enum</code> and
   <code class="literal">submodules</code> and any composed forms of them.
  </p><p>
   Extensible option types can be used for <code class="literal">enum</code> options that
   affects multiple modules, or as an alternative to related
   <code class="literal">enable</code> options.
  </p><p>
   As an example, we will take the case of display managers. There is a central
   display manager module for generic display manager options and a module file
   per display manager backend (sddm, gdm ...).
  </p><p>
   There are two approach to this module structure:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      Managing the display managers independently by adding an enable option to
      every display manager module backend. (NixOS)
     </p></li><li class="listitem"><p>
      Managing the display managers in the central module by adding an option
      to select which display manager backend to use.
     </p></li></ul></div><p>
  </p><p>
   Both approaches have problems.
  </p><p>
   Making backends independent can quickly become hard to manage. For display
   managers, there can be only one enabled at a time, but the type system can
   not enforce this restriction as there is no relation between each backend
   <code class="literal">enable</code> option. As a result, this restriction has to be
   done explicitely by adding assertions in each display manager backend
   module.
  </p><p>
   On the other hand, managing the display managers backends in the central
   module will require to change the central module option every time a new
   backend is added or removed.
  </p><p>
   By using extensible option types, it is possible to create a placeholder
   option in the central module
   (<a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-option-declaration-eot-service" title="Example 50.3. Extensible type placeholder in the service module" shape="rect">Example&nbsp;50.3, “Extensible type placeholder in the service module”</a>), and to extend
   it in each backend module
   (<a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-option-declaration-eot-backend-gdm" title="Example 50.4. Extending services.xserver.displayManager.enable in the gdm module" shape="rect">Example&nbsp;50.4, “Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">gdm</code> module”</a>,
   <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-option-declaration-eot-backend-sddm" title="Example 50.5. Extending services.xserver.displayManager.enable in the sddm module" shape="rect">Example&nbsp;50.5, “Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">sddm</code> module”</a>).
  </p><p>
   As a result, <code class="literal">displayManager.enable</code> option values can be
   added without changing the main service module file and the type system
   automatically enforce that there can only be a single display manager
   enabled.
  </p><div class="example"><a id="ex-option-declaration-eot-service" shape="rect"></a><p class="title"><strong>Example&nbsp;50.3.&nbsp;Extensible type placeholder in the service module</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve">services.xserver.displayManager.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = mkOption {
  <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">"Display manager to use"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">type</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> types; nullOr (enum [ ]);
};</pre></div></div><br class="example-break" clear="none"><br><div class="example"><a id="ex-option-declaration-eot-backend-gdm" shape="rect"></a><p class="title"><strong>Example&nbsp;50.4.&nbsp;Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">gdm</code> module</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve">services.xserver.displayManager.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = mkOption {
  <span class="hljs-attr"><span class="hljs-attr">type</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> types; nullOr (enum [ <span class="hljs-string"><span class="hljs-string">"gdm"</span></span> ]);
};</pre></div></div><br class="example-break" clear="none"><br><div class="example"><a id="ex-option-declaration-eot-backend-sddm" shape="rect"></a><p class="title"><strong>Example&nbsp;50.5.&nbsp;Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">sddm</code> module</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve">services.xserver.displayManager.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = mkOption {
  <span class="hljs-attr"><span class="hljs-attr">type</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> types; nullOr (enum [ <span class="hljs-string"><span class="hljs-string">"sddm"</span></span> ]);
};</pre></div></div><br class="example-break" clear="none"><br><p>
   The placeholder declaration is a standard <code class="literal">mkOption</code>
   declaration, but it is important that extensible option declarations only
   use the <code class="literal">type</code> argument.
  </p><p>
   Extensible option types work with any of the composed variants of
   <code class="literal">enum</code> such as <code class="literal">with types; nullOr (enum [ "foo"
   "bar" ])</code> or <code class="literal">with types; listOf (enum [ "foo" "bar"
   ])</code>.
  </p></section></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-option-types" class="title" style="clear: both">50.2.&nbsp;Options Types<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-option-types" aria-label="Anchor link for: sec option types" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Option types are a way to put constraints on the values a module option can
  take. Types are also responsible of how values are merged in case of multiple
  value definitions.
 </p><section class="section"><div class="titlepage"><div><div><h3 id="sec-option-types-basic" class="title">50.2.1.&nbsp;Basic Types<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-option-types-basic" aria-label="Anchor link for: sec option types basic" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   Basic types are the simplest available types in the module system. Basic
   types include multiple string types that mainly differ in how definition
   merging is handled.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <code class="varname">types.attrs</code>
    </span></dt><dd><p>
      A free-form attribute set.
     </p></dd><dt><span class="term">
     <code class="varname">types.bool</code>
    </span></dt><dd><p>
      A boolean, its values can be <code class="literal">true</code> or
      <code class="literal">false</code>.
     </p></dd><dt><span class="term">
     <code class="varname">types.path</code>
    </span></dt><dd><p>
      A filesystem path, defined as anything that when coerced to a string
      starts with a slash. Even if derivations can be considered as path, the
      more specific <code class="literal">types.package</code> should be preferred.
     </p></dd><dt><span class="term">
     <code class="varname">types.package</code>
    </span></dt><dd><p>
      A derivation or a store path.
     </p></dd></dl></div><p>
   Integer-related types:
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <code class="varname">types.int</code>
    </span></dt><dd><p>
      A signed integer.
     </p></dd><dt><span class="term">
     <code class="varname">types.ints.{s8, s16, s32}</code>
    </span></dt><dd><p>
      Signed integers with a fixed length (8, 16 or 32 bits). They go from
      <span class="mathphrase">−2<sup>n</sup>/2</span> to <span class="mathphrase">2<sup>n</sup>/2−1</span> respectively (e.g. <code class="literal">−128</code> to
      <code class="literal">127</code> for 8 bits).
     </p></dd><dt><span class="term">
     <code class="varname">types.ints.unsigned</code>
    </span></dt><dd><p>
      An unsigned integer (that is &gt;= 0).
     </p></dd><dt><a id="types.ints.ux" shape="rect"></a><span class="term">
     <code class="varname">types.ints.{u8, u16, u32}</code>
    </span></dt><dd><p>
      Unsigned integers with a fixed length (8, 16 or 32 bits). They go from
      <span class="mathphrase">0</span> to
      <span class="mathphrase">2<sup>n</sup>−1</span> respectively (e.g. <code class="literal">0</code> to
      <code class="literal">255</code> for 8 bits).
     </p></dd><dt><span class="term">
     <code class="varname">types.ints.positive</code>
    </span></dt><dd><p>
      A positive integer (that is &gt; 0).
     </p></dd><dt><span class="term">
     <code class="varname">types.port</code>
    </span></dt><dd><p>
      A port number. This type is an alias to
      <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#types.ints.ux" shape="rect"><code class="varname">types.ints.u16</code></a>.
     </p></dd></dl></div><p>
   String-related types:
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <code class="varname">types.str</code>
    </span></dt><dd><p>
      A string. Multiple definitions cannot be merged.
     </p></dd><dt><span class="term">
     <code class="varname">types.lines</code>
    </span></dt><dd><p>
      A string. Multiple definitions are concatenated with a new line
      <code class="literal">"\n"</code>.
     </p></dd><dt><span class="term">
     <code class="varname">types.commas</code>
    </span></dt><dd><p>
      A string. Multiple definitions are concatenated with a comma
      <code class="literal">","</code>.
     </p></dd><dt><span class="term">
     <code class="varname">types.envVar</code>
    </span></dt><dd><p>
      A string. Multiple definitions are concatenated with a collon
      <code class="literal">":"</code>.
     </p></dd><dt><span class="term">
     <code class="varname">types.strMatching</code>
    </span></dt><dd><p>
      A string matching a specific regular expression. Multiple definitions
      cannot be merged. The regular expression is processed using
      <code class="literal">builtins.match</code>.
     </p></dd></dl></div></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-option-types-value" class="title">50.2.2.&nbsp;Value Types<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-option-types-value" aria-label="Anchor link for: sec option types value" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   Value types are types that take a value parameter.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <code class="varname">types.enum</code> <em class="replaceable"><code>l</code></em>
    </span></dt><dd><p>
      One element of the list <em class="replaceable"><code>l</code></em>, e.g.
      <code class="literal">types.enum [ "left" "right" ]</code>. Multiple definitions
      cannot be merged.
     </p></dd><dt><span class="term">
     <code class="varname">types.separatedString</code> <em class="replaceable"><code>sep</code></em>
    </span></dt><dd><p>
      A string with a custom separator <em class="replaceable"><code>sep</code></em>, e.g.
      <code class="literal">types.separatedString "|"</code>.
     </p></dd><dt><span class="term">
     <code class="varname">types.ints.between</code> <em class="replaceable"><code>lowest</code></em> <em class="replaceable"><code>highest</code></em>
    </span></dt><dd><p>
      An integer between <em class="replaceable"><code>lowest</code></em> and
      <em class="replaceable"><code>highest</code></em> (both inclusive). Useful for creating
      types like <code class="literal">types.port</code>.
     </p></dd><dt><span class="term">
     <code class="varname">types.submodule</code> <em class="replaceable"><code>o</code></em>
    </span></dt><dd><p>
      A set of sub options <em class="replaceable"><code>o</code></em>.
      <em class="replaceable"><code>o</code></em> can be an attribute set, a function
      returning an attribute set, or a path to a file containing such a value. Submodules are used in
      composed types to create modular options. This is equivalent to
      <code class="literal">types.submoduleWith { modules = toList o; shorthandOnlyDefinesConfig = true; }</code>.
      Submodules are detailed in
      <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#section-option-types-submodule" title="50.2.4. Submodule" shape="rect">Section&nbsp;50.2.4, “Submodule”</a>.
     </p></dd><dt><span class="term">
       <code class="varname">types.submoduleWith</code> {
        <em class="replaceable"><code>modules</code></em>,
        <em class="replaceable"><code>specialArgs</code></em> ? {},
        <em class="replaceable"><code>shorthandOnlyDefinesConfig</code></em> ? false }
     </span></dt><dd><p>
         Like <code class="varname">types.submodule</code>, but more flexible and with better defaults.
         It has parameters
         </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
             <em class="replaceable"><code>modules</code></em>
             A list of modules to use by default for this submodule type. This gets combined
             with all option definitions to build the final list of modules that will be included.
             </p><div class="alert alert-info"><strong>Note:</strong> 
               Only options defined with this argument are included in rendered documentation.
             </div><p>
           </p></li><li class="listitem"><p>
             <em class="replaceable"><code>specialArgs</code></em>
             An attribute set of extra arguments to be passed to the module functions.
             The option <code class="literal">_module.args</code> should be used instead
             for most arguments since it allows overriding. <em class="replaceable"><code>specialArgs</code></em> should only be
             used for arguments that can't go through the module fixed-point, because of
             infinite recursion or other problems. An example is overriding the
             <code class="varname">lib</code> argument, because <code class="varname">lib</code> itself is used
             to define <code class="literal">_module.args</code>, which makes using
             <code class="literal">_module.args</code> to define it impossible.
           </p></li><li class="listitem"><p>
             <em class="replaceable"><code>shorthandOnlyDefinesConfig</code></em>
             Whether definitions of this type should default to the <code class="literal">config</code>
             section of a module (see <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-module-syntax" title="Example 50.1. Structure of NixOS Modules" shape="rect">Example&nbsp;50.1, “Structure of NixOS Modules”</a>) if it is an attribute
             set. Enabling this only has a benefit when the submodule defines an option named
             <code class="literal">config</code> or <code class="literal">options</code>. In such a case it would
             allow the option to be set with <code class="literal">the-submodule.config = "value"</code>
             instead of requiring <code class="literal">the-submodule.config.config = "value"</code>.
             This is because only when modules <span class="emphasis"><em>don't</em></span> set the
             <code class="literal">config</code> or <code class="literal">options</code> keys, all keys are interpreted
             as option definitions in the <code class="literal">config</code> section. Enabling this option
             implicitly puts all attributes in the <code class="literal">config</code> section.
           </p><p>
             With this option enabled, defining a non-<code class="literal">config</code> section requires
             using a function: <code class="literal">the-submodule = { ... }: { options = { ... }; }</code>.
           </p></li></ul></div><p>
       </p></dd></dl></div></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-option-types-composed" class="title">50.2.3.&nbsp;Composed Types<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-option-types-composed" aria-label="Anchor link for: sec option types composed" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   Composed types are types that take a type as parameter. <code class="literal">listOf
   int</code> and <code class="literal">either int str</code> are examples of composed
   types.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <code class="varname">types.listOf</code> <em class="replaceable"><code>t</code></em>
    </span></dt><dd><p>
      A list of <em class="replaceable"><code>t</code></em> type, e.g. <code class="literal">types.listOf
      int</code>. Multiple definitions are merged with list concatenation.
     </p></dd><dt><span class="term">
     <code class="varname">types.attrsOf</code> <em class="replaceable"><code>t</code></em>
    </span></dt><dd><p>
      An attribute set of where all the values are of
      <em class="replaceable"><code>t</code></em> type. Multiple definitions result in the
      joined attribute set.
      </p><div class="alert alert-info"><strong>Note:</strong> 
       This type is <span class="emphasis"><em>strict</em></span> in its values, which in turn
       means attributes cannot depend on other attributes. See <code class="varname">
       types.lazyAttrsOf</code> for a lazy version.
      </div><p>
     </p></dd><dt><span class="term">
     <code class="varname">types.lazyAttrsOf</code> <em class="replaceable"><code>t</code></em>
    </span></dt><dd><p>
      An attribute set of where all the values are of
      <em class="replaceable"><code>t</code></em> type. Multiple definitions result in the
      joined attribute set. This is the lazy version of <code class="varname">types.attrsOf
      </code>, allowing attributes to depend on each other.
      </p><div class="alert alert-warning"><strong>Warning:</strong> 
       This version does not fully support conditional definitions! With an
       option <code class="varname">foo</code> of this type and a definition
       <code class="literal">foo.attr = lib.mkIf false 10</code>, evaluating
       <code class="literal">foo ? attr</code> will return <code class="literal">true</code>
       even though it should be false. Accessing the value will then throw
       an error. For types <em class="replaceable"><code>t</code></em> that have an
       <code class="literal">emptyValue</code> defined, that value will be returned
       instead of throwing an error. So if the type of <code class="literal">foo.attr</code>
       was <code class="literal">lazyAttrsOf (nullOr int)</code>, <code class="literal">null</code>
       would be returned instead for the same <code class="literal">mkIf false</code> definition.
      </div><p>
     </p></dd><dt><span class="term">
     <code class="varname">types.nullOr</code> <em class="replaceable"><code>t</code></em>
    </span></dt><dd><p>
      <code class="literal">null</code> or type <em class="replaceable"><code>t</code></em>. Multiple
      definitions are merged according to type <em class="replaceable"><code>t</code></em>.
     </p></dd><dt><span class="term">
     <code class="varname">types.uniq</code> <em class="replaceable"><code>t</code></em>
    </span></dt><dd><p>
      Ensures that type <em class="replaceable"><code>t</code></em> cannot be merged. It is
      used to ensure option definitions are declared only once.
     </p></dd><dt><span class="term">
     <code class="varname">types.either</code> <em class="replaceable"><code>t1</code></em> <em class="replaceable"><code>t2</code></em>
    </span></dt><dd><p>
      Type <em class="replaceable"><code>t1</code></em> or type <em class="replaceable"><code>t2</code></em>,
      e.g. <code class="literal">with types; either int str</code>. Multiple definitions
      cannot be merged.
     </p></dd><dt><span class="term">
     <code class="varname">types.oneOf</code> [ <em class="replaceable"><code>t1</code></em> <em class="replaceable"><code>t2</code></em> ... ]
    </span></dt><dd><p>
      Type <em class="replaceable"><code>t1</code></em> or type <em class="replaceable"><code>t2</code></em> and so forth,
      e.g. <code class="literal">with types; oneOf [ int str bool ]</code>. Multiple definitions
      cannot be merged.
     </p></dd><dt><span class="term">
     <code class="varname">types.coercedTo</code> <em class="replaceable"><code>from</code></em> <em class="replaceable"><code>f</code></em> <em class="replaceable"><code>to</code></em>
    </span></dt><dd><p>
      Type <em class="replaceable"><code>to</code></em> or type
      <em class="replaceable"><code>from</code></em> which will be coerced to type
      <em class="replaceable"><code>to</code></em> using function <em class="replaceable"><code>f</code></em>
      which takes an argument of type <em class="replaceable"><code>from</code></em> and
      return a value of type <em class="replaceable"><code>to</code></em>. Can be used to
      preserve backwards compatibility of an option if its type was changed.
     </p></dd></dl></div></section><section class="section"><div class="titlepage"><div><div><h3 id="section-option-types-submodule" class="title">50.2.4.&nbsp;Submodule<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#section-option-types-submodule" aria-label="Anchor link for: section option types submodule" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   <code class="literal">submodule</code> is a very powerful type that defines a set of
   sub-options that are handled like a separate module.
  </p><p>
   It takes a parameter <em class="replaceable"><code>o</code></em>, that should be a set, or
   a function returning a set with an <code class="literal">options</code> key defining
   the sub-options. Submodule option definitions are type-checked accordingly
   to the <code class="literal">options</code> declarations. Of course, you can nest
   submodule option definitons for even higher modularity.
  </p><p>
   The option set can be defined directly
   (<a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-submodule-direct" title="Example 50.6. Directly defined submodule" shape="rect">Example&nbsp;50.6, “Directly defined submodule”</a>) or as reference
   (<a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-submodule-reference" title="Example 50.7. Submodule defined as a reference" shape="rect">Example&nbsp;50.7, “Submodule defined as a reference”</a>).
  </p><div class="example"><a id="ex-submodule-direct" shape="rect"></a><p class="title"><strong>Example&nbsp;50.6.&nbsp;Directly defined submodule</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve">options.<span class="hljs-attr"><span class="hljs-attr">mod</span></span> = mkOption {
  <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">"submodule example"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">type</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> types; submodule {
    <span class="hljs-attr"><span class="hljs-attr">options</span></span> = {
      <span class="hljs-attr"><span class="hljs-attr">foo</span></span> = mkOption {
        <span class="hljs-attr"><span class="hljs-attr">type</span></span> = int;
      };
      <span class="hljs-attr"><span class="hljs-attr">bar</span></span> = mkOption {
        <span class="hljs-attr"><span class="hljs-attr">type</span></span> = str;
      };
    };
  };
};</pre></div></div><br class="example-break" clear="none"><br><div class="example"><a id="ex-submodule-reference" shape="rect"></a><p class="title"><strong>Example&nbsp;50.7.&nbsp;Submodule defined as a reference</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
  <span class="hljs-attr"><span class="hljs-attr">modOptions</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">options</span></span> = {
      <span class="hljs-attr"><span class="hljs-attr">foo</span></span> = mkOption {
        <span class="hljs-attr"><span class="hljs-attr">type</span></span> = int;
      };
      <span class="hljs-attr"><span class="hljs-attr">bar</span></span> = mkOption {
        <span class="hljs-attr"><span class="hljs-attr">type</span></span> = int;
      };
    };
  };
<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>
options.<span class="hljs-attr"><span class="hljs-attr">mod</span></span> = mkOption {
  <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">"submodule example"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">type</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> types; submodule modOptions;
};</pre></div></div><br class="example-break" clear="none"><br><p>
   The <code class="literal">submodule</code> type is especially interesting when used
   with composed types like <code class="literal">attrsOf</code> or
   <code class="literal">listOf</code>. When composed with <code class="literal">listOf</code>
   (<a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-submodule-listof-declaration" title="Example 50.8. Declaration of a list of submodules" shape="rect">Example&nbsp;50.8, “Declaration of a list of submodules”</a>),
   <code class="literal">submodule</code> allows multiple definitions of the submodule
   option set (<a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-submodule-listof-definition" title="Example 50.9. Definition of a list of submodules" shape="rect">Example&nbsp;50.9, “Definition of a list of submodules”</a>).
  </p><div class="example"><a id="ex-submodule-listof-declaration" shape="rect"></a><p class="title"><strong>Example&nbsp;50.8.&nbsp;Declaration of a list of submodules</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve">options.<span class="hljs-attr"><span class="hljs-attr">mod</span></span> = mkOption {
  <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">"submodule example"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">type</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> types; listOf (submodule {
    <span class="hljs-attr"><span class="hljs-attr">options</span></span> = {
      <span class="hljs-attr"><span class="hljs-attr">foo</span></span> = mkOption {
        <span class="hljs-attr"><span class="hljs-attr">type</span></span> = int;
      };
      <span class="hljs-attr"><span class="hljs-attr">bar</span></span> = mkOption {
        <span class="hljs-attr"><span class="hljs-attr">type</span></span> = str;
      };
    };
  });
};</pre></div></div><br class="example-break" clear="none"><br><div class="example"><a id="ex-submodule-listof-definition" shape="rect"></a><p class="title"><strong>Example&nbsp;50.9.&nbsp;Definition of a list of submodules</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve">config.<span class="hljs-attr"><span class="hljs-attr">mod</span></span> = [
  { <span class="hljs-attr"><span class="hljs-attr">foo</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attr"><span class="hljs-attr">bar</span></span> = <span class="hljs-string"><span class="hljs-string">"one"</span></span>; }
  { <span class="hljs-attr"><span class="hljs-attr">foo</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attr"><span class="hljs-attr">bar</span></span> = <span class="hljs-string"><span class="hljs-string">"two"</span></span>; }
];</pre></div></div><br class="example-break" clear="none"><br><p>
   When composed with <code class="literal">attrsOf</code>
   (<a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-submodule-attrsof-declaration" title="Example 50.10. Declaration of attribute sets of submodules" shape="rect">Example&nbsp;50.10, “Declaration of attribute sets of submodules”</a>),
   <code class="literal">submodule</code> allows multiple named definitions of the
   submodule option set (<a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-submodule-attrsof-definition" title="Example 50.11. Declaration of attribute sets of submodules" shape="rect">Example&nbsp;50.11, “Declaration of attribute sets of submodules”</a>).
  </p><div class="example"><a id="ex-submodule-attrsof-declaration" shape="rect"></a><p class="title"><strong>Example&nbsp;50.10.&nbsp;Declaration of attribute sets of submodules</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve">options.<span class="hljs-attr"><span class="hljs-attr">mod</span></span> = mkOption {
  <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">"submodule example"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">type</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> types; attrsOf (submodule {
    <span class="hljs-attr"><span class="hljs-attr">options</span></span> = {
      <span class="hljs-attr"><span class="hljs-attr">foo</span></span> = mkOption {
        <span class="hljs-attr"><span class="hljs-attr">type</span></span> = int;
      };
      <span class="hljs-attr"><span class="hljs-attr">bar</span></span> = mkOption {
        <span class="hljs-attr"><span class="hljs-attr">type</span></span> = str;
      };
    };
  });
};</pre></div></div><br class="example-break" clear="none"><br><div class="example"><a id="ex-submodule-attrsof-definition" shape="rect"></a><p class="title"><strong>Example&nbsp;50.11.&nbsp;Declaration of attribute sets of submodules</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve">config.mod.<span class="hljs-attr"><span class="hljs-attr">one</span></span> = { <span class="hljs-attr"><span class="hljs-attr">foo</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attr"><span class="hljs-attr">bar</span></span> = <span class="hljs-string"><span class="hljs-string">"one"</span></span>; };
config.mod.<span class="hljs-attr"><span class="hljs-attr">two</span></span> = { <span class="hljs-attr"><span class="hljs-attr">foo</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attr"><span class="hljs-attr">bar</span></span> = <span class="hljs-string"><span class="hljs-string">"two"</span></span>; };</pre></div></div><br class="example-break" clear="none"><br></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-option-types-extending" class="title">50.2.5.&nbsp;Extending types<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-option-types-extending" aria-label="Anchor link for: sec option types extending" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   Types are mainly characterized by their <code class="literal">check</code> and
   <code class="literal">merge</code> functions.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <code class="varname">check</code>
    </span></dt><dd><p>
      The function to type check the value. Takes a value as parameter and
      return a boolean. It is possible to extend a type check with the
      <code class="literal">addCheck</code> function
      (<a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-extending-type-check-1" title="Example 50.12. Adding a type check" shape="rect">Example&nbsp;50.12, “Adding a type check”</a>), or to fully
      override the check function
      (<a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-extending-type-check-2" title="Example 50.13. Overriding a type check" shape="rect">Example&nbsp;50.13, “Overriding a type check”</a>).
     </p><div class="example"><a id="ex-extending-type-check-1" shape="rect"></a><p class="title"><strong>Example&nbsp;50.12.&nbsp;Adding a type check</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve"><span class="hljs-attr"><span class="hljs-attr">byte</span></span> = mkOption {
  <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">"An integer between 0 and 255."</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">type</span></span> = types.addCheck types.int (x: x &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; x &lt;= <span class="hljs-number"><span class="hljs-number">255</span></span>);
};</pre></div></div><br class="example-break" clear="none"><br><div class="example"><a id="ex-extending-type-check-2" shape="rect"></a><p class="title"><strong>Example&nbsp;50.13.&nbsp;Overriding a type check</strong></p><div class="example-contents"><pre class="screen hljs nix" xml:space="preserve"><span class="hljs-attr"><span class="hljs-attr">nixThings</span></span> = mkOption {
  <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">"words that start with 'nix'"</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">type</span></span> = types.str // {
    <span class="hljs-attr"><span class="hljs-attr">check</span></span> = (x: lib.hasPrefix <span class="hljs-string"><span class="hljs-string">"nix"</span></span> x)
  };
};</pre></div></div><br class="example-break" clear="none"><br></dd><dt><span class="term">
     <code class="varname">merge</code>
    </span></dt><dd><p>
      Function to merge the options values when multiple values are set. The
      function takes two parameters, <code class="literal">loc</code> the option path as
      a list of strings, and <code class="literal">defs</code> the list of defined values
      as a list. It is possible to override a type merge function for custom
      needs.
     </p></dd></dl></div></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-option-types-custom" class="title">50.2.6.&nbsp;Custom Types<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-option-types-custom" aria-label="Anchor link for: sec option types custom" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   Custom types can be created with the <code class="literal">mkOptionType</code>
   function. As type creation includes some more complex topics such as
   submodule handling, it is recommended to get familiar with
   <code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/lib/types.nix" target="_top" shape="rect">types.nix</a></code>
   code before creating a new type.
  </p><p>
   The only required parameter is <code class="literal">name</code>.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <code class="varname">name</code>
    </span></dt><dd><p>
      A string representation of the type function name.
     </p></dd><dt><span class="term">
     <code class="varname">definition</code>
    </span></dt><dd><p>
      Description of the type used in documentation. Give information of the
      type and any of its arguments.
     </p></dd><dt><span class="term">
     <code class="varname">check</code>
    </span></dt><dd><p>
      A function to type check the definition value. Takes the definition value
      as a parameter and returns a boolean indicating the type check result,
      <code class="literal">true</code> for success and <code class="literal">false</code> for
      failure.
     </p></dd><dt><span class="term">
     <code class="varname">merge</code>
    </span></dt><dd><p>
      A function to merge multiple definitions values. Takes two parameters:
     </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
        <em class="replaceable"><code>loc</code></em>
       </span></dt><dd><p>
         The option path as a list of strings, e.g. <code class="literal">["boot" "loader
         "grub" "enable"]</code>.
        </p></dd><dt><span class="term">
        <em class="replaceable"><code>defs</code></em>
       </span></dt><dd><p>
         The list of sets of defined <code class="literal">value</code> and
         <code class="literal">file</code> where the value was defined, e.g. <code class="literal">[ {
         file = "/foo.nix"; value = 1; } { file = "/bar.nix"; value = 2 }
         ]</code>. The <code class="literal">merge</code> function should return the
         merged value or throw an error in case the values are impossible or
         not meant to be merged.
        </p></dd></dl></div></dd><dt><span class="term">
     <code class="varname">getSubOptions</code>
    </span></dt><dd><p>
      For composed types that can take a submodule as type parameter, this
      function generate sub-options documentation. It takes the current option
      prefix as a list and return the set of sub-options. Usually defined in a
      recursive manner by adding a term to the prefix, e.g. <code class="literal">prefix:
      elemType.getSubOptions (prefix ++
      [<em class="replaceable"><code>"prefix"</code></em>])</code> where
      <em class="replaceable"><code>"prefix"</code></em> is the newly added prefix.
     </p></dd><dt><span class="term">
     <code class="varname">getSubModules</code>
    </span></dt><dd><p>
      For composed types that can take a submodule as type parameter, this
      function should return the type parameters submodules. If the type
      parameter is called <code class="literal">elemType</code>, the function should just
      recursively look into submodules by returning
      <code class="literal">elemType.getSubModules;</code>.
     </p></dd><dt><span class="term">
     <code class="varname">substSubModules</code>
    </span></dt><dd><p>
      For composed types that can take a submodule as type parameter, this
      function can be used to substitute the parameter of a submodule type. It
      takes a module as parameter and return the type with the submodule
      options substituted. It is usually defined as a type function call with a
      recursive call to <code class="literal">substSubModules</code>, e.g for a type
      <code class="literal">composedType</code> that take an <code class="literal">elemtype</code>
      type parameter, this function should be defined as <code class="literal">m:
      composedType (elemType.substSubModules m)</code>.
     </p></dd><dt><span class="term">
     <code class="varname">typeMerge</code>
    </span></dt><dd><p>
      A function to merge multiple type declarations. Takes the type to merge
      <code class="literal">functor</code> as parameter. A <code class="literal">null</code> return
      value means that type cannot be merged.
     </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
        <em class="replaceable"><code>f</code></em>
       </span></dt><dd><p>
         The type to merge <code class="literal">functor</code>.
        </p></dd></dl></div><p>
      Note: There is a generic <code class="literal">defaultTypeMerge</code> that work
      with most of value and composed types.
     </p></dd><dt><span class="term">
     <code class="varname">functor</code>
    </span></dt><dd><p>
      An attribute set representing the type. It is used for type operations
      and has the following keys:
     </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
        <code class="varname">type</code>
       </span></dt><dd><p>
         The type function.
        </p></dd><dt><span class="term">
        <code class="varname">wrapped</code>
       </span></dt><dd><p>
         Holds the type parameter for composed types.
        </p></dd><dt><span class="term">
        <code class="varname">payload</code>
       </span></dt><dd><p>
         Holds the value parameter for value types. The types that have a
         <code class="literal">payload</code> are the <code class="literal">enum</code>,
         <code class="literal">separatedString</code> and <code class="literal">submodule</code>
         types.
        </p></dd><dt><span class="term">
        <code class="varname">binOp</code>
       </span></dt><dd><p>
         A binary operation that can merge the payloads of two same types.
         Defined as a function that take two payloads as parameters and return
         the payloads merged.
        </p></dd></dl></div></dd></dl></div></section></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-option-definitions" class="title" style="clear: both">50.3.&nbsp;Option Definitions<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-option-definitions" aria-label="Anchor link for: sec option definitions" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Option definitions are generally straight-forward bindings of values to
  option names, like
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-attr"><span class="hljs-attr">config</span></span> = {
  services.httpd.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
};
</pre><p>
  However, sometimes you need to wrap an option definition or set of option
  definitions in a <span class="emphasis"><em>property</em></span> to achieve certain effects:
 </p><div class="simplesect"><div class="titlepage"><div><div><h3 id="sec-option-definitions-delaying-conditionals" class="title">Delaying Conditionals<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-option-definitions-delaying-conditionals" aria-label="Anchor link for: sec option definitions delaying conditionals" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   If a set of option definitions is conditional on the value of another
   option, you may need to use <code class="varname">mkIf</code>. Consider, for instance:
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-attr"><span class="hljs-attr">config</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> config.services.httpd.enable <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> {
  environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span> = [ <em class="replaceable"><code>...</code></em> ];
  <em class="replaceable"><code>...</code></em>
} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {};
</pre><p>
   This definition will cause Nix to fail with an “infinite recursion”
   error. Why? Because the value of
   <code class="option">config.services.httpd.enable</code> depends on the value being
   constructed here. After all, you could also write the clearly circular and
   contradictory:
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-attr"><span class="hljs-attr">config</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> config.services.httpd.enable <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> {
  services.httpd.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
  services.httpd.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
};
</pre><p>
   The solution is to write:
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-attr"><span class="hljs-attr">config</span></span> = mkIf config.services.httpd.enable {
  environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span> = [ <em class="replaceable"><code>...</code></em> ];
  <em class="replaceable"><code>...</code></em>
};
</pre><p>
   The special function <code class="varname">mkIf</code> causes the evaluation of the
   conditional to be “pushed down” into the individual definitions, as if
   you had written:
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-attr"><span class="hljs-attr">config</span></span> = {
  environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> config.services.httpd.enable <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> [ <em class="replaceable"><code>...</code></em> ] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> [];
  <em class="replaceable"><code>...</code></em>
};
</pre><p>
  </p></div><div class="simplesect"><div class="titlepage"><div><div><h3 id="sec-option-definitions-setting-priorities" class="title">Setting Priorities<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-option-definitions-setting-priorities" aria-label="Anchor link for: sec option definitions setting priorities" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   A module can override the definitions of an option in other modules by
   setting a <span class="emphasis"><em>priority</em></span>. All option definitions that do not
   have the lowest priority value are discarded. By default, option definitions
   have priority 1000. You can specify an explicit priority by using
   <code class="varname">mkOverride</code>, e.g.
</p><pre class="programlisting hljs nix" xml:space="preserve">services.openssh.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = mkOverride <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
</pre><p>
   This definition causes all other definitions with priorities above 10 to be
   discarded. The function <code class="varname">mkForce</code> is equal to
   <code class="varname">mkOverride 50</code>.
  </p></div><div class="simplesect"><div class="titlepage"><div><div><h3 id="sec-option-definitions-merging" class="title">Merging Configurations<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-option-definitions-merging" aria-label="Anchor link for: sec option definitions merging" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   In conjunction with <code class="literal">mkIf</code>, it is sometimes useful for a
   module to return multiple sets of option definitions, to be merged together
   as if they were declared in separate modules. This can be done using
   <code class="varname">mkMerge</code>:
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-attr"><span class="hljs-attr">config</span></span> = mkMerge
  [ <span class="hljs-comment"><span class="hljs-comment"># Unconditional stuff.</span></span>
    { environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span> = [ <em class="replaceable"><code>...</code></em> ];
    }
    <span class="hljs-comment"><span class="hljs-comment"># Conditional stuff.</span></span>
    (mkIf config.services.bla.enable {
      environment.<span class="hljs-attr"><span class="hljs-attr">systemPackages</span></span> = [ <em class="replaceable"><code>...</code></em> ];
    })
  ];
</pre><p>
  </p></div></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-assertions" class="title" style="clear: both">50.4.&nbsp;Warnings and Assertions<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-assertions" aria-label="Anchor link for: sec assertions" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  When configuration problems are detectable in a module, it is a good idea to
  write an assertion or warning. Doing so provides clear feedback to the user
  and prevents errors after the build.
 </p><p>
  Although Nix has the <code class="literal">abort</code> and
  <code class="literal">builtins.trace</code>
  <a class="link" href="https://nixos.org/nix/manual/#ssec-builtins" target="_top" shape="rect">functions</a>
  to perform such tasks, they are not ideally suited for NixOS modules. Instead
  of these functions, you can declare your warnings and assertions using the
  NixOS module system.
 </p><section class="section"><div class="titlepage"><div><div><h3 id="sec-assertions-warnings" class="title">50.4.1.&nbsp;Warnings<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-assertions-warnings" aria-label="Anchor link for: sec assertions warnings" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   This is an example of using <code class="literal">warnings</code>.
  </p><pre class="programlisting hljs nix" xml:space="preserve">
{ config, lib, ... }:
{
  <span class="hljs-attr"><span class="hljs-attr">config</span></span> = lib.mkIf config.services.foo.enable {
    <span class="hljs-attr"><span class="hljs-attr">warnings</span></span> =
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> config.services.foo.bar
      <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> [ <span class="hljs-string"><span class="hljs-string">''You have enabled the bar feature of the foo service.
               This is known to cause some specific problems in certain situations.
               ''</span></span> ]
      <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> [];
  }
}

</pre></section><section class="section"><div class="titlepage"><div><div><h3 id="sec-assertions-assertions" class="title">50.4.2.&nbsp;Assertions<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-assertions-assertions" aria-label="Anchor link for: sec assertions assertions" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
   This example, extracted from the
   <a class="link" href="https://github.com/NixOS/nixpkgs/blob/release-17.09/nixos/modules/services/logging/syslogd.nix" target="_top" shape="rect">
   <code class="literal">syslogd</code> module </a> shows how to use
   <code class="literal">assertions</code>. Since there can only be one active syslog
   daemon at a time, an assertion is useful to prevent such a broken system
   from being built.
  </p><pre class="programlisting hljs nix" xml:space="preserve">
{ config, lib, ... }:
{
  <span class="hljs-attr"><span class="hljs-attr">config</span></span> = lib.mkIf config.services.syslogd.enable {
    <span class="hljs-attr"><span class="hljs-attr">assertions</span></span> =
      [ { <span class="hljs-attr"><span class="hljs-attr">assertion</span></span> = !config.services.rsyslogd.enable;
          <span class="hljs-attr"><span class="hljs-attr">message</span></span> = <span class="hljs-string"><span class="hljs-string">"rsyslogd conflicts with syslogd"</span></span>;
        }
      ];
  }
}

</pre></section></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-meta-attributes" class="title" style="clear: both">50.5.&nbsp;Meta Attributes<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-meta-attributes" aria-label="Anchor link for: sec meta attributes" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Like Nix packages, NixOS modules can declare meta-attributes to provide extra
  information. Module meta attributes are defined in the
  <code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/misc/meta.nix" target="_top" shape="rect">meta.nix</a></code>
  special module.
 </p><p>
  <code class="literal">meta</code> is a top level attribute like
  <code class="literal">options</code> and <code class="literal">config</code>. Available
  meta-attributes are <code class="literal">maintainers</code> and
  <code class="literal">doc</code>.
 </p><p>
  Each of the meta-attributes must be defined at most once per module file.
 </p><pre class="programlisting hljs nix" xml:space="preserve">{ config, lib, pkgs, ... }:
{
  <span class="hljs-attr"><span class="hljs-attr">options</span></span> = {
    ...
  };

  <span class="hljs-attr"><span class="hljs-attr">config</span></span> = {
    ...
  };

  <span class="hljs-attr"><span class="hljs-attr">meta</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">maintainers</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> lib.maintainers; [ ericsagnes ]; <a id="modules-meta-1" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/1.svg" alt="1" border="0"></span>
    <span class="hljs-attr"><span class="hljs-attr">doc</span></span> = ./default.xml; <a id="modules-meta-2" shape="rect"></a><span><img src="./NixOS-Manual-Version-20.09_files/2.svg" alt="2" border="0"></span>
  };
}
</pre><div class="calloutlist"><table class="table table-striped" border="0" summary="Callout list"><tbody><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#modules-meta-1" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/1.svg" alt="1" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
    <code class="varname">maintainers</code> contains a list of the module maintainers.
   </p></td></tr><tr><td width="5%" valign="top" align="left" rowspan="1" colspan="1"><p><a href="https://nixos.org/manual/nixos/stable/#modules-meta-2" shape="rect"><span><img src="./NixOS-Manual-Version-20.09_files/2.svg" alt="2" border="0"></span></a> </p></td><td valign="top" align="left" rowspan="1" colspan="1"><p>
    <code class="varname">doc</code> points to a valid DocBook file containing the module
    documentation. Its contents is automatically added to
    <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ch-configuration" title="Part II. Configuration" shape="rect">Part&nbsp;II, “Configuration”</a>. Changes to a module documentation
    have to be checked to not break building the NixOS manual:
   </p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-build nixos/release.nix -A manual</pre></td></tr></tbody></table></div></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-importing-modules" class="title" style="clear: both">50.6.&nbsp;Importing Modules<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-importing-modules" aria-label="Anchor link for: sec importing modules" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Sometimes NixOS modules need to be used in configuration but exist outside of
  Nixpkgs. These modules can be imported:
 </p><pre class="programlisting hljs nix" xml:space="preserve">{ config, lib, pkgs, ... }:

{
  <span class="hljs-attr"><span class="hljs-attr">imports</span></span> =
    [ <span class="hljs-comment"><span class="hljs-comment"># Use a locally-available module definition in</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># ./example-module/default.nix</span></span>
        ./example-module
    ];

  services.exampleModule.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
}
</pre><p>
  The environment variable <code class="literal">NIXOS_EXTRA_MODULE_PATH</code> is an
  absolute path to a NixOS module that is included alongside the Nixpkgs NixOS
  modules. Like any NixOS module, this module can import additional modules:
 </p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-comment"><span class="hljs-comment"># ./module-list/default.nix</span></span>
[
  ./example-module1
  ./example-module2
]
</pre><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-comment"><span class="hljs-comment"># ./extra-module/default.nix</span></span>
{ <span class="hljs-attr"><span class="hljs-attr">imports</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">import</span></span> ./module-list.nix; }
</pre><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-comment"><span class="hljs-comment"># NIXOS_EXTRA_MODULE_PATH=/absolute/path/to/extra-module</span></span>
{ config, lib, pkgs, ... }:

{
  <span class="hljs-comment"><span class="hljs-comment"># No `imports` needed</span></span>

  services.exampleModule1.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
}
</pre></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-replace-modules" class="title" style="clear: both">50.7.&nbsp;Replace Modules<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-replace-modules" aria-label="Anchor link for: sec replace modules" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Modules that are imported can also be disabled. The option declarations,
  config implementation and the imports of a disabled module will be ignored, allowing another
  to take it's place. This can be used to import a set of modules from another
  channel while keeping the rest of the system on a stable release.
 </p><p>
  <code class="literal">disabledModules</code> is a top level attribute like
  <code class="literal">imports</code>, <code class="literal">options</code> and
  <code class="literal">config</code>. It contains a list of modules that will be
  disabled. This can either be the full path to the module or a string with the
  filename relative to the modules path (eg. &lt;nixpkgs/nixos/modules&gt; for
  nixos).
 </p><p>
  This example will replace the existing postgresql module with the version
  defined in the nixos-unstable channel while keeping the rest of the modules
  and packages from the original nixos channel. This only overrides the module
  definition, this won't use postgresql from nixos-unstable unless explicitly
  configured to do so.
 </p><pre class="programlisting hljs nix" xml:space="preserve">{ config, lib, pkgs, ... }:

{
  <span class="hljs-attr"><span class="hljs-attr">disabledModules</span></span> = [ <span class="hljs-string"><span class="hljs-string">"services/databases/postgresql.nix"</span></span> ];

  <span class="hljs-attr"><span class="hljs-attr">imports</span></span> =
    [ <span class="hljs-comment"><span class="hljs-comment"># Use postgresql service from nixos-unstable channel.</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># sudo nix-channel --add https://nixos.org/channels/nixos-unstable nixos-unstable</span></span>
      &lt;nixos-unstable/nixos/modules/services/databases/postgresql.nix&gt;
    ];

  services.postgresql.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
}
</pre><p>
  This example shows how to define a custom module as a replacement for an
  existing module. Importing this module will disable the original module
  without having to know it's implementation details.
 </p><pre class="programlisting hljs nix" xml:space="preserve">{ config, lib, pkgs, ... }:

<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> lib;

<span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
  <span class="hljs-attr"><span class="hljs-attr">cfg</span></span> = config.programs.man;
<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>

{
  <span class="hljs-attr"><span class="hljs-attr">disabledModules</span></span> = [ <span class="hljs-string"><span class="hljs-string">"services/programs/man.nix"</span></span> ];

  <span class="hljs-attr"><span class="hljs-attr">options</span></span> = {
    programs.man.<span class="hljs-attr"><span class="hljs-attr">enable</span></span> = mkOption {
      <span class="hljs-attr"><span class="hljs-attr">type</span></span> = types.bool;
      <span class="hljs-attr"><span class="hljs-attr">default</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">"Whether to enable manual pages."</span></span>;
    };
  };

  <span class="hljs-attr"><span class="hljs-attr">config</span></span> = mkIf cfg.enabled {
    <span class="hljs-attr"><span class="hljs-attr">warnings</span></span> = [ <span class="hljs-string"><span class="hljs-string">"disabled manpages for production deployments."</span></span> ];
  };
}
</pre></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-freeform-modules" class="title" style="clear: both">50.8.&nbsp;Freeform modules<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-freeform-modules" aria-label="Anchor link for: sec freeform modules" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Freeform modules allow you to define values for option paths that have not been declared explicitly. This can be used to add attribute-specific types to what would otherwise have to be <code class="literal">attrsOf</code> options in order to accept all attribute names.
 </p><p>
  This feature can be enabled by using the attribute <code class="literal">freeformType</code> to define a freeform type. By doing this, all assignments without an associated option will be merged using the freeform type and combined into the resulting <code class="literal">config</code> set. Since this feature nullifies name checking for entire option trees, it is only recommended for use in submodules.
 </p><div class="example"><a id="ex-freeform-module" shape="rect"></a><p class="title"><strong>Example&nbsp;50.14.&nbsp;Freeform submodule</strong></p><div class="example-contents"><p>
   The following shows a submodule assigning a freeform type that allows arbitrary attributes with <code class="literal">str</code> values below <code class="literal">settings</code>, but also declares an option for the <code class="literal">settings.port</code> attribute to have it type-checked and assign a default value. See <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#ex-settings-typed-attrs" title="Example 50.16. Declaring a type-checked settings attribute" shape="rect">Example&nbsp;50.16, “Declaring a type-checked <code class="literal">settings</code> attribute”</a> for a more complete example.
  </p><pre class="programlisting hljs nix" xml:space="preserve">{ lib, config, ... }: {

  options.<span class="hljs-attr"><span class="hljs-attr">settings</span></span> = lib.mkOption {
    <span class="hljs-attr"><span class="hljs-attr">type</span></span> = lib.types.submodule {

      <span class="hljs-attr"><span class="hljs-attr">freeformType</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> lib.types; attrsOf str;

      <span class="hljs-comment"><span class="hljs-comment"># We want this attribute to be checked for the correct type</span></span>
      options.<span class="hljs-attr"><span class="hljs-attr">port</span></span> = lib.mkOption {
        <span class="hljs-attr"><span class="hljs-attr">type</span></span> = lib.types.port;
        <span class="hljs-comment"><span class="hljs-comment"># Declaring the option also allows defining a default value</span></span>
        <span class="hljs-attr"><span class="hljs-attr">default</span></span> = <span class="hljs-number"><span class="hljs-number">8080</span></span>;
      };

    };
  };
}
 </pre><p>
  And the following shows what such a module then allows
 </p><pre class="programlisting hljs nix" xml:space="preserve">{
  <span class="hljs-comment"><span class="hljs-comment"># Not a declared option, but the freeform type allows this</span></span>
  settings.<span class="hljs-attr"><span class="hljs-attr">logLevel</span></span> = <span class="hljs-string"><span class="hljs-string">"debug"</span></span>;

  <span class="hljs-comment"><span class="hljs-comment"># Not allowed because the the freeform type only allows strings</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># settings.enable = true;</span></span>

  <span class="hljs-comment"><span class="hljs-comment"># Allowed because there is a port option declared</span></span>
  settings.<span class="hljs-attr"><span class="hljs-attr">port</span></span> = <span class="hljs-number"><span class="hljs-number">80</span></span>;

  <span class="hljs-comment"><span class="hljs-comment"># Not allowed because the port option doesn't allow strings</span></span>
  <span class="hljs-comment"><span class="hljs-comment"># settings.port = "443";</span></span>
}
 </pre></div></div><br class="example-break" clear="none"><br><div class="note"><h3 class="title" id="note-2">Note<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#note-2" aria-label="Anchor link for: note 2" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3><p>
   Freeform attributes cannot depend on other attributes of the same set without infinite recursion:
</p><pre class="programlisting hljs nix" xml:space="preserve">{
  <span class="hljs-comment"><span class="hljs-comment"># This throws infinite recursion encountered</span></span>
  settings.<span class="hljs-attr"><span class="hljs-attr">logLevel</span></span> = lib.mkIf (config.settings.<span class="hljs-attr"><span class="hljs-attr">port</span></span> == <span class="hljs-number"><span class="hljs-number">80</span></span>) <span class="hljs-string"><span class="hljs-string">"debug"</span></span>;
}
</pre><p>
   To prevent this, declare options for all attributes that need to depend on others. For above example this means to declare <code class="literal">logLevel</code> to be an option.
  </p></div></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-settings-options" class="title" style="clear: both">50.9.&nbsp;Options for Program Settings<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-settings-options" aria-label="Anchor link for: sec settings options" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Many programs have configuration files where program-specific settings can be declared. File formats can be separated into two categories:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
         Nix-representable ones: These can trivially be mapped to a subset of Nix syntax. E.g. JSON is an example, since its values like <code class="literal">{"foo":{"bar":10}}</code> can be mapped directly to Nix: <code class="literal">{ foo = { bar = 10; }; }</code>. Other examples are INI, YAML and TOML. The following section explains the convention for these settings.
       </p></li><li class="listitem"><p>
         Non-nix-representable ones: These can't be trivially mapped to a subset of Nix syntax. Most generic programming languages are in this group, e.g. bash, since the statement <code class="literal">if true; then echo hi; fi</code> doesn't have a trivial representation in Nix.
       </p><p>
         Currently there are no fixed conventions for these, but it is common to have a <code class="literal">configFile</code> option for setting the configuration file path directly. The default value of <code class="literal">configFile</code> can be an auto-generated file, with convenient options for controlling the contents. For example an option of type <code class="literal">attrsOf str</code> can be used for representing environment variables which generates a section like <code class="literal">export FOO="foo"</code>. Often it can also be useful to also include an <code class="literal">extraConfig</code> option of type <code class="literal">lines</code> to allow arbitrary text after the autogenerated part of the file.
       </p></li></ul></div><p>
 </p><section class="section"><div class="titlepage"><div><div><h3 id="sec-settings-nix-representable" class="title">50.9.1.&nbsp;Nix-representable Formats (JSON, YAML, TOML, INI, ...)<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-settings-nix-representable" aria-label="Anchor link for: sec settings nix representable" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><p>
     By convention, formats like this are handled with a generic <code class="literal">settings</code> option, representing the full program configuration as a Nix value. The type of this option should represent the format. The most common formats have a predefined type and string generator already declared under <code class="literal">pkgs.formats</code>:
     </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
           <code class="varname">pkgs.formats.json</code> { }
         </span></dt><dd><p>
             A function taking an empty attribute set (for future extensibility) and returning a set with JSON-specific attributes <code class="varname">type</code> and <code class="varname">generate</code> as specified <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#pkgs-formats-result" shape="rect">below</a>.
           </p></dd><dt><span class="term">
           <code class="varname">pkgs.formats.yaml</code> { }
         </span></dt><dd><p>
             A function taking an empty attribute set (for future extensibility) and returning a set with YAML-specific attributes <code class="varname">type</code> and <code class="varname">generate</code> as specified <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#pkgs-formats-result" shape="rect">below</a>.
           </p></dd><dt><span class="term">
           <code class="varname">pkgs.formats.ini</code> { <em class="replaceable"><code>listsAsDuplicateKeys</code></em> ? false, ... }
         </span></dt><dd><p>
             A function taking an attribute set with values
             </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
                   <code class="varname">listsAsDuplicateKeys</code>
                 </span></dt><dd><p>
                     A boolean for controlling whether list values can be used to represent duplicate INI keys
                   </p></dd></dl></div><p>
            It returns a set with INI-specific attributes <code class="varname">type</code> and <code class="varname">generate</code> as specified <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#pkgs-formats-result" shape="rect">below</a>.
           </p></dd><dt><span class="term">
           <code class="varname">pkgs.formats.toml</code> { }
         </span></dt><dd><p>
             A function taking an empty attribute set (for future extensibility) and returning a set with TOML-specific attributes <code class="varname">type</code> and <code class="varname">generate</code> as specified <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#pkgs-formats-result" shape="rect">below</a>.
           </p></dd></dl></div><p>

   </p><p><a id="pkgs-formats-result" shape="rect"></a>
     These functions all return an attribute set with these values:
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
          <code class="varname">type</code>
        </span></dt><dd><p>
            A module system type representing a value of the format
          </p></dd><dt><span class="term">
          <code class="varname">generate</code> <em class="replaceable"><code>filename</code></em> <em class="replaceable"><code>jsonValue</code></em>
        </span></dt><dd><p>
           A function that can render a value of the format to a file. Returns a file path.
           </p><div class="alert alert-info"><strong>Note:</strong> 
             This function puts the value contents in the Nix store. So this should be avoided for secrets.
            </div><p>
          </p></dd></dl></div><p>
   </p><div class="example"><a id="ex-settings-nix-representable" shape="rect"></a><p class="title"><strong>Example&nbsp;50.15.&nbsp;Module with conventional <code class="literal">settings</code> option</strong></p><div class="example-contents"><p>
       The following shows a module for an example program that uses a JSON configuration file. It demonstrates how above values can be used, along with some other related best practices. See the comments for explanations.
     </p><pre class="programlisting hljs nix" xml:space="preserve">{ options, config, lib, pkgs, ... }:
<span class="hljs-keyword"><span class="hljs-keyword">let</span></span>
  <span class="hljs-attr"><span class="hljs-attr">cfg</span></span> = config.services.foo;
  <span class="hljs-comment"><span class="hljs-comment"># Define the settings format used for this program</span></span>
  <span class="hljs-attr"><span class="hljs-attr">settingsFormat</span></span> = pkgs.formats.json {};
<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {

  options.services.<span class="hljs-attr"><span class="hljs-attr">foo</span></span> = {
    <span class="hljs-attr"><span class="hljs-attr">enable</span></span> = lib.mkEnableOption <span class="hljs-string"><span class="hljs-string">"foo service"</span></span>;

    <span class="hljs-attr"><span class="hljs-attr">settings</span></span> = lib.mkOption {
      <span class="hljs-comment"><span class="hljs-comment"># Setting this type allows for correct merging behavior</span></span>
      <span class="hljs-attr"><span class="hljs-attr">type</span></span> = settingsFormat.type;
      <span class="hljs-attr"><span class="hljs-attr">default</span></span> = {};
      <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">''
        Configuration for foo, see
        &lt;link xlink:href="https://example.com/docs/foo"/&gt;
        for supported settings.
      ''</span></span>;
    };
  };

  <span class="hljs-attr"><span class="hljs-attr">config</span></span> = lib.mkIf cfg.enable {
    <span class="hljs-comment"><span class="hljs-comment"># We can assign some default settings here to make the service work by just</span></span>
    <span class="hljs-comment"><span class="hljs-comment"># enabling it. We use `mkDefault` for values that can be changed without</span></span>
    <span class="hljs-comment"><span class="hljs-comment"># problems</span></span>
    services.foo.<span class="hljs-attr"><span class="hljs-attr">settings</span></span> = {
      <span class="hljs-comment"><span class="hljs-comment"># Fails at runtime without any value set</span></span>
      <span class="hljs-attr"><span class="hljs-attr">log_level</span></span> = lib.mkDefault <span class="hljs-string"><span class="hljs-string">"WARN"</span></span>;

      <span class="hljs-comment"><span class="hljs-comment"># We assume systemd's `StateDirectory` is used, so we require this value,</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># therefore no mkDefault</span></span>
      <span class="hljs-attr"><span class="hljs-attr">data_path</span></span> = <span class="hljs-string"><span class="hljs-string">"/var/lib/foo"</span></span>;

      <span class="hljs-comment"><span class="hljs-comment"># Since we use this to create a user we need to know the default value at</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># eval time</span></span>
      <span class="hljs-attr"><span class="hljs-attr">user</span></span> = lib.mkDefault <span class="hljs-string"><span class="hljs-string">"foo"</span></span>;
    };

    environment.etc.<span class="hljs-string"><span class="hljs-string">"foo.json"</span></span>.<span class="hljs-attr"><span class="hljs-attr">source</span></span> =
      <span class="hljs-comment"><span class="hljs-comment"># The formats generator function takes a filename and the Nix value</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># representing the format value and produces a filepath with that value</span></span>
      <span class="hljs-comment"><span class="hljs-comment"># rendered in the format</span></span>
      settingsFormat.generate <span class="hljs-string"><span class="hljs-string">"foo-config.json"</span></span> cfg.settings;

    <span class="hljs-comment"><span class="hljs-comment"># We know that the `user` attribute exists because we set a default value</span></span>
    <span class="hljs-comment"><span class="hljs-comment"># for it above, allowing us to use it without worries here</span></span>
    users.users.${cfg.settings.user} = {};

    <span class="hljs-comment"><span class="hljs-comment"># ...</span></span>
  };
}
</pre></div></div><br class="example-break" clear="none"><br><section class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sec-settings-attrs-options" shape="rect"></a>50.9.1.1.&nbsp;Option declarations for attributes</h4></div></div></div><p>
     Some <code class="literal">settings</code> attributes may deserve some extra care. They may need a different type, default or merging behavior, or they are essential options that should show their documentation in the manual. This can be done using <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-freeform-modules" title="50.8. Freeform modules" shape="rect">Section&nbsp;50.8, “Freeform modules”</a>.
     </p><div class="example"><a id="ex-settings-typed-attrs" shape="rect"></a><p class="title"><strong>Example&nbsp;50.16.&nbsp;Declaring a type-checked <code class="literal">settings</code> attribute</strong></p><div class="example-contents"><p>
       We extend above example using freeform modules to declare an option for the port, which will enforce it to be a valid integer and make it show up in the manual.
      </p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-attr"><span class="hljs-attr">settings</span></span> = lib.mkOption {
  <span class="hljs-attr"><span class="hljs-attr">type</span></span> = lib.types.submodule {

    <span class="hljs-attr"><span class="hljs-attr">freeformType</span></span> = settingsFormat.type;

    <span class="hljs-comment"><span class="hljs-comment"># Declare an option for the port such that the type is checked and this option</span></span>
    <span class="hljs-comment"><span class="hljs-comment"># is shown in the manual.</span></span>
    options.<span class="hljs-attr"><span class="hljs-attr">port</span></span> = lib.mkOption {
      <span class="hljs-attr"><span class="hljs-attr">type</span></span> = lib.types.port;
      <span class="hljs-attr"><span class="hljs-attr">default</span></span> = <span class="hljs-number"><span class="hljs-number">8080</span></span>;
      <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">''
        Which port this service should listen on.
      ''</span></span>;
    };

  };
  <span class="hljs-attr"><span class="hljs-attr">default</span></span> = {};
  <span class="hljs-attr"><span class="hljs-attr">description</span></span> = <span class="hljs-string"><span class="hljs-string">''
    Configuration for Foo, see
    &lt;link xlink:href="https://example.com/docs/foo"/&gt;
    for supported values.
  ''</span></span>;
};
</pre></div></div><p><br class="example-break" clear="none"><br>
    </p></section></section></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-building-parts" class="title">Chapter&nbsp;51.&nbsp;Building Specific Parts of NixOS<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-building-parts" aria-label="Anchor link for: sec building parts" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  With the command <span class="command"><strong>nix-build</strong></span>, you can build specific parts
  of your NixOS configuration. This is done as follows:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <em class="replaceable"><code>/path/to/nixpkgs/nixos</code></em>
<code class="prompt">$ </code>nix-build -A config.<em class="replaceable"><code>option</code></em></pre><p>
  where <em class="replaceable"><code>option</code></em> is a NixOS option with type
  “derivation” (i.e. something that can be built). Attributes of interest
  include:
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <code class="varname">system.build.toplevel</code>
    </span></dt><dd><p>
      The top-level option that builds the entire NixOS system. Everything else
      in your configuration is indirectly pulled in by this option. This is
      what <span class="command"><strong>nixos-rebuild</strong></span> builds and what
      <code class="filename">/run/current-system</code> points to afterwards.
     </p><p>
      A shortcut to build this is:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-build -A system</pre><p>
     </p></dd><dt><span class="term">
     <code class="varname">system.build.manual.manualHTML</code>
    </span></dt><dd><p>
      The NixOS manual.
     </p></dd><dt><span class="term">
     <code class="varname">system.build.etc</code>
    </span></dt><dd><p>
      A tree of symlinks that form the static parts of
      <code class="filename">/etc</code>.
     </p></dd><dt><span class="term">
     <code class="varname">system.build.initialRamdisk</code>
    , </span><span class="term">
     <code class="varname">system.build.kernel</code>
    </span></dt><dd><p>
      The initial ramdisk and kernel of the system. This allows a quick way to
      test whether the kernel and the initial ramdisk boot correctly, by using
      QEMU’s <code class="option">-kernel</code> and <code class="option">-initrd</code> options:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>nix-build -A config.system.build.initialRamdisk -o initrd
<code class="prompt">$ </code>nix-build -A config.system.build.kernel -o kernel
<code class="prompt">$ </code>qemu-system-x86_64 -kernel ./kernel/bzImage -initrd ./initrd/initrd -hda /dev/<span class="hljs-literal"><span class="hljs-literal">null</span></span>
</pre><p>
     </p></dd><dt><span class="term">
     <code class="varname">system.build.nixos-rebuild</code>
    , </span><span class="term">
     <code class="varname">system.build.nixos-install</code>
    , </span><span class="term">
     <code class="varname">system.build.nixos-generate-config</code>
    </span></dt><dd><p>
      These build the corresponding NixOS commands.
     </p></dd><dt><span class="term">
     <code class="varname">systemd.units.<em class="replaceable"><code>unit-name</code></em>.unit</code>
    </span></dt><dd><p>
      This builds the unit with the specified name. Note that since unit names
      contain dots (e.g. <code class="literal">httpd.service</code>), you need to put
      them between quotes, like this:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>nix-build -A 'config.systemd.units.<span class="hljs-string"><span class="hljs-string">"httpd.service"</span></span>.unit'
</pre><p>
      You can also test individual units, without rebuilding the whole system,
      by putting them in <code class="filename">/run/systemd/system</code>:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt">$ </code>cp $(nix-build -A 'config.systemd.units.<span class="hljs-string"><span class="hljs-string">"httpd.service"</span></span>.unit')/httpd.service \
    /run/systemd/system/tmp-httpd.service
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">systemctl daemon-reload</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">systemctl start tmp-httpd.service</span></span>
</pre><p>
      Note that the unit must not have the same name as any unit in
      <code class="filename">/etc/systemd/system</code> since those take precedence over
      <code class="filename">/run/systemd/system</code>. That’s why the unit is
      installed as <code class="filename">tmp-httpd.service</code> here.
     </p></dd></dl></div><p>
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-writing-documentation" class="title">Chapter&nbsp;52.&nbsp;Writing NixOS Documentation<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-writing-documentation" aria-label="Anchor link for: sec writing documentation" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-writing-docs-building-the-manual" shape="rect">52.1. Building the Manual</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-writing-docs-editing-docbook-xml" shape="rect">52.2. Editing DocBook XML</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-writing-docs-creating-a-topic" shape="rect">52.3. Creating a Topic</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-writing-docs-adding-a-topic" shape="rect">52.4. Adding a Topic to the Book</a></span></dt></dl></div><p>
  As NixOS grows, so too does the need for a catalogue and explanation of its
  extensive functionality. Collecting pertinent information from disparate
  sources and presenting it in an accessible style would be a worthy
  contribution to the project.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="sec-writing-docs-building-the-manual" class="title" style="clear: both">52.1.&nbsp;Building the Manual<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-writing-docs-building-the-manual" aria-label="Anchor link for: sec writing docs building the manual" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   The DocBook sources of the <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html" title="NixOS Manual" shape="rect">NixOS Manual</a> are in the
   <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/doc/manual" target="_top" shape="rect"><code class="filename">nixos/doc/manual</code></a>
   subdirectory of the Nixpkgs repository.
  </p><p>
   You can quickly validate your edits with <span class="command"><strong>make</strong></span>:
  </p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/nixpkgs/nixos/doc/manual
<code class="prompt">$ </code>make
</pre><p>
   Once you are done making modifications to the manual, it's important to
   build it before committing. You can do that as follows:
  </p><pre class="screen hljs" xml:space="preserve">nix-build nixos/release.nix -A manual.x86_64-linux</pre><p>
   When this command successfully finishes, it will tell you where the manual
   got generated. The HTML will be accessible through the
   <code class="filename">result</code> symlink at
   <code class="filename">./result/share/doc/nixos/index.html</code>.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-writing-docs-editing-docbook-xml" class="title" style="clear: both">52.2.&nbsp;Editing DocBook XML<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-writing-docs-editing-docbook-xml" aria-label="Anchor link for: sec writing docs editing docbook xml" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   For general information on how to write in DocBook, see
   <a class="link" href="http://www.docbook.org/tdg5/en/html/docbook.html" target="_top" shape="rect"> DocBook
   5: The Definitive Guide</a>.
  </p><p>
   Emacs nXML Mode is very helpful for editing DocBook XML because it validates
   the document as you write, and precisely locates errors. To use it, see
   <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-emacs-docbook-xml" title="28.3.3. Editing DocBook 5 XML Documents" shape="rect">Section&nbsp;28.3.3, “Editing DocBook 5 XML Documents”</a>.
  </p><p>
   <a class="link" href="http://pandoc.org/" target="_top" shape="rect">Pandoc</a> can generate DocBook XML
   from a multitude of formats, which makes a good starting point.
   </p><div class="example"><a id="ex-pandoc-xml-conv" shape="rect"></a><p class="title"><strong>Example&nbsp;52.1.&nbsp;Pandoc invocation to convert GitHub-Flavoured MarkDown to DocBook 5 XML</strong></p><div class="example-contents"><pre class="screen hljs" xml:space="preserve">pandoc -f markdown_github -t docbook5 docs.md -o my-section.md</pre></div></div><p><br class="example-break" clear="none"><br>
   Pandoc can also quickly convert a single <code class="filename">section.xml</code> to
   HTML, which is helpful when drafting.
  </p><p>
   Sometimes writing valid DocBook is simply too difficult. In this case,
   submit your documentation updates in a
   <a class="link" href="https://github.com/NixOS/nixpkgs/issues/new" target="_top" shape="rect">GitHub
   Issue</a> and someone will handle the conversion to XML for you.
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-writing-docs-creating-a-topic" class="title" style="clear: both">52.3.&nbsp;Creating a Topic<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-writing-docs-creating-a-topic" aria-label="Anchor link for: sec writing docs creating a topic" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   You can use an existing topic as a basis for the new topic or create a topic
   from scratch.
  </p><p>
   Keep the following guidelines in mind when you create and add a topic:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      The NixOS
      <a class="link" href="http://www.docbook.org/tdg5/en/html/book.html" target="_top" shape="rect"><code class="sgmltag-element">book</code></a>
      element is in <code class="filename">nixos/doc/manual/manual.xml</code>. It
      includes several
      <a class="link" href="http://www.docbook.org/tdg5/en/html/book.html" target="_top" shape="rect"><code class="sgmltag-element">part</code>s</a>
      which are in subdirectories.
     </p></li><li class="listitem"><p>
      Store the topic file in the same directory as the <code class="sgmltag-element">part</code> to
      which it belongs. If your topic is about configuring a NixOS module, then
      the XML file can be stored alongside the module definition
      <code class="filename">nix</code> file.
     </p></li><li class="listitem"><p>
      If you include multiple words in the file name, separate the words with a
      dash. For example: <code class="filename">ipv6-config.xml</code>.
     </p></li><li class="listitem"><p>
      Make sure that the <code class="sgmltag-element">xml:id</code> value is unique. You can use
      abbreviations if the ID is too long. For example:
      <code class="varname">nixos-config</code>.
     </p></li><li class="listitem"><p>
      Determine whether your topic is a chapter or a section. If you are
      unsure, open an existing topic file and check whether the main element is
      chapter or section.
     </p></li></ul></div><p>
  </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-writing-docs-adding-a-topic" class="title" style="clear: both">52.4.&nbsp;Adding a Topic to the Book<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-writing-docs-adding-a-topic" aria-label="Anchor link for: sec writing docs adding a topic" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Open the parent XML file and add an <code class="varname">xi:include</code> element to
   the list of chapters with the file name of the topic that you created. If
   you created a <code class="sgmltag-element">section</code>, you add the file to the <code class="sgmltag-element">chapter</code>
   file. If you created a <code class="sgmltag-element">chapter</code>, you add the file to the
   <code class="sgmltag-element">part</code> file.
  </p><p>
   If the topic is about configuring a NixOS module, it can be automatically
   included in the manual by using the <code class="varname">meta.doc</code> attribute.
   See <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-meta-attributes" title="50.5. Meta Attributes" shape="rect">Section&nbsp;50.5, “Meta Attributes”</a> for an explanation.
  </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-building-cd" class="title">Chapter&nbsp;53.&nbsp;Building Your Own NixOS CD<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-building-cd" aria-label="Anchor link for: sec building cd" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Building a NixOS CD is as easy as configuring your own computer. The idea is
  to use another module which will replace your
  <code class="filename">configuration.nix</code> to configure the system that would be
  installed on the CD.
 </p><p>
  Default CD/DVD configurations are available inside
  <code class="filename">nixos/modules/installer/cd-dvd</code>.
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/NixOS/nixpkgs.git
<code class="prompt">$ </code><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nixpkgs/nixos
<code class="prompt">$ </code>nix-build -A config.system.build.isoImage -I nixos-config=modules/installer/<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>-dvd/installation-cd-minimal.nix default.nix</pre><p>
 </p><p>
  Before burning your CD/DVD, you can check the content of the image by
  mounting anywhere like suggested by the following command:
</p><pre class="screen hljs nix" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mount -o loop -t iso9660 ./result/iso/cd.iso /mnt/iso</span></span></pre><p>
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="sec-nixos-tests" class="title">Chapter&nbsp;54.&nbsp;NixOS Tests<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-nixos-tests" aria-label="Anchor link for: sec nixos tests" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-writing-nixos-tests" shape="rect">54.1. Writing Tests</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-running-nixos-tests" shape="rect">54.2. Running Tests</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#sec-running-nixos-tests-interactively" shape="rect">54.3. Running Tests interactively</a></span></dt></dl></div><p>
  When you add some feature to NixOS, you should write a test for it. NixOS
  tests are kept in the directory
  <code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/tests" target="_top" shape="rect">nixos/tests</a></code>,
  and are executed (using Nix) by a testing framework that automatically starts
  one or more virtual machines containing the NixOS system(s) required for the
  test.
 </p><section class="section"><div class="titlepage"><div><div><h2 id="sec-writing-nixos-tests" class="title" style="clear: both">54.1.&nbsp;Writing Tests<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-writing-nixos-tests" aria-label="Anchor link for: sec writing nixos tests" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  A NixOS test is a Nix expression that has the following structure:
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-built_in"><span class="hljs-built_in">import</span></span> ./make-test-python.nix {

  <span class="hljs-comment"><span class="hljs-comment"># Either the configuration of a single machine:</span></span>
  <span class="hljs-attr"><span class="hljs-attr">machine</span></span> =
    { config, pkgs, ... }:
    { <em class="replaceable"><code>configuration…</code></em>
    };

  <span class="hljs-comment"><span class="hljs-comment"># Or a set of machines:</span></span>
  <span class="hljs-attr"><span class="hljs-attr">nodes</span></span> =
    { <em class="replaceable"><code><span class="hljs-attr"><span class="hljs-attr">machine1</span></span></code></em> =
        { config, pkgs, ... }: { <em class="replaceable"><code>…</code></em> };
      <em class="replaceable"><code><span class="hljs-attr"><span class="hljs-attr">machine2</span></span></code></em> =
        { config, pkgs, ... }: { <em class="replaceable"><code>…</code></em> };
      …
    };

  <span class="hljs-attr"><span class="hljs-attr">testScript</span></span> =
    <span class="hljs-string"><span class="hljs-string">''
      </span></span><em class="replaceable"><code><span class="hljs-string"><span class="hljs-string">Python code…</span></span></code></em><span class="hljs-string"><span class="hljs-string">
    ''</span></span>;
}
</pre><p>
  The attribute <code class="literal">testScript</code> is a bit of Python code that
  executes the test (described below). During the test, it will start one or
  more virtual machines, the configuration of which is described by the
  attribute <code class="literal">machine</code> (if you need only one machine in your
  test) or by the attribute <code class="literal">nodes</code> (if you need multiple
  machines). For instance,
  <code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/login.nix" target="_top" shape="rect">login.nix</a></code>
  only needs a single machine to test whether users can log in on the virtual
  console, whether device ownership is correctly maintained when switching
  between consoles, and so on. On the other hand,
  <code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/nfs.nix" target="_top" shape="rect">nfs.nix</a></code>,
  which tests NFS client and server functionality in the Linux kernel
  (including whether locks are maintained across server crashes), requires
  three machines: a server and two clients.
 </p><p>
  There are a few special NixOS configuration options for test VMs:

  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <code class="option">virtualisation.memorySize</code>
    </span></dt><dd><p>
      The memory of the VM in megabytes.
     </p></dd><dt><span class="term">
     <code class="option">virtualisation.vlans</code>
    </span></dt><dd><p>
      The virtual networks to which the VM is connected. See
      <code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/nat.nix" target="_top" shape="rect">nat.nix</a></code>
      for an example.
     </p></dd><dt><span class="term">
     <code class="option">virtualisation.writableStore</code>
    </span></dt><dd><p>
      By default, the Nix store in the VM is not writable. If you enable this
      option, a writable union file system is mounted on top of the Nix store
      to make it appear writable. This is necessary for tests that run Nix
      operations that modify the store.
     </p></dd></dl></div><p>
  For more options, see the module
  <code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/virtualisation/qemu-vm.nix" target="_top" shape="rect">qemu-vm.nix</a></code>.
 </p><p>
  The test script is a sequence of Python statements that perform various
  actions, such as starting VMs, executing commands in the VMs, and so on. Each
  virtual machine is represented as an object stored in the variable
  <code class="literal"><em class="replaceable"><code>name</code></em></code> if this is also the
  identifier of the machine in the declarative config.
  If you didn't specify multiple machines using the <code class="literal">nodes</code>
  attribute, it is just <code class="literal">machine</code>.
  The following example starts the machine, waits until it has finished booting,
  then executes a command and checks that the output is more-or-less correct:
</p><pre class="programlisting hljs nix" xml:space="preserve">machine.start()
machine.wait_for_unit(<span class="hljs-string"><span class="hljs-string">"default.target"</span></span>)
<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> not <span class="hljs-string"><span class="hljs-string">"Linux"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> machine.succeed(<span class="hljs-string"><span class="hljs-string">"uname"</span></span>):
  raise Exception(<span class="hljs-string"><span class="hljs-string">"Wrong OS"</span></span>)
</pre><p>
  The first line is actually unnecessary; machines are implicitly started when
  you first execute an action on them (such as <code class="literal">wait_for_unit</code>
  or <code class="literal">succeed</code>). If you have multiple machines, you can speed
  up the test by starting them in parallel:
</p><pre class="programlisting hljs" xml:space="preserve">start_all()
</pre><p>
 </p><p>
  The following methods are available on machine objects:
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
     <code class="methodname">start</code>
    </span></dt><dd><p>
      Start the virtual machine. This method is asynchronous — it does not
      wait for the machine to finish booting.
     </p></dd><dt><span class="term">
     <code class="methodname">shutdown</code>
    </span></dt><dd><p>
      Shut down the machine, waiting for the VM to exit.
     </p></dd><dt><span class="term">
     <code class="methodname">crash</code>
    </span></dt><dd><p>
      Simulate a sudden power failure, by telling the VM to exit immediately.
     </p></dd><dt><span class="term">
     <code class="methodname">block</code>
    </span></dt><dd><p>
      Simulate unplugging the Ethernet cable that connects the machine to the
      other machines.
     </p></dd><dt><span class="term">
     <code class="methodname">unblock</code>
    </span></dt><dd><p>
      Undo the effect of <code class="methodname">block</code>.
     </p></dd><dt><span class="term">
     <code class="methodname">screenshot</code>
    </span></dt><dd><p>
      Take a picture of the display of the virtual machine, in PNG format. The
      screenshot is linked from the HTML log.
     </p></dd><dt><span class="term">
     <code class="methodname">get_screen_text</code>
    </span></dt><dd><p>
      Return a textual representation of what is currently visible on the
      machine's screen using optical character recognition.
     </p><div class="alert alert-info"><strong>Note:</strong> 
       This requires passing <code class="option">enableOCR</code> to the test attribute
       set.
      </div></dd><dt><span class="term">
     <code class="methodname">send_monitor_command</code>
    </span></dt><dd><p>
      Send a command to the QEMU monitor. This is rarely used, but allows doing
      stuff such as attaching virtual USB disks to a running machine.
     </p></dd><dt><span class="term">
     <code class="methodname">send_key</code>
    </span></dt><dd><p>
      Simulate pressing keys on the virtual keyboard, e.g.,
      <code class="literal">send_key("ctrl-alt-delete")</code>.
     </p></dd><dt><span class="term">
     <code class="methodname">send_chars</code>
    </span></dt><dd><p>
      Simulate typing a sequence of characters on the virtual keyboard, e.g.,
      <code class="literal">send_chars("foobar\n")</code> will type the string
      <code class="literal">foobar</code> followed by the Enter key.
     </p></dd><dt><span class="term">
     <code class="methodname">execute</code>
    </span></dt><dd><p>
      Execute a shell command, returning a list
      <code class="literal">(<em class="replaceable"><code>status</code></em>,
      <em class="replaceable"><code>stdout</code></em>)</code>.
     </p></dd><dt><span class="term">
     <code class="methodname">succeed</code>
    </span></dt><dd><p>
      Execute a shell command, raising an exception if the exit status is not
      zero, otherwise returning the standard output.
     </p></dd><dt><span class="term">
     <code class="methodname">fail</code>
    </span></dt><dd><p>
      Like <code class="methodname">succeed</code>, but raising an exception if the
      command returns a zero status.
     </p></dd><dt><span class="term">
     <code class="methodname">wait_until_succeeds</code>
    </span></dt><dd><p>
      Repeat a shell command with 1-second intervals until it succeeds.
     </p></dd><dt><span class="term">
     <code class="methodname">wait_until_fails</code>
    </span></dt><dd><p>
      Repeat a shell command with 1-second intervals until it fails.
     </p></dd><dt><span class="term">
     <code class="methodname">wait_for_unit</code>
    </span></dt><dd><p>
      Wait until the specified systemd unit has reached the “active” state.
     </p></dd><dt><span class="term">
     <code class="methodname">wait_for_file</code>
    </span></dt><dd><p>
      Wait until the specified file exists.
     </p></dd><dt><span class="term">
     <code class="methodname">wait_for_open_port</code>
    </span></dt><dd><p>
      Wait until a process is listening on the given TCP port (on
      <code class="literal">localhost</code>, at least).
     </p></dd><dt><span class="term">
     <code class="methodname">wait_for_closed_port</code>
    </span></dt><dd><p>
      Wait until nobody is listening on the given TCP port.
     </p></dd><dt><span class="term">
     <code class="methodname">wait_for_x</code>
    </span></dt><dd><p>
      Wait until the X11 server is accepting connections.
     </p></dd><dt><span class="term">
     <code class="methodname">wait_for_text</code>
    </span></dt><dd><p>
      Wait until the supplied regular expressions matches the textual contents
      of the screen by using optical character recognition (see
      <code class="methodname">get_screen_text</code>).
     </p><div class="alert alert-info"><strong>Note:</strong> 
       This requires passing <code class="option">enableOCR</code> to the test attribute
       set.
      </div></dd><dt><span class="term">
     <code class="methodname">wait_for_console_text</code>
    </span></dt><dd><p>
      Wait until the supplied regular expressions match a line of the serial
      console output. This method is useful when OCR is not possibile or
      accurate enough.
     </p></dd><dt><span class="term">
     <code class="methodname">wait_for_window</code>
    </span></dt><dd><p>
      Wait until an X11 window has appeared whose name matches the given
      regular expression, e.g., <code class="literal">wait_for_window("Terminal")</code>.
     </p></dd><dt><span class="term">
     <code class="methodname">copy_from_host</code>
    </span></dt><dd><p>
      Copies a file from host to machine, e.g.,
      <code class="literal">copy_from_host("myfile", "/etc/my/important/file")</code>.
     </p><p>
      The first argument is the file on the host. The file needs to be
      accessible while building the nix derivation. The second argument is the
      location of the file on the machine.
     </p></dd><dt><span class="term">
     <code class="methodname">systemctl</code>
    </span></dt><dd><p>
      Runs <code class="literal">systemctl</code> commands with optional support for
      <code class="literal">systemctl --user</code>
     </p><p>
</p><pre class="programlisting hljs nix" xml:space="preserve">machine.systemctl(<span class="hljs-string"><span class="hljs-string">"list-jobs --no-pager"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># runs `systemctl list-jobs --no-pager`</span></span>
machine.systemctl(<span class="hljs-string"><span class="hljs-string">"list-jobs --no-pager"</span></span>, <span class="hljs-string"><span class="hljs-string">"any-user"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># spawns a shell for `any-user` and runs `systemctl --user list-jobs --no-pager`</span></span>
</pre><p>
     </p></dd></dl></div><p>
 </p><p>
  To test user units declared by <code class="literal">systemd.user.services</code> the
  optional <code class="literal">user</code> argument can be used:
</p><pre class="programlisting hljs nix" xml:space="preserve">machine.start()
machine.wait_for_x()
machine.wait_for_unit(<span class="hljs-string"><span class="hljs-string">"xautolock.service"</span></span>, <span class="hljs-string"><span class="hljs-string">"x-session-user"</span></span>)
</pre><p>
  This applies to <code class="literal">systemctl</code>, <code class="literal">get_unit_info</code>,
  <code class="literal">wait_for_unit</code>, <code class="literal">start_job</code> and
  <code class="literal">stop_job</code>.
 </p><p>
  For faster dev cycles it's also possible to disable the code-linters (this shouldn't
  be commited though):
</p><pre class="programlisting hljs nix" xml:space="preserve"><span class="hljs-built_in"><span class="hljs-built_in">import</span></span> ./make-test-python.nix {
  <span class="hljs-attr"><span class="hljs-attr">skipLint</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
  <span class="hljs-attr"><span class="hljs-attr">machine</span></span> =
    { config, pkgs, ... }:
    { <em class="replaceable"><code>configuration…</code></em>
    };

  <span class="hljs-attr"><span class="hljs-attr">testScript</span></span> =
    <span class="hljs-string"><span class="hljs-string">''
      </span></span><em class="replaceable"><code><span class="hljs-string"><span class="hljs-string">Python code…</span></span></code></em><span class="hljs-string"><span class="hljs-string">
    ''</span></span>;
}
</pre><p>
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-running-nixos-tests" class="title" style="clear: both">54.2.&nbsp;Running Tests<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-running-nixos-tests" aria-label="Anchor link for: sec running nixos tests" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  You can run tests using <span class="command"><strong>nix-build</strong></span>. For example, to run the
  test
  <code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/login.nix" target="_top" shape="rect">login.nix</a></code>,
  you just do:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>nix-build <span class="hljs-string"><span class="hljs-string">'&lt;nixpkgs/nixos/tests/login.nix&gt;'</span></span>
</pre><p>
  or, if you don’t want to rely on <code class="envar">NIX_PATH</code>:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /my/nixpkgs/nixos/tests
<code class="prompt">$ </code>nix-build login.nix
…
running the VM <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> script
machine: QEMU running (pid 8841)
…
6 out of 6 tests succeeded
</pre><p>
  After building/downloading all required dependencies, this will perform a
  build that starts a QEMU/KVM virtual machine containing a NixOS system. The
  virtual machine mounts the Nix store of the host; this makes VM creation very
  fast, as no disk image needs to be created. Afterwards, you can view a
  pretty-printed log of the test:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>firefox result/log.html
</pre><p>
 </p></section><section class="section"><div class="titlepage"><div><div><h2 id="sec-running-nixos-tests-interactively" class="title" style="clear: both">54.3.&nbsp;Running Tests interactively<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#sec-running-nixos-tests-interactively" aria-label="Anchor link for: sec running nixos tests interactively" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  The test itself can be run interactively. This is particularly useful when
  developing or debugging a test:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>nix-build nixos/tests/login.nix -A driver
<code class="prompt">$ </code>./result/bin/nixos-test-driver
starting VDE switch <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> network 1
<code class="prompt">&gt;</code>
</pre><p>
  You can then take any Python statement, e.g.
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">&gt;</code> start_all()
<code class="prompt">&gt;</code> test_script()
<code class="prompt">&gt;</code> machine.succeed(<span class="hljs-string"><span class="hljs-string">"touch /tmp/foo"</span></span>)
<code class="prompt">&gt;</code> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(machine.succeed(<span class="hljs-string"><span class="hljs-string">"pwd"</span></span>)) <span class="hljs-comment"><span class="hljs-comment"># Show stdout of command</span></span>
</pre><p>
  The function <span class="command"><strong>test_script</strong></span> executes the entire test script
  and drops you back into the test driver command line upon its completion.
  This allows you to inspect the state of the VMs after the test (e.g. to debug
  the test script).
 </p><p>
  To just start and experiment with the VMs, run:
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>nix-build nixos/tests/login.nix -A driver
<code class="prompt">$ </code>./result/bin/nixos-run-vms
</pre><p>
  The script <span class="command"><strong>nixos-run-vms</strong></span> starts the virtual machines
  defined by test.
 </p><p>
   You can re-use the VM states coming from a previous run
   by setting the <span class="command"><strong>--keep-vm-state</strong></span> flag.
</p><pre class="screen hljs" xml:space="preserve"><code class="prompt">$ </code>./result/bin/nixos-run-vms --keep-vm-state
</pre><p>
  The machine state is stored in the
  <code class="filename">$TMPDIR/vm-state-</code><code class="varname">machinename</code> directory.
 </p></section></section><section class="chapter"><div class="titlepage"><div><div><h2 id="ch-testing-installer" class="title">Chapter&nbsp;55.&nbsp;Testing the Installer<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#ch-testing-installer" aria-label="Anchor link for: ch testing installer" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
  Building, burning, and booting from an installation CD is rather tedious, so
  here is a quick way to see if the installer works properly:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">mount -t tmpfs none /mnt</span></span>
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">nixos-generate-config --root /mnt</span></span>
<code class="prompt">$ </code>nix-build <span class="hljs-string"><span class="hljs-string">'&lt;nixpkgs/nixos&gt;'</span></span> -A config.system.build.nixos-install
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">./result/bin/nixos-install</span></span></pre><p>
  To start a login shell in the new NixOS installation in
  <code class="filename">/mnt</code>:
</p><pre class="screen hljs bash" xml:space="preserve"><code class="prompt">$ </code>nix-build <span class="hljs-string"><span class="hljs-string">'&lt;nixpkgs/nixos&gt;'</span></span> -A config.system.build.nixos-enter
<code class="prompt"><span class="hljs-comment"><span class="hljs-comment"># </span></span></code><span class="hljs-comment"><span class="hljs-comment">./result/bin/nixos-enter</span></span>
</pre><p>
 </p></section><section class="chapter"><div class="titlepage"><div><div><h2 id="ch-releases" class="title">Chapter&nbsp;56.&nbsp;Releases<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#ch-releases" aria-label="Anchor link for: ch releases" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#release-process" shape="rect">56.1. Release process</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#release-management-team" shape="rect">56.2. Release Management Team</a></span></dt><dt><span class="section"><a href="https://nixos.org/manual/nixos/stable/index.html#release-schedule" shape="rect">56.3. Release schedule</a></span></dt></dl></div><section class="section"><div class="titlepage"><div><div><h2 id="release-process" class="title" style="clear: both">56.1.&nbsp;Release process<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#release-process" aria-label="Anchor link for: release process" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   Going through an example of releasing NixOS 19.09:
  </p><section class="section"><div class="titlepage"><div><div><h3 id="one-month-before-the-beta" class="title">56.1.1.&nbsp;One month before the beta<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#one-month-before-the-beta" aria-label="Anchor link for: one month before the beta" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      Create an announcement on <a class="link" href="https://discourse.nixos.org/" target="_top" shape="rect">Discourse</a> as a warning about upcoming beta <span class="quote">“<span class="quote">feature freeze</span>”</span> in a month. <a class="link" href="https://discourse.nixos.org/t/nixos-19-09-feature-freeze/3707" target="_top" shape="rect">See this post as an example</a>.
     </p></li><li class="listitem"><p>
      Discuss with Eelco Dolstra and the community (via IRC, ML) about what will reach the deadline. Any issue or Pull Request targeting the release should be included in the release milestone.
     </p></li><li class="listitem"><p>
      Remove attributes that we know we will not be able to support, especially if there is a stable alternative. E.g. Check that our Linux kernels’ <a class="link" href="https://www.kernel.org/category/releases.html" target="_top" shape="rect">projected end-of-life</a> are after our release projected end-of-life.
     </p></li></ul></div></section><section class="section"><div class="titlepage"><div><div><h3 id="at-beta-release-time" class="title">56.1.2.&nbsp;At beta release time<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#at-beta-release-time" aria-label="Anchor link for: at beta release time" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
      From the master branch run:
     </p><pre class="programlisting hljs" xml:space="preserve">git checkout -b release-19.09
</pre></li><li class="listitem"><p>
      <a class="link" href="https://github.com/NixOS/nixpkgs/commit/10e61bf5be57736035ec7a804cb0bf3d083bf2cf#diff-9c798092bac0caeb5c52d509be0ca263R69" target="_top" shape="rect">Bump the <code class="literal">system.defaultChannel</code> attribute in <code class="literal">nixos/modules/misc/version.nix</code></a>
     </p></li><li class="listitem"><p>
      <a class="link" href="https://github.com/NixOS/nixpkgs/commit/10e61bf5be57736035ec7a804cb0bf3d083bf2cf#diff-831e8d9748240fb23e6734fdc2a6d16eR15" target="_top" shape="rect">Update <code class="literal">versionSuffix</code> in <code class="literal">nixos/release.nix</code></a>
     </p></li></ol></div><p>
    To get the commit count, use the following command:
   </p><pre class="programlisting hljs" xml:space="preserve">git rev-list --count release-19.09
</pre><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
      Edit changelog at <code class="literal">nixos/doc/manual/release-notes/rl-1909.xml</code>.
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        Get all new NixOS modules:
       </p><pre class="programlisting hljs" xml:space="preserve">git diff release-19.03..release-19.09 nixos/modules/module-list.nix | grep ^+
</pre></li><li class="listitem"><p>
        Note systemd, kernel, glibc, desktop environment, and Nix upgrades.
       </p></li></ul></div></li><li class="listitem"><p>
      Tag the release:
     </p><pre class="programlisting hljs nix" xml:space="preserve">git tag --annotate <span class="hljs-attr"><span class="hljs-attr">--message="Release</span></span> <span class="hljs-number"><span class="hljs-number">19.09</span></span>-beta<span class="hljs-string"><span class="hljs-string">" 19.09-beta
git push upstream 19.09-beta
</span></span></pre></li><li class="listitem"><p>
      <a class="link" href="https://github.com/NixOS/nixpkgs/commit/01268fda85b7eee4e462c873d8654f975067731f#diff-2bc0e46110b507d6d5a344264ef15adaR1" target="_top" shape="rect">On the <code class="literal">master</code> branch, increment the <code class="literal">.version</code> file</a>
     </p><pre class="programlisting hljs bash" xml:space="preserve"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n <span class="hljs-string"><span class="hljs-string">"20.03"</span></span> &gt; .version
</pre></li><li class="listitem"><p>
      <a class="link" href="https://github.com/NixOS/nixpkgs/commit/01268fda85b7eee4e462c873d8654f975067731f#diff-03f3d41b68f62079c55001f1a1c55c1dR137" target="_top" shape="rect">Update <code class="literal">codeName</code> in <code class="literal">lib/trivial.nix</code></a> This will be the name for the next release.
     </p></li><li class="listitem"><p>
      <a class="link" href="https://github.com/NixOS/nixpkgs/commit/01268fda85b7eee4e462c873d8654f975067731f#diff-e7ee5ff686cdcc513ca089d6e5682587R11" target="_top" shape="rect">Create a new release notes file for the upcoming release + 1</a>, in our case this is <code class="literal">rl-2003.xml</code>.
     </p></li><li class="listitem"><p>
      Contact the infrastructure team to create the necessary Hydra Jobsets.
     </p></li><li class="listitem"><p>
      <a class="link" href="https://github.com/NixOS/nixos-org-configurations/blob/master/channels.nix" target="_top" shape="rect">Create a channel at https://nixos.org/channels by creating a PR to nixos-org-configurations, changing <code class="literal">channels.nix</code></a>
     </p></li><li class="listitem"><p>
      Get all Hydra jobsets for the release to have their first evaluation.
     </p></li><li class="listitem"><p>
      <a class="link" href="https://github.com/NixOS/nixpkgs/issues/13559" target="_top" shape="rect">Create an issue for tracking Zero Hydra Failures progress. ZHF is an effort to get build failures down to zero.</a>
     </p></li></ol></div></section><section class="section"><div class="titlepage"><div><div><h3 id="during-beta" class="title">56.1.3.&nbsp;During Beta<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#during-beta" aria-label="Anchor link for: during beta" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      Monitor the master branch for bugfixes and minor updates and cherry-pick them to the release branch.
     </p></li></ul></div></section><section class="section"><div class="titlepage"><div><div><h3 id="before-the-final-release" class="title">56.1.4.&nbsp;Before the final release<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#before-the-final-release" aria-label="Anchor link for: before the final release" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      Re-check that the release notes are complete.
     </p></li><li class="listitem"><p>
      Release Nix (currently only Eelco Dolstra can do that). <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/installer/tools/nix-fallback-paths.nix" target="_top" shape="rect">Make sure fallback is updated.</a>
     </p></li><li class="listitem"><p>
      <a class="link" href="https://github.com/NixOS/nixpkgs/commit/40fd9ae3ac8048758abdcfc7d28a78b5f22fe97e" target="_top" shape="rect">Update README.md with new stable NixOS version information.</a>
     </p></li><li class="listitem"><p>
      Change <code class="literal">stableBranch</code> to <code class="literal">true</code> in Hydra and wait for the channel to update.
     </p></li></ul></div></section><section class="section"><div class="titlepage"><div><div><h3 id="at-final-release-time" class="title">56.1.5.&nbsp;At final release time<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#at-final-release-time" aria-label="Anchor link for: at final release time" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h3></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
      Update <a class="xref" href="https://nixos.org/manual/nixos/stable/index.html#sec-upgrading" title="Chapter 4. Upgrading NixOS" shape="rect">Chapter&nbsp;4, <em>Upgrading NixOS</em></a> section of the manual to match new stable release version.
     </p></li><li class="listitem"><p>
      Update <code class="literal">rl-1909.xml</code> with the release date.
     </p></li><li class="listitem"><p>
      Tag the final release
     </p><pre class="programlisting hljs nix" xml:space="preserve">git tag --annotate <span class="hljs-attr"><span class="hljs-attr">--message="Release</span></span> <span class="hljs-number"><span class="hljs-number">19.09</span></span><span class="hljs-string"><span class="hljs-string">" 19.09
git push upstream 19.09
</span></span></pre></li><li class="listitem"><p>
      Update <a class="link" href="https://github.com/NixOS/nixos-homepage" target="_top" shape="rect">nixos-homepage</a> for the release.
     </p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>
        <a class="link" href="https://github.com/NixOS/nixos-homepage/blob/47ac3571c4d71e841fd4e6c6e1872e762b9c4942/Makefile#L1" target="_top" shape="rect">Update <code class="literal">NIXOS_SERIES</code> in the <code class="literal">Makefile</code></a>.
       </p></li><li class="listitem"><p>
        <a class="link" href="https://github.com/NixOS/nixos-homepage/blob/47ac3571c4d71e841fd4e6c6e1872e762b9c4942/nixos-release.tt#L1" target="_top" shape="rect">Update <code class="literal">nixos-release.tt</code> with the new NixOS version</a>.
       </p></li><li class="listitem"><p>
        <a class="link" href="https://github.com/NixOS/nixos-homepage/blob/47ac3571c4d71e841fd4e6c6e1872e762b9c4942/flake.nix#L10" target="_top" shape="rect">Update the <code class="literal">flake.nix</code> input <code class="literal">released-nixpkgs</code> to 19.09</a>.
       </p></li><li class="listitem"><p>
        Run <code class="literal">./update.sh</code> (this updates flake.lock to updated channel).
       </p></li><li class="listitem"><p>
        <a class="link" href="https://github.com/NixOS/nixos-homepage/blob/a5626c71c03a2dd69086564e56f1a230a2bb177a/logo/nixos-logo-19.09-loris-lores.png" target="_top" shape="rect">Add a compressed version of the NixOS logo for 19.09</a>.
       </p></li><li class="listitem"><p>
        <a class="link" href="https://github.com/NixOS/nixos-homepage/commit/a5626c71c03a2dd69086564e56f1a230a2bb177a#diff-9cdc6434d3e4fd93a6e5bb0a531a7c71R5" target="_top" shape="rect">Compose a news item for the website RSS feed</a>.
       </p></li></ol></div></li><li class="listitem"><p>
      Create a new topic on <a class="link" href="https://discourse.nixos.org/" target="_top" shape="rect">the Discourse instance</a> to announce the release.
     </p></li></ol></div><p>
    You should include the following information:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      Number of commits for the release:
     </p><pre class="programlisting hljs nix" xml:space="preserve">bash git log release-<span class="hljs-number"><span class="hljs-number">19.03</span></span>..release-<span class="hljs-number"><span class="hljs-number">19.09</span></span> <span class="hljs-attr"><span class="hljs-attr">--format=%an</span></span> | wc -l
</pre></li><li class="listitem"><p>
      Commits by contributor:
     </p><pre class="programlisting hljs" xml:space="preserve">git shortlog --summary --numbered release-19.03..release-19.09
</pre></li></ul></div><p>
    Best to check how the previous post was formulated to see what needs to be included.
   </p></section></section><section class="section"><div class="titlepage"><div><div><h2 id="release-management-team" class="title" style="clear: both">56.2.&nbsp;Release Management Team<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#release-management-team" aria-label="Anchor link for: release management team" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><p>
   For each release there are two release managers. After each release the release manager having managed two releases steps down and the release management team of the last release appoints a new release manager.
  </p><p>
   This makes sure a release management team always consists of one release manager who already has managed one release and one release manager being introduced to their role, making it easier to pass on knowledge and experience.
  </p><p>
   Release managers for the current NixOS release are tracked by GitHub team <a class="link" href="https://github.com/orgs/NixOS/teams/nixos-release-managers/members" target="_top" shape="rect"><code class="literal">@NixOS/nixos-release-managers</code></a>.
  </p><p>
   A release manager’s role and responsibilities are:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     manage the release process
    </p></li><li class="listitem"><p>
     start discussions about features and changes for a given release
    </p></li><li class="listitem"><p>
     create a roadmap
    </p></li><li class="listitem"><p>
     release in cooperation with Eelco Dolstra
    </p></li><li class="listitem"><p>
     decide which bug fixes, features, etc… get backported after a release
    </p></li></ul></div></section><section class="section"><div class="titlepage"><div><div><h2 id="release-schedule" class="title" style="clear: both">56.3.&nbsp;Release schedule<a class="anchorjs-link " href="https://nixos.org/manual/nixos/stable/#release-schedule" aria-label="Anchor link for: release schedule" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; line-height: 1; padding-left: 0.375em;"></a></h2></div></div></div><div class="informaltable"><table class="informaltable" border="1"><colgroup span="1"><col align="left" span="1"><col align="left" span="1"></colgroup><thead><tr><th align="left" rowspan="1" colspan="1">
            Date
          </th><th align="left" rowspan="1" colspan="1">
            Event
          </th></tr></thead><tbody><tr><td align="left" rowspan="1" colspan="1">
            2016-07-25
          </td><td align="left" rowspan="1" colspan="1">
            Send email to nix-dev about upcoming branch-off
          </td></tr><tr><td align="left" rowspan="1" colspan="1">
            2016-09-01
          </td><td align="left" rowspan="1" colspan="1"><code class="literal">release-16.09</code> branch and corresponding jobsets are created,
            change freeze
          </td></tr><tr><td align="left" rowspan="1" colspan="1">
            2016-09-30
          </td><td align="left" rowspan="1" colspan="1">
            NixOS 16.09 released
          </td></tr></tbody></table></div></section></section></div></div><ul xmlns="http://www.w3.org/1999/xhtml" class="hidden"><li class="next"><a accesskey="n" href="https://nixos.org/manual/nixos/stable/options.html">Appendix&nbsp;A.&nbsp;Configuration Options →</a></li></ul>
</section>
  </main>

  <footer>
    <div>
      <div class="upper">
        <section>
          <h4>The project</h4>
          <ul>
            <li><a href="https://status.nixos.org/">Channel Status</a></li>
            <li><a href="https://search.nixos.org/packages">Packages search</a></li>
            <li><a href="https://search.nixos.org/options">Options search</a></li>
            <li><a href="https://nixos.org/teams/security.html">Security</a></li>
          </ul>
        </section>
        <section>
          <h4>Get in Touch</h4>
          <ul>
            <li><a href="https://discourse.nixos.org/">Forum</a></li>
            <li><a href="https://webchat.freenode.net/#nixos">Chat</a></li>
            <li><a href="https://nixos.org/commercial-support.html">Commercial support</a></li>
          </ul>
        </section>
        <section>
          <h4>Contribute</h4>
          <ul>
            <li><a href="https://nixos.org/guides/contributing.html">Contributing Guide</a></li>
            <li><a href="https://nixos.org/donate.html">Donate</a></li>
          </ul>
        </section>
        <section>
          <h4>Stay up to date</h4>
          <ul>
            <li><a href="https://nixos.org/news.html">Announcements</a></li>
            <li><a href="https://weekly.nixos.org/">Newsletter</a></li>
          </ul>
        </section>
      </div>
      <hr>
      <div class="lower">
        <section class="footer-copyright">
          <h4>NixOS</h4>
          <div>
            <span>
              Copyright © 2021 NixOS
            </span>
            <a href="https://github.com/NixOS/nixos-homepage/blob/master/LICENSES/CC-BY-SA-4.0.txt">
              <abbr title="Creative Commons Attribution Share Alike 4.0 International">
                CC-BY-SA-4.0
              </abbr>
            </a>
          </div>
        </section>
        <section class="footer-social">
          <h4>Connect with us</h4>
          <ul>
            <li class="social-icon -twitter"><a href="https://twitter.com/nixos_org">Twitter</a></li>
            <li class="social-icon -youtube"><a href="https://www.youtube.com/channel/UC3vIimi9q4AT8EgxYp_dWIw">Youtube</a></li>
            <li class="social-icon -github"><a href="https://github.com/NixOS">GitHub</a></li>
          </ul>
        </section>
      </div>
    </div>
  </footer>
  <script src="./NixOS-Manual-Version-20.09_files/nixos-site.js"></script>  <script src="./NixOS-Manual-Version-20.09_files/anchor.min.js"></script>
  <script>
    anchors.add('main h1, main h2, main h3');
  </script>

  <script src="./NixOS-Manual-Version-20.09_files/manual-version-switch.js"></script><div style="background: #333333;color: #FFFFFF;padding: 0.5em 1em;position: fixed;bottom: 0.5em;right: 0.5em;font-size: 0.8em;"><div style="text-align: right;cursor: pointer;"><span>v: stable</span> <strong aria-hidden="true">＋</strong><strong style="display: none;" aria-hidden="true">－</strong></div><dl style="width: 240px;margin: 0 0 1em 0;display: none;"><dt style="color: #999999;">Channels:</dt><dd style="display: inline-block;margin-left: 1em;"><a style="color: #FFFFFF;font-weight: bold;text-decoration: none;" href="https://nixos.org/manual/nixos/unstable">unstable (21.05)</a></dd><dd style="display: inline-block;margin-left: 1em;"><a style="color: #FFFFFF;font-weight: bold;text-decoration: none;" href="https://nixos.org/manual/nixos/stable">stable (20.09)</a></dd></dl></div>



</body></html>